!function(n){function e(){const n=new Dexie("XSocialDB");return n.version(1).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id"}),n.version(2).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id"}),n.version(3).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated"}),n.version(4).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated"}),n.version(5).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt"}),n.version(6).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt"}),n.version(7).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed"}),n.version(8).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt"}),n.version(9).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt"}),n.version(10).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt",xFanClubMemberships:"&streamerHandle, joined, joinedAt, lastCheckinDate, points, level"}),n.version(11).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt",xFanClubMemberships:"&streamerHandle, joined, joinedAt, lastCheckinDate, points, level",xMapDatingData:"&id, accountId, lastGenerated, lastUpdated"}),n.version(12).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt",xFanClubMemberships:"&streamerHandle, joined, joinedAt, lastCheckinDate, points, level",xMapDatingData:"&id, accountId, lastGenerated, lastUpdated",xMapUserProfile:"&id, lastUpdated"}),n.version(13).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt",xFanClubMemberships:"&streamerHandle, joined, joinedAt, lastCheckinDate, points, level",xMapDatingData:"&id, accountId, lastGenerated, lastUpdated",xMapUserProfile:"&id, lastUpdated",xMapChats:"&id, accountId, userId, lastUpdated"}),n.version(13).stores({xTweetsData:"&id",xSettings:"&id",xPresets:"++id, name, createdAt",xUserProfile:"&id",xUserTweets:"&id",xCharacterProfiles:"&characterId",xActiveAccount:"&id",xAccountList:"&accountId, name, createdAt",xNPCs:"&id",xAskbox:"&id",xAccountProfiles:"&handle, name, updatedAt",xAccountAskbox:"&id",xCharacterRelationships:"&id, accountId, lastUpdated",xBookmarks:"&id, accountId, tweetId, bookmarkedAt",xLikes:"&id, accountId, tweetId, likedAt",xWorldEvents:"&id, accountId, lastGenerated, lastProgressed",xCustomGiftCategories:"&id, accountId, name, enabled, createdAt",xCustomGifts:"&id, categoryId, accountId, name, points, createdAt",xFanClubs:"&handle, createdAt, updatedAt",xFanClubMemberships:"&streamerHandle, joined, joinedAt, lastCheckinDate, points, level",xMapDatingData:"&id, accountId, lastGenerated, lastUpdated",xMapUserProfile:"&id, lastUpdated",xMapChats:"&id, accountId, userId, lastUpdated",xTools:"&id, accountId, updatedAt"}),n}function t(){return n.db}const o=n=>document.querySelectorAll(n).forEach(n=>n.style.display="none"),a=(n,e)=>document.querySelectorAll(n).forEach(n=>n.classList.remove(e)),i=(n,e,t)=>document.querySelectorAll(n).forEach(n=>n.style[e]=t),r={clean:n=>n?n.replace("@","").toLowerCase():"",ensureAt:n=>n?n.startsWith("@")?n:`@${n}`:"",equals:(n,e)=>!(!n||!e)&&r.clean(n)===r.clean(e)},s={buildCharacterInfo(n,e,t){let o=`\n角色名：${n.name}`;return o+=`\n本名：${n.originalName}`,o+=`\n人设：${n.settings.aiPersona||"无特定人设"}`,"couple"===t.verificationType&&t.coupleCharacterId===n.id&&(o+="\n【特殊关系】：该角色是用户的情侣认证对象，所有X平台观众都知道这层关系"),o+="\n【X平台身份（必须严格使用）】：",o+=`\n- X用户名：${e.xName}`,o+=`\n- X句柄：@${e.xHandle}`,o+=`\n- X头像：${e.xAvatar}`,o+="\n- 认证状态："+(e.xVerified?"是":"否"),e.xBio&&(o+=`\n- X简介：${e.xBio}`),e.publicIdentity&&(o+=`\n- 公众身份：${e.publicIdentity}`),e.showRealName&&e.realName&&(o+=`\n- 真实姓名：${e.realName}（已公开）`),o},buildUserIdentityInfo(n,e,t){const o=t.knownIdentityCharacters.includes(n.id);let a="\n【用户身份识别】："+(o?"知道用户身份":"不知道用户身份");if(o){a+=`\n- 该角色可以识别用户账号 ${t.handle}（${t.name}）`,a+="\n- 可以根据角色特定的用户人设与用户自然互动，回复时表现出认识";const n=e&&e.userPersona?e.userPersona:"";n.trim()?a+=`\n- 该角色了解的用户信息：${n.substring(0,150)}${n.length>150?"...":""}`:a+="\n- 该角色尚未设置用户人设信息，按基础认识模式互动"}else a+="\n- 该角色完全不知道用户的真实身份，按照陌生人模式回复";return a},buildNPCRelationships(n){if(!n.relationships||0===n.relationships.length)return"";let e="\n【已绑定NPC关系】：";return n.relationships.forEach(n=>{e+=`\n- ${n.npcName} (${n.npcHandle}): ${n.relationshipType}`,n.description&&(e+=` | ${n.description}`)}),e+="\n注意：当该角色参与回复时，其绑定的NPC也可能出现在回复中，要体现相应的关系特点。",e},buildMemoryInfo(n){let e="";if(n.history&&n.history.length>0){const t=n.history.slice(-10);e+="\n最近聊天记忆：",t.forEach(t=>{"assistant"===t.role&&t.content&&(e+=`\n- ${n.name}: ${t.content.substring(0,100)}...`)})}return n.longTermMemory&&n.longTermMemory.length>0&&(e+="\n长期记忆：",n.longTermMemory.forEach(n=>{e+=`\n- ${n.content}`})),e},async buildCompleteCharacterInfo(n,o,a="reply"){if(!n||0===n.length)return"";t();const i=e(),r=await i.xCharacterProfiles.toArray(),s=[];for(const e of n){const n=r.find(n=>n.characterId===e);n&&n.xHandle&&s.push(n.xHandle)}if(0===s.length)return"";const l=await this.getBatchProfiles(s,{userProfileInfo:o});if(0===l.length)return"";let c="";c="tweet"===a?"\n\n【绑定角色信息】以下绑定角色可以作为推文发布者，根据其设定和兴趣发布推文：\n":"reaction"===a?"\n\n【绑定角色信息】以下绑定角色可以对推文进行互动（评论、点赞等），根据角色设定和话题相关性决定是否互动：\n":"\n\n【绑定角色信息】以下绑定角色可以参与回复，根据角色设定和话题相关性决定是否回复：\n";let d=c;for(const n of l)"character"===n.type&&(d+=this.formatProfileForPrompt(n,{includeType:!1,includeTweets:!0,includeRelationships:!0}),d+="\n");return d+="tweet"===a?'\n【角色发推要求】：\n- 角色发推内容要符合其人设、兴趣和性格特点\n- 知道用户身份的角色：可以在推文中自然地@用户或提及用户相关话题\n- 不知道用户身份的角色：发布独立推文，不涉及用户\n- 推文内容应该多样化：日常生活、兴趣爱好、工作学习、情感分享等\n【NPC关系互动】：\n- 有绑定NPC关系的角色，其NPC可能在其推文下评论互动\n- NPC用户名、句柄与关系设定保持一致，头像统一使用默认头像，认证状态为"否"\n- 同一NPC保持身份和性格一致性':"reaction"===a?'\n【角色互动要求】：\n- 角色互动（评论/点赞）要符合其人设和兴趣，与推文内容相关\n- 知道用户身份的角色：在用户发布的推文下可以表现出认识，自然互动\n- 不知道用户身份的角色：按照陌生人模式互动，不知道发布者身份\n- 互动应该自然真实，就像普通用户一样\n【NPC关系互动】：\n- 有绑定NPC关系的角色，其NPC可在评论中出现，体现关系特点\n- NPC用户名、句柄与关系设定保持一致，头像统一使用默认头像，认证状态为"否"\n- 同一NPC保持身份和性格一致性':'\n【角色回复要求】：\n- 角色回复要自然真实，就像普通用户回复一样\n- 知道用户身份的角色：回复时可表现出认识，体现对用户的了解\n- 不知道用户身份的角色：按照陌生人模式回复，不知道用户账号信息\n【NPC关系互动】：\n- 有绑定NPC关系的角色，其NPC可在回复中出现，体现关系特点\n- NPC用户名、句柄与关系设定保持一致，头像统一使用默认头像，认证状态为"否"\n- 同一NPC保持身份和性格一致性，不认识的NPC间不互相@或提及',d},buildBaseSystemPrompt({userPrompt:n,worldSetting:e}){let t="";return n.trim()&&(t+=n.trim()+"\n\n"),t+="【世界观设定约束】：",e.trim()?t+=`\n${e.trim()}\n上述世界观设定是最高优先级的约束条件，必须严格遵守。`:t+="\n无特殊世界观限制，但内容需健康正面，符合社交平台规范。",t},buildUserXProfileInfo:n=>({name:n.name,handle:n.handle,avatar:n.avatar,bio:n.bio,verified:n.verified,verificationType:n.verificationType||"none",coupleCharacterId:n.coupleCharacterId||"",coupleCharacterName:n.coupleCharacterName||"",publicIdentity:n.publicIdentity||"",showRealName:n.showRealName||!1,realName:n.realName||"",knownIdentityCharacters:n.knownIdentityCharacters||[]}),buildUniversalConstraints(n){const e=this.getUserVerificationTypeDescription(n);return`\n🚫🚫🚫 【核心禁令 - 最高优先级】 🚫🚫🚫\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**绝对禁止以用户身份生成任何内容！**\n用户身份标识（禁止使用）：\n- 用户名：${n.name}\n- 用户句柄：${n.handle}\n- 🚨 警告：用户是独立的个体，不要与任何绑定角色混淆！\n- 🚨 警告：不要将绑定角色误认为用户！\n- 用户信息：仅供理解上下文，严禁在生成内容中使用\n**你只能生成以下身份的内容**：\n✅ 绑定角色（使用提供的xName、xHandle、xAvatar等）\n✅ 虚构的普通X平台用户（自创用户名和句柄）\n❌ 绝对不能生成用户本人发表的任何推文/评论/回复\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【用户X平台公开身份】（所有观众都知道的公开信息）：\n- 用户名：${n.name}（这是用户，不是角色！）\n- 用户句柄：${n.handle}（这是用户的唯一标识！）\n- 认证状态：${n.verified?"已认证":"未认证"}\n- 认证类型：${e}\n${"couple"===n.verificationType&&n.coupleCharacterName?`- 情侣关系：与${n.coupleCharacterName}为公开情侣（观众可知）`:""}\n${n.publicIdentity?`- 公众身份：${n.publicIdentity}`:""}\n${n.bio?`- 个人简介：${n.bio}`:""}\n【身份识别关键点】：\n🚨 用户 vs 角色的区别：\n- 用户（${n.name} / ${n.handle}）：真实操作者，你绝对不能模拟其发言\n- 绑定角色：已设定的虚拟角色，有各自的X平台身份（xName、xHandle），你可以生成他们的内容\n- 🚨 特别注意：即使某个角色与用户有关系（如情侣），也不要将该角色当成用户本人！\n【权限分级 - 路人评论者的认知范围】：\n🔓 路人可见（X平台公开信息）：\n- 用户/角色的X姓名、X句柄、认证状态\n- X简介、公众身份、公开的情侣关系\n- X平台上发布的推文内容\n🔒 路人禁知（私密信息）：\n- 真实姓名、真实职业、真实身份\n- 角色人设描述、性格细节、AI人格设定\n- 聊天记忆、私人对话、用户专属人设\n- 只有亲密关系才知道的信息（除非是已绑定的关系NPC）\n⚠️ 路人评论规则：\n- 路人只能基于🔓公开信息进行评论\n- 禁止在评论中提及🔒私密信息\n- 禁止使用只有亲密关系才知道的称呼（如"老师"、"同学"等，除非是公开身份）`},getUserVerificationTypeDescription(n){switch(n.verificationType){case"verified":return"蓝色勾标认证";case"couple":return"情侣认证";case"married":return"已婚认证";case"vip":return"VIP认证";default:return"无认证"}},buildScenarioPrompt({isOwnPost:n,commentType:e,pageType:t,parentComment:o,targetCommentEl:a}){let i="\n\n【场景识别】：";return n&&"main_comment"===e?i+="用户在自己发布的推文下方发表了评论。\n【任务】：生成其他用户对她评论的反应回复，或新的话题相关评论。":n&&"reply_comment"===e?i+="用户在自己发布的推文的评论区楼中楼发表了回复。\n【任务】：生成其他用户对这条楼中楼回复的反应，或话题相关的新回复。":n||"main_comment"!==e?n||"reply_comment"!==e||(i+="用户在别人发布的推文的评论区楼中楼发表了回复。\n【任务】：生成其他用户对此楼中楼回复的反应，可能包括被回复者本人。"):i+="用户在别人发布的推文下方发表了评论。\n【任务】：生成其他用户（包括原推作者）对此评论的互动回复。",i+='\n【生成要求】：\n1. 社交真实性：模拟真实的X平台用户互动，语言自然流畅\n2. 情绪共鸣：根据原推内容和用户评论，生成有情感共鸣的回应\n3. 多样化互动：可以是赞同、反对、补充、提问、调侃等多种类型\n4. 身份一致：每个角色回复都要符合其设定的身份和性格特点\n5. 避免重复：多个回复之间保持内容和表达方式的差异性\n【格式要求】：\n- 每条回复独立成段，以"【回复X】"开头标记\n- 严格按照角色的X平台身份信息生成，不得擅自修改用户名、句柄等\n- 回复长度适中，符合社交媒体特点（一般20-200字）\n- 可以适当使用emoji表情，但不要过度',i},async getUnifiedProfile(e,t={}){try{const o=r.clean(e);if(!o)return null;console.log(`🔍 [统一资料] 查询句柄: ${o}`);let a=n.userProfileData?.xHandle||n.userProfileData?.handle||n.userProfileData?.username;const i=r.clean(a);if(console.log(`🔍 [统一资料] 用户句柄对比: 查询="${o}" vs 用户="${i}" (来源: xHandle=${n.userProfileData?.xHandle}, handle=${n.userProfileData?.handle}, username=${n.userProfileData?.username})`),r.equals(e,a)){const e=n.userProfileData.name||n.userProfileData.xName||"用户",t=n.userProfileData.handle||n.userProfileData.xHandle||`@${a}`,o=n.userProfileData.avatar||n.userProfileData.xAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",i=n.userProfileData.verified||n.userProfileData.xVerified||!1,r=n.userProfileData.bio||n.userProfileData.xBio||"",s=n.userProfileData.cover||n.userProfileData.xCover||"";console.log(`✅ [统一资料] 找到用户自己: ${e} (${t})`);return{type:"user",name:e,handle:t,avatar:o,verified:i,publicIdentity:n.userProfileData.publicIdentity||"",bio:r,xProfile:{xName:e,xHandle:t,xAvatar:o,xVerified:i,xBio:r,xCover:s},knowsUserIdentity:!1,xMessageHistory:[],recentTweets:[]}}const s=await this._getCharacterProfileByHandle(o,t.userProfileInfo);if(s)return console.log(`✅ [统一资料] 找到角色: ${s.name}`),s;const l=await this._getNPCProfileByHandle(o);if(l)return console.log(`✅ [统一资料] 找到绑定NPC: ${l.name}`),l;const c=await this._getRelationshipNPCProfileByHandle(o);if(c)return console.log(`✅ [统一资料] 找到关系NPC: ${c.name}`),c;const d=await this._getAccountProfileByHandle(o);return d?(console.log(`✅ [统一资料] 找到账户: ${d.name}`),d):(console.log("ℹ️ [统一资料] 未找到匹配，创建陌生人模板"),await this._createStrangerProfile(e,t.messageId))}catch(n){return console.error("[统一资料] 查询失败:",n),null}},async _getCharacterProfileByHandle(o,a=null){try{const i=e(),s=t(),l=(await i.xCharacterProfiles.toArray()).find(n=>r.equals(n.xHandle,o));if(!l)return null;const c=(await s.chats.toArray()).find(n=>n.id===l.characterId);if(!c)return null;const d=await i.xAccountProfiles.get(o),p=d?.tweets||[];let g=null;d?.liveRoomData&&(g=d.liveRoomData,console.log(`🎤 [直播数据] 角色 ${l.xName}: 找到直播间数据 "${g.title||"无标题"}"`));let m=null,x=null;try{const n=await i.xFanClubs.get(o);n&&n.data&&(m=n.data,console.log(`🎖️ [粉丝团] 角色 ${l.xName}: 找到粉丝团配置 "${m.clubName||"无名称"}"`)),x=await i.xFanClubMemberships.get(o),x&&console.log(`🎖️ [粉丝团] 用户在 ${l.xName} 的粉丝团中: LV${x.level} (${x.points}积分)`)}catch(n){console.warn(`⚠️ [粉丝团] 角色 ${l.xName} 粉丝团数据读取失败:`,n)}let u=!1;a&&a.knownIdentityCharacters&&(u=a.knownIdentityCharacters.includes(c.id)),console.log(`👤 [身份识别] 角色 ${l.xName} ${u?"✅ 知道":"❌ 不知道"}用户身份${u&&l.userPersona?" (有专属人设)":u?" (无专属人设)":""}`);let h=[];try{const e=n.currentAccountId||"main",t=[e];"main"!==e&&t.push("main");let o=null;for(const n of t){const e=`messageConversation_${n}_msg_${c.id}`,t=await i.xAccountProfiles.get(e);if(t&&t.data&&t.data.messages){o=t;break}}if(o&&o.data&&o.data.messages){h=o.data.messages.slice(-50).map(n=>({type:n.type,content:n.content||"",isOwn:n.isOwn||!1,time:n.time||"",timestamp:n.timestamp||""})),console.log(`✅ [私信数据] 角色 ${l.xName}: ${h.length} 条记忆`)}}catch(n){console.error(`❌ [私信数据] 角色 ${l.xName} 读取失败:`,n)}let f=[];try{const n=await s.chatSessions.where("characterId").equals(c.id).and(n=>!0===n.syncToX).first();if(n){f=(await s.chatMessages.where("[characterId+sessionId]").equals([c.id,n.id.toString()]).toArray()).map(n=>({role:"user"===n.sender?"user":"assistant",content:n.content||"",timestamp:n.timestamp})),console.log(`📜 [聊天历史] 使用投递给X的聊天框"${n.name}": ${f.length} 条记录`)}}catch(n){console.warn("⚠️ [聊天历史] 查找投递给X的聊天框失败:",n)}if(0===f.length)try{const n=await s.globalSettings.get(`defaultChatSyncToX_${c.id}`);if(!0===n?.value){f=(await s.chatMessages.where("[characterId+sessionId]").equals([c.id,"default"]).toArray()).map(n=>({role:"user"===n.sender?"user":"assistant",content:n.content||"",timestamp:n.timestamp})),console.log(`📜 [聊天历史] 使用投递给X的默认聊天框: ${f.length} 条记录`)}}catch(n){console.warn("⚠️ [聊天历史] 检查默认聊天框同步标记失败:",n)}if(0===f.length)if(c.history&&c.history.length>0)f=c.history,console.log(`📜 [聊天历史] 正确npc-4(1).html格式: ${f.length} 条记录`);else try{f=(await s.chatMessages.where("[characterId+sessionId]").equals([c.id,"default"]).toArray()).map(n=>({role:"user"===n.sender?"user":"assistant",content:n.content||"",timestamp:n.timestamp})),console.log(`📜 [聊天历史] mobile-simulator.html默认聊天框: ${f.length} 条记录`)}catch(n){console.warn("⚠️ [聊天历史] 读取chatMessages失败:",n)}return{type:"character",name:l.xName,handle:l.xHandle,avatar:l.xAvatar,bio:l.xBio||"",verified:l.xVerified||!1,publicIdentity:l.publicIdentity||"",characterData:{id:c.id,originalName:c.originalName,aiPersona:c.settings?.aiPersona||"",history:f,longTermMemory:c.longTermMemory||[],userPersona:l.userPersona||"",xMessageHistory:h},knowsUserIdentity:u,tweets:p,relationships:l.relationships||[],liveRoomData:g,fanClubConfig:m,userFanClubMembership:x,xProfile:l,character:c,characterId:c.id,_source:"character",_characterId:c.id,_loadedAt:Date.now()}}catch(n){return console.error("[统一资料] 角色查询失败:",n),null}},async _getAccountProfileByHandle(n){try{const t=e(),o=await t.xAccountProfiles.get(n);if(!o)return null;const a=o.accountInfo||o,i=await this._loadXMessageHistory(a.handle);let r=null;o.liveRoomData&&(r=o.liveRoomData,console.log(`🎤 [直播数据] 账户 ${a.name}: 找到直播间数据 "${r.title||"无标题"}"`));let s=null,l=null;try{const t=e(),o=await t.xFanClubs.get(n);o&&o.data&&(s=o.data,console.log(`🎖️ [粉丝团] 账户 ${a.name}: 找到粉丝团配置 "${s.clubName||"无名称"}"`)),l=await t.xFanClubMemberships.get(n),l&&console.log(`🎖️ [粉丝团] 用户在 ${a.name} 的粉丝团中: LV${l.level} (${l.points}积分)`)}catch(n){console.warn(`⚠️ [粉丝团] 账户 ${a.name} 粉丝团数据读取失败:`,n)}return{type:"account",name:a.name,handle:a.handle,avatar:a.avatar,bio:a.bio||"",verified:a.verified||!1,publicIdentity:a.publicIdentity||"",accountInfo:{name:a.name,handle:a.handle,avatar:a.avatar,bio:a.bio||"",verified:a.verified||!1,verificationType:a.verificationType||"none",cover:a.cover||o.cover||"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",publicIdentity:a.publicIdentity||"",customTag1:a.customTag1||o.customTag1||null,customTag2:a.customTag2||o.customTag2||null,followersCount:a.followersCount||"0",followingCount:a.followingCount||"0"},accountData:{accountType:o.accountType||"unknown",personality:o.personality||"",postingHabits:o.postingHabits||"",sourceContext:o.sourceContext||null,followersCount:a.followersCount||"0",followingCount:a.followingCount||"0",xMessageHistory:i},tweets:o.tweets||[],relationships:o.relationships||[],liveRoomData:r,fanClubConfig:s,userFanClubMembership:l,_source:"account",_accountHandle:n,_loadedAt:Date.now()}}catch(n){return console.error("[统一资料] 账户查询失败:",n),null}},async _loadXMessageHistory(t){try{const o=e(),a=n.currentAccountId||"main",i=r.clean(t),s=[a];"main"!==a&&s.push("main");let l=null,c=null;for(const n of s){const e=`messagesList_${n}`,t=await o.xAccountProfiles.get(e);if(t&&t.data&&t.data.length>0){l=t,c=n;break}}if(!l)return[];const d=l.data.find(n=>r.equals(n.userHandle,t));let p,g;if(d)p=`messageConversation_${c}_${d.id}`,g=await o.xAccountProfiles.get(p);else{const n=[`msg_account_${i}`,`msg_npc_${i}`,`msg_relationship_${i}`,i];for(const e of s){for(const t of n){const n=`messageConversation_${e}_${t}`,a=await o.xAccountProfiles.get(n);if(a&&a.data&&a.data.messages){p=n,g=a;break}}if(g)break}if(!g)return[]}if(!g||!g.data||!g.data.messages)return[];const m=g.data.messages.slice(-50).map(n=>({type:n.type,content:n.content||"",isOwn:n.isOwn||!1,time:n.time||"",timestamp:n.timestamp||"",amount:n.amount,note:n.note,imageDescription:n.imageDescription,voiceText:n.voiceText,title:n.title,url:n.url,tweet:n.tweet,profile:n.profile}));return console.log(`✅ [私信数据] ${t}: ${m.length} 条记忆`),m}catch(n){return console.error(`❌ [私信数据] ${t}: 读取失败`,n),[]}},async _getNPCProfileByHandle(n){try{const t=e(),o="xNPCs_global",a=await t.xNPCs.get(o),i=a?.npcs||[];for(const e of i)if(r.equals(e.handle,n)){const n=await this._loadXMessageHistory(e.handle);return{type:"npc",name:e.name,handle:e.handle,avatar:e.avatar,bio:"",verified:!1,publicIdentity:"",npcData:{personality:e.personality||"",postingHabits:e.postingHabits||"",homepage:e.homepage||"",xMessageHistory:n},npc:e,tweets:[],relationships:[],_source:"npc",_loadedAt:Date.now()}}return null}catch(n){return console.error("[统一资料] 绑定NPC查询失败:",n),null}},async _getRelationshipNPCProfileByHandle(n){try{const o=e(),a=t(),i=await o.xCharacterProfiles.toArray(),s=await a.chats.toArray();for(const e of i)if(e.relationships&&0!==e.relationships.length)for(const t of e.relationships)if(r.equals(t.npcHandle,n)){const n=s.find(n=>n.id===e.characterId);if(n){const o=await this._loadXMessageHistory(t.npcHandle);return{type:"relationshipNpc",name:t.npcName,handle:t.npcHandle,avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",bio:"",verified:!1,publicIdentity:"",relationshipData:{relationshipType:t.relationshipType,description:t.description||"",ownerCharacterId:n.id,ownerCharacterName:n.name,xMessageHistory:o},relationship:t,ownerCharacter:n,ownerXProfile:e,tweets:[],relationships:[],_source:"relationshipNpc",_ownerId:n.id,_loadedAt:Date.now()}}}return null}catch(n){return console.error("[统一资料] 关系NPC查询失败:",n),null}},async _createStrangerProfile(t,o=null){const a=r.clean(t);let i="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";if(o)try{const t=e(),a=`strangerSettings_${n.currentAccountId||"main"}_${o}`,r=await t.xAccountProfiles.get(a);r&&r.customAvatar&&(i=r.customAvatar,console.log(`✅ [陌生人资料] 读取到自定义头像: ${i}`))}catch(n){console.error("[陌生人资料] 读取自定义设置失败:",n)}return{type:"stranger",name:a,handle:`@${a}`,avatar:i,bio:"",verified:!1,publicIdentity:"",characterData:null,accountData:{xMessageHistory:await this._loadXMessageHistory(`@${a}`)},tweets:[],relationships:[],_source:"stranger",_messageId:o,_loadedAt:Date.now()}},_formatMessageContent(n){if("text"===n.type)return n.content||"";if("image"===n.type)return n.isOwn?"[用户发送了图片]":`[图片: ${n.imageDescription||"图片"}]`;if("voice"===n.type)return`[语音: ${n.voiceText||"语音消息"}]`;if("sticker"===n.type)return"[表情包]";if("transfer"===n.type){return`[转账${n.amount?`$${n.amount}`:""}${n.note?` (${n.note})`:""}]`}return"link"===n.type?`[分享链接: ${n.title||"链接"}]`:"quoteTweet"===n.type?`[转发推文: ${n.tweet?.content||""}]`:"quoteProfile"===n.type?`[分享主页: ${n.profile?.name||""}]`:`[${n.type}消息]`},_formatLiveRoomData(n,e,t="character"){if(!n)return{text:"",tokenCount:0};let o=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎤 直播间信息（该${"character"===t?"角色":"账户"}的直播间上下文）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;if(n.title&&(o+=`直播间标题：${n.title}\n`),n.description&&(o+=`直播间简介：${n.description}\n`),n.announcement&&(o+=`直播公告：${n.announcement}\n`),n.streamerPersonality&&(o+=`\n【主播性格】：${n.streamerPersonality}\n`),n.contentTheme&&(o+=`【直播内容主题】：${n.contentTheme}\n`),n.targetAudience&&(o+=`【目标观众】：${n.targetAudience}\n`),n.danmakuMessages&&n.danmakuMessages.length>0){const t=n.danmakuMessages.filter(n=>n.isStreamer).slice(-30).reverse();t.length>0&&(o+="\n【主播最近发言】（展现主播真实性格和表达方式）：\n",t.slice(0,20).forEach((n,e)=>{const t=n.content||n.message||"";if(t){const n=t.length>80?`${t.substring(0,80)}...`:t;o+=`${e+1}. ${n}\n`}}));const a=n.danmakuMessages.slice(-30).reverse();a.length>0&&(o+="\n【直播间最近互动】（主播与观众的互动氛围）：\n",a.slice(0,15).forEach(n=>{const t=n.isStreamer?e:n.sender,a=n.content||n.message||"";if(a&&t){const n=a.length>60?`${a.substring(0,60)}...`:a;o+=`${t}: ${n}\n`}}))}o+=`\n⚠️ 重要说明：\n- 以上是该${"character"===t?"角色":"账户"}的直播间上下文信息\n- 主播的发言和互动方式能准确反映其真实性格和表达习惯\n- 在生成私信、推文、账户主页等内容时，应保持与直播间表现的一致性\n- 不要在不合适的场景（如公开推文）中直接提及直播间内的具体互动细节\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const a=d.estimateTokens(o);return console.log(`📊 [直播] ${t} ${e}: ~${a} tokens`),{text:o,tokenCount:a}},_formatFanClubData(n,e,t,o="character"){if(!n)return{text:"",tokenCount:0};let a=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎖️ 粉丝团信息（该${"character"===o?"角色":"账户"}的粉丝团系统）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;if(a+=`\n📋 粉丝团基本信息：\n- 粉丝团名称：${n.clubName||"未设置"}\n- 粉丝团简介：${n.clubDescription||n.description||"无简介"}\n`,n.levelSystem&&Array.isArray(n.levelSystem)){a+=`\n🏆 粉丝团等级系统（共 ${n.levelSystem.length} 个等级）：\n`;const e=[];n.levelSystem.length<=10?e.push(...n.levelSystem):(e.push(...n.levelSystem.slice(0,5)),e.push({level:"...",levelName:"...",requiredPoints:"...",benefit:"（省略中间等级）"}),e.push(...n.levelSystem.slice(-5))),e.forEach(n=>{"..."===n.level?a+=`${n.benefit}\n`:a+=`LV${n.level} ${n.levelName}：需要${n.requiredPoints}积分 - ${n.benefit||n.description||"无描述"}\n`})}if(e){if(a+=`\n👤 用户在该粉丝团的会员状态：\n- ✅ 用户已加入该粉丝团\n- 当前等级：LV${e.level||1}\n- 当前积分：${e.points||0}\n- 连续签到：${e.consecutiveDays||0}天\n- 加入时间：${e.joinedAt||"未知"}\n- 最后签到：${e.lastCheckIn||"未签到"}\n`,n.levelSystem&&Array.isArray(n.levelSystem)){const t=n.levelSystem.find(n=>n.level===e.level);t&&(a+=`- 等级称号：${t.levelName}\n`,a+=`- 当前福利：${t.benefit||t.description||"无描述"}\n`);const o=n.levelSystem.find(n=>n.level===e.level+1);if(o){const n=o.requiredPoints-(e.points||0);a+=`- 距离下一级（LV${o.level} ${o.levelName}）还需：${n}积分\n`}else a+="- 🎉 已达到最高等级！\n"}}else a+="\n👤 用户在该粉丝团的会员状态：\n- ❌ 用户尚未加入该粉丝团\n- 用户可以通过签到、送礼、互动等方式加入并升级\n";if(n.fanClubContactConfig){const t=n.fanClubContactConfig;a+=`\n💬 主播粉丝团私联规则：\n- 主播是否会主动私联高等级粉丝：${t.willContactPrivately?"是":"否"}\n`,t.willContactPrivately&&(a+=`- 触发私联的等级门槛：LV${t.contactLevelThreshold}及以上\n`,a+=`- 被拒绝后是否持续私联：${t.persistAfterRejection?"是":"否"}\n`,e&&e.level>=t.contactLevelThreshold&&(a+=`⚠️ 用户当前等级（LV${e.level}）已达到私联门槛，主播可能会主动私信用户\n`))}a+=`\n⚠️ 重要说明：\n- 粉丝团等级反映了用户对该${"character"===o?"角色":"账户"}的支持程度\n- 等级越高，说明用户对该${"character"===o?"角色":"账户"}的投入越多（时间、金钱、互动）\n- 在生成${"character"===o?"角色":"账户"}的回复时，应根据用户的粉丝团等级调整亲密度和态度\n- 高等级粉丝通常会获得更热情、更特殊的对待\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const i=d.estimateTokens(a);return console.log(`📊 [粉丝团] ${o} ${t}: ~${i} tokens`),{text:a,tokenCount:i}},_formatXMessageHistory(n,e,t="character"){if(!n||0===n.length)return{text:"",tokenCount:0,messageCount:0};let o=`\n【X平台私信记忆】（该${"character"===t?"角色":"account"===t?"账户":"npc"===t?"NPC":"relationshipNpc"===t?"关系NPC":"陌生人"}与用户在X平台私信中的对话记录${"character"===t?"":"，仅供参考"}）：\n`;const a=n.slice(-50);let i=0;for(const n of a){const t=n.isOwn?"用户":e,a=this._formatMessageContent(n);if(a){o+=`${t}: ${a.length>80?`${a.substring(0,80)}...`:a}\n`,i++}if(i>=50)break}o+="character"===t?'\n⚠️ 重要说明：\n- 这些是在X平台私信功能中的真实对话记录\n- 无论角色是否"认识用户身份"（其他场景的身份），这些X平台对话都是客观存在的\n- 根据当前场景（推文/评论/私信）自然使用，不要在公开推文中直接提及私信内容\n':`⚠️ 以上是X平台私信对话记录，仅供理解该${"account"===t?"账户":"npc"===t?"NPC":"relationshipNpc"===t?"关系NPC":"陌生人"}与用户的关系和沟通风格\n⚠️ 根据当前场景（推文/评论）自然使用，不要在公开推文中直接提及私信内容\n`;const r=d.estimateTokens(o);return console.log(`📊 [私信] ${t} ${e}: ${i}条, ~${r} tokens`),{text:o,tokenCount:r,messageCount:i}},formatProfileForPrompt(n,e={}){if(!n)return"";const{includeType:t=!0,includeTweets:o=!0,includeRelationships:a=!0}=e;let i="";if(t){i+=`${{character:"【角色资料】",account:"【账户资料】",stranger:"【陌生人资料】"}[n.type]||"【资料】"}\n`}if(!n.name||!n.handle)return console.warn("⚠️ [格式化资料] profile 缺少必需字段 name 或 handle:",{type:n.type,name:n.name,handle:n.handle}),"";if(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📱 X平台公开信息（路人可见）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nX姓名：${n.name}\nX句柄：${n.handle}\n认证状态：${n.verified?"已认证":"未认证"}\n${n.bio?`X简介：${n.bio}`:""}\n${n.publicIdentity?`公开身份：${n.publicIdentity}`:""}\n🚨 重要：以上信息是X平台上的公开资料，所有X用户（包括路人、陌生人）都能看到。\n路人评论时只能基于这些公开信息，不能提及下方的私密信息！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,"character"===n.type&&n.characterData){const e=n.characterData,t=e.originalName||n.name||"未知",o=e.aiPersona||"无特定人设";if(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔒 角色私密资料（仅供AI理解角色，路人不知道）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n真实姓名：${t}\n人设描述：${o}\n⚠️ 隐私规则：\n- 真实姓名"${t}"是私密信息，路人评论中禁止提及！\n- 路人只能称呼X姓名"${n.name}"或使用句柄"${n.handle}"\n- 只有该角色本人或关系NPC（已绑定的私人关系）才知道真实姓名\n- 人设描述仅供AI理解角色性格，路人不知道这些细节\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,void 0!==n.knowsUserIdentity&&(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👤 用户身份识别\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n该角色${n.knowsUserIdentity?"知道":"不知道"}用户的真实身份\n`,n.knowsUserIdentity?(i+="✅ 该角色可以识别用户，回复时应该表现出认识\n",e.userPersona&&e.userPersona.trim()?i+=`\n【角色了解的用户信息】（专属用户人设）：\n${e.userPersona}\n⚠️ 该角色应该根据这些信息与用户互动\n`:i+="⚠️ 该角色尚未设置专属用户人设，按基础认识模式互动\n"):i+="❌ 该角色完全不知道用户的真实身份，必须按照陌生人模式回复\n⚠️ 不要让角色猜测、暗示或表现出任何对用户的认识\n",i+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"),e.xMessageHistory&&e.xMessageHistory.length>0){const t=this._formatXMessageHistory(e.xMessageHistory,n.name,"character");i+=t.text}if(n.liveRoomData){const e=this._formatLiveRoomData(n.liveRoomData,n.name,"character");i+=e.text}if(n.fanClubConfig){const e=this._formatFanClubData(n.fanClubConfig,n.userFanClubMembership,n.name,"character");i+=e.text}if(n.knowsUserIdentity&&e.userPersona&&e.userPersona.trim()&&e.history&&e.history.length>0){i+="\n【其他聊天记忆】（与用户在其他场景的对话，仅供参考）：\n";const t=e.history.slice(-10);let o=0;for(const e of t){if("user"===e.role&&e.content){const n=String(e.content);i+=`用户: ${n.substring(0,100)}${n.length>100?"...":""}\n`,o++}else if("assistant"===e.role&&e.content){const t=String(e.content);i+=`${n.name}: ${t.substring(0,100)}${t.length>100?"...":""}\n`,o++}if(o>=10)break}i+="⚠️ 以上记忆仅供理解角色与用户关系，根据当前场景自然使用\n"}e.longTermMemory&&e.longTermMemory.length>0&&(i+="\n【长期记忆】（仅供AI参考，路人不知道）：\n",e.longTermMemory.forEach((n,e)=>{i+=`${e+1}. ${n.content}\n`}))}if("account"===n.type&&n.accountData){const e=n.accountData;if(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔒 账户资料（仅供AI理解，路人不知道）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n账户类型：${e.accountType}\n${e.personality?`人设描述：${e.personality}`:""}\n${e.postingHabits?`发帖习惯：${e.postingHabits}`:""}\n${e.followersCount?`关注者：${e.followersCount}`:""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,e.xMessageHistory&&e.xMessageHistory.length>0){const t=this._formatXMessageHistory(e.xMessageHistory,n.name,"account");i+=t.text}if(n.liveRoomData){const e=this._formatLiveRoomData(n.liveRoomData,n.name,"account");i+=e.text}if(n.fanClubConfig){const e=this._formatFanClubData(n.fanClubConfig,n.userFanClubMembership,n.name,"account");i+=e.text}}if("npc"===n.type&&n.npcData){const e=n.npcData;if(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔒 NPC资料（仅供AI理解角色，路人不知道）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n${e.personality?`人设描述：${e.personality}`:""}\n${e.postingHabits?`发帖习惯：${e.postingHabits}`:""}\n${e.homepage?`主页链接：${e.homepage}`:""}\n⚠️ 该NPC是全局绑定的虚拟角色，按照人设描述进行互动\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,e.xMessageHistory&&e.xMessageHistory.length>0){const t=this._formatXMessageHistory(e.xMessageHistory,n.name,"npc");i+=t.text}}if("relationshipNpc"===n.type&&n.relationshipData){const e=n.relationshipData;if(i+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔒 关系NPC资料（仅供AI理解角色，路人不知道）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n关系类型：${e.relationshipType}\n${e.description?`关系描述：${e.description}`:""}\n所属角色：${e.ownerCharacterName}（该NPC是 ${e.ownerCharacterName} 的专属关系角色）\n⚠️ 该NPC与角色 ${e.ownerCharacterName} 有绑定关系，互动时应体现这种关系\n⚠️ 该NPC只与其所属角色有特殊关系，与其他角色/用户按照普通关系互动\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,e.xMessageHistory&&e.xMessageHistory.length>0){const t=this._formatXMessageHistory(e.xMessageHistory,n.name,"relationshipNpc");i+=t.text}}if("stranger"===n.type&&(i+="\n⚠️ 该用户是陌生人（未在系统中绑定），回复应该自然真实，符合普通X平台用户的特点\n⚠️ 如果没有特殊设定，按照一般性格进行回复\n",n.accountData&&n.accountData.xMessageHistory&&n.accountData.xMessageHistory.length>0)){const e=this._formatXMessageHistory(n.accountData.xMessageHistory,n.name,"stranger");i+=e.text}if(o&&n.tweets&&n.tweets.length>0){i+="\n【最近推文】（参考发帖风格）：\n";n.tweets.slice(0,3).forEach((n,e)=>{i+=`${e+1}. "${n.content}"\n`,i+=` 互动：${n.stats?.likes||0}喜欢，${n.stats?.comments||0}评论\n`})}return a&&n.relationships&&n.relationships.length>0&&(i+="\n【已绑定关系】：\n",n.relationships.forEach(n=>{i+=`- ${n.npcName} (${n.npcHandle}): ${n.relationshipType}`,n.description&&(i+=` | ${n.description}`),i+="\n"})),i},async getBatchProfiles(n,e={}){if(!Array.isArray(n)||0===n.length)return[];return(await Promise.all(n.map(n=>this.getUnifiedProfile(n,e)))).filter(n=>null!==n)},async filterUserImpersonation(t,o=null,a=null){console.log("═══════════════════════════════════════"),console.log("🚫 [身份筛选] 开始检查用户身份冒用...");let i=o,s=a;if(i&&s)console.log(`📋 [身份筛选] 使用提供的用户信息: ${s} (@${i})`);else{console.log("🔍 [身份筛选] 未提供用户信息，从数据库读取最新数据...");try{const o=e(),a=n.currentAccountId||"main",r=await o.xUserProfile.get(a);if(!r)return console.warn("⚠️ [身份筛选] 数据库中未找到用户资料，跳过筛选"),console.log("═══════════════════════════════════════"),t;i=r.handle,s=r.name,console.log(`✅ [身份筛选] 已从数据库读取用户信息: ${s} (@${i})`)}catch(n){return console.error("❌ [身份筛选] 读取用户资料失败:",n),console.log("═══════════════════════════════════════"),t}}r.clean(i);const l=s.toLowerCase();let c=0;const d=n=>{if(!n||!n.handle)return!1;if(r.equals(n.handle,i))return console.warn(`  🚫 检测到句柄冒用: @${n.handle} (假扮: ${s})`),!0;return(n.name||"").toLowerCase()===l&&(console.warn(`  🚫 检测到姓名冒用: ${n.name} (假扮: ${s})`),!0)},p=n=>Array.isArray(n)?n.filter(n=>d(n.user)?(console.warn(`  🗑️ 删除冒用推文: "${(n.content||"").substring(0,50)}..."`),c++,!1):(n.comments&&Array.isArray(n.comments)&&(n.comments=g(n.comments)),!0)):n,g=n=>Array.isArray(n)?n.filter(n=>d(n.user)?(console.warn(`  🗑️ 删除冒用评论: "${(n.content||"").substring(0,50)}..."`),c++,!1):(n.replies&&Array.isArray(n.replies)&&(n.replies=g(n.replies)),!0)):n;return t.forYouTweets&&(t.forYouTweets=p(t.forYouTweets)),t.followingTweets&&(t.followingTweets=p(t.followingTweets)),t.tweets&&Array.isArray(t.tweets)&&(t.tweets=p(t.tweets)),t.comments&&Array.isArray(t.comments)&&(t.comments=g(t.comments)),t.replies&&Array.isArray(t.replies)&&(t.replies=g(t.replies)),t.likes&&Array.isArray(t.likes)&&(t.likes=t.likes.filter(n=>{const e=n.users||[];return n.users=e.filter(n=>!d(n)),0!==n.users.length||(console.warn("  🗑️ 删除全冒用点赞通知"),c++,!1)})),t.retweets&&Array.isArray(t.retweets)&&(t.retweets=t.retweets.filter(n=>d(n.user)?(console.warn("  🗑️ 删除冒用转推通知"),c++,!1):(n.comments&&(n.comments=g(n.comments)),!0))),console.log("═══════════════════════════════════════"),c>0?console.log(`✅ [身份筛选] 筛选完成，共删除 ${c} 个冒用身份的内容`):console.log("✅ [身份筛选] 筛选完成，未检测到身份冒用"),console.log("═══════════════════════════════════════"),t},async _buildAvatarMap(){const o=e(),a=(t(),new Map);console.log("🔍 [头像修正] 开始从数据库加载最新头像数据...");const i=(n,e,t,o)=>{const i=r.clean(n);i&&a.set(i,{avatar:e,type:t,name:o})};try{const e=n.currentAccountId||"main",t=await o.xUserProfile.get(e);t?.handle&&t?.avatar?(i(t.handle,t.avatar,"user",t.name),console.log(`👤 [头像修正] 已加载用户头像（数据库）: ${t.name} (@${t.handle}) -> ${t.avatar.substring(0,50)}...`)):console.warn("⚠️ [头像修正] 未找到用户资料或头像为空")}catch(n){console.error("❌ [头像修正] 读取用户头像失败:",n)}const s=await o.xCharacterProfiles.toArray();let l=0,c=0;for(const n of s)if(n.xHandle&&n.xAvatar&&(i(n.xHandle,n.xAvatar,"character",n.xName),l++),n.relationships?.length>0)for(const e of n.relationships)e.npcHandle&&(i(e.npcHandle,"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg","relationshipNpc",e.npcName),c++);l>0&&console.log(`🎭 [头像修正] 已加载 ${l} 个角色头像`),c>0&&console.log(`👥 [头像修正] 已加载 ${c} 个关系NPC头像（默认）`);const d=await o.xNPCs.get("xNPCs_global"),p=d?.npcs||[];let g=0;for(const n of p)n.handle&&n.avatar&&(i(n.handle,n.avatar,"npc",n.name),g++);g>0&&console.log(`🤖 [头像修正] 已加载 ${g} 个绑定NPC头像`);const m=await o.xAccountProfiles.toArray(),x=m.filter(n=>n.handle?.startsWith("strangerSettings_")&&n.customAvatar),u=m.filter(n=>"messagesList"===n.name);let h=0;for(const n of x){if(!n.messageId)continue;let e=!1;for(const t of u){if(!t.data||!Array.isArray(t.data))continue;const o=t.data.find(e=>e.id===n.messageId);if(o?.userHandle){i(o.userHandle,n.customAvatar,"stranger",o.userName||"陌生人"),h++,e=!0;break}}e||console.warn(`⚠️ [头像修正] 陌生人设置存在但未找到对应私信: ${n.messageId}`)}return h>0&&console.log(`👻 [头像修正] 已加载 ${h} 个陌生人自定义头像`),console.log(`✅ [头像修正] 头像映射表构建完成，共 ${a.size} 个用户`),a},async enforceAvatarRules(n,e=null){console.log("═══════════════════════════════════════"),console.log("🔧 [头像修正] 开始修正头像数据..."),console.log("═══════════════════════════════════════");const t=await this._buildAvatarMap(),o="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",a={user:0,character:0,npc:0,relationshipNpc:0,stranger:0,passerby:0,total:0},i=n=>{if(n&&"object"==typeof n)if(Array.isArray(n))n.forEach(n=>i(n));else{if(n.user&&n.user.handle&&(n=>{if(!n||!n.handle)return;const e=r.clean(n.handle);if(t.has(e)){const o=t.get(e);if(n.avatar!==o.avatar){const t={user:"用户",character:"角色",npc:"NPC",relationshipNpc:"关系NPC",stranger:"陌生人"}[o.type]||o.type;console.log(`  🔄 ${t}: ${n.name} (@${e})`),console.log(`     旧头像: ${n.avatar.substring(0,60)}...`),console.log(`     新头像: ${o.avatar.substring(0,60)}...`),n.avatar=o.avatar,a[o.type]++,a.total++}}else n.avatar!==o&&(console.log(`  🔄 路人: ${n.name} (@${e}) -> 默认头像`),n.avatar=o,a.passerby++,a.total++)})(n.user),n.senderHandle&&n.senderAvatar){const e=r.clean(n.senderHandle);if(t.has(e)){const o=t.get(e);if(n.senderAvatar!==o.avatar){const t={user:"用户",character:"角色",npc:"NPC",relationshipNpc:"关系NPC",stranger:"陌生人"}[o.type]||o.type;console.log(`  🔄 ${t}[粉丝群]: ${n.senderName} (@${e})`),console.log(`     旧头像: ${n.senderAvatar.substring(0,60)}...`),console.log(`     新头像: ${o.avatar.substring(0,60)}...`),n.senderAvatar=o.avatar,a[o.type]++,a.total++}}else n.senderAvatar!==o&&(console.log(`  🔄 路人[粉丝群]: ${n.senderName} (@${e}) -> 默认头像`),n.senderAvatar=o,a.passerby++,a.total++)}for(const e in n)n.hasOwnProperty(e)&&"object"==typeof n[e]&&i(n[e])}};return i(n),console.log("═══════════════════════════════════════"),a.total>0?(console.log(`✅ [头像修正] 修正完成，共修正 ${a.total} 个头像：`),a.user>0&&console.log(`   👤 用户: ${a.user} 个`),a.character>0&&console.log(`   🎭 角色: ${a.character} 个`),a.npc>0&&console.log(`   🤖 NPC: ${a.npc} 个`),a.relationshipNpc>0&&console.log(`   👥 关系NPC: ${a.relationshipNpc} 个`),a.stranger>0&&console.log(`   👻 陌生人: ${a.stranger} 个`),a.passerby>0&&console.log(`   🚶 路人: ${a.passerby} 个`)):console.log("✅ [头像修正] 所有头像都正确，无需修正"),console.log("═══════════════════════════════════════"),n},repairJSON(n){if(console.log("🔧 [JSON修复] 开始尝试修复JSON格式错误..."),!n||"string"!=typeof n)return console.error("❌ [JSON修复] 输入不是有效的字符串"),null;let e=n,t=0;try{e=e.replace(/^[\s\S]*?```json\s*/i,"").replace(/```\s*[\s\S]*$/i,"").replace(/^[^{\[]*/,"").replace(/[^}\]]*$/,"").trim();const n=/,(\s*[}\]])/g;n.test(e)&&(e=e.replace(n,"$1"),t++,console.log("✅ [JSON修复] 已移除末尾多余逗号"));const o=/("(?:\\.|[^"\\])*?")/g;e=e.replace(o,n=>n.includes("\n")&&!n.includes("\\n")?(t++,n.replace(/\n/g,"\\n")):n);const a=/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g;a.test(e)&&(e=e.replace(a,'$1"$2":'),t++,console.log("✅ [JSON修复] 已为键名添加引号"));e.includes("'")&&(e=e.replace(/:\s*'([^']*?)'/g,': "$1"'),e=e.replace(/{\s*'([^']*?)'\s*:/g,'{"$1":'),t++,console.log("✅ [JSON修复] 已替换部分单引号为双引号")),e=e.replace(/"([^"]*)":\s*"([^"]*)"/g,(n,e,o)=>{const a=(o.match(/\\"/g)||[]).length;if((o.match(/"/g)||[]).length>a){const n=o.replace(/(?<!\\)"/g,'\\"');return t++,`"${e}": "${n}"`}return n});try{return JSON.parse(e),t>0?console.log(`✅ [JSON修复] 成功修复 ${t} 处错误，JSON现在有效`):console.log("ℹ️ [JSON修复] JSON原本就是有效的，无需修复"),e}catch(n){console.warn("⚠️ [JSON修复] 基础修复后仍无法解析，尝试深度修复..."),e=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"");const o=(e.match(/{/g)||[]).length,a=(e.match(/}/g)||[]).length,i=(e.match(/\[/g)||[]).length,r=(e.match(/\]/g)||[]).length;o>a&&(e+="}".repeat(o-a),console.log(`✅ [JSON修复] 添加了 ${o-a} 个缺失的 }`),t++),i>r&&(e+="]".repeat(i-r),console.log(`✅ [JSON修复] 添加了 ${i-r} 个缺失的 ]`),t++);try{return JSON.parse(e),console.log(`✅ [JSON修复] 深度修复成功，共修复 ${t} 处错误`),e}catch(n){return console.error("❌ [JSON修复] 修复失败，JSON仍然无效:",n.message),console.error("修复后的内容:",e.substring(0,500)+"..."),null}}}catch(n){return console.error("❌ [JSON修复] 修复过程中发生错误:",n),null}},async getApplicableWorldBooks(n,t={}){try{const o=e(),a=await o.xSettings.get("globalWorldBooks");if(!a||!a.worldBooks||0===a.worldBooks.length)return console.log("🔍 [世界书] 未找到全局世界书数据"),"";console.log(`🔍 [世界书] 当前场景: ${n}, 总世界书数: ${a.worldBooks.length}`);const{boundCharacters:i=[]}=t,r=a.worldBooks.filter(e=>{const t=e.scenes&&e.scenes.length>0,o=e.targetType&&"none"!==e.targetType;if(!t&&!o)return console.log(`⏸️ [世界书] "${e.name}" - 闲置状态，跳过应用`),!1;const a="messages"===n;if("specific"===e.targetType&&e.selectedCharacters){const n=i&&i.some(n=>e.selectedCharacters.includes(n));return console.log(`${n?"✅":"❌"} [世界书] "${e.name}" - 指定角色 (当前: [${i.join(", ")}], 需要: [${e.selectedCharacters.join(", ")}])`),n}if(a){if(t&&!e.scenes.includes("global"))return console.log(`❌ [世界书] "${e.name}" - 私信场景但绑定了其他场景 (${e.scenes.join(", ")})`),!1;if(e.scenes&&e.scenes.includes("global"))return console.log(`✅ [世界书] "${e.name}" - 全局场景，适用于所有场景`),!0;if("all"===e.targetType)return console.log(`✅ [世界书] "${e.name}" - 全局对话，适用于所有私信`),!0;if("characterOnly"===e.targetType){const n=i&&i.length>0;return console.log(`${n?"✅":"❌"} [世界书] "${e.name}" - 仅角色对话 (当前角色数: ${i.length})`),n}return console.log(`❌ [世界书] "${e.name}" - 私信场景但目标类型不适用`),!1}if(!t)return console.log(`❌ [世界书] "${e.name}" - 非私信场景且未绑定场景`),!1;if(!(e.scenes.includes("global")||e.scenes.includes(n)))return console.log(`❌ [世界书] "${e.name}" - 场景不匹配 (需要: ${e.scenes.join(", ")}, 当前: ${n})`),!1;if(console.log(`✅ [世界书] "${e.name}" - 场景匹配 (${e.scenes.join(", ")})`),e.scenes.includes("global"))return console.log(`✅ [世界书] "${e.name}" - 全局场景，无需检查目标类型`),!0;if("all"===e.targetType)return console.log(`✅ [世界书] "${e.name}" - 目标: 全局对话，适用`),!0;if("characterOnly"===e.targetType){const n=i&&i.length>0;return console.log(`${n?"✅":"❌"} [世界书] "${e.name}" - 目标: 仅角色 (角色数: ${i.length})`),n}return"none"===e.targetType?(console.log(`✅ [世界书] "${e.name}" - 场景绑定，无特定目标限制`),!0):(console.log(`❌ [世界书] "${e.name}" - 未知目标类型: ${e.targetType}`),!1)});if(0===r.length)return console.log("🔍 [世界书] 没有适用的世界书"),"";console.log(`✅ [世界书] 找到 ${r.length} 个适用的世界书: ${r.map(n=>n.name).join(", ")}`);let s="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📚 世界书（额外知识库）📚\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";return r.forEach(n=>{s+=`\n【${n.name}】\n${n.content}\n`}),s}catch(n){return console.error("获取世界书内容失败:",n),""}},async buildCharacterRelationships(n,o){if(!n||0===n.length)return"";try{const n=e(),a=`xCharacterRelationships_${o||"main"}`,i=await n.xCharacterRelationships.get(a);if(!i||!i.data)return"";const r=i.data.links||[];if(0===r.length)return"";const s=t(),l=await s.chats.toArray(),c=await n.xCharacterProfiles.toArray(),d=new Map,p=new Map;l.forEach(n=>{n.isGroup||d.set(n.id,n.name)}),c.forEach(n=>{p.set(n.characterId,n)});let g="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💞 角色关系网络（角色之间的关系）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨 重要提示：以下是已绑定角色彼此之间的关系，这些关系与用户无关！\n- 用户是独立的个体，不要将任何角色误认为用户\n- 这些关系描述的是角色A与角色B之间的互动，而非用户参与的关系\n";return r.forEach((n,e)=>{const t=d.get(n.charA)||"未知角色A",o=d.get(n.charB)||"未知角色B",a=p.get(n.charA),i=p.get(n.charB);g+=`【角色关系 ${e+1}】（角色之间的关系，与用户无关）\n`,g+=`- 角色A：${t}\n`,a&&(g+=` X平台身份：${a.xName} (${a.xHandle})\n`),g+=`- 角色B：${o}\n`,i&&(g+=` X平台身份：${i.xName} (${i.xHandle})\n`),g+=`- ${t}对${o}的关系：${n.relationshipAtoB||"未设置"}\n`,g+=`- ${o}对${t}的关系：${n.relationshipBtoA||"未设置"}\n`,n.story&&n.story.trim()&&(g+=`- 关系情节：${n.story}\n`),g+="\n"}),g+='\n【角色关系互动规则】：\n🚨 核心原则：这些是角色之间的关系，不要与用户关系混淆！\n1. 角色互动对象识别：\n- 当角色A与角色B互动时，使用上述列出的X平台身份（xName和xHandle）\n- 绝对不要将角色B误认为用户\n- 用户有独立的用户名和句柄，不要与角色身份混淆\n2. 互动频率和类型根据关系亲密度决定：\n- 亲密关系（情侣、挚友、家人等）：互动频率较高（30-50%），可以亲昵称呼、开玩笑\n- 普通关系（朋友、同事、熟人等）：互动频率中等（15-30%），保持礼貌友好\n- 紧张关系（竞争、冷战、敌对等）：互动频率较低（5-15%），可能带有暗讽、针锋相对\n3. 互动内容要符合关系设定和情节背景\n4. 避免强行制造互动，保持自然真实\n5. 如果关系情节中有具体故事，可以在互动中体现相关细节\n6. 🚨 再次强调：所有上述关系都是"角色↔角色"的关系，不是"角色↔用户"的关系！\n',g}catch(n){return console.error("构建角色关系信息失败:",n),""}}},l={buildCharacterItem(n,e=!1){const t=`character-item-${n.id}`,o=`character-avatar-${n.id}`;setTimeout(()=>{const e=document.getElementById(t),a=document.getElementById(o);if(e&&(p.addHoverEffect(e,{backgroundColor:"rgba(255,255,255,0.05)"},{backgroundColor:"transparent"}),p.safeAddEventListener(e,"click",()=>me(n.id))),a){let e;p.safeAddEventListener(a,"contextmenu",e=>(e.preventDefault(),xe(n.id),!1)),p.safeAddEventListener(a,"mousedown",()=>{e=setTimeout(()=>xe(n.id),500)}),p.safeAddEventListener(a,"mouseup",()=>clearTimeout(e)),p.safeAddEventListener(a,"mouseleave",()=>clearTimeout(e)),p.safeAddEventListener(a,"touchstart",()=>{e=setTimeout(()=>xe(n.id),500)}),p.safeAddEventListener(a,"touchend",()=>clearTimeout(e))}},0);const a=n.settings?.aiAvatar||n.aiAvatar||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"%3E%3Ccircle cx="12" cy="12" r="10" fill="%23333"/%3E%3Ctext x="12" y="16" text-anchor="middle" fill="%23fff" font-size="10"%3E?%3C/text%3E%3C/svg%3E';return`\n <div id="${t}" class="character-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #333; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">\n <img id="${o}" src="${a}" alt="${n.name||"未命名"}"\n style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; cursor: pointer;"\n title="长按设置X资料">\n <div style="flex: 1; min-width: 0;">\n <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 2px;">${n.name||"未命名"}</div>\n <div style="color: #71767b; font-size: 13px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">\n ${n.originalName||""}\n </div>\n <div style="color: var(--x-accent); font-size: 11px; margin-top: 2px;">\n 长按头像设置X资料\n </div>\n </div>\n ${this.buildCheckbox(n.id,e)}\n </div>\n `},buildCheckbox:(n,e)=>`\n <div class="character-checkbox" data-character-id="${n}" style="width: 20px; height: 20px; border: 2px solid ${e?"var(--x-accent)":"#71767b"}; border-radius: 4px; display: flex; align-items: center; justify-content: center; background-color: ${e?"var(--x-accent)":"#71767b"}; transition: all 0.2s; ">\n ${e?'<svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #fff;"><path d="M9 16.17L5.53 12.7l-1.06 1.06L9 18.3l9.54-9.54-1.06-1.06L9 16.17z"/></svg>':""}\n </div>\n `,buildCharacterInfoDisplay:n=>`\n <div style="display: flex; align-items: center; gap: 16px;">\n <img src="${n.settings?.aiAvatar||n.aiAvatar||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"%3E%3Ccircle cx="12" cy="12" r="10" fill="%23333"/%3E%3Ctext x="12" y="16" text-anchor="middle" fill="%23fff" font-size="10"%3E?%3C/text%3E%3C/svg%3E'}" alt="${n.name||"未命名"}" style="width: 60px; height: 60px; border-radius: 50%;">\n <div>\n <div style="color: #fff; font-size: 18px; font-weight: 600; margin-bottom: 4px;">${n.name||"未命名"}</div>\n <div style="color: #71767b; font-size: 14px;">本名：${n.originalName||"未知"}</div>\n <div style="color: #71767b; font-size: 14px;">设置该角色在X平台的专属身份资料</div>\n </div>\n </div>\n `,buildEmptyState:n=>`<p style="color: #71767b; text-align: center; padding: 20px;">${n}</p>`,buildErrorState:n=>`<p style="color: #f4212e; text-align: center; padding: 20px;">${n}</p>`},c={validateRequired(n){const e=[];for(const[t,o]of Object.entries(n))o&&""!==o.trim()||e.push(t);return{isValid:0===e.length,missing:e}},validateHandle:n=>n?n.length>15?{isValid:!1,error:"句柄长度不能超过15个字符"}:/^[a-zA-Z0-9_]+$/.test(n)?{isValid:!0}:{isValid:!1,error:"句柄只能包含字母、数字和下划线"}:{isValid:!1,error:"句柄不能为空"},validateName:(n,e=30)=>n?n.length>e?{isValid:!1,error:`名称长度不能超过${e}个字符`}:{isValid:!0}:{isValid:!1,error:"名称不能为空"},safeParseJSON(n,e=null){try{return JSON.parse(n)}catch(n){return console.error("JSON解析失败:",n),e}},safeGetElement(n){const e=document.getElementById(n);return e||console.warn(`未找到元素: ${n}`),e},handleError(n,e=""){console.error(`${e} 错误:`,n),mn(`${e}失败: ${n.message}`,"error")}},d={estimateTokens(n){if(!n)return 0;const e=(n.match(/[\u4e00-\u9fa5]/g)||[]).length,t=n.length-e;return Math.ceil(e/2+t/4)},logTokenUsage(n,e,t,o=0){const a=this.estimateTokens(t),i=o+a;return console.log(`📊 [${n}] ${e}: ${a.toLocaleString()} tokens | 累计: ${i.toLocaleString()} tokens`),i},logFinalPrompt(n,e,t="",o=""){const a=this.estimateTokens(e),i=this.estimateTokens(t),r=this.estimateTokens(o),s=a+i+r;return console.log(`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📊 [${n}] Token使用统计\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n系统提示词: ${a.toLocaleString()} tokens\n用户消息: ${i.toLocaleString()} tokens\n上下文信息: ${r.toLocaleString()} tokens\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n总计: ${s.toLocaleString()} tokens\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n `),{systemTokens:a,userTokens:i,contextTokens:r,totalTokens:s}}},p={addHoverEffect(n,e={},t={}){n&&(n.addEventListener("mouseover",()=>{Object.assign(n.style,e)}),n.addEventListener("mouseout",()=>{Object.assign(n.style,t)}))},addHoverEffectBatch(n,e={},t={}){document.querySelectorAll(n).forEach(n=>{this.addHoverEffect(n,e,t)})},addButtonHover(n){this.addHoverEffect(n,{backgroundColor:"rgba(255,255,255,0.1)"},{backgroundColor:"transparent"})},addLinkUnderlineHover(n,e="span"){n&&(n.addEventListener("mouseover",()=>{const t=e?n.querySelector(e):n;t&&(t.style.textDecoration="underline")}),n.addEventListener("mouseout",()=>{const t=e?n.querySelector(e):n;t&&(t.style.textDecoration="none")}))},safeAddEventListener(n,e,t){n&&"function"==typeof t&&n.addEventListener(e,t)},debounce(n,e){let t;return function(...o){clearTimeout(t),t=setTimeout(()=>{clearTimeout(t),n(...o)},e)}},throttle(n,e){let t;return function(...o){t||(n.apply(this,o),t=!0,setTimeout(()=>t=!1,e))}}},g={_getGeminiResponseText:n=>n.candidates&&n.candidates[0]&&n.candidates[0].content&&n.candidates[0].content.parts&&n.candidates[0].content.parts[0].text||"",async loadConfigAndSettings(n=null){const o=t(),a=e(),i=await o.apiConfig.get("main");if(!(i&&i.proxyUrl&&i.apiKey&&i.model))throw new Error("请先配置API设置");const r=`xSettings_${n||vt||"main"}`,s=await a.xSettings.get(r);return{db:o,xDb:a,apiConfig:i,xSettings:{userPrompt:s?.systemPrompt||"",worldSetting:s?.worldSetting||"",boundCharacters:s?.boundCharacters||[]}}},async loadBoundNPCs(n=null){const t=e(),o=await t.xNPCs.get("xNPCs_global"),a=n||vt||"main",i=(o?.npcs||[]).filter(n=>n.boundUsers&&n.boundUsers.includes(a));return i.length>0&&console.log(`📋 已加载 ${i.length} 个绑定NPC:`,i.map(n=>`${n.name}(${n.handle})`).join(", ")),i},async sendAIRequest({apiConfig:n,systemPrompt:e,messages:t,temperature:o=.8}){const{proxyUrl:a,apiKey:i,model:r}=n,s=a.includes("generativelanguage");let l;if(s){const n={url:`${"https://generativelanguage.googleapis.com/v1beta/models"}/${r}:generateContent?key=${getRandomValue(i)}`,data:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:e+"\n\n"+t.map(n=>Array.isArray(n.content)?n.content.map(n=>n.text||"[图片]").join(" "):n.content).join("\n")}]}],generationConfig:{temperature:o}})}};l=await fetch(n.url,n.data)}else{const n={model:r,messages:[{role:"system",content:e},...t],temperature:o,stream:!1};l=await fetch(`${a}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(n)})}if(!l.ok){const n=await l.json();throw new Error(`API错误: ${l.status} - ${n.error?.message||l.statusText}`)}const c=await l.json();let d;return d=s?this._getGeminiResponseText(c):c.choices?.[0]?.message?.content||"",console.log("AI原始响应:",d),d},parseJSONResponse(n){const e=n.replace(/```json\s*/i,"").replace(/```\s*$/,"").trim();if(!e)throw new Error("AI返回了空的响应内容");try{return JSON.parse(e)}catch(n){console.warn("⚠️ [JSON解析] 直接解析失败，尝试使用修复工具..."),console.error("原始错误:",n.message),console.error("尝试解析的内容:",e.substring(0,500)+"...");const t=s.repairJSON(e);if(!t)throw console.error("❌ [JSON解析] JSON修复工具无法修复"),new Error(`AI返回的数据不是有效的JSON格式: ${n.message}`);try{const n=JSON.parse(t);return console.log("✅ [JSON解析] 使用修复工具成功解析"),n}catch(n){throw console.error("❌ [JSON解析] 修复后仍然无法解析:",n.message),new Error(`AI返回的数据无法修复: ${n.message}`)}}},postProcessData:async(n,e=null)=>(n=await s.filterUserImpersonation(n,e?.handle,e?.name),await s.enforceAvatarRules(n),n)},m={formatNumber:n=>null==n?"0":n<1e3?n.toString():n<1e6?(n/1e3).toFixed(1).replace(/\.0$/,"")+"K":n<1e9?(n/1e6).toFixed(1).replace(/\.0$/,"")+"M":(n/1e9).toFixed(1).replace(/\.0$/,"")+"B",formatTime(n){const e=new Date(n),t=new Date,o=Math.floor((t-e)/1e3);return o<60?"刚刚":o<3600?Math.floor(o/60)+"分钟前":o<86400?Math.floor(o/3600)+"小时前":o<2592e3?Math.floor(o/86400)+"天前":e.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric"})},generateId:(n="id")=>`${n}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,deepClone(n){if(null===n||"object"!=typeof n)return n;if(n instanceof Date)return new Date(n.getTime());if(n instanceof Array)return n.map(n=>this.deepClone(n));if("object"==typeof n){const e={};for(const t in n)n.hasOwnProperty(t)&&(e[t]=this.deepClone(n[t]));return e}},uniqueArray(n,e=null){if(e){const t=new Set;return n.filter(n=>{const o=n[e];return!t.has(o)&&(t.add(o),!0)})}return[...new Set(n)]},safeGet(n,e,t=null){const o=e.split(".");let a=n;for(const n of o){if(null==a||!a.hasOwnProperty(n))return t;a=a[n]}return a},sortBy(n,e,t=!0){return n.sort((n,o)=>{const a=this.safeGet(n,e),i=this.safeGet(o,e);return a<i?t?-1:1:a>i?t?1:-1:0})},paginate(n,e=1,t=10){const o=(e-1)*t;return{data:n.slice(o,o+t),pagination:{page:e,limit:t,total:n.length,totalPages:Math.ceil(n.length/t),hasNext:o+t<n.length,hasPrev:e>1}}}},x={cache:new Map,setCache(n,e,t=3e5){this.cache.set(n,{value:e,expiry:Date.now()+t})},getCache(n){const e=this.cache.get(n);return e?Date.now()>e.expiry?(this.cache.delete(n),null):e.value:null},cleanExpiredCache(){const n=Date.now();for(const[e,t]of this.cache.entries())n>t.expiry&&this.cache.delete(e)},batchDOMUpdate(n){const e=document.createDocumentFragment();return n.forEach(n=>{"function"==typeof n&&n(e)}),e},defer:(n,e=0)=>setTimeout(n,e),idle:e=>n.requestIdleCallback?n.requestIdleCallback(e):setTimeout(e,1),measurePerformance:(n,e)=>async(...t)=>{const o=performance.now();try{const a=await e(...t),i=performance.now();return console.log(`Performance [${n}]: ${(i-o).toFixed(2)}ms`),a}catch(e){const t=performance.now();throw console.error(`Performance [${n}] Error: ${(t-o).toFixed(2)}ms`,e),e}}};function u(t){if("notifications"===t||"messages"===t){if(void 0!==n.xSocialAuth&&!n.xSocialAuth.hasAccess())return console.log(`🔒 访问 ${t} 页面需要社交功能权限`),void n.xSocialAuth.requestAccess();void 0!==n.xSocialAuth&&n.xSocialAuth.validateToken&&n.xSocialAuth.validateToken().catch(e=>{console.error("社交功能 Token 验证失败:",e),setTimeout(()=>{n.location.reload()},1500)})}["home","notifications","messages","settings","profile"].includes(t)&&w&&(console.log("📖 [导航] 切换到其他页面，清除搜索结果标记"),w=!1,v=""),"home"===t?yn("home"):"notifications"===t?yn("notifications"):"messages"===t&&yn("messages"),o(".x-page");const r=document.getElementById("x-"+t+"-page");r&&(r.style.display="flex");const s=document.querySelector(".x-top-bar"),l=document.querySelector(".x-bottom-nav"),c=document.querySelector(".refresh-trends-btn");"askbox"===t||"live"===t?(s&&(s.style.display="none"),l&&(l.style.display="none"),c&&(c.style.display="none")):(s&&(s.style.display="flex"),l&&(l.style.display="flex"),c&&(c.style.display="search"===t?"flex":"none")),a(".x-nav-item","active"),i(".x-nav-item svg","fill","#fff"),o(".nav-highlight");const d={home:0,search:1,notifications:2,messages:3,settings:-1,profile:-1,askbox:-1,live:-1}[t];"profile"===t?setTimeout(()=>{dt(),$o()},100):"askbox"===t?setTimeout(()=>{Zs()},100):"live"===t?setTimeout(async()=>{await Ca()},100):"search"===t?setTimeout(()=>{!async function(){if(await A(),L(),w&&v){document.getElementById("trending-view").style.display="none",document.getElementById("search-results-view").style.display="flex";const n=document.getElementById("search-back-btn");n&&(n.style.display="flex");const e=document.querySelector(".refresh-trends-btn");e&&(e.style.display="none")}else{document.getElementById("trending-view").style.display="flex",document.getElementById("search-results-view").style.display="none";const n=document.querySelector(".refresh-trends-btn");n&&(n.style.display="flex");const e=document.getElementById("search-back-btn");e&&(e.style.display="none")}try{const n=e(),t=await n.xTweetsData.get("trends");t&&(t.recommended&&t.trending&&(f.recommended=t.recommended,f.trending=t.trending),b.forEach(n=>{t[n.id]&&(f[n.id]=t[n.id])}),console.log("✅ 已从数据库加载热搜数据"))}catch(n){console.log("⚠️ 加载热搜数据失败，使用默认数据:",n)}C()}()},100):"notifications"===t?setTimeout(async()=>{await bl()},100):"messages"===t&&setTimeout(async()=>{await pc()},100),"settings"===t&&setTimeout(async()=>{await oe(),await async function(){try{const n=e(),t=`xLanguage_${vt||"main"}`,o=await n.xSettings.get(t);o&&o.language&&(Hn=o.language,Un(Hn))}catch(n){console.error("加载语言偏好失败:",n)}}(),await qn(),console.log("✅ 已加载当前账号的X设置")},100);const p=document.querySelectorAll(".x-nav-item");p[d]&&d>=0&&(p[d].classList.add("active"),p[d].querySelector("svg").style.fill="var(--x-accent)",p[d].querySelector(".nav-highlight").style.display="block")}setInterval(()=>x.cleanExpiredCache(),6e4);let h="recommended",f={recommended:[{id:"t1",category:"娱乐 · 热门话题",title:"流行电影讨论",count:125600},{id:"t2",category:"体育 · 实时",title:"篮球比赛精彩瞬间",count:89200},{id:"t3",category:"科技 · 趋势",title:"AI技术新突破",count:256700},{id:"t4",category:"音乐 · 流行",title:"新专辑发布",count:67800},{id:"t5",category:"游戏 · 热门",title:"年度游戏评选",count:145300}],trending:[{id:"t6",category:"全球 · 趋势",title:"国际新闻热点",count:892300},{id:"t7",category:"商业 · 财经",title:"股市最新动态",count:234500},{id:"t8",category:"社会 · 讨论",title:"社会话题关注",count:456700},{id:"t9",category:"文化 · 热议",title:"传统文化传承",count:178900},{id:"t10",category:"健康 · 生活",title:"养生健康小贴士",count:123400}]},b=[],v="",y="top",w=!1,k={top:[],latest:[],users:[]};function $(n){h=n;const e=document.querySelectorAll(".search-tab");e.forEach(n=>{n.classList.remove("active")});const t=Array.from(e).find(e=>e.onclick&&e.onclick.toString().includes(n));t&&t.classList.add("active"),C()}function C(){const n=document.getElementById("trending-list");if(!n)return;const e=f[h]||[];0!==e.length?n.innerHTML=e.map(n=>`\n <div class="trending-item" onclick="handleTrendingClick('${n.id}')">\n <div class="trending-header">\n <div class="trending-category">${n.category}</div>\n <div class="trending-more" onclick="event.stopPropagation(); handleTrendingMore('${n.id}')">\n <svg viewBox="0 0 24 24" aria-hidden="true">\n <g><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></g>\n </svg>\n </div>\n </div>\n <div class="trending-title">${n.title}</div>\n <div class="trending-count">${N(n.count)} 条帖子</div>\n </div>\n`).join(""):n.innerHTML='\n <div style="display: flex; justify-content: center; align-items: center; padding: 40px 20px; color: #71767b;">\n 暂无热搜内容\n </div>\n '}function I(){const n=document.getElementById("search-input"),e=document.getElementById("search-submit-btn");n&&e&&(n.value.trim()?e.style.display="flex":e.style.display="none")}function S(){const n=document.getElementById("search-results-content");if(!n)return;const e=k[y]||[];0!==e.length?"users"===y?n.innerHTML=e.map(n=>`\n <div style="padding: 16px; border-bottom: 1px solid #2f3336; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <img\n src="${n.avatar}"\n alt="${n.name}"\n onclick="event.stopPropagation(); openAccountProfile('${n.name.replace(/'/g,"\\'")}', '${n.handle.startsWith("@")?n.handle:"@"+n.handle}', '${n.avatar}', {\n source: 'search',\n searchQuery: '${v.replace(/'/g,"\\'")}',\n userBio: '${(n.bio||"").replace(/'/g,"\\'")}',\n verified: ${n.verified||!1}\n })"\n style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0; cursor: pointer; transition: opacity 0.2s; "\n onmouseover="this.style.opacity='0.8'"\n onmouseout="this.style.opacity='1'">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${n.name}</span>\n ${n.verified?'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);">\n <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.26 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.45 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>\n </svg>':""}\n </div>\n <div style="color: #71767b; font-size: 15px; margin-bottom: 4px;">@${n.handle}</div>\n ${n.bio?`<div style="color: #e7e9ea; font-size: 14px;">${n.bio}</div>`:""}\n </div>\n </div>\n `).join(""):(n.innerHTML="",e.forEach(e=>{const t=H(e);n.appendChild(t);const o=t.querySelector(".tweet-action.comment");o&&(o.removeAttribute("onclick"),o.addEventListener("click",async n=>{n.stopPropagation(),console.log("📖 [搜索结果] 点击评论按钮，显示详情:",e.id),await showSearchTweetDetail(e.id)}))})):n.innerHTML='\n <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #71767b; ">\n <svg viewBox="0 0 24 24" style="width: 80px; height: 80px; fill: #71767b; margin-bottom: 20px;">\n <g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g>\n </svg>\n <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">没有找到结果</div>\n <div style="font-size: 14px;">尝试搜索其他内容</div>\n </div>\n '}async function M(){const e=document.getElementById("search-input"),t=e?.value?.trim();if(!t)return void mn("请输入搜索内容","info");v=t,w=!0,document.getElementById("trending-view").style.display="none",document.getElementById("search-results-view").style.display="flex";const o=document.getElementById("search-back-btn");o&&(o.style.display="flex");const a=document.querySelector(".refresh-trends-btn");a&&(a.style.display="none");document.getElementById("search-results-content").innerHTML=`\n <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #71767b; ">\n <div style="width: 40px; height: 40px; border: 3px solid var(--x-accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; "></div>\n <div style="margin-top: 20px; font-size: 15px;">正在搜索"${t}"...</div>\n </div>\n`;try{const{apiConfig:e,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r,boundCharacters:l}=o,c=s.buildUserXProfileInfo(n.userProfileData),p=await a.xCharacterProfiles.toArray(),m=[];for(const n of l){const e=p.find(e=>e.characterId===n);e&&m.push(e)}const x=c.publicIdentity||"",u=c.bio||"",h=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(x+" "+u);let f=0,b=s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});f=d.logTokenUsage("搜索生成器","基础系统提示词",b,f);const v=await s.getApplicableWorldBooks("search",{boundCharacters:l});v&&(b+=v,f=d.logTokenUsage("搜索生成器","世界书内容",v,f));const y=new Set;if(v)for(const n of l){const e=p.find(e=>e.characterId===n);if(e){const t=e.xName||"",o=e.xHandle||"";(t&&v.includes(t)||o&&v.includes(o))&&(y.add(n),console.log(`🔍 世界书中提到角色: ${t} (${o})`))}}const w=[],$=t.toLowerCase();for(const n of m){let e=!1;const t=n.publicIdentity||"";if(/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(t)){const o=n.xName||"",a=n.xHandle||"",i=n.xBio||"";(o.toLowerCase().includes($)||$.includes(o.toLowerCase())||a.toLowerCase().includes($)||$.includes(a.toLowerCase())||t.toLowerCase().includes($)||$.includes(t.toLowerCase())||i&&(i.toLowerCase().includes($)||$.includes(i.toLowerCase())))&&(e=!0)}if(n.showRealName&&n.realName){const t=n.realName.toLowerCase();(t.includes($)||$.includes(t))&&(e=!0)}e&&w.push({type:"character",characterId:n.characterId,xProfile:n,name:n.xName,handle:n.xHandle,avatar:n.xAvatar,verified:n.xVerified||!1,publicIdentity:t,bio:n.xBio||"",reason:"公众人物或真名搜索"})}const C="xNPCs_global",I=await a.xNPCs.get(C),M=vt||"main",T=(I?.npcs||[]).filter(n=>n.boundUsers&&n.boundUsers.includes(M));for(const n of T){const e=n.name||"",t=n.handle||"",o=n.personality||"",a=n.homepage||"";(e.toLowerCase().includes($)||$.includes(e.toLowerCase())||t.toLowerCase().includes($)||$.includes(t.toLowerCase())||o.toLowerCase().includes($)||a.toLowerCase().includes($))&&w.push({type:"npc",npc:n,name:e,handle:t,avatar:n.avatar,verified:!1,publicIdentity:"",bio:"",reason:"NPC账户匹配"})}for(const n of p)if(n.relationships&&n.relationships.length>0)for(const e of n.relationships){const t=e.npcName||"",o=e.npcHandle||"",a=e.relationshipType||"",i=e.description||"";(t.toLowerCase().includes($)||$.includes(t.toLowerCase())||o.toLowerCase().includes($)||$.includes(o.toLowerCase())||a.toLowerCase().includes($)||i.toLowerCase().includes($))&&w.push({type:"relationshipNpc",relationship:e,ownerXProfile:n,name:t,handle:o,avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1,publicIdentity:"",bio:"",reason:"关系NPC匹配"})}console.log("🔍 搜索匹配检查:",{query:t,"角色":w.filter(n=>"character"===n.type).length,NPC:w.filter(n=>"npc"===n.type).length,"关系NPC":w.filter(n=>"relationshipNpc"===n.type).length,"总计":w.length});for(const n of y)if(!w.find(e=>"character"===e.type&&e.characterId===n)){const e=p.find(e=>e.characterId===n);e&&w.push({type:"character",characterId:e.characterId,xProfile:e,name:e.xName,handle:e.xHandle,avatar:e.xAvatar,verified:e.xVerified||!1,publicIdentity:e.publicIdentity||"",bio:e.xBio||"",reason:"世界书提及"})}console.log("🔍 搜索隐私检查（优化后）:",{query:t,isUserPublicFigure:h,totalCharacters:l.length,totalNPCs:T.length,worldBookMentioned:y.size,allowedTotal:w.length,allowedList:w.map(n=>`${n.name} (${n.reason})`)});const A=await bn("搜索生成器",{usageRate:.3,usageDescription:"**搜索场景的大事件使用**：\n1. **关键词匹配**：如果搜索关键词与某个大事件相关（标题、分类、详情中包含关键词），应该优先在搜索结果中展示\n2. **相关推文**：如果大事件与搜索关键词相关，热门推文和最新推文应该包含讨论该事件的内容\n3. **相关用户**：如果大事件涉及某些人物/机构，用户列表可能包含相关账户\n4. **自然关联**：即使关键词不完全匹配，如果搜索主题与大事件相关，也可以适度融入\n5. **使用率说明**：只有当关键词与大事件相关时才融入，不相关则忽略"});A&&(b+=A,f=d.logTokenUsage("搜索生成器","世界运转大事件",A,f)),b+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的搜索结果生成器。用户搜索了关键词："${t}"\n这是全局搜索，需要生成符合搜索关键词的X平台内容。\n请生成与搜索关键词相关的结果：\n- 热门：3-8条与关键词高度相关的热门推文\n- 最新：3-5条与关键词相关的最新推文\n- 用户：2-6个与关键词相关的X用户账号\n【重要隐私规则】：\n${0!==w.length||h?"":"- **禁止出现绑定身份**：用户和所有绑定身份都不符合搜索条件\n- 生成的所有内容必须是虚构的陌生用户，不能使用任何绑定角色/NPC的信息\n- 这是全局搜索，应该展示与关键词相关的公众内容，而非私人关系"}\n${h&&$.includes(c.name.toLowerCase())?"- **用户是公众人物且搜索了用户相关关键词**：可以生成少量与用户相关的内容（1-2条）":""}\n${w.length>0?`- **允许出现以下身份**（仅限这些）：${w.map(n=>`${n.name}[${n.reason}]`).join("、")}\n- 原因说明：\n* "公众人物或真名搜索"：该角色是公众人物且搜索关键词与他们相关，或搜索了他们公开的真名\n* "世界书提及"：该角色在世界书中被提及，可以根据世界书的上下文在搜索结果中出现\n* "NPC账户匹配"：该NPC的名称、句柄或人设与搜索关键词匹配\n* "关系NPC匹配"：该关系NPC的名称、句柄或关系描述与搜索关键词匹配\n- 其他未列出的身份严禁出现`:"- **禁止出现任何绑定身份**：没有身份符合出现条件（非公众人物、搜索关键词不相关、且未在世界书中提及）"}\n【生成要求】：\n- 所有内容必须与搜索关键词"${t}"高度相关\n- 热门推文应该有较高的互动数据（点赞、转发、评论）\n- 最新推文时间较近（几分钟到几小时前）\n- 推文内容要多样化，从不同角度体现搜索关键词\n- 每条推文2-5条评论即可\n- 用户账号要有相关性（用户名、简介、或身份与关键词相关）\n- 除已绑定角色外，其他用户头像统一：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n- 这是全局搜索，应展示多样化的陌生用户内容，而非私人社交圈\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const E=b.substring(b.indexOf("🎯 核心任务说明 🎯"));if(f=d.logTokenUsage("搜索生成器","搜索任务说明",E,f),w.length>0){const n=b.length;b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 允许出现的身份信息\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下是符合搜索条件、可以在结果中出现的身份：\n";for(const n of w){b+=`\n【${n.name}】（${"character"===n.type?"角色":"npc"===n.type?"NPC":"关系NPC"}）\n- X姓名：${n.name}\n- X句柄：${n.handle}\n- X头像：${n.avatar}\n- 认证状态：${n.verified?"已认证":"未认证"}\n${n.publicIdentity?`- 公众身份：${n.publicIdentity}`:""}\n${n.bio?`- X简介：${n.bio}`:""}\n- 出现原因：${n.reason}\n`,"character"===n.type&&n.xProfile?n.xProfile.showRealName&&n.xProfile.realName&&(b+=`- 真实姓名：${n.xProfile.realName}（已公开）\n`):"npc"===n.type&&n.npc?(n.npc.personality&&(b+=`- 人设：${n.npc.personality}\n`),n.npc.postingHabits&&(b+=`- 发帖习惯：${n.npc.postingHabits}\n`)):"relationshipNpc"===n.type&&n.relationship&&(b+=`- 关系类型：与 ${n.ownerXProfile.xName} (${n.ownerXProfile.xHandle}) 的 ${n.relationship.relationshipType}\n`,n.relationship.description&&(b+=`- 关系描述：${n.relationship.description}\n`));try{const e=n.handle.replace("@",""),t=await a.xAccountProfiles.get(e),o=t?.tweets?.slice(0,5)||[];o.length>0&&(b+=`\n${n.name} 的近期推文（${o.length}条）：\n`,o.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发\n${n.media&&n.media.length>0?` - 媒体：${n.media[0].description.substring(0,50)+"..."}\n`:""}`}))}catch(e){console.warn(`搜索生成器：读取 ${n.name} 的推文失败:`,e)}b+="\n"}b+='\n【使用规则】：\n- 只能使用上述列出的身份信息\n- 必须严格使用其X姓名、句柄、头像、认证状态\n- 如果他们与搜索关键词相关，可以作为推文发布者或出现在用户列表中\n- 可以基于他们的近期推文内容生成相关的搜索结果\n- 标注为"世界书提及"的角色，说明他们在世界书中被提及\n- 标注为"公众人物或真名搜索"的角色，说明他们是公众人物且与搜索关键词相关\n- 标注为"NPC账户匹配"的NPC，说明其信息与搜索关键词匹配\n- 标注为"关系NPC匹配"的关系NPC，说明其关系信息与搜索关键词匹配\n- 其他未列出的身份严禁出现\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';const e=b.substring(n);f=d.logTokenUsage("搜索生成器","允许身份信息与推文",e,f)}const z=b.length;if(b+=s.buildUniversalConstraints(c),h&&$.includes(c.name.toLowerCase())){b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📰 用户近期推文（公众人物）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";try{const n=`userTweets_${vt||"main"}`,e=await a.xUserTweets.get(n),t=e?.tweets?.slice(0,5)||[];t.length>0?(b+=`${c.name} 的近期推文（${t.length}条）：\n`,t.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n${n.image?` - 媒体：${"description"===n.image.type?n.image.content.substring(0,50)+"...":"包含图片"}\n`:""}`}),b+="\n【使用说明】：\n- 可以基于用户的近期推文生成相关的搜索结果\n- 用户是公众人物，可以在搜索结果中适度出现（1-2条推文）\n- 但仍然禁止在评论区假扮用户身份\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"):b+="暂无近期推文数据\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"}catch(n){console.warn("搜索生成器：读取用户推文失败:",n),b+="暂无近期推文数据\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"}}const B=b.substring(z);f=d.logTokenUsage("搜索生成器","用户资料约束与推文",B,f),b+=`\n【JSON返回格式】：\n\`\`\`json\n{\n"top": [热门推文数组(3-5条)],\n"latest": [最新推文数组(3-5条)],\n"users": [用户数组(2-4个)]\n}\n\`\`\`\n推文对象结构：\n- user: {name, handle, avatar, verified}\n- content: 推文文本（必须与"${t}"相关）\n- time: 时间描述\n- stats: {comments, retweets, likes, views} (纯数字)\n- media: [{type:"description", description:"描述，至少20字", sensitive:false}] (可选，30-50%推文包含)\n- comments: [评论数组(2-5条，必须生成)]\n评论对象结构：\n- id: 评论唯一ID（可留空，系统自动生成）\n- user: {name, handle, avatar, verified}\n- content: 评论文本\n- time: 时间描述\n- image: {type: "description", content: "图片文字描述"} (可选，10-20%的评论带图)\n- replies: [楼中楼回复数组] (可选，0-2条)\n楼中楼回复对象结构：\n- id: 回复唯一ID（可留空，系统自动生成）\n- user: {name, handle, avatar, verified}\n- content: 回复文本\n- time: 时间描述\n- image: {type: "description", content: "图片文字描述"} (可选)\n- replyTo: "@被回复者句柄" (必填)\n用户对象结构：\n- name: 用户姓名\n- handle: 用户句柄（不带@）\n- avatar: 头像URL\n- verified: 布尔值\n- bio: 个人简介（体现与"${t}"的关联）\n关键规则：\n1. 所有内容必须围绕搜索关键词"${t}"展开\n2. 热门推文stats高（1万-50万），最新推文stats低（100-5千）\n3. 最新推文时间近（刚刚、几分钟前、1小时前等）\n4. verified字段必须是布尔值(true/false)\n5. stats中所有数字必须是纯数字\n6. 每条推文必须包含2-5条评论，10-20%的评论可带图\n7. 评论可以包含楼中楼回复（replies数组），形成对话链${r.trim()?"\n8. 严格遵守世界观设定":""}\n【🔒 隐私保护规则】：\n🚨 搜索结果中的评论者（非绑定角色/关系NPC的路人）只能基于X平台公开信息：\n✅ 可以使用：X姓名、X句柄、X简介、公开身份\n❌ 禁止提及：真实姓名、真实职业、私人关系、未公开的身份信息\n❌ 禁止使用：只有亲密关系才知道的称呼（如"老师"、"同学"等，除非是公开身份）\n⚠️ 只有已绑定的关系NPC才能在评论中提及私密信息（因为他们是角色的私人关系）\n`;const L=b.substring(b.lastIndexOf("【JSON返回格式】"));f=d.logTokenUsage("搜索生成器","JSON格式要求",L,f);const P=[{role:"user",content:`请生成关键词"${t}"的搜索结果`}];d.logFinalPrompt("搜索生成器",b,P[0].content);const D=await g.sendAIRequest({apiConfig:e,systemPrompt:b,messages:P,temperature:.8});let N=g.parseJSONResponse(D);if(N=await g.postProcessData(N,c),!N.top||!N.latest||!N.users)throw new Error("AI返回的数据格式不正确，缺少必要字段");const R=Date.now();N.top=N.top.map((n,e)=>({...n,id:`search_top_${R}_${e}`,_source:"search",comments:n.comments?.map((n,t)=>{const o={...n,id:`search_top_${R}_${e}_c${t}`};return n.replies&&n.replies.length>0&&(o.replies=n.replies.map((n,o)=>({...n,id:`search_top_${R}_${e}_c${t}_r${o}`}))),o})||[]})),N.latest=N.latest.map((n,e)=>({...n,id:`search_latest_${R}_${e}`,_source:"search",comments:n.comments?.map((n,t)=>{const o={...n,id:`search_latest_${R}_${e}_c${t}`};return n.replies&&n.replies.length>0&&(o.replies=n.replies.map((n,t)=>({...n,id:`search_latest_${R}_${e}_c${t}`}))),o})||[]})),k.top=N.top,k.latest=N.latest,k.users=N.users;try{await a.xTweetsData.put({id:`search_${t}`,query:t,results:N,timestamp:(new Date).toISOString()}),console.log("✅ 搜索结果已保存到数据库")}catch(n){console.error("⚠️ 保存搜索结果失败:",n)}S(),mn(`找到 ${N.top.length+N.latest.length} 条相关推文`,"success")}catch(n){console.error("❌ 搜索失败:",n),mn(`搜索失败: ${n.message}`,"error");document.getElementById("search-results-content").innerHTML=`\n <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #f4212e; ">\n <svg viewBox="0 0 24 24" style="width: 80px; height: 80px; fill: #f4212e; margin-bottom: 20px;">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></g>\n </svg>\n <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">搜索出错</div>\n <div style="font-size: 14px; color: #71767b;">${n.message}</div>\n </div>\n `}}function T(n){if(n&&n.target!==n.currentTarget)return;const e=document.getElementById("category-manager-modal");e&&(e.style.display="none")}async function A(){try{const n=e(),t=`customCategories_${vt||"main"}`,o=await n.xTweetsData.get(t);o&&o.categories?(b=o.categories,console.log("✅ 已加载自定义分类:",b.length,"个")):b=[]}catch(n){console.error("⚠️ 加载自定义分类失败:",n),b=[]}}function E(){const n=document.getElementById("custom-categories-list");n&&(0!==b.length?n.innerHTML=b.map((n,e)=>`\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 16px; ">\n <div style="display: flex; align-items: flex-start; gap: 12px;">\n\n <label style="display: flex; align-items: center; cursor: pointer; margin-top: 4px; ">\n <input\n type="checkbox"\n ${n.enabled?"checked":""}\n onchange="toggleCategory(${e})"\n style="width: 18px; height: 18px; accent-color: var(--x-accent); cursor: pointer; ">\n </label>\n\n <div style="flex: 1; min-width: 0;">\n\n <div style="margin-bottom: 12px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 4px; ">分类名称 *</label>\n <input\n type="text"\n value="${n.name||""}"\n placeholder="例如：动漫"\n onchange="updateCategoryName(${e}, this.value)"\n style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 8px 12px; font-size: 15px; outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='#333'">\n </div>\n\n <div style="margin-bottom: 12px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 4px; ">分类内容/类型（可选）</label>\n <textarea\n placeholder="例如：动画、漫画、声优、番剧相关内容"\n onchange="updateCategoryDescription(${e}, this.value)"\n style="width: 100%; min-height: 60px; background-color:#000; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 8px 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='#333'">${n.description||""}</textarea>\n </div>\n\n <div style="display: flex; align-items: center; justify-content: space-between; color:${n.enabled?"var(--x-accent)":"#71767b"}; font-size: 12px; ">\n <span>${n.enabled?"✅ 已启用":"❌ 已禁用"}</span>\n <button\n onclick="deleteCategory(${e})"\n style="background: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 16px; padding: 4px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s; "\n onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"\n onmouseout="this.style.backgroundColor='transparent'">\n 删除\n </button>\n </div>\n </div>\n </div>\n </div>\n`).join(""):n.innerHTML='\n <div style="text-align: center; padding: 40px 20px; color: #71767b; font-size: 14px; ">\n 还没有自定义分类，点击"添加分类"按钮创建\n </div>\n ')}function z(n){confirm("确定要删除这个分类吗？")&&(b.splice(n,1),E())}function B(n){b[n]&&(b[n].enabled=!b[n].enabled,E())}function L(){const n=document.querySelector(".search-tabs");if(!n)return;const e=n.querySelector(".add-category-btn");n.innerHTML="";const t=document.createElement("div");t.className="search-tab"+("recommended"===h?" active":""),t.textContent="为你推荐",t.onclick=()=>$("recommended"),n.appendChild(t);const o=document.createElement("div");o.className="search-tab"+("trending"===h?" active":""),o.textContent="当前趋势",o.onclick=()=>$("trending"),n.appendChild(o),b.filter(n=>n.enabled&&n.name).forEach(e=>{const t=document.createElement("div");t.className="search-tab"+(h===e.id?" active":""),t.textContent=e.name,t.onclick=()=>$(e.id),n.appendChild(t)}),e&&n.appendChild(e)}n.showSearchTweetDetail=async function(n){console.log("📖 [搜索结果] 显示推文详情:",n);const e=[...k.top||[],...k.latest||[]].find(e=>e.id===n);e?(e._source||(e._source="search"),await io(e)):mn("未找到该推文","error")};const P=[{id:"1",user:{name:"热门推荐用户",handle:"@trending_user",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!0},content:"🔥 今日热门话题！大家都在讨论的新技术趋势 #AI #科技 #未来",time:"3小时",media:[],stats:{comments:567,retweets:1200,likes:5600,views:89e3},comments:[{id:"c1-1",user:{name:"科技达人",handle:"@tech_expert",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!0},content:"确实，AI技术发展太快了，每天都有新突破",time:"2小时",replies:[{id:"c1-1-1",user:{name:"学生小王",handle:"@student_wang",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:"请问有什么推荐的学习资源吗？",time:"1小时",replyTo:"@tech_expert"}]}]}],D=[{id:"2",user:{name:"我的朋友",handle:"@my_friend",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:"今天天气真不错，和朋友们一起出去玩了！😊 #美好时光",time:"30分钟",media:[{type:"image",description:"阳光明媚的公园里，几个朋友在草地上野餐的温馨场景",sensitive:!1}],stats:{comments:8,retweets:2,likes:24,views:156},comments:[{id:"c2-1",user:{name:"好友A",handle:"@friend_a",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:"看起来很棒！下次叫上我 😊",time:"25分钟",replies:[]}]},{id:"3",user:{name:"数码达人",handle:"@digital_expert",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!0},content:"完全同意这个观点！AI确实正在改变我们的生活方式，每个人都应该学会拥抱这种变化 🤖✨",time:"45分钟",media:[],quotedTweet:{type:"tweet",user:{name:"科技前沿",handle:"@tech_frontier",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!0},content:"AI技术的快速发展正在重塑各行各业，从自动驾驶到智能助手，我们正生活在一个科技革命的时代 #AI #未来科技",time:"2小时"},stats:{comments:15,retweets:32,likes:89,views:1250},comments:[{id:"c3-1",user:{name:"科技爱好者",handle:"@tech_lover",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:"是的，特别是在工作效率提升方面，AI工具帮助很大",time:"40分钟",replies:[]}]}];function N(n){return n>=1e6?(n/1e6).toFixed(1)+"万":n>=1e4?(n/1e4).toFixed(1)+"万":n>=1e3?(n/1e3).toFixed(1)+"K":n.toString()}function R(n,e={}){if(!n)return"";const t=e.isOwn||!1?"rgba(255, 255, 255, 0.9)":"var(--x-accent)";return n=(n=(n=(n=(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/\n/g,"<br>")).replace(/ {2,}/g,n=>" "+"&nbsp;".repeat(n.length-1))).replace(/#([^\s#@<]+)/g,`<span class="hashtag" style="color: ${t}; font-weight: 600;">#$1</span>`)).replace(/@([^\s#@<]+)/g,`<span class="mention" style="color: ${t}; font-weight: 600;">@$1</span>`)}function H(n){const e=document.createElement("div");return e.className="tweet-item",e.dataset.tweetId=n.id,e.innerHTML=`\n <img class="tweet-avatar" src="${n.user.avatar}" alt="${n.user.name}">\n <div class="tweet-main">\n <div class="tweet-user-info">\n <span class="tweet-user-name">${n.user.name}</span>\n ${n.user.verified?'<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span class="tweet-user-handle">${n.user.handle}</span>\n <span class="tweet-time">·${n.time}</span>\n <div class="tweet-more">\n <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></g>\n </svg>\n </div>\n </div>\n ${n.content?`<div class="tweet-content">${R(n.content)}</div>`:""}\n ${n.quotedTweet?`\n <div class="quoted-tweet" onclick="handleQuotedTweetClick('${n.quotedTweet.user.handle}')">\n <div class="quote-indicator">\n <svg viewBox="0 0 24 24">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n ${"comment"===n.quotedTweet.type?"引用评论":"引用推文"}\n </div>\n <div class="quoted-user-info">\n <img class="quoted-user-avatar" src="${n.quotedTweet.user.avatar}" alt="${n.quotedTweet.user.name}">\n <span class="quoted-user-name">${n.quotedTweet.user.name}</span>\n ${n.quotedTweet.user.verified?'<svg class="tweet-verified" style="width: 14px; height: 14px;" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span class="quoted-user-handle">${n.quotedTweet.user.handle}</span>\n <span class="quoted-user-time">·${n.quotedTweet.time}</span>\n </div>\n <div class="quoted-content">${R(n.quotedTweet.content)}</div>\n ${n.quotedTweet.image?`\n <div class="quoted-media" style="margin-top: 8px;">\n ${"description"===n.quotedTweet.image.type?`\n <div style="background-color: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 8px;">\n <div style="color: #fff; font-size: 12px; line-height: 1.4;">${n.quotedTweet.image.content}</div>\n </div>\n `:""}\n ${"upload"===n.quotedTweet.image.type?`\n <div style="border-radius: 8px; overflow: hidden;">\n <img src="${n.quotedTweet.image.content}" style="width: 100%; max-height: 100px; object-fit: cover; display: block;" alt="引用图片">\n </div>\n `:""}\n </div>\n `:""}\n </div>\n `:""}\n ${n.media&&n.media.length>0?`\n <div class="tweet-media">\n <div style="width: 100%; max-height: 200px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 16px; color:var(--x-text-primary); position: relative; overflow: hidden;" id="media-${n.id}">\n ${n.media[0].sensitive?`\n <div class="sensitive-overlay" onclick="showSensitiveContent('${n.id}')">\n <div class="sensitive-text">敏感内容</div>\n <div class="sensitive-description">此推文可能包含敏感内容</div>\n </div>\n `:""}\n <div class="tweet-media-scrollable" style="width: 100%; max-height: 200px; padding: 16px; overflow-y: auto; box-sizing: border-box; ${n.media[0].sensitive?"filter: blur(20px);":""}" id="content-${n.id}">\n <div style="font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.media[0].description}</div>\n </div>\n </div>\n </div>\n `:""}\n <div class="tweet-actions">\n <div class="tweet-action comment" onclick="showTweetComments('${n.id}')">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>\n </svg>\n <span>${N(n.stats.comments)}</span>\n </div>\n <div class="tweet-action retweet" onclick="handleQuoteRetweetFromData('tweet', '${n.id}')">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n <span>${m.formatNumber(n.stats.retweets)}</span>\n </div>\n <div class="tweet-action like" onclick="toggleLike('${n.id}', this)" data-liked="false" data-likes="${n.stats.likes}">\n <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n <span class="like-count">${m.formatNumber(n.stats.likes)}</span>\n </div>\n <div class="tweet-action view">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>\n </svg>\n <span>${m.formatNumber(n.stats.views)}</span>\n </div>\n <div class="tweet-action bookmark" onclick="toggleBookmark('${n.id}', this)" data-bookmarked="false">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>\n </svg>\n </div>\n <div class="tweet-action share">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>\n </svg>\n       </div>\n      </div>\n      </div>\n      `,e.dataset.needsStatusCheck="true",e}function j(n){try{const e=n.querySelector(".tweet-avatar")?.src||"",t=n.querySelector(".tweet-user-name")?.textContent||"",o=n.querySelector(".tweet-user-handle")?.textContent||"",a=!!n.querySelector(".tweet-verified"),i=n.querySelector(".tweet-content")?.textContent||"",r=n.querySelector(".tweet-time")?.textContent?.replace("·","").trim()||"",s=n.querySelector(".tweet-action.comment span")?.textContent||"0",l=n.querySelector(".tweet-action.retweet span")?.textContent||"0",c=n.querySelector(".like-count")?.textContent||"0",d=n.querySelector(".tweet-action.view span")?.textContent||"0";return{id:n.dataset.tweetId,user:{name:t,handle:o,avatar:e,verified:a},content:i,time:r,stats:{comments:U(s),retweets:U(l),likes:U(c),views:U(d)},comments:[]}}catch(n){return console.error("❌ [书签] 从DOM提取推文数据失败:",n),null}}function U(n){return n?(n=n.trim().toUpperCase()).endsWith("K")?Math.round(1e3*parseFloat(n)):n.endsWith("M")?Math.round(1e6*parseFloat(n)):parseInt(n)||0:0}async function O(n){try{const t=vt||"main",o=e(),a=`bookmark_${t}_${n}`;return!!await o.xBookmarks.get(a)}catch(n){return console.error("❌ [书签] 检查收藏状态失败:",n),!1}}async function _(n){try{const t=vt||"main",o=e(),a=`like_${t}_${n}`;return!!await o.xLikes.get(a)}catch(n){return console.error("❌ [喜欢] 检查喜欢状态失败:",n),!1}}n.toggleBookmark=async function(t,o){try{if("true"===o.getAttribute("data-bookmarked")){await async function(n){try{const t=vt||"main",o=e(),a=`bookmark_${t}_${n}`;await o.xBookmarks.delete(a),console.log(`✅ [书签] 账户 ${t} 已删除书签: ${n}`)}catch(n){throw console.error("❌ [书签] 删除书签失败:",n),n}}(t),o.setAttribute("data-bookmarked","false");const n=o.querySelector("svg");n&&(n.innerHTML='<g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>'),mn("已取消收藏","info"),console.log(`📌 [书签] 已取消收藏推文: ${t}`)}else{await async function(t){try{const o=vt||"main",a=e();let i=null;if(i=[...n.xTweetsData?.forYouTweets||[],...n.xTweetsData?.followingTweets||[]].find(n=>n.id===t),!i){const n=await a.xTweetsData.get("tweets");n&&(i=n.forYouTweets?.find(n=>n.id===t)||n.followingTweets?.find(n=>n.id===t))}if(!i&&t.startsWith("user_")){const n=`userTweets_${o}`,e=await a.xUserTweets.get(n);e&&e.tweets&&(i=e.tweets.find(n=>n.id===t))}if(!i&&Sn&&Sn.tweets&&(i=Sn.tweets.find(n=>n.id===t)),!i){const n=document.querySelector(`[data-tweet-id="${t}"]`);n&&(console.log("📝 [书签] 从DOM中提取推文数据"),i=j(n))}if(!i)return console.warn("⚠️ [书签] 未找到推文数据:",t),void mn("无法收藏该推文","error");const r=`bookmark_${o}_${t}`;await a.xBookmarks.put({id:r,accountId:o,tweetId:t,tweetData:i,bookmarkedAt:Date.now()}),console.log(`✅ [书签] 账户 ${o} 已保存书签: ${t}`)}catch(n){throw console.error("❌ [书签] 保存书签失败:",n),n}}(t),o.setAttribute("data-bookmarked","true");const a=o.querySelector("svg");a&&(a.innerHTML='<g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z"></path></g>'),mn("已添加到书签","success"),console.log(`📌 [书签] 已收藏推文: ${t}`)}const a=document.getElementById("profile-highlights-content");a&&"block"===a.style.display&&await loadHighlights()}catch(n){console.error("❌ [书签] 切换书签状态失败:",n),mn("操作失败","error")}},n.loadHighlights=async function(){try{console.log("🌟 [亮点] 开始加载亮点内容");const n=document.getElementById("profile-highlights-content");if(!n)return void console.warn("⚠️ [亮点] 未找到亮点容器");const t=await async function(){try{const n=vt||"main",t=e(),o=await t.xBookmarks.where("accountId").equals(n).sortBy("bookmarkedAt");return o.reverse(),console.log(`📚 [书签] 账户 ${n} 已加载 ${o.length} 个书签`),o}catch(n){return console.error("❌ [书签] 加载书签失败:",n),[]}}();if(0===t.length){const e=Rn[Hn]||Rn.zh;return void(n.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color:var(--x-text-secondary); font-size: 31px; font-weight: 800; margin-bottom: 8px;">${e.profileNoHighlights}</div>\n <div style="color:var(--x-text-secondary); font-size: 15px;">${e.profileNoHighlightsDesc}</div>\n </div>\n `)}n.innerHTML="",t.forEach(e=>{if(e.tweetData){const t=H(e.tweetData);n.appendChild(t);const o=t.querySelector(".bookmark");if(o){o.setAttribute("data-bookmarked","true");const n=o.querySelector("svg");n&&(n.innerHTML='<g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z"></path></g>')}}}),console.log(`✅ [亮点] 已显示 ${t.length} 个收藏的推文`)}catch(n){console.error("❌ [亮点] 加载亮点内容失败:",n),mn("加载失败","error")}},n.toggleLike=async function(n,t){try{const o="true"===t.getAttribute("data-liked"),a=t.querySelector(".like-count");let i=parseInt(t.getAttribute("data-likes"))||0;if(o){await async function(n){try{const t=vt||"main",o=e(),a=`like_${t}_${n}`;await o.xLikes.delete(a),console.log(`✅ [喜欢] 账户 ${t} 已删除喜欢: ${n}`)}catch(n){throw console.error("❌ [喜欢] 删除喜欢失败:",n),n}}(n),t.setAttribute("data-liked","false"),i=Math.max(0,i-1),t.setAttribute("data-likes",i),a&&(a.textContent=m.formatNumber(i));const o=t.querySelector("svg");o&&(o.innerHTML='<g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>'),console.log(`💔 [喜欢] 已取消喜欢推文: ${n}`)}else{await async function(n){try{const t=vt||"main",o=e();let a=null;if(a=[...P,...D].find(e=>e.id===n),!a){const e=await o.xTweetsData.get("tweets");e&&(a=e.forYouTweets?.find(e=>e.id===n)||e.followingTweets?.find(e=>e.id===n))}if(!a&&n.startsWith("user_")){const e=`userTweets_${t}`,i=await o.xUserTweets.get(e);i&&i.tweets&&(a=i.tweets.find(e=>e.id===n))}if(!a&&Sn&&Sn.tweets&&(a=Sn.tweets.find(e=>e.id===n)),!a){const e=document.querySelector(`[data-tweet-id="${n}"]`);e&&(console.log("📝 [喜欢] 从DOM中提取推文数据"),a=j(e))}if(!a)return console.warn("⚠️ [喜欢] 未找到推文数据:",n),void mn("无法喜欢该推文","error");const i=`like_${t}_${n}`;await o.xLikes.put({id:i,accountId:t,tweetId:n,tweetData:a,likedAt:Date.now()}),console.log(`✅ [喜欢] 账户 ${t} 已保存喜欢: ${n}`)}catch(n){throw console.error("❌ [喜欢] 保存喜欢失败:",n),n}}(n),t.setAttribute("data-liked","true"),i+=1,t.setAttribute("data-likes",i),a&&(a.textContent=m.formatNumber(i));const o=t.querySelector("svg");o&&(o.innerHTML='<g><path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>'),console.log(`💖 [喜欢] 已喜欢推文: ${n}`),await async function(){try{const n=vt||"main",t=e(),o=await t.xLikes.where("accountId").equals(n).count();if(console.log(`📊 [喜欢触发] 当前喜欢总数: ${o}`),o>0&&o%5==0){const o=Date.now(),a=o-F;if(a<X){const n=Math.ceil((X-a)/1e3);return void console.log(`⏳ [喜欢触发] 冷却中，还需等待 ${n} 秒`)}console.log("🎯 [喜欢触发] 达到触发条件，准备随机选择一条喜欢的推文"),F=o;const i=(await t.xLikes.where("accountId").equals(n).sortBy("likedAt")).slice(-5);if(i.length>0){const n=i[Math.floor(Math.random()*i.length)].tweetData;console.log("🎲 [喜欢触发] 随机选中推文:",n);const t=n.user.handle.replace("@","");await async function(n,t){try{console.log(`🤖 [喜欢触发AI] 开始处理推文作者: ${n}`);const o=e(),a=(await o.xCharacterProfiles.toArray()).find(e=>e.xHandle&&e.xHandle.replace("@","").toLowerCase()===n.toLowerCase());if(a){console.log(`✅ [喜欢触发AI] 找到角色: ${a.xName}`);const n={id:a.characterId?`msg_${a.characterId}`:"msg_001",user:{name:a.xName,handle:a.xHandle,avatar:a.xAvatar,verified:a.xVerified||!1},preview:"看到你喜欢了我的推文",time:"刚刚"},e=await vl(n,!0,{isAutoMessage:!0,timeSinceLastMessage:0,likedTweetContext:t});if(e&&e.length>0){const t=`messageConversation_${vt||"main"}_${n.id}`;let i=await o.xAccountProfiles.get(t);i||(i={handle:t,name:"messageConversation",data:{messages:[]},messageId:n.id,accountId:vt||"main",updatedAt:(new Date).toISOString()}),i.data.messages.push(...e),i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i);Rl({title:"X",message:"en"===Hn?`${a.xName} noticed you liked their tweet and sent you a message!`:`${a.xName} 看到你喜欢了TA的推文，发来了私信！`,avatar:a.xAvatar,leftIcon:"x"}),console.log(`✅ [喜欢触发AI] 已触发${a.xName}的主动私信`)}}else console.log(`ℹ️ [喜欢触发AI] ${n} 不是绑定角色，跳过触发`)}catch(n){console.error("❌ [喜欢触发AI] 触发失败:",n)}}(t,n)}}}catch(n){console.error("❌ [喜欢触发] 检查触发条件失败:",n)}}()}const r=document.getElementById("profile-likes-content");r&&"block"===r.style.display&&await loadLikes()}catch(n){console.error("❌ [喜欢] 切换喜欢状态失败:",n),mn("操作失败","error")}},n.loadLikes=async function(){try{console.log("💖 [喜欢] 开始加载喜欢内容");const n=document.getElementById("profile-likes-content");if(!n)return void console.warn("⚠️ [喜欢] 未找到喜欢容器");const t=await async function(){try{const n=vt||"main",t=e(),o=await t.xLikes.where("accountId").equals(n).sortBy("likedAt");return o.reverse(),console.log(`💖 [喜欢] 账户 ${n} 已加载 ${o.length} 个喜欢`),o}catch(n){return console.error("❌ [喜欢] 加载喜欢失败:",n),[]}}();if(0===t.length){const e=Rn[Hn]||Rn.zh;return void(n.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color:var(--x-text-secondary); font-size: 31px; font-weight: 800; margin-bottom: 8px;">${e.profileNoLikes}</div>\n <div style="color:var(--x-text-secondary); font-size: 15px;">${e.profileNoLikesDesc}</div>\n </div>\n `)}n.innerHTML="",t.forEach(e=>{if(e.tweetData){const t=H(e.tweetData);n.appendChild(t);const o=t.querySelector(".tweet-action.like");if(o){o.setAttribute("data-liked","true");const n=o.querySelector("svg");n&&(n.innerHTML='<g><path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>')}}}),console.log(`✅ [喜欢] 已显示 ${t.length} 个喜欢的推文`)}catch(n){console.error("❌ [喜欢] 加载喜欢内容失败:",n),mn("加载失败","error")}};let F=0;const X=3e5;function q(n,e){const t=document.querySelector(`#${e} .tweets-container`);t.innerHTML="";let o=0;!function a(){const i=Math.min(o+10,n.length),r=document.createDocumentFragment();for(let t=o;t<i;t++){const o=n[t],a=H(o);o.isNew&&(a.style.opacity="0",a.style.transform="translateY(-20px)",a.style.transition="opacity 0.4s ease, transform 0.4s ease",setTimeout(()=>{a.style.opacity="1",a.style.transform="translateY(0)",o.isNew=!1},50*t)),r.appendChild(a),V(a,o,e)}t.appendChild(r),o=i,o<n.length&&requestAnimationFrame(a)}(),setTimeout(()=>{!function(n){const e=new IntersectionObserver(n=>{n.forEach(async n=>{if(n.isIntersecting){const t=n.target;if("true"===t.dataset.needsStatusCheck){t.dataset.needsStatusCheck="false";const n=t.dataset.tweetId,[o,a]=await Promise.all([O(n),_(n)]),i=t.querySelector(".bookmark");if(i&&o){i.setAttribute("data-bookmarked","true");const n=i.querySelector("svg");n&&(n.innerHTML='<g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5z"></path></g>')}const r=t.querySelector(".tweet-action.like");if(r&&a){r.setAttribute("data-liked","true");const n=r.querySelector("svg");n&&(n.innerHTML='<g><path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>')}e.unobserve(t)}}})},{root:n,rootMargin:"100px",threshold:.01});n.querySelectorAll('.tweet-item[data-needs-status-check="true"]').forEach(n=>{e.observe(n)})}(t)},100)}function V(n,e,t){const o=n.querySelector(".tweet-avatar");o&&(o.style.cursor="pointer",o.addEventListener("click",n=>{n.stopPropagation(),openAccountProfile(e.user.name,e.user.handle,e.user.avatar,{source:"feed",tweetContent:e.content,tweetMedia:e.media,tweetStats:e.stats,tweetTime:e.time})}));const a=n.querySelector(".quoted-user-avatar");a&&e.quotedTweet&&(a.style.cursor="pointer",a.addEventListener("click",n=>{n.stopPropagation(),openAccountProfile(e.quotedTweet.user.name,e.quotedTweet.user.handle,e.quotedTweet.user.avatar,{source:"feed",tweetContent:e.quotedTweet.content,tweetTime:e.quotedTweet.time})}));let i=null,r=!1;n.addEventListener("touchstart",o=>{G||(r=!0,i=setTimeout(()=>{r&&(o.preventDefault(),J(t),K(e.id,n))},500))}),n.addEventListener("touchmove",()=>{r=!1,i&&clearTimeout(i)}),n.addEventListener("touchend",()=>{r=!1,i&&clearTimeout(i)}),n.addEventListener("mousedown",o=>{G||0===o.button&&(i=setTimeout(()=>{J(t),K(e.id,n)},500))}),n.addEventListener("mouseup",()=>{i&&clearTimeout(i)}),n.addEventListener("mouseleave",()=>{i&&clearTimeout(i)}),n.addEventListener("click",t=>{G&&(t.preventDefault(),t.stopPropagation(),K(e.id,n))})}let G=!1,Y=new Set,W=null;function J(n){if(G)return;G=!0,W=n,Y.clear(),function(){const n=document.getElementById("feed-multi-select-toolbar");n&&n.remove();const e=document.createElement("div");if(e.id="feed-multi-select-toolbar",e.style.cssText="\n position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 24px; padding: 12px 20px; display: flex; align-items: center; gap: 16px; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); animation: feedSlideUp 0.3s ease;\n",e.innerHTML='\n <span id="feed-selected-count" style="color:var(--x-text-primary); font-size: 14px; font-weight: 600;">已选择 0 条</span>\n <button onclick="selectAllFeedTweets()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 16px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.opacity=\'0.8\'" onmouseout="this.style.opacity=\'1\'">\n 全选\n </button>\n <button onclick="deleteFeedSelectedTweets()" style="background-color: #f4212e; color: #fff; border: none; border-radius: 16px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#d91b2a\'" onmouseout="this.style.backgroundColor=\'#f4212e\'">\n 删除\n </button>\n <button onclick="exitFeedMultiSelectMode()" style="background-color: transparent; color:var(--x-text-primary); border: 1px solid var(--x-border-color); border-radius: 16px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n 取消\n </button>\n',document.body.appendChild(e),!document.getElementById("feed-multiselect-animation-style")){const n=document.createElement("style");n.id="feed-multiselect-animation-style",n.textContent="\n @keyframes feedSlideUp {\n from {\n transform: translateX(-50%) translateY(20px); opacity: 0; }\n to {\n transform: translateX(-50%) translateY(0); opacity: 1; }\n }\n @keyframes feedSlideDown {\n from {\n transform: translateX(-50%) translateY(0); opacity: 1; }\n to {\n transform: translateX(-50%) translateY(20px); opacity: 0; }\n }\n ",document.head.appendChild(n)}}();const e=document.querySelector(`#${n} .tweets-container`);if(e){e.querySelectorAll(".tweet-item").forEach(n=>{n.style.transition="transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease",n.style.cursor="pointer"})}console.log("📱 [首页多选] 已进入多选模式")}function K(n,e){G&&(Y.has(n)?(Y.delete(n),e.style.transform="",e.style.boxShadow="",e.style.backgroundColor=""):(Y.add(n),e.style.transform="scale(0.98)",e.style.boxShadow="0 0 0 3px var(--x-accent)",e.style.backgroundColor="color-mix(in srgb, var(--x-accent) 10%, transparent)"),Q())}function Q(){const n=document.getElementById("feed-selected-count");n&&(n.textContent=`已选择 ${Y.size} 条`)}function Z(n){const e=Date.now()-n,t=Math.floor(e/1e3),o=Math.floor(t/60),a=Math.floor(o/60),i=Math.floor(a/24);if(t<60)return"刚刚";if(o<60)return`${o}分钟前`;if(a<24)return`${a}小时前`;if(i<7)return`${i}天前`;const r=new Date(n);return`${r.getMonth()+1}月${r.getDate()}日`}function nn(n){if(!n||isNaN(n)||n<=0)return console.warn("⚠️ [时间显示] 无效的时间戳:",n),"刚刚";const e=Date.now()-n,t=Math.floor(e/6e4),o=Math.floor(e/36e5),a=Math.floor(e/864e5);if(t<1)return"刚刚";if(t<60)return`${t}分钟前`;if(o<24)return`${o}小时前`;if(a<7)return`${a}天前`;const i=new Date(n);if(isNaN(i.getTime()))return console.warn("⚠️ [时间显示] 无效的日期对象，时间戳:",n),"刚刚";return`${i.getMonth()+1}月${i.getDate()}日`}function en(n,e=!1){const t=document.createElement("div");t.className=e?"comment-item reply-item":"comment-item",t.dataset.commentId=n.id;const o=Math.floor(50*Math.random())+1,a=Math.floor(10*Math.random())+1,i=Math.floor(5*Math.random())+1,r=Math.floor(1e3*Math.random())+50;t.innerHTML=`\n <img class="tweet-avatar" src="${n.user.avatar}" alt="${n.user.name}"\n onclick="openAccountProfile('${n.user.name.replace(/'/g,"\\'")}', '${n.user.handle}', '${n.user.avatar}', {source: 'tweetDetail', commentContent: '${n.content.replace(/'/g,"\\'").substring(0,100)}'});event.stopPropagation();"\n style="cursor: pointer; transition: opacity 0.2s;"\n onmouseover="this.style.opacity='0.8'"\n onmouseout="this.style.opacity='1'">\n <div class="comment-main">\n <div class="comment-user-info">\n <span class="tweet-user-name" onclick="openAccountProfile('${n.user.name.replace(/'/g,"\\'")}', '${n.user.handle}', '${n.user.avatar}', {source: 'tweetDetail', commentContent: '${n.content.replace(/'/g,"\\'").substring(0,100)}'});event.stopPropagation();" style="cursor: pointer;">${n.user.name}</span>\n ${n.user.verified?'<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span class="tweet-user-handle">${n.user.handle.startsWith("@")?n.user.handle:"@"+n.user.handle}</span>\n <span class="tweet-time">·${n.timestamp?nn(n.timestamp):n.time||"刚刚"}</span>\n <div style="margin-left: auto; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color: 0.2s; display: flex; align-items: center;" onmouseover="this.style.backgroundColor='color-mix(in srgb, var(--x-accent) , 0.1)'" onmouseout="this.style.backgroundColor='transparent'" onclick="${n.user.handle===te.handle?`deleteUserComment('${n.id}')`:"event.stopPropagation(); showXToast('更多选项开发中', 'info')"}">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #71767b;">\n <g><circle cx="12" cy="5" r="2"></circle><circle cx="12" cy="12" r="2"></circle><circle cx="12" cy="19" r="2"></circle></g>\n </svg>\n </div>\n </div>\n <div class="comment-content">\n ${n.replyTo?`<span class="reply-to">${n.replyTo}</span>`:""}\n ${R(function(n,e){if(!n)return"";if(e){n=n.replace(/^回复\s*@[^\s:：]+[：:]\s*/,"");const t=e.replace("@","");n=(n=n.replace(new RegExp(`^@${t}\\s*[：:]?\\s*`,"i"),"")).replace(new RegExp(`@${t}(?=\\s|$|[^\\w])`,"gi"),"")}return n}(n.content,n.replyTo))}\n ${n.image?"description"===n.image.type?`<div style="margin-top: 8px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 8px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 13px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.image.content}</div>\n </div>`:`<div style="margin-top: 8px; border-radius: 12px; overflow: hidden; max-width: 300px;">\n <img src="${n.image.content}" style="width: 100%; max-height: 280px; object-fit: cover; display: block;" alt="评论图片">\n </div>`:""}\n ${n.sticker?`<div style="margin-top: 8px; max-width: 120px;">\n <img src="${n.sticker.url}" alt="${n.sticker.description}" style="width: 100%; height: auto; display: block; border-radius: 8px; cursor: pointer;"\n      onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding: 12px; color:var(--x-text-secondary); text-align: center;\\'>表情包加载失败</div>';"\n      title="${n.sticker.description}">\n </div>`:""}\n </div>\n <div class="comment-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; gap: 2px; max-width: 100%; overflow-x: hidden;">\n <div class="comment-action reply-action" onclick="showReplyInput('${n.id}', '${n.user.handle}')" style="display: flex; align-items: center; gap: 2px; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 1 auto; min-width: 0;">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>\n </svg>\n <span style="font-size: 12px; white-space: nowrap;">${a}</span>\n </div>\n <div class="comment-action" onclick="handleQuoteRetweetFromData('comment', '${n.id}')" style="display: flex; align-items: center; gap: 2px; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 1 auto; min-width: 0;">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n <span style="font-size: 12px; white-space: nowrap;">${i}</span>\n </div>\n <div class="comment-action like" onclick="toggleCommentLike('${n.id}', this)" data-liked="false" data-likes="${o}" style="display: flex; align-items: center; gap: 2px; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 1 auto; min-width: 0;">\n <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n <span class="like-count" style="font-size: 12px; white-space: nowrap;">${o}</span>\n </div>\n <div class="comment-action" style="display: flex; align-items: center; gap: 2px; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 1 auto; min-width: 0;">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>\n </svg>\n <span style="font-size: 12px; white-space: nowrap;">${N(r)}</span>\n </div>\n <div class="comment-action bookmark" style="display: flex; align-items: center; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 0 auto; min-width: 16px;">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>\n </svg>\n </div>\n <div class="comment-action share comment-share-btn" data-comment-id="${n.id}" style="display: flex; align-items: center; cursor: pointer; color: #71767b; transition: color 0.2s; flex: 0 0 auto; min-width: 16px;">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; flex-shrink: 0;">\n <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>\n </svg>\n </div>\n </div>\n\n <div id="reply-input-${n.id}" class="reply-input-container" style="display: none; margin-top: 12px; padding-left: 48px;">\n <div style="display: flex; align-items: flex-start; gap: 12px;">\n <img src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Your avatar" style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;" class="reply-user-avatar">\n <div style="flex: 1;">\n <textarea placeholder="发布你的回复" style="width: 100%; min-height: 20px; max-height: 80px; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; outline: none; font-family: inherit; line-height: 1.3; border-bottom: 1px solid #333; padding-bottom: 8px;" oninput="autoResizeReply(this, '${n.id}')" onkeydown="handleReplyInput(event, '${n.id}', '${n.user.handle}')"></textarea>\n <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">\n <div style="display: flex; gap: 12px;">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent); cursor: pointer;">\n <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"></path></g>\n </svg>\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent); cursor: pointer;">\n <g><path d="M8 9.5C8 8.119 8.672 7 9.5 7S11 8.119 11 9.5 10.328 12 9.5 12 8 10.881 8 9.5zm6.5 2.5c.828 0 1.5-1.119 1.5-2.5S15.328 7 14.5 7 13 8.119 13 9.5s.672 2.5 1.5 2.5zM12 16c-2.224 0-3.021-2.227-3.051-2.316l-1.897.633c.05.15 1.271 3.684 4.949 3.684s4.898-3.533 4.949-3.684l-1.896-.638c-.033.095-.83 2.322-3.053 2.322zm10.25-4.001c0 5.652-4.598 10.25-10.25 10.25S1.75 17.652 1.75 12 6.348 1.75 12 1.75 22.25 6.348 22.25 12zm-2 0c0-4.549-3.701-8.25-8.25-8.25S3.75 7.451 3.75 12s3.701 8.25 8.25 8.25 8.25-3.701 8.25-8.25z"></path></g>\n </svg>\n </div>\n <div style="display: flex; gap: 8px;">\n <button onclick="cancelReply('${n.id}')" style="background: transparent; color: #71767b; border: 1px solid #333; border-radius: 16px; padding: 4px 12px; font-size: 13px; cursor: pointer;">取消</button>\n <button id="reply-btn-${n.id}" onclick="submitReply('${n.id}', '${n.user.handle}')" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 16px; padding: 4px 12px; font-size: 13px; cursor: pointer; opacity: 0.5;" disabled>回复</button>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n `;const s=t.querySelector(".comment-share-btn");return s&&(s.onclick=()=>{let e=null;const t=sessionStorage.getItem("currentTweetData");if(t)try{e=JSON.parse(t)}catch(n){console.error("解析推文数据失败:",n)}showShareContentModal({user:n.user,content:n.content,time:n.time||(n.timestamp?nn(n.timestamp):"刚刚"),image:n.image,parentTweet:e},"comment")}),t}function tn(n){const e=document.querySelector(".comments-container");e.innerHTML="";let t=[...P,...D];(k.top||k.latest)&&(t=[...t,...k.top||[],...k.latest||[]]),Sn&&Sn.tweets&&(t=[...t,...Sn.tweets]);const o=t.find(e=>e.id===n);if(!o||!o.comments)return;o.comments.forEach(n=>{const t=document.createElement("div");t.style.cssText="position: relative;";const o=en(n);n.replies&&n.replies.length>0&&o.classList.add("has-replies"),t.appendChild(o);const a=o.querySelector(".tweet-avatar");a&&(a.style.cursor="pointer",a.addEventListener("click",e=>{e.stopPropagation(),openAccountProfile(n.user.name,n.user.handle,n.user.avatar,{source:"comment",commentContent:n.content,commentImage:n.image,commentTime:n.time})})),n.replies&&n.replies.length>0&&n.replies.forEach(n=>{const e=en(n,!0);t.appendChild(e);const o=e.querySelector(".tweet-avatar");o&&(o.style.cursor="pointer",o.addEventListener("click",e=>{e.stopPropagation(),openAccountProfile(n.user.name,n.user.handle,n.user.avatar,{source:"comment",commentContent:n.content,commentImage:n.image,commentTime:n.time,replyTo:n.replyTo})}))}),e.appendChild(t)});document.querySelectorAll(".reply-user-avatar").forEach(n=>{n.src=te.avatar})}n.selectAllFeedTweets=function(){if(!G||!W)return;const n=document.querySelector(`#${W} .tweets-container`);if(!n)return;const e="for-you-content"===W?P:D,t=n.querySelectorAll(".tweet-item");e.forEach((n,e)=>{Y.add(n.id);const o=t[e];o&&(o.style.transform="scale(0.98)",o.style.boxShadow="0 0 0 3px var(--x-accent)",o.style.backgroundColor="color-mix(in srgb, var(--x-accent) 10%, transparent)")}),Q()},n.exitFeedMultiSelectMode=function(){if(!G)return;G=!1,Y.clear(),W=null;const n=document.getElementById("feed-multi-select-toolbar");n&&(n.style.animation="feedSlideDown 0.3s ease",setTimeout(()=>n.remove(),300)),document.querySelectorAll(".tweet-item").forEach(n=>{n.style.transform="",n.style.boxShadow="",n.style.backgroundColor="",n.style.cursor=""}),console.log("📱 [首页多选] 已退出多选模式")},n.deleteFeedSelectedTweets=async function(){if(0!==Y.size){if(confirm(`确定要删除 ${Y.size} 条推文吗？`))try{const n="for-you-content"===W,t=(n?P:D).filter(n=>!Y.has(n.id));n?(P.length=0,P.push(...t)):(D.length=0,D.push(...t));const o=e();await o.xTweetsData.put({id:"tweets",forYouTweets:P,followingTweets:D,lastUpdated:(new Date).toISOString()}),q(n?P:D,W),mn(`已删除 ${Y.size} 条推文`,"success"),exitFeedMultiSelectMode()}catch(n){console.error("删除推文失败:",n),mn("删除失败","error")}}else mn("请先选择要删除的推文","info")},setInterval(function(){P.forEach(n=>{n.createdAt&&(n.time=Z(n.createdAt))}),D.forEach(n=>{n.createdAt&&(n.time=Z(n.createdAt))}),document.querySelectorAll(".tweet-time[data-timestamp]").forEach(n=>{const e=parseInt(n.dataset.timestamp);e&&!isNaN(e)&&(n.textContent=Z(e))}),document.querySelectorAll(".tweet-time").forEach(n=>{const e=n.closest(".tweet-item");if(e&&e.dataset.tweetId&&!n.dataset.timestamp){const t=e.dataset.tweetId,o=[...P,...D].find(n=>n.id===t);o&&o.createdAt&&(n.textContent=Z(o.createdAt))}})},3e4);let on=null,an=null;function rn(){on=null;const n=document.getElementById("comment-image-preview");document.getElementById("comment-image-preview-img").src="",n.style.display="none",document.getElementById("comment-image-input").value=""}function sn(){n.setCommentStickerMode&&n.setCommentStickerMode(!0),n.resetSelectedCommentSticker&&n.resetSelectedCommentSticker(),n.openStickerPicker?n.openStickerPicker():mn("表情包功能暂不可用","error")}function ln(){an=null;const n=document.getElementById("detail-comment-image-preview");document.getElementById("detail-comment-image-preview-img").src="",n.style.display="none",document.getElementById("detail-comment-image-input").value=""}let cn=null;async function dn(){const t=document.getElementById("comment-input"),o=t.value.trim();if(0===o.length||!cn)return;let a=null,i=!1;const r=[...P,...D];if(a=r.find(n=>n.id===cn),!a&&Sn&&Sn.tweets&&(a=Sn.tweets.find(n=>n.id===cn),i=!!a),!a)return void mn("无法找到对应的推文","error");if("private"===a.privacy)return void mn("私有帖子不支持回复功能","error");const s={id:"new-"+Date.now(),user:{name:n.userProfileData.name,handle:n.userProfileData.handle,avatar:n.userProfileData.avatar,verified:n.userProfileData.verified},content:o,timestamp:Date.now(),replies:[]};if(on&&(s.image={type:"upload",content:on}),a){a.comments||(a.comments=[]),a.comments.push(s),a.stats.comments+=1;const n=P.findIndex(n=>n.id===a.id);if(-1!==n)P[n]=a;else{const n=D.findIndex(n=>n.id===a.id);-1!==n&&(D[n]=a)}try{const n=e();if(i){const e=(a._accountHandle||(Sn.accountInfo||Sn).handle).replace("@",""),t=Sn.tweets.findIndex(n=>n.id===a.id);-1!==t&&(Sn.tweets[t]=a),await n.xAccountProfiles.put({handle:e,name:(Sn.accountInfo||Sn).name,accountInfo:Sn.accountInfo||Sn,tweets:Sn.tweets,accountReplies:Sn.accountReplies||[],updatedAt:(new Date).toISOString()}),console.log("✅ 用户评论已保存到账户推文，评论ID:",s.id,"账户:",e)}else await n.xTweetsData.put({id:"tweets",forYouTweets:P,followingTweets:D,lastUpdated:(new Date).toISOString()}),console.log("用户评论已保存到数据库，评论ID:",s.id)}catch(n){console.error("保存评论数据失败:",n)}}tn(cn),t.value="",t.style.height="20px",on&&rn();const l=document.getElementById("reply-btn");l.style.opacity="0.5",l.disabled=!0;const c=document.querySelector(".comments-container");setTimeout(()=>{c.scrollTop=c.scrollHeight},100),mn("你的评论等待回复中","info");const d=a.user&&(a.user.handle===te.handle||a.id.startsWith("user_"));setTimeout(async()=>{await Co(a,s,{isOwnPost:d,commentType:"main_comment",pageType:"main",parentComment:null})},100)}function pn(n){const e=document.getElementById(`reply-input-${n}`);if(e){e.style.display="none";const t=e.querySelector("textarea");t.value="",t.style.height="20px";const o=document.getElementById(`reply-btn-${n}`);o.style.opacity="0.5",o.disabled=!0}}async function gn(t,o){const a=document.getElementById(`reply-input-${t}`).querySelector("textarea").value.trim();if(0===a.length)return;let i=null;const r=sessionStorage.getItem("currentTweetData");if(r)try{i=JSON.parse(r)}catch(n){console.error("解析sessionStorage推文数据失败:",n)}if(!i&&cn){const n=[...P,...D];i=n.find(n=>n.id===cn)}if(!i)return void mn("无法获取推文信息","error");if("private"===i.privacy)return void mn("私有帖子不支持回复功能","error");let s=null,l=t;const c=!!r,d=(c?document.getElementById("detail-comments-container"):document.querySelector(".comments-container")).querySelectorAll(".comment-item");let p=null;if(d.forEach(n=>{n.dataset.commentId===t&&(p=n)}),p){const n=p.querySelector(".tweet-user-name").textContent,e=p.querySelector(".tweet-user-handle").textContent,o=p.querySelector(".comment-content").textContent.trim();if(s={id:t,user:{name:n,handle:e},content:o},p.classList.contains("reply-item")){let n=p.previousElementSibling;for(;n&&n.classList.contains("reply-item");)n=n.previousElementSibling;if(n&&n.classList.contains("comment-item")&&!n.classList.contains("reply-item"))l=n.dataset.commentId;else{let n=p.parentNode.querySelector(".comment-item:not(.reply-item)");n&&(l=n.dataset.commentId)}}}const g={id:"reply-"+Date.now(),user:{name:n.userProfileData.name,handle:n.userProfileData.handle,avatar:n.userProfileData.avatar,verified:n.userProfileData.verified},content:a,timestamp:Date.now(),replyTo:o,replies:[]};if(console.log("💬 [楼中楼回复] 创建新回复:",{id:g.id,content:g.content.substring(0,50)+"...",replyTo:o,mainCommentId:l,isDetailPage:c}),c){const n=en(g,!0);if(p){let e=null;if(p.classList.contains("reply-item")){let n=p.nextElementSibling;for(e=p;n&&n.classList.contains("reply-item");)e=n,n=n.nextElementSibling}else{let n=p.nextElementSibling;for(e=p;n&&n.classList.contains("reply-item");)e=n,n=n.nextElementSibling}e.nextSibling?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n)}try{console.log("💬 [楼中楼回复] 开始保存到数据库");let n=JSON.parse(sessionStorage.getItem("currentTweetData"));if(n){console.log("💬 [楼中楼回复] 推文ID:",n.id),console.log("💬 [楼中楼回复] 主评论ID:",l),console.log("💬 [楼中楼回复] 当前评论总数:",n.comments?.length||0);const t=n.comments.find(n=>n.id===l);if(t){console.log("💬 [楼中楼回复] 找到主评论，当前回复数:",t.replies?.length||0),t.replies||(t.replies=[]),t.replies.push(g),console.log("💬 [楼中楼回复] 新回复已添加，新回复总数:",t.replies.length),sessionStorage.setItem("currentTweetData",JSON.stringify(n)),console.log("✅ [楼中楼回复] sessionStorage 已更新");const o=e(),a=n.id.startsWith("user_"),i="account"===n._source;if(console.log("💬 [楼中楼回复] 是否为用户推文:",a),console.log("💬 [楼中楼回复] 是否为账户推文:",i),i){console.log("💬 [楼中楼回复] 保存到账户推文数据库");const e=(n._accountHandle||(Sn.accountInfo||Sn).handle).replace("@","");if(Sn&&Sn.tweets){const t=Sn.tweets.findIndex(e=>e.id===n.id);-1!==t?(Sn.tweets[t]=n,await o.xAccountProfiles.put({handle:e,name:(Sn.accountInfo||Sn).name,accountInfo:Sn.accountInfo||Sn,tweets:Sn.tweets,accountReplies:Sn.accountReplies||[],updatedAt:(new Date).toISOString()}),console.log("✅ [楼中楼回复] 账户推文已更新，账户:",e)):console.warn("⚠️ [楼中楼回复] 未找到目标账户推文")}}else if(a){console.log("💬 [楼中楼回复] 保存到用户推文数据库");const e=`userTweets_${vt||"main"}`,t=await o.xUserTweets.get(e);if(t&&t.tweets){console.log("💬 [楼中楼回复] 找到用户推文数据，推文总数:",t.tweets.length);const a=t.tweets.findIndex(e=>e.id===n.id);-1!==a?(console.log("💬 [楼中楼回复] 找到目标推文，索引:",a),t.tweets[a]=n,await o.xUserTweets.put(t),console.log("✅ [楼中楼回复] 用户推文已更新到账户:",e)):console.warn("⚠️ [楼中楼回复] 未找到目标用户推文")}else console.warn("⚠️ [楼中楼回复] 未找到用户推文数据")}else{console.log("💬 [楼中楼回复] 保存到主页推文数据库");const e=await o.xTweetsData.get("tweets");if(e){let t=!1;if(e.forYouTweets){const o=e.forYouTweets.findIndex(e=>e.id===n.id);-1!==o&&(e.forYouTweets[o]=n,t=!0,console.log("💬 [楼中楼回复] 已更新 forYouTweets"))}if(!t&&e.followingTweets){const o=e.followingTweets.findIndex(e=>e.id===n.id);-1!==o&&(e.followingTweets[o]=n,t=!0,console.log("💬 [楼中楼回复] 已更新 followingTweets"))}t?(await o.xTweetsData.put(e),console.log("✅ [楼中楼回复] 主页推文已保存到数据库")):console.warn("⚠️ [楼中楼回复] 未在主页数据中找到目标推文")}}}else console.warn("⚠️ [楼中楼回复] 未找到主评论，mainCommentId:",l)}else console.warn("⚠️ [楼中楼回复] sessionStorage 中无推文数据")}catch(n){console.error("❌ [楼中楼回复] 保存失败:",n)}}else{const n=i.comments.find(n=>n.id===l);if(n){n.replies||(n.replies=[]),n.replies.push(g);const t=P.findIndex(n=>n.id===i.id);if(-1!==t)P[t]=i;else{const n=D.findIndex(n=>n.id===i.id);-1!==n&&(D[n]=i)}try{const n=e();await n.xTweetsData.put({id:"tweets",forYouTweets:P,followingTweets:D,lastUpdated:(new Date).toISOString()}),console.log("用户回复已保存到数据库，回复ID:",g.id)}catch(n){console.error("保存回复数据失败:",n)}tn(cn)}}pn(t),mn("你的评论等待回复中","info");const m=i.user&&(i.user.handle===te.handle||i.id.startsWith("user_"));setTimeout(async()=>{await Co(i,g,{isOwnPost:m,commentType:"reply_comment",pageType:c?"detail":"main",parentComment:s,mainCommentId:l})},100)}function mn(n,e="success"){const t=document.querySelector(".x-toast");t&&t.remove();const o=document.getElementById("x-social-screen"),a=o?.classList.contains("x-theme-light");let i,r,s,l,c;"success"===e?(c="✓",a?(i="linear-gradient(135deg, rgba(29, 155, 240, 0.15) 0%, rgba(29, 155, 240, 0.08) 100%)",r="rgba(29, 155, 240, 0.4)",s="#1d9bf0",l="rgba(29, 155, 240, 0.3)"):(i="linear-gradient(135deg, rgba(29, 155, 240, 0.25) 0%, rgba(29, 155, 240, 0.15) 100%)",r="rgba(29, 155, 240, 0.6)",s="#60c5ff",l="rgba(29, 155, 240, 0.4)")):"error"===e?(c="✕",a?(i="linear-gradient(135deg, rgba(244, 33, 46, 0.15) 0%, rgba(244, 33, 46, 0.08) 100%)",r="rgba(244, 33, 46, 0.4)",s="#f4212e",l="rgba(244, 33, 46, 0.3)"):(i="linear-gradient(135deg, rgba(244, 33, 46, 0.25) 0%, rgba(244, 33, 46, 0.15) 100%)",r="rgba(244, 33, 46, 0.6)",s="#ff6b75",l="rgba(244, 33, 46, 0.4)")):(c="ℹ",a?(i="linear-gradient(135deg, rgba(83, 100, 113, 0.15) 0%, rgba(83, 100, 113, 0.08) 100%)",r="rgba(83, 100, 113, 0.4)",s="#536471",l="rgba(83, 100, 113, 0.3)"):(i="linear-gradient(135deg, rgba(113, 118, 123, 0.25) 0%, rgba(113, 118, 123, 0.15) 100%)",r="rgba(113, 118, 123, 0.6)",s="#8b98a5",l="rgba(113, 118, 123, 0.4)"));const d=document.createElement("div");d.className="x-toast",d.innerHTML=`\n      <div class="x-toast-icon">${c}</div>\n      <div class="x-toast-message">${n}</div>\n      <div class="x-toast-scanline"></div>\n    `,d.style.cssText=`\n      position: fixed;\n      top: 80px;\n      left: 50%;\n      transform: translateX(-50%);\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      padding: 12px 20px;\n      background: ${i};\n      backdrop-filter: blur(12px);\n      -webkit-backdrop-filter: blur(12px);\n      border: 2px solid ${r};\n      color: ${s};\n      font-size: 15px;\n      font-weight: 600;\n      z-index: 100000;\n      box-shadow:\n        0 4px 16px ${l},\n        inset 0 1px 0 rgba(255, 255, 255, 0.1);\n      clip-path: polygon(\n        0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px,\n        100% calc(100% - 8px), calc(100% - 8px) 100%,\n        8px 100%, 0 calc(100% - 8px)\n      );\n      animation: xToastSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;\n      pointer-events: none;\n      user-select: none;\n    `;d.querySelector(".x-toast-icon").style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      width: 24px;\n      height: 24px;\n      font-size: 16px;\n      font-weight: bold;\n      flex-shrink: 0;\n    ";d.querySelector(".x-toast-message").style.cssText="\n      flex: 1;\n      line-height: 1.4;\n    ";d.querySelector(".x-toast-scanline").style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        rgba(255, 255, 255, 0.03) 0px,\n        rgba(255, 255, 255, 0.03) 1px,\n        transparent 1px,\n        transparent 2px\n      );\n      pointer-events: none;\n      z-index: 1;\n    ";const p=document.createElement("style");p.textContent="\n      @keyframes xToastSlideIn {\n        0% {\n          opacity: 0;\n          transform: translateX(-50%) translateY(-30px) scale(0.9);\n        }\n        100% {\n          opacity: 1;\n          transform: translateX(-50%) translateY(0) scale(1);\n        }\n      }\n      @keyframes xToastSlideOut {\n        0% {\n          opacity: 1;\n          transform: translateX(-50%) translateY(0) scale(1);\n        }\n        100% {\n          opacity: 0;\n          transform: translateX(-50%) translateY(-30px) scale(0.9);\n        }\n      }\n    ",document.head.appendChild(p),document.body.appendChild(d),setTimeout(()=>{d.style.animation="xToastSlideOut 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards",setTimeout(()=>{d.parentNode&&d.remove(),p.parentNode&&p.remove()},300)},2700)}async function xn(){const e=document.querySelector(".x-refresh-btn");e.style.animation="spin 1s linear infinite";const t=document.createElement("style");t.textContent="\n @keyframes spin {\n from {transform: rotate(0deg); }\n to {transform: rotate(360deg); }\n }\n ",document.head.appendChild(t);try{const{db:e,xDb:t,apiConfig:o,xSettings:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r,boundCharacters:l}=a,c=await g.loadBoundNPCs(),p=s.buildUserXProfileInfo(n.userProfileData);console.log("🎭 绑定角色数量:",l.length),l.length>0&&console.log("🎭 绑定角色列表:",l),console.log("👤 已知身份角色数:",n.userProfileData.knownIdentityCharacters?.length||0),n.userProfileData.knownIdentityCharacters?.length>0&&console.log("👤 已知身份角色列表:",n.userProfileData.knownIdentityCharacters);const m=p.publicIdentity||"",x=p.bio||"",u=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(m+" "+x),h=[];if(l.length>0){const n=await t.xCharacterProfiles.toArray();for(const e of l){const t=n.find(n=>n.characterId===e);if(t&&t.publicIdentity){/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(t.publicIdentity)&&h.push({characterId:e,xProfile:t})}}}console.log("🌟 高曝光身份检测:",{isUserHighExposure:u,highExposureCharactersCount:h.length,highExposureCharactersList:h.map(n=>n.xProfile.xName)});let f="";if(u||h.length>0){const n=`userTweets_${vt||"main"}`,e=await t.xUserTweets.get(n),o=e?.tweets?.slice(0,3)||[];if(o.length>0||h.length>0){f="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━🌟 高曝光身份 - 近期推文上下文\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下是高曝光身份的公众人物近期发布的推文，其他用户可能会讨论这些内容：\n",u&&o.length>0&&(f+=`\n【${p.name} 的近期推文】（${p.publicIdentity}）\n`,o.forEach((n,e)=>{if(f+=`\n${e+1}. "${n.content}"`,n.location&&(f+=`\n- 位置：${n.location}`),n.image&&("description"===n.image.type?f+=`\n- 图片描述：${n.image.content}`:"upload"===n.image.type?f+="\n- 附带真实上传图片":"uploads"===n.image.type&&n.image.images&&(f+=`\n- 附带${n.image.images.length}张真实上传图片`)),n.link&&(f+=`\n- 附带链接：${n.link.title||n.link.url||"链接"}`,n.link.description&&(f+=`（${n.link.description}）`)),n.quotedTweet){const e=n.quotedTweet,t="tweet"===e.type?"推文":"评论";f+=`\n- 引用转发了 ${e.user.name} 的${t}："${e.content}"`,e.image&&("description"===e.image.type?f+=`（含图片：${e.image.content}）`:f+="（含图片）")}if(n.quotedFanGroup){const e=n.quotedFanGroup;f+=`\n- 转发了粉丝群：${e.name}（${e.memberCount||0}位成员，门槛：${e.threshold||"无"}）`}f+=`\n- 发布时间：${n.time||"最近"}\n- 互动数据：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n`}));for(const{xProfile:n}of h)f+=`\n【${n.xName} 的信息】（${n.publicIdentity}）\n- 可能会发布与其身份相关的推文\n- 可能会被其他用户讨论或提及\n`;f+="\n【高曝光身份推文生成规则】：\n- 约20-30%的新推文可以包含对上述推文的讨论、转发、或评论\n- 讨论应该是其他普通用户或粉丝的视角，而非本人\n- 可以是支持、批评、分析、或单纯的转发评论\n- 不要在每条推文中都提及，保持自然和多样性\n- 其余70-80%的推文应该是与高曝光身份无关的通用热门内容\n- 如果生成讨论推文，要体现公众人物的影响力（较高的互动数据）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",console.log("📰 已加载高曝光身份近期推文上下文，用户推文数:",o.length)}}let b=0;const v=new Date;let y=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 时间感知\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前北京时间：${v.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",weekday:"long"})}\n【时间相关提示】：\n- 生成的推文时间应该合理（例如：刚刚、1分钟前、5分钟前、1小时前、今天 xx:xx等）\n- 不要生成未来时间\n- 根据当前时间判断是早晨、中午、下午、晚上、深夜，内容应该符合时段特征\n- 周末/工作日的内容风格可以有所不同\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`+s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});b=d.logTokenUsage("推文生成器","时间感知+基础系统提示词",y,b);const w=await s.getApplicableWorldBooks("feed",{boundCharacters:l});w&&(y+=w,b=d.logTokenUsage("推文生成器","世界书内容",w,b));const k=`worldEvents_${vt||"main"}`,$=await t.xWorldEvents.get(k);if($&&$.enabled&&$.events&&$.events.length>0){const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌍 世界运转状态（推文生成必读）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前世界设定】：\n📍 所在地点：${$.location}\n🌤️ 天气状况：${$.weather?.condition||"--"} ${$.weather?.temp||"--"}\n💡 穿衣建议：${$.weather?.tip||"--"}\n\n【近期大事件】（${$.events.length}个热门事件）：\n${$.events.map((n,e)=>`\n${e+1}. [${n.category}] ${n.title}\n   详情：${n.detail}\n   影响：${n.impact}\n`).join("")}\n\n【大事件融入规则】：\n🎯 核心原则：约10-40%的推文应该围绕这些大事件展开，让世界显得鲜活\n1. **直接讨论**：路人/角色直接评论某个事件，发表看法\n2. **间接影响**：事件影响了日常生活（如天气影响穿着、政策影响工作等）\n3. **转发声明**：如果某个事件涉及明星/公众人物，可能有当事人声明或粉丝转发\n4. **话题延伸**：从大事件延伸出相关话题讨论\n5. **黑色幽默**：保持讽刺、夸张的黑色幽默风格，与事件本身的风格一致\n6. **自然融入**：不要强行在每条推文中提及，保持多样性\n\n【注意】：\n- 其余60-90%的推文可以是与事件无关的日常内容\n- 事件讨论要符合用户/角色的身份和视角\n- 路人评论只能基于事件的公开信息，不能知道内幕细节\n- 角色如果与事件相关（如明星角色遇到娱乐事件），可以有更深入的互动\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;y+=n,b=d.logTokenUsage("推文生成器","世界运转大事件",n,b),console.log(`🌍 [推文生成器] 已注入 ${$.events.length} 个世界大事件`)}else console.log("ℹ️ [推文生成器] 世界大事件未启用或无数据，生成常规推文");y+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的内容生成器。请生成两组推文数据：\n- "为你推荐"页面（热门有趣内容）\n- "正在关注"页面（个人生活日常）\n**你只负责生成其他用户的推文，绝不生成用户本人的推文！**\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【生成要求】：\n- 每组生成5-10条推文，内容多样化\n- 热门推文5-12条评论，普通推文1-5条，支持多层级楼中楼回复\n- **绑定角色可以作为推文发布者**：根据角色设定和兴趣发布独立推文\n- **绑定NPC可以作为推文发布者**：根据NPC人设和发帖习惯发布推文\n- NPC关系互动：有绑定关系的NPC在角色推文下自然留言，体现关系特点\n- 除了绑定角色外，其他用户头像统一：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n- 引用推文功能：约20-30%的推文可以使用引用功能，适合表达观点、评论热点、转发有趣内容\n【情侣关系与粉丝群体规则】：\n'+("couple"===p.verificationType&&p.coupleCharacterName?`- **情侣关系自然化**：用户与${p.coupleCharacterName}是公开情侣，但这是私人关系\n- 情侣角色可以偶尔出现在推文/评论中，但频率要低（建议10-20%概率），保持自然\n- 情侣互动应该围绕推文主题，不要每次都强调情侣身份\n- 粉丝群体判断：\n* 如果用户或情侣角色有明星/网红/公众人物等身份 → 可以生成少量CP粉丝评论（最多1-2条）\n* 如果都是普通人身份 → 禁止生成"磕CP""嗑糖"等粉丝向评论，普通情侣不会有粉丝群体`:"- **普通情侣关系**：如果生成情侣内容，确保只在适合的场景下出现，且不应有粉丝群体");const C=y.substring(b>0?y.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"):0);b=d.logTokenUsage("推文生成器","核心任务说明",C,b);const I=await s.buildCompleteCharacterInfo(l,p,"tweet");I&&(y+=I,b=d.logTokenUsage("推文生成器","角色资料信息",I,b));const S=await s.buildCharacterRelationships(l,vt||"main");if(S&&(y+=S,b=d.logTokenUsage("推文生成器","角色关系网络",S,b),console.log("💞 已加载角色关系网络信息")),c.length>0){const n=y.length;y+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 绑定NPC资料\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下是与当前用户绑定的NPC，他们可以在推文生成中作为独立用户出现：\n";for(const n of c)y+=`\n【NPC基本信息】\n- X姓名：${n.name}\n- X句柄：${n.handle}\n- X头像：${n.avatar}\n- 认证状态：false（NPC默认无认证）\n【NPC人设】\n${n.personality||"暂无人设描述"}\n【发帖习惯】\n${n.postingHabits||"暂无发帖习惯描述"}\n【主页内容】\n${n.homepage||"暂无主页内容设置"}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;y+=`\n【NPC使用规则】：\n1. NPC可以作为推文发布者，生成符合其人设和发帖习惯的推文\n2. NPC可以在评论区出现，根据其人设进行互动\n3. NPC的内容应该围绕其人设和主页内容展开\n4. NPC与角色/用户的互动应该自然，不要过于频繁\n5. 严格使用NPC的X姓名(${c.map(n=>n.name).join("、")})、句柄(${c.map(n=>n.handle).join("、")})和头像\n6. NPC认证状态固定为 false\n`;const e=y.substring(n);b=d.logTokenUsage("推文生成器","NPC资料信息",e,b)}f&&(y+=f,b=d.logTokenUsage("推文生成器","高曝光身份推文上下文",f,b));const M=y.length;y+=s.buildUniversalConstraints(p);const T=y.substring(M);b=d.logTokenUsage("推文生成器","用户资料约束",T,b),y+='\n【JSON返回格式】：\n```json\n{"forYouTweets": [推文数组], "followingTweets": [推文数组]}\n```\n推文对象结构：\n- user: {name, handle, avatar, verified}\n- content: 推文文本\n- time: 时间描述\n- stats: {comments, retweets, likes, views} (纯数字)\n- sticker: {url: "表情包链接", description: "表情包描述"} (可选，约10-15%评论使用)\n- media: [{type:"description", description:"文字描述，至少30字"}] (可选)\n- quotedTweet: {type, user, content, time} (可选，约20-30%推文使用)\n- comments: [评论数组] (3-8条热门推文，1-4条普通推文)\n评论对象结构：\n- user: {name, handle, avatar, verified}\n- content: 评论文本\n- time: 时间描述\n- replies: [回复数组] (可选，支持多层级但不超过3层)\n- replyTo: "@被回复者句柄" (楼中楼回复时必填)\n关键规则：\n1. verified字段必须是布尔值(true/false)\n2. stats中所有数字必须是纯数字，不带引号\n3. 可选字段不使用时完全省略，不要设为null\n4. content直接写内容，不用引号包裹';const A=y.substring(y.lastIndexOf("【JSON返回格式】"));b=d.logTokenUsage("推文生成器","JSON格式要求",A,b);const E=[{role:"user",content:"请生成新的X社交平台推文数据"}];d.logFinalPrompt("推文生成器",y,E[0].content);const z=await g.sendAIRequest({apiConfig:o,systemPrompt:y,messages:E,temperature:.8});let B=g.parseJSONResponse(z);if(B=await g.postProcessData(B,p),!B.forYouTweets||!B.followingTweets)throw new Error("AI返回的数据格式不正确，缺少必要字段");const L=n=>n.map(n=>(n.stats||(n.stats={comments:n.comments?.length||0,retweets:0,likes:0,views:0}),n.comments&&(n.comments=n.comments.map(n=>{const e={...n,id:`c_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};return n.replies&&(e.replies=n.replies.map(n=>({...n,id:`r_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}))),e})),n));B.forYouTweets=L(B.forYouTweets),B.followingTweets=L(B.followingTweets);const N=Date.now();B.forYouTweets.forEach((n,e)=>{n.id=`fy_${N}_${e}`,n.createdAt=N}),B.followingTweets.forEach((n,e)=>{n.id=`fl_${N}_${e}`,n.createdAt=N}),P.unshift(...B.forYouTweets),D.unshift(...B.followingTweets),P.length>50&&P.splice(50),D.length>50&&D.splice(50);try{await t.xTweetsData.put({id:"tweets",forYouTweets:B.forYouTweets,followingTweets:B.followingTweets,lastUpdated:(new Date).toISOString()})}catch(n){console.error("保存推文数据失败:",n)}const R=p.handle;let H=!1;for(const n of B.forYouTweets){if(n.content&&n.content.includes(R)){H=!0;break}if(n.comments)for(const e of n.comments){if(e.content&&e.content.includes(R)){H=!0;break}if(e.replies)for(const n of e.replies)if(n.content&&n.content.includes(R)){H=!0;break}if(H)break}if(H)break}if(!H)for(const n of B.followingTweets){if(n.content&&n.content.includes(R)){H=!0;break}if(n.comments)for(const e of n.comments){if(e.content&&e.content.includes(R)){H=!0;break}if(e.replies)for(const n of e.replies)if(n.content&&n.content.includes(R)){H=!0;break}if(H)break}if(H)break}B.forYouTweets.forEach(n=>{n.isNew=!0}),B.followingTweets.forEach(n=>{n.isNew=!0}),q(P,"for-you-content"),q(D,"following-content");const j="en"===Hn,U=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";Rl(H?{title:"X",message:j?"Your feed has been refreshed! Someone mentioned you 🔔":"你的首页已刷新！有人提到你了哦 🔔",avatar:U,leftIcon:"x"}:{title:"X",message:j?"Your feed has been refreshed!":"你的首页已刷新！",avatar:U,leftIcon:"x"})}catch(n){console.error("刷新推文失败:",n),mn(`刷新失败: ${n.message}`,"error")}finally{e.style.animation="",t.parentNode&&t.remove()}}let un=!1;async function hn(t=!1){try{console.log(`🌍 [世界大事件] 开始${t?"推进":"生成"}大事件...`);const o=e(),a=`worldEvents_${vt||"main"}`;let i=null;if(t&&(i=await o.xWorldEvents.get(a),!i)){return void mn("en"===Hn?"No events found, please generate first":"没有现有事件，请先生成","error")}const{apiConfig:r,xSettings:l}=await g.loadConfigAndSettings(),{userPrompt:c,worldSetting:p}=l;let m=0;const x=new Date;let u=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 时间感知\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前北京时间：${x.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",weekday:"long"})}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`+s.buildBaseSystemPrompt({userPrompt:c,worldSetting:p});m=d.logTokenUsage("世界大事件生成器","时间感知+基础系统提示词",u,m);const h=await s.getApplicableWorldBooks("global",{});h&&(u+=h,m=d.logTokenUsage("世界大事件生成器","世界书内容",h,m));const f=s.buildUserXProfileInfo(n.userProfileData);if(t){const n=Date.now()-(i.lastProgressed||i.lastGenerated),e=Math.floor(n/36e5),t=Math.floor(e/24);u+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：世界推进模式\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是一个世界运转模拟器，负责推进已有的世界大事件。\n\n【当前世界状态】：\n📍 所在地点：${i.location}\n🌤️ 天气状况：${i.weather?.condition||"--"} ${i.weather?.temp||"--"}\n\n【现有大事件】（${i.events.length}个）：\n${i.events.map((n,e)=>`\n${e+1}. [${n.category}] ${n.title}\n   详情：${n.detail}\n   影响：${n.impact}\n`).join("\n")}\n\n【时间推进】：\n距离上次更新已过去 ${e} 小时（${t} 天）\n\n【推进任务】：\n1. **更新天气**：根据时间推移，合理更新天气状况（气温、天气、穿衣建议）\n2. **推进现有事件**（30%）：选择1-2个现有事件，推进其发展（新进展、后续影响、反转等）\n3. **生成新事件**（70%）：生成2-6个全新的大事件，符合世界观和时间线\n4. **保持连贯性**：新旧事件可以有关联，形成因果链\n\n【事件要求】：\n- 总事件数控制在3-8个以内\n- 必须符合现有世界观设定\n- 黑色幽默风格，夸张但不荒诞\n- 事件分类：抓马/政治/体育/娱乐/明星/新闻/流言/科技/社会等\n- 每个事件包含：标题（10-30字）、分类、详细描述（50-150字）、影响（20-80字）\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n\n【JSON返回格式】：\n\`\`\`json\n{\n  "location": "城市名",\n  "weather": {\n    "temp": "15-22°C",\n    "condition": "多云转晴",\n    "tip": "建议穿薄外套，早晚温差大"\n  },\n  "events": [\n    {\n      "title": "事件标题",\n      "category": "娱乐",\n      "detail": "事件详细描述，黑色幽默风格",\n      "impact": "事件造成的影响和后果"\n    }\n  ]\n}\n\`\`\`\n`}else u+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：世界初始化\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是一个世界运转模拟器，负责为用户生成一个鲜活的、运转中的世界。\n\n【任务】：\n1. **确定地点**：${f.publicIdentity?`用户是${f.publicIdentity}，`:""}根据用户设定和世界观，确定一个合理的所在城市/地点\n2. **生成天气**：当前时间的天气状况（气温范围、天气描述、穿衣建议）\n3. **生成大事件**：3-8个近期发生的大事件（近三天，主要是今天）\n\n【事件要求】：\n- 必须符合世界观设定，不要脱离世界观臆造\n- 黑色幽默风格：讽刺、荒诞、夸张，但保持逻辑自洽\n- 事件分类多样化：政治丑闻、娱乐八卦、体育赛事、明星抓马、社会新闻、流言蜚语、科技突破、经济波动等\n- 好坏参半：不全是正面或负面，有起有落才真实\n- 每个事件包含：\n  * 标题：10-30字，抓眼球\n  * 分类：简短标签（如"娱乐"、"政治"、"体育"）\n  * 详细：50-150字，黑色幽默叙述\n  * 影响：20-80字，这事儿对世界/人们的影响\n\n【风格示例】：\n❌ 平淡："某市长宣布新政策"\n✅ 黑色幽默："某市长凌晨三点发推宣布禁止凌晨三点发推，网友：你先自首吧"\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n\n【JSON返回格式】：\n\`\`\`json\n{\n  "location": "城市名（如上海、纽约、虚构城市名等）",\n  "weather": {\n    "temp": "温度范围（如15-22°C）",\n    "condition": "天气状况（如多云转晴、小雨、晴朗等）",\n    "tip": "穿衣建议（如建议穿薄外套，早晚温差大）"\n  },\n  "events": [\n    {\n      "title": "事件标题",\n      "category": "事件分类",\n      "detail": "事件详细描述，黑色幽默风格",\n      "impact": "事件造成的影响和后果"\n    }\n  ]\n}\n\`\`\`\n`;const b=u.substring(m>0?u.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"):0);m=d.logTokenUsage("世界大事件生成器","核心任务说明",b,m);const v=[{role:"user",content:t?"请推进世界大事件":"请生成世界大事件"}];d.logFinalPrompt("世界大事件生成器",u,v[0].content);const y=await g.sendAIRequest({apiConfig:r,systemPrompt:u,messages:v,temperature:.9});let w=g.parseJSONResponse(y);if(!w.location||!w.weather||!w.events)throw new Error("AI返回的数据格式不正确，缺少必要字段");w.events=w.events.map((n,e)=>({...n,id:`evt_${Date.now()}_${e}`,timestamp:(new Date).toISOString()}));const k={id:a,accountId:vt||"main",enabled:!0,location:w.location,weather:w.weather,events:w.events,lastGenerated:t?i.lastGenerated:Date.now(),lastProgressed:Date.now(),updatedAt:(new Date).toISOString()};await o.xWorldEvents.put(k),console.log(`✅ [世界大事件] ${t?"推进":"生成"}完成，共${k.events.length}个事件`),fn(k);const $="en"===Hn;mn(t?$?"Events progressed":"世界事件已推进":$?"Events generated":"世界事件已生成","success")}catch(n){console.error("生成世界大事件失败:",n);mn("en"===Hn?`Generation failed: ${n.message}`:`生成失败: ${n.message}`,"error")}}function fn(n){if(!n)return;const e=document.getElementById("world-location");e&&(e.textContent=n.location||"--");const t=document.getElementById("weather-condition"),o=document.getElementById("weather-temp"),a=document.getElementById("weather-tip");t&&(t.textContent=n.weather?.condition||"--"),o&&(o.textContent=n.weather?.temp||"--"),a&&(a.textContent=n.weather?.tip||"--");const i=document.getElementById("last-generated-time"),r=document.getElementById("last-progressed-time");i&&(i.textContent=n.lastGenerated?new Date(n.lastGenerated).toLocaleString("zh-CN"):"--"),r&&(r.textContent=n.lastProgressed?new Date(n.lastProgressed).toLocaleString("zh-CN"):"--");const s=document.getElementById("world-events-list");if(s)if(n.events&&0!==n.events.length){const e="en"===Hn?"Impact":"影响";s.innerHTML=n.events.map((n,t)=>`\n          <div style="background-color: var(--x-bg-primary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 12px; margin-bottom: 8px;">\n            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n              <span style="background-color: var(--x-accent); color: #fff !important; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 4px;">${n.category}</span>\n              <span style="color: var(--x-text-primary); font-size: 14px; font-weight: 600; flex: 1;">${n.title}</span>\n            </div>\n            <div style="color: var(--x-text-primary); font-size: 13px; line-height: 1.4; margin-bottom: 8px;">${n.detail}</div>\n            <div style="color: var(--x-text-secondary); font-size: 12px; padding-top: 8px; border-top: 1px solid var(--x-border-color);">\n              <strong style="color: var(--x-accent);">${e}:</strong> ${n.impact}\n            </div>\n          </div>\n        `).join("")}else{const n="en"===Hn?"No events yet":"暂无事件";s.innerHTML=`<p style="color: var(--x-text-secondary); text-align: center; padding: 20px;">${n}</p>`}!function(n){const e=document.getElementById("progress-world-events-btn"),t=document.getElementById("progress-cooldown-tip");if(!e||!n)return;const o=Date.now(),a=n.lastProgressed||n.lastGenerated,i=o-a,r=108e5;if(i<r){e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed";const n=r-i,o=Math.floor(n/36e5),a=Math.floor(n%36e5/6e4);if(t){t.style.display="block";const n="en"===Hn;t.textContent=n?`Cooldown: ${o}h ${a}m remaining`:`推进功能冷却中，剩余 ${o}小时${a}分钟`}}else e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",t&&(t.style.display="none")}(n)}async function bn(n,t={}){const{usageRate:o=.3,usageDescription:a="",isPublicFigure:i=!1}=t;try{const t=e(),r=`worldEvents_${vt||"main"}`,s=await t.xWorldEvents.get(r);if(!s||!s.enabled||!s.events||0===s.events.length)return console.log(`ℹ️ [${n}] 世界大事件未启用或无数据`),"";const l=Math.round(100*o),c=100-l,d=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌍 世界运转状态（${n}必读）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前世界设定】：\n📍 所在地点：${s.location}\n🌤️ 天气状况：${s.weather?.condition||"--"} ${s.weather?.temp||"--"}\n💡 穿衣建议：${s.weather?.tip||"--"}\n\n【近期大事件】（${s.events.length}个热门事件）：\n${s.events.map((n,e)=>`\n${e+1}. [${n.category}] ${n.title}\n   详情：${n.detail}\n   影响：${n.impact}\n`).join("")}\n\n【大事件融入规则】：\n🎯 核心原则：约${l}%的内容应该围绕这些大事件展开，让世界显得鲜活\n${a||"1. **直接讨论**：直接评论某个事件，发表看法\n2. **间接影响**：事件影响了日常生活（如天气影响穿着、政策影响工作等）\n3. **转发声明**：如果某个事件涉及明星/公众人物，可能有当事人声明或粉丝转发\n4. **话题延伸**：从大事件延伸出相关话题讨论\n5. **黑色幽默**：保持讽刺、夸张的黑色幽默风格，与事件本身的风格一致\n6. **自然融入**：不要强行在每条内容中提及，保持多样性"}\n${i?'\n⚠️ **公众人物特殊规则**：\n- 高曝光用户可能被网友询问对大事件的看法\n- 遇到灾难/慈善事件时，可能有人要求捐款或表态\n- 遇到争议事件时，可能被要求"站队"表明立场\n- 这些互动要真实展现网络生态（有支持、有质疑、有键盘侠）':""}\n\n【注意】：\n- 其余${c}%的内容可以是与事件无关的日常内容\n- 事件讨论要符合角色的身份和视角\n- 路人评论只能基于事件的公开信息，不能知道内幕细节\n- 黑色幽默风格要保持一致\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;return console.log(`🌍 [${n}] 已注入 ${s.events.length} 个世界大事件（使用率${l}%）`),d}catch(e){return console.error(`❌ [${n}] 读取世界大事件失败:`,e),""}}function vn(n){const e=`${n}-notification-dot`,t=document.getElementById(e);t&&(t.style.display="block",console.log(`✨ 显示${n}提醒点`))}function yn(n){const e=`${n}-notification-dot`,t=document.getElementById(e);t&&(t.style.display="none",console.log(`✅ 清除${n}提醒点`))}n.toggleWorldEvents=async function(){un=!un;const n=document.getElementById("world-events-toggle"),t=n.querySelector(".toggle-circle"),o=document.getElementById("world-events-area"),a=e(),i=`worldEvents_${vt||"main"}`;if(un){n.style.backgroundColor="var(--x-accent)",t.style.left="22px",o.style.display="block";const e=await a.xWorldEvents.get(i);if(e&&e.events&&0!==e.events.length)e.enabled=!0,await a.xWorldEvents.put(e),fn(e);else{mn("en"===Hn?"Generating world events...":"正在生成世界大事件...","info"),await hn()}mn("en"===Hn?"World Events enabled":"世界运转大事件已开启","success")}else{const e=await a.xWorldEvents.get(i);e&&(e.enabled=!1,await a.xWorldEvents.put(e),console.log("🔴 [世界大事件] 已在数据库中标记为禁用")),n.style.backgroundColor="#333",t.style.left="2px",o.style.display="none";mn("en"===Hn?"World Events disabled":"世界运转大事件已关闭","info")}await async function(n){try{const t=e(),o=`xSettings_${vt||"main"}`;let a=await t.xSettings.get(o);a?(a.worldEventsEnabled=n,a.updatedAt=(new Date).toISOString()):a={id:o,worldEventsEnabled:n,updatedAt:(new Date).toISOString()},await t.xSettings.put(a),console.log("💾 [世界大事件] 状态已保存: "+(n?"开启":"关闭"))}catch(n){console.error("保存世界大事件状态失败:",n)}}(un)},n.refreshWorldEvents=async function(){if(!un){return void mn("en"===Hn?"Please enable World Events first":"请先开启世界运转大事件","error")}confirm("en"===Hn?"Regenerate all events? This will replace existing events.":"确定要重新生成所有大事件吗？这将替换现有的所有事件。")&&await hn(!1)},n.progressWorldEvents=async function(){if(!un){return void mn("en"===Hn?"Please enable World Events first":"请先开启世界运转大事件","error")}const n=e(),t=`worldEvents_${vt||"main"}`,o=await n.xWorldEvents.get(t);if(!o){return void mn("en"===Hn?"No events found, please generate first":"没有现有事件，请先生成","error")}const a=Date.now()-(o.lastProgressed||o.lastGenerated),i=108e5;if(a<i){const n=i-a,e=Math.floor(n/36e5),t=Math.floor(n%36e5/6e4);return void mn("en"===Hn?`Cooldown: ${e}h ${t}m remaining`:`推进功能冷却中，剩余 ${e}小时${t}分钟`,"error")}await hn(!0)},n.showNavNotificationDot=vn,n.hideNavNotificationDot=yn;let wn=null,kn=!1;const $n=6e5;function Cn(){const n=new Date(Date.now()+$n),e=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`,t=document.getElementById("next-refresh-time");t&&(t.textContent=e)}async function In(n){try{const t=e(),o=`xSettings_${vt||"main"}`;let a=await t.xSettings.get(o);a?(a.autoRefreshFeedEnabled=n,a.updatedAt=(new Date).toISOString()):a={id:o,autoRefreshFeedEnabled:n,updatedAt:(new Date).toISOString()},await t.xSettings.put(a),console.log("💾 [智能刷新] 状态已保存: "+(n?"开启":"关闭"))}catch(n){console.error("保存刷新状态失败:",n)}}n.toggleAutoRefreshFeed=async function(){kn=!kn;const n=document.getElementById("auto-refresh-feed-toggle"),e=n.querySelector(".toggle-circle"),t=document.getElementById("auto-refresh-feed-status");if(kn){n.style.backgroundColor="var(--x-accent)",e.style.left="22px",t.style.display="block",function(){wn&&clearInterval(wn);wn=setInterval(async()=>{await async function(){try{console.log("⏰ [智能刷新] 开始自动刷新主页推文..."),await xn(),Cn();const n=document.querySelector('.x-page[style*="display: flex"]');n&&"x-home-page"===n.id||vn("home"),console.log("✅ [智能刷新] 刷新完成")}catch(n){console.error("❌ [智能刷新] 自动刷新失败:",n)}}()},$n),Cn()}(),await In(!0);mn("en"===Hn?"Auto refresh enabled":"智能刷新已开启","success")}else{n.style.backgroundColor="#333",e.style.left="2px",t.style.display="none",wn&&(clearInterval(wn),wn=null),await In(!1);mn("en"===Hn?"Auto refresh disabled":"智能刷新已关闭","info")}};let Sn=null,Mn=!1,Tn=null;function An(n,e){if(n===e)return 1;if(0===n.length||0===e.length)return 0;const t=n.length>e.length?n:e,o=n.length>e.length?e:n;let a=0;const i=o.split(""),r=t.split("");i.forEach(n=>{const e=r.indexOf(n);-1!==e&&(a++,r.splice(e,1))});const s=a/t.length;return t.includes(o)?Math.max(s,o.length/t.length):s}async function En(e,t,o,a={}){console.log(`🔍 [账户查询] 查询账户: ${e} (${t})`),(a.bio||a.followersCount||void 0!==a.verified)&&console.log("📋 [账户查询] 检测到私信名片的现有资料:",{bio:a.bio,followersCount:a.followersCount,verified:a.verified});const i=await s.getUnifiedProfile(t,{userProfileInfo:n.userProfileData,includeRecentTweets:!1,includeRelationships:!0});if(!i){console.log("⚠️ 未知账户，将根据基本信息生成:",e);const n={accountType:"unknown",name:e,handle:t,avatar:o,verified:void 0!==a.verified&&a.verified,cover:"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||"",publicIdentity:"",customTag1:null,customTag2:null,followingCount:"",followersCount:a.followersCount||""};return(a.bio||a.followersCount)&&console.log("✅ 使用来自私信的现有资料:",{bio:a.bio,followersCount:a.followersCount,verified:a.verified}),n}console.log(`✅ 识别为 ${i.type} 账户:`,i.name,`(${i.handle})`);let r=[];if("character"===i.type&&i.characterData?.xMessageHistory?r=i.characterData.xMessageHistory:"account"===i.type&&i.accountData?.xMessageHistory?r=i.accountData.xMessageHistory:"npc"===i.type&&i.npcData?.xMessageHistory?r=i.npcData.xMessageHistory:"relationshipNpc"===i.type&&i.relationshipData?.xMessageHistory?r=i.relationshipData.xMessageHistory:"stranger"===i.type&&i.accountData?.xMessageHistory&&(r=i.accountData.xMessageHistory),r.length>0&&console.log(`✅ [账户查询] 提取到 ${r.length} 条X平台私信记忆`),"character"===i.type){let e="verified";"couple"===n.userProfileData.verificationType&&n.userProfileData.coupleCharacterId===i.characterId&&(e="couple");const t={accountType:"character",name:i.name,handle:i.handle,avatar:i.avatar,verified:void 0!==a.verified?a.verified:i.verified,verificationType:i.verified?e:"none",cover:i.xProfile.xCover||"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||i.bio,publicIdentity:i.publicIdentity,customTag1:i.xProfile.customTag1||null,customTag2:i.xProfile.customTag2||null,followingCount:i.xProfile.followingCount||"",followersCount:a.followersCount||i.xProfile.followersCount||"",personality:i.characterData.aiPersona||"",characterData:i.character,xProfileData:i.xProfile,characterId:i.characterId,xMessageHistory:r};return(a.bio||a.followersCount)&&console.log("✅ [角色账户] 已应用私信名片的现有资料"),t}if("npc"===i.type){const n={accountType:"npc",name:i.npc.name,handle:i.npc.handle,avatar:i.npc.avatar,verified:void 0!==a.verified&&a.verified,cover:"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||"",publicIdentity:"",customTag1:null,customTag2:null,followingCount:"",followersCount:a.followersCount||"",personality:i.npc.personality||"",postingHabits:i.npc.postingHabits||"",homepage:i.npc.homepage||"",npcData:i.npc,xMessageHistory:r};return(a.bio||a.followersCount)&&console.log("✅ [NPC账户] 已应用私信名片的现有资料"),n}if("relationshipNpc"===i.type){const n={accountType:"relationshipNpc",name:i.relationship.npcName,handle:i.relationship.npcHandle,avatar:o||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:void 0!==a.verified&&a.verified,cover:"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||"",publicIdentity:"",customTag1:null,customTag2:null,followingCount:"",followersCount:a.followersCount||"",relationshipType:i.relationship.relationshipType,relationshipDescription:i.relationship.description||"",ownerCharacterId:i.ownerCharacter.id,ownerCharacterName:i.ownerCharacter.name,ownerXProfile:i.ownerXProfile,relationshipData:i.relationship,xMessageHistory:r};return(a.bio||a.followersCount)&&console.log("✅ [关系NPC账户] 已应用私信名片的现有资料"),n}if("account"===i.type){const n={accountType:"account",name:i.accountInfo.name,handle:i.accountInfo.handle,avatar:i.accountInfo.avatar,verified:void 0!==a.verified?a.verified:i.accountInfo.verified||!1,verificationType:i.accountInfo.verificationType||"none",cover:i.accountInfo.cover||"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||i.accountInfo.bio||"",publicIdentity:i.accountInfo.publicIdentity||"",customTag1:i.accountInfo.customTag1||null,customTag2:i.accountInfo.customTag2||null,followingCount:i.accountInfo.followingCount||"",followersCount:a.followersCount||i.accountInfo.followersCount||"",accountInfo:i.accountInfo,xMessageHistory:r};return(a.bio||a.followersCount)&&console.log("✅ [X账户] 已应用私信名片的现有资料"),n}return{accountType:"unknown",name:e,handle:t,avatar:o,verified:void 0!==a.verified&&a.verified,cover:"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:a.bio||"",publicIdentity:"",customTag1:null,customTag2:null,followingCount:"",followersCount:a.followersCount||""}}async function zn(e,o={}){try{const{isProgressMode:a=!1,existingTweets:i=[],existingReplies:r=[],sourceContext:l={}}=o,{apiConfig:c,xSettings:p,xDb:m}=await g.loadConfigAndSettings(),{userPrompt:x,worldSetting:u}=p,h=s.buildUserXProfileInfo(n.userProfileData);let f=0,b=s.buildBaseSystemPrompt({userPrompt:x,worldSetting:u});f=d.logTokenUsage("账户主页生成器","基础系统提示词",b,f);const v={boundCharacters:[]};"character"===e.accountType&&e.characterId&&(v.boundCharacters=[e.characterId]);const y=await s.getApplicableWorldBooks("profile",v);y&&(b+=y,f=d.logTokenUsage("账户主页生成器","世界书内容",y,f));const w=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((e.publicIdentity||"")+" "+(e.bio||"")),k=await bn("账户主页生成器",{usageRate:.3,isPublicFigure:w,usageDescription:`**账户主页场景的大事件使用**：\n1. **推文内容**：约10%的推文可能围绕大事件展开\n   - 发表对大事件的看法或评论\n   - 分享与大事件相关的内容或心得\n   - 如果是相关领域专家，可能深入分析\n2. **回复互动**：账户可能回复其他人关于大事件的讨论\n   - 在别人的推文下评论大事件\n   - 回复关于大事件的提问\n3. **喜欢内容**：账户可能喜欢与大事件相关的推文\n   - 喜欢对大事件的精彩评论\n   - 喜欢大事件相关的资讯或分析\n4. **身份影响**：${w?"公众人物的推文可能被要求对大事件表态":"普通账户可能自然讨论大事件"}\n5. **自然融入**：只有约10%的内容涉及大事件，其余90%展示账户的日常和个性`});if(k&&(b+=k,f=d.logTokenUsage("账户主页生成器","世界运转大事件",k,f)),b+=a?"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：推进账户主页内容 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你需要为X平台账户生成**新的**主页展示内容，包括：\n- **新的**推文（3-4条，必须与已有内容完全不同）\n- **新的**回复互动（2-3条，必须与已有回复完全不同）\n⚠️⚠️⚠️ 【绝对禁止重复】⚠️⚠️⚠️\n- 已有的推文和回复会在下方完整展示\n- 新推文的内容、话题、观点必须与已有推文**完全不同**\n- 新回复必须是全新的互动对象和内容\n- 绝对不允许出现相同或高度相似的表达\n**推进模式生成策略**：\n- 账户基本信息已固定，不需要生成\n- 新推文应展现不同的话题维度或新的生活动态\n- 可以是时间流逝后的新话题、新想法、新事件\n- 新推文的时间应该比已有推文更新\n- 严格遵循账户已有的风格和人设，但内容必须全新\n- **禁止生成置顶推文**：所有新推文的 pinned 字段必须设置为 false 或不设置\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n":"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：生成账户主页内容 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你需要为X平台账户生成主页展示内容，包括：\n- 账户基本信息（若已提供则严格使用，不可修改）\n- 最近发布的推文（3-5条）\n- 推文下的评论互动\n**生成原则**：\n- 如果是已知角色账户，必须严格遵循其X资料设定\n- 如果是NPC账户，必须严格遵循其人设和发帖习惯\n- 如果是角色关系NPC账户，必须体现与所属角色的关系特点，遵循关系设定\n- 如果是未知账户，根据昵称、句柄、简介进行合理推断\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",b+=`\n【目标账户信息】：\n- X姓名：${e.name}\n- X句柄：${e.handle}\n- X头像：${e.avatar}\n- 认证状态：${e.verified?"是":"否"}\n${e.verified?"- 认证类型："+("couple"===e.verificationType?"情侣认证（心形图标）":(e.verificationType,"普通认证（蓝色勾标）")):""}\n${e.bio?`- X简介：${e.bio}`:""}\n${e.publicIdentity?`- 公众身份：${e.publicIdentity}`:""}\n${e.personality?`- 人设描述：${e.personality}`:""}\n${e.postingHabits?`- 发帖习惯：${e.postingHabits}`:""}\n${e.cover?`- 背景图：${e.cover}`:""}\n${e.customTag1?`- 自定义标签1：${e.customTag1.icon} ${e.customTag1.text} (${e.customTag1.color})`:""}\n${e.customTag2?`- 自定义标签2：${e.customTag2.icon} ${e.customTag2.text} (${e.customTag2.color})`:""}\n${e.followingCount?`- 正在关注：${e.followingCount}`:""}\n${e.followersCount?`- 关注者：${e.followersCount}`:""}\n`,l&&l.source){if(b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【账户来源上下文】\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n","feed"===l.source)b+=`来源：首页推文\n该账户发布的内容：\n"${l.tweetContent}"\n${l.tweetMedia&&l.tweetMedia.length>0?`媒体内容：${l.tweetMedia[0].description}\n`:""}- 发布时间：${l.tweetTime}\n- 互动数据：${l.tweetStats?.comments||0}评论，${l.tweetStats?.likes||0}喜欢，${l.tweetStats?.retweets||0}转发\n**生成要求**：\n- 基于该账户发布的内容，推断其兴趣、话题偏好和发帖风格\n- 生成的主页推文应该与这条推文风格一致\n- 可以生成主题相关但不重复的推文内容`;else if("comment"===l.source)b+=`来源：评论区\n该账户发表的评论：\n"${l.commentContent}"\n${l.commentImage?`评论图片：${"description"===l.commentImage.type?l.commentImage.content:"包含图片"}\n`:""}- 发布时间：${l.commentTime}\n${l.replyTo?`- 回复对象：${l.replyTo}\n`:""}\n**生成要求**：\n- 基于该账户发表的评论，推断其互动风格和表达习惯\n- 生成的主页推文应该体现类似的表达方式和兴趣点\n- 主页推文可以与评论主题相关，但要展现更完整的个人特色`;else if("search"===l.source)b+=`来源：搜索结果\n搜索关键词："${l.searchQuery}"\n该账户在搜索结果中的信息：\n- 昵称：${e.name}\n- 句柄：${e.handle}\n${l.userBio?`- 简介：${l.userBio}\n`:""}- 认证状态：${l.verified?"已认证":"未认证"}\n**生成要求**：\n- 基于搜索关键词和账户基本信息，推断账户特点和内容方向\n- 生成的推文应该与搜索关键词"${l.searchQuery}"有一定相关性\n- 确保账户特点与简介、昵称、句柄相符`;else if("dm"===l.source||"dm_quote_profile"===l.source){const n="dm"===l.source?"私信详情页":"私信中的账户名片";if(b+=`来源：${n}\n该账户的已知信息：\n- 昵称：${e.name}\n- 句柄：${e.handle}\n${e.bio?`- 简介：${e.bio}\n`:""}${e.followersCount?`- 关注者：${e.followersCount}\n`:""}- 认证状态：${e.verified?"已认证":"未认证"}\n${l.messagePreview?`- 私信预览："${l.messagePreview}"\n`:""}`,"dm_quote_profile"===l.source&&l.conversationContext)try{const{currentConversationHandle:n,messageId:t}=l.conversationContext;console.log("📝 [名片生成] 尝试读取对话记录:",n,"| messageId:",t);const o=`messageConversation_${vt||"main"}_${t}`;console.log("📝 [名片生成] 查询对话ID:",o);const a=await m.xAccountProfiles.get(o);if(a&&a.data&&a.data.messages&&a.data.messages.length>0){console.log(`✅ [名片生成] 找到对话记录，共 ${a.data.messages.length} 条消息`),b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【私信对话上下文】（该账户在私信中的对话记录）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const n=a.data.messages.slice(-30);let t=0;for(const o of n){const n=o.isOwn?"用户":e.name;let a="";if("text"===o.type)a=o.content;else if("image"===o.type)a=o.isOwn?"[用户发送了图片]":`[图片: ${o.imageDescription||"图片"}]`;else if("voice"===o.type)a=`[语音: ${o.voiceText||"语音消息"}]`;else if("sticker"===o.type)a="[表情包]";else if("transfer"===o.type){const n=o.amount?`$${o.amount}`:"";a=`[转账${n}${o.note?` (${o.note})`:""}]`}else if("link"===o.type)a=`[分享链接: ${o.title||"链接"}]`;else if("quoteTweet"===o.type)a=`[转发推文: ${o.tweet?.content||""}]`;else if("quoteProfile"===o.type){const n=o.profile||{};a=`[分享主页: ${n.name||""}${n.bio?` - ${n.bio}`:""}${n.followers?` (${n.followers}关注者)`:""}]`}else a=`[${o.type}消息]`;if(a){const e=a.length>150?`${a.substring(0,150)}...`:a;b+=`${n}: ${e}\n`,t++}if(t>=30)break}b+=`\n⚠️ 重要说明：\n- 以上是该账户与用户在私信中的真实对话记录（共${t}条）\n- 生成账户主页时，必须基于这些对话内容来推断账户的性格、兴趣和特点\n- 生成的推文内容、风格、话题应该与对话中展现的形象高度一致\n- 如果对话中提到了具体的事件、话题或兴趣，推文应该体现这些内容\n- 如果对话中有转发的账户名片，说明该账户与这些名片账户有关联\n- 确保账户主页与私信中的形象完全匹配，不要出现矛盾\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const o=b.substring(b.lastIndexOf("【私信对话上下文】"));f=d.logTokenUsage("账户主页生成器","私信对话上下文",o,f)}else console.log("ℹ️ [名片生成] 未找到对话记录或对话为空"),a?console.log("📋 [名片生成] 对话数据结构:",{hasData:!!a.data,hasMessages:!!a.data?.messages,messageCount:a.data?.messages?.length||0}):console.log("📋 [名片生成] 数据库中未找到该对话ID的记录")}catch(n){console.error("❌ [名片生成] 读取对话记录失败:",n)}b+=`\n**生成要求**：\n- ${e.bio?"已有简介，必须严格使用，不可修改":"需要生成符合该账户特点的简介"}\n- ${e.followersCount?`已有关注者数量(${e.followersCount})，必须使用，不可修改`:"需要生成合理的关注者数量（100-5000之间）"}\n- 生成的推文内容要与已有信息（简介、私信内容等）保持一致\n- ${"dm_quote_profile"===l.source&&l.conversationContext?"特别注意：生成的账户主页必须与上述私信对话中展现的性格、兴趣、话题完全一致":"确保账户形象真实可信，符合其在私信中展现的特点"}`}else if("live"===l.source){const n=l.liveContext||{};b+=`来源：直播间\n该账户正在进行直播：\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【直播信息】\n- 直播主题：${n.liveTitle||"直播中"}\n${n.liveSubtitle?`- 副标题：${n.liveSubtitle}\n`:""}- 在线观众：${n.onlineViewers||0}人\n- 直播时长：${Math.floor((n.liveDuration||0)/60)}分钟\n${n.liveTags&&n.liveTags.length>0?`- 标签：${n.liveTags.join(", ")}\n`:""}${n.liveDescription?`- 直播描述：${n.liveDescription}\n`:""}${n.liveNotice?`- 直播公告：${n.liveNotice}\n`:""}\n【主播发言记录】（最近${(n.streamerSpeeches||[]).length}条）\n`,n.streamerSpeeches&&n.streamerSpeeches.length>0?n.streamerSpeeches.forEach((n,e)=>{b+=`${e+1}. "${n.content}"\n`}):b+="（暂无主播发言记录）\n",b+=`\n【直播间弹幕】（最近${(n.danmakuMessages||[]).length}条）\n`,n.danmakuMessages&&n.danmakuMessages.length>0?n.danmakuMessages.forEach((n,e)=>{b+=`${e+1}. ${n.userId}: "${n.content}"\n`}):b+="（暂无弹幕记录）\n",b+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**生成要求**：\n- 该账户正在直播中，需要在头像旁显示"直播中"光晕效果\n- 基于直播间的主播发言、弹幕互动、直播主题，推断账户的内容风格和话题偏好\n- 生成的主页推文应该与直播内容主题相关，体现主播的发言风格和兴趣点\n- 可以生成一些与直播话题相关的推文（如预告直播、分享直播感想等）\n- 推文内容要与主播在直播中展现的性格、语言风格保持一致\n- 如果直播有特定标签，推文可以涉及这些话题领域\n- 评论区可能有观众提及他们在直播间的互动或话题\n- 保持账户形象与直播间主播形象高度一致'}b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const n=b.substring(b.lastIndexOf("【账户来源上下文】"));f=d.logTokenUsage("账户主页生成器","账户来源上下文",n,f)}"character"===e.accountType?b+="\n【角色账户特殊要求】：\n- **严格遵守**：所有已提供的X资料信息必须完全一致，不得修改\n- 推文内容要符合角色人设和性格特点\n- 评论互动要体现角色的社交风格\n- 如有NPC关系，可在推文/评论中自然体现":"npc"===e.accountType?b+="\n【NPC账户特殊要求】：\n- **严格遵守**：使用NPC的姓名、句柄、头像、人设\n- 推文内容符合NPC的发帖习惯和主页内容设置\n- 评论互动符合NPC的性格特点":"relationshipNpc"===e.accountType?b+=`\n【角色关系NPC账户特殊要求】：\n- **严格遵守**：使用NPC的姓名（${e.name}）和句柄（${e.handle}）\n- 该NPC与角色 ${e.ownerCharacterName} (${e.ownerXProfile.xName} - ${e.ownerXProfile.xHandle}) 的关系：${e.relationshipType}\n${e.relationshipDescription?`- 关系描述：${e.relationshipDescription}`:""}\n- 推文内容应体现这种关系特点，可能会提及或艾特 ${e.ownerXProfile.xHandle}\n- 生成的推文和互动要符合该NPC与角色的关系设定\n- 评论区可能出现 ${e.ownerXProfile.xName} 的互动，要体现两者的关系\n- 如未提供bio、关注者数等信息，由AI根据NPC特点和关系合理补充`:b+="\n【未知账户生成要求】：\n- 根据提供的昵称、句柄、简介推断账户特点\n- 生成合理的推文内容和互动风格\n- 保持账户身份的一致性";const $=b.substring(b.indexOf("【目标账户信息】"));if(f=d.logTokenUsage("账户主页生成器","账户信息与要求",$,f),"relationshipNpc"===e.accountType&&e.ownerCharacterId){const n=t(),o=(await n.chats.toArray()).find(n=>n.id===e.ownerCharacterId),a=e.ownerXProfile;if(o&&a){let n=`\n【所属角色详细资料】（该NPC的关系对象）：\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n- 角色本名：${o.name}\n- 角色人设：${o.settings.aiPersona||"无特定人设"}\n- X平台身份（必须严格使用）：\n* X用户名：${a.xName}\n* X句柄：${a.xHandle}\n* X头像：${a.xAvatar}\n* 认证状态：${a.xVerified?"是":"否"}`;if(a.xBio&&(n+=`\n * X简介：${a.xBio}`),a.publicIdentity&&(n+=`\n * 公众身份：${a.publicIdentity}`),n+=`\n- 该NPC（${e.name}）与角色（${a.xName}）的关系：${e.relationshipType}\n${e.relationshipDescription?`- 关系详情：${e.relationshipDescription}`:""}\n【关系互动要求】：\n- 推文内容应自然体现与 ${a.xName} (${a.xHandle}) 的关系\n- ${a.xName} 可能在评论区出现，互动要符合双方关系设定\n- 必须严格使用 ${a.xName} 的X平台身份信息\n- 可以提及或艾特 ${a.xHandle}，但不要过度频繁\n- 保持该NPC独立的个性，不要完全依附于角色\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,b+=n,f=d.logTokenUsage("账户主页生成器","关系NPC-所属角色资料",n,f),a.relationships&&a.relationships.length>0){let n="\n【所属角色的其他NPC关系】（可能在互动中出现）：\n";a.relationships.forEach(t=>{t.npcHandle!==e.handle&&(n+=`\n- ${t.npcName} (${t.npcHandle}): ${t.relationshipType}`,t.description&&(n+=` - ${t.description}`))}),n+=`\n注意：这些NPC也可能出现在评论区，要体现各自与 ${a.xName} 的关系特点。\n`,b+=n,f=d.logTokenUsage("账户主页生成器","关系NPC-其他NPC关系",n,f)}const t=await s.buildCharacterRelationships([e.ownerCharacterId],vt||"main");t&&(b+=`\n【所属角色的角色关系网络】（可能在互动中出现）：\n${t}\n`,f=d.logTokenUsage("账户主页生成器","关系NPC-角色关系网络",t,f))}}if("character"===e.accountType&&e.characterId){const n=await s.buildCharacterRelationships([e.characterId],vt||"main");if(n){b+=n,f=d.logTokenUsage("账户主页生成器","角色关系网络",n,f);try{const n=t(),o=`xCharacterRelationships_${vt||"main"}`,a=await m.xCharacterRelationships.get(o);if(a&&a.data){const t=a.data.links||[],o=new Set;if(t.forEach(n=>{n.charA===e.characterId?o.add(n.charB):n.charB===e.characterId&&o.add(n.charA)}),o.size>0){const e=await n.chats.toArray(),t=await m.xCharacterProfiles.toArray();let a="\n【关系角色详细资料】（可能出现在评论或互动中的角色）：\n";for(const n of o){const o=e.find(e=>e.id===n),i=t.find(e=>e.characterId===n);o&&i&&(a+=`\n- 角色名：${o.name}\n人设：${o.settings.aiPersona||"无特定人设"}\nX平台身份（必须严格使用）：\n- X用户名：${i.xName}\n- X句柄：${i.xHandle}\n- X头像：${i.xAvatar}\n- 认证状态：${i.xVerified?"是":"否"}`,i.xBio&&(a+=`\n - X简介：${i.xBio}`),i.publicIdentity&&(a+=`\n - 公众身份：${i.publicIdentity}`),a+="\n")}a+="\n【关系角色互动要求】：\n- 关系角色可能在推文评论或回复中出现，体现彼此的关系\n- 必须严格使用上述X平台身份信息（xName、xHandle、xAvatar等）\n- 互动内容要符合角色人设和关系设定\n- 保持各角色身份的一致性和准确性\n",b+=a,f=d.logTokenUsage("账户主页生成器","关系角色详细资料",a,f)}}}catch(n){console.error("获取关系角色详细资料失败:",n)}}}if(a&&(i.length>0||r.length>0)){b+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【已有内容上下文】- 绝对禁止重复以下内容\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 以下是该账户的所有已有推文和回复，生成新内容时必须**完全避开**这些话题和表达：\n**已有推文（共${i.length}条）**：\n`,i.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time}\n- 互动：${n.stats.comments||0}评论，${n.stats.likes||0}喜欢\n${n.media&&n.media.length>0?` - 媒体：${n.media[0].description}\n`:""}`}),r.length>0&&(b+=`\n**已有回复（共${r.length}条）**：\n`,r.forEach((n,e)=>{b+=`\n${e+1}. 回复了${"tweet"===n.type?"推文":"评论"}: "${n.accountReply.content}"\n- 时间：${n.accountReply.time}`})),b+=`\n🚫🚫🚫 【重复检测清单】🚫🚫🚫\n- 上述${i.length}条推文的内容、话题、观点都已被使用\n- 新推文必须是**全新的话题**或**不同角度的观点**\n- 不要生成任何与上述内容相似度超过30%的推文\n- 时间设置必须比最新推文（${i[0]?.time||"未知"}）更新\n- 保持风格一致，但内容必须创新\n**新内容生成方向建议**：\n- 探索完全不同的生活话题或兴趣领域\n- 展现不同时间段的新想法或新发现\n- 基于人设生成全新角度的内容\n- 避免重复已有推文的关键词和主题\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const n=b.substring(b.indexOf("【已有内容上下文】"));f=d.logTokenUsage("账户主页生成器","已有内容上下文",n,f)}const C=b.length;if(b+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 当前生成账户\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n正在生成：${e.name} (${e.handle}) 的账户主页\n账户类型：${"character"===e.accountType?"角色账户":"npc"===e.accountType?"NPC账户":"relationshipNpc"===e.accountType?`角色关系NPC账户（与 ${e.ownerCharacterName} 的关系NPC）`:"未知账户"}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,"character"===e.accountType&&e.characterId){if(h.knownIdentityCharacters.includes(e.characterId)){const n=b.length,t={verified:"蓝色勾标认证",couple:"情侣认证",married:"已婚认证",vip:"VIP认证"}[h.verificationType]||"无认证",o=e.xProfileData?.userPersona&&e.xProfileData.userPersona.trim();b+=`\n【用户身份信息】该角色认识用户\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n用户X平台资料（仅供参考，严禁假扮）：\n- 用户名：${h.name}\n- 用户句柄：${h.handle}\n- 认证状态：${t}\n${h.publicIdentity?`- 公众身份：${h.publicIdentity}`:""}\n${h.bio?`- 个人简介：${h.bio}`:""}\n`;try{const n=`userTweets_${vt||"main"}`,e=await m.xUserTweets.get(n),t=e?.tweets?.slice(0,5)||[];t.length>0&&(b+=`\n用户近期推文（${t.length}条）：\n`,t.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n${n.image?` - 媒体：${"description"===n.image.type?n.image.content.substring(0,50)+"...":"包含图片"}\n`:""}`}))}catch(n){console.warn("读取用户推文失败:",n)}b+=`\n该角色了解的用户信息：\n${o?e.xProfileData.userPersona:"⚠️ 未设置用户人设 - 该角色只知道用户的基本X平台信息（上述资料），不了解用户的私人信息、性格特点或两者之间的具体关系。"}\n🚫 【关键约束】\n${o?`- 该角色可以在推文中提及或艾特用户 ${h.handle}，也可以讨论用户的推文\n- 但评论区不能出现用户 ${h.name} (${h.handle}) 的发言\n- 所有评论必须是虚构的普通用户，不得使用用户的名称或句柄`:`- 该角色可以在推文中提及用户 ${h.handle}（基于基本认识），也可以讨论用户的推文\n- 但不要捏造或推断两者的具体关系（如情侣、伴侣、家人等）\n- 评论区绝对禁止出现用户 ${h.name} (${h.handle}) 的发言\n- 所有评论必须是虚构的普通用户，不得使用用户的名称或句柄\n- ⚠️ 重要：未设置用户人设意味着不能假设两者有特殊关系`}\n- ${e.name} 和 ${h.name} 是两个完全独立的不同个体\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const a=b.substring(n);f=d.logTokenUsage("账户主页生成器","角色认识用户-资料与推文",a,f)}else b+=`\n【用户身份信息】该角色不认识用户\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n用户X平台公开资料（仅供参考，禁止假扮）：\n- 用户名：${h.name}\n- 用户句柄：${h.handle}\n${h.publicIdentity?`- 公众身份：${h.publicIdentity}`:""}\n身份关系：\n- ${e.name} 不知道用户的真实身份\n- ${e.name} 和 ${h.name} 是完全独立的不同个体\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}else{const n=[e.name||"",e.handle||"",e.bio||"",e.publicIdentity||"",e.personality||"",e.postingHabits||"",e.homepage||""].join(" "),o=n.includes(h.name)||n.includes(h.handle)||n.includes(h.handle.replace("@","")),a=t(),i=await a.chats.toArray(),r=await m.xCharacterProfiles.toArray(),s=[];for(const e of r)if(n.includes(e.xName)||n.includes(e.xHandle)||n.includes(e.xHandle.replace("@",""))){const n=i.find(n=>n.id===e.characterId);n&&s.push({character:n,xProfile:e})}if(o||s.length>0){const n=b.length;if(b+="\n【提及的身份信息】该账户资料提及以下身份\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",o){const n={verified:"蓝色勾标认证",couple:"情侣认证",married:"已婚认证",vip:"VIP认证"}[h.verificationType]||"无认证";b+=`\n用户X平台公开资料（仅供参考，禁止假扮）：\n- 用户名：${h.name}\n- 用户句柄：${h.handle}\n- 认证状态：${n}\n${h.publicIdentity?`- 公众身份：${h.publicIdentity}`:""}\n${h.bio?`- 个人简介：${h.bio}`:""}\n`;try{const n=`userTweets_${vt||"main"}`,e=await m.xUserTweets.get(n),t=e?.tweets?.slice(0,5)||[];t.length>0&&(b+=`\n用户近期推文（${t.length}条）：\n`,t.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n${n.image?` - 媒体：${"description"===n.image.type?n.image.content.substring(0,50)+"...":"包含图片"}\n`:""}`}))}catch(n){console.warn("读取用户推文失败:",n)}}if(s.length>0){b+="\n提及的角色X平台资料（仅供参考，禁止假扮）：\n";for(const{character:n,xProfile:e}of s){b+=`\n- ${n.name} - X身份：${e.xName} (${e.xHandle})\n${e.publicIdentity?`公众身份：${e.publicIdentity}`:""}\n${e.xBio?`简介：${e.xBio}`:""}\n`;try{const n=e.xHandle.replace("@",""),t=await m.xAccountProfiles.get(n),o=t?.tweets?.slice(0,5)||[];o.length>0&&(b+=`\n${e.xName} 的近期推文（${o.length}条）：\n`,o.forEach((n,e)=>{b+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发\n${n.media&&n.media.length>0?` - 媒体：${n.media[0].description.substring(0,50)+"..."}\n`:""}`}))}catch(n){console.warn(`读取角色 ${e.xName} 的推文失败:`,n)}}}b+=`\n互动说明：\n- ${e.name} 可以讨论或评论上述身份和他们的推文内容\n- 可以基于上述推文内容生成相关的互动或回应\n- 但 ${e.name} 不是上述任何身份，是独立的个体\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const t=b.substring(n);f=d.logTokenUsage("账户主页生成器","提及身份信息与推文",t,f)}else b+=`\n【用户身份信息】无关联\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n用户基本标识（仅供参考，禁止假扮）：\n- 用户名：${h.name}\n- 用户句柄：${h.handle}\n身份关系：\n- ${e.name} 与用户无任何关联\n- ${e.name} 和 ${h.name} 是完全独立的不同个体\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}if(e.xMessageHistory&&e.xMessageHistory.length>0){const n=b.length;console.log(`📝 [账户主页生成器] 开始处理私信记忆，总数: ${e.xMessageHistory.length} 条`),b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【X平台私信记忆】（该账户与用户的私信对话记录）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const t=e.xMessageHistory.slice(-50);let o=0;for(const n of t){const t=n.isOwn?"用户":e.name;let a="";if("text"===n.type)a=n.content;else if("image"===n.type)a=n.isOwn?"[用户发送了图片]":`[图片: ${n.imageDescription||"图片"}]`;else if("voice"===n.type)a=`[语音: ${n.voiceText||"语音消息"}]`;else if("sticker"===n.type)a="[表情包]";else if("transfer"===n.type){const e=n.amount?`$${n.amount}`:"";a=`[转账${e}${n.note?` (${n.note})`:""}]`}else a="link"===n.type?`[分享链接: ${n.title||"链接"}]`:"quoteTweet"===n.type?`[转发推文: ${n.tweet?.content||""}]`:"quoteProfile"===n.type?`[分享主页: ${n.profile?.name||""}]`:`[${n.type}消息]`;if(a){const n=a.length>80?`${a.substring(0,80)}...`:a;b+=`${t}: ${n}\n`,o++}if(o>=50)break}b+="\n⚠️ 重要说明：\n- 这些是在X平台私信功能中的真实对话记录\n- 无论账户类型（角色/NPC/陌生人），这些对话都是客观存在的\n- 生成账户主页时，可以基于这些互动记录展现关系和沟通风格\n- 不要在公开推文中直接提及私密的私信内容\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const a=b.substring(n),i=d.estimateTokens(a);console.log(`📊 [私信] ${"character"===e.accountType?"角色":"npc"===e.accountType?"NPC":"账户"} ${e.name}: ${o}条, ~${i} tokens`),f=d.logTokenUsage("账户主页生成器","X平台私信记忆",a,f)}else console.log("ℹ️ [账户主页生成器] 该账户无私信记忆数据");b+=`\n🚫🚫🚫 核心禁令（最高优先级）🚫🚫🚫\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【绝对禁止】假扮用户发布任何内容！\n身份识别：\n当前账户：${e.name} (${e.handle})\n用户账户：${h.name} (${h.handle})\n⚠️ 这是两个完全不同的独立个体！\n生成规则：\n✅ 可以生成：${e.name} (${e.handle}) 发布的推文/评论/回复\n✅ 可以生成：虚构的普通X平台用户（自创用户名和句柄）\n❌ 绝对禁止：以 ${h.name} (${h.handle}) 的身份发布任何内容\n❌ 绝对禁止：在 user.name 或 user.handle 字段中使用用户的名称或句柄\n⚠️ 重要提醒：\n所有推文的 user 字段必须是 ${e.name} (${e.handle})\n所有评论的 user 字段必须是虚构用户（不得是 ${h.name} 或 ${h.handle}）${"relationshipNpc"===e.accountType?`\n特殊说明：该NPC与 ${e.ownerXProfile.xName} (${e.ownerXProfile.xHandle}) 有关系，\n评论区可以出现 ${e.ownerXProfile.xName} 的互动，但必须严格使用其X平台身份信息`:""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const I=b.substring(C);f=d.logTokenUsage("账户主页生成器","身份约束与核心禁令",I,f),b+=a?'\n【JSON返回格式】：\n```json\n{"tweets": [推文数组], "accountReplies": [回复数组], "accountLikes": [喜欢数组]}\n```\n**注意**：推进模式下不需要返回accountInfo，只需返回新的推文、回复和喜欢':`\n【JSON返回格式】：\n\`\`\`json\n{"accountInfo": {...}, "tweets": [推文数组], "accountReplies": [回复数组], "accountLikes": [喜欢数组]}\n\`\`\`\naccountInfo对象结构：\n- name, handle, avatar, verified (已提供的必须完全一致)\n- verificationType: ${e.verified?`"${e.verificationType||"verified"}" (必须使用此值，不可修改)`:'"none" (不可修改)'}\n- cover: 可补充\n- bio: ${e.bio?`"${e.bio}" (已提供，必须使用此值，不可修改)`:"可补充"}\n- customTag1/2: {icon, text, color} (可选)\n- followingCount: 可补充\n- followersCount: ${e.followersCount?`"${e.followersCount}" (已提供，必须使用此值，不可修改)`:"可补充"}`,b+=`\ntweets数组（3-5条）：\n- user: {name, handle, avatar, verified, verificationType}\n- content: 推文文本\n- time: 时间描述\n- stats: {comments, retweets, likes, views} (纯数字)\n- media: [{type:"description", description:"图片描述，至少20字"}] (可选)\n- comments: [评论数组] (1-5条，必须生成，10-20%的评论可带图)\n- pinned: true/false (可选，第一条推文可置顶，显示"已置顶"标识)\n评论对象结构（重要）：\n- id: 评论唯一ID（可留空，系统自动生成）\n- user: {name, handle, avatar, verified}\n- content: 评论文本 (可与sticker同时存在)\n- timeOffset: 相对推文发布的分钟数（负数，如-5表示推文发布后5分钟的评论）\n- sticker: {url: "表情包链接", description: "表情包描述"} (可选，约10-15%评论使用)\n- image: {type: "description", content: "图片文字描述"} (可选，10-20%的评论带图，用于展示图片视频等媒体)\n- replies: [楼中楼回复数组] (可选，0-2条)\n楼中楼回复对象结构：\n- id: 回复唯一ID（可留空，系统自动生成）\n- user: {name, handle, avatar, verified}\n- content: 回复文本 (可与sticker同时存在)\n- timeOffset: 相对推文发布的分钟数（负数，如-10表示推文发布后10分钟的回复）\n- sticker: {url: "表情包链接", description: "表情包描述"} (可选，约10-15%回复使用)\n- image: {type: "description", content: "图片文字描述"} (可选，少量回复可带图)\n- replyTo: "@被回复者句柄" (必填)\naccountReplies数组（2-4条，账户的回复记录）：\n🚨 重要：每条回复都必须包含完整的三部分数据结构\n结构说明：\n- type: "tweet" | "comment" (回复推文或回复评论)\n- originalTweet: 原始推文对象（🚨必填！无论type是什么）\n{\nuser: {name, handle, avatar, verified},\ncontent: "推文内容",\ntime: "时间描述",\nstats: {comments: 数字, retweets: 数字, likes: 数字, views: 数字},\nmedia: [{type:"description", description:"图片描述"}] //可选\n}\n- originalComment: 原始评论对象（⚠️仅当type="comment"时必填）\n{\nuser: {name, handle, avatar, verified},\ncontent: "评论内容",\ntime: "时间描述"\n}\n- accountReply: 账户的回复对象（🚨必填！）\n{\nuser: {name, handle, avatar, verified}, //必须使用目标账户信息\ncontent: "回复内容",\ntime: "时间描述",\nstats: {comments: 数字, retweets: 数字, likes: 数字, views: 数字}\n}\n📋 示例1（回复推文）：\n{\n"type": "tweet",\n"originalTweet": {完整推文对象},\n"accountReply": {账户回复对象}\n}\n📋 示例2（回复评论）：\n{\n"type": "comment",\n"originalTweet": {完整推文对象}, ← 必须提供！评论所属的推文\n"originalComment": {完整评论对象}, ← 必须提供！被回复的评论\n"accountReply": {账户回复对象}\n}\naccountLikes数组（3-5条，账户喜欢的推文）：\n- user: {name, handle, avatar, verified, verificationType}\n- content: 推文文本\n- time: 时间描述\n- stats: {comments, retweets, likes, views} (纯数字)\n- media: [{type:"description", description:"图片描述"}] (可选，30-40%的推文可带媒体)\n- comments: [评论数组] (1-3条即可，比主页推文评论少一些)\n📋 喜欢推文示例：\n{\n"user": {\n"name": "某用户",\n"handle": "@someuser",\n"avatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n"verified": false\n},\n"content": "推文内容",\n"time": "2小时",\n"stats": {\n"comments": 45,\n"retweets": 128,\n"likes": 892,\n"views": 12400\n},\n"comments": [...]\n}\n⚠️ accountLikes特殊要求：\n- 喜欢的推文来自其他用户，不是账户自己的推文\n- 推文内容应该与账户的兴趣、身份、人设相关\n- 如果是角色账户，喜欢的内容要符合角色性格\n- 如果是关系NPC，可以喜欢所属角色的推文\n- 推文的互动数据应该合理（likes数应该较高，因为值得被喜欢）\n- 时间描述应该是相对时间（如"3小时"、"昨天"、"2天"等）\n【表情包使用规则】：\n- 表情包仅限使用世界书中提供的真实链接，严禁虚构或编造链接\n- 表情包与文字内容可以同时存在，用于增强表达效果\n- 使用频率控制在约10-15%的评论和回复中，保持自然\n- sticker对象包含url和description两个必需字段\n\n关键规则：\n1. accountInfo已提供字段必须与输入完全一致，不得修改\n2. 未提供字段由AI合理补充\n3. verified必须是布尔值(true/false)\n4. 如果该账户在角色X资料或NPC设置中标注为情侣关系，必须设置verificationType为"couple"\n5. ${a?"**禁止生成置顶推文**：所有推文的 pinned 必须为 false 或不设置":"建议将最重要或最新的一条推文设置为pinned: true（置顶）"}\n6. stats所有数字必须是纯数字，不带引号\n7. 每条推文必须包含1-5条评论，评论内容要与推文相关\n8. 评论可以包含楼中楼回复（replies数组），形成对话链\n9. 🚨 accountReplies必须生成2-4条，每条都必须包含完整数据：\n- type="tweet": 必须有 originalTweet + accountReply\n- type="comment": 必须有 originalTweet + originalComment + accountReply（三个都要！）\n10. accountReplies中的accountReply.user必须使用目标账户的信息\n11. 🚨 accountLikes必须生成3-5条，每条都是完整的推文对象：\n- 必须包含user、content、time、stats字段\n- user不能是目标账户本人（账户不能喜欢自己的推文）\n- 推文内容要与账户兴趣相关，体现账户的品味和关注点\n12. 除了角色和npc以外所有账号都使用统一头像：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n13. 默认背景图：https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg\n14. 🚫 **禁止假扮用户**：绝对不可在user字段使用 ${h.name} 或 ${h.handle}，这是用户身份，不可假扮\n15. ${"character"===e.accountType?`🚫 **严禁自创角色关系**：除非明确提供的关系信息，不要让目标角色(${e.name})在推文/评论中声称与其他角色有特殊关系（如情侣、家人等）。所有评论者必须是虚构用户，不要使用其他已知角色的身份。`:"relationshipNpc"===e.accountType?`✅ **关系NPC互动规则**：该NPC与 ${e.ownerXProfile.xName} (${e.ownerXProfile.xHandle}) 有 ${e.relationshipType} 关系。评论区可以出现 ${e.ownerXProfile.xName} 的互动，必须严格使用其X平台身份信息。其他评论者应为虚构用户。`:"评论者应为虚构的普通用户，保持身份的独立性"}\n16. sticker字段只能使用世界书中存在的真实链接，禁止虚构`;const S=b.substring(b.lastIndexOf("【JSON返回格式】"));f=d.logTokenUsage("账户主页生成器","JSON格式要求",S,f);const M=[{role:"user",content:`请生成账户 ${e.name} (${e.handle}) 的主页内容`}];d.logFinalPrompt("账户主页生成器",b,M[0].content);const T=await g.sendAIRequest({apiConfig:c,systemPrompt:b,messages:M,temperature:.7});let A=g.parseJSONResponse(T);if(A=await g.postProcessData(A,h),a){if(!A.tweets)throw new Error("AI返回的数据格式不正确：缺少推文数据");if(i&&i.length>0){const n=A.tweets||[],e=n.filter(n=>{const e=n.content.toLowerCase().trim();return!i.some(n=>{const t=n.content.toLowerCase().trim();if(t===e)return!0;const o=An(t,e);return o>.7&&(console.log(`🚫 [账户主页推进] 检测到重复推文（相似度${(100*o).toFixed(1)}%）:`,e.substring(0,50)),!0)})}),t=n.length-e.length;if(t>0&&(console.log(`🔍 [账户主页推进] 过滤了 ${t} 条重复推文`),A.tweets=e),0===e.length)throw new Error("AI生成的所有推文都与已有内容重复，请重新生成")}if(r&&r.length>0&&A.accountReplies){const n=A.accountReplies||[],e=n.filter(n=>{const e=n.accountReply?.content?.toLowerCase().trim()||"";if(!e)return!0;return!r.some(n=>{const t=n.accountReply?.content?.toLowerCase().trim()||"";if(!t)return!1;if(t===e)return!0;const o=An(t,e);return o>.7&&(console.log(`🚫 [账户主页推进] 检测到重复回复（相似度${(100*o).toFixed(1)}%）:`,e.substring(0,50)),!0)})}),t=n.length-e.length;t>0&&(console.log(`🔍 [账户主页推进] 过滤了 ${t} 条重复回复`),A.accountReplies=e)}}else{if(!A.accountInfo||!A.tweets)throw new Error("AI返回的数据格式不正确");if(A.accountInfo){const n=e.verificationType||"verified";A.accountInfo.verificationType=n,console.log(`🔒 [账户主页生成] 强制设置账户认证类型: ${n}`)}}const E=e.verificationType||"verified",z=e.handle;let B=0;A.tweets&&A.tweets.length>0&&A.tweets.forEach(n=>{n.user&&n.user.handle===z&&n.user.verificationType!==E&&(n.user.verificationType=E,B++),n.comments&&n.comments.length>0&&n.comments.forEach(n=>{n.user&&n.user.handle===z&&n.user.verificationType!==E&&(n.user.verificationType=E,B++),n.replies&&n.replies.length>0&&n.replies.forEach(n=>{n.user&&n.user.handle===z&&n.user.verificationType!==E&&(n.user.verificationType=E,B++)})})}),A.accountReplies&&A.accountReplies.length>0&&A.accountReplies.forEach(n=>{n.accountReply&&n.accountReply.user&&n.accountReply.user.handle===z&&n.accountReply.user.verificationType!==E&&(n.accountReply.user.verificationType=E,B++)}),B>0&&console.log(`🔒 [账户主页生成] 共修正了 ${B} 处认证类型错误`);const L=Date.now();A.tweets.forEach((n,e)=>{if(n.id||(n.id=`account_tweet_${L}_${e}`),!n.timestamp){const t=2*e+Math.floor(2*Math.random());n.timestamp=L-60*t*60*1e3}n.stats||(n.stats={comments:n.comments?.length||0,retweets:0,likes:0,views:0}),n.comments&&n.comments.length>0&&n.comments.forEach((t,o)=>{t.id||(t.id=`account_comment_${L}_${e}_${o}`),void 0!==t.timeOffset?(t.timestamp=n.timestamp+60*Math.abs(t.timeOffset)*1e3,delete t.timeOffset):t.timestamp||(t.timestamp=n.timestamp+60*(5+30*Math.random())*1e3),t.replies&&t.replies.length>0&&t.replies.forEach((a,i)=>{a.id||(a.id=`account_reply_${L}_${e}_${o}_${i}`),void 0!==a.timeOffset?(a.timestamp=n.timestamp+60*Math.abs(a.timeOffset)*1e3,delete a.timeOffset):a.timestamp||(a.timestamp=t.timestamp+60*(1+10*Math.random())*1e3)})})}),A.accountLikes&&A.accountLikes.length>0&&A.accountLikes.forEach((n,e)=>{if(n.id||(n.id=`account_liked_${L}_${e}`),!n.timestamp){const t=e+1+Math.floor(2*Math.random());n.timestamp=L-24*t*60*60*1e3}n.stats||(n.stats={comments:n.comments?.length||0,retweets:0,likes:0,views:0}),n.comments&&n.comments.length>0&&n.comments.forEach((t,o)=>{t.id||(t.id=`liked_comment_${L}_${e}_${o}`),void 0!==t.timeOffset?(t.timestamp=n.timestamp+60*Math.abs(t.timeOffset)*1e3,delete t.timeOffset):t.timestamp||(t.timestamp=n.timestamp+60*(5+30*Math.random())*1e3)})});return Rl({title:"X",message:"en"===Hn?"Account profile has been generated!":"账户主页已生成！",avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),A}catch(n){return console.error("生成账户主页内容失败:",n),mn(`生成失败: ${n.message}`,"error"),null}}function Bn(n){console.log("渲染账户主页:",n);const e=n.accountInfo||n;document.getElementById("account-profile-nav-name").textContent=e.name||n.name;const t=n.tweets&&n.tweets.length||0;document.getElementById("account-profile-nav-count").textContent=`${m.formatNumber(t)} ${jn("accountPostsCount")}`;document.getElementById("account-cover-image").style.backgroundImage=`url('${e.cover||n.cover||"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg"}')`;document.getElementById("account-avatar-image").src=e.avatar||n.avatar,n.sourceContext&&n.sourceContext.isLiveStreaming&&console.log("🎤 [账户主页] 检测到正在直播"),document.getElementById("account-display-name").textContent=e.name||n.name;const o=document.getElementById("account-verified-badge"),a=e.verificationType||n.verificationType||"verified";e.verified||n.verified?(o.innerHTML="couple"===a?'\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n ':'\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>\n </svg>\n ',o.style.display="inline-flex",o.style.alignItems="center"):o.style.display="none";const i=e.handle||n.handle;document.getElementById("account-handle-text").textContent=i.startsWith("@")?i:`@${i}`;const r=document.getElementById("account-bio-text");e.bio||n.bio?(r.textContent=e.bio||n.bio,r.style.display="block"):r.style.display="none";const s=document.getElementById("account-tags-container");s.innerHTML="";const l=e.customTag1||n.customTag1,c=e.customTag2||n.customTag2;if(l&&l.text){const n=document.createElement("div");n.style.cssText=`display: flex; align-items: center; gap: 4px; color: ${l.color||"#71767b"}; font-size: 15px;`,n.innerHTML=`<span>${l.icon||""}</span><span>${l.text}</span>`,s.appendChild(n)}if(c&&c.text){const n=document.createElement("div");n.style.cssText=`display: flex; align-items: center; gap: 4px; color: ${c.color||"#71767b"}; font-size: 15px;`,n.innerHTML=`<span>${c.icon||""}</span><span>${c.text}</span>`,s.appendChild(n)}document.getElementById("account-following-count").textContent=e.followingCount||n.followingCount||"0",document.getElementById("account-followers-count").textContent=e.followersCount||n.followersCount||"0";const d=document.getElementById("account-follow-btn");(d&&d.textContent.includes("关注")||d&&d.textContent.includes("Following"))&&(d.textContent=jn("accountFollow"));const p=document.getElementById("account-tweets-container");p.innerHTML="",n.tweets&&n.tweets.length>0?n.tweets.forEach(n=>{const t=Ln(n,e);p.appendChild(t)}):p.innerHTML='<div style="padding: 40px; text-align: center; color: #71767b;">该账户还没有发布推文</div>',document.querySelectorAll(".x-page").forEach(n=>n.style.display="none"),document.getElementById("account-profile-page").style.display="flex",mn(`已加载 ${e.name||n.name} 的主页`,"success")}function Ln(n,e){const t=document.createElement("div");t.style.cssText="border-bottom: 1px solid var(--x-border-color);";const o=n.user||e,a=n.pinned||!1;let i="";return o.verified&&(i="couple"===o.verificationType?'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>':'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'),t.innerHTML=`\n ${a?`\n <div style="padding: 12px 16px 0; display: flex; align-items: center; gap: 12px;">\n <div style="width: 40px; display: flex; justify-content: flex-end;">\n <svg viewBox="0 0 32 32" style="width: 16px; height: 16px; fill: #71767b;">\n <path d="M20.743 14.815l-0.933-12.065h5.191c0.414 0 0.75-0.336 0.75-0.75s-0.336-0.75-0.75-0.75v0h-18c-0.414 0-0.75 0.336-0.75 0.75s0.336 0.75 0.75 0.75v0h5.432l-1.275 12.103c-3.213 0.959-5.574 3.738-5.904 7.113l-0.003 0.034c0 0.414 0.336 0.75 0.75 0.75h9.25v7.25c0 0.414 0.336 0.75 0.75 0.75s0.75-0.336 0.75-0.75v0-7.25h9.25c0.414-0 0.75-0.336 0.75-0.75v0c0-3.017-2.35-5.787-6.007-7.185zM12.104 16.081c0.096-0.035 0.179-0.085 0.249-0.148l-0.001 0.001 0.005-0.003c0.126-0.117 0.211-0.275 0.233-0.453l0-0.004 0.011-0.022 1.337-12.701h4.367l0.979 12.681c0.033 0.35 0.303 0.627 0.647 0.67l0.004 0c2.542 0.682 4.512 2.623 5.222 5.096l0.013 0.052h-18.341c0.729-2.54 2.714-4.49 5.222-5.157l0.052-0.012z"></path>\n </svg>\n </div>\n <span style="color: #71767b; font-size: 13px; font-weight: 700;">${jn("accountPinned")}</span>\n </div>\n `:""}\n <div style="padding: 12px 16px; display: flex; gap: 12px; position: relative;">\n <img src="${o.avatar}" alt="${o.name}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${o.name}</span>\n ${i}\n <span style="color: #71767b; font-size: 15px; margin-left: 4px;">${o.handle.startsWith("@")?o.handle:"@"+o.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${n.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${n.timestamp?Z(n.timestamp):n.time||"刚刚"}</span>\n </div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; margin-bottom: 12px; word-wrap: break-word;">${R(n.content)}</div>\n${n.media&&n.media.length>0?`\n<div style="background-color:var(--x-bg-secondary); border-radius: 16px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--x-border-color);">\n<div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px;">${R(n.media[0].description)}</div>\n</div>\n`:""}\n<div style="display: flex; justify-content: space-between; max-width: 425px; margin-top: 12px;">\n<div onclick="showAccountTweetDetail('${n.id}')" style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.comments||0)}</span>\n </div>\n <div onclick="handleQuoteRetweetFromAccountTweet('${n.id}')" style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.retweets||0)}</span>\n </div>\n <div class="tweet-action like" onclick="toggleLike('${n.id}', this)" data-liked="false" data-likes="${n.stats.likes||0}" style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='#f91880'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>\n <span class="like-count" style="font-size: 13px;">${m.formatNumber(n.stats.likes||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer; padding: 0;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.views||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 8px; color: #71767b; cursor: pointer; padding: 0;">\n <div onclick="toggleBookmark('${n.id}', this)" data-bookmarked="false" style="display: flex; align-items: center;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g></svg>\n </div>\n <div style="display: flex; align-items: center;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g></svg>\n </div>\n </div>\n </div>\n </div>\n\n   <div onclick="deleteAccountTweet('${n.id}', '${(e.handle||o.handle).replace("@","")}', event)" style="position: absolute; top: 12px; right: 16px; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'" onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #71767b;">\n <g><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></g>\n </svg>\n </div>\n </div>\n`,t}async function Pn(n){try{const t=e(),o=n.accountInfo.handle.replace("@",""),a={handle:o,name:n.accountInfo.name,accountInfo:n.accountInfo,tweets:n.tweets||[],accountReplies:n.accountReplies||[],accountLikes:n.accountLikes||[],updatedAt:(new Date).toISOString()};n.liveRoomData&&(a.liveRoomData=n.liveRoomData,console.log(`🎤 [保存账户] 保存直播间数据: "${n.liveRoomData.title||"无标题"}"`)),await t.xAccountProfiles.put(a),console.log("✅ 账户主页数据已保存:",o,"- 推文数:",a.tweets.length,"- 回复数:",a.accountReplies.length,"- 喜欢数:",a.accountLikes.length)}catch(n){console.error("保存账户主页数据失败:",n)}}async function Dn(n,t){try{const o=e(),a=n.replace("@","");console.log(`📝 [账户主页同步] 开始将推文添加到 ${a} 的账户主页`);let i=await o.xAccountProfiles.get(a);i||(console.log("📝 [账户主页同步] 账户主页不存在，创建新的主页数据"),i={handle:a,name:t.user.name,accountInfo:{name:t.user.name,handle:n,avatar:t.user.avatar,verified:t.user.verified||!1,verificationType:t.user.verificationType||"verified"},tweets:[],accountReplies:[],accountLikes:[],updatedAt:(new Date).toISOString()}),i.tweets||(i.tweets=[]);if(i.tweets.some(n=>n.id===t.id||n.timestamp===t.timestamp))return void console.log("⏭️ [账户主页同步] 推文已存在，跳过添加");const r=i.tweets.find(n=>n.pinned),s=i.tweets.filter(n=>!n.pinned);s.unshift(t),s.sort((n,e)=>(e.timestamp||0)-(n.timestamp||0)),i.tweets=r?[r,...s]:s,i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log(`✅ [账户主页同步] 推文已添加到 ${a} 的主页，当前推文总数: ${i.tweets.length}`),!Sn||Sn.accountInfo?.handle!==n&&Sn.handle!==n||(console.log("🔄 [账户主页同步] 检测到正在查看该账户主页，刷新显示"),Sn.tweets=i.tweets,Bn(Sn))}catch(n){console.error("❌ [账户主页同步] 添加推文到账户主页失败:",n)}}function Nn(){const n=document.querySelector('#account-profile-page [onclick="refreshAccountProfile()"]');if(!n)return;const e=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff";Mn?(n.innerHTML=`\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${e}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M3 12h4.5l1.5 -6l4 12l2 -9l1.5 3h4.5" />\n </svg>\n `,n.setAttribute("title","推进账户主页（生成新内容并追加）")):(n.innerHTML=`\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${e}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M9 4.55a8 8 0 0 1 6 14.9m0 -4.45v5h5" />\n <path d="M5.63 7.16l0 .01" />\n <path d="M4.06 11l0 .01" />\n <path d="M4.63 15.1l0 .01" />\n <path d="M7.16 18.37l0 .01" />\n <path d="M11 19.94l0 .01" />\n </svg>\n `,n.setAttribute("title","重新生成账户主页"))}n.openAccountProfile=async function(t,o,a,i={}){try{console.log(`🔍 正在打开账户主页: ${t} (${o})`),console.log("📍 来源信息:",i);const r=e(),l=o.replace("@",""),c=await r.xAccountProfiles.get(l);if(c){console.log("✅ 找到已保存的账户主页数据");const e=(await r.xCharacterProfiles.toArray()).find(n=>n.xHandle===o||n.xHandle===`@${l}`);if(e){console.log("🔄 [账户主页] 检测到角色账户，同步最新X资料");let t="verified";"couple"===n.userProfileData.verificationType&&n.userProfileData.coupleCharacterId===e.characterId&&(t="couple"),c.accountInfo={...c.accountInfo,name:e.xName,handle:e.xHandle,avatar:e.xAvatar,verified:e.xVerified,verificationType:e.xVerified?t:"none",cover:e.xCover||c.accountInfo.cover||"https://i.postimg.cc/tT8Rfsf1/mmexport1759603246385.jpg",bio:e.xBio||"",publicIdentity:e.publicIdentity||"",customTag1:e.customTag1||null,customTag2:e.customTag2||null,followingCount:e.followingCount||c.accountInfo.followingCount||"",followersCount:e.followersCount||c.accountInfo.followersCount||""};const o=n=>{n&&n.handle===e.xHandle&&(n.name=e.xName,n.avatar=e.xAvatar,n.verified=e.xVerified,n.verificationType=e.xVerified?t:"none")};c.tweets&&c.tweets.forEach(n=>{o(n.user),n.comments&&n.comments.forEach(n=>{o(n.user),n.replies&&n.replies.forEach(n=>o(n.user))})}),c.accountReplies&&c.accountReplies.forEach(n=>{n.accountReply&&o(n.accountReply.user)}),c.updatedAt=(new Date).toISOString(),await r.xAccountProfiles.put(c),console.log("✅ [账户主页] 已同步最新X资料信息")}return console.log("🔄 [账户主页] 重新读取X平台私信记忆"),c.xMessageHistory=await s._loadXMessageHistory(o),c.xMessageHistory&&c.xMessageHistory.length>0?console.log(`✅ [账户主页] 重新读取到 ${c.xMessageHistory.length} 条私信记忆`):console.log("ℹ️ [账户主页] 该账户暂无私信记忆"),console.log("📊 [账户主页] 加载数据统计:",{"推文数":c.tweets?.length||0,"回复数":c.accountReplies?.length||0,"喜欢数":c.accountLikes?.length||0,"私信数":c.xMessageHistory?.length||0}),i&&Object.keys(i).length>0&&(c.sourceContext=i,console.log("💎 [账户主页] 附加来源上下文到已保存的数据",i)),Sn=c,void Bn(c)}const d=await En(t,o,a,i.existingInfo);if(!d)return void mn("无法加载账户信息","error");if(Sn={...d,sourceContext:i},d.tweets&&d.tweets.length>0)return void Bn({...d,sourceContext:i});mn("正在生成账户主页...","info");const p=await zn(d,{sourceContext:i});p&&(Sn={...d,...p,sourceContext:i},console.log("📊 [账户主页] 新生成数据统计:",{"推文数":p.tweets?.length||0,"回复数":p.accountReplies?.length||0,"喜欢数":p.accountLikes?.length||0}),Bn(Sn),await Pn(Sn),mn("账户主页已生成并保存","success"))}catch(n){console.error("打开账户主页失败:",n),mn(`加载失败: ${n.message}`,"error")}},n.closeAccountProfile=function(){if(Mn&&(Mn=!1,Nn()),document.getElementById("account-profile-page").style.display="none",w&&v){console.log("📖 [返回] 从账户主页返回搜索结果页"),document.getElementById("trending-view").style.display="none",document.getElementById("search-results-view").style.display="flex";const n=document.getElementById("search-back-btn");n&&(n.style.display="flex");const e=document.querySelector(".refresh-trends-btn");e&&(e.style.display="none"),document.getElementById("x-search-page").style.display="flex"}else document.getElementById("x-home-page").style.display="flex"},n.showAccountTweetDetail=async function(n){if(!Sn||!Sn.tweets)return void mn("无法找到推文数据","error");const e=Sn.tweets.find(e=>e.id===n);e?(e._source="account",e._accountHandle=(Sn.accountInfo||Sn).handle,await io(e)):mn("未找到该推文","error")},n.showLikedTweetDetail=async function(n){if(!Sn||!Sn.accountLikes)return void mn("无法找到喜欢数据","error");const e=Sn.accountLikes.find(e=>e.id===n);e?(e._source="liked",e._accountHandle=(Sn.accountInfo||Sn).handle,await io(e)):mn("未找到该推文","error")},n.toggleAccountFollow=function(){const n=document.getElementById("account-follow-btn"),e=document.getElementById("account-notify-btn"),t=jn("accountFollow"),o=jn("accountFollowing"),a=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-bg-primary").trim(),i=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim(),r=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-border-color").trim();n.textContent===t?(n.textContent=o,n.style.backgroundColor=a||"#000",n.style.color=i||"#fff",n.style.border=`1px solid ${r||"#536471"}`,e.style.display="flex",mn("已关注该账户","success")):(n.textContent=t,n.style.backgroundColor=i||"#fff",n.style.color=a||"#000",n.style.border="none",e.style.display="none",mn("已取消关注","info"))},n.toggleAccountNotifications=function(){mn("通知设置已更新","success")},n.sendMessageToAccount=async function(){if(void 0!==n.xSocialAuth&&!n.xSocialAuth.hasAccess())return console.log("🔒 发送私信需要社交功能权限"),void n.xSocialAuth.requestAccess();if(!Sn)return void mn("无法获取账户信息","error");console.log("📨 从账户主页打开私信详情页");const t=Sn.accountInfo||Sn,o=t.handle.replace("@","");try{const n=e(),a=`xSettings_${vt||"main"}`,i=await n.xSettings.get(a),r=i?.boundCharacters||[];let s,l=null;for(const e of r){const t=await n.xCharacterProfiles.get(e);if(t&&t.xHandle.replace("@","")===o){l=e,console.log("✅ [统一ID] 找到匹配的已绑定角色:",e);break}}l?(s=`msg_${l}`,console.log("📝 [统一ID] 使用角色ID格式:",s)):(s=`msg_account_${o}`,console.log("📝 [统一ID] 使用账户ID格式:",s));let c=null;Sn&&Sn.sourceContext&&"live"===Sn.sourceContext.source&&Sn.sourceContext.liveUserData&&(c=Sn.sourceContext.liveUserData,console.log("💎 [私信] 检测到从直播间进入，携带用户直播间数据",c));const d={id:s,userName:t.name,userHandle:t.handle,userAvatar:t.avatar,user:{name:t.name,handle:t.handle,avatar:t.avatar,verified:t.verified||!1},lastMessage:"",timestamp:(new Date).toISOString(),unread:!1,_fromAccountProfile:!0,_liveUserData:c},p={name:t.name,handle:t.handle,avatar:t.avatar,bio:t.bio||"",followersCount:t.followersCount||"0",verified:t.verified||!1};Al=d,Zl=[],document.getElementById("x-message-detail-page").style.display="flex",Wl(d,p),console.log("✅ 已打开私信详情页（来自账户主页）")}catch(n){console.error("❌ [统一ID] 查找角色失败:",n);let e=null;Sn&&Sn.sourceContext&&"live"===Sn.sourceContext.source&&Sn.sourceContext.liveUserData&&(e=Sn.sourceContext.liveUserData,console.log("💎 [私信] 检测到从直播间进入，携带用户直播间数据",e));const a={id:`msg_account_${o}`,userName:t.name,userHandle:t.handle,userAvatar:t.avatar,user:{name:t.name,handle:t.handle,avatar:t.avatar,verified:t.verified||!1},lastMessage:"",timestamp:(new Date).toISOString(),unread:!1,_fromAccountProfile:!0,_liveUserData:e},i={name:t.name,handle:t.handle,avatar:t.avatar,bio:t.bio||"",followersCount:t.followersCount||"0",verified:t.verified||!1};Al=a,Zl=[],document.getElementById("x-message-detail-page").style.display="flex",Wl(a,i),console.log("✅ 已打开私信详情页（使用默认ID，来自账户主页）")}},n.switchAccountTab=function(n){document.querySelectorAll(".account-tab").forEach(e=>{e.onclick.toString().includes(n)?(e.style.fontWeight="700",e.style.color="#fff",e.style.borderBottom="4px solid var(--x-accent)"):(e.style.fontWeight="500",e.style.color="#71767b",e.style.borderBottom="4px solid transparent")});const e=document.getElementById("account-tweets-container");if(e.innerHTML="","posts"===n)if(Sn&&Sn.tweets){const n=Sn.accountInfo||Sn;Sn.tweets.forEach(t=>{const o=Ln(t,n);e.appendChild(o)})}else e.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">${jn("accountNoPosts")}</div>\n <div style="color: #71767b; font-size: 15px;">${jn("accountNoPostsDesc")}</div>\n </div>\n `;else if("replies"===n)if(Sn&&Sn.accountReplies&&Sn.accountReplies.length>0){const n=Sn.accountReplies.filter(n=>n?!!n.type||(console.warn("⚠️ [账户标签] 跳过无效回复: 缺少 type 字段",n),!1):(console.warn("⚠️ [账户标签] 跳过无效回复: null/undefined"),!1));n.length>0?n.forEach(n=>{const t=function(n){const e=document.createElement("div");e.style.cssText="border-bottom: 1px solid #2f3336;";const t=Sn.accountInfo||Sn;if(!n||!n.type)return console.warn("⚠️ [账户回复] 回复数据不完整:",n),e.innerHTML='<div style="padding: 16px; color: #71767b;">回复数据不完整</div>',e;let o="";if(t.verified&&(o="couple"===t.verificationType?'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>':'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'),"tweet"===n.type){if(!n.originalTweet||!n.originalTweet.user||!n.accountReply)return console.warn("⚠️ [账户回复] 推文回复数据不完整:",n),e.innerHTML='<div style="padding: 16px; color: #71767b;">推文回复数据不完整</div>',e;const a=n.originalTweet.user,i=n.accountReply;let r="";a.verified&&(r='<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'),e.innerHTML=`\n <div style="padding: 12px 16px;">\n\n <div style="display: flex; gap: 12px; margin-bottom: 8px;">\n <img src="${a.avatar}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${a.name}</span>\n ${r}\n <span style="color: #71767b; font-size: 15px;">${a.handle.startsWith("@")?a.handle:"@"+a.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${n.originalTweet.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${n.originalTweet.timestamp?Z(n.originalTweet.timestamp):n.originalTweet.time||"刚刚"}</span>\n </div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; word-wrap: break-word;">${R(n.originalTweet.content)}</div>\n${n.originalTweet.media&&n.originalTweet.media.length>0?`\n<div style="background-color:var(--x-bg-secondary); border-radius: 16px; padding: 12px; margin-top: 12px; border: 1px solid var(--x-border-color);">\n<div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px;">${R(n.originalTweet.media[0].description)}</div>\n</div>\n`:""}\n</div>\n</div>\n\n<div style="display: flex; gap: 12px;">\n\n<div style="width: 40px; display: flex; justify-content: center; position: relative;">\n<div style="width: 2px; height: 100%; background-color: #2f3336;"></div>\n</div>\n <div style="flex: 1;"></div>\n </div>\n\n <div style="display: flex; gap: 12px; margin-top: 8px;">\n <img src="${t.avatar}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${t.name}</span>\n ${o}\n <span style="color: #71767b; font-size: 15px;">${t.handle.startsWith("@")?t.handle:"@"+t.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${i.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${i.timestamp?Z(i.timestamp):i.time||"刚刚"}</span>\n </div>\n <div style="color: #71767b; font-size: 15px; margin-bottom: 4px;">${jn("accountReplyTo")} <span style="color: var(--x-accent);">${a.handle.startsWith("@")?a.handle:"@"+a.handle}</span></div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; margin-bottom: 12px; word-wrap: break-word;">${R(i.content)}</div>\n\n <div style="display: flex; justify-content: space-between; max-width: 425px;">\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(i.stats.comments||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(i.stats.retweets||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='#f91880'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(i.stats.likes||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(i.stats.views||0)}</span>\n </div>\n </div>\n </div>\n </div>\n </div>\n `}else if("comment"===n.type){if(!(n.originalTweet&&n.originalTweet.user&&n.originalComment&&n.originalComment.user&&n.accountReply))return console.warn("⚠️ [账户回复] 评论回复数据不完整:",n),e.innerHTML='<div style="padding: 16px; color: #71767b;">评论回复数据不完整</div>',e;const a=n.originalTweet.user,i=n.originalComment.user,r=n.accountReply;let s="";a.verified&&(s='<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>');let l="";i.verified&&(l='<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'),e.innerHTML=`\n <div style="padding: 12px 16px;">\n\n <div style="display: flex; gap: 12px; margin-bottom: 4px;">\n <img src="${a.avatar}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${a.name}</span>\n ${s}\n <span style="color: #71767b; font-size: 15px;">${a.handle.startsWith("@")?a.handle:"@"+a.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${n.originalTweet.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${n.originalTweet.timestamp?Z(n.originalTweet.timestamp):n.originalTweet.time||"刚刚"}</span>\n </div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; word-wrap: break-word;">${R(n.originalTweet.content)}</div>\n${n.originalTweet.media&&n.originalTweet.media.length>0?`\n<div style="background-color:var(--x-bg-secondary); border-radius: 16px; padding: 12px; margin-top: 12px; border: 1px solid var(--x-border-color);">\n<div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px;">${R(n.originalTweet.media[0].description)}</div>\n</div>\n`:""}\n</div>\n</div>\n\n<div style="display: flex; gap: 12px; margin-top: 8px;">\n<div style="width: 40px; display: flex; justify-content: center;">\n<div style="width: 2px; background-color: #2f3336; height: 100%;"></div>\n</div>\n <div style="flex: 1; padding-top: 4px;">\n <div style="display: flex; gap: 12px;">\n <img src="${i.avatar}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${i.name}</span>\n ${l}\n <span style="color: #71767b; font-size: 15px;">${i.handle.startsWith("@")?i.handle:"@"+i.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${n.originalComment.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${n.originalComment.timestamp?Z(n.originalComment.timestamp):n.originalComment.time||"刚刚"}</span>\n </div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; word-wrap: break-word;">${R(n.originalComment.content)}</div>\n </div>\n </div>\n </div>\n </div>\n\n <div style="display: flex; gap: 12px; margin-top: 8px;">\n <div style="width: 40px; display: flex; justify-content: center;">\n <div style="width: 2px; background-color: #2f3336; height: 100%;"></div>\n </div>\n <div style="flex: 1; padding-top: 4px;">\n <div style="display: flex; gap: 12px;">\n <img src="${t.avatar}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color: #fff; font-weight: 800; font-size: 15px;">${t.name}</span>\n ${o}\n <span style="color: #71767b; font-size: 15px;">${t.handle.startsWith("@")?t.handle:"@"+t.handle}</span>\n <span style="color: #71767b; font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${r.timestamp||Date.now()}" style="color: #71767b; font-size: 15px;">${r.timestamp?Z(r.timestamp):r.time||"刚刚"}</span>\n </div>\n <div style="color: #71767b; font-size: 15px; margin-bottom: 4px;">${jn("accountReplyTo")} <span style="color: var(--x-accent);">${i.handle.startsWith("@")?i.handle:"@"+i.handle}</span></div>\n <div style="color: #fff; font-size: 15px; line-height: 20px; margin-bottom: 12px; word-wrap: break-word;">${R(r.content)}</div>\n\n <div style="display: flex; justify-content: space-between; max-width: 425px;">\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(r.stats.comments||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(r.stats.retweets||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='#f91880'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(r.stats.likes||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #71767b; cursor: pointer;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='#71767b'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(r.stats.views||0)}</span>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n `}return e}(n);e.appendChild(t)}):e.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">${jn("accountNoReplies")}</div>\n <div style="color: #71767b; font-size: 15px;">${jn("accountNoRepliesDesc")}</div>\n </div>\n `}else e.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">${jn("accountNoReplies")}</div>\n <div style="color: #71767b; font-size: 15px;">${jn("accountNoRepliesDesc")}</div>\n </div>\n `;else if("likes"===n)if(console.log("🔍 [喜欢列表] 开始渲染喜欢列表"),console.log("🔍 [喜欢列表] currentViewingAccount:",Sn),console.log("🔍 [喜欢列表] accountLikes数量:",Sn?.accountLikes?.length||0),Sn&&Sn.accountLikes&&Sn.accountLikes.length>0){console.log("✅ [喜欢列表] 找到喜欢数据，开始渲染");const n=Sn.accountInfo||Sn;Sn.accountLikes.forEach((t,o)=>{console.log(`📋 [喜欢列表] 渲染第 ${o+1} 条喜欢:`,t.content?.substring(0,30));const a=function(n,e){const t=document.createElement("div");t.style.cssText="border-bottom: 1px solid var(--x-border-color);";const o=n.user;let a="";return o.verified&&(a="couple"===o.verificationType?'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>':'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>'),t.innerHTML=`\n\n <div style="padding: 12px 16px 0; display: flex; align-items: center; gap: 12px;">\n <div style="width: 40px; display: flex; justify-content: flex-end;">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-text-secondary);">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n </div>\n <span style="color:var(--x-text-secondary); font-size: 13px; font-weight: 700;">${e.name} ${jn("accountLiked")}</span>\n </div>\n\n <div style="padding: 12px 16px; display: flex; gap: 12px; position: relative;">\n <img src="${o.avatar}" alt="${o.name}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 2px; flex-wrap: wrap;">\n <span style="color:var(--x-text-primary); font-weight: 800; font-size: 15px;">${o.name}</span>\n ${a}\n <span style="color:var(--x-text-secondary); font-size: 15px; margin-left: 4px;">${o.handle.startsWith("@")?o.handle:"@"+o.handle}</span>\n <span style="color:var(--x-text-secondary); font-size: 15px; margin: 0 4px;">·</span>\n <span class="tweet-time" data-timestamp="${n.timestamp||Date.now()}" style="color:var(--x-text-secondary); font-size: 15px;">${n.timestamp?Z(n.timestamp):n.time||"刚刚"}</span>\n </div>\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px; margin-bottom: 12px; word-wrap: break-word;">${R(n.content)}</div>\n${n.media&&n.media.length>0?`\n<div style="background-color:var(--x-bg-secondary); border-radius: 16px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--x-border-color);">\n<div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px;">${R(n.media[0].description)}</div>\n</div>\n`:""}\n<div style="display: flex; justify-content: space-between; max-width: 425px; margin-top: 12px;">\n<div onclick="showLikedTweetDetail('${n.id||Date.now()}')" style="display: flex; align-items: center; gap: 4px; color:var(--x-text-secondary); cursor: pointer; padding: 0;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='var(--x-text-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.comments||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color:var(--x-text-secondary); cursor: pointer; padding: 0;" onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='var(--x-text-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.retweets||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: #f91880; cursor: pointer; padding: 0;" onmouseover="this.style.color='#f91880'" onmouseout="this.style.color='#f91880'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.likes||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color:var(--x-text-secondary); cursor: pointer; padding: 0;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='var(--x-text-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g></svg>\n <span style="font-size: 13px;">${m.formatNumber(n.stats.views||0)}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 8px; color:var(--x-text-secondary); cursor: pointer; padding: 0;">\n <div style="display: flex; align-items: center;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='var(--x-text-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g></svg>\n </div>\n <div style="display: flex; align-items: center;" onmouseover="this.style.color='var(--x-accent)'" onmouseout="this.style.color='var(--x-text-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;"><g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g></svg>\n </div>\n </div>\n </div>\n </div>\n\n <div style="position: absolute; top: 12px; right: 16px; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'" onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-secondary);">\n <g><path d="M3 12c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm7 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"></path></g>\n </svg>\n </div>\n </div>\n`,t.dataset.tweetData=JSON.stringify(n),t}(t,n);e.appendChild(a)}),console.log(`✅ [喜欢列表] 共渲染了 ${Sn.accountLikes.length} 条喜欢`)}else console.warn("⚠️ [喜欢列表] 无喜欢数据，显示空状态"),e.innerHTML=`\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color:var(--x-text-secondary); font-size: 31px; font-weight: 800; margin-bottom: 8px;">${jn("accountNoLikes")}</div>\n <div style="color:var(--x-text-secondary); font-size: 15px;">${jn("accountNoLikesDesc")}</div>\n </div>\n `},n.deleteAccountTweet=async function(n,t,o){o&&(o.preventDefault(),o.stopPropagation());if(confirm("确定要删除这条推文吗？删除后无法恢复。"))try{const o=e(),a=t.replace("@",""),i=await o.xAccountProfiles.get(a);if(!i||!i.tweets)return void mn("未找到账户数据","error");const r=i.tweets.length;if(i.tweets=i.tweets.filter(e=>e.id!==n),i.tweets.length===r)return void mn("未找到该推文","error");i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log(`✅ 已删除账户推文: ${n}，剩余推文数: ${i.tweets.length}`),mn("推文已删除","success"),!Sn||Sn.accountInfo?.handle!==`@${a}`&&Sn.accountInfo?.handle!==a&&Sn.handle!==`@${a}`&&Sn.handle!==a||(console.log("🔄 刷新当前查看的账户主页"),Sn.tweets=i.tweets,Bn(Sn))}catch(n){console.error("❌ 删除账户推文失败:",n),mn("删除失败","error")}},n.toggleProgressMode=function(){Mn=!Mn,Nn(),Mn?mn("已切换到推进模式 - 将生成新内容并追加","success"):mn("已切换到重新生成模式 - 将覆盖现有内容","info")},n.handleRefreshButtonMouseDown=function(){Tn=setTimeout(()=>{toggleProgressMode()},800)},n.handleRefreshButtonMouseUp=function(){Tn&&(clearTimeout(Tn),Tn=null)},n.refreshAccountProfile=async function(){if(Tn&&(clearTimeout(Tn),Tn=null),Sn)try{if(Mn)mn("正在推进账户主页...","info"),await async function(){try{const n=Sn.accountInfo||Sn,e=await En(n.name,n.handle,n.avatar);if(!e)return void mn("无法加载账户信息","error");const t=await zn(e,{isProgressMode:!0,existingTweets:Sn.tweets||[],existingReplies:Sn.accountReplies||[]});if(t){t.tweets&&t.tweets.forEach(n=>{n.pinned=!1});const e=Sn.tweets||[],o=e.find(n=>n.pinned),a=e.filter(n=>!n.pinned),i=t.tweets||[];let r;r=o?[o,...i,...a]:[...i,...a];const s=[...t.accountReplies||[],...Sn.accountReplies||[]],l=[...t.accountLikes||[],...Sn.accountLikes||[]];console.log("📊 [推进模式] 数据合并统计:",{"新推文":t.tweets?.length||0,"旧推文":(Sn.tweets||[]).filter(n=>!n.pinned).length,"合并后推文":r.length,"新回复":t.accountReplies?.length||0,"旧回复":(Sn.accountReplies||[]).length,"合并后回复":s.length,"新喜欢":t.accountLikes?.length||0,"旧喜欢":(Sn.accountLikes||[]).length,"合并后喜欢":l.length}),Sn={...Sn,tweets:r,accountReplies:s,accountLikes:l,accountInfo:Sn.accountInfo||n},Bn(Sn),await Pn(Sn),mn(`已推进：新增 ${t.tweets?.length||0} 条推文，${t.accountReplies?.length||0} 条回复，${t.accountLikes?.length||0} 条喜欢`,"success")}}catch(n){console.error("推进账户主页失败:",n),mn(`推进失败: ${n.message}`,"error")}}();else{mn("正在重新生成账户主页...","info");const n=Sn.accountInfo||Sn,e=await En(n.name,n.handle,n.avatar);if(!e)return void mn("无法加载账户信息","error");const t=await zn(e);t&&(Sn={...e,...t},console.log("📊 [账户主页] 重新生成数据统计:",{"推文数":t.tweets?.length||0,"回复数":t.accountReplies?.length||0,"喜欢数":t.accountLikes?.length||0}),Bn(Sn),await Pn(Sn),mn("账户主页已刷新","success"))}}catch(n){console.error("刷新账户主页失败:",n),mn(`刷新失败: ${n.message}`,"error")}else mn("未找到当前账户信息","error")};const Rn={zh:{navHome:"主页",navSearch:"搜索",navNotifications:"通知",navMessages:"消息",homeTitle:"主页",homeForYou:"为你推荐",homeFollowing:"正在关注",homeCompose:"有什么新鲜事?",homeNoTweets:"暂无推文",homeNoTweetsDesc:"开始关注一些人，或刷新查看推荐内容",searchTitle:"搜索",searchPlaceholder:"搜索",searchTrending:"热门话题",searchNoResults:"无搜索结果",searchRefresh:"刷新热搜",notificationsTitle:"通知",notificationsTabAll:"全部",notificationsTabMentions:"提及",notificationsEmpty:"暂无通知",notificationsEmptyDesc:"当有人点赞、评论或关注你时，你会在这里看到通知",notificationsRecommended:"推荐关注",notificationsLiked:"喜欢了你的帖子",notificationsFollowed:"关注了你",notificationsReplied:"回复了你",notificationsMentioned:"提及了你",notificationsRetweeted:"转推了你的帖子",messagesTitle:"私信",messagesEmpty:"暂无私信",messagesEmptyDesc:"发送私信与朋友保持联系",messageFollowers:"位关注者",messageInputPlaceholder:"开始写私信",profileTitle:"个人资料",profileEditProfile:"编辑个人资料",profileFollowing:"正在关注",profileFollowers:"关注者",profilePosts:"帖子",profilePostsCount:"帖子",profileLikes:"喜欢",profileHighlights:"亮点",profileArticles:"文章",profileMedia:"媒体",profileNoLikes:"还没有喜欢的推文",profileNoLikesDesc:"当你喜欢一条推文时，它会显示在这里。",profileNoHighlights:"还没有收藏",profileNoHighlightsDesc:"点击推文下方的书签按钮来收藏喜欢的内容",profileNoArticles:"还没有文章",profileNoArticlesDesc:"发布的文章会显示在这里。",profileNoMedia:"还没有媒体",profileNoMediaDesc:"包含照片和视频的推文会显示在这里。",profileAccountManager:"账号管理",tweetDetailTitle:"帖子",tweetDetailReply:"回复",tweetDetailReplyPlaceholder:"发布你的回复",tweetDetailRerollTooltip:"重新生成回复",tweetDetailRetweets:"转推",tweetDetailLikes:"喜欢",tweetDetailBookmarks:"书签",tweetDetailViews:"查看",commentsTitle:"发帖",commentsReply:"回复",commentsReplyPlaceholder:"发布你的回复",accountPostsCount:"个帖子",accountFollow:"关注",accountFollowing:"正在关注",accountFollowingLabel:"正在关注",accountFollowersLabel:"关注者",accountFollowsYou:"关注你",accountPostsTab:"帖子",accountRepliesTab:"回复",accountLikesTab:"喜欢",accountPinned:"已置顶",accountNoPosts:"还没有帖子",accountNoPostsDesc:"该账户的帖子会显示在这里。",accountNoReplies:"还没有回复",accountNoRepliesDesc:"该账户的回复会显示在这里。",accountNoLikes:"还没有喜欢",accountNoLikesDesc:"该账户喜欢的内容会显示在这里。",accountReplyTo:"回复",accountLiked:"已喜欢",settingsTitle:"设置",settingsPrompt:"提示词",settingsPromptPlaceholder:"输入系统提示词...",settingsWorldView:"世界观设定",settingsWorldViewPlaceholder:"描述角色所在的世界观、背景设定...",settingsCharacterBinding:"绑定角色",settingsCharacterBindingDesc:"开启后，绑定的角色可以在X上发布推文",settingsSelectCharacter:"选择要绑定的角色",settingsRelationship:"角色关系册",settingsRelationshipDesc:"开启后，可以为已绑定的角色建立关系网络，设置角色之间的双向关系",settingsRelationshipGraph:"角色关系图",settingsEditGraph:"编辑关系图",settingsNPCBinding:"绑定NPC",settingsNPCBindingDesc:"开启后，可以创建和管理自定义NPC，设置其人设、发帖习惯和绑定用户",settingsNPCList:"NPC列表",settingsCreateNPC:"+ 创建NPC",settingsSave:"保存设置",settingsSavePreset:"保存为预设",settingsImport:"导入数据",settingsExport:"导出数据",settingsPresetManagement:"预设管理",settingsWorldBooks:"世界书管理",settingsWorldBooksDesc:"世界书可以为AI提供额外的知识库，支持绑定到不同场景和角色",settingsWorldBooksButton:"打开世界书管理面板",settingsWorldEvents:"世界运转大事件",settingsWorldEventsDesc:"开启后，AI将根据世界观生成地点、天气和近期大事件，让推文生成更真实连贯",settingsWorldEventsLocation:"所在地点",settingsWorldEventsWeather:"天气状况",settingsWorldEventsLastGenerated:"上次生成",settingsWorldEventsLastProgressed:"上次推进",settingsWorldEventsRecentEvents:"近期大事件",settingsWorldEventsNoEvents:"暂无事件",settingsWorldEventsRefresh:"更新事件",settingsWorldEventsProgress:"推进事件",settingsWorldEventsCooldownTip:"推进功能需要间隔3小时使用",settingsAutoTweetDetection:"智能发推检测",settingsAutoTweetDetectionDesc:"开启后，每隔5分钟自动检测已绑定角色的聊天记忆，生成New Tweet通知",settingsAutoTweetDetectionNote:'仅对设置了"角色身份识别"和"专属用户人设"的角色生效',settingsDetectionRunning:"检测服务运行中",settingsNextDetectionTime:"下次检测时间",settingsAutoRefreshFeed:"智能刷新主页",settingsAutoRefreshFeedDesc:"开启后，每隔10分钟自动刷新主页推文",settingsRefreshRunning:"刷新服务运行中",settingsNextRefreshTime:"下次刷新时间",relationshipNoData:"暂无关系数据",relationshipNoDataHint:"点击上方按钮开始创建角色关系",relationshipCharacterCount:"角色数",relationshipLinkCount:"关系数",relationshipAddCharacter:"+ 添加角色",relationshipSave:"保存关系图",relationshipClose:"关闭",relationshipEmptyState:"暂无角色",relationshipEmptyStateHint:"点击上方按钮添加角色",liveTitle:"直播",liveAudioTab:"语音直播",liveVideoTab:"视频直播",liveOnlineCount:"人在线",liveJoinStream:"加入直播",liveNoAudioStreams:"暂无语音直播",liveNoVideoStreams:"暂无视频直播",liveWaitingContent:"等待精彩内容上线",liveRoomInfo:"直播间信息",liveRoomDescription:"直播简介",liveRoomAnnouncement:"直播公告",liveRoomWelcome:"欢迎来到直播间！",liveRoomSendMessage:"说点什么...",danmakuSent:"弹幕已发送",you:"我",toastThemeLight:"已切换到日间模式",toastThemeDark:"已切换到夜间模式",toastLanguageChinese:"已切换到中文",toastLanguageEnglish:"已切换到英文",btnSave:"保存",btnCancel:"取消",btnEdit:"编辑",btnDelete:"删除",btnConfirm:"确认"},en:{navHome:"Home",navSearch:"Explore",navNotifications:"Notifications",navMessages:"Messages",homeTitle:"Home",homeForYou:"For you",homeFollowing:"Following",homeCompose:"What's happening?",homeNoTweets:"No posts yet",homeNoTweetsDesc:"Follow people or refresh to see recommended content",searchTitle:"Explore",searchPlaceholder:"Search",searchTrending:"What's happening",searchNoResults:"No results found",searchRefresh:"Refresh trends",notificationsTitle:"Notifications",notificationsTabAll:"All",notificationsTabMentions:"Mentions",notificationsEmpty:"No notifications yet",notificationsEmptyDesc:"When someone likes, comments, or follows you, you'll see it here",notificationsRecommended:"Recommended",notificationsLiked:"liked your post",notificationsFollowed:"followed you",notificationsReplied:"replied to you",notificationsMentioned:"mentioned you",notificationsRetweeted:"retweeted your post",messagesTitle:"Messages",messagesEmpty:"No messages yet",messagesEmptyDesc:"Send a message to stay in touch with friends",messageFollowers:"followers",messageInputPlaceholder:"Start a message",profileTitle:"Profile",profileEditProfile:"Edit profile",profileFollowing:"Following",profileFollowers:"Followers",profilePosts:"Posts",profilePostsCount:"posts",profileLikes:"Likes",profileHighlights:"Highlights",profileArticles:"Articles",profileMedia:"Media",profileNoLikes:"No liked posts yet",profileNoLikesDesc:"When you like a post, it will show up here.",profileNoHighlights:"No bookmarks yet",profileNoHighlightsDesc:"Tap the bookmark button below posts to save your favorites",profileNoArticles:"No articles yet",profileNoArticlesDesc:"Published articles will show up here.",profileNoMedia:"No media yet",profileNoMediaDesc:"Posts with photos and videos will show up here.",profileAccountManager:"Account Manager",tweetDetailTitle:"Post",tweetDetailReply:"Reply",tweetDetailReplyPlaceholder:"Post your reply",tweetDetailRerollTooltip:"Regenerate replies",tweetDetailRetweets:"Reposts",tweetDetailLikes:"Likes",tweetDetailBookmarks:"Bookmarks",tweetDetailViews:"Views",commentsTitle:"Post",commentsReply:"Reply",commentsReplyPlaceholder:"Post your reply",accountPostsCount:"posts",accountFollow:"Follow",accountFollowing:"Following",accountFollowingLabel:"Following",accountFollowersLabel:"Followers",accountFollowsYou:"Follows you",accountPostsTab:"Posts",accountRepliesTab:"Replies",accountLikesTab:"Likes",accountPinned:"Pinned",accountNoPosts:"No posts yet",accountNoPostsDesc:"Posts from this account will show up here.",accountNoReplies:"No replies yet",accountNoRepliesDesc:"Replies from this account will show up here.",accountNoLikes:"No likes yet",accountNoLikesDesc:"Liked posts will show up here.",accountReplyTo:"Replying to",accountLiked:"liked",settingsTitle:"Settings",settingsPrompt:"System Prompt",settingsPromptPlaceholder:"Enter system prompt...",settingsWorldView:"World Setting",settingsWorldViewPlaceholder:"Describe the world setting and background...",settingsCharacterBinding:"Character Binding",settingsCharacterBindingDesc:"When enabled, bound characters can post on X",settingsSelectCharacter:"Select Character to Bind",settingsRelationship:"Character Relations",settingsRelationshipDesc:"When enabled, create relationship networks for bound characters",settingsRelationshipGraph:"Relationship Graph",settingsEditGraph:"Edit Graph",settingsNPCBinding:"NPC Binding",settingsNPCBindingDesc:"When enabled, create and manage custom NPCs",settingsNPCList:"NPC List",settingsCreateNPC:"+ Create NPC",settingsSave:"Save Settings",settingsSavePreset:"Save as Preset",settingsImport:"Import Data",settingsExport:"Export Data",settingsPresetManagement:"Preset Management",settingsWorldBooks:"World Books",settingsWorldBooksDesc:"World books provide additional knowledge base for AI, can be bound to different scenes and characters",settingsWorldBooksButton:"Open World Books Panel",settingsWorldEvents:"World Events",settingsWorldEventsDesc:"When enabled, AI will generate location, weather and recent events based on world settings",settingsWorldEventsLocation:"Location",settingsWorldEventsWeather:"Weather",settingsWorldEventsLastGenerated:"Last Generated",settingsWorldEventsLastProgressed:"Last Progressed",settingsWorldEventsRecentEvents:"Recent Events",settingsWorldEventsNoEvents:"No events yet",settingsWorldEventsRefresh:"Refresh",settingsWorldEventsProgress:"Progress",settingsWorldEventsCooldownTip:"Progress function requires 3 hours cooldown",settingsAutoTweetDetection:"Auto Tweet Detection",settingsAutoTweetDetectionDesc:"When enabled, automatically detect chat history of bound characters every 5 minutes and generate New Tweet notifications",settingsAutoTweetDetectionNote:'Only effective for characters with "Identity Recognition" and "Exclusive User Persona" settings',settingsDetectionRunning:"Detection service running",settingsNextDetectionTime:"Next detection time",settingsAutoRefreshFeed:"Auto Refresh Feed",settingsAutoRefreshFeedDesc:"When enabled, automatically refresh feed every 10 minutes",settingsRefreshRunning:"Refresh service running",settingsNextRefreshTime:"Next refresh time",relationshipNoData:"No relationship data",relationshipNoDataHint:"Click button above to create character relationships",relationshipCharacterCount:"Characters",relationshipLinkCount:"Relations",relationshipAddCharacter:"+ Add Character",relationshipSave:"Save Graph",relationshipClose:"Close",relationshipEmptyState:"No characters",relationshipEmptyStateHint:"Click button above to add characters",liveTitle:"Live",liveAudioTab:"Audio Live",liveVideoTab:"Video Live",liveOnlineCount:"viewers",liveJoinStream:"Join Live",liveNoAudioStreams:"No audio streams",liveNoVideoStreams:"No video streams",liveWaitingContent:"Waiting for exciting content",liveRoomInfo:"Room Info",liveRoomDescription:"Description",liveRoomAnnouncement:"Announcement",liveRoomWelcome:"Welcome to the live room!",liveRoomSendMessage:"Say something...",danmakuSent:"Message sent",you:"You",toastThemeLight:"Switched to Light Mode",toastThemeDark:"Switched to Dark Mode",toastLanguageChinese:"Switched to Chinese",toastLanguageEnglish:"Switched to English",btnSave:"Save",btnCancel:"Cancel",btnEdit:"Edit",btnDelete:"Delete",btnConfirm:"Confirm"}};let Hn="zh";function jn(n){return(Rn[Hn]||Rn.zh)[n]||n}function Un(n){const e=Rn[n];if(!e)return;console.log(`🌐 正在应用语言: ${n}`);const t=document.getElementById("language-text");t&&(t.textContent="zh"===n?"中文":"EN"),document.querySelectorAll("[data-i18n]").forEach(n=>{const t=n.getAttribute("data-i18n");e[t]&&("INPUT"===n.tagName||"TEXTAREA"===n.tagName?n.placeholder=e[t]:n.textContent=e[t])});const o=document.getElementById("x-profile-header-count");if(o&&o.textContent){const n=o.textContent.match(/\d+/);n&&(o.textContent=`${n[0]} ${e.profilePostsCount}`)}!function(n){const e=document.getElementById("tweet-detail-stats");if(e){const t=e.querySelectorAll('span[style*="color: #71767b"]');t.length>=3&&(t[0].textContent=n.tweetDetailRetweets,t[1].textContent=n.tweetDetailLikes,t[2].textContent=n.tweetDetailBookmarks)}const t=document.getElementById("tweet-detail-views-label");t&&(t.textContent=n.tweetDetailViews)}(e),function(n){const e=document.getElementById("account-profile-nav-count");if(e&&e.textContent){const t=e.textContent.match(/\d+/);t&&(e.textContent=`${t[0]} ${n.accountPostsCount}`)}const t=document.getElementById("account-follow-btn");t&&(t.textContent.includes("Following")||t.textContent.includes("正在关注")?t.textContent=n.accountFollowing:(t.textContent.includes("Follow")||t.textContent.includes("关注"))&&(t.textContent=n.accountFollow))}(e),console.log("✅ 语言已应用: "+("zh"===n?"中文":"English"))}async function On(){try{const n=document.getElementById("x-social-screen");if(!n)return;const t=n.classList.contains("x-theme-light")?"dark":"light";"light"===t?n.classList.add("x-theme-light"):n.classList.remove("x-theme-light");const o=document.getElementById("theme-icon-dark"),a=document.getElementById("theme-icon-light");"light"===t?(o.style.display="none",a.style.display="block"):(o.style.display="block",a.style.display="none");const i=e(),r=`xTheme_${vt||"main"}`;await i.xSettings.put({id:r,theme:t,updatedAt:(new Date).toISOString()}),_n(t);const s=document.getElementById("character-relationship-graph-modal");s&&"none"!==s.style.display&&Fe();const l=document.getElementById("relationship-binding-area");l&&"none"!==l.style.display&&setTimeout(()=>{ze()},100),console.log("🎨 主题已切换为: "+("light"===t?"日间模式":"夜间模式"));const c=Rn[Hn]||Rn.zh;mn("light"===t?c.toastThemeLight:c.toastThemeDark,"success")}catch(n){console.error("主题切换失败:",n),mn("主题切换失败","error")}}function _n(n){if(!document.getElementById("x-social-screen"))return}const Fn=[{name:"Twitter蓝",color:"#1d9bf0"},{name:"薰衣草紫",color:"#7856ff"},{name:"玫瑰粉",color:"#f91880"},{name:"翡翠绿",color:"#00ba7c"},{name:"橙色",color:"#ff7a00"},{name:"红色",color:"#f4212e"},{name:"黄色",color:"#ffd400"},{name:"青色",color:"#00d4ff"}];function Xn(){const n=document.getElementById("accent-color-picker-modal");n&&n.remove()}async function qn(){try{const n=e(),t=`xAccentColor_${vt||"main"}`,o=await n.xSettings.get(t);if(o&&o.accentColor){const n=document.getElementById("x-social-screen");n&&(n.style.setProperty("--x-accent",o.accentColor),console.log("✅ 已加载主题色:",o.accentColor))}}catch(n){console.error("加载主题色偏好失败:",n)}}let Vn={avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",nickname:"⩌⌯⩌",prompt:"在这里输入你的匿名提问，或点击下方按钮生成随机提问...",background:"https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg",answeredQuestions:[]},Gn="",Yn=!1,Wn=new Set,Jn=null;async function Kn(){try{const n=e(),t=(Sn.accountInfo||Sn).handle.replace("@",""),o=`account_askbox_${t}`;Vn.id=o,await n.xAccountAskbox.put(Vn),console.log("✅ 账户提问箱数据已保存到数据库:",t)}catch(n){console.error("❌ 保存账户提问箱数据失败:",n)}}function Qn(){const n=document.getElementById("account-answered-questions-list"),e=document.getElementById("account-answered-questions-title");if(n){if(0===Vn.answeredQuestions.length)return e&&(e.style.display="none"),void(n.innerHTML='\n <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; padding: 40px 20px; ">\n 暂无提问\n </div>\n ');e&&(e.style.display="block"),n.innerHTML=Vn.answeredQuestions.map((n,e)=>{const t=new Date(n.date).toLocaleDateString("zh-CN",{month:"short",day:"numeric"}),o=Wn.has(n.id);return`\n <div\n class="account-askbox-question-item"\n data-question-id="${n.id}"\n style="background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.2s; ${o?"border: 3px solid var(--x-accent); background-color: color-mix(in srgb, var(--x-accent) , 0.1);":""}\n ${Yn?"border-left: 3px solid var(--x-accent);":""}\n "\n onmouseover="if(!${Yn}){this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';}"\n onmouseout="if(!${Yn}){this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';}"\n onmousedown="startAccountQuestionLongPress('${n.id}')"\n onmouseup="endAccountQuestionLongPress()"\n onmouseleave="endAccountQuestionLongPress()"\n ontouchstart="handleAccountQuestionTouchStart(event, '${n.id}')"\n ontouchend="handleAccountQuestionTouchEnd(event, '${n.id}')"\n ontouchcancel="endAccountQuestionLongPress()"\n onclick="if(${Yn}){toggleAccountQuestionSelection('${n.id}');event.stopPropagation();}"\n >\n\n <div style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); padding: 20px; color: #fff; ">\n <div style="font-size: 15px; line-height: 1.6; word-break: break-word;">\n ${n.question}\n </div>\n </div>\n\n <div style="background-color:#fff; padding: 20px; min-height: 60px; color: #333; ">\n <div id="account-answer-${n.id}"\n contenteditable="true"\n data-question-id="${n.id}"\n style="font-size: 14px; line-height: 1.6; word-break: break-word; outline: none; cursor: text; min-height: 20px; ${n.answer?"":"color: #999; text-align: center;"}\n "\n onblur="saveAccountQuestionAnswer('${n.id}')"\n onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}"\n onfocus="if(this.textContent==='点击此处回复...'){this.textContent='';this.style.color='#333';this.style.textAlign='left';}">${n.answer||"点击此处回复..."}</div>\n </div>\n\n <div style="background-color: #f5f5f5; padding: 8px 20px; color: #999; font-size: 12px; text-align: right; ">\n ${t}\n </div>\n </div>\n`}).join("")}}function Zn(){Yn=!0,function(){let n=document.getElementById("account-askbox-delete-toolbar");n||(n=document.createElement("div"),n.id="account-askbox-delete-toolbar",n.style.cssText="\n position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 12px 20px; display: flex; align-items: center; gap: 16px; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); ",n.innerHTML='\n <button onclick="selectAllAccountQuestions()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 全选\n </button>\n <span id="account-askbox-selected-count" style="color: #fff; font-size: 14px; font-weight: 500;">已选择 0 个</span>\n <button onclick="deleteSelectedAccountQuestions()" style="background-color: #f91880; color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#d0155f\'" onmouseout="this.style.backgroundColor=\'#f91880\'">\n 删除\n </button>\n <button onclick="exitAccountAskboxMultiSelectMode()" style="background-color: rgba(255,255,255,0.15); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.25)\'" onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.15)\'">\n 取消\n </button>\n ',document.body.appendChild(n));n.style.display="flex"}(),document.querySelectorAll(".account-askbox-question-item").forEach(n=>{n.style.borderLeft="3px solid var(--x-accent)"}),console.log("✅ 已进入账户提问箱多选模式")}function ne(){const n=document.getElementById("account-askbox-selected-count");n&&(n.textContent=`已选择 ${Wn.size} 个`)}n.openAccountAskbox=async function(){if(Sn)try{await async function(){await async function(){try{const n=e(),t=(Sn.accountInfo||Sn).handle.replace("@",""),o=`account_askbox_${t}`,a=await n.xAccountAskbox.get(o);a?(Object.assign(Vn,a),console.log("✅ 账户提问箱数据已从数据库加载:",t)):(Vn={avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",nickname:"⩌⌯⩌",prompt:"在这里输入你的匿名提问，或点击下方按钮生成随机提问...",background:"https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg",answeredQuestions:[],id:o},await n.xAccountAskbox.put(Vn),console.log("✅ 已创建默认账户提问箱数据:",t))}catch(n){console.error("❌ 加载账户提问箱数据失败:",n)}}(),Gn="";const n=document.getElementById("account-askbox-avatar"),t=document.getElementById("account-askbox-nickname"),o=document.getElementById("account-askbox-prompt"),a=document.getElementById("account-askbox-background");n&&(n.src=Vn.avatar);t&&(t.textContent=Vn.nickname);o&&(o.textContent="在这里输入你的匿名提问，或点击下方按钮生成随机提问...");a&&(a.style.backgroundImage=`url('${Vn.background}')`);Qn()}(),document.getElementById("account-profile-page").style.display="none",document.getElementById("account-askbox-page").style.display="flex"}catch(n){console.error("打开账户提问箱失败:",n),mn("打开提问箱失败: "+n.message,"error")}else mn("未找到当前账户信息","error")},n.closeAccountAskbox=function(){Yn&&exitAccountAskboxMultiSelectMode(),document.getElementById("account-askbox-page").style.display="none",document.getElementById("account-profile-page").style.display="flex"},n.changeAccountAskboxAvatar=async function(){const n=prompt("请输入新的头像URL:",Vn.avatar);if(n&&n.trim()){Vn.avatar=n.trim();const e=document.getElementById("account-askbox-avatar");e&&(e.src=Vn.avatar),await Kn(),mn("头像已更新并保存","success")}},n.saveAccountAskboxNickname=async function(){const n=document.getElementById("account-askbox-nickname");if(!n)return;const e=n.textContent.trim();e&&e!==Vn.nickname&&(Vn.nickname=e,await Kn(),console.log("✅ 昵称已自动保存:",e))},n.saveAccountAskboxPrompt=async function(){const n=document.getElementById("account-askbox-prompt");if(!n)return;const e=n.textContent.trim();e&&"在这里输入你的匿名提问，或点击下方按钮生成随机提问..."!==e?(Gn=e,console.log("📝 [提问箱] 用户输入了提问:",Gn)):(Gn="",console.log("📝 [提问箱] 用户清空了提问"))},n.openAccountAskboxSettings=function(){const n=prompt("请输入新的背景图URL:",Vn.background);if(n&&n.trim()){Vn.background=n.trim();const e=document.getElementById("account-askbox-background");e&&(e.style.backgroundImage=`url('${Vn.background}')`),Kn(),mn("背景图已更新并保存","success")}},n.getNewAccountQuestion=async function(){if(Sn)try{const o=Gn&&Gn.trim().length>0;o?(console.log("🎯 [提问箱] 检测到用户提问，准备生成回答:",Gn),mn("正在生成回答...","info")):(console.log("🎲 [提问箱] 没有用户提问，生成随机问答"),mn("正在生成新的提问...","info"));const a=t(),i=e(),r=await a.apiConfig.get("main");if(!(r&&r.proxyUrl&&r.apiKey&&r.model))return void mn("请先配置API设置","error");const{proxyUrl:l,apiKey:c,model:d}=r,p=`xSettings_${vt||"main"}`,g=await i.xSettings.get(p),m=g?.systemPrompt||"",x=g?.worldSetting||"",u=Sn.accountInfo||Sn,h=(u.handle.replace("@",""),await s.getUnifiedProfile(u.handle));if(!h)return void mn("无法获取账户资料","error");console.log("📋 [提问箱] 账户类型:",h.type);let f=s.formatProfileForPrompt(h,{includeType:!0,includeTweets:!1,includeRelationships:!0}),b="";Sn.tweets&&Sn.tweets.length>0&&(b="\n【该账户最近发布的推文】：\n",Sn.tweets.slice(0,5).forEach((n,e)=>{b+=`${e+1}. ${n.content}${n.time?` (${n.time})`:""}`,n.image&&("description"===n.image.type?b+=`\n [图片描述: ${n.image.content}]`:"upload"===n.image.type&&(b+="\n [包含上传的图片]")),n.media&&n.media.length>0&&n.media.forEach(n=>{"description"===n.type&&n.description&&(b+=`\n [图片描述: ${n.description}]`)}),b+="\n"}));s.buildUserXProfileInfo(n.userProfileData);let v="";if(h.relationships&&h.relationships.length>0){const n=h.relationships.find(n=>"恋人"===n.relationshipType);n&&(v=`\n【该账户的情侣关系】：\n与 ${n.npcName}（${n.npcHandle}）是恋人关系`,n.description&&(v+=`\n${n.description}`))}let y="";Vn.answeredQuestions.length>0&&(y="\n【已有的提问列表（需要重新生成回答）】：\n",Vn.answeredQuestions.forEach((n,e)=>{y+=`${e+1}. ${n.question}\n`}));let w=s.buildBaseSystemPrompt({userPrompt:m,worldSetting:x}),k="";o&&(k=`\n【🔴 用户匿名提问（必须回答）】：\n"${Gn}"\n`),w+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 - 账户提问箱生成 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你需要为该账户生成匿名提问，并以该账户的身份回答这些提问。\n${f}\n${b}\n${v}\n${k}\n${y}\n【生成要求】：\n1. ${o?`必须回答用户的匿名提问"${Gn}"，同时额外生成2-5个随机问答`:y?"如果有已有提问列表，请基于这些提问重新生成回答":"生成3-10个适合该账户身份的匿名提问"}\n2. ${o?"用户提问是完全匿名的，不要在回答中假设提问者的身份":"提问要自然、真实，符合匿名提问箱的风格"}\n3. ${o?"":"提问内容要与账户的X平台公开信息相关（X姓名、简介、公开身份、最近推文）"}\n4. ${"character"===h.type||"npc"===h.type?"回答必须严格符合角色/NPC的人设和性格特点":"回答要自然、真实"}\n5. ${o?"回答用户提问时要自然、真诚，体现账户的性格和口吻":"提问可以是：\n- 关于最近推文内容的追问或评论\n- 关于生活经验、情感态度的询问\n- 关于兴趣爱好、日常生活的好奇\n- 轻松幽默或真诚的话题"}\n6. ${o?"":"提问长度适中（10-50字）"}\n7. 回答要体现该账户的性格和口吻，长度适中（20-100字）\n8. ${o?"":"避免过于私密、冒犯或不适当的问题"}\n${o?"":'【🔒 隐私保护规则 - 匿名提问限制】：\n🚨 匿名提问者只能基于该账户的X平台公开信息：\n✅ 可以基于：X姓名、X句柄、X简介、公开身份、公开的推文内容\n❌ 禁止提及：真实姓名、真实职业、私密关系、未公开的身份信息\n❌ 禁止使用：只有亲密关系才知道的称呼（如"老师"、"同学"等，除非是公开身份）\n示例说明：\n- ✅ 正确："姐姐你平时喜欢什么类型的音乐啊？"（基于公开称呼）\n- ❌ 错误："张老师今天上课讲了什么内容？"（泄露了真实姓氏和职业）\n- ❌ 错误："同学你这次考试考得怎么样？"（假装是同学关系）\n⚠️ 回答也要注意：不要在回答中主动泄露私密信息，除非是角色本人想公开'}\n【返回格式】：\n返回JSON数组，每个对象包含question和answer字段：\n\`\`\`json\n[\n{"question": "提问内容1", "answer": "该账户的回答1"},\n{"question": "提问内容2", "answer": "该账户的回答2"},\n{"question": "提问内容3", "answer": "该账户的回答3"}\n]\n\`\`\`\n【重要】：\n- 必须返回有效的JSON数组格式\n- question是匿名提问的内容\n- answer是该账户以自己的身份和人设回答的内容\n- ${o?`请务必包含用户提问"${Gn}"的回答，并额外生成2-5组随机问答，将用户问答自然混入其中，不要特殊化`:y?`请基于已有的${Vn.answeredQuestions.length}个提问重新生成回答`:"生成3-10组问答"}\n现在，请生成JSON格式的问答内容：`;const $=[{role:"user",content:o?`请回答用户的匿名提问"${Gn}"，同时生成2-5组随机问答，将用户问答自然混入其中，返回JSON数组格式`:y?`请基于已有的${Vn.answeredQuestions.length}个提问，以该账户的身份重新生成回答，返回JSON数组格式`:"请生成3-10组问答，返回JSON数组格式"}];let C,I=l.includes("generativelanguage");if(I){const n={url:`${"https://generativelanguage.googleapis.com/v1beta/models"}/${d}:generateContent?key=${getRandomValue(c)}`,data:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:w+"\n\n"+$.map(n=>n.content).join("\n")}]}],generationConfig:{temperature:.9}})}};C=await fetch(n.url,n.data)}else{const n={model:d,messages:[{role:"system",content:w},...$],temperature:.9,stream:!1};C=await fetch(`${l}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(n)})}if(!C.ok){const n=await C.json();throw new Error(`API错误: ${C.status} - ${n.error?.message||C.statusText}`)}const S=await C.json();let M,T;I?S.candidates&&S.candidates[0]&&S.candidates[0].content&&S.candidates[0].content.parts&&(M=S.candidates[0].content.parts[0].text||""):M=S.choices?.[0]?.message?.content||"",console.log("AI生成的问答:",M);try{let n=M.trim();const e=n.match(/```(?:json)?\s*(\[\s*\{[\s\S]*?\}\s*\])\s*```/);if(e)n=e[1];else if(!n.startsWith("[")||!n.endsWith("]"))throw new Error("未找到有效的JSON格式");if(T=JSON.parse(n),!Array.isArray(T)||0===T.length)throw new Error("AI返回的不是有效的数组或数组为空")}catch(n){throw console.error("JSON解析失败:",n),new Error(`解析AI回答失败: ${n.message}`)}console.log(`✅ 解析到 ${T.length} 组问答:`,T),y&&(Vn.answeredQuestions=[]);const A=T.map((n,e)=>({id:`q_${Date.now()}_${e}_${Math.random().toString(36).substr(2,9)}`,question:n.question||"",answer:n.answer||"",date:(new Date).toISOString()}));if(Vn.answeredQuestions.unshift(...A),await Kn(),Qn(),o){mn("已生成回答！","success"),Gn="";const n=document.getElementById("account-askbox-prompt");n&&(n.textContent="在这里输入你的匿名提问，或点击下方按钮生成随机提问..."),console.log(`✅ [提问箱] 用户提问已回答，问题已混入${A.length}组问答中`)}else mn(""+(y?"已重新生成回答":`生成了 ${A.length} 组问答`),"success");if("character"===h.type&&h.characterData){const n=.3,e=Math.random()<n;if(console.log("🔔 检测到角色提问箱"),console.log(`🎲 触发概率: ${(100*n).toFixed(0)}%, 本次${e?"触发":"不触发"}`),!e)return void console.log("⏭️ 本次未触发角色主动发消息");console.log("✅ 准备触发角色主动发消息"),console.log("📋 角色数据:",h.characterData.originalName,h.characterData.id);const t=h.characterData.id,o=Vn.answeredQuestions.slice(0,3).map((n,e)=>`${e+1}. Q: ${n.question}\n A: ${n.answer}`).join("\n\n");setTimeout(async()=>{try{const n=`msg_${t}`,e=`messagesList_${vt||"main"}`,a=await i.xAccountProfiles.get(e);let r=null;if(a&&a.data&&(r=a.data.find(e=>e.id===n)),!r){const t={id:n,user:{name:accountData.name,handle:accountData.handle,avatar:accountData.avatar,verified:accountData.verified||!1},preview:"发现你在看我的提问箱...",time:"刚刚",unread:!0,unreadCount:1};a&&a.data?(a.data.unshift(t),await i.xAccountProfiles.put(a)):await i.xAccountProfiles.put({handle:e,name:"messagesList",data:[t],updatedAt:(new Date).toISOString()}),r=t,dc.unshift(t)}const s=`messageConversation_${vt||"main"}_${n}`,l=await i.xAccountProfiles.get(s),c=l&&l.data&&l.data.messages&&l.data.messages.length>0;console.log("🎯 触发角色主动发消息（提问箱查看）"),console.log("📖 现有对话记录: "+(c?l.data.messages.length+"条消息":"无（首次对话）"));const d=await vl(r,!0,{isAskboxViewed:!0,askboxContent:o,characterId:t});if(d&&d.length>0){if(await cc(d,r),a&&a.data){const e=a.data.findIndex(e=>e.id===n);-1!==e&&(a.data[e].preview=d[0].content||d[0].voiceText||"[消息]",a.data[e].time=d[0].time||"刚刚",a.data[e].unread=!0,a.data[e].unreadCount=(a.data[e].unreadCount||0)+d.length,await i.xAccountProfiles.put(a),dc=a.data)}console.log(`✅ 角色已发送 ${d.length} 条私信`),mn(`${h.name} 给你发来了新消息`,"info")}}catch(n){console.error("触发角色主动发消息失败:",n)}},1e3)}}catch(n){console.error("生成提问失败:",n),mn(`生成失败: ${n.message}`,"error")}else mn("未找到当前账户信息","error")},n.saveAccountQuestionAnswer=async function(n){const e=document.getElementById(`account-answer-${n}`);if(!e)return;const t=Vn.answeredQuestions.find(e=>e.id===n);if(!t)return;let o=e.textContent.trim();"点击此处回复..."===o&&(o=""),o!==t.answer&&(t.answer=o,await Kn(),console.log("✅ 回复已自动保存:",n))},n.startAccountQuestionLongPress=function(n){Yn||(Jn=setTimeout(()=>{Zn(),toggleAccountQuestionSelection(n)},500))},n.endAccountQuestionLongPress=function(){Jn&&(clearTimeout(Jn),Jn=null)},n.handleAccountQuestionTouchStart=function(e,t){Yn||(n.accountQuestionTouchStartTime=Date.now(),n.accountQuestionTouchStartY=e.touches[0].clientY,Jn=setTimeout(()=>{Zn(),toggleAccountQuestionSelection(t)},500))},n.handleAccountQuestionTouchEnd=function(e,t){if(Jn&&(clearTimeout(Jn),Jn=null),Yn){const o=Date.now()-(n.accountQuestionTouchStartTime||0),a=Math.abs((e.changedTouches[0]?.clientY||n.accountQuestionTouchStartY||0)-(n.accountQuestionTouchStartY||0));o<500&&a<10&&(e.preventDefault(),toggleAccountQuestionSelection(t))}},n.toggleAccountQuestionSelection=function(n){Yn||Zn();const e=document.querySelector(`.account-askbox-question-item[data-question-id="${n}"]`);e&&(Wn.has(n)?(Wn.delete(n),e.style.border="",e.style.backgroundColor="rgba(255,255,255,0.9)"):(Wn.add(n),e.style.border="3px solid var(--x-accent)",e.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)"),ne())},n.exitAccountAskboxMultiSelectMode=function(){Yn=!1,Wn.clear(),function(){const n=document.getElementById("account-askbox-delete-toolbar");n&&(n.style.display="none")}(),Jn&&(clearTimeout(Jn),Jn=null),n.accountQuestionTouchStartTime=null,n.accountQuestionTouchStartY=null,document.querySelectorAll(".account-askbox-question-item").forEach(n=>{n.style.border="",n.style.borderLeft="",n.style.backgroundColor="rgba(255,255,255,0.9)"}),console.log("✅ 已退出账户提问箱多选模式")},n.selectAllAccountQuestions=function(){document.querySelectorAll(".account-askbox-question-item").forEach(n=>{const e=n.dataset.questionId;Wn.has(e)||(Wn.add(e),n.style.border="3px solid var(--x-accent)",n.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)")}),ne()},n.deleteSelectedAccountQuestions=async function(){if(0===Wn.size)return void mn("请先选择要删除的提问","warning");if(confirm(`确定要删除选中的 ${Wn.size} 个提问吗？删除后无法恢复。`))try{Vn.answeredQuestions=Vn.answeredQuestions.filter(n=>!Wn.has(n.id)),await Kn(),mn(`已删除 ${Wn.size} 个提问`,"success"),n.exitAccountAskboxMultiSelectMode(),Qn()}catch(n){console.error("删除提问失败:",n),mn("删除失败: "+n.message,"error")}};let ee={systemPrompt:"",worldSetting:"",characterBinding:!1,boundCharacters:[],worldBooks:[]};n.userProfileData||(n.userProfileData={name:"我",handle:"@me",avatar:"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",coverImage:"https://i.postimg.cc/qRzMB6nQ/default-cover.jpg",bio:"欢迎来到我的X主页！",verified:!1,verificationType:"none",coupleCharacterId:"",coupleCharacterName:"",customTag1:"科技爱好者",customTag1Icon:"✨",customTag1Color:"#71767b",customTag2:"2024年加入",customTag2Icon:"📅",customTag2Color:"#71767b",following:"156",followers:"89",knownIdentityCharacters:[],publicIdentity:"",showRealName:!1,realName:""});let te=n.userProfileData;async function oe(){try{const n=e();await re();const t=`xSettings_${vt||"main"}`,o=await n.xSettings.get(t);if(o){const n=ee.worldBooks;ee=o,ee.worldBooks=n}else{const n=ee.worldBooks;ee={systemPrompt:"",worldSetting:"",characterBinding:!1,boundCharacters:[],npcBinding:!1,worldBooks:n}}await ae(),de(),console.log("✅ X设置已加载 (账户:",vt||"main",")"),console.log("📚 全局世界书:",ee.worldBooks?.length||0,"个")}catch(n){console.error("初始化X设置失败:",n)}}async function ae(){document.getElementById("x-system-prompt").value=ee.systemPrompt||"",document.getElementById("x-world-setting").value=ee.worldSetting||"",ee.boundCharacters||(ee.boundCharacters=[]),ee.worldBooks||(ee.worldBooks=[]),pe();const n=document.getElementById("character-binding-area");ee.characterBinding?(n.style.display="block",ge()):n.style.display="none",Ae();const e=document.getElementById("relationship-binding-area");ee.characterRelationship?.enabled?(e.style.display="block",await Ee(),setTimeout(()=>{ze()},200)):e.style.display="none",rt();const t=document.getElementById("npc-binding-area");ee.npcBinding?(t.style.display="block",st()):t.style.display="none"}async function ie(){try{const n=e();await n.xSettings.put({id:"globalWorldBooks",worldBooks:ee.worldBooks||[],lastUpdated:(new Date).toISOString()}),console.log("✅ 全局世界书已保存")}catch(n){throw console.error("保存全局世界书失败:",n),n}}async function re(){try{const n=e(),t=await n.xSettings.get("globalWorldBooks");if(t&&t.worldBooks&&t.worldBooks.length>0)ee.worldBooks=t.worldBooks,console.log("✅ 全局世界书已加载:",ee.worldBooks.length,"个");else{console.log("📦 [世界书迁移] 全局世界书为空，尝试从账户设置迁移...");const e=`xSettings_${vt||"main"}`,t=await n.xSettings.get(e);t&&t.worldBooks&&t.worldBooks.length>0?(console.log(`📦 [世界书迁移] 发现账户设置中有 ${t.worldBooks.length} 个世界书，正在迁移到全局设置...`),ee.worldBooks=t.worldBooks,await ie(),console.log("✅ [世界书迁移] 迁移完成！")):(ee.worldBooks=[],console.log("ℹ️ [世界书] 无世界书数据"))}}catch(n){console.error("加载全局世界书失败:",n),ee.worldBooks=[]}}async function se(){try{ee.systemPrompt=document.getElementById("x-system-prompt").value,ee.worldSetting=document.getElementById("x-world-setting").value;const n=e(),t=`xSettings_${vt||"main"}`,o={...ee};delete o.worldBooks,await n.xSettings.put({id:t,...o,lastUpdated:(new Date).toISOString()}),console.log("✅ X设置已保存 (账户:",vt||"main",")"),mn("设置已保存","success")}catch(n){console.error("保存设置失败:",n),mn("保存失败: "+n.message,"error")}}function le(){const n=document.getElementById("world-books-manage-list");if(!n)return;if(!ee.worldBooks||0===ee.worldBooks.length)return void(n.innerHTML='\n <div style="color:var(--x-text-secondary); font-size: 15px; text-align: center; padding: 60px 20px; background-color:var(--x-bg-secondary); border-radius: 16px; border: 2px dashed var(--x-border-color); ">\n <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: var(--x-text-secondary); margin-bottom: 16px;">\n <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v13c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-13c0-.276-.224-.5-.5-.5h-13z"></path></g>\n </svg>\n <div style="font-weight: 600; margin-bottom: 8px; font-size: 16px;">暂无世界书</div>\n <div style="font-size: 13px;">点击右上角"添加世界书"按钮创建第一个世界书</div>\n </div>\n ');const e={global:"全局",messages:"私信",search:"搜索",trending:"热搜",profile:"主页",feed:"首页",tweetDetail:"详情"};n.innerHTML=`\n <div style="display: flex; flex-direction: column; gap: 12px;">\n ${ee.worldBooks.map((n,t)=>{const o=n.scenes?.map(n=>e[n]||n).join(", ")||"未绑定场景";let a=[];n.bindToAll&&a.push("全局对话"),n.bindToCharacterOnly&&a.push("仅角色对话"),n.boundCharacters&&n.boundCharacters.length>0&&a.push(`${n.boundCharacters.length}个指定角色`);const i=a.length>0?a.join(" + "):"未绑定目标",r=n.isIdle||"none"===n.targetType&&(!n.scenes||0===n.scenes.length);return`\n <div style="background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 16px; padding: 16px; transition: all 0.2s; " onmouseover="this.style.borderColor='var(--x-accent)'"\n onmouseout="this.style.borderColor='var(--x-border-color)'">\n <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 12px;">\n <div style="flex: 1; min-width: 0;">\n <div style="color:var(--x-text-primary); font-size: 17px; font-weight: 700; margin-bottom: 8px; ">${n.name}</div>\n <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; ">\n ${r?'\n <span style="display: inline-flex; align-items: center; background-color: rgba(113, 118, 123, 0.2); color:var(--x-text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-text-secondary); margin-right: 4px;">\n <g><path d="M8 7c0 2.21-1.79 4-4 4S0 9.21 0 7s1.79-4 4-4 4 1.79 4 4zm5-4c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm9 0c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path></g>\n </svg>\n 闲置状态（暂未启用）\n </span>\n ':`\n <span style="display: inline-flex; align-items: center; background-color: #1d9bf0; color: #ffffff; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #ffffff; margin-right: 4px;">\n <g><path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37c.324-.216 7.945-5.365 7.945-11.332C20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path></g>\n </svg>\n ${o}\n </span>\n <span style="display: inline-flex; align-items: center; background-color: rgba(29, 155, 240, 0.15); color: #1d9bf0; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #1d9bf0; margin-right: 4px;">\n <g><path d="M17.863 13.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44zM12 2C9.791 2 8 3.79 8 6s1.791 4 4 4 4-1.79 4-4-1.791-4-4-4z"></path></g>\n </svg>\n ${i}\n </span>\n `}\n </div>\n </div>\n <div style="display: flex; gap: 8px; flex-shrink: 0; margin-left: 12px;">\n <button onclick="editWorldBookInManage(${t})" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 18px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">编辑</button>\n <button onclick="deleteWorldBookInManage(${t})" style="background-color: #f4212e; color: #fff; border: none; border-radius: 18px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">删除</button>\n </div>\n </div>\n <div style="color:var(--x-text-secondary); font-size: 14px; line-height: 1.6; max-height: 80px; overflow: hidden; text-overflow: ellipsis; background-color:var(--x-bg-primary); padding: 12px; border-radius: 8px; ">${n.content.substring(0,150)}${n.content.length>150?"...":""}</div>\n </div>\n `}).join("")}\n </div>\n`}function ce(n=null,e=null){const o=null!==n,a=document.createElement("div");a.id="world-book-modal",a.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 12px; box-sizing: border-box;\n",a.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 100%; max-width: 600px; max-height: calc(100vh - 24px); overflow-y: auto; border: 1px solid var(--x-border-color); box-sizing: border-box; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--x-border-color); position: sticky; top: 0; background-color:var(--x-bg-primary); z-index: 1; ">\n <h2 style="color:var(--x-text-primary); font-size: 18px; font-weight: 700; margin: 0; ">${o?"编辑世界书":"创建世界书"}</h2>\n <div onclick="closeWorldBookModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="padding: 16px;">\n <form id="world-book-form" onsubmit="saveWorldBook(event)">\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-primary); font-size: 14px; font-weight: 600; margin-bottom: 6px; ">世界书名称 *</label>\n <input type="text" id="wb-name" required\n value="${n?.name||""}"\n placeholder="例如：表情包库、角色关系设定..."\n style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); padding: 10px 12px; font-size: 14px; outline: none; box-sizing: border-box; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'">\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-primary); font-size: 14px; font-weight: 600; margin-bottom: 6px; ">世界书内容 *</label>\n <textarea id="wb-content" required rows="6"\n placeholder="输入世界书内容，例如：&#10;表情包链接：&#10;- 开心：https://example.com/happy.gif&#10;- 生气：https://example.com/angry.gif&#10;&#10;或其他设定内容..."\n style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); padding: 10px 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit; line-height: 1.5; box-sizing: border-box; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'">${n?.content||""}</textarea>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-primary); font-size: 14px; font-weight: 600; margin-bottom: 4px; ">绑定场景（可多选）</label>\n <div style="color:var(--x-text-secondary); font-size: 12px; margin-bottom: 8px; line-height: 1.4; ">💡 提示：如果不绑定任何场景和目标，世界书将处于闲置状态，不会被应用到任何场景</div>\n <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; ">\n ${["global","messages","search","trending","profile","feed","tweetDetail"].map(e=>`\n <label style="display: flex; align-items: center; padding: 8px 10px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'">\n <input type="checkbox" name="wb-scenes" value="${e}" ${n?.scenes?.includes(e)||!1?"checked":""}\n style="margin-right: 6px; cursor: pointer;">\n <span style="color:var(--x-text-primary); font-size: 13px;">${{global:"全局",messages:"私信界面",search:"搜索界面",trending:"热搜界面",profile:"角色主页",feed:"首页推文",tweetDetail:"推文详情"}[e]}</span>\n </label>\n `).join("")}\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-primary); font-size: 14px; font-weight: 600; margin-bottom: 8px; ">绑定目标（可选）</label>\n\n <label style="display: flex; align-items: center; padding: 8px 10px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; cursor: pointer; margin-bottom: 6px; ">\n <input type="checkbox" id="wb-bind-all" ${n?.bindToAll?"checked":""}\n style="margin-right: 6px; cursor: pointer;">\n <span style="color:var(--x-text-primary); font-size: 13px;">绑定到全局对话</span>\n </label>\n\n <label style="display: flex; align-items: center; padding: 8px 10px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; cursor: pointer; margin-bottom: 6px; ">\n <input type="checkbox" id="wb-bind-character-only" ${n?.bindToCharacterOnly?"checked":""}\n style="margin-right: 6px; cursor: pointer;">\n <span style="color:var(--x-text-primary); font-size: 13px;">绑定到仅角色对话</span>\n </label>\n\n <div style="margin-top: 6px;">\n <label style="display: block; color:var(--x-text-secondary); font-size: 12px; margin-bottom: 6px; ">绑定到指定角色（任何相关情景都会使用）：</label>\n <div id="wb-character-list" style="max-height: 160px; overflow-y: auto; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 6px; ">\n\n </div>\n </div>\n </div>\n\n <div style="display: flex; gap: 10px; margin-top: 20px;">\n <button type="button" onclick="closeWorldBookModal()" style="flex: 1; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 20px; padding: 11px; color:var(--x-text-primary); font-size: 14px; font-weight: 600; cursor: pointer; box-sizing: border-box; ">取消</button>\n <button type="submit" style="flex: 1; background-color: var(--x-accent); border: none; border-radius: 20px; padding: 11px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; box-sizing: border-box; ">${o?"保存修改":"创建世界书"}</button>\n </div>\n </form>\n </div>\n </div>\n`;const i=document.getElementById("x-social-screen");i?i.appendChild(a):document.body.appendChild(a),o&&a.setAttribute("data-edit-index",e),async function(n=[]){try{const e=t(),o=(await e.chats.toArray()).filter(n=>!n.isGroup&&!n.linkedCharacterData&&n.name&&""!==n.name.trim()),a=document.getElementById("wb-character-list");if(!a)return;if(0===o.length)return void(a.innerHTML='\n <div style="color:var(--x-text-secondary); font-size: 12px; text-align: center; padding: 16px; ">暂无可绑定的角色</div>\n ');a.innerHTML=o.map(e=>`\n <label style="display: flex; align-items: center; padding: 6px 8px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <input type="checkbox" name="wb-characters" value="${e.id}"\n ${n.includes(e.id)?"checked":""}\n style="margin-right: 6px; cursor: pointer;">\n <span style="color:var(--x-text-primary); font-size: 13px;">${e.name}</span>\n </label>\n `).join("")}catch(n){console.error("加载角色列表失败:",n)}}(n?.boundCharacters||[]),a.addEventListener("click",n=>{n.target===a&&closeWorldBookModal()})}async function de(){try{const n=e(),t=await n.xPresets.orderBy("createdAt").reverse().toArray(),o=document.getElementById("x-presets-list");if(0===t.length)return void(o.innerHTML='<p style="color: #71767b; font-size: 14px; text-align: center; margin: 20px 0;">暂无保存的预设</p>');o.innerHTML=t.map(n=>`\n <div class="preset-item" style="display: flex; align-items: center; justify-content: space-between; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px;">\n <div style="flex: 1; min-width: 0;">\n <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 4px; word-wrap: break-word;">${n.name}</div>\n <div style="color: #71767b; font-size: 13px;">${new Date(n.createdAt).toLocaleString()}</div>\n </div>\n <div style="display: flex; gap: 8px; flex-shrink: 0;">\n <button onclick="loadXPreset(${n.id})"\n style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 12px; cursor: pointer; white-space: nowrap;">\n 加载\n </button>\n <button onclick="deleteXPreset(${n.id})"\n style="background-color: #f4212e; color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 12px; cursor: pointer; white-space: nowrap;">\n 删除\n </button>\n </div>\n </div>\n `).join("")}catch(n){console.error("加载预设列表失败:",n)}}function pe(){const n=document.getElementById("x-character-toggle"),e=n.querySelector(".toggle-circle");ee.characterBinding?(n.style.backgroundColor="var(--x-accent)",e.style.left="22px"):(n.style.backgroundColor="#333",e.style.left="2px")}async function ge(){try{const n=t(),e=await n.chats.toArray(),o=e.filter(n=>!n.isGroup&&!n.linkedCharacterData&&n.name&&""!==n.name.trim());console.log(`📋 [角色列表] 共 ${e.length} 条记录，过滤后 ${o.length} 个有效角色`);const a=document.getElementById("characters-list");if(0===o.length)return void(a.innerHTML=l.buildEmptyState("暂无可绑定的角色，请先创建角色聊天"));ee.boundCharacters||(ee.boundCharacters=[]),a.innerHTML=o.map(n=>{const e=ee.boundCharacters.includes(n.id);return l.buildCharacterItem(n,e)}).join("")}catch(n){c.handleError(n,"加载角色列表"),document.getElementById("characters-list").innerHTML=l.buildErrorState("加载角色列表失败")}}function me(n){ee.boundCharacters||(ee.boundCharacters=[]);const e=ee.boundCharacters.indexOf(n);e>-1?ee.boundCharacters.splice(e,1):ee.boundCharacters.push(n);const t=document.querySelector(`[data-character-id="${n}"]`);if(t){const e=ee.boundCharacters.includes(n);t.outerHTML=l.buildCheckbox(n,e)}}n.openWorldBooksManageModal=async function(){await re();const n=document.createElement("div");n.id="world-books-manage-modal",n.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 12px; box-sizing: border-box;\n",n.innerHTML='\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 100%; max-width: 700px; max-height: calc(100vh - 24px); display: flex; flex-direction: column; border: 1px solid var(--x-border-color); box-sizing: border-box; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--x-border-color); flex-shrink: 0; ">\n <h2 style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin: 0; ">世界书管理<span style="font-size: 14px; color:var(--x-text-secondary); font-weight: 400; margin-left: 8px;">(全局共享)</span></h2>\n <div style="display: flex; gap: 12px; align-items: center;">\n <button onclick="openCreateWorldBookModal()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.opacity=\'0.9\'" onmouseout="this.style.opacity=\'1\'">\n + 添加世界书\n </button>\n <div onclick="closeWorldBooksManageModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n\n <div id="world-books-manage-list" style="flex: 1; overflow-y: auto; padding: 16px 20px; ">\n\n </div>\n </div>\n';const e=document.getElementById("x-social-screen");e?e.appendChild(n):document.body.appendChild(n),le(),n.addEventListener("click",e=>{e.target===n&&closeWorldBooksManageModal()})},n.closeWorldBooksManageModal=function(){const n=document.getElementById("world-books-manage-modal");n&&n.remove()},n.editWorldBookInManage=function(n){ce(ee.worldBooks[n],n)},n.deleteWorldBookInManage=async function(n){confirm("确定要删除这个世界书吗？")&&(ee.worldBooks.splice(n,1),await ie(),le(),mn("世界书已删除","success"))},n.openCreateWorldBookModal=function(){ce()},n.closeWorldBookModal=function(){const n=document.getElementById("world-book-modal");n&&n.remove()},n.saveWorldBook=async function(n){n.preventDefault();const e=document.getElementById("wb-name").value.trim(),t=document.getElementById("wb-content").value.trim();if(!e||!t)return void mn("请填写完整信息","error");const o=document.querySelectorAll('input[name="wb-scenes"]:checked'),a=Array.from(o).map(n=>n.value),i=document.getElementById("wb-bind-all").checked,r=document.getElementById("wb-bind-character-only").checked,s=document.querySelectorAll('input[name="wb-characters"]:checked'),l=Array.from(s).map(n=>n.value);let c="none",d=[];i?c="all":r?c="characterOnly":l.length>0&&(c="specific",d=[...l]);const p={name:e,content:t,scenes:a,targetType:c,selectedCharacters:d,bindToAll:i,bindToCharacterOnly:r,boundCharacters:l,isIdle:"none"===c&&(!a||0===a.length),createdAt:(new Date).toISOString()},g=document.getElementById("world-book-modal"),m=g?.getAttribute("data-edit-index");ee.worldBooks||(ee.worldBooks=[]),null!=m?(ee.worldBooks[parseInt(m)]=p,mn("世界书已更新","success")):(ee.worldBooks.push(p),mn("世界书已创建","success")),await ie();document.getElementById("world-books-manage-modal")&&le(),closeWorldBookModal()};async function xe(o){try{if(!document.getElementById("character-x-profile-modal"))return console.error("❌ 角色X资料弹窗元素不存在于DOM中"),void mn("无法打开X资料设置，请先绑定角色","error");const a=t(),i=e(),r=await a.chats.get(o);if(!r)return void mn("未找到角色信息","error");if(!r.name||r.linkedCharacterData)return mn("无效的角色数据（可能是聊天记录）","error"),void console.error("❌ 角色数据异常:",r);let s=await i.xCharacterProfiles.get(o);if(!s){const n=r.name||"未命名",e=n.toLowerCase().replace(/\s+/g,"_");s={characterId:o,xName:n,xHandle:e,xAvatar:r.settings?.aiAvatar||r.aiAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",xVerified:!1,xBio:"",relationships:[]}}s.relationships||(s.relationships=[]);const c=document.getElementById("character-x-profile-form");if(!c){console.error("❌ 角色X资料表单不存在，弹窗可能未正确加载"),mn("弹窗加载失败，请先勾选绑定该角色，然后刷新页面重试","error");const n=document.getElementById("character-x-profile-modal");return void(n&&(n.style.display="none"))}const d=document.getElementById("character-info-display");d&&(d.innerHTML=l.buildCharacterInfoDisplay(r));const p=document.getElementById("character-x-avatar"),g=document.getElementById("character-x-avatar-url"),m=document.getElementById("character-x-cover-preview"),x=document.getElementById("character-x-cover-url"),u=document.getElementById("character-x-name"),h=document.getElementById("character-x-handle"),f=document.getElementById("character-x-verified"),b=document.getElementById("character-tag1-icon"),v=document.getElementById("character-custom-tag1"),y=document.getElementById("character-tag1-color"),w=document.getElementById("character-tag2-icon"),k=document.getElementById("character-custom-tag2"),$=document.getElementById("character-tag2-color"),C=document.getElementById("character-following-count"),I=document.getElementById("character-followers-count"),S=document.getElementById("character-x-bio"),M=document.getElementById("character-public-identity"),T=document.getElementById("character-show-real-name"),A=document.getElementById("character-real-name"),E="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",z="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg";p&&(p.src=s.xAvatar||E),g&&(g.value=s.xAvatar||E),m&&(m.src=s.xCover||z),x&&(x.value=s.xCover||""),u&&(u.value=s.xName||r.name||""),h&&(h.value=s.xHandle||""),f&&(f.checked=s.xVerified||!1),b&&(b.value=s.customTag1?.icon||""),v&&(v.value=s.customTag1?.text||""),y&&(y.value=s.customTag1?.color||"#71767b"),w&&(w.value=s.customTag2?.icon||""),k&&(k.value=s.customTag2?.text||""),$&&($.value=s.customTag2?.color||"#71767b"),C&&(C.value=s.followingCount||""),I&&(I.value=s.followersCount||""),S&&(S.value=s.xBio||""),M&&(M.value=s.publicIdentity||""),T&&(T.checked=s.showRealName||!1),A&&(A.value=s.realName||""),Rt();const B=document.getElementById("character-auto-message-enabled"),L=document.getElementById("character-auto-message-interval");B&&(B.checked=s.autoMessageEnabled||!1),L&&(L.value=s.autoMessageInterval||60),n.toggleAutoMessageSettings(),fe(),c.setAttribute("data-character-id",o),console.log("📖 [打开X资料] 加载关系数据，关系数:",(s.relationships||[]).length),we(s.relationships||[]);const P=document.getElementById("character-x-profile-modal");P&&(P.style.display="block")}catch(n){c.handleError(n,"打开角色X资料")}}function ue(){const n=document.getElementById("character-x-profile-modal");n&&(n.style.display="none")}function he(){fe()}function fe(){const n=document.getElementById("character-x-bio"),e=document.getElementById("character-bio-count");n&&e&&(e.textContent=n.value.length);const t=document.getElementById("character-real-name"),o=document.getElementById("character-real-name-count");t&&o&&(o.textContent=t.value.length)}async function be(t){t.preventDefault();const o=document.getElementById("character-x-profile-form");if(!o)return void mn("表单元素未找到","error");const a=o.getAttribute("data-character-id");if(!a)return void mn("角色ID未找到","error");const i=(n,e="")=>{const t=document.getElementById(n);return t?t.value.trim():e},r=(n,e=!1)=>{const t=document.getElementById(n);return t?t.checked:e},s=i("character-x-name"),l=i("character-x-handle"),c=i("character-x-avatar-url"),d=c||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",p=r("character-x-verified"),g=i("character-x-cover-url")||"https://i.postimg.cc/qRzMB6nQ/default-cover.jpg",m=i("character-tag1-icon"),x=i("character-custom-tag1"),u=document.getElementById("character-tag1-color"),h=u?u.value:"#71767b",f=i("character-tag2-icon"),b=i("character-custom-tag2"),v=document.getElementById("character-tag2-color"),y=v?v.value:"#71767b",w=i("character-following-count"),k=i("character-followers-count"),$=i("character-x-bio"),C=i("character-public-identity"),I=r("character-show-real-name"),S=i("character-real-name"),M=r("character-auto-message-enabled"),T=parseInt(i("character-auto-message-interval"))||60;if(s)if(l)if(s.length>50)mn("X用户名不能超过50个字符","error");else if(l.length>15)mn("X句柄不能超过15个字符","error");else if($&&$.length>160)mn("X简介不能超过160个字符","error");else if(I&&S&&S.length>50)mn("真实姓名不能超过50个字符","error");else{if(I&&!S&&mn("建议填写真实姓名","warning"),M){if(T<10)return void mn("自动发消息间隔不能少于10秒","error");if(T>3600)return void mn("自动发消息间隔不能超过3600秒","error")}if(c)try{new URL(c)}catch(n){mn("头像URL格式无效，将使用默认头像","warning")}try{const t=e();console.log("💾 [保存X资料] 开始保存，当前关系数:",ye.length);const o=await t.xCharacterProfiles.get(a),i=o?.userPersona||"";console.log("💾 [保存X资料] 保留现有用户人设，长度:",i.length,"字符"),await t.xCharacterProfiles.put({characterId:a,xName:s,xHandle:l,xAvatar:d,xVerified:p,xCover:g,customTag1:x?{icon:m,text:x,color:h}:null,customTag2:b?{icon:f,text:b,color:y}:null,followingCount:w,followersCount:k,xBio:$,publicIdentity:C,showRealName:I,realName:I?S:"",relationships:JSON.parse(JSON.stringify(ye)),autoMessageEnabled:M,autoMessageInterval:T,userPersona:i,lastUpdated:(new Date).toISOString()}),console.log("✅ [保存X资料] X资料已保存，关系数:",ye.length),mn("X资料已保存","success"),M&&"function"==typeof n.resetAutoMessageTrigger&&(void 0===n.lastAutoMessageTrigger&&(n.lastAutoMessageTrigger={}),n.lastAutoMessageTrigger[a]=Date.now(),console.log(`⏰ 已为角色 ${a} 设置初始触发时间，需等待 ${T}秒 后首次触发`)),Kc(),setTimeout(()=>{Jc()},500);try{const e=`msg_${a}`,o=`messagesList_${vt||"main"}`,i=await t.xAccountProfiles.get(o);if(i&&i.data){const r=i.data,c=r.findIndex(n=>n.id===e);if(-1!==c){r[c].userAvatar=d,r[c].userName=s,r[c].userHandle=l,await t.xAccountProfiles.put({handle:o,name:"messagesList",data:r,updatedAt:(new Date).toISOString()}),console.log(`✅ [保存X资料] 已更新私信列表数据库中角色 ${a} 的信息`);const i=document.getElementById("x-messages-page");i&&"function"==typeof n.loadMessagesList&&("flex"===i.style.display?(await n.loadMessagesList(),console.log("✅ [保存X资料] 私信列表UI已立即刷新")):console.log("✅ [保存X资料] 私信列表将在下次显示时自动刷新"));const p=document.getElementById("x-message-detail-page");if(p&&"flex"===p.style.display&&n.currentMessageConversation&&n.currentMessageConversation.id===e){const n=document.getElementById("message-detail-top-avatar");n&&(n.src=d,console.log("✅ [保存X资料] 已更新详情页顶部头像"));const e=document.getElementById("message-detail-avatar");e&&(e.src=d,console.log("✅ [保存X资料] 已更新详情页大头像"));const t=document.getElementById("message-detail-top-name");t&&(t.textContent=s);const o=document.getElementById("message-detail-name");o&&(o.textContent=s);const a=document.getElementById("message-detail-handle");a&&(a.textContent=l),console.log("✅ [保存X资料] 私信详情页UI已实时更新")}}}}catch(n){console.warn("⚠️ [保存X资料] 刷新私信显示失败（不影响保存）:",n)}ue()}catch(n){console.error("❌ [保存X资料] 保存角色X资料失败:",n),mn("保存失败: "+n.message,"error")}}else mn("X句柄不能为空","error");else mn("X用户名不能为空","error")}let ve=null,ye=[];function we(n){ye=n?JSON.parse(JSON.stringify(n)):[],console.log("📋 [渲染关系列表] 当前关系数:",ye.length);const e=document.getElementById("character-relationships-list");0!==ye.length?e.innerHTML=ye.map(n=>`\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px;">\n <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n <div style="flex: 1;">\n <div style="color: #fff; font-weight: 600; font-size: 14px; margin-bottom: 4px;">\n ${n.npcName} <span style="color: #71767b; font-weight: normal;">${n.npcHandle}</span>\n </div>\n <div style="color: var(--x-accent); font-size: 12px; background-color: rgba(29,155,240,0.1); padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 6px;">\n ${n.relationshipType}\n </div>\n </div>\n <div style="display: flex; gap: 8px;">\n <button onclick="editRelationship('${n.id}')"\n style="background: none; border: none; color: var(--x-accent); cursor: pointer; padding: 4px 8px; font-size: 12px;">\n 编辑\n </button>\n <button onclick="deleteRelationship('${n.id}')"\n style="background: none; border: none; color: #f4212e; cursor: pointer; padding: 4px 8px; font-size: 12px;">\n 删除\n </button>\n </div>\n </div>\n ${n.description?`<div style="color: #71767b; font-size: 12px; line-height: 1.4;">${n.description}</div>`:""}\n </div>\n `).join(""):e.innerHTML='\n <div style="text-align: center; color: #71767b; font-size: 13px; padding: 20px;">\n 暂无绑定关系，点击上方"添加关系"按钮开始绑定NPC\n </div>\n '}function ke(){document.getElementById("relationship-modal").style.display="none",ve=null}function $e(){const n=document.getElementById("relationship-description");document.getElementById("relationship-desc-count").textContent=n.value.length}async function Ce(){const n=document.getElementById("character-x-profile-form").getAttribute("data-character-id");if(!n)throw console.error("❌ [保存关系] 无法获取角色ID"),new Error("无法获取角色ID，保存失败");try{const t=e(),o=await t.xCharacterProfiles.get(n);if(!o)throw console.error("❌ [保存关系] 未找到角色资料:",n),new Error("未找到角色资料");o.relationships=JSON.parse(JSON.stringify(ye)),await t.xCharacterProfiles.put(o),console.log("✅ [保存关系] 关系已保存到数据库，当前关系数:",o.relationships.length)}catch(n){throw console.error("❌ [保存关系] 保存关系到数据库失败:",n),n}}async function Ie(n){n.preventDefault();const e=document.getElementById("relationship-npc-name").value.trim(),t=document.getElementById("relationship-npc-handle").value.trim(),o=document.getElementById("relationship-type").value,a=document.getElementById("relationship-description").value.trim();if(!e)return void mn("NPC名称不能为空","error");if(!t)return void mn("NPC句柄不能为空","error");const i=t.startsWith("@")?t:`@${t}`;try{if(ve){const n=ye.findIndex(n=>n.id===ve);-1!==n&&(ye[n]={...ye[n],npcName:e,npcHandle:i,relationshipType:o,description:a,updatedAt:(new Date).toISOString()})}else{const n={id:"rel_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),npcName:e,npcHandle:i,relationshipType:o,description:a,createdAt:(new Date).toISOString()};ye.push(n)}await Ce(),we(ye),ke(),mn(ve?"关系已更新":"关系已添加","success")}catch(n){console.error("保存关系失败:",n),mn("保存失败","error")}}let Se,Me={characters:[],links:[]},Te=null;function Ae(){const n=document.getElementById("x-relationship-toggle"),e=n?.querySelector(".toggle-circle");if(!n||!e)return;ee.characterRelationship?.enabled||!1?(n.style.backgroundColor="var(--x-accent)",e.style.left="22px"):(n.style.backgroundColor="#333",e.style.left="2px")}async function Ee(){try{const n=e(),o=`xCharacterRelationships_${vt||"main"}`,a=await n.xCharacterRelationships.get(o),i=ee.boundCharacters||[],r=t(),s=(await r.chats.toArray()).filter(n=>!n.isGroup&&i.includes(n.id)).map(n=>({id:n.id,name:n.name,avatar:n.settings?.aiAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}));if(a&&a.data){Me=a.data;const n=new Set(Me.characters.map(n=>n.id)),e=new Set(s.map(n=>n.id));s.forEach(e=>{n.has(e.id)||(Me.characters.push(e),console.log("➕ 新增角色到关系册:",e.name))}),Me.characters=Me.characters.filter(n=>{const t=e.has(n.id);return t||(console.log("➖ 从关系册移除角色:",n.name),Me.links=Me.links.filter(e=>e.charA!==n.id&&e.charB!==n.id)),t}),Me.characters.forEach(n=>{const e=s.find(e=>e.id===n.id);e&&(n.name=e.name,n.avatar=e.avatar)})}else Me.characters=s,Me.links=[];console.log("✅ 已加载角色关系数据:",{"角色数":Me.characters.length,"关系数":Me.links.length,"角色列表":Me.characters.map(n=>n.name)})}catch(n){console.error("❌ 加载关系数据失败:",n)}}function ze(){const n=document.getElementById("relationship-preview-canvas"),e=document.getElementById("relationship-preview-placeholder"),t=document.getElementById("relationship-stats");if(!n)return;const o=Me.links?.length||0,a=Me.characters?.length||0,i=Me.characters||[],r=Me.links||[];if(a>0){e.style.display="none",t.style.display="block",document.getElementById("relationship-character-count").textContent=a,document.getElementById("relationship-link-count").textContent=o;const s=n.getContext("2d");s.clearRect(0,0,n.width,n.height);const l=getComputedStyle(document.documentElement),c=l.getPropertyValue("--x-accent").trim()||"#1d9bf0",d=l.getPropertyValue("--x-bg-primary").trim()||"#000",p=l.getPropertyValue("--x-text-primary").trim()||"#fff",g=n.width/2,m=n.height/2,x=Math.min(n.width,n.height)/2-20;i.forEach((n,e)=>{const t=e/i.length*Math.PI*2-Math.PI/2;n.previewX=g+x*Math.cos(t),n.previewY=m+x*Math.sin(t)}),s.strokeStyle=c,s.lineWidth=1.5,r.forEach(n=>{const e=i.find(e=>e.id===n.charA),t=i.find(e=>e.id===n.charB);e&&t&&(s.beginPath(),s.moveTo(e.previewX,e.previewY),s.lineTo(t.previewX,t.previewY),s.stroke())}),i.forEach(n=>{s.beginPath(),s.arc(n.previewX,n.previewY,15,0,2*Math.PI),s.fillStyle=c,s.fill(),s.strokeStyle=d,s.lineWidth=2,s.stroke(),s.fillStyle=p,s.font="bold 10px sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText(n.name.charAt(0),n.previewX,n.previewY)})}else e.style.display="block",t.style.display="none"}function Be(){clearTimeout(Se),Se=setTimeout(()=>{const n=document.getElementById("character-relationship-graph-modal");n&&"none"!==n.style.display&&(Oe(),Fe())},300)}function Le(n){"Escape"===n.key&&je&&(je=!1,Ue=null,Fe(),mn("已取消选择","info"),console.log("📍 已退出角色选择模式"))}function Pe(e){if(e&&e.target!==e.currentTarget)return;const t=document.getElementById("character-relationship-graph-modal");t&&(t.style.display="none",document.body.style.overflow="auto",je=!1,Ue=null,n.removeEventListener("resize",Be),n.removeEventListener("orientationchange",Be),n.removeEventListener("keydown",Le))}let De=!1,Ne=null,Re=0,He=0,je=!1,Ue=null;function Oe(){const n=document.getElementById("relationship-graph-canvas");if(!n)return;const e=n.parentElement;n.width=e.clientWidth,n.height=e.clientHeight,n.onmousedown=Xe,n.onmousemove=Ve,n.onmouseup=Ye,n.onclick=Ze,n.addEventListener("touchstart",qe,{passive:!1}),n.addEventListener("touchmove",Ge,{passive:!1}),n.addEventListener("touchend",Qe,{passive:!1})}const _e={};function Fe(){const e=document.getElementById("relationship-graph-canvas"),t=document.getElementById("graph-empty-state");if(!e)return;const o=e.getContext("2d"),a=Me.characters||[],i=Me.links||[],r=getComputedStyle(document.documentElement),s=r.getPropertyValue("--x-accent").trim()||"#1d9bf0",l=r.getPropertyValue("--x-bg-primary").trim()||"#000",c=(r.getPropertyValue("--x-bg-secondary").trim(),r.getPropertyValue("--x-text-primary").trim()||"#fff"),d=l.includes("#000")||l.includes("0, 0, 0")?"rgba(0, 0, 0, 0.7)":"rgba(255, 255, 255, 0.85)";if(document.getElementById("graph-character-count").textContent=`${a.length} 角色`,document.getElementById("graph-link-count").textContent=`${i.length} 关系`,0===a.length)return void(t.style.display="block");if(t.style.display="none",o.clearRect(0,0,e.width,e.height),je){const n=Ue?"请点击第二个角色":"请点击第一个角色";o.fillStyle=s,o.font="bold 16px sans-serif",o.textAlign="center",o.fillText(n,e.width/2,30),o.fillStyle=c,o.font="12px sans-serif",o.fillText("(按 ESC 键取消)",e.width/2,50)}const p=e.width/2,g=e.height/2,m=Math.min(e.width,e.height)/3;a.forEach((n,e)=>{if(void 0===n.x||void 0===n.y){const t=e/a.length*Math.PI*2-Math.PI/2;n.x=p+m*Math.cos(t),n.y=g+m*Math.sin(t)}}),i.forEach(e=>{const t=a.find(n=>n.id===e.charA),i=a.find(n=>n.id===e.charB);if(t&&i){o.beginPath(),o.moveTo(t.x,t.y),o.lineTo(i.x,i.y),o.strokeStyle=s,o.lineWidth=2,o.stroke();const a=(t.x+i.x)/2,r=(t.y+i.y)/2,l=n.innerWidth<768,c=l?70:80,p=l?30:35,g=l?"10px":"11px";o.fillStyle=d,o.fillRect(a-c/2,r-p/2,c,p),o.fillStyle=s,o.font=g+" sans-serif",o.textAlign="center";const m=l?12:15;o.fillText(e.relationAtoB||"关系",a,r-m/2),o.fillText(e.relationBtoA||"关系",a,r+m/2)}});const x=n.innerWidth<768,u=x?25:35,h=u-2;a.forEach(n=>{const e=je&&Ue===n.id;if(e&&(o.beginPath(),o.arc(n.x,n.y,u+5,0,2*Math.PI),o.strokeStyle=s,o.lineWidth=3,o.stroke()),o.beginPath(),o.arc(n.x,n.y,u,0,2*Math.PI),o.fillStyle=e?"#FFA500":s,o.fill(),o.strokeStyle=l,o.lineWidth=2,o.stroke(),n.avatar)if(_e[n.avatar]){const e=_e[n.avatar];o.save(),o.beginPath(),o.arc(n.x,n.y,h,0,2*Math.PI),o.closePath(),o.clip(),o.drawImage(e,n.x-h,n.y-h,2*h,2*h),o.restore()}else{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{_e[n.avatar]=e,Fe()},e.onerror=()=>{o.fillStyle=c,o.font="bold 14px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(n.name.charAt(0),n.x,n.y)},e.src=n.avatar,o.fillStyle=c,o.font="bold 14px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(n.name.charAt(0),n.x,n.y)}else o.fillStyle=c,o.font="bold 14px sans-serif",o.textAlign="center",o.textBaseline="middle",o.fillText(n.name.charAt(0),n.x,n.y);o.fillStyle=c,o.font=x?"bold 11px sans-serif":"bold 12px sans-serif",o.textAlign="center",o.textBaseline="top",o.fillText(n.name,n.x,n.y+u+10),n.radius=u})}function Xe(n){const e=n.target,t=e.getBoundingClientRect(),o=n.clientX-t.left,a=n.clientY-t.top,i=Me.characters||[];for(const n of i){const t=o-n.x,i=a-n.y,r=n.radius||35;if(Math.sqrt(t*t+i*i)<r)return De=!0,Ne=n.id,Re=t,He=i,void(e.style.cursor="grabbing")}}function qe(n){n.preventDefault();const e=n.target.getBoundingClientRect(),t=n.touches[0],o=t.clientX-e.left,a=t.clientY-e.top;We=Date.now(),Je=o,Ke=a;const i=Me.characters||[];for(const n of i){const e=o-n.x,t=a-n.y,i=n.radius||35;if(Math.sqrt(e*e+t*t)<i)return Ne=n.id,Re=e,void(He=t)}}function Ve(n){const e=n.target,t=e.getBoundingClientRect(),o=n.clientX-t.left,a=n.clientY-t.top,i=Me.characters||[];if(De&&Ne){const n=i.find(n=>n.id===Ne);n&&(n.x=o-Re,n.y=a-He,Fe())}else{const n=i.find(n=>{const e=o-n.x,t=a-n.y,i=n.radius||35;return Math.sqrt(e*e+t*t)<i});e.style.cursor=n?"grab":"default"}}function Ge(n){n.preventDefault();const e=n.target.getBoundingClientRect(),t=n.touches[0],o=t.clientX-e.left,a=t.clientY-e.top,i=Me.characters||[];if(Ne&&!De){const n=o-Je,e=a-Ke;Math.sqrt(n*n+e*e)>10&&(De=!0,console.log("📍 开始拖拽角色"))}if(De&&Ne){const n=i.find(n=>n.id===Ne);n&&(n.x=o-Re,n.y=a-He,Fe())}}function Ye(n){De&&(De=!1,Ne=null,n.target.style.cursor="default")}let We=0,Je=0,Ke=0;function Qe(n){n.preventDefault();const e=De;if(De?(De=!1,Ne=null):Ne&&(Ne=null),!e&&n.changedTouches&&n.changedTouches.length>0){const e=n.target.getBoundingClientRect(),t=n.changedTouches[0],o=t.clientX-e.left,a=t.clientY-e.top,i=Me.characters||[],r=Me.links||[];if(je){for(const n of i){const e=o-n.x,t=a-n.y,i=n.radius||35;if(Math.sqrt(e*e+t*t)<i)return void nt(n)}return}for(const n of r){const e=i.find(e=>e.id===n.charA),t=i.find(e=>e.id===n.charB);if(e&&t){if(et(o,a,e.x,e.y,t.x,t.y)<20)return void tt(n)}}}}function Ze(n){if(De)return;const e=n.target.getBoundingClientRect(),t=n.clientX-e.left,o=n.clientY-e.top,a=Me.characters||[],i=Me.links||[];if(je)for(const n of a){const e=t-n.x,a=o-n.y,i=n.radius||35;if(Math.sqrt(e*e+a*a)<i)return void nt(n)}else for(const n of i){const e=a.find(e=>e.id===n.charA),i=a.find(e=>e.id===n.charB);if(e&&i){if(et(t,o,e.x,e.y,i.x,i.y)<15)return void tt(n)}}}function nt(e){if(Ue){if(Ue===e.id)return void mn("请选择不同的角色","error");if(Me.links.find(n=>n.charA===Ue&&n.charB===e.id||n.charA===e.id&&n.charB===Ue))return mn("这两个角色已存在关系，请直接点击连线编辑","error"),je=!1,Ue=null,void Fe();console.log("✅ 已选择第二个角色:",e.name);const t={id:"link_"+Date.now(),charA:Ue,charB:e.id,relationAtoB:"",relationBtoA:"",story:""};Me.links.push(t),je=!1,Ue=null,Fe(),at(),n.characterRelationshipData=Me,setTimeout(()=>{tt(t)},100)}else Ue=e.id,console.log("✅ 已选择第一个角色:",e.name),mn(`已选择 ${e.name}，请点击第二个角色`,"info"),Fe()}function et(n,e,t,o,a,i){const r=a-t,s=i-o,l=r*r+s*s;let c,d,p=-1;0!==l&&(p=((n-t)*r+(e-o)*s)/l),p<0?(c=t,d=o):p>1?(c=a,d=i):(c=t+p*r,d=o+p*s);const g=n-c,m=e-d;return Math.sqrt(g*g+m*m)}function tt(n){Te=n.id;const e=Me.characters||[],t=e.find(e=>e.id===n.charA),o=e.find(e=>e.id===n.charB);if(!t||!o)return;document.getElementById("char-a-name").textContent=t.name,document.getElementById("char-b-name").textContent=o.name,document.getElementById("char-a-to-b-label").textContent=`${t.name} 是 ${o.name} 的：`,document.getElementById("char-b-to-a-label").textContent=`${o.name} 是 ${t.name} 的：`,document.getElementById("relationship-a-to-b").value=n.relationAtoB||"",document.getElementById("relationship-b-to-a").value=n.relationBtoA||"",document.getElementById("relationship-story").value=n.story||"";const a=document.getElementById("edit-relationship-detail-modal");a&&(a.style.display="block")}function ot(n){if(n&&n.target!==n.currentTarget)return;const e=document.getElementById("edit-relationship-detail-modal");e&&(e.style.display="none"),Te=null}function at(){const n=document.getElementById("relationship-links-list");if(!n)return;const e=Me.links||[],t=Me.characters||[];0!==e.length?n.innerHTML=e.map(n=>{const e=t.find(e=>e.id===n.charA),o=t.find(e=>e.id===n.charB);if(!e||!o)return"";const a=n.story?`\n <div style="color: #71767b; font-size: 11px; margin-top: 6px; padding-top: 6px; border-top: 1px solid #2f3336;">\n ${n.story.length>50?n.story.substring(0,50)+"...":n.story}\n </div>\n `:"";return`\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s; " onclick="openEditRelationshipDetailModal(window.characterRelationshipData.links.find(l => l.id === '${n.id}'))"\n onmouseover="this.style.backgroundColor='#2a2a2a'"\n onmouseout="this.style.backgroundColor='#1a1a1a'">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">\n <div style="display: flex; align-items: center; gap: 8px;">\n <span style="color: #fff; font-weight: 600; font-size: 14px;">${e.name}</span>\n <span style="color: #71767b;">⇆</span>\n <span style="color: #fff; font-weight: 600; font-size: 14px;">${o.name}</span>\n </div>\n </div>\n <div style="display: flex; gap: 12px; font-size: 12px;">\n <div style="color: var(--x-accent);">${e.name}: ${n.relationAtoB||"(未设置)"}</div>\n <div style="color: var(--x-accent);">${o.name}: ${n.relationBtoA||"(未设置)"}</div>\n </div>\n ${a}\n </div>\n `}).join(""):n.innerHTML='<div style="color: #71767b; text-align: center; padding: 20px;">暂无关系</div>'}let it=null;function rt(){const n=document.getElementById("x-npc-toggle"),e=n.querySelector(".toggle-circle");ee.npcBinding?(n.style.backgroundColor="var(--x-accent)",e.style.left="22px"):(n.style.backgroundColor="#333",e.style.left="2px")}async function st(){try{const n=e(),t="xNPCs_global",o=await n.xNPCs.get(t),a=vt||"main",i=(o?.npcs||[]).filter(n=>n.boundUsers&&n.boundUsers.includes(a)),r=document.getElementById("npcs-list");if(0===i.length)return void(r.innerHTML='<p style="color: #71767b; font-size: 14px; text-align: center; padding: 20px 0;">暂无绑定到此账号的NPC，点击上方按钮创建</p>');r.innerHTML=i.map(n=>`\n <div style="background-color: #0a0a0a; border: 1px solid #2f3336; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; ">\n <img src="${n.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}"\n style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;"\n alt="${n.name}">\n <div style="flex: 1; min-width: 0;">\n <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 2px;">${n.name}</div>\n <div style="color: #71767b; font-size: 14px;">${n.handle}</div>\n <div style="color: #71767b; font-size: 13px; margin-top: 4px;">\n 绑定用户: ${n.boundUsers?.length||0}个\n </div>\n </div>\n <div style="display: flex; gap: 8px; flex-shrink: 0;">\n <button onclick="editNPC('${n.id}')" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; " onmouseover="this.style.backgroundColor='#1a8cd8'" onmouseout="this.style.backgroundColor='var(--x-accent)'">\n 编辑\n </button>\n <button onclick="deleteNPC('${n.id}')" style="background-color: #f4212e; color: #fff; border: none; border-radius: 15px; padding: 6px 12px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: all 0.2s; " onmouseover="this.style.backgroundColor='#d11a29'" onmouseout="this.style.backgroundColor='#f4212e'">\n 删除\n </button>\n </div>\n </div>\n `).join("")}catch(n){console.error("加载NPC列表失败:",n),document.getElementById("npcs-list").innerHTML='<p style="color: #f4212e; font-size: 14px; text-align: center; padding: 20px 0;">加载失败，请重试</p>'}}async function lt(n=[]){try{const t=e(),o=await t.xAccountList.toArray(),a=document.getElementById("npc-bind-users");if(0===o.length)return void(a.innerHTML='<p style="color: #71767b; font-size: 14px; text-align: center; padding: 10px 0;">暂无账号</p>');a.innerHTML=o.map(e=>{const t=n.includes(e.accountId);return`\n <label style="display: flex; align-items: center; gap: 12px; padding: 8px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <input\n type="checkbox"\n value="${e.accountId}"\n ${t?"checked":""}\n style="width: 16px; height: 16px; accent-color: var(--x-accent); cursor: pointer;">\n <img src="${e.avatar}" style="width: 32px; height: 32px; border-radius: 50%;" alt="${e.name}">\n <div style="flex: 1;">\n <div style="color: #fff; font-size: 14px; font-weight: 600;">${e.name}</div>\n <div style="color: #71767b; font-size: 13px;">账号ID: ${e.accountId}</div>\n </div>\n </label>\n `}).join("")}catch(n){console.error("加载用户列表失败:",n)}}function ct(n){n&&n.target!==n.currentTarget||(document.getElementById("npc-edit-modal").style.display="none",document.body.style.overflow="auto",it=null)}function dt(){const e=n.userProfileData,t=document.getElementById("top-bar-avatar");t&&(t.src=e.avatar);const o={"x-profile-header-name":e.name,"x-profile-user-name":e.name,"x-profile-user-handle":e.handle,"x-profile-bio":e.bio,"x-profile-following-count":e.following,"x-profile-followers-count":e.followers};Object.entries(o).forEach(([n,e])=>{const t=document.getElementById(n);t&&(t.textContent=e)});const a=document.getElementById("x-profile-tag1"),i=document.getElementById("x-profile-tag1-icon"),r=document.getElementById("x-profile-tag2"),s=document.getElementById("x-profile-tag2-icon");a&&(a.textContent=e.customTag1,a.style.color=e.customTag1Color||"#71767b"),i&&(i.textContent=e.customTag1Icon||"✨"),r&&(r.textContent=e.customTag2,r.style.color=e.customTag2Color||"#71767b"),s&&(s.textContent=e.customTag2Icon||"📅");const l=document.getElementById("x-profile-main-avatar");l&&(l.src=e.avatar);const c=document.getElementById("x-profile-cover-image");c&&(c.src=e.coverImage),pt();const d=document.querySelector("#comment-input-area img, .comment-input-area img");d&&(d.src=e.avatar);const p=document.getElementById("comment-user-avatar");p&&(p.src=e.avatar);const g=document.getElementById("detail-comment-user-avatar");g&&(g.src=e.avatar);document.querySelectorAll(".reply-user-avatar").forEach(n=>{n.src=e.avatar});const m=document.getElementById("compose-user-avatar");m&&(m.src=e.avatar),console.log("✅ UI已更新，当前用户资料:",e.name)}function pt(){const n=document.getElementById("x-profile-verified-badge");if(!n)return;const e=te.verificationType||"none";if("none"===e)return void(n.style.display="none");n.style.display="inline-block";let t="#1d9bf0",o="";switch(e){case"verified":default:t="#1d9bf0",o="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z";break;case"couple":t=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff",o="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z";break;case"married":t=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff",o="M12 4c4.42 0 8 3.58 8 8s-3.58 8-8 8-8-3.58-8-8 3.58-8 8-8zm0 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z";break;case"vip":t=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff",o="M12 3l6 6-6 6-6-6 6-6zm0 2.83L8.83 9 12 12.17 15.17 9 12 5.83z"}n.style.fill=t;const a=n.querySelector("path");if(a&&a.setAttribute("d",o),"couple"===e&&te.coupleCharacterName)n.setAttribute("title",`情侣认证 - 与${te.coupleCharacterName}是情侣关系`);else{const t={verified:"已认证账户",married:"已婚认证",vip:"VIP认证",couple:"情侣认证"};n.setAttribute("title",t[e]||"已认证账户")}}function gt(n){te.avatar=n;["#top-bar-avatar","#x-profile-main-avatar",".comment-input-area img","#comment-user-avatar","#detail-comment-user-avatar","#compose-user-avatar","#live-page-user-avatar"].forEach(e=>{const t=document.querySelector(e);t&&(t.src=n)}),document.querySelectorAll(".reply-user-avatar").forEach(e=>{e.src=n}),document.querySelectorAll('.comment-item img[alt="我"], .comment-item img[alt="Your avatar"]').forEach(e=>{e.src=n})}let mt=null;function xt(){mt&&clearInterval(mt),console.log("📊 [粉丝数浮动] 系统已启动"),setTimeout(()=>{ut()},5e3);const n=()=>{const e=60*(10+20*Math.random())*1e3;console.log(`📊 [粉丝数浮动] 下次触发时间: ${(e/6e4).toFixed(1)}分钟后`),mt=setTimeout(()=>{ut(),n()},e)};n()}async function ut(){try{console.log("📊 [粉丝数浮动] 开始检查所有账户..."),await async function(){try{const t=e(),o=`userTweets_${vt||"main"}`,a=await t.xUserTweets.get(o),i=a?.tweets?.slice(0,3)||[],r=n.userProfileData.followers||"0",s=ht(r),l=bt({publicIdentity:n.userProfileData.publicIdentity||"",bio:n.userProfileData.bio||"",recentTweets:i,currentFollowers:s});if(0===l)return void console.log("📊 [用户粉丝数] 本次无变化");const c=ft(Math.max(0,s+l),r);n.userProfileData.followers=c,n.userProfileData.followersCount=c,n.userProfileData.lastUpdated=(new Date).toISOString(),await t.xUserProfile.put({id:vt||"main",...n.userProfileData});const d=document.getElementById("x-profile-followers-count");if(d&&(d.textContent=c),console.log(`📊 [用户粉丝数] ${l>0?"+":""}${l} (${r} → ${c})`),Math.abs(l)>=50){Rl({title:"X",message:"en"===Hn?`Followers ${l>0?"increased":"decreased"} by ${Math.abs(l)}`:`粉丝数${l>0?"增加":"减少"}了 ${Math.abs(l)}`,leftIcon:"x",duration:3e3})}}catch(n){console.error("❌ [用户粉丝数] 更新失败:",n)}}(),await async function(){try{const n=e(),t=await n.xCharacterProfiles.toArray();if(0===t.length)return void console.log("📊 [角色粉丝数] 无已绑定角色");console.log(`📊 [角色粉丝数] 检查 ${t.length} 个角色`);for(const e of t){if(!e.followersCount||""===e.followersCount)continue;const t=e.xHandle.replace("@",""),o=await n.xAccountProfiles.get(t),a=o?.tweets?.slice(0,3)||[],i=e.followersCount,r=ht(i),s=bt({publicIdentity:e.publicIdentity||"",bio:e.xBio||"",recentTweets:a,currentFollowers:r});if(0===s)continue;const l=ft(Math.max(0,r+s),i);e.followersCount=l,await n.xCharacterProfiles.put(e),console.log(`📊 [角色粉丝数] ${e.xName}: ${s>0?"+":""}${s} (${i} → ${l})`),o&&(o.accountInfo.followersCount=l,await n.xAccountProfiles.put(o),console.log(` └─ 已同步到账户主页 ${t}`))}}catch(n){console.error("❌ [角色粉丝数] 更新失败:",n)}}(),console.log("✅ [粉丝数浮动] 所有账户粉丝数已更新")}catch(n){console.error("❌ [粉丝数浮动] 触发失败:",n)}}function ht(n){if(!n||""===n)return 0;const e=n.toString().toLowerCase().trim();if(e.includes("k")){const n=parseFloat(e.replace("k",""));return Math.round(1e3*n)}if(e.includes("w")){const n=parseFloat(e.replace("w",""));return Math.round(1e4*n)}if(e.includes("m")){const n=parseFloat(e.replace("m",""));return Math.round(1e6*n)}const t=parseInt(e);return isNaN(t)?0:t}function ft(n,e=""){if(0===n)return"0";const t=e.toString().toLowerCase(),o=t.includes("k"),a=t.includes("w"),i=t.includes("m");if(a){if(n>=1e4){const e=n/1e4;return e%1==0?`${Math.round(e)}w`:`${e.toFixed(1)}w`}return n.toString()}if(i){if(n>=1e6){const e=n/1e6;return e%1==0?`${Math.round(e)}m`:`${e.toFixed(1)}m`}if(n>=1e3){const e=n/1e3;return e%1==0?`${Math.round(e)}k`:`${e.toFixed(1)}k`}return n.toString()}if(o||!a){if(n>=1e6){const e=n/1e6;return e%1==0?`${Math.round(e)}m`:`${e.toFixed(1)}m`}if(n>=1e3){const e=n/1e3;return e%1==0?`${Math.round(e)}k`:`${e.toFixed(1)}k`}}return n.toString()}function bt({publicIdentity:n,bio:e,recentTweets:t,currentFollowers:o}){const a=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(n+" "+e);let i=0;if(t.length>0){let n=0;t.forEach(e=>{const t=e.stats||{},o=t.likes||0,a=t.retweets||0,i=t.comments||0,r=t.views||0,s=r>0?(o+2*a+3*i)/r:0;s>.1?n+=1:s>.05?n+=.5:s>.02?n+=0:n-=.5}),i=n/t.length}console.log(` 📊 推文质量评分: ${i.toFixed(2)} (${t.length}条推文)`);let r=0,s=1;s=i>.5?Math.random()<.8?1:-1:i>0?Math.random()<.7?1:-1:i>-.5?Math.random()<.5?1:-1:Math.random()<.3?1:-1,r=a?t.length>0?100+400*Math.random():50+150*Math.random():t.length>0?20+80*Math.random():5+25*Math.random();if(r*=.5+.8*Math.abs(i),o>1e4?r*=1.5:o>5e3&&(r*=1.2),Math.random()>.6)return console.log(" 📊 本次随机跳过浮动"),0;const l=Math.round(r*s);return console.log(` 📊 浮动计算: ${a?"高曝光":"普通"}身份, 方向${s>0?"↑":"↓"}, 幅度${Math.abs(l)}`),l}n.triggerAutoMessageAfterAway=async function(n){try{console.log("⏰ [离开后自动消息] 开始触发，messageId:",n);const t=e(),o=`messageConversation_${vt||"main"}_${n}`,a=await t.xAccountProfiles.get(o);if(!a)return void console.log("⚠️ [离开后自动消息] 未找到对话数据");if(!a.isAway)return void console.log("⚠️ [离开后自动消息] 对话已不再处于离开状态");const i=new Date;if(i<new Date(a.awayUntil))return void console.log("⚠️ [离开后自动消息] 离开时间尚未结束");a.isAway=!1,delete a.awayUntil,delete a.awayDuration,await t.xAccountProfiles.put(a),console.log("✅ [离开后自动消息] 已清除离开状态");if(!(n&&n.startsWith("msg_")&&"msg_001"!==n))return void console.log("⚠️ [离开后自动消息] 不是绑定角色，跳过");let r="未知",s="@unknown",l="";try{const e=n.replace("msg_",""),o=await t.xCharacterProfiles.get(e);o?(r=o.xName,s=o.xHandle,l=o.xAvatar,console.log(`✅ [离开后自动消息] 从xCharacterProfiles获取角色信息: ${r}`)):a.data&&a.data.senderProfile?(r=a.data.senderProfile.name||"未知",s=a.data.senderProfile.handle||"@unknown",l=a.data.senderProfile.avatar||"",console.log(`✅ [离开后自动消息] 从senderProfile获取角色信息: ${r}`)):a.data&&a.data.user&&(r=a.data.user.name||"未知",s=a.data.user.handle||"@unknown",l=a.data.user.avatar||"",console.log(`✅ [离开后自动消息] 从user获取角色信息: ${r}`))}catch(n){console.error("❌ [离开后自动消息] 获取角色信息失败:",n)}const c={id:n,user:{name:r,handle:s,avatar:l}};console.log("📤 [离开后自动消息] 开始生成AI主动消息");const d=await vl(c,!0,{isAutoMessage:!0,timeSinceLastMessage:60*a.awayDuration||3600,isAwayReturn:!0});if(d&&d.length>0){const e=await t.xAccountProfiles.get(o);e&&e.data&&e.data.messages&&(e.data.messages.push(...d),await t.xAccountProfiles.put(e),console.log("✅ [离开后自动消息] AI消息已保存"));const a=`messagesList_${vt||"main"}`,i=await t.xAccountProfiles.get(a);if(i&&i.data){const e=i.data,o=e.findIndex(e=>e.id===n);-1!==o&&(e[o].unread=!0,e[o].unreadCount=(e[o].unreadCount||0)+d.length,await t.xAccountProfiles.put({handle:a,name:"messagesList",data:e,updatedAt:(new Date).toISOString()}),dc=e,Hl(c.user.name,c.user.avatar,d.length),vn("messages"),console.log("✅ [离开后自动消息] 已标记为未读并显示提醒"))}}else console.log("⚠️ [离开后自动消息] AI未生成消息")}catch(n){console.error("❌ [离开后自动消息] 触发失败:",n)}},n.currentAccountId=n.currentAccountId||"main";let vt=n.currentAccountId;async function yt(){const n=await async function(){try{const n=e(),t=await n.xAccountList.orderBy("createdAt").toArray(),o=await n.xActiveAccount.get("current");if(0===t.length){const e={accountId:"main",name:te.name||"我",avatar:te.avatar||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",createdAt:(new Date).toISOString(),isActive:!0};return await n.xAccountList.put(e),await n.xActiveAccount.put({id:"current",accountId:"main"}),[e]}return t.forEach(n=>{n.isActive=o&&o.accountId===n.accountId}),t}catch(n){return console.error("获取账户列表失败:",n),[]}}(),t=document.createElement("div");t.id="account-manager-modal",t.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px); ",t.innerHTML=`\n <div style="background-color: #1a1a1a; border-radius: 16px; width: 90%; max-width: 480px; max-height: 70vh; overflow-y: auto; border: 1px solid #333; position: relative; ">\n\n <div style="padding: 20px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background-color: #1a1a1a; z-index: 10; ">\n <div>\n <h3 style="margin: 0; color: #fff; font-size: 20px; font-weight: 700;">账号管理</h3>\n <p style="margin: 4px 0 0; color: #71767b; font-size: 14px;">管理你的多个X账户</p>\n </div>\n <button onclick="closeAccountManager()" style="background: transparent; border: none; color: #71767b; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n </div>\n\n <div style="padding: 20px;">\n <div id="accounts-list" style="margin-bottom: 20px;">\n ${await async function(n){if(0===n.length)return'\n <div style="text-align: center; color: #71767b; padding: 40px 20px;">\n <div style="font-size: 16px; margin-bottom: 8px;">暂无账户</div>\n <div style="font-size: 14px;">创建你的第一个账户</div>\n </div>\n ';return n.map(n=>`\n <div style="border: 2px solid ${n.isActive?"var(--x-accent)":"#333"}; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; background-color: ${n.isActive?"color-mix(in srgb, var(--x-accent) , 0.05)":"transparent"}; " onclick="switchAccount('${n.accountId}')"\n onmouseover="if (!${n.isActive}) this.style.borderColor='#536471'"\n onmouseout="if (!${n.isActive}) this.style.borderColor='#333'">\n <div style="display: flex; align-items: center; gap: 12px;">\n <img src="${n.avatar}" style="width: 48px; height: 48px; border-radius: 50%;" alt="${n.name}">\n <div style="flex: 1;">\n <div style="color: #fff; font-size: 16px; font-weight: 700; margin-bottom: 4px;">\n ${n.name}\n ${n.isActive?'<span style="color: var(--x-accent); font-size: 12px; margin-left: 8px;">● 当前账户</span>':""}\n </div>\n <div style="color: #71767b; font-size: 14px;">\n 创建于 ${new Date(n.createdAt).toLocaleDateString("zh-CN")}\n </div>\n </div>\n ${n.isActive||"main"===n.accountId?"":`\n <button onclick="event.stopPropagation(); deleteAccount('${n.accountId}')" style="background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'"\n onmouseout="this.style.backgroundColor='transparent'">\n 删除\n </button>\n `}\n </div>\n </div>\n `).join("")}(n)}\n </div>\n\n <button onclick="createNewAccount()" style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 12px; padding: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; " onmouseover="this.style.backgroundColor='#1a8cd8'"\n onmouseout="this.style.backgroundColor='var(--x-accent)'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g>\n </svg>\n 新建账户\n </button>\n </div>\n </div>\n `,document.body.appendChild(t),document.body.style.overflow="hidden",t.addEventListener("click",n=>{n.target===t&&wt()})}function wt(){const n=document.getElementById("account-manager-modal");n&&n.remove(),document.body.style.overflow="auto"}async function kt(t){if(t!==vt)try{yl&&(clearInterval(yl),yl=null,wl=!1);const o=e();await o.xActiveAccount.put({id:"current",accountId:t}),vt=t,n.currentAccountId=t,await Ct(t),await oe(),dt(),gt(te.avatar),"none"!==document.getElementById("x-profile-page").style.display&&$o(),await Ks(),"none"!==document.getElementById("x-askbox-page").style.display&&await Zs();const a=document.getElementById("compose-user-avatar");a&&(a.src=te.avatar),await qn(),await Mt();const i=document.getElementById("x-messages-page");i&&"flex"===i.style.display&&await pc();const r=document.getElementById("x-notifications-page");r&&"flex"===r.style.display&&await bl(),wt(),mn(`已切换到账户：${te.name}`,"success"),console.log("✅ 已切换账户，绑定角色数:",ee.boundCharacters?.length||0)}catch(n){console.error("切换账户失败:",n),mn("切换账户失败","error")}else wt()}async function $t(){try{const t=e();await async function(){try{const n=e();if(!await n.xAccountList.get("main")){const e=await n.xUserProfile.get("main"),t={accountId:"main",name:e?.name||"我",avatar:e?.avatar||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",createdAt:e?.lastUpdated||(new Date).toISOString()};await n.xAccountList.put(t),console.log("已创建默认账户记录")}await n.xActiveAccount.get("current")||(await n.xActiveAccount.put({id:"current",accountId:"main"}),console.log("已设置默认激活账户"))}catch(n){console.error("初始化多账户系统失败:",n)}}();const o=await t.xActiveAccount.get("current");o?(vt=o.accountId,n.currentAccountId=o.accountId):(vt="main",n.currentAccountId="main",await t.xActiveAccount.put({id:"current",accountId:"main"})),console.log("✅ 已加载激活账户:",vt)}catch(e){console.error("加载激活账户失败:",e),vt="main",n.currentAccountId="main"}}async function Ct(t=null){try{const o=e(),a=t||vt||"main",i=await o.xUserProfile.get(a);if(i)Object.assign(n.userProfileData,i);else{console.log("⚠️ 未找到账户资料，使用默认值:",a);const e=qs(a);Object.assign(n.userProfileData,e)}Vs(n.userProfileData),console.log("✅ 已加载用户资料数据:",a),n.userProfileData.knownIdentityCharacters&&n.userProfileData.knownIdentityCharacters.length>0&&console.log("📌 已知身份角色数量:",n.userProfileData.knownIdentityCharacters.length)}catch(e){console.error("❌ 加载用户资料失败，使用默认数据:",e);const t=qs("main");Object.assign(n.userProfileData,t)}}document.addEventListener("click",function(n){const e=document.getElementById("profile-menu-btn"),t=document.getElementById("profile-dropdown-menu");e&&t&&(e.contains(n.target)||t.contains(n.target)||(t.style.display="none"))}),n.clearCurrentAskboxData=async function(){try{const n=e(),t=vt||"main",o=`askbox_${t}`;await n.xAskbox.put({id:o,avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",nickname:"= =",prompt:"请向我匿名提问!waiting...",background:"https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg",answeredQuestions:[]}),await Ks(),"none"!==document.getElementById("x-askbox-page").style.display&&nl(),console.log("✅ 已清空账户提问箱数据:",t),mn("提问箱数据已清空","success")}catch(n){console.error("❌ 清空提问箱数据失败:",n),mn("清空失败: "+n.message,"error")}};let It={accountId:"main",isActivated:!1,balance:0,currency:"USD",transactions:[],activatedAt:null,initialAmount:0,creditScore:100};function St(){const n=document.getElementById("wallet-modal");if(n){const e=n.querySelector("div");e.style.transform="scale(0.9) translateY(20px)",e.style.opacity="0",setTimeout(()=>{n.remove(),document.body.style.overflow="auto"},200)}}async function Mt(){try{const n=e(),t=`wallet_${vt||"main"}`,o=await n.xAccountProfiles.get(t);o&&o.data?(Object.assign(It,o.data),It.accountId=vt||"main"):It={accountId:vt||"main",isActivated:!1,balance:0,currency:"USD",transactions:[],activatedAt:null,initialAmount:0,creditScore:100},console.log("✅ 钱包数据已加载:",It.accountId,It.isActivated?"已激活":"未激活")}catch(n){console.error("加载钱包数据失败:",n),It={accountId:vt||"main",isActivated:!1,balance:0,currency:"USD",transactions:[],activatedAt:null,initialAmount:0,creditScore:100}}}async function Tt(){try{const n=e(),t=`wallet_${vt||"main"}`;await n.xAccountProfiles.put({handle:t,name:"wallet",accountId:vt||"main",data:{...It},updatedAt:(new Date).toISOString()}),console.log("✅ 钱包数据已保存")}catch(n){throw console.error("保存钱包数据失败:",n),n}}function At(){return It.transactions.filter(n=>n.amount>0).length}function Et(){return It.transactions.filter(n=>n.amount<0).length}function zt(n,e,t){const o=document.getElementById("x-social-screen"),a=o&&o.classList.contains("x-theme-light"),i=document.createElement("div");i.id="transaction-history-modal",i.style.cssText=`\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: ${a?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; display: flex; align-items: center; justify-content: center; z-index: 26; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n`,i.innerHTML=`\n <div style="background-color: ${a?"rgba(255, 255, 255, 0.95)":"rgba(0, 0, 0, 0.95)"}; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; width: 90%; max-width: 400px; max-height: 80vh; position: relative; overflow: hidden; box-shadow: ${a?"0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 0, 0, 0.1)":"0 20px 60px rgba(0, 0, 0, 0.8), 0 8px 32px rgba(255, 255, 255, 0.05)"}; border: 2px solid ${a?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; " onclick="event.stopPropagation()">\n\n <div style="background: linear-gradient(135deg, ${a?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.05)"} 0%, ${a?"rgba(0, 0, 0, 0.01)":"rgba(255, 255, 255, 0.02)"} 100%); padding: 24px; text-align: center; border-bottom: 1px dashed ${a?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.15)"}; position: relative; ">\n\n <div style="position: absolute; left: -10px; bottom: -10px; width: 20px; height: 20px; border-radius: 50%; background-color: ${a?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; "></div>\n <div style="position: absolute; right: -10px; bottom: -10px; width: 20px; height: 20px; border-radius: 50%; background-color: ${a?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; "></div>\n\n <button onclick="closeTransactionHistoryModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: ${a?"#536471":"#71767b"}; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; " onmouseover="this.style.backgroundColor='${a?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}';"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n\n <div style="color: ${a?"#0f1419":"#ffffff"}; font-size: 20px; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; ">${n}</div>\n <div style="color: ${a?"#666666":"#999999"}; font-size: 12px; font-weight: 600; font-family: monospace; letter-spacing: 1px; text-transform: uppercase; ">${e.length} Records</div>\n </div>\n\n <div style="max-height: 50vh; overflow-y: auto; padding: 16px 24px; ">\n ${e.length>0?function(n,e=!1){return n.map(n=>{return`\n <div style="margin-bottom: 12px; background: linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.03)"} 0%, ${e?"rgba(0, 0, 0, 0.01)":"rgba(255, 255, 255, 0.01)"} 100%); border: 1px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; border-radius: 10px; padding: 14px; position: relative; overflow: hidden; ">\n\n <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: repeating-linear-gradient(\n 90deg,\n ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"} 0px,\n ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"} 4px,\n transparent 4px,\n transparent 8px\n ); "></div>\n <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n <div style="flex: 1; min-width: 0;">\n <div style="color: ${e?"#0f1419":"#ffffff"}; font-size: 14px; font-weight: 600; margin-bottom: 6px; word-wrap: break-word; ">${n.description}</div>\n <div style="color: ${e?"#6b7280":"#9ca3af"}; font-size: 11px; margin-bottom: 4px; font-family: monospace; letter-spacing: 0.3px; ">${new Date(n.timestamp).toLocaleDateString("zh-CN")} ${new Date(n.timestamp).toLocaleTimeString("zh-CN",{hour12:!1})}</div>\n </div>\n <div style="color: ${n.amount>0?e?"#0f1419":"#ffffff":e?"#666666":"#999999"}; font-size: 16px; font-weight: 700; margin-left: 12px; flex-shrink: 0; font-family: monospace; ">${n.amount>0?"+":""}$${Math.abs(n.amount).toFixed(2)}</div>\n </div>\n\n <div style="display: inline-block; padding: 3px 8px; background: ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.08)"}; border: 1px solid ${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.12)"}; border-radius: 6px; font-size: 10px; color: ${e?"#666666":"#999999"}; font-weight: 600; letter-spacing: 0.5px; ">${t=n.type,{deposit:"充值",transfer_in:"收款",transfer_out:"转账",refund:"退款",init:"初始化",tip:"打赏",penalty:"违约费",fan_group_fee:"粉丝群入群费"}[t]||t}</div>\n </div>\n`;var t}).join("")}(e,a):function(n=!1,e){return`\n <div style="text-align: center; padding: 40px 20px; color: ${n?"#6b7280":"#9ca3af"}; font-size: 15px; ">\n <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: currentColor; opacity: 0.3; margin: 0 auto 12px;">\n <g><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></g>\n </svg>\n <div style="font-weight: 600; margin-bottom: 8px;">暂无${e}</div>\n <div style="font-size: 13px; opacity: 0.8;">\n ${e.includes("收款")?"收到的资金会显示在这里":"转出的资金会显示在这里"}\n </div>\n </div>\n`}(a,n)}\n </div>\n </div>\n`,document.body.appendChild(i),document.body.style.overflow="hidden",i.addEventListener("click",n=>{n.target===i&&closeTransactionHistoryModal()});const r=i.querySelector("div");r.style.transform="scale(0.8) translateY(20px)",r.style.opacity="0",requestAnimationFrame(()=>{r.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",r.style.transform="scale(1) translateY(0)",r.style.opacity="1"})}function Bt(){document.getElementById("edit-profile-modal").style.display="flex",document.body.style.overflow="hidden",function(){const o=n.userProfileData;document.getElementById("edit-user-name").value=o.name,document.getElementById("edit-user-handle").value=o.handle.replace("@",""),document.getElementById("edit-user-bio").value=o.bio,document.getElementById("edit-custom-tag1").value=o.customTag1,document.getElementById("edit-custom-tag2").value=o.customTag2,document.getElementById("edit-following-count").value=o.following,document.getElementById("edit-followers-count").value=o.followers,document.getElementById("edit-tag1-icon").value=o.customTag1Icon||"✨",document.getElementById("edit-tag2-icon").value=o.customTag2Icon||"📅",document.getElementById("edit-tag1-color").value=o.customTag1Color||"#71767b",document.getElementById("edit-tag2-color").value=o.customTag2Color||"#71767b",document.getElementById("edit-tag1-color-text").value=o.customTag1Color||"#71767b",document.getElementById("edit-tag2-color-text").value=o.customTag2Color||"#71767b",document.getElementById("edit-cover-image").src=o.coverImage,document.getElementById("edit-main-avatar").src=o.avatar,document.getElementById("edit-public-identity").value=o.publicIdentity||"",document.getElementById("edit-show-real-name").checked=o.showRealName||!1,document.getElementById("edit-real-name").value=o.realName||"",Nt(),Dt(),function(){const o=n.userProfileData,a=document.getElementById("edit-verification-type");a&&(a.value=o.verificationType||"none");const i=document.getElementById("edit-couple-character");i&&(i.value=o.coupleCharacterId||"");(async function(){try{const n=t(),o=e(),a=(await n.chats.toArray()).filter(n=>!n.isGroup&&!n.linkedCharacterData&&n.name&&""!==n.name.trim()),i=document.getElementById("edit-couple-character");if(!i)return;i.innerHTML='<option value="" style="background-color:#000; color: #fff;">未选择角色</option>';const r=await o.xCharacterProfiles.toArray(),s=new Map;r.forEach(n=>{s.set(n.characterId,n)}),a.forEach(n=>{const e=document.createElement("option");e.value=n.id;const t=s.get(n.id),o=t?.xName||n.name;e.textContent=o,e.style.backgroundColor="#000",e.style.color="#fff",i.appendChild(e)}),te.coupleCharacterId&&(i.value=te.coupleCharacterId)}catch(n){console.error("加载情侣角色选项失败:",n)}})(),Pt()}(),jt(),console.log("✅ 已加载用户数据到编辑表单")}()}function Lt(n){if(n&&n.target!==n.currentTarget)return;document.getElementById("edit-profile-modal").style.display="none",document.body.style.overflow="auto"}function Pt(){const n=document.getElementById("edit-verification-type"),e=document.getElementById("couple-binding-section");if(!n||!e)return;const t=n.value;e.style.display="couple"===t?"block":"none"}function Dt(){const n=document.getElementById("edit-user-name"),e=document.getElementById("edit-user-handle"),t=document.getElementById("edit-user-bio"),o=document.getElementById("edit-custom-tag1"),a=document.getElementById("edit-custom-tag2");if(n){const e=n.value.length;n.parentNode.querySelector("div").textContent=`${e} / 50`}if(e){const n=e.value.length;e.parentNode.querySelector("div").textContent=`${n} / 15`}if(t){const n=t.value.length;t.parentNode.querySelector("div").textContent=`${n} / 160`}if(o){const n=o.value.length;o.closest(".form-group").querySelector("div:last-child").textContent=`${n} / 30`}if(a){const n=a.value.length;a.closest(".form-group").querySelector("div:last-child").textContent=`${n} / 30`}const i=document.getElementById("edit-real-name");if(i){const n=i.value.length;i.parentNode.querySelector("div").textContent=`${n} / 50`}}function Nt(){const n=document.getElementById("edit-show-real-name"),e=document.getElementById("real-name-input-container");if(n&&e)if(n.checked)e.style.display="block";else{e.style.display="none";const n=document.getElementById("edit-real-name");n&&(n.value="",Dt())}else console.warn("用户真名相关元素未找到")}function Rt(){const n=document.getElementById("character-show-real-name"),e=document.getElementById("character-real-name-input-container");if(n&&e)if(n.checked)e.style.display="block";else{e.style.display="none";const n=document.getElementById("character-real-name");n&&(n.value="",fe())}else console.warn("角色真名相关元素未找到")}function Ht(n){return n?n.toString().trim():""}async function jt(){console.log("🔄 [加载角色身份识别列表] 开始加载");try{const n=t(),o=e(),a=`xSettings_${vt||"main"}`,i=await o.xSettings.get(a),r=i?.boundCharacters||[];if(console.log(`🔄 [加载角色身份识别列表] 绑定角色数: ${r.length}`),0===r.length)return console.log("⚠️ [加载角色身份识别列表] 无绑定角色"),void Ut([]);const s=(await n.chats.toArray()).filter(n=>!n.isGroup&&!n.linkedCharacterData&&n.name&&""!==n.name.trim()&&r.includes(n.id));console.log(`🔄 [加载角色身份识别列表] 过滤后角色数: ${s.length}`);const l=[];for(const n of s){const e=await o.xCharacterProfiles.get(n.id);if(e){const t=(e.userPersona||"").length;console.log(`🔄 [加载角色身份识别列表] 角色 ${n.name} (${n.id})`),console.log(` - X名称: ${e.xName}`),console.log(` - 用户人设长度: ${t} 字符`),console.log(` - 人设预览: "${(e.userPersona||"").substring(0,50)}${t>50?"...":""}"`),l.push({id:n.id,name:n.name,originalName:n.originalName,xProfile:e})}}console.log(`✅ [加载角色身份识别列表] 最终角色数: ${l.length}`),Ut(l)}catch(n){console.error("❌ [加载角色身份识别列表] 加载失败:",n),console.error("❌ [加载角色身份识别列表] 错误详情:",n.message,n.stack),Ut([])}}function Ut(n){const e=document.getElementById("identity-characters-list");0!==n.length?(te.knownIdentityCharacters||(te.knownIdentityCharacters=[]),e.innerHTML=n.map(n=>{const e=te.knownIdentityCharacters.includes(n.id);return`\n <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: background-color 0.2s;"\n onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"\n onmouseout="this.style.backgroundColor='transparent'"\n onclick="toggleIdentityCharacter('${n.id}')">\n\n <div style="width: 18px; height: 18px; border: 2px solid ${e?"var(--x-accent)":"#71767b"}; border-radius: 3px; background-color: ${e?"var(--x-accent)":"transparent"}; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; ">\n ${e?'<svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #fff;"><path d="M9 16.17L5.53 12.7l-1.06 1.06L9 18.3l9.54-9.54-1.06-1.06L9 16.17z"/></svg>':""}\n </div>\n\n <img src="${n.xProfile.xAvatar}" alt="${n.xProfile.xName}"\n style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;">\n\n <div style="flex: 1; min-width: 0;">\n <div style="color: #fff; font-weight: 600; font-size: 14px;">\n ${n.xProfile.xName}\n ${n.xProfile.xVerified?'<svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-accent); margin-left: 4px; display: inline;"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z"/></svg>':""}\n </div>\n <div style="color: #71767b; font-size: 12px;">\n ${n.xProfile.xHandle} • ${n.name}\n ${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?'<span style="color: #10b981; font-size: 11px; margin-left: 8px;">✓ 已设置人设</span>':'<span style="color: #f59e0b; font-size: 11px; margin-left: 8px;">⚠ 未设置人设</span>'}\n </div>\n </div>\n\n <div class="persona-setting-btn" onclick="event.stopPropagation(); window.openUserPersonaEditor('${n.id}')"\n style="width: 32px; height: 32px; border-radius: 50%; background-color: ${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?"#10b981":"#1d9bf0"}; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: all 0.2s; margin-left: 8px; "\n onmouseover="this.style.backgroundColor='${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?"#059669":"#1a8cd8"}'; this.style.transform='scale(1.05)'"\n onmouseout="this.style.backgroundColor='${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?"#10b981":"#1d9bf0"}'; this.style.transform='scale(1)'"\n title="${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?"编辑用户人设":"设置用户人设"}">\n ${n.xProfile&&n.xProfile.userPersona&&n.xProfile.userPersona.trim()?'<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;"><g><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></g></svg>':'<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;"><g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g></svg>'}\n </div>\n </div>\n `}).join("")):e.innerHTML='\n <div style="text-align: center; color: #71767b; font-size: 13px; padding: 20px;">\n 暂无已绑定X资料的角色<br>\n <span style="font-size: 12px; margin-top: 4px; display: block;">\n 请先在X设置中绑定角色并设置X资料\n </span>\n </div>\n '}n.showIncomeHistory=function(){zt("收款记录",It.transactions.filter(n=>n.amount>0),"#22c55e")},n.showExpenseHistory=function(){zt("付款记录",It.transactions.filter(n=>n.amount<0),"#ef4444")},n.closeTransactionHistoryModal=function(){const n=document.getElementById("transaction-history-modal");if(n){const e=n.querySelector("div");e.style.transform="scale(0.9) translateY(20px)",e.style.opacity="0",setTimeout(()=>{n.remove(),document.body.style.overflow="auto"},200)}},n.toggleAutoMessageSettings=function(){const n=document.getElementById("character-auto-message-enabled"),e=document.getElementById("auto-message-time-settings");n&&e&&(n.checked?e.style.display="block":e.style.display="none")},n.openUserPersonaEditor=async function(o){console.log(`📖 [打开用户人设编辑器] 角色ID: ${o}`);try{const a=t(),i=e(),r=await a.chats.get(o),s=await i.xCharacterProfiles.get(o);if(console.log("📖 [打开用户人设编辑器] 角色数据:",r?"存在":"不存在"),console.log("📖 [打开用户人设编辑器] X资料数据:",s?"存在":"不存在"),!r||!s)return console.error("❌ [打开用户人设编辑器] 无法获取角色信息"),void mn("无法获取角色信息","error");const l=s.userPersona||"";console.log(`📖 [打开用户人设编辑器] 现有人设长度: ${l.length} 字符`),console.log(`📖 [打开用户人设编辑器] 人设内容预览: "${l.substring(0,100)}${l.length>100?"...":""}"`),n.showUserPersonaModal(o,r.name,s.xName,l)}catch(n){console.error("❌ [打开用户人设编辑器] 失败:",n),console.error("❌ [打开用户人设编辑器] 错误详情:",n.message,n.stack),mn("打开编辑器失败: "+n.message,"error")}},n.showUserPersonaModal=function(e,t,o,a){console.log(`🖼️ [显示用户人设弹窗] 角色: ${o} (${t})`),console.log(`🖼️ [显示用户人设弹窗] 角色ID: ${e}`),console.log(`🖼️ [显示用户人设弹窗] 传入的人设长度: ${a.length} 字符`);const i=document.createElement("div");i.id="user-persona-modal",i.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px); ",i.innerHTML=`\n <div style="background-color: #1a1a1a; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; border: 1px solid #333; ">\n\n <div style="padding: 20px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; ">\n <div>\n <h3 style="margin: 0; color: #fff; font-size: 18px; font-weight: 700;">\n 编辑用户人设\n </h3>\n <p style="margin: 4px 0 0; color: #71767b; font-size: 14px;">\n 为 ${o} (${t}) 设置你的身份信息\n </p>\n </div>\n <button onclick="window.closeUserPersonaModal()" style="background: transparent; border: none; color: #71767b; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.1)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n </div>\n\n <div style="padding: 20px;">\n\n <div style="background-color: #003d82; border: 1px solid var(--x-accent); border-radius: 8px; padding: 12px; margin-bottom: 20px; ">\n <div style="color: var(--x-accent); font-size: 14px; font-weight: 600; margin-bottom: 4px;">\n 💡 如何设置用户人设\n </div>\n <div style="color: #e1e8ed; font-size: 13px; line-height: 1.4;">\n • 描述你希望这个角色了解的关于你的信息<br>\n • 例如：性格特点、兴趣爱好、职业背景等<br>\n • 这些信息将帮助角色更自然地与你互动\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px; ">用户人设</label>\n <textarea id="user-persona-input" placeholder="请描述你希望${o}了解的关于你的信息..." style="width: 100%; min-height: 120px; max-height: 300px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; padding: 12px; resize: vertical; outline: none; box-sizing: border-box; font-family: inherit; line-height: 1.4; " oninput="window.updatePersonaCharCount()">${a}</textarea>\n <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; ">\n <div style="color: #71767b; font-size: 12px;">\n 建议详细描述，帮助角色更好地理解你\n </div>\n <div id="persona-char-count" style="color: #71767b; font-size: 12px;">\n ${a.length} 字符\n </div>\n </div>\n </div>\n\n <div style="display: flex; gap: 12px; justify-content: flex-end;">\n <button onclick="window.closeUserPersonaModal()" style="background: transparent; color: #71767b; border: 1px solid #333; border-radius: 20px; padding: 8px 20px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.05)'"\n onmouseout="this.style.backgroundColor='transparent'">\n 取消\n </button>\n <button onclick="window.saveUserPersona('${e}')" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 20px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='#1a8cd8'"\n onmouseout="this.style.backgroundColor='var(--x-accent)'">\n 保存\n </button>\n </div>\n </div>\n </div>\n `,document.body.appendChild(i),i.addEventListener("click",e=>{e.target===i&&n.closeUserPersonaModal()})},n.updatePersonaCharCount=function(){const n=document.getElementById("user-persona-input"),e=document.getElementById("persona-char-count");n&&e&&(e.textContent=`${n.value.length} 字符`)},n.closeUserPersonaModal=function(){console.log("🚪 [关闭用户人设弹窗] 关闭编辑弹窗");const n=document.getElementById("user-persona-modal");if(n){const e=document.getElementById("user-persona-input");e&&console.log(`🚪 [关闭用户人设弹窗] 弹窗中当前内容长度: ${e.value.length} 字符`),n.remove(),console.log("✅ [关闭用户人设弹窗] 弹窗已移除")}},n.saveUserPersona=async function(t){const o=document.getElementById("user-persona-input").value.trim();console.log(`💾 [保存用户人设] 开始保存角色 ${t} 的用户人设`),console.log(`💾 [保存用户人设] 人设内容长度: ${o.length} 字符`);try{const a=e();let i=await a.xCharacterProfiles.get(t);if(console.log("💾 [保存用户人设] 获取到的角色资料:",i?"存在":"不存在"),i){const e=i.userPersona||"";console.log(`💾 [保存用户人设] 旧人设长度: ${e.length} 字符`),console.log(`💾 [保存用户人设] 新人设长度: ${o.length} 字符`),i.userPersona=o,await a.xCharacterProfiles.put(i);const r=await a.xCharacterProfiles.get(t),s=r?.userPersona||"";console.log(`✅ [保存用户人设] 验证保存结果 - 实际保存长度: ${s.length} 字符`),s===o?console.log("✅ [保存用户人设] 数据验证成功，保存一致"):(console.warn("⚠️ [保存用户人设] 数据验证失败！保存的内容与预期不一致"),console.warn(`⚠️ [保存用户人设] 预期: "${o.substring(0,50)}..."`),console.warn(`⚠️ [保存用户人设] 实际: "${s.substring(0,50)}..."`)),mn(o?"用户人设已保存":"用户人设已清空","success"),n.closeUserPersonaModal(),console.log("🔄 [保存用户人设] 重新加载角色身份识别列表"),await jt()}else console.error(`❌ [保存用户人设] 无法找到角色资料，角色ID: ${t}`),mn("无法找到角色资料","error")}catch(n){console.error("❌ [保存用户人设] 保存失败:",n),console.error("❌ [保存用户人设] 错误详情:",n.message,n.stack),mn("保存失败: "+n.message,"error")}};let Ot="public",_t=null;function Ft(){document.getElementById("compose-tweet-modal").style.display="flex",document.body.style.overflow="hidden",function(){document.getElementById("compose-text-input").value="",qt(),Vt(),document.getElementById("compose-image-section").style.display="none",document.getElementById("compose-location-section").style.display="none",document.getElementById("compose-link-section").style.display="none",["image-btn","location-btn","attach-btn"].forEach(n=>{document.getElementById(n).style.backgroundColor="transparent"}),Jt(),Qt(),no(),Ot="public",_t=null;const e=document.getElementById("privacy-icon-path"),t=document.getElementById("privacy-text");e.setAttribute("d","M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z"),t.textContent="所有人可以回复",t.style.color="var(--x-accent)";const o=document.getElementById("business-task-selection");o&&(o.style.display="none");Mo();const a=document.getElementById("compose-fangroup-quote-section");a&&a.remove();n.currentQuoteFanGroup=null}();const e=document.querySelector('#compose-tweet-modal img[alt="用户头像"]');e&&(e.src=te.avatar)}function Xt(e){if(e&&e.target!==e.currentTarget)return;document.getElementById("compose-tweet-modal").style.display="none",document.body.style.overflow="auto",Mo();const t=document.getElementById("compose-fangroup-quote-section");t&&t.remove(),n.currentQuoteFanGroup=null}function qt(){const n=document.getElementById("compose-text-input"),e=document.getElementById("compose-char-count"),t=n.value.length;e.textContent=`${t} / 280`,e.style.color=t>260?"#f4212e":t>240?"#ffad1f":"#71767b"}function Vt(){const n=document.getElementById("compose-text-input"),e=document.getElementById("compose-tweet-btn");n.value.trim().length>0?(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed")}function Gt(){document.getElementById("compose-text-input").value}function Yt(){const n=document.getElementById("compose-image-section"),e=document.getElementById("image-btn");"none"===n.style.display?(n.style.display="block",e.style.backgroundColor="rgba(29,155,240,0.1)"):(n.style.display="none",e.style.backgroundColor="transparent",Jt())}let Wt=[];function Jt(){document.getElementById("image-file-input").value="",Wt=[],document.getElementById("uploaded-image-preview").style.display="none";const n=document.getElementById("preview-images-container");n&&(n.innerHTML="");const e=document.querySelector("#image-description-input textarea");e&&(e.value="");const t=document.getElementById("img-desc-btn"),o=document.getElementById("img-upload-btn");t.style.backgroundColor="#333",t.style.borderColor="#536471",o.style.backgroundColor="#333",o.style.borderColor="#536471",document.getElementById("image-description-input").style.display="none",document.getElementById("image-upload-area").style.display="none"}function Kt(){const n=document.getElementById("compose-location-section"),e=document.getElementById("location-btn");"none"===n.style.display?(n.style.display="block",e.style.backgroundColor="rgba(29,155,240,0.1)"):(n.style.display="none",e.style.backgroundColor="transparent",Qt())}function Qt(){document.getElementById("location-input").value=""}function Zt(){const n=document.getElementById("compose-link-section"),e=document.getElementById("attach-btn");"none"===n.style.display?(n.style.display="block",e.style.backgroundColor="rgba(29,155,240,0.1)"):(n.style.display="none",e.style.backgroundColor="transparent",no())}function no(){document.getElementById("link-title-input").value="",document.getElementById("link-url-input").value="",document.getElementById("link-description-input").value=""}async function eo(){try{const n=e(),t=`businessTransfers_${vt||"main"}`,o=await n.xAccountProfiles.get(t),a=document.getElementById("business-task-selection"),i=document.getElementById("business-tasks-list");if(!a||!i)return;if(a.style.display="block",i.innerHTML="",!o||!o.data)return void(i.innerHTML='\n <div style="text-align: center; padding: 24px 12px; color: #71767b; font-size: 13px; ">\n <svg viewBox="0 0 24 24" style="width: 40px; height: 40px; fill: currentColor; opacity: 0.3; margin: 0 auto 8px;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path></g>\n </svg>\n <div>没有待完成的任务</div>\n </div>\n ');const r=new Date;console.log("📋 [显示任务列表] 开始筛选，总数:",o.data.length);const s=o.data.filter(n=>{if(console.log("📋 [筛选任务]",{direction:n.direction,taskStatus:n.taskStatus,taskDeadline:n.taskDeadline,acceptedAt:n.acceptedAt,taskDeadlineHours:n.taskDeadlineHours}),"received"!==n.direction||"in_progress"!==n.taskStatus)return!1;let e;if(n.taskDeadline)e=new Date(n.taskDeadline);else{if(!n.acceptedAt||!n.taskDeadlineHours)return console.warn("⚠️ [筛选任务] 任务没有足够信息计算截止时间，仍然显示",n.transferId),!0;{const t=new Date(n.acceptedAt),o=parseFloat(n.taskDeadlineHours)||24;e=new Date(t.getTime()+60*o*60*1e3),console.log("⚠️ [筛选任务] 动态计算截止时间:",e.toISOString())}}const t=e.getTime()>r.getTime();return console.log("📋 [筛选任务] 是否有效:",t),t});if(console.log("📋 [显示任务列表] 筛选后:",s.length),0===s.length)return void(i.innerHTML='\n <div style="text-align: center; padding: 24px 12px; color: #71767b; font-size: 13px; ">\n <svg viewBox="0 0 24 24" style="width: 40px; height: 40px; fill: currentColor; opacity: 0.3; margin: 0 auto 8px;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path></g>\n </svg>\n <div>没有待完成的任务</div>\n </div>\n ');s.forEach(n=>{let e;if(n.taskDeadline)e=new Date(n.taskDeadline);else if(n.acceptedAt&&n.taskDeadlineHours){const t=new Date(n.acceptedAt),o=parseFloat(n.taskDeadlineHours)||24;e=new Date(t.getTime()+60*o*60*1e3)}else e=new Date(r.getTime()+864e5);const t=e.getTime()-r.getTime(),o=Math.floor(t/36e5),a=Math.floor(t%36e5/6e4),s=o>0?`剩余 ${o}小时${a}分钟`:`剩余 ${a}分钟`,l=_t===n.transferId,c=document.createElement("div");c.style.cssText=`\n padding: 14px; margin-bottom: 10px; background: linear-gradient(135deg, ${l?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.03)"} 0%, ${l?"rgba(255, 255, 255, 0.04)":"rgba(255, 255, 255, 0.01)"} 100%); border: 1px solid ${l?"rgba(255, 255, 255, 0.25)":"rgba(255, 255, 255, 0.1)"}; border-radius: 10px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; `,c.innerHTML=`\n\n <div style="position: absolute; top: 50%; right: -25px; transform: translateY(-50%) rotate(15deg); font-size: 28px; color: rgba(255, 255, 255, 0.02); font-weight: 700; pointer-events: none; ">TASK</div>\n <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">\n <div style="flex: 1;">\n <div style="color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 4px;">\n 来自 ${n.senderName}\n </div>\n <div style="color: #71767b; font-size: 11px; font-family: monospace; letter-spacing: 0.3px;">${n.senderHandle}</div>\n </div>\n <div style="padding: 4px 10px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%); color: #e5e5e5; font-size: 10px; font-weight: 600; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.15); letter-spacing: 0.5px; display: flex; align-items: center; gap: 4px; ">\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: currentColor;">\n <g><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path></g>\n </svg>\n ${s}\n </div>\n </div>\n\n <div style="color: #e5e5e5; font-size: 13px; line-height: 1.4; margin-bottom: 12px; padding: 10px; background: rgba(255, 255, 255, 0.02); border-left: 2px solid rgba(255, 255, 255, 0.15); border-radius: 4px; ">${n.taskDescription}</div>\n\n <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); ">\n <div style="color: #71767b; font-size: 11px; font-family: monospace; ">$${n.amount} <span style="opacity: 0.6;">(定金 $${n.depositAmount})</span></div>\n ${l?'<div style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; font-size: 10px; font-weight: 600; color: #fff; letter-spacing: 0.5px; ">\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: currentColor;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></g>\n </svg>\n 已选择\n </div>':""}\n </div>\n `,c.onclick=()=>{_t=n.transferId,eo()},c.onmouseover=function(){l||(this.style.borderColor="rgba(255, 255, 255, 0.2)",this.style.background="linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%)")},c.onmouseout=function(){l||(this.style.borderColor="rgba(255, 255, 255, 0.1)",this.style.background="linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%)")},i.appendChild(c)})}catch(n){console.error("显示商业任务失败:",n)}}function to(){if("none"===document.getElementById("compose-image-section").style.display)return null;const n=document.querySelector("#image-description-input textarea");return n&&"none"!==n.style.display&&n.value.trim()?{type:"description",content:n.value.trim()}:Wt&&Wt.length>0?{type:"uploads",images:Wt.map(n=>({content:n}))}:null}function oo(){if("none"===document.getElementById("compose-location-section").style.display)return null;const n=document.getElementById("location-input").value.trim();return n||null}function ao(){if("none"===document.getElementById("compose-link-section").style.display)return null;const n=document.getElementById("link-title-input").value.trim(),e=document.getElementById("link-url-input").value.trim(),t=document.getElementById("link-description-input").value.trim(),o=document.getElementById("link-preview-image"),a=o&&o.src.startsWith("data:")?o.src:null;return n||e||t||a?{title:n,url:e,description:t,thumbnail:a}:null}function no(){document.getElementById("link-title-input").value="",document.getElementById("link-url-input").value="",document.getElementById("link-description-input").value="",document.getElementById("link-image-input").value="",document.getElementById("link-image-preview").style.display="none"}async function io(n){console.log("📖 [显示详情] 开始显示推文详情，推文ID:",n.id);let t=n;try{const o=e();if(n.id.startsWith("user_")){console.log("📖 [显示详情] 从用户推文数据库加载");const e=`userTweets_${vt||"main"}`,a=await o.xUserTweets.get(e);if(a&&a.tweets){const e=a.tweets.find(e=>e.id===n.id);e?(t=e,console.log("✅ [显示详情] 已加载最新用户推文数据，评论数:",e.comments?.length||0)):console.warn("⚠️ [显示详情] 数据库中未找到该用户推文")}}else{console.log("📖 [显示详情] 从主页推文数据库加载");const e=await o.xTweetsData.get("tweets");if(e){let o=null;e.forYouTweets&&(o=e.forYouTweets.find(e=>e.id===n.id)),!o&&e.followingTweets&&(o=e.followingTweets.find(e=>e.id===n.id)),o?(t=o,console.log("✅ [显示详情] 已加载最新主页推文数据，评论数:",o.comments?.length||0)):console.warn("⚠️ [显示详情] 数据库中未找到该主页推文")}}}catch(n){console.error("❌ [显示详情] 从数据库加载推文失败:",n)}sessionStorage.setItem("currentTweetData",JSON.stringify(t)),console.log("📖 [显示详情] sessionStorage 已更新"),document.querySelectorAll(".x-page").forEach(n=>{n.style.display="none"});document.getElementById("x-tweet-detail-page").style.display="flex";const o="account"===t._source,a="search"===t._source,i=t.id&&t.id.startsWith("user_");if(o||a){const n=o?"账户推文":"搜索结果推文";console.log(`📖 [显示详情] 检测到${n}，强制启用推进模式（该类型推文仅支持推进）`),po||(po=!0,xo())}else i&&(console.log("📖 [显示详情] 检测到用户推文，支持重回+推进模式"),xo());!function(n){const e=document.getElementById("tweet-detail-container");e.setAttribute("data-tweet-id",n.id);const t=`\n <div class="tweet-detail-item" style="padding: 16px 16px 4px 16px;">\n\n <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">\n <img src="${n.user.avatar}" alt="${n.user.name}"\n onclick="openAccountProfile('${n.user.name.replace(/'/g,"\\'")}', '${n.user.handle}', '${n.user.avatar}', {source: 'tweetDetail'});event.stopPropagation();"\n style="width: 48px; height: 48px; border-radius: 50%; cursor: pointer; transition: opacity 0.2s;"\n onmouseover="this.style.opacity='0.8'"\n onmouseout="this.style.opacity='1'">\n <div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span onclick="openAccountProfile('${n.user.name.replace(/'/g,"\\'")}', '${n.user.handle}', '${n.user.avatar}', {source: 'tweetDetail'});event.stopPropagation();" style="color: #fff; font-weight: 700; font-size: 17px; cursor: pointer;">${n.user.name}</span>\n ${n.user.verified?'<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n </div>\n <div style="color: #71767b; font-size: 15px;">${n.user.handle.startsWith("@")?n.user.handle:"@"+n.user.handle}</div>\n </div>\n </div>\n\n <div style="color: #fff; font-size: 16px; line-height: 1.3; margin-bottom: 16px; word-wrap: break-word;">\n ${R(n.content)}\n </div>\n ${function(n){if(n.media&&Array.isArray(n.media)&&n.media.length>0){const e=n.media[0];if("description"===e.type&&e.description)return`\n <div style="margin-bottom: 16px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 16px; padding: 16px;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 20px;">${e.description}</div>\n </div>\n `;if("upload"===e.type&&e.url)return`\n <div style="margin-bottom: 16px; border-radius: 16px; overflow: hidden;">\n <img src="${e.url}" style="width: 100%; max-height: 400px; object-fit: cover; display: block;" alt="推文图片">\n </div>\n `}if(!n.image)return"";if("description"===n.image.type)return`\n <div style="margin-bottom: 16px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.image.content}</div>\n </div>\n `;if("upload"===n.image.type)return`\n <div style="margin-bottom: 16px; border-radius: 16px; overflow: hidden;">\n <img src="${n.image.content}" style="width: 100%; max-height: 400px; object-fit: cover; display: block;" alt="推文图片">\n </div>\n `;if("uploads"===n.image.type&&n.image.images&&n.image.images.length>0){const e=n.image.images.length;let t="";t=1===e?"grid-template-columns: 1fr;":"grid-template-columns: repeat(2, 1fr);";return`\n <div style="margin-bottom: 16px; display: grid; ${t} gap: 4px;">\n ${n.image.images.map((n,t)=>`\n <div style="${3===e&&0===t?"grid-column: span 2;":""}border-radius: 12px; overflow: hidden;">\n <img src="${n.content}" style="width: 100%; height: ${1===e?"400px":"280px"}; object-fit: cover; display: block;" alt="推文图片${t+1}">\n </div>\n `).join("")}\n </div>\n `}return""}(n)}\n ${function(n){return n.link?`\n <div style="margin-bottom: 16px; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'" onmouseout="this.style.backgroundColor='transparent'">\n ${n.link.thumbnail?`\n <div style="width: 100%; height: 200px; background-color: #333;">\n <img src="${n.link.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;" alt="链接预览图">\n </div>\n `:""}\n <div style="padding: 12px;">\n <div style="color: #71767b; font-size: 13px; margin-bottom: 4px;">${n.link.url||"链接"}</div>\n ${n.link.title?`<div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 4px; line-height: 1.3;">${n.link.title}</div>`:""}\n ${n.link.description?`<div style="color: #71767b; font-size: 14px; line-height: 1.4;">${n.link.description}</div>`:""}\n </div>\n </div>\n `:""}(n)}\n ${function(n){if(!n.quotedTweet)return"";const e=n.quotedTweet,t="tweet"===e.type?"推文":"评论";return`\n <div style="margin-bottom: 16px; border: 1px solid var(--x-border-color); border-radius: 16px; padding: 16px; background-color: var(--x-bg-hover); transition: background-color 0.2s;">\n <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">\n <img src="${e.user.avatar}"\n onclick="openAccountProfile('${e.user.name.replace(/'/g,"\\'")}', '${e.user.handle}', '${e.user.avatar}', {source: 'quotedTweet'});event.stopPropagation();"\n style="width: 24px; height: 24px; border-radius: 50%; cursor: pointer; transition: opacity 0.2s;"\n onmouseover="this.style.opacity='0.8'"\n onmouseout="this.style.opacity='1'"\n alt="${e.user.name}">\n <div style="display: flex; align-items: center; gap: 4px;">\n <span onclick="openAccountProfile('${e.user.name.replace(/'/g,"\\'")}', '${e.user.handle}', '${e.user.avatar}', {source: 'quotedTweet'});event.stopPropagation();" style="color:var(--x-text-primary); font-size: 15px; font-weight: 700; cursor: pointer;">${e.user.name}</span>\n ${e.user.verified?'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span style="color:var(--x-text-secondary); font-size: 15px;">${e.user.handle}</span>\n <span style="color:var(--x-text-secondary); font-size: 15px;">·${e.time}</span>\n </div>\n </div>\n <div style="color:var(--x-text-primary); font-size: 17px; line-height: 1.3; word-wrap: break-word;">${e.content}</div>\n ${function(n){if(!n.image)return"";if("description"===n.image.type)return`\n <div style="margin-top: 8px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 8px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 13px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.image.content}</div>\n </div>\n `;if("upload"===n.image.type)return`\n <div style="margin-top: 8px; border-radius: 8px; overflow: hidden;">\n <img src="${n.image.content}" style="width: 100%; max-height: 120px; object-fit: cover; display: block;" alt="引用图片">\n </div>\n `;return""}(e)}\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-top: 12px; font-style: italic;">引用${t}</div>\n </div>\n `}(n)}\n ${function(n){if(!n.quotedFanGroup)return"";const e=n.quotedFanGroup;return`\n <div style="margin-bottom: 16px; border: 1px solid var(--x-border-color); border-radius: 16px; padding: 16px; background-color: var(--x-bg-hover); transition: background-color 0.2s; cursor: pointer; " onclick="event.stopPropagation(); showXToast('粉丝群详情功能开发中', 'info');"\n onmouseover="this.style.backgroundColor='var(--x-bg-secondary)'"\n onmouseout="this.style.backgroundColor='var(--x-bg-hover)'">\n <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">\n <img src="${e.avatar}"\n style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;"\n alt="${e.name}">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">\n <span style="color:var(--x-text-primary); font-size: 17px; font-weight: 700;">${e.name}</span>\n <span style="padding: 2px 8px; background-color:var(--x-bg-primary); color: var(--x-accent); font-size: 11px; border-radius: 4px; font-weight: 600; border: 1px solid var(--x-accent); ">粉丝群</span>\n </div>\n <div style="color:var(--x-text-secondary); font-size: 15px;">\n ${e.memberCount} 位成员\n </div>\n </div>\n </div>\n ${e.threshold?`\n <div style="padding: 12px; background-color:var(--x-bg-primary); border-radius: 8px; border-left: 3px solid var(--x-accent); margin-bottom: 12px; ">\n <div style="color:var(--x-text-primary); font-weight: 600; font-size: 13px; margin-bottom: 6px;">\n 入群门槛\n </div>\n <div style="color:var(--x-text-secondary); font-size: 15px; line-height: 1.4;">\n ${e.threshold}\n </div>\n </div>\n `:""}\n <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--x-border-color); ">\n <div style="color:var(--x-text-secondary); font-size: 13px; font-style: italic;">\n 引用粉丝群\n </div>\n <div style="display: flex; align-items: center; gap: 4px; color: var(--x-accent); font-size: 13px; font-weight: 600; ">\n <span>申请加入</span>\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <g><path d="M8.58 7.17l4.24 4.24-4.24 4.24 1.42 1.42 5.66-5.66-5.66-5.66z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n `}(n)}\n\n <div style="display: flex; align-items: center; justify-content: space-between; margin: 12px 0 16px 0;">\n <div style="display: flex; align-items: center; gap: 16px;">\n <span style="color: #71767b; font-size: 15px;">${ro(n.timestamp||n.createdAt)}</span>\n <span style="color: #71767b; font-size: 15px;">·</span>\n <span id="tweet-detail-views" style="color: #fff; font-weight: 700; font-size: 15px;">${N(n.stats.views)}</span>\n <span id="tweet-detail-views-label" style="color: #71767b; font-size: 15px;">${jn("tweetDetailViews")}</span>\n </div>\n ${n.location?`\n <div style="display: flex; align-items: center; gap: 4px; color: var(--x-accent); font-size: 15px;">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <g>\n <path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path>\n </g>\n </svg>\n <span>${n.location}</span>\n </div>\n `:""}\n </div>\n\n <div id="tweet-detail-stats" style="display: flex; align-items: center; gap: 32px; padding: 16px 0; border-top: 1px solid #2f3336; border-bottom: 1px solid #2f3336;">\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(n.stats.retweets)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailRetweets")}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(n.stats.likes)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailLikes")}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(n.stats.comments)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailBookmarks")}</span>\n </div>\n </div>\n\n <div style="display: flex; justify-content: space-between; padding: 12px 0 0 0;">\n <div class="tweet-action comment" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">\n <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>\n </svg>\n </div>\n <div class="tweet-action retweet" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(0,186,124,0.1)'; this.style.color='#00ba7c';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n </div>\n <div class="tweet-action like" onclick="toggleDetailLike('${n.id}', this)" data-liked="false" data-likes="${n.stats.likes}" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(249,24,128,0.1)'; this.style.color='#f91880';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">\n <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n </div>\n <div class="tweet-action bookmark" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">\n <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>\n </svg>\n </div>\n <div class="tweet-action share" id="tweet-detail-share-btn" style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(29,155,240,0.1)'; this.style.color='#1d9bf0';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#71767b';">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">\n <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n `;e.innerHTML=t;const o=document.querySelector("#x-tweet-detail-page .detail-comment-input-area img");o&&(o.src=te.avatar);const a=document.getElementById("tweet-detail-share-btn");a&&(a.onclick=()=>{showShareContentModal({user:n.user,content:n.content,time:n.time||ro(n.timestamp),image:n.image,fullTweet:n,comments:n.comments||[]},"tweet")});!function(n){const e=document.getElementById("detail-comments-container");if(e.innerHTML="",!n||0===n.length)return;console.log("📋 [渲染评论] 开始渲染评论，主评论数:",n.length),n.forEach(n=>{const t=en(n);e.appendChild(t),n.replies&&n.replies.length>0&&(console.log("📋 [渲染评论] 评论",n.id,"有",n.replies.length,"条楼中楼回复"),n.replies.forEach(n=>{const t=en(n,!0);e.appendChild(t)}))}),console.log("✅ [渲染评论] 评论渲染完成");document.querySelectorAll(".reply-user-avatar").forEach(n=>{n.src=te.avatar})}(n.comments)}(t),console.log("✅ [显示详情] 推文详情页面已显示"),setTimeout(()=>{const n=document.getElementById("detail-comment-user-avatar");n&&(n.src=te.avatar);document.querySelectorAll(".reply-user-avatar").forEach(n=>{n.src=te.avatar})},100)}function ro(n){if(!n)return"未知时间";const e=new Date(n);if(isNaN(e.getTime()))return"未知时间";return new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e)}function so(){const e=document.getElementById("detail-comment-input"),t=document.getElementById("detail-reply-btn");if(!t)return;const o=e&&e.value.trim().length>0,a=n.getSelectedCommentSticker?null!==n.getSelectedCommentSticker():null!==Ao;o||a?(t.style.opacity="1",t.disabled=!1):(t.style.opacity="0.5",t.disabled=!0)}async function lo(){const t=document.getElementById("detail-comment-input"),o=t.value.trim(),a=n.getSelectedCommentSticker?n.getSelectedCommentSticker():Ao;if(console.log("📝 [表情包调试] currentSticker:",a),0===o.length&&!a)return;const i=sessionStorage.getItem("currentTweetData");if(!i)return void mn("无法获取推文信息","error");let r;try{r=JSON.parse(i)}catch(n){return void mn("推文数据解析失败","error")}if(console.log("📝 [提交评论] 开始处理评论提交"),console.log("📝 [提交评论] 推文ID:",r.id),console.log("📝 [提交评论] 推文作者:",r.user.handle),console.log("📝 [提交评论] 当前用户:",n.userProfileData.handle),console.log("📝 [提交评论] 是否为用户推文:",r.id.startsWith("user_")),"private"===r.privacy)return void mn("私有帖子不支持回复功能","error");const s={id:"detail_"+Date.now(),user:{name:n.userProfileData.name,handle:n.userProfileData.handle,avatar:n.userProfileData.avatar,verified:n.userProfileData.verified},content:o,time:"刚刚",replies:[]};an&&(s.image={type:"upload",content:an}),a?(s.sticker={url:a.url,description:a.description},console.log("📝 [表情包调试] 表情包已添加到newComment:",s.sticker)):console.log("📝 [表情包调试] 没有表情包数据"),console.log("📝 [提交评论] 新评论数据:",{id:s.id,content:s.content.substring(0,50)+"...",hasImage:!!s.image,hasSticker:!!s.sticker}),r.comments||(r.comments=[]),r.comments.push(s),r.stats||(r.stats={comments:0,retweets:0,likes:0,views:0}),r.stats.comments=r.comments.length,console.log("📝 [提交评论] 评论已添加到推文数据，当前评论总数:",r.stats.comments);try{const n=e(),t=r.id.startsWith("user_"),o="retweet_mention"===r._source,a="newtweet_mention"===r._source;if(o){console.log("📝 [提交评论] 这是 Mentions 转帖，保存到 Mentions 数据");const e=`mentions_${vt||"main"}`,t=await n.xAccountProfiles.get(e);if(t&&t.data){const e=t.data.findIndex(n=>n.id===r.id&&"retweet"===n.type);-1!==e?(t.data[e].comments=r.comments,t.data[e].stats?t.data[e].stats.comments=r.stats.comments:t.data[e].stats=r.stats,await n.xAccountProfiles.put(t),console.log("✅ [提交评论] Mentions 转帖通知已更新，评论总数:",r.comments.length)):console.warn("⚠️ [提交评论] 未在 Mentions 数据中找到对应的转帖通知:",r.id)}else console.warn("⚠️ [提交评论] 未找到 Mentions 数据:",e)}else if(a){console.log("📝 [提交评论] 这是 Mentions New Tweet，保存到 Mentions 数据");const e=`mentions_${vt||"main"}`,t=await n.xAccountProfiles.get(e);if(t&&t.data){const e=t.data.findIndex(n=>n.id===r._mentionId&&"newTweet"===n.type);-1!==e?(t.data[e].tweet||(t.data[e].tweet={}),t.data[e].tweet.comments=r.comments,t.data[e].tweet.stats?t.data[e].tweet.stats.comments=r.stats.comments:t.data[e].tweet.stats=r.stats,await n.xAccountProfiles.put(t),console.log("✅ [提交评论] Mentions New Tweet 通知已更新，评论总数:",r.comments.length)):console.warn("⚠️ [提交评论] 未在 Mentions 数据中找到对应的 New Tweet 通知:",r._mentionId)}else console.warn("⚠️ [提交评论] 未找到 Mentions 数据:",e)}else if(t){console.log("📝 [提交评论] 这是用户自己的推文，保存到 xUserTweets");const e=`userTweets_${vt||"main"}`,t=await n.xUserTweets.get(e);if(t&&t.tweets){console.log("📝 [提交评论] 找到用户推文数据，推文总数:",t.tweets.length);const e=t.tweets.findIndex(n=>n.id===r.id);-1!==e?(console.log("📝 [提交评论] 找到目标推文，索引:",e),t.tweets[e]=r,await n.xUserTweets.put(t),console.log("✅ [提交评论] 用户推文数据已保存到数据库")):console.warn("⚠️ [提交评论] 未找到目标推文，推文ID:",r.id)}else console.warn("⚠️ [提交评论] 未找到用户推文数据")}else{console.log("📝 [提交评论] 这是主页推文，保存到 xTweetsData");const e=await n.xTweetsData.get("tweets");if(e){let t=!1;if(e.forYouTweets){const n=e.forYouTweets.findIndex(n=>n.id===r.id);-1!==n&&(e.forYouTweets[n]=r,t=!0,console.log("📝 [提交评论] 已更新 forYouTweets"))}if(e.followingTweets&&!t){const n=e.followingTweets.findIndex(n=>n.id===r.id);-1!==n&&(e.followingTweets[n]=r,t=!0,console.log("📝 [提交评论] 已更新 followingTweets"))}t?(await n.xTweetsData.put(e),console.log("✅ [提交评论] 主页推文数据已保存到数据库")):console.warn("⚠️ [提交评论] 未在主页数据中找到目标推文")}}sessionStorage.setItem("currentTweetData",JSON.stringify(r)),console.log("✅ [提交评论] sessionStorage 已更新")}catch(n){console.error("❌ [提交评论] 保存评论到数据库失败:",n),mn("评论保存失败: "+n.message,"error")}const l=document.getElementById("detail-comments-container");console.log("📝 [表情包调试] 渲染前的newComment:",JSON.stringify(s,null,2));const c=en(s);l.appendChild(c),console.log("📝 [提交评论] 评论已渲染到页面");if(document.querySelectorAll(".reply-user-avatar").forEach(e=>{e.src=n.userProfileData.avatar}),n.clearCommentInput)n.clearCommentInput();else{t.value="",t.style.height="20px",an&&ln();const e=document.getElementById("comment-sticker-preview");e&&e.remove(),n.setSelectedCommentSticker?n.setSelectedCommentSticker(null):Ao=null;const o=document.getElementById("detail-reply-btn");o.style.opacity="0.5",o.disabled=!0}mn("你的评论等待回复中","info");const d=r.user&&(r.user.handle===te.handle||r.id.startsWith("user_"));console.log("📝 [提交评论] 准备触发AI回复，isOwnPost:",d),setTimeout(async()=>{try{await Co(r,s,{isOwnPost:d,commentType:"main_comment",pageType:"detail",parentComment:null}),console.log("✅ [提交评论] AI回复生成完成")}catch(n){console.error("❌ [提交评论] AI回复生成失败:",n)}},100),console.log("✅ [提交评论] 评论提交流程完成（AI回复已异步触发）")}async function co(t,o,a){try{console.log("💰 [AI付款] 处理商业任务付款:",t);const i=parseFloat(t.amount||0);if(i<=0)return;await Mt();const r=parseFloat(It.balance)||0;It.balance=r+i;const s=a.user?.name||"对方";let l="";l=t.note?`${s} - ${t.note}`:`商业转账尾款 - ${s}`;const c={id:"business_payment_"+Date.now(),description:l,amount:i,timestamp:(new Date).toISOString(),type:"business_transfer_remaining_in"};It.transactions.unshift(c),await Tt();const d=e(),p=`businessTransfers_${vt||"main"}`,g=await d.xAccountProfiles.get(p);if(g&&g.data){const n=g.data.find(n=>n.transferId===o.transferId);n&&(n.taskStatus="completed",n.completedAt=(new Date).toISOString(),await d.xAccountProfiles.put(g),console.log("✅ [AI付款] 商业转账状态已更新为已完成"))}console.log("✅ [AI付款] 付款完成，金额:",i,"新余额:",It.balance),setTimeout(()=>{Rl({title:"X Wallet",message:`已收款 $${i.toFixed(2)}, 当前余额 $${It.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"})},2e3)}catch(n){console.error("❌ [AI付款] 处理付款失败:",n)}}n.removeUploadedImage=function(n){Wt.splice(n,1);const e=document.getElementById("preview-images-container"),t=document.getElementById("uploaded-image-preview");e.innerHTML="",0===Wt.length?t.style.display="none":Wt.forEach((n,t)=>{const o=document.createElement("div");o.style.cssText="position: relative; border-radius: 8px; overflow: hidden;",o.innerHTML=`\n <img src="${n}" style="width: 100%; height: 150px; object-fit: cover; display: block;" alt="预览图片">\n <div onclick="removeUploadedImage(${t})" style="position: absolute; top: 4px; right: 4px; background-color: rgba(0,0,0,0.7); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.9)'" onmouseout="this.style.backgroundColor='rgba(0,0,0,0.7)'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n `,e.appendChild(o)}),mn("已移除图片","info")},n.goBackFromTweetDetail=function(){const n=sessionStorage.getItem("currentTweetData");if(n)try{const e=JSON.parse(n);if("account"===e._source)return po&&(po=!1,xo(),console.log("📖 [返回] 已重置推进模式")),document.getElementById("x-tweet-detail-page").style.display="none",void(document.getElementById("account-profile-page").style.display="flex");if("search"===e._source){if(po&&(po=!1,xo(),console.log("📖 [返回] 已重置推进模式")),document.getElementById("x-tweet-detail-page").style.display="none",w&&v){document.getElementById("trending-view").style.display="none",document.getElementById("search-results-view").style.display="flex";const n=document.getElementById("search-back-btn");n&&(n.style.display="flex");const e=document.querySelector(".refresh-trends-btn");e&&(e.style.display="none")}return void u("search")}}catch(n){console.warn("解析推文数据失败:",n)}u("home")};let po=!1,go=null;function An(n,e){if(n===e)return 1;if(0===n.length||0===e.length)return 0;const t=n.length>e.length?n:e,o=n.length>e.length?e:n;let a=0;const i=o.split(""),r=t.split("");i.forEach(n=>{const e=r.indexOf(n);-1!==e&&(a++,r.splice(e,1))});const s=a/t.length;return t.includes(o)?Math.max(s,o.length/t.length):s}async function mo(t,o=!1,a=!1){try{const{db:i,xDb:r,apiConfig:l,xSettings:c}=await g.loadConfigAndSettings(),{userPrompt:p,worldSetting:m,boundCharacters:x}=c,u="account"===t._source,h=t.id&&t.id.startsWith("user_"),f=!0===t.isBusinessPost;let b,v=!1,y=null,w=h;if(console.log("🔍 [发帖生成器] 推文类型检测:",{isAccountTweet:u,isUserTweet:h,isBusinessPost:f,tweetId:t.id}),u){console.log("🔍 [AI生成] 检测到账户推文，加载账户资料");let n=Sn;if(!n&&t._accountHandle){const e=t._accountHandle.replace("@","");n=await r.xAccountProfiles.get(e)}if(n){const e=n.accountInfo||n;if(b={name:e.name,handle:e.handle,avatar:e.avatar,verified:e.verified||!1,verificationType:e.verificationType||"none",publicIdentity:e.publicIdentity||"",bio:e.bio||"",knownIdentityCharacters:[]},console.log("✅ [AI生成] 已加载账户资料:",b.name),x&&x.length>0){const n=await r.xCharacterProfiles.toArray(),t=e.handle.replace("@","");for(const o of x){const a=n.find(n=>n.characterId===o);if(a&&a.xHandle===t){v=!0,y=o,console.log("🎭 [AI生成] 识别到绑定角色账户:",e.name,"(",o,")");break}}}}else console.warn("⚠️ [AI生成] 未找到账户资料，使用推文用户信息"),b={name:t.user.name,handle:t.user.handle,avatar:t.user.avatar,verified:t.user.verified||!1,verificationType:t.user.verificationType||"none",publicIdentity:"",bio:"",knownIdentityCharacters:[]}}else if(h)console.log("✅ [发帖生成器] 检测到用户推文，使用用户资料"),b=s.buildUserXProfileInfo(n.userProfileData);else{console.log("🔍 [发帖生成器] 检测到主页推文，查询发帖人资料:",t.user.handle);try{const e=await s.getUnifiedProfile(t.user.handle,{userProfileInfo:n.userProfileData});e?(console.log("✅ [发帖生成器] 已获取发帖人资料:",e.name),"character"===e.type&&x.includes(e.characterId)&&(v=!0,y=e.characterId,console.log("🎭 [发帖生成器] 发帖人是绑定角色:",e.name)),b={name:e.name,handle:e.handle,avatar:e.avatar,verified:e.verified||!1,verificationType:e.xProfile?.xVerified?"verified":"none",publicIdentity:e.publicIdentity||"",bio:e.bio||"",knownIdentityCharacters:[]},w=!1):(console.warn("⚠️ [发帖生成器] 未找到发帖人资料，使用推文用户信息"),b={name:t.user.name,handle:t.user.handle,avatar:t.user.avatar,verified:t.user.verified||!1,verificationType:t.user.verificationType||"none",publicIdentity:"",bio:"",knownIdentityCharacters:[]},w=!1)}catch(n){console.error("❌ [发帖生成器] 获取发帖人资料失败:",n),b={name:t.user.name,handle:t.user.handle,avatar:t.user.avatar,verified:t.user.verified||!1,verificationType:t.user.verificationType||"none",publicIdentity:"",bio:"",knownIdentityCharacters:[]},w=!1}}const k=b;console.log("📋 [发帖生成器] 最终资料信息:",{name:k.name,handle:k.handle,isUserOwnTweet:w,isBoundCharacterAccount:v,boundCharacterIdForAccount:y});let $="";if(w&&k.knownIdentityCharacters.length>0&&x.length>0){const n=(await i.chats.toArray()).filter(n=>!n.isGroup&&k.knownIdentityCharacters.includes(n.id));if(n.length>0){$="\n\n【知道用户身份的角色】：";for(const e of n){let n=await r.xCharacterProfiles.get(e.id);if(n&&($+=`\n- ${n.xName} (${n.xHandle}): 知道用户身份，可能会对用户的帖子进行互动`,e.history&&e.history.length>0)){const n=e.history.slice(-5);$+="\n 最近互动记忆：",n.forEach(n=>{"assistant"===n.role&&n.content&&($+=`\n - ${n.content.substring(0,80)}...`)})}}$+="\n\n注意：这些角色可能会对用户的帖子进行评论，但概率不要太高，要自然。"}}let C=0,I=s.buildBaseSystemPrompt({userPrompt:p,worldSetting:m});C=d.logTokenUsage("发帖生成器","基础系统提示词",I,C);const S={boundCharacters:[]};v&&y?(S.boundCharacters=[y],console.log("📚 [发帖生成器] 加载绑定角色的世界书")):w?(S.boundCharacters=x,console.log("📚 [发帖生成器] 加载用户所有绑定角色的世界书")):(S.boundCharacters=[],console.log("📚 [发帖生成器] 跳过世界书（非用户推文）"));const M=await s.getApplicableWorldBooks("tweetDetail",S);M&&(I+=M,C=d.logTokenUsage("发帖生成器","世界书内容",M,C));const T=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||"")),A=await bn("发帖生成器",{usageRate:.25,isPublicFigure:T,usageDescription:`**发帖评论场景的大事件使用**：\n1. **询问看法**：${T?"高曝光用户":"用户"}发推文时，评论区可能有人询问对大事件的看法\n   - "怎么看最近的XXX事件？"\n   - "能说说你对XXX的态度吗？"\n2. **要求表态**：${T?"遇到灾难/慈善事件，可能被要求捐款或声援":"可能涉及灾难事件的讨论"}\n   - ${T?'"什么时候捐款？"、"请为XXX发声！"':"表达同情或关注"}\n   - ${T?'"明星就该有社会责任感"':""}\n3. **立场站队**：遇到争议事件，${T?"可能被要求表明立场":"评论可能涉及争议话题"}\n   - ${T?'"你支持哪一方？"、"保持沉默就是默认"':"讨论不同观点"}\n4. **网络生态**：评论区要真实（有支持、有质疑、有键盘侠、有理性讨论）\n5. **自然融入**：只有约25%的评论涉及大事件，其余仍然围绕推文本身`});A&&(I+=A,C=d.logTokenUsage("发帖生成器","世界运转大事件",A,C));const E=w?"用户":`${k.name} (${k.handle})`;if(a){const n=t.timestamp||Date.now(),e=Date.now(),o=Math.floor((e-n)/6e4),a=Math.floor(o/60),i=Math.floor(a/24);let r;r=i>0?`${i}天${a%24}小时`:a>0?`${a}小时${o%60}分钟`:`${o}分钟`,I+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：推进帖子互动 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的互动生成器。${E}的帖子已发布一段时间，你的任务是：\n✅ 生成**新的**评论和互动（在已有评论基础上继续）\n✅ 更新互动数据（点赞、转发、浏览量应该增加）\n❌ 绝对不能生成${E}本人发表的任何内容\n❌ 绝对不能重复已有评论的内容或观点\n**时间信息**：\n- 帖子发布已过去：${r}\n- 已有评论数量：${t.comments?.length||0} 条\n**推进模式生成策略**：\n1. **优先生成楼中楼回复**（70%）：\n- 对已有评论进行回复、补充或讨论\n- 使用 replyTo 字段指定回复对象\n- 可以赞同、质疑、或提出新角度\n2. **次要生成新顶层评论**（30%）：\n- 必须带有明显的时间感（"刚看到"、"终于找到"、"现在才发现"等）\n- 角度必须与所有已有评论完全不同\n- 可以是迟到者的独特视角或冷静分析\n3. **内容创新要求**：\n- 不要重复任何已有的观点、表达或句式\n- 提供新的信息、角度或情绪\n- 互动数据应反映热度持续（点赞、转发、浏览量增加）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`}else I+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚫 核心任务说明 🚫\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的互动生成器。${E}刚发布了一条新帖子，你的任务是：\n✅ 生成其他X平台用户对这条帖子的评论和反应\n❌ 绝对不能生成${E}本人发表的任何内容\n**明确：${E}已经发布了推文，你只负责生成别人的回应！**\n${w||v?"":`⚠️ **特别注意**：这是${E}发布的推文，与当前用户无关。\n- 应该生成普通路人用户的评论\n- 评论者是看到这条推文的陌生网友\n- 不要假设评论者与${E}有任何私人关系`}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;const z=I.substring(I.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));C=d.logTokenUsage("发帖生成器","核心任务说明",z,C);let B="";const L=v||w?s.buildUserXProfileInfo(n.userProfileData):null;if(v&&y?(console.log("📋 [发帖生成器] 发帖人是绑定角色，只加载该角色信息（传递真实用户资料以判断身份识别）"),B=await s.buildCompleteCharacterInfo([y],L,"reaction")):w?(console.log("📋 [发帖生成器] 用户推文，加载所有绑定角色信息"),B=await s.buildCompleteCharacterInfo(x,L,"reaction")):(console.log("📋 [发帖生成器] 其他人的推文，不加载用户角色（将生成路人评论）"),B=""),B?(I+=B,C=d.logTokenUsage("发帖生成器","角色资料信息",B,C)):console.log("ℹ️ [发帖生成器] 跳过角色资料（非用户推文或无绑定角色）"),(w||v)&&x&&x.length>0){const n=await s.buildCharacterRelationships(x,vt);n&&(I+=n,C=d.logTokenUsage("发帖生成器","角色关系网络",n,C))}$&&(I+=$,C=d.logTokenUsage("发帖生成器","已知身份角色",$,C));const P=/@(\w+)/g,D=[...t.content.matchAll(P)];if(D.length>0){console.log(`📢 [发帖生成器] 检测到${D.length}个@提及`);const e=[...new Set(D.map(n=>n[1]))];for(const t of e)try{const e=await s.getUnifiedProfile(`@${t}`,{userProfileInfo:w?n.userProfileData:null});if(e){const n=I.length;I+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📢 被@提及的账户资料 📢\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n推文中提到了 ${e.handle}，以下是该账户的详细信息：\n`,I+=s.formatProfileForPrompt(e,{includeType:!0,includeTweets:!0,includeRelationships:!0}),I+="\n⚠️ 被@提及的影响：\n- 该账户看到自己被@提及后，可能会来评论区互动\n- 出现概率根据以下因素决定：\n* 与发帖者的关系（认识/陌生）\n* 推文内容的相关性\n* 该账户的活跃度和性格\n- 如果该账户来评论，必须严格使用上述资料信息\n- 评论内容要符合被@的情境（如被请教、被吐槽、被感谢等）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const t=I.substring(n);C=d.logTokenUsage("发帖生成器",`@提及账户 ${e.handle}`,t,C)}}catch(n){console.error(`❌ [发帖生成器] 读取@${t}资料失败:`,n)}}const R=I.length;I+=s.buildUniversalConstraints(k);const H=I.substring(R);if(C=d.logTokenUsage("发帖生成器","用户资料约束",H,C),a&&t.comments&&t.comments.length>0){const n=I.length;I+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 【已有评论上下文 - 严禁重复】⚠️\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下是该帖子**已存在**的所有评论（共${t.comments.length}条），**绝对不能**生成与这些内容相似或重复的评论：\n`,t.comments.forEach((n,e)=>{I+=`${e+1}. ${n.user.name} (${n.user.handle}): "${n.content}"`,n.sticker&&(I+=` [含表情包: ${n.sticker.description}]`),n.image&&(I+=" [含图片]"),I+="\n",n.replies&&n.replies.length>0&&n.replies.forEach(n=>{I+=` └─ ${n.user.name} (${n.user.handle}): "${n.content}"`,n.sticker&&(I+=` [含表情包: ${n.sticker.description}]`),n.image&&(I+=" [含图片]"),I+="\n"})}),I+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚫 【严格要求 - 必须遵守】🚫\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n1. **绝对禁止**重复上述任何评论的观点、内容或表达方式\n2. **绝对禁止**使用与上述评论相似的句式或措辞\n3. **必须生成**全新的、不同角度的评论\n4. 新评论应该：\n- 提出完全不同的观点或看法\n- 使用不同的表达方式和语气\n- 可以是对已有评论的**补充回复**（楼中楼，使用replyTo字段）\n- 可以从时间角度切入（如"刚看到"、"终于找到这个帖子"等）\n- 可以是新角度的提问、质疑或讨论\n5. 如果实在找不到新角度，优先生成楼中楼回复而非新评论\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';const e=I.substring(n);C=d.logTokenUsage("发帖生成器","已有评论上下文",e,C)}I+=`\n【生成要求】：\n- 生成${a?"3-8":"3-15"}条评论，内容多样化（简短/深度/表情符号），支持楼中楼回复，全年龄适宜\n${a?'- ⚠️ **推进模式特殊要求**：\n* 优先生成楼中楼回复（对已有评论的回复）而非新的顶层评论\n* 新顶层评论必须有明显的时间感（如"刚看到"、"现在才发现"等）\n* 新评论角度要与已有评论**完全不同**，不要重复任何观点\n* 可以是后来者的补充、质疑、或从全新角度的讨论':""}\n${f?'- 💼 **商业推文特殊要求**：\n* 这是一条商业化推文（广告/推广性质），数据应该更高\n* 互动数据（点赞、转发、浏览量）应该是普通推文的1.5-3倍\n* 评论区应该有30-50%是正面支持性评论（"支持！"、"好棒"、"已下单"等）\n* 20-30%是询问相关信息的评论（"在哪买"、"多少钱"、"怎么联系"等）\n* 10-20%可以是中性或轻微质疑的评论（保持真实感）\n* 评论风格应该更像粉丝/潜在客户，而非批评者\n* 如果用户有较高知名度，应该体现出粉丝经济效应':""}\n- 引用转发处理：如帖子含引用内容，评论可涉及用户观点和被引用原内容\n- 公众身份影响：知名度越高，讨论热度和互动数据越多\n- 除了绑定角色外，其他用户头像统一：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n- 图片支持：评论可以包含文字图片（10-20%的评论带图），用于展示图片视频等媒体，图片描述应详细具体\n【🔒 隐私保护规则 - 路人评论限制】：\n🚨 路人评论者（非绑定角色/关系NPC的普通用户）只能基于X平台公开信息：\n✅ 可以使用：X姓名、X句柄、X简介、公开身份\n❌ 禁止提及：真实姓名、真实职业、私人关系、未公开的身份信息\n❌ 禁止使用：只有亲密关系才知道的称呼（如"老师"、"同学"、"同事"等，除非是公开身份）\n❌ 禁止提及：角色人设描述中的私密细节\n示例说明：\n- ✅ 正确："@handle 姐姐太美了"（基于公开身份"网红"）\n- ❌ 错误："@handle 张老师这节课讲得真好"（泄露了真实职业"老师"和真实姓氏）\n- ❌ 错误："@handle 李老师今天也这么漂亮"（泄露了真实姓名）\n⚠️ 只有已绑定的关系NPC才能提及私密信息（因为他们是角色的私人关系）\n【情侣角色回复规则】：\n${"couple"===k.verificationType&&k.coupleCharacterName?`- 用户的情侣是 ${k.coupleCharacterName}（公开关系）\n- 出现概率应很低（10-20%，与帖子无关时更低）\n- 评论围绕帖子主题，自然体现亲密关系但不过分强调\n- 粉丝群体限制：仅当双方为明星/网红/公众人物时才可能生成1-2条CP粉丝评论，普通情侣严禁生成"磕CP""嗑糖"等粉丝向评论`:""}\n【JSON返回格式】：\n\`\`\`json\n{\n"stats": {retweets, likes, views, comments},\n"comments": [评论数组]${!w||o||a?"":',\n"mentions": {\n  "likes": [点赞通知数组，1-2条],\n  "retweets": [转帖通知数组，1-3条]\n}'+(f?',\n"tips": [打赏记录数组，3-8条]':"")}\n}\n\`\`\`\n评论对象结构：\n- user: {name, handle, avatar, verified}\n- content: 评论文本 (可与sticker同时存在)\n- timeOffset: 相对推文发布的分钟数（负数，如-5表示推文发布后5分钟的评论）\n- sticker: {url: "表情包链接", description: "表情包描述"} (可选，约10-15%评论使用)\n- image: {type: "description", content: "图片文字描述"} (可选，10-20%的评论带图)\n- replies: [回复数组] (可选，楼中楼回复，不超过3层)\n- replyTo: "@被回复者句柄" (楼中楼回复时必填)\n${!w||o||a?"":`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔔 Mentions通知对象结构（必须生成）🔔\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n点赞通知对象：\n{\n  "id": "mention_like_xxx",\n  "type": "like",\n  "users": [{name, handle, avatar: "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg", verified: false}], // 3个用户\n  "othersCount": ${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"50-500之间的数字（用户是公众人物）":"5-50之间的数字（用户是普通用户）"},\n  "time": "时间描述（如'2小时前'）",\n  "tweet": {"content": "被点赞的推文内容（与用户推文一致）", "image": null或图片描述}\n}\n\n转帖通知对象：\n{\n  "id": "mention_retweet_xxx",\n  "type": "retweet",\n  "user": {name, handle, avatar: "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg", verified: false},\n  "retweetContent": "转帖者添加的评论内容",\n  "time": "时间描述",\n  "quotedTweet": {\n    "user": {"name": "${k.name}", "handle": "${k.handle}", "avatar": "${k.avatar}", "verified": ${k.verified||!1}},\n    "content": "原推文内容（与用户推文一致）",\n    "stats": {comments, retweets, likes}\n  },\n  "stats": {\n    "comments": ${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"100-500":"5-20"},\n    "retweets": ${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"500-2000":"10-50"},\n    "likes": ${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"1000-5000":"20-100"},\n    "views": ${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"5000-50000":"100-1000"}\n  },\n  "comments": [2-5条评论，结构同上]\n}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`}${w&&!o&&!a&&f?`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎁 打赏记录对象结构（商业推文必须生成）🎁\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n{\n  "name": "打赏者姓名",\n  "handle": "@username",\n  "amount": 25.00（数字，${/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test((k.publicIdentity||"")+" "+(k.bio||""))?"15-80":"5-30"}），\n  "note": "打赏备注（简短、真诚、与推文内容相关）"\n}\n生成3-8条打赏记录，根据推文数据表现：\n- 浏览量<1000：3-4条\n- 浏览量1000-5000：4-6条\n- 浏览量>5000：6-8条\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`:""}\n【表情包使用规则】：\n- 表情包仅限使用世界书中提供的真实链接，严禁虚构或编造链接\n- 表情包与文字内容可以同时存在，用于增强表达效果\n- 使用频率控制在约10-15%的评论中，保持自然\n- sticker对象包含url和description两个必需字段\n\n关键规则：\n1. verified字段必须是布尔值(true/false)\n2. stats中所有数字必须是纯数字\n3. timeOffset必须是负数，表示评论发布在推文之后多少分钟（如-5, -10, -30等）\n4. 支持多层对话链：A评论 → B回复A(replyTo:"@A") → C回复B(replyTo:"@B")\n5. sticker字段只能使用世界书中存在的真实链接，禁止虚构${!w||o||a?"":"\n6. 🔔 **mentions字段必须生成**（点赞和转帖通知）\n7. 所有通知的头像统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n8. 转帖必须包含comments数组（2-5条评论）"}${w&&!o&&!a&&f?"\n9. 🎁 **tips字段必须生成**（商业推文的打赏记录）\n10. amount必须是数字类型，保留两位小数":""}`;const j=I.substring(I.lastIndexOf("【JSON返回格式】"));C=d.logTokenUsage("发帖生成器","JSON格式要求",j,C);const U=[];let O=`请为这条推文生成社交互动数据：\n推文内容："${t.content}"\n${t.location?`位置：${t.location}`:""}`;if(t.link&&(O+="\n\n【附带链接】：",t.link.title&&(O+=`\n标题：${t.link.title}`),t.link.url&&(O+=`\n地址：${t.link.url}`),t.link.description&&(O+=`\n描述：${t.link.description}`),t.link.thumbnail&&(O+="\n[含链接首图]")),t.quotedTweet){const n=t.quotedTweet,e="tweet"===n.type?"推文":"评论";O+=`\n【引用${e}】：\n原作者：${n.user.name} (${n.user.handle})${n.user.verified?" ✓已认证":""}\n发布时间：${n.time}\n原内容："${n.content}"`,n.image&&("description"===n.image.type?O+=`\n原图片描述：${n.image.content}`:"upload"===n.image.type&&(O+="\n原图片：包含上传的图片内容")),n.location&&(O+=`\n原位置：${n.location}`),O+=`\n注意：这是一条引用转发，用户对原${e}进行了评论并转发。AI回复应该考虑到这个引用关系和上下文，生成的评论可能会同时涉及用户的评论和被引用的原内容。`}if(t.quotedFanGroup){const n=t.quotedFanGroup;O+=`\n【引用粉丝群】：\n群名：${n.name}\n当前成员数：${n.memberCount||0} 位\n入群门槛：${n.threshold||"无"}\n注意：这是一条转发粉丝群链接的推文，用户在宣传/分享自己的粉丝群。AI回复应该：\n1. 考虑粉丝群的主题和门槛要求\n2. 评论者可能对加入粉丝群表示兴趣，询问详情\n3. 评论者可能讨论入群门槛是否合理\n4. 如果门槛涉及金钱，可能有人讨论价格\n5. 真实粉丝会表示支持，普通路人会好奇询问，也可能有质疑的声音\n6. 评论应该围绕"粉丝群招募"这个核心话题展开`}U.push({type:"text",text:O}),t.image&&("upload"===t.image.type&&t.image.content?U.push({type:"image_url",image_url:{url:t.image.content}}):"uploads"===t.image.type&&t.image.images&&t.image.images.length>0?t.image.images.forEach((n,e)=>{n.content&&U.push({type:"image_url",image_url:{url:n.content}})}):"description"===t.image.type&&U.push({type:"text",text:`图片描述：${t.image.content}`}));const _=[{role:"user",content:U}],F=U.map(n=>n.text||"[图片]").join(" ");C=d.logTokenUsage("发帖生成器","上下文信息",F,C),d.logFinalPrompt("发帖生成器",I,F);const X=await g.sendAIRequest({apiConfig:l,systemPrompt:I,messages:_,temperature:.8});console.log("用户身份识别调试信息（发帖AI回复）:"),console.log("- 用户X资料:",k),console.log("- 知道用户身份的角色数量:",k.knownIdentityCharacters.length),$&&console.log("- 知道用户身份的角色信息已添加到AI上下文");let q=g.parseJSONResponse(X);if(q=await g.postProcessData(q,k),!q.stats||!q.comments)throw new Error("AI返回的数据格式不正确");if(a&&t.comments&&t.comments.length>0){const n=t.comments,e=q.comments||[],o=e.filter(e=>{const t=e.content.toLowerCase().trim();return!n.some(n=>{const o=n.content.toLowerCase().trim();if(o===t)return!0;const a=An(t,o);return a>.7?(console.log(`🔍 [重复检测] 发现相似评论 (${(100*a).toFixed(0)}%):`,{existing:n.content,new:e.content}),!0):!!(n.replies&&n.replies.length>0)&&n.replies.some(n=>{const e=n.content.toLowerCase().trim();if(e===t)return!0;const o=An(t,e);return o>.7&&(console.log(`🔍 [重复检测] 发现与楼中楼回复相似的评论 (${(100*o).toFixed(0)}%)`),!0)})})}),a=e.length-o.length;if(a>0&&(console.log(`✅ [去重] 移除了 ${a} 条重复评论，保留 ${o.length} 条新评论`),q.comments=o),0===o.length)return void mn("AI生成的评论与已有内容重复，已自动过滤","warning")}const V=Date.now();let G=t.timestamp||V;"number"!=typeof G&&(G=G instanceof Date?G.getTime():"string"==typeof G?new Date(G).getTime():V),(isNaN(G)||G<=0)&&(console.warn("⚠️ [发帖生成器] 推文时间戳无效，使用当前时间"),G=V),q.comments.forEach((n,e)=>{if(n.id=`ai_${V}_${e}`,a){const e=Math.floor(60*Math.random());n.timestamp=V-60*e*1e3,delete n.timeOffset}else void 0!==n.timeOffset?(n.timestamp=G+60*Math.abs(n.timeOffset)*1e3,delete n.timeOffset):n.timestamp||(n.timestamp=G+60*(5+30*Math.random())*1e3);n.replies&&n.replies.length>0&&n.replies.forEach((t,o)=>{t.id=`ai_${V}_${e}_${o}`,a?(t.timestamp=n.timestamp+60*(1+10*Math.random())*1e3,delete t.timeOffset):void 0!==t.timeOffset?(t.timestamp=G+60*Math.abs(t.timeOffset)*1e3,delete t.timeOffset):t.timestamp||(t.timestamp=n.timestamp+60*(1+10*Math.random())*1e3)})}),await async function(n,t,o=!1,a=!1){const i=document.getElementById("tweet-detail-stats");i&&(i.innerHTML=`\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(t.stats.retweets)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailRetweets")}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(t.stats.likes)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailLikes")}</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="color: #fff; font-weight: 700; font-size: 15px;">${N(t.stats.comments)}</span>\n <span style="color: #71767b; font-size: 15px;">${jn("tweetDetailBookmarks")}</span>\n </div>\n `);const r=document.getElementById("tweet-detail-views"),s=document.getElementById("tweet-detail-views-label");r&&(r.textContent=N(t.stats.views));s&&(s.textContent=jn("tweetDetailViews"));const l=document.getElementById("detail-comments-container");o&&!a&&l&&(l.innerHTML="");l&&t.comments.length>0&&t.comments.forEach(n=>{const e=document.createElement("div");e.style.cssText="position: relative;";const t=en(n);n.replies&&n.replies.length>0&&t.classList.add("has-replies"),e.appendChild(t),n.replies&&n.replies.length>0&&n.replies.forEach(n=>{const t=en(n,!0);e.appendChild(t)}),l.appendChild(e)});await async function(n,t,o=!1){try{const a=e(),i=sessionStorage.getItem("currentTweetData");let r=!1,s=!1,l=null;if(i)try{const n=JSON.parse(i);r="account"===n._source,s="search"===n._source,l=n._accountHandle}catch(n){console.warn("解析推文数据失败:",n)}if(s){console.log("📝 [更新数据] 检测到搜索结果推文，更新搜索数据");const e=await a.xTweetsData.get("tweets");if(e){let r=!1;if(e.forYouTweets){const a=e.forYouTweets.findIndex(e=>e.id===n);if(-1!==a){if(o){const n=e.forYouTweets[a].stats;e.forYouTweets[a].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const o=e.forYouTweets[a].comments||[];e.forYouTweets[a].comments=[...o,...t.comments||[]]}else e.forYouTweets[a].stats={...e.forYouTweets[a].stats,...t.stats},e.forYouTweets[a].comments=t.comments||[];r=!0,console.log(`📈 [搜索推文] forYouTweets 新增 ${t.comments?.length||0} 条评论`)}}if(e.followingTweets&&!r){const a=e.followingTweets.findIndex(e=>e.id===n);if(-1!==a){if(o){const n=e.followingTweets[a].stats;e.followingTweets[a].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const o=e.followingTweets[a].comments||[];e.followingTweets[a].comments=[...o,...t.comments||[]]}else e.followingTweets[a].stats={...e.followingTweets[a].stats,...t.stats},e.followingTweets[a].comments=t.comments||[];r=!0,console.log(`📈 [搜索推文] followingTweets 新增 ${t.comments?.length||0} 条评论`)}}if(r){if(await a.xTweetsData.put(e),i)try{const e=JSON.parse(i);e.id===n&&(e.stats=t.stats,e.comments=e.comments||[],e.comments=o?[...e.comments,...t.comments||[]]:t.comments||[],sessionStorage.setItem("currentTweetData",JSON.stringify(e)))}catch(n){console.warn("更新 sessionStorage 失败:",n)}return void console.log("✅ 搜索推文AI反应已保存:",n,o?"(推进模式)":"")}}}if(r&&l){console.log("📝 [更新数据] 检测到账户推文，更新账户主页数据");const e=l.replace("@",""),r=await a.xAccountProfiles.get(e);if(r&&r.tweets){const e=r.tweets.findIndex(e=>e.id===n);if(-1!==e){if(o){const n=r.tweets[e].stats;r.tweets[e].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const o=r.tweets[e].comments||[];r.tweets[e].comments=[...o,...t.comments||[]],console.log(`📈 [账户推文] 新增 ${t.comments?.length||0} 条评论`)}else r.tweets[e].stats={...r.tweets[e].stats,...t.stats},r.tweets[e].comments=t.comments||[];if(await a.xAccountProfiles.put(r),i)try{const t=JSON.parse(i);t.id===n&&(t.stats=r.tweets[e].stats,t.comments=r.tweets[e].comments,sessionStorage.setItem("currentTweetData",JSON.stringify(t)))}catch(n){console.warn("更新 sessionStorage 失败:",n)}return void console.log("✅ 账户推文AI反应已保存:",n,o?"(推进模式)":"")}}}if(!(n&&n.startsWith("user_"))){console.log("📝 [更新数据] 检测到主页推文，更新主页数据");const e=await a.xTweetsData.get("tweets");if(e){let r=!1;if(e.forYouTweets){const a=e.forYouTweets.findIndex(e=>e.id===n);if(-1!==a){if(o){const n=e.forYouTweets[a].stats;e.forYouTweets[a].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const o=e.forYouTweets[a].comments||[];e.forYouTweets[a].comments=[...o,...t.comments||[]]}else e.forYouTweets[a].stats={...e.forYouTweets[a].stats,...t.stats},e.forYouTweets[a].comments=t.comments||[];r=!0,console.log(`📈 [主页推文] forYouTweets 新增 ${t.comments?.length||0} 条评论`)}}if(e.followingTweets&&!r){const a=e.followingTweets.findIndex(e=>e.id===n);if(-1!==a){if(o){const n=e.followingTweets[a].stats;e.followingTweets[a].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const o=e.followingTweets[a].comments||[];e.followingTweets[a].comments=[...o,...t.comments||[]]}else e.followingTweets[a].stats={...e.followingTweets[a].stats,...t.stats},e.followingTweets[a].comments=t.comments||[];r=!0,console.log(`📈 [主页推文] followingTweets 新增 ${t.comments?.length||0} 条评论`)}}if(r){if(await a.xTweetsData.put(e),i)try{const e=JSON.parse(i);e.id===n&&(e.stats=t.stats,e.comments=e.comments||[],e.comments=o?[...e.comments,...t.comments||[]]:t.comments||[],sessionStorage.setItem("currentTweetData",JSON.stringify(e)))}catch(n){console.warn("更新 sessionStorage 失败:",n)}return void console.log("✅ 主页推文AI反应已保存:",n,o?"(推进模式)":"")}console.warn("⚠️ 未在主页数据中找到要更新的推文:",n)}return}const c=`userTweets_${vt||"main"}`;let d=await a.xUserTweets.get(c);if(!d)return void console.warn("未找到用户推文数据，账户ID:",c);const p=d.tweets.findIndex(e=>e.id===n);if(-1!==p){if(o){const n=d.tweets[p].stats;d.tweets[p].stats={comments:Math.max(n.comments,t.stats.comments),retweets:Math.max(n.retweets,t.stats.retweets),likes:Math.max(n.likes,t.stats.likes),views:Math.max(n.views,t.stats.views)};const e=d.tweets[p].comments||[];d.tweets[p].comments=[...e,...t.comments||[]],console.log(`📈 [推进模式] 新增 ${t.comments?.length||0} 条评论`)}else d.tweets[p].stats={...d.tweets[p].stats,...t.stats},d.tweets[p].comments=t.comments||[];if(await a.xUserTweets.put(d),i)try{const e=JSON.parse(i);e.id===n&&(e.stats=d.tweets[p].stats,e.comments=d.tweets[p].comments,sessionStorage.setItem("currentTweetData",JSON.stringify(e)))}catch(n){console.warn("更新 sessionStorage 失败:",n)}console.log("✅ 推文AI反应已保存到数据库:",n,"账户:",c,o?"(推进模式)":""),function(){const n=document.getElementById("x-profile-tweets-container");n&&"none"!==n.parentElement.style.display&&$o()}()}else console.warn("⚠️ 未找到要更新的推文:",n)}catch(n){console.error("❌ 更新存储推文数据失败:",n)}}(n,t,a)}(t.id,q,o,a);const Y=document.getElementById("x-tweet-detail-page");if(Y&&"flex"===Y.style.display){const n=sessionStorage.getItem("currentTweetData");if(n){if(JSON.parse(n).id===t.id){const n=e(),o=`userTweets_${vt||"main"}`,a=await n.xUserTweets.get(o);if(a){const n=a.tweets.find(n=>n.id===t.id);n&&(await io(n),console.log("✅ 详情页已刷新，显示最新AI反应"))}}}}const W="en"===Hn,J=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";if(Rl({title:"X",message:a?W?"Your post interaction has been progressed!":"帖子互动已推进！":W?"Someone replied to your post!":"你的帖子有人回复了哦！",avatar:J,leftIcon:"x"}),w&&!o&&!a){if(q.mentions){console.log("🔔 [Mentions] AI已生成通知数据，开始处理");try{const n=q.mentions,o=Date.now();n.likes&&Array.isArray(n.likes)&&n.likes.forEach((n,e)=>{n.id||(n.id=`mention_like_${o}_${e}`),n.timestamp=o-60*(5+30*Math.random())*1e3}),n.retweets&&Array.isArray(n.retweets)&&n.retweets.forEach((n,e)=>{n.id||(n.id=`mention_retweet_${o}_${e}`),n.timestamp=o-60*(10+50*Math.random())*1e3,n.originalTweetId=t.id,n.comments&&n.comments.length>0&&n.comments.forEach((t,a)=>{t.id||(t.id=`mention_retweet_${o}_${e}_c${a}`),t.timestamp||(t.timestamp=n.timestamp+60*(5+30*Math.random())*1e3)})});const a=e(),i=`mentions_${vt||"main"}`;let r=await a.xAccountProfiles.get(i);r||(r={handle:i,id:i,data:[]});const s=[...n.likes||[],...n.retweets||[]];r.data=[...s,...r.data],await a.xAccountProfiles.put(r),console.log(`✅ [Mentions] 已保存 ${n.likes?.length||0} 条点赞通知，${n.retweets?.length||0} 条转帖通知`),vn("notifications")}catch(n){console.error("❌ [Mentions] 保存通知失败:",n)}}if(f&&q.tips&&Array.isArray(q.tips)){console.log(`🎁 [打赏] AI已生成 ${q.tips.length} 条打赏数据，开始调度`);try{const e=18e6;q.tips.forEach((o,a)=>{const i=Math.random()*e;console.log(`🎁 [打赏调度] 打赏 #${a+1} 将在 ${Math.round(i/1e3/60)} 分钟后触发`),setTimeout(async()=>{try{if(await Mt(),!It.isActivated)return void console.warn("🎁 [打赏通知] 钱包未激活，跳过打赏");const e=parseFloat(o.amount);It.balance+=e;const a={id:"tip_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:`来自 ${o.name} 的打赏`,amount:e,timestamp:(new Date).toISOString(),type:"tip",note:o.note,tipper:{name:o.name,handle:o.handle},tweetId:t.id};It.transactions.unshift(a),await Tt(),console.log(`🎁 [打赏通知] 打赏已入账: +$${e.toFixed(2)}`),Rl({title:`收到来自 ${o.name} 的赠金`,message:`+$${e.toFixed(2)} - ${o.note}`,avatar:n.userProfileData?.avatar,leftIcon:"custom",leftIconHtml:'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #22c55e;"><g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"></path></g></svg>',duration:4e3}),mn(`收到打赏 +$${e.toFixed(2)}`,"success")}catch(n){console.error("🎁 [打赏通知] 处理打赏失败:",n)}},i)})}catch(n){console.error("🎁 [打赏] 调度失败:",n)}}}if(!o&&!a){const n=/@(\w+)/g,e=[...t.content.matchAll(n)];if(e.length>0&&k&&k.handle){const n=k.handle;e.forEach(e=>{const o=`@${e[1]}`;qc(n,o,"mention",t.content).catch(n=>{console.error("拉黑解除检测失败（静默）:",n)})})}}}catch(n){console.error("生成AI回复失败:",n),mn(`回复生成失败: ${n.message}`,"error")}}function xo(){const n=document.getElementById("reroll-replies-btn");if(!n)return;const e=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff";let t=!1;const o=sessionStorage.getItem("currentTweetData");if(o)try{const n=JSON.parse(o);t="account"===n._source||"search"===n._source}catch(n){console.warn("解析推文数据失败:",n)}po?(n.innerHTML=`\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${e}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M3 12h4l3 8l4 -16l3 8h4" />\n </svg>\n `,n.setAttribute("title",t?"推进帖子互动（追加新评论）":"推进帖子互动（追加新评论）\n长按切换到重新生成模式")):(n.innerHTML=`\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: ${e};">\n <g>\n <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />\n </g>\n </svg>\n `,n.setAttribute("title","重新生成回复\n长按切换到推进模式"))}function uo(){const n=document.getElementById("tweet-detail-container");return n?n.getAttribute("data-tweet-id"):null}async function ho(){try{const n=e(),t=`userTweets_${vt||"main"}`,o=await n.xUserTweets.get(t);return o?o.tweets:[]}catch(n){return console.error("获取用户推文失败:",n),[]}}n.toggleTweetProgressMode=function(){const n=sessionStorage.getItem("currentTweetData");if(n)try{const e=JSON.parse(n),t="account"===e._source,o="search"===e._source;if((t||o)&&po)return void mn("该推文只支持推进模式","warning")}catch(n){console.warn("解析推文数据失败:",n)}po=!po,xo(),po?mn("已切换到推进模式 - 将追加新评论","success"):mn("已切换到重新生成模式 - 将覆盖现有评论","info")},n.handleTweetRerollButtonMouseDown=function(){go=setTimeout(()=>{toggleTweetProgressMode()},800)},n.handleTweetRerollButtonMouseUp=function(){go&&(clearTimeout(go),go=null)};let fo=!1,bo=new Set;function vo(n,e){e&&(e.preventDefault(),e.stopPropagation());const t=document.getElementById("tweet-action-menu");t&&t.remove(),ho().then(e=>{const t=e.find(e=>e.id===n);if(!t)return;const o=t.pinned||!1,a=document.createElement("div");a.id="tweet-action-menu",a.style.cssText="\n position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color:#000; border: 1px solid #2f3336; border-radius: 16px; min-width: 280px; z-index: 10000; box-shadow: 0 8px 24px rgba(0,0,0,0.5); ",a.innerHTML=`\n <div style="padding: 12px 0;">\n <div onclick="toggleTweetPin('${n}')" style="padding: 12px 16px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'" onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 32 32" style="width: 18px; height: 18px; fill: currentColor;">\n <path d="M20.743 14.815l-0.933-12.065h5.191c0.414 0 0.75-0.336 0.75-0.75s-0.336-0.75-0.75-0.75v0h-18c-0.414 0-0.75 0.336-0.75 0.75s0.336 0.75 0.75 0.75v0h5.432l-1.275 12.103c-3.213 0.959-5.574 3.738-5.904 7.113l-0.003 0.034c0 0.414 0.336 0.75 0.75 0.75h9.25v7.25c0 0.414 0.336 0.75 0.75 0.75s0.75-0.336 0.75-0.75v0-7.25h9.25c0.414-0 0.75-0.336 0.75-0.75v0c0-3.017-2.35-5.787-6.007-7.185zM12.104 16.081c0.096-0.035 0.179-0.085 0.249-0.148l-0.001 0.001 0.005-0.003c0.126-0.117 0.211-0.275 0.233-0.453l0-0.004 0.011-0.022 1.337-12.701h4.367l0.979 12.681c0.033 0.35 0.303 0.627 0.647 0.67l0.004 0c2.542 0.682 4.512 2.623 5.222 5.096l0.013 0.052h-18.341c0.729-2.54 2.714-4.49 5.222-5.157l0.052-0.012z"></path>\n </svg>\n <span>${o?"取消置顶":"置顶到个人资料"}</span>\n </div>\n <div onclick="enterMultiSelectModeFromMenu('${n}')" style="padding: 12px 16px; color: #fff; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'" onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n <g><path d="M9 2C6.243 2 4 4.243 4 7v10c0 2.757 2.243 5 5 5h6c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H9zm0 2h6c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H9c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm6.207 3.793l-5.5 5.5-2.414-2.414-1.414 1.414 3.121 3.121.707.707.707-.707 6.207-6.207-1.414-1.414z"></path></g>\n </svg>\n <span>选择多条推文</span>\n </div>\n <div onclick="deleteSingleTweet('${n}')" style="padding: 12px 16px; color: #f4212e; font-size: 15px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'" onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n <g><path d="M16 6V4.5C16 3.12 14.88 2 13.5 2h-3C9.11 2 8 3.12 8 4.5V6H3v2h1.06l.81 11.21C4.98 20.78 6.28 22 7.86 22h8.27c1.58 0 2.88-1.22 3-2.79L19.93 8H21V6h-5zm-6-1.5c0-.28.22-.5.5-.5h3c.27 0 .5.22.5.5V6h-4V4.5zm7.13 14.57c-.04.52-.47.93-1 .93H7.86c-.53 0-.96-.41-1-.93L6.07 8h11.85l-.79 11.07zM9 17v-6h2v6H9zm4 0v-6h2v6h-2z"></path></g>\n </svg>\n <span>删除</span>\n </div>\n </div>\n <div onclick="closeTweetActionMenu()" style="padding: 12px 16px; color: #71767b; font-size: 15px; font-weight: 500; cursor: pointer; text-align: center; border-top: 1px solid #2f3336; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.03)'" onmouseout="this.style.backgroundColor='transparent'">\n 取消\n </div>\n `,document.body.appendChild(a),setTimeout(()=>{document.addEventListener("click",function n(e){a.contains(e.target)||(a.remove(),document.removeEventListener("click",n))})},100)})}function yo(n){fo||wo();const e=document.querySelector(`[data-tweet-id="${n}"]`);e&&(bo.has(n)?(bo.delete(n),e.classList.remove("selected"),e.style.backgroundColor=""):(bo.add(n),e.classList.add("selected"),e.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)"),ko())}function wo(){fo=!0,function(){let n=document.getElementById("delete-toolbar");n||(n=document.createElement("div"),n.id="delete-toolbar",n.style.cssText="\n position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color:#000; border: 1px solid #333; border-radius: 20px; padding: 8px 16px; display: flex; align-items: center; gap: 12px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); ",n.innerHTML='\n <button onclick="selectAllTweets()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">\n 全选\n </button>\n <span id="selected-count" style="color: #fff; font-size: 14px;">已选择 0 条</span>\n <button onclick="deleteSelectedTweets()" style="background-color: #f91880; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">\n 删除\n </button>\n <button onclick="exitMultiSelectMode()" style="background-color: #333; color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 13px; cursor: pointer;">\n 取消\n </button>\n ',document.body.appendChild(n));n.style.display="flex"}(),document.querySelectorAll(".user-tweet-item").forEach(n=>{n.style.borderLeft="3px solid var(--x-accent)"})}function ko(){const n=document.getElementById("selected-count");n&&(n.textContent=`已选择 ${bo.size} 条`)}async function $o(){try{const n=await ho(),e=document.getElementById("x-profile-tweets-container");if(0===n.length)e.innerHTML='\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;">还没有推文</div>\n <div style="color: #71767b; font-size: 15px;">当你发送第一条推文时，它会显示在这里。</div>\n </div>\n ';else{const t=[...n].sort((n,e)=>{const t=n.pinned||!1,o=e.pinned||!1;return t&&!o?-1:!t&&o?1:0});e.innerHTML="",t.forEach(n=>{const t=function(n){const e=document.createElement("div");let t;e.className="user-tweet-item",e.dataset.tweetId=n.id,e.style.cursor="pointer",e.style.position="relative",e.style.borderBottom="1px solid var(--x-border-color)",e.style.display="block";let o=!1,a=0,i=0,r=!1,s=0;const l=15,c=300;e.addEventListener("touchstart",e=>{const s=e.touches[0];a=s.clientX,i=s.clientY,r=!1,t=setTimeout(()=>{r||(o=!0,vo(n.id,e),e.preventDefault())},800)}),e.addEventListener("touchmove",n=>{const e=n.touches[0],o=Math.abs(e.clientX-a),s=Math.abs(e.clientY-i);(o>l||s>l)&&(r=!0,clearTimeout(t))}),e.addEventListener("touchend",e=>{clearTimeout(t);const a=Date.now();if(a-s<c)return console.log("🚫 [触摸] 防抖拦截，忽略重复触摸"),void e.preventDefault();s=a,o||r?o&&e.preventDefault():(e.preventDefault(),fo?yo(n.id):io(n)),o=!1,r=!1});let d=0;function p(n){if(!n.image)return"";if("description"===n.image.type)return`\n <div style="margin-top: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 12px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 14px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.image.content}</div>\n </div>\n `;if("upload"===n.image.type)return`\n <div style="margin-top: 12px; border-radius: 12px; overflow: hidden;">\n <img src="${n.image.content}" style="width: 100%; max-height: 200px; object-fit: cover; display: block;" alt="推文图片">\n </div>\n `;if("uploads"===n.image.type&&n.image.images&&n.image.images.length>0){const e=n.image.images.length;let t="";t=1===e?"grid-template-columns: 1fr;":"grid-template-columns: repeat(2, 1fr);";return`\n <div style="margin-top: 12px; display: grid; ${t} gap: 4px;">\n ${n.image.images.map((n,t)=>`\n <div style="${3===e&&0===t?"grid-column: span 2;":""}border-radius: 8px; overflow: hidden;">\n <img src="${n.content}" style="width: 100%; height: ${1===e?"200px":"150px"}; object-fit: cover; display: block;" alt="推文图片${t+1}">\n </div>\n `).join("")}\n </div>\n `}return""}function g(n){return n.link?`\n <div style="margin-top: 12px; border: 1px solid #333; border-radius: 12px; overflow: hidden;">\n ${n.link.thumbnail?`\n <div style="width: 100%; height: 150px; background-color: #333;">\n <img src="${n.link.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;" alt="链接预览图">\n </div>\n `:""}\n <div style="padding: 12px;">\n <div style="color: #71767b; font-size: 13px; margin-bottom: 4px;">${n.link.url||"链接"}</div>\n ${n.link.title?`<div style="color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 4px;">${n.link.title}</div>`:""}\n ${n.link.description?`<div style="color: #71767b; font-size: 13px;">${n.link.description}</div>`:""}\n </div>\n </div>\n `:""}function x(n){return n.image?"description"===n.image.type?`\n <div style="margin-top: 6px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 6px; padding: 6px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.image.content}</div>\n </div>\n `:"upload"===n.image.type?`\n <div style="margin-top: 6px; border-radius: 6px; overflow: hidden;">\n <img src="${n.image.content}" style="width: 100%; max-height: 80px; object-fit: cover; display: block;" alt="引用图片">\n </div>\n `:"":""}function u(n){if(!n.quotedTweet)return"";const e=n.quotedTweet,t="tweet"===e.type?"推文":"评论";return`\n <div style="margin-top: 12px; border: 1px solid var(--x-border-color); border-radius: 12px; padding: 12px; background-color: var(--x-bg-hover);">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <img src="${e.user.avatar}" style="width: 20px; height: 20px; border-radius: 50%;" alt="${e.user.name}">\n <span style="color:var(--x-text-primary); font-size: 13px; font-weight: 600;">${e.user.name}</span>\n ${e.user.verified?'<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span style="color:var(--x-text-secondary); font-size: 13px;">${e.user.handle}</span>\n <span style="color:var(--x-text-secondary); font-size: 13px;">·${e.time}</span>\n </div>\n <div style="color:var(--x-text-primary); font-size: 14px; line-height: 1.4;">${e.content}</div>\n ${x(e)}\n <div style="color:var(--x-text-secondary); font-size: 12px; margin-top: 8px;">引用${t}</div>\n </div>\n `}e.addEventListener("mousedown",e=>{0===e.button&&(t=setTimeout(()=>{o=!0,vo(n.id,e),e.preventDefault()},800))}),e.addEventListener("mouseup",e=>{if(0!==e.button)return;clearTimeout(t);const a=Date.now();a-d<c?console.log("🚫 [鼠标] 防抖拦截，忽略重复点击"):(d=a,o||(fo?yo(n.id):io(n)),o=!1)}),e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation()});const h=n.pinned||!1;return e.innerHTML=`\n ${h?'\n <div style="padding: 12px 16px 0; display: flex; align-items: center; gap: 12px;">\n <div style="width: 40px; display: flex; justify-content: flex-end;">\n <svg viewBox="0 0 32 32" style="width: 16px; height: 16px; fill: #71767b;">\n <path d="M20.743 14.815l-0.933-12.065h5.191c0.414 0 0.75-0.336 0.75-0.75s-0.336-0.75-0.75-0.75v0h-18c-0.414 0-0.75 0.336-0.75 0.75s0.336 0.75 0.75 0.75v0h5.432l-1.275 12.103c-3.213 0.959-5.574 3.738-5.904 7.113l-0.003 0.034c0 0.414 0.336 0.75 0.75 0.75h9.25v7.25c0 0.414 0.336 0.75 0.75 0.75s0.75-0.336 0.75-0.75v0-7.25h9.25c0.414-0 0.75-0.336 0.75-0.75v0c0-3.017-2.35-5.787-6.007-7.185zM12.104 16.081c0.096-0.035 0.179-0.085 0.249-0.148l-0.001 0.001 0.005-0.003c0.126-0.117 0.211-0.275 0.233-0.453l0-0.004 0.011-0.022 1.337-12.701h4.367l0.979 12.681c0.033 0.35 0.303 0.627 0.647 0.67l0.004 0c2.542 0.682 4.512 2.623 5.222 5.096l0.013 0.052h-18.341c0.729-2.54 2.714-4.49 5.222-5.157l0.052-0.012z"></path>\n </svg>\n </div>\n <span style="color: #71767b; font-size: 13px; font-weight: 700;">已置顶</span>\n </div>\n ':""}\n <div style="display: flex; gap: 12px; padding: 12px 16px;">\n <img src="${n.user.avatar}" alt="${n.user.name}" style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;">\n <div style="flex: 1; min-width: 0;" class="tweet-main">\n <div class="tweet-user-info">\n <span class="tweet-user-name">${n.user.name}</span>\n ${n.user.verified?'<svg class="tweet-verified" viewBox="0 0 24 24"><g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g></svg>':""}\n <span class="tweet-user-handle">${n.user.handle}</span>\n <span class="tweet-time" data-timestamp="${n.timestamp||Date.now()}">·${n.timestamp?Z(n.timestamp):"刚刚"}</span>\n ${n.location?`\n <div style="display: flex; align-items: center; gap: 4px; margin-left: 8px;">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-accent);">\n <g><path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path></g>\n </svg>\n <span style="color: var(--x-accent); font-size: 13px;">${n.location}</span>\n </div>\n `:""}\n </div>\n <div class="tweet-content">${R(n.content)}</div>\n ${p(n)}\n ${g(n)}\n ${u(n)}\n <div class="tweet-actions">\n <div class="tweet-action comment">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>\n </svg>\n <span>${m.formatNumber(n.stats.comments)}</span>\n </div>\n <div class="tweet-action retweet" onclick="handleQuoteRetweetFromData('tweet', '${n.id}')">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n <span>${m.formatNumber(n.stats.retweets)}</span>\n </div>\n <div class="tweet-action like" data-liked="false" data-likes="${n.stats.likes}">\n <svg class="action-icon like-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g>\n </svg>\n <span class="like-count">${m.formatNumber(n.stats.likes)}</span>\n </div>\n <div class="tweet-action view">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10H6v10H4zm9.248 0v-7h2v7h-2z"></path></g>\n </svg>\n <span>${m.formatNumber(n.stats.views)}</span>\n </div>\n <div class="tweet-action bookmark">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M4 4.5C4 3.12 5.119 2 6.5 2h11C18.881 2 20 3.12 20 4.5v18.44l-8-5.71-8 5.71V4.5zM6.5 4c-.276 0-.5.22-.5.5v14.56l6-4.29 6 4.29V4.5c0-.28-.224-.5-.5-.5h-11z"></path></g>\n </svg>\n </div>\n <div class="tweet-action share">\n <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">\n <g><path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.29 3.3-1.42-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n </div>\n `,e}(n);e.appendChild(t)})}const t=document.getElementById("x-profile-header-count");t&&(t.textContent=`${n.length} 帖子`)}catch(n){console.error("加载用户推文失败:",n)}}async function Co(t,o,a={}){try{const{isOwnPost:i=!1,commentType:r="main_comment",pageType:l="detail",parentComment:c=null,mainCommentId:p=null}=a,{apiConfig:m,xSettings:x,xDb:u}=await g.loadConfigAndSettings(),{userPrompt:h,worldSetting:f,boundCharacters:b}=x;console.log("🔄 [AI回复] 重新加载最新推文数据，避免覆盖用户评论");const v=t.id,y=v.startsWith("user_"),w="retweet_mention"===t._source;let k=null;if(w){console.log("🔄 [AI回复] 从 Mentions 数据库加载转帖通知");const n=`mentions_${vt||"main"}`,e=await u.xAccountProfiles.get(n);if(e&&e.data){const n=e.data.find(n=>n.id===v&&"retweet"===n.type);n&&(k={...t,comments:n.comments||[],stats:n.stats||t.stats},console.log("✅ [AI回复] 已从 Mentions 加载转帖数据，评论数:",k.comments.length))}}else if(y){const n=`userTweets_${vt||"main"}`,e=await u.xUserTweets.get(n);e&&e.tweets&&(k=e.tweets.find(n=>n.id===v))}else{const n=await u.xTweetsData.get("tweets");n&&(k=n.forYouTweets?.find(n=>n.id===v)||n.followingTweets?.find(n=>n.id===v))}k?(console.log("✅ [AI回复] 已加载最新推文数据，评论数:",k.comments?.length||0),t=k):console.warn("⚠️ [AI回复] 未能加载最新推文数据，使用传入数据");const $=s.buildUserXProfileInfo(n.userProfileData);let C=0,I=s.buildBaseSystemPrompt({userPrompt:h,worldSetting:f});C=d.logTokenUsage("统一AI回复生成器","基础系统提示词",I,C),I+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚫 核心任务说明 🚫\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的互动生成器。你的任务是：\n✅ 为用户的评论生成其他人的回应/反应\n❌ 绝对不能再生成用户本人的评论或回复\n**明确：用户已经发表了评论，你只负责生成别人对这条评论的反应！**\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━";const S=I.substring(I.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));C=d.logTokenUsage("统一AI回复生成器","核心任务说明",S,C);const M=I.length;I+=s.buildScenarioPrompt({isOwnPost:i,commentType:r,pageType:l,parentComment:c});const T=I.substring(M);C=d.logTokenUsage("统一AI回复生成器","场景分支提示词",T,C);const A=await s.buildCompleteCharacterInfo(b,$,"reply");A&&(I+=A,C=d.logTokenUsage("统一AI回复生成器","角色资料信息",A,C));const E=I.length;I+=s.buildUniversalConstraints($);const z=I.substring(E);C=d.logTokenUsage("统一AI回复生成器","用户资料约束",z,C);const B=await bn("统一AI回复生成器",{usageRate:.2,usageDescription:'**评论回复场景的大事件使用**：\n1. **话题延伸**：如果用户的评论涉及某个大事件，回复可以展开讨论\n2. **观点碰撞**：对大事件持不同看法的网友可能在回复中辩论\n3. **信息补充**：回复可能补充大事件的相关信息或最新进展\n4. **轻度关联**：即使推文不直接涉及大事件，回复也可能自然提及（如"最近XXX事闹得，都没心情看这个了"）\n5. **自然融入**：只有约20%的回复涉及大事件，保持多样性'});B&&(I+=B,C=d.logTokenUsage("统一AI回复生成器","世界运转大事件",B,C)),I+=`\n【评论回复要求】：\n- 生成1-5条回复，内容多样化（简短/深度/表情符号）\n- 环境贴合：参考评论区现有讨论，基于主题和氛围生成贴合回复\n- 回复内容必须围绕推文主题和用户评论内容，不要偏离主题\n- 除了绑定角色外，其他用户头像统一：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n${b.length>0?"**角色回复要点**：根据设定判断是否适合发言，符合人设特点，可生成0-2个角色回复，严格使用角色X资料信息。":"**当前状态**：无绑定角色，生成普通用户回复。"}\n【🔒 隐私保护规则 - 路人回复限制】：\n🚨 路人回复者（非绑定角色/关系NPC的普通用户）只能基于X平台公开信息：\n✅ 可以使用：X姓名、X句柄、X简介、公开身份\n❌ 禁止提及：真实姓名、真实职业、私人关系、未公开的身份信息\n❌ 禁止使用：只有亲密关系才知道的称呼（如"老师"、"同学"、"老板"等，除非是公开身份）\n❌ 禁止提及：角色人设描述中的私密细节\n示例说明：\n- ✅ 正确："姐姐说得对"（基于公开的社交称呼）\n- ❌ 错误："王老师说得好"（泄露了真实姓氏和职业）\n- ❌ 错误："同学你好厉害"（假装是同学关系，路人不可能知道）\n⚠️ 只有已绑定的关系NPC才能提及私密信息或使用私密称呼（因为他们是角色的私人关系）\n【情侣角色回复规则】：\n${"couple"===$.verificationType&&$.coupleCharacterName?`- 用户的情侣是 ${$.coupleCharacterName}\n- **关键限制**：在他人帖子下回复用户评论时，出现概率极低（5-15%）\n* 评论与情侣角色无关 → 不出现\n* 话题普通/日常 → 很少出现\n* 只有评论内容与情侣角色相关、或确有理由参与讨论时才可能出现\n- 回复围绕帖子主题和讨论，不只是"秀恩爱"\n- 粉丝群体严格限制：仅当双方为明星/网红/公众人物时才可能有1条CP粉丝评论（概率极低），普通情侣绝无"磕学家""CP粉"等粉丝群体`:""}\n【JSON返回格式】：\n\`\`\`json\n{\n"${"reply_comment"===r&&"main"===l?"replies":"comments"}": [回复数组]\n}\n\`\`\`\n回复对象结构：\n- user: {name, handle, avatar, verified}\n- content: 回复文本 (可与sticker同时存在)\n- timeOffset: 相对推文发布的分钟数（负数，如-5表示推文发布后5分钟的回复）\n- sticker: {url: "表情包链接", description: "表情包描述"} (可选，约10-15%回复使用)\n- replyTo: "${o.user.handle}" (必须回复用户刚发表的评论)\n- replies: []\n【表情包使用规则】：\n- 表情包仅限使用世界书中提供的真实链接，严禁虚构或编造链接\n- 表情包与文字内容可以同时存在，用于增强表达效果\n- 使用频率控制在约10-15%的回复中，保持自然\n- sticker对象包含url和description两个必需字段\n\n关键规则：\n1. verified字段必须是布尔值(true/false)\n1.5. timeOffset必须是负数，表示回复发布在推文之后多少分钟（如-2, -5, -15等）\n2. replyTo字段必须是"${o.user.handle}"，表示回复用户的评论\n3. ${b.length>0?"生成角色回复时必须严格使用提供的角色X资料(xName、xHandle、xAvatar、xVerified)，不得使用默认值或自编信息":"普通用户回复，自创用户名和句柄"}\n4. sticker字段只能使用世界书中存在的真实链接，禁止虚构`;const L=I.substring(I.lastIndexOf("【JSON返回格式】"));C=d.logTokenUsage("统一AI回复生成器","JSON格式要求",L,C);let N=`【推文信息${"detail"===l?"（详情页）":"（主页）"}】\n标题：${i?"【用户的帖子】":""}${t.content}\n推文作者：${t.user.name} (${t.user.handle})\n${t.location?`位置：${t.location}`:""}\n${t.link?`链接：${t.link.title||t.link.url}`:""}\n${t.media&&t.media.length>0?`媒体：${t.media[0].description}`:""}`;if(t.quotedTweet){const n=t.quotedTweet,e="tweet"===n.type?"推文":"评论";N+=`\n【该推文引用了以下${e}】\n原作者：${n.user.name} (${n.user.handle})${n.user.verified?" ✓已认证":""}\n发布时间：${n.time}\n原内容："${n.content}"`,n.image&&("description"===n.image.type?N+=`\n原图片描述：${n.image.content}`:"upload"===n.image.type&&(N+="\n原图片：包含上传的图片内容")),n.location&&(N+=`\n原位置：${n.location}`),N+=`\n注意：这是引用转发，用户的评论是对上述${e}的回应/评论。回复时可以同时考虑用户的评论和被引用的原内容，可以讨论引用关系、原作者观点，或用户的转发评论等。`}if(N+=`\n【用户发表的${"main_comment"===r?"评论":"回复"}】\n用户名：${o.user.name}\n用户句柄：${o.user.handle}\n${"main_comment"===r?"评论":"回复"}内容：${o.content}`,"reply_comment"===r&&c&&(N+=`\n【用户回复的对象（楼中楼场景）】\n被回复者姓名：${c.user.name}\n被回复者句柄：${c.user.handle}\n被回复的评论：${c.content}\n⚠️ 重要说明：\n- 用户 ${o.user.name} (${o.user.handle}) 刚刚回复了 ${c.user.name} (${c.user.handle}) 的评论\n- 你生成的回复必须是对用户 ${o.user.name} (${o.user.handle}) 的回复\n- 所有回复的 replyTo 字段必须是 "${o.user.handle}"`),t.comments&&t.comments.length>0){N+=`\n【当前评论区内容】（共${t.comments.length}条评论，帮助理解讨论主题和氛围）`;t.comments.slice(0,10).forEach((n,e)=>{if(N+=`\n${e+1}. ${n.user.name} (${n.user.handle}): ${n.content}`,n.sticker&&(N+=` [含表情包: ${n.sticker.description}]`),n.replies&&n.replies.length>0){n.replies.slice(0,3).forEach((n,e)=>{N+=`\n└─ ${n.user.name} (${n.user.handle}): ${n.content}`,n.sticker&&(N+=` [含表情包: ${n.sticker.description}]`)}),n.replies.length>3&&(N+=`\n└─ ...还有${n.replies.length-3}条回复`)}}),t.comments.length>10&&(N+=`\n...还有${t.comments.length-10}条评论未显示`)}if(t.user&&t.user.handle)try{console.log(`📝 [统一AI回复] 读取推文作者资料: ${t.user.handle}`);const n=await s.getUnifiedProfile(t.user.handle,{userProfileInfo:$});n&&(N+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📝 推文作者完整资料 📝\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",N+=s.formatProfileForPrompt(n,{includeType:!0,includeTweets:!0,includeRelationships:!0}),N+="\n⚠️ 推文作者资料使用说明：\n- 如果推文作者是角色/NPC，回复时可能会来评论区互动\n- 推文作者的关系NPC如果看到这条推文，可能会来评论\n- 回复要符合推文作者的身份和背景\n- 如果推文作者与用户有聊天记忆，可以自然体现在互动中\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",C=d.logTokenUsage("统一AI回复生成器","推文作者资料",N.substring(N.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")),C))}catch(n){console.error("❌ [统一AI回复] 读取推文作者资料失败:",n)}d.logTokenUsage("统一AI回复生成器","上下文信息",N,C);const R=[];R.push({type:"text",text:N}),o.image&&"upload"===o.image.type&&o.image.content?R.push({type:"image_url",image_url:{url:o.image.content}}):o.image&&"description"===o.image.type&&R.push({type:"text",text:`用户评论附带的图片描述：${o.image.content}`});const H=[{role:"user",content:R}],j=R.map(n=>n.text||"[图片]").join(" ");d.logFinalPrompt("统一AI回复生成器",I,j);const U=await g.sendAIRequest({apiConfig:m,systemPrompt:I,messages:H,temperature:.8});console.log("绑定角色数量:",b.length),console.log("评论区上下文:",t.comments?`${t.comments.length}条评论`:"无评论"),t.comments&&t.comments.length>0&&console.log("评论示例:",t.comments.slice(0,3).map(n=>`${n.user.name}: ${n.content.substring(0,50)}...`));let O=g.parseJSONResponse(U);O=await g.postProcessData(O,$);const _=Date.now(),F=O["reply_comment"===r&&"main"===l?"replies":"comments"]||[];if(!Array.isArray(F))throw new Error("AI返回的数据格式不正确");if("detail"===l){console.log("🤖 [AI回复] 详情页模式 - 生成了",F.length,"条回复");let n=t.timestamp||t.createdAt||Date.now();if("number"!=typeof n&&(n=n instanceof Date?n.getTime():"string"==typeof n?new Date(n).getTime():Date.now()),(isNaN(n)||n<=0)&&(console.warn("⚠️ [AI回复] 推文时间戳无效，使用当前时间"),n=Date.now()),"main_comment"===r)F.forEach((e,o)=>{e.id=`ai_unified_${_}_${o}`,void 0===e.timeOffset||isNaN(e.timeOffset)?e.timestamp&&!isNaN(e.timestamp)||(e.timestamp=n+60*(2+20*Math.random())*1e3):(e.timestamp=n+60*Math.abs(e.timeOffset)*1e3,delete e.timeOffset),(isNaN(e.timestamp)||e.timestamp<=0)&&(console.warn("⚠️ [AI回复] 评论时间戳无效，使用推文时间"),e.timestamp=n),t.comments.push(e)}),t.stats.comments+=F.length,console.log("🤖 [AI回复] AI回复已添加到推文数据，新评论总数:",t.stats.comments);else if("reply_comment"===r&&c){const e=t.comments.find(n=>n.id===c.id);e?(e.replies||(e.replies=[]),F.forEach((t,o)=>{if(t.id=`ai_unified_${_}_${o}`,void 0===t.timeOffset||isNaN(t.timeOffset)){if(!t.timestamp||isNaN(t.timestamp)){let o=e.timestamp||e.createdAt||n;"number"!=typeof o&&(o=o instanceof Date?o.getTime():"string"==typeof o?new Date(o).getTime():n),t.timestamp=o+60*(1+10*Math.random())*1e3}}else t.timestamp=n+60*Math.abs(t.timeOffset)*1e3,delete t.timeOffset;(isNaN(t.timestamp)||t.timestamp<=0)&&(console.warn("⚠️ [AI回复] 楼中楼回复时间戳无效，使用推文时间"),t.timestamp=n),e.replies.push(t)}),console.log("🤖 [AI回复] 楼中楼回复已添加，目标评论:",c.id,"，当前回复总数:",e.replies.length)):console.error("❌ [AI回复] 未找到目标评论:",c.id)}try{const n=e(),o=t.id.startsWith("user_"),a="account"===t._source,i="retweet_mention"===t._source,r="newtweet_mention"===t._source;if(i){console.log("🤖 [AI回复] 保存到 Mentions 转帖通知数据");const e=`mentions_${vt||"main"}`,o=await n.xAccountProfiles.get(e);if(o&&o.data){const e=o.data.findIndex(n=>n.id===t.id&&"retweet"===n.type);-1!==e?(o.data[e].comments=t.comments,o.data[e].stats?o.data[e].stats.comments=t.stats.comments:o.data[e].stats=t.stats,await n.xAccountProfiles.put(o),console.log("✅ [AI回复] Mentions 转帖通知已更新，评论总数:",t.comments.length)):console.warn("⚠️ [AI回复] 未在 Mentions 数据中找到对应的转帖通知:",t.id)}else console.warn("⚠️ [AI回复] 未找到 Mentions 数据:",e)}else if(r){console.log("🤖 [AI回复] 保存到 Mentions New Tweet 通知数据");const e=`mentions_${vt||"main"}`,o=await n.xAccountProfiles.get(e);if(o&&o.data){const e=o.data.findIndex(n=>n.id===t._mentionId&&"newTweet"===n.type);-1!==e?(o.data[e].tweet||(o.data[e].tweet={}),o.data[e].tweet.comments=t.comments,o.data[e].tweet.stats?o.data[e].tweet.stats.comments=t.stats.comments:o.data[e].tweet.stats=t.stats,await n.xAccountProfiles.put(o),console.log("✅ [AI回复] Mentions New Tweet 通知已更新，评论总数:",t.comments.length)):console.warn("⚠️ [AI回复] 未在 Mentions 数据中找到对应的 New Tweet 通知:",t._mentionId)}else console.warn("⚠️ [AI回复] 未找到 Mentions 数据:",e)}else if(a){console.log("🤖 [AI回复] 保存到账户推文数据");const e=(t._accountHandle||(Sn.accountInfo||Sn).handle).replace("@","");if(Sn&&Sn.tweets){const o=Sn.tweets.findIndex(n=>n.id===t.id);-1!==o&&(Sn.tweets[o]=t,await n.xAccountProfiles.put({handle:e,name:(Sn.accountInfo||Sn).name,accountInfo:Sn.accountInfo||Sn,tweets:Sn.tweets,accountReplies:Sn.accountReplies||[],updatedAt:(new Date).toISOString()}),console.log("✅ [AI回复] 账户推文已保存，账户:",e))}}else if(o){console.log("🤖 [AI回复] 保存到用户推文数据");const e=`userTweets_${vt||"main"}`,o=await n.xUserTweets.get(e);if(o&&o.tweets){const e=o.tweets.findIndex(n=>n.id===t.id);-1!==e?(o.tweets[e]=t,await n.xUserTweets.put(o),console.log("✅ [AI回复] 用户推文AI回复已保存，评论总数:",t.comments.length,"，主评论",t.comments.length,"条")):console.error("❌ [AI回复] 未在数据库中找到目标推文")}}else{console.log("🤖 [AI回复] 保存到主页推文数据");const e=await n.xTweetsData.get("tweets");if(e){let o=!1;if(e.forYouTweets){const n=e.forYouTweets.findIndex(n=>n.id===t.id);-1!==n&&(e.forYouTweets[n]=t,o=!0)}if(e.followingTweets&&!o){const n=e.followingTweets.findIndex(n=>n.id===t.id);-1!==n&&(e.followingTweets[n]=t,o=!0)}o?(await n.xTweetsData.put(e),console.log("✅ [AI回复] 主页推文AI回复已保存，评论总数:",t.comments.length,"，主评论",t.comments.length,"条")):console.error("❌ [AI回复] 未在数据库中找到目标推文")}}sessionStorage.setItem("currentTweetData",JSON.stringify(t)),console.log("✅ [AI回复] sessionStorage 已更新")}catch(n){console.error("❌ [AI回复] 保存AI回复到数据库失败:",n)}F.forEach((n,e)=>{const t=en(n,"reply_comment"===r),o=document.getElementById("detail-comments-container");if("reply_comment"===r&&c){const n=o.querySelectorAll(".comment-item");let e=null,a=null;n.forEach(n=>{if(n.dataset.commentId===c.id)if(e=n,n.classList.contains("reply-item")){let e=n.nextElementSibling;for(a=n;e&&e.classList.contains("reply-item");)a=e,e=e.nextElementSibling}else{let e=n.nextElementSibling;for(a=n;e&&e.classList.contains("reply-item");)a=e,e=e.nextElementSibling}}),a?a.nextSibling?a.parentNode.insertBefore(t,a.nextSibling):a.parentNode.appendChild(t):o.appendChild(t)}else o.appendChild(t)}),console.log("✅ [AI回复] AI回复已渲染到页面");document.querySelectorAll(".reply-user-avatar").forEach(n=>{n.src=te.avatar})}else{console.log("🤖 [AI回复] 主页模式 - 开始处理");let n=t.timestamp||t.createdAt||Date.now();if("number"!=typeof n&&(n=n instanceof Date?n.getTime():"string"==typeof n?new Date(n).getTime():Date.now()),(isNaN(n)||n<=0)&&(console.warn("⚠️ [AI回复] 主页模式：推文时间戳无效，使用当前时间"),n=Date.now()),"main_comment"===r)F.forEach((e,o)=>{e.id=`ai_main_unified_${_}_${o}`,void 0===e.timeOffset||isNaN(e.timeOffset)?e.timestamp&&!isNaN(e.timestamp)||(e.timestamp=n+60*(2+20*Math.random())*1e3):(e.timestamp=n+60*Math.abs(e.timeOffset)*1e3,delete e.timeOffset),(isNaN(e.timestamp)||e.timestamp<=0)&&(console.warn("⚠️ [AI回复] 主页模式：评论时间戳无效，使用推文时间"),e.timestamp=n),t.comments.push(e)}),t.stats.comments+=F.length,console.log("🤖 [AI回复] 已添加主评论，新增:",F.length,"条，总计:",t.comments.length);else{const e=p||c.id,o=t.comments.find(n=>n.id===e);o?(F.forEach((e,t)=>{if(e.id=`ai_main_sub_unified_${_}_${t}`,void 0===e.timeOffset||isNaN(e.timeOffset)){if(!e.timestamp||isNaN(e.timestamp)){let t=o.timestamp||o.createdAt||n;"number"!=typeof t&&(t=t instanceof Date?t.getTime():"string"==typeof t?new Date(t).getTime():n),e.timestamp=t+60*(1+10*Math.random())*1e3}}else e.timestamp=n+60*Math.abs(e.timeOffset)*1e3,delete e.timeOffset;(isNaN(e.timestamp)||e.timestamp<=0)&&(console.warn("⚠️ [AI回复] 主页模式：楼中楼回复时间戳无效，使用推文时间"),e.timestamp=n),o.replies||(o.replies=[]),o.replies.push(e)}),console.log("🤖 [AI回复] 已添加楼中楼回复到主评论:",e,"，新增:",F.length,"条")):console.warn("⚠️ [AI回复] 无法找到主评论，mainCommentId:",e)}try{let n=!1;const e=P.findIndex(n=>n.id===t.id);if(-1!==e)P[e]=t,n=!0,console.log("🤖 [AI回复] 已更新forYouTweets中的推文");else{const e=D.findIndex(n=>n.id===t.id);-1!==e&&(D[e]=t,n=!0,console.log("🤖 [AI回复] 已更新followingTweets中的推文"))}n||console.warn("⚠️ [AI回复] 未在全局数组中找到推文:",t.id);const o=await u.xTweetsData.get("tweets");o?(o.forYouTweets=P,o.followingTweets=D,o.lastUpdated=(new Date).toISOString(),await u.xTweetsData.put(o),console.log("✅ [AI回复] 数据已保存到数据库")):(await u.xTweetsData.put({id:"tweets",forYouTweets:P,followingTweets:D,lastUpdated:(new Date).toISOString()}),console.log("✅ [AI回复] 数据已创建并保存"))}catch(n){console.error("❌ [AI回复] 保存统一AI回复数据失败:",n)}console.log("🤖 [AI回复] 开始重新渲染评论区，推文ID:",cn),tn(cn);const e=document.querySelector(".comments-container");setTimeout(()=>{e&&(e.scrollTop=e.scrollHeight,console.log("✅ [AI回复] 评论区已滚动到底部"))},100)}if(Rl({title:"X",message:"en"===Hn?"Your comment received a reply!":"你的评论已经收到回复！",avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),t&&t.user&&t.user.handle&&o&&o.user&&o.user.handle){const n=o.user.handle,e=t.user.handle;qc(n,e,"comment",o.content).catch(n=>{console.error("拉黑解除检测失败（静默）:",n)})}}catch(n){console.error("生成统一AI回复失败:",n),mn(`回复生成失败: ${n.message}`,"error")}}n.closeTweetActionMenu=function(){const n=document.getElementById("tweet-action-menu");n&&n.remove()},n.toggleTweetPin=async function(n){try{const t=e(),o=`userTweets_${vt||"main"}`,a=await t.xUserTweets.get(o);if(a&&a.tweets){const e=a.tweets.find(e=>e.id===n);if(e){const n=e.pinned||!1;n||a.tweets.forEach(n=>{n.pinned&&(n.pinned=!1)}),e.pinned=!n,await t.xUserTweets.put(a),mn(n?"已取消置顶":"推文已置顶","success"),closeTweetActionMenu(),$o()}}}catch(n){console.error("切换置顶状态失败:",n),mn("操作失败","error")}},n.deleteSingleTweet=async function(n){if(confirm("确定要删除这条推文吗？删除后无法恢复。"))try{const t=e(),o=`userTweets_${vt||"main"}`,a=await t.xUserTweets.get(o);if(a&&a.tweets){a.tweets=a.tweets.filter(e=>e.id!==n),await t.xUserTweets.put(a);const e=await t.xTweetsData.get("tweets");if(e){let o=!1;if(e.forYouTweets){const t=e.forYouTweets.length;e.forYouTweets=e.forYouTweets.filter(e=>e.id!==n),e.forYouTweets.length!==t&&(o=!0)}if(e.followingTweets){const t=e.followingTweets.length;e.followingTweets=e.followingTweets.filter(e=>e.id!==n),e.followingTweets.length!==t&&(o=!0)}o&&await t.xTweetsData.put(e)}mn("推文已删除","success"),closeTweetActionMenu(),$o()}}catch(n){console.error("删除推文失败:",n),mn("删除失败","error")}},n.enterMultiSelectModeFromMenu=function(n){closeTweetActionMenu(),wo(),n&&yo(n)},n.exitMultiSelectMode=function(){fo=!1,bo.clear(),function(){const n=document.getElementById("delete-toolbar");n&&(n.style.display="none")}(),document.querySelectorAll(".user-tweet-item").forEach(n=>{n.classList.remove("selected"),n.style.backgroundColor="",n.style.borderLeft=""})},n.selectAllTweets=function(){document.querySelectorAll(".user-tweet-item").forEach(n=>{const e=n.dataset.tweetId;bo.has(e)||(bo.add(e),n.classList.add("selected"),n.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)")}),ko()},n.deleteSelectedTweets=async function(){if(0===bo.size)return;if(confirm(`确定要删除选中的 ${bo.size} 条推文吗？删除后无法恢复。`))try{const n=e(),t=`userTweets_${vt||"main"}`,o=await n.xUserTweets.get(t);if(o&&o.tweets){o.tweets=o.tweets.filter(n=>!bo.has(n.id)),await n.xUserTweets.put(o);const e=await n.xTweetsData.get("tweets");if(e){let t=!1;if(e.forYouTweets){const n=e.forYouTweets.length;e.forYouTweets=e.forYouTweets.filter(n=>!bo.has(n.id)),e.forYouTweets.length!==n&&(t=!0)}if(e.followingTweets){const n=e.followingTweets.length;e.followingTweets=e.followingTweets.filter(n=>!bo.has(n.id)),e.followingTweets.length!==n&&(t=!0)}t&&await n.xTweetsData.put(e)}mn(`已删除 ${bo.size} 条推文`,"success"),exitMultiSelectMode(),$o()}}catch(n){console.error("删除推文失败:",n),mn("删除失败","error")}};let Io=null;function So(n,e,t,o,a,i,r,s,l=null,c=null,d=null){Ft(),Io={type:n,id:e,user:{name:t,handle:o,avatar:a,verified:i},content:r,time:s,image:l,link:c,location:d},function(){if(!Io)return;const n=document.getElementById("quote-content-preview"),e=document.getElementById("quote-type-text"),t=document.getElementById("quote-user-avatar"),o=document.getElementById("quote-user-name"),a=document.getElementById("quote-user-verified"),i=document.getElementById("quote-user-handle"),r=document.getElementById("quote-user-time"),s=document.getElementById("quote-content-text");if(!n)return;n.style.display="block",e&&(e.textContent="tweet"===Io.type?"引用推文":"引用评论");t&&(t.src=Io.user.avatar);o&&(o.textContent=Io.user.name);i&&(i.textContent=Io.user.handle);r&&(r.textContent="·"+Io.time);a&&(a.style.display=Io.user.verified?"inline":"none");if(s){const n=Io.content.replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&amp;/g,"&");s.textContent=n}const l=document.getElementById("quote-image-container");if(l)if(Io.image){if(l.style.display="block","description"===Io.image.type)l.innerHTML=`\n <div style="margin-top: 8px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 8px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 13px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${Io.image.content}</div>\n </div>\n `;else if("upload"===Io.image.type)l.innerHTML=`\n <div style="margin-top: 8px; border-radius: 8px; overflow: hidden;">\n <img src="${Io.image.content}" style="width: 100%; max-height: 120px; object-fit: cover; display: block;" alt="引用图片">\n </div>\n `;else if("uploads"===Io.image.type&&Io.image.images&&Io.image.images.length>0){Io.image.images.length;let n="grid-template-columns: repeat(2, 1fr);";const e=Io.image.images.map((n,e)=>`\n <div style="border-radius: 6px; overflow: hidden;">\n <img src="${n.content}" style="width: 100%; height: 80px; object-fit: cover; display: block;" alt="引用图片${e+1}">\n </div>\n `).join("");l.innerHTML=`\n <div style="margin-top: 8px; display: grid; ${n} gap: 4px;">\n ${e}\n </div>\n `}}else l.style.display="none",l.innerHTML=""}();const p=document.getElementById("compose-text-input");p&&(p.placeholder="tweet"===n?"添加你的评论来引用这条推文":"添加你的评论来引用这条评论",p.focus())}function Mo(){Io=null;const n=document.getElementById("quote-content-preview");n&&(n.style.display="none");const e=document.getElementById("quote-image-container");e&&(e.style.display="none",e.innerHTML="");const t=document.getElementById("compose-text-input");t&&(t.placeholder="有什么新鲜事？")}n.handleQuoteRetweetFromAccountTweet=async function(n){if(!Sn||!Sn.tweets)return void mn("无法找到推文数据","error");const e=Sn.tweets.find(e=>e.id===n);if(!e)return void mn("未找到该推文","error");let t=null;e.media&&e.media.length>0?"description"===e.media[0].type&&(t={type:"description",content:e.media[0].description}):e.image&&(t=e.image),So("tweet",e.id,e.user.name,e.user.handle,e.user.avatar,e.user.verified,e.content||"",e.time,t,null,null)};let To=!1,Ao=null;n.isCommentStickerMode=To,n.getCommentStickerMode=()=>To,n.setCommentStickerMode=e=>{To=e,n.isCommentStickerMode=e},n.getSelectedCommentSticker=()=>Ao,n.setSelectedCommentSticker=n=>{Ao=n},n.resetSelectedCommentSticker=()=>{Ao=null},n.selectCommentSticker=function(e){if(n.getCommentStickerMode()){if(Ao=e,n.userStickers&&Array.isArray(n.userStickers)){const t=n.userStickers.findIndex(n=>n.url===e.url&&n.description===e.description);-1!==t&&(n.userStickers[t].useCount=(n.userStickers[t].useCount||0)+1,n.userStickers[t].lastUsedAt=(new Date).toISOString(),n.saveUserStickers&&n.saveUserStickers())}!function(e){const t=document.querySelector(".detail-comment-input-area");if(!t)return;!function(){const n=document.getElementById("comment-sticker-preview");n&&n.remove();so()}();const o=document.createElement("div");o.id="comment-sticker-preview",o.style.cssText="\n      margin-top: 10px;\n      padding: 12px;\n      background-color: var(--x-bg-secondary);\n      border: 1px solid var(--x-border-color);\n      border-radius: 12px;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      position: relative;\n    ";const a=document.createElement("img");a.src=e.url,a.alt=e.description,a.style.cssText="\n      width: 60px;\n      height: 60px;\n      object-fit: contain;\n      border-radius: 8px;\n    ";const i=document.createElement("div");i.style.cssText="\n      flex: 1;\n      color: var(--x-text-primary);\n    ",i.innerHTML=`\n      <div style="font-size: 13px; font-weight: 600; margin-bottom: 2px;">选中的表情包</div>\n      <div style="font-size: 12px; color: var(--x-text-secondary);">${e.description||"表情包"}</div>\n    `;const r=document.createElement("button");r.innerHTML='\n      <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n        <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n      </svg>\n    ',r.style.cssText="\n      background: none;\n      border: none;\n      color: var(--x-text-secondary);\n      cursor: pointer;\n      padding: 4px;\n      border-radius: 50%;\n      transition: all 0.2s;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    ",r.onmouseover=()=>{r.style.backgroundColor="var(--x-bg-hover)",r.style.color="var(--x-text-primary)"},r.onmouseout=()=>{r.style.backgroundColor="transparent",r.style.color="var(--x-text-secondary)"},r.onclick=()=>{const e=document.getElementById("comment-sticker-preview");e&&e.remove(),n.setSelectedCommentSticker?n.setSelectedCommentSticker(null):Ao=null,so()},o.appendChild(a),o.appendChild(i),o.appendChild(r),t.appendChild(o),so()}(e),n.closeStickerPicker&&n.closeStickerPicker(),n.setCommentStickerMode(!1)}},n.getCommentContent=function(){const e=document.getElementById("detail-comment-input");return{text:e?e.value.trim():"",sticker:n.getSelectedCommentSticker?n.getSelectedCommentSticker():Ao}},n.clearCommentInput=function(){console.log("📝 [清理调试] 开始清理评论输入");const e=document.getElementById("detail-comment-input");e&&(e.value="",e.style.height="20px");const t=document.getElementById("comment-sticker-preview");t&&(t.remove(),console.log("📝 [清理调试] 表情包预览已移除")),n.setSelectedCommentSticker?(n.setSelectedCommentSticker(null),console.log("📝 [清理调试] 表情包选择已重置（通过全局函数）")):(Ao=null,console.log("📝 [清理调试] 表情包选择已重置（直接赋值）"));const o=document.getElementById("detail-comment-image-preview");o&&(o.style.display="none"),so(),console.log("📝 [清理调试] 评论输入清理完成")},n.openCommentStickers=sn,n.openReviewPage=function(){confirm("en"===Hn?"Are you ready to navigate to the Review page?":"是否准备移动到审核页面？")?(n.open("https://discord.gg/KrVUCGykXp","_blank"),console.log("✅ 已打开审核页面")):console.log("❌ 用户取消跳转审核页面")},n.openHelpPage=function(){confirm("en"===Hn?"Are you ready to navigate to the Help & FAQ page?":"是否准备移动到答疑页面？")?(n.open("https://docs.qq.com/smartsheet/DQkppaVN2enJVSHBq","_blank"),console.log("✅ 已打开答疑页面")):console.log("❌ 用户取消跳转答疑页面")};let Eo=[],zo=1e3,Bo=1;let Lo=[{name:"默认道具",icon:"❓",rarity:"common",weight:10,category:"特殊道具"}];async function Po(){try{const n=e(),t=vt||"main",o=`tools_${t}`,a=await n.xTools.get(o);await n.xTools.put({id:o,accountId:t,items:Eo,coins:zo,gachaPool:a?.gachaPool||Lo,scenarioGenerated:a?.scenarioGenerated||!1,generatedAt:a?.generatedAt,updatedAt:(new Date).toISOString()}),console.log("✅ 道具数据已保存")}catch(n){console.error("❌ 保存道具数据失败:",n)}}function Do(){const n=Lo.reduce((n,e)=>n+e.weight,0);let e=Math.random()*n;for(const n of Lo)if(e-=n.weight,e<=0)return{...n};return{...Lo[0]}}function No(){return Math.max(1,Math.ceil(Eo.length/12))}function Ro(){const n=document.getElementById("page-info"),e=document.getElementById("page-prev"),t=document.getElementById("page-next"),o=No();n&&(n.textContent=`${Bo}/${o}`),e&&(1===Bo?(e.classList.add("disabled"),e.style.opacity="0.3",e.style.cursor="not-allowed"):(e.classList.remove("disabled"),e.style.opacity="1",e.style.cursor="pointer")),t&&(Bo>=o?(t.classList.add("disabled"),t.style.opacity="0.3",t.style.cursor="not-allowed"):(t.classList.remove("disabled"),t.style.opacity="1",t.style.cursor="pointer"))}function Ho(){const n=document.getElementById("tool-cards-grid");if(!n)return;n.innerHTML="";const e=12*(Bo-1),t=e+12,o=Eo.slice(e,t);for(let e=0;e<12;e++){const t=document.createElement("div");if(t.className="item-card",e<o.length){const n=o[e];t.classList.add("has"),"rare"===n.rarity&&t.classList.add("rare"),t.innerHTML=`\n          <div class="envelope-line"></div>\n          <div class="card-corner-dots"></div>\n          <div class="item-icon">${n.icon}</div>\n          <div class="item-name">${n.name}</div>\n          <div class="item-count">${n.count}</div>\n          <div class="rarity-corner"></div>\n        `}n.appendChild(t)}Ro(),jo()}function jo(){const n=document.getElementById("tool-total"),e=document.getElementById("tool-types"),t=document.getElementById("tool-coins");if(n){const e=Eo.reduce((n,e)=>n+e.count,0);n.textContent=e}e&&(e.textContent=Eo.length),t&&(t.textContent=zo)}let Uo=null,Oo=0;function _o(){const n=document.getElementById("tool-boot-percent"),e=document.querySelector(".tool-boot-progress-fill");console.log("🚀 [开机动画] AI生成完毕，快速完成进度条..."),Uo&&(clearInterval(Uo),Uo=null);const t=setInterval(()=>{Oo<100?(Oo+=5,n&&(n.textContent=Math.floor(Oo)+"%"),e&&(e.style.width=Oo+"%")):(clearInterval(t),console.log("✅ [开机动画] 进度条已完成100%"))},50)}let Fo="audio",Xo=[];const qo=["https://i.postimg.cc/8PDPnVzb/00a041b0fad26d28187d01ff3beaa5bb.jpg","https://i.postimg.cc/mDCB8dxy/01a0641ac6ccdd39d92c010c0de96081.jpg","https://i.postimg.cc/BQMsYLyJ/09c6de67b73f8cb6c98df9c5e6de780b.jpg","https://i.postimg.cc/HnTD3d4q/156e25617d2a3e905d2e5a7e1d489700.jpg","https://i.postimg.cc/JncSsSV2/c05d136d6ab0836ba4a89cc58ac1a201.jpg","https://i.postimg.cc/vHmCmPq8/f1ecc90ac9e91d2a968faead1464d0bc.jpg","https://i.postimg.cc/RC1n0d3N/01f3e825a988ae3fa59d498217478964.jpg","https://i.postimg.cc/7ZR5RQRc/72700355d3069eb2cea793d7b9d40ad4.jpg","https://i.postimg.cc/5N7yHRfz/bea6a5355ed311f47a397d7bc0257865.jpg"];function Vo(){const n=Math.floor(Math.random()*qo.length);return qo[n]}const Go={audio:[],video:[]};function Yo(n){Fo=n;const e=document.querySelectorAll(".live-tab");e.forEach(n=>{n.classList.remove("live-tab-active"),n.style.color="#71767b",n.style.backgroundColor="rgba(255,255,255,0.1)"});let t=null;t="audio"===n?e[0]:"video"===n?e[1]:Array.from(e).find(e=>e.onclick&&e.onclick.toString().includes(n)),t&&(t.classList.add("live-tab-active"),t.style.color="#fff",t.style.backgroundColor="var(--x-accent)");const o=document.querySelectorAll(".live-tab-content");o.forEach(n=>{n.style.opacity="0",n.style.transition="opacity 0.2s ease-out"}),setTimeout(()=>{if(o.forEach(n=>{n.style.display="none"}),"audio"===n||"video"===n){const e=document.getElementById(`live-${n}-content`);e&&(e.style.display="block",setTimeout(()=>{e.style.opacity="1"},10)),Wo(n)}else{const e=document.getElementById("live-audio-content");if(e){e.style.display="block",setTimeout(()=>{e.style.opacity="1"},10);const t=document.getElementById("live-audio-list");if(t){const e=Go[n]||[],o=Xo.find(e=>e.id===n),a=o?o.name:"自定义分类";0===e.length?t.innerHTML=`\n                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #aaa; text-align: center;">\n                  <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: currentColor; opacity: 0.5; margin-bottom: 16px;">\n                    <path d="M10.5 20h-5.5a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v2.5" />\n                    <path d="M14.569 11.45a3 3 0 1 0 -4.518 3.83" />\n                  </svg>\n                  <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${a}直播</div>\n                  <div style="font-size: 14px; opacity: 0.8;">该分类下暂无直播内容</div>\n                </div>\n              `:(e.forEach(n=>{n.background||(n.background=Vo())}),t.innerHTML=e.map((e,t)=>Jo(e,n,t)).join(""))}}}},200)}function Wo(n){const e=document.getElementById(`live-${n}-list`);if(!e)return;const t=Go[n]||[];if(0===t.length){const t=Rn[Hn]||Rn.zh,o="audio"===n?t.liveNoAudioStreams:t.liveNoVideoStreams;return void(e.innerHTML=`\n        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #aaa; text-align: center;">\n          <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: currentColor; opacity: 0.5; margin-bottom: 16px;">\n            <path d="M10.5 20h-5.5a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v2.5" />\n            <path d="M14.569 11.45a3 3 0 1 0 -4.518 3.83" />\n          </svg>\n          <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${o}</div>\n          <div style="font-size: 14px; opacity: 0.8;">${t.liveWaitingContent}</div>\n        </div>\n      `)}t.forEach(n=>{n.background||(n.background=Vo())}),e.innerHTML=t.map((e,t)=>Jo(e,n,t)).join("")}function Jo(n,e,t=0){Rn[Hn]||Rn.zh;const o=.05*t;return`\n      <div class="live-stream-card" onclick="joinLiveStream('${n.id}')" \n        style="cursor: pointer; transition: all 0.2s ease; position: relative; margin-bottom: 16px; animation: liveCardFadeIn 0.4s ease-out ${o}s both; opacity: 0;"\n        onmouseover="this.querySelector('.card-overlay').style.opacity='1'"\n        onmouseout="this.querySelector('.card-overlay').style.opacity='0'">\n        \n        \x3c!-- 缩略图容器 --\x3e\n        <div style="position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; margin-bottom: 12px; background-color: #1a1a1a;">\n          \x3c!-- 背景图片 --\x3e\n          <img src="${n.background}" alt="${n.title}" \n            style="width: 100%; height: 100%; object-fit: cover;">\n          \n          \x3c!-- 在线人数指示器 --\x3e\n          <div style="position: absolute; top: 8px; left: 8px; display: flex; align-items: center; gap: 4px; background-color: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 4px;">\n            <div style="width: 8px; height: 8px; background-color: var(--x-accent); border-radius: 50%; animation: pulse 2s infinite;"></div>\n            <span style="color: #fff; font-size: 12px; font-weight: 500;">${n.onlineCount.toLocaleString()}</span>\n          </div>\n          \n          \x3c!-- 持续时间 --\x3e\n          <div style="position: absolute; bottom: 8px; right: 8px; background-color: rgba(0,0,0,0.7); padding: 3px 8px; border-radius: 4px;">\n            <span style="color: #fff; font-size: 12px; font-weight: 500;">${n.duration}</span>\n          </div>\n          \n          \x3c!-- 悬停覆盖层 --\x3e\n          <div class="card-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s ease;">\n            <div style="width: 48px; height: 48px; border-radius: 50%; background-color: var(--x-accent); display: flex; justify-content: center; align-items: center;">\n              <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #fff;">\n                <path d="M8 5v14l11-7z"></path>\n              </svg>\n            </div>\n          </div>\n        </div>\n        \n        \x3c!-- 内容区域 --\x3e\n        <div style="display: flex; gap: 12px;">\n          \x3c!-- 主播头像 --\x3e\n          <div style="width: 36px; height: 36px; border-radius: 50%; overflow: hidden; flex-shrink: 0;">\n            <img src="${n.streamerAvatar}" alt="${n.streamerName}" style="width: 100%; height: 100%; object-fit: cover;">\n          </div>\n          \n          \x3c!-- 文本内容 --\x3e\n          <div style="flex: 1; min-width: 0;">\n            \x3c!-- 直播标题 --\x3e\n            <h3 style="color: #fff; font-size: 14px; font-weight: 500; margin: 0 0 6px 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${n.title}</h3>\n            \n            \x3c!-- 主播名和分类 --\x3e\n            <div style="display: flex; flex-direction: column;">\n              <span style="color: #aaa; font-size: 12px; margin-bottom: 2px;">${n.streamerName} ${n.streamerHandle}</span>\n              <div style="display: flex; align-items: center; gap: 8px;">\n                <span style="color: #aaa; font-size: 12px;">${n.category}</span>\n              </div>\n            </div>\n          </div>\n          \n          \x3c!-- 更多选项 --\x3e\n          <div style="width: 24px; display: flex; justify-content: center; cursor: pointer;" onclick="event.stopPropagation()">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n              <path d="M12 16.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM10.5 12c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5zm0-6c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5z"></path>\n            </svg>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        @keyframes pulse {\n          0% { opacity: 1; }\n          50% { opacity: 0.5; }\n          100% { opacity: 1; }\n        }\n        \n        @keyframes spin {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        \n        @keyframes liveCardFadeIn {\n          0% {\n            opacity: 0;\n            transform: translateY(20px);\n          }\n          100% {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n      </style>\n    `}let Ko=null,Qo=null,Zo=null,na={isOpen:!1,isAnimating:!1};const ea={"语音聊天":"http://music.163.com/song/media/outer/url?id=2085883558.mp3","音乐":"http://music.163.com/song/media/outer/url?id=2085883558.mp3","聊天":"http://music.163.com/song/media/outer/url?id=2085883558.mp3",default:"http://music.163.com/song/media/outer/url?id=2085883558.mp3"};let ta={};async function oa(e,t=[],o="normal"){try{if(!Ko||!Ko.details)throw new Error("当前没有直播间数据");const{db:a,xDb:i,apiConfig:r,xSettings:l}=await g.loadConfigAndSettings(),{userPrompt:c,worldSetting:p,boundCharacters:m}=l,x=s.buildUserXProfileInfo(n.userProfileData),u=x.publicIdentity||"",h=x.bio||"",f=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(u+" "+h),b=Ko.streamerHandle,v=await s.getUnifiedProfile(b,{userProfileInfo:x});if(!v)throw new Error("无法获取主播资料");let y=0,w=s.buildBaseSystemPrompt({userPrompt:c,worldSetting:p});y=d.logTokenUsage("直播互动生成器","基础系统提示词",w,y);const k=await s.getApplicableWorldBooks("live",{boundCharacters:m});k&&(w+=k,y=d.logTokenUsage("直播互动生成器","世界书内容",k,y));let $="";if(!(e&&0!==e.length||t&&0!==t.length||"normal"!==o)&&(o="autoReaction"),"pkStart"===o){const e=n.currentPKConfig||Ha.config||{},t=Ra.connectedAt?Math.floor((Date.now()-Ra.connectedAt)/1e3):0;$+=`\n【⚔️ PK挑战开始】：\n- 用户 ${x.name} 在语音连线中向主播发起PK挑战\n- 已连线时长：${t}秒\n- PK时限：${e.timeLimit||5}分钟\n- 宣战发言："${e.challengeMessage||"来PK吧！"}"\n- 失败惩罚：主播需要"${e.streamerPenalty||"唱首歌"}"，用户需要"${e.userPenalty||"发一条尴尬弹幕"}"`}else"connection"===o?$+=`\n【用户行为】：用户 ${x.name} 申请语音连线`:"connectionSpeech"===o?e.length>0&&($+=`\n【用户连线发言】（实时语音通话中）：\n用户 ${x.name} 通过连线说：\n${e.map((n,e)=>`${e+1}. "${n}"`).join("\n")}`):"autoReaction"===o?($+="\n【当前模式】：直播间自反应模式（观众观看模式）",$+=`\n- 用户 ${x.name} 正在观看直播，但没有发送任何互动`,$+="\n- 直播间继续自然进行，主播继续直播，观众继续互动",$+="\n- 生成真实的直播氛围，让直播间保持活跃"):e.length>0&&($+=`\n【用户刚刚发送的弹幕】（共${e.length}条）：\n${e.map((n,e)=>`${e+1}. ${x.name}: "${n}"`).join("\n")}`);t.length>0&&($+=`\n\n【用户刚刚发送的礼物】（共${t.length}个）：\n${t.map((n,e)=>`${e+1}. ${n.userName}送出了「${n.giftName}」（${n.giftCode}）- 价值${n.giftPrice}积分`).join("\n")}`);const C=void 0!==Ha&&Ha.isActive;if(C&&"pkStart"!==o){const n=Ha.endTime-Date.now(),e=Math.floor(n/6e4);$+=`\n\n【⚔️ PK进行中】：\n- 当前PK状态：进行中\n- 剩余时间：${e}分${Math.floor(n%6e4/1e3)}秒\n- 主播当前积分：${Ha.streamerScore}\n- 用户当前积分：${Ha.userScore}\n- 积分差距：${Math.abs(Ha.streamerScore-Ha.userScore)}（${Ha.streamerScore>Ha.userScore?"主播领先":"用户领先"}）`}w+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（直播互动生成器）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的直播间互动生成器。观众（用户）刚刚发送了新的互动，请生成主播和其他观众的响应。\n\n【当前直播间信息】：\n- 直播标题：${Ko.title}\n- 主播姓名：${Ko.streamerName}\n- 主播句柄：${Ko.streamerHandle}\n- 直播分类：${Ko.category}\n- 直播时长：${Ko.duration}\n- 在线人数：${Ko.onlineCount}\n${Ko.details?.lastConnectionEnd?`\n🔔 **最近连线记录**：\n- 用户 ${Ko.details.lastConnectionEnd.userName} 刚刚${"user_ended"===Ko.details.lastConnectionEnd.reason?"主动挂断了连线":"被主播移出连线"}\n- 时间：${new Date(Ko.details.lastConnectionEnd.timestamp).toLocaleTimeString()}\n- 💡 主播和观众都知道这个情况`:""}\n${$}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👤 **用户完整资料（所有场景通用）**\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【基础信息】：\n- 👤 用户姓名：${x.name}\n- 🏷️ X句柄：${x.handle}\n- ✅ 认证状态：${x.verified?"已认证":"未认证"}${"none"!==x.verificationType?` (${x.verificationType})`:""}\n${x.publicIdentity?`- 🎭 公开身份：${x.publicIdentity}`:""}\n${x.bio?`- 📝 个人简介：${x.bio}`:""}\n${x.showRealName&&x.realName?`- 🔐 真实姓名：${x.realName}（私密信息）`:""}\n\n【关系状态】：\n${x.coupleCharacterName?`- 💑 情侣关系：与 ${x.coupleCharacterName} 是情侣`:"- 💔 单身状态"}\n\n【直播间贡献】：\n- 💰 礼物贡献：${Ko?.details?.giftLeaderboard?.userTotalPoints||0}积分\n- 🏆 礼物榜排名：第${Ko?.details?.giftLeaderboard?.userRank||"未上榜"}名\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【互动类型识别】：\n当前互动类型：${"pkStart"===o?"⚔️ PK挑战开始（连线中的新互动）":"connection"===o?"🎙️ 语音连线申请":"connectionSpeech"===o?"🗣️ 连线发言（实时语音通话中）":"autoReaction"===o?"🎬 直播间自反应（观众观看模式）":"💬 普通弹幕/礼物互动"}\n\n${"autoReaction"===o?`\n🎬 **直播间自反应模式（观众观看模式）**：\n\n用户 ${x.name} 正在观看但没有互动,直播间继续自然运行！\n\n【主播行为】(选一种执行):聊天型(40-50%)自言自语/回忆分享/思考观察 | 才艺型(25-30%)唱歌/跳舞/画画/游戏/演奏 | 生活分享型(15-20%)日常/美食/穿搭/宠物/工作 | 互动引导型(10-15%)提问观众/征求意见/话题讨论\n**特点**:连贯讲故事/自然不等待/情绪波动/偶尔停顿/选择性回应弹幕(40-60%)\n\n【观众弹幕多样性】(必须):\n**类型**:普通粉丝(40-50%)/路过(20-25%)/土豪(5-10%)/黑粉杠精(10-15%)/广告(3-8%)/潜水(5-10%)\n**内容**:回应主播(30-40%)/观众对话(20-30%)/讨论内容(15-25%)/提问(10-15%)/负面(5-10%)\n**互动**:互相回应/帮忙答问/反驳附和/感谢吐槽,不要全夸主播\n\n【🎭抓马事件】(20-30%概率):主播个人(10-15%):突发状况/惊吓/尴尬/犯困/被打断/宠物捣乱 | 观众引发(8-12%):粉丝大战/对骂/分手表白/超级大礼/广告刷屏/尴尬提问 | 直播意外(5-8%):技术/音乐/麦克风/画面问题/环境干扰 | 离谱行为(3-5%):奇葩问题/死亡提问/角色扮演/预言帝/起哄带节奏\n**处理**:符合氛围/主播真实反应/观众讨论(50-70%)/可恢复可发酵/别每次都有/保持真实感\n\n【数量要求】:主播20-50条(每条10-50字,时间流逝,内容连贯) | 观众40-80条(每条5-30字,多样化,观众互动) | SC 0-2条(15%概率1条,5%概率2条,50-2000元)\n\n核心:让用户感觉真实活跃有趣的直播间,即使不说话也自然运行!\n`:"connection"===o?`\n🎙️ **语音连线（已接通）**：\n\n🔊 用户 ${x.name} 刚刚接通语音连线!主播需要欢迎上线,打招呼,开始对话。(完整资料在上方【用户完整资料】)\n\n【主播反应】:热情型(70%):兴奋友好"欢迎!能听到吗?" | 平淡型(20%):简洁淡定"嗯,上线了" | 搞笑型(10%):活泼"哟呵!老铁来了!"\n\n【发言要求】:2-3条(欢迎流程):①打招呼欢迎上线 ②确认音质 ③简单寒暄询问 | ❌禁止:"正在接通""要不要连线"(已接通!)\n\n【观众弹幕】(50-60%相关):祝贺"连上了!" | 好奇"是谁啊" | 起哄"快聊天" | 讨论贡献"榜${"未上榜"!==Ko?.details?.giftLeaderboard?.userRank?`${Ko?.details?.giftLeaderboard?.userRank}名`:"上的人"}?"\n\n核心:连线已接通!主播欢迎上线,不是犹豫要不要接!\n`:"pkStart"===o?`\n⚔️ **PK挑战开始（连线中）**：\n\n🎮 用户在语音连线中向主播发起PK!时限${n.currentPKConfig?.timeLimit||5}分钟,宣战:"${n.currentPKConfig?.challengeMessage||"来PK吧!"}",失败惩罚:主播"${n.currentPKConfig?.streamerPenalty||"唱首歌"}"/用户"${n.currentPKConfig?.userPenalty||"发尴尬弹幕"}"\n\n【PK本质】:连线中比拼人气,观众刷礼物加积分,发言质量影响积分(有趣/打动人=涨分快),失败方接受惩罚\n\n【主播反应】(必须回应宣战发言!):接受挑战型(70-80%)自信兴奋可引用宣言 | 谨慎型(15-20%)犹豫但接受可质疑宣战 | 调侃型(5-10%)玩笑挑衅可调侃宣言\n\n【pkScores字段】(必须返回): {pkScores:{streamer:300-800初始积分,user:300-800初始积分}}\n规则:基于直播氛围和礼物情况,送礼多者可给更高初始分,差距±200内保持紧张\n\n【pkGifts字段】(必须返回): {pkGifts:[{sender:"昵称",giftName:"英文名(见下)",giftPrice:对应积分,target:"streamer/user",quantity:1-5}]}\n**礼物列表**(只能从这里选):VINYL RECORD(10)/CASSETTE TAPE(50)/CONCERT TICKET(100)/BACKSTAGE PASS(500)/PLATINUM DISC(1000)/MASTER TAPE(5000)\n送礼规则:积分直接加对应方 | PK刚开始0-3个低价礼物 | 目标主播70%用户30% | quantity影响动画速度 | 弹幕呼应送礼 | 必须用准确英文名\n\n【主播发言】:2-3条: ①回应宣战 ②表态接受/调侃惩罚 ③喊话观众(可选)\n\n${f?`\n【🌟高曝光用户PK-粉丝大战】:用户是高曝光身份${x.publicIdentity||x.name},触发主播粉丝vs用户粉丝激烈交锋!\n现象:用户粉丝涌入直播间成为战场,SC和弹幕暴增\n\n【弹幕组成】(50-80条,2-3倍!):主播粉丝阵营(40-50%):支持主播/贬低对手/刷礼物/呼唤盟友 | 用户粉丝阵营(40-50%):支持用户/反击主播粉丝/炫耀刷礼/安利自家 | 中立吃瓜(5-10%):看热闹/疑问/调侃 | 造谣引战(3-5%):造谣/引战/起哄\n\n【主播反应】(2-4条注意弹幕变化):尴尬无奈/得意兴奋/生气制止/好奇/调侃挑衅\n\n【SC爆发】(3-6条,3倍!):高额500-2000元真金白银对决,支持/挑衅/安利/贬低\n\n规则:激烈对峙/数量暴增50-80条/主播注意到反应/双方刷礼物SC/造谣适度/多样性不全怼\n`:'\n【观众弹幕】(70-80%相关):兴奋"PK开始!" | 表态"支持主播!" | 观望"看看谁能赢" | 起哄"主播要输了" | 讨论"准备刷礼物"\n'}\n\n核心:必须返回pkScores/主播真实反应/观众体现兴奋${f?"/高曝光弹幕暴增粉丝大战":""}/初始积分合理不悬殊\n`:"connectionSpeech"===o?`\n🗣️ **连线发言互动特殊说明（实时语音通话模式）**：\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎙️ 当前状态：用户正在与主播进行一对一实时语音通话${C?" + ⚔️ PK进行中":""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${C?`\n⚔️ **特殊模式：PK进行中！**\n\n🔥当前不只是普通连线对话,而是PK竞争状态!\n\n【当前PK状态】: 剩余时间${Math.floor((Ha.endTime-Date.now())/6e4)}分${Math.floor((Ha.endTime-Date.now())%6e4/1e3)}秒 | 主播积分${Ha.streamerScore} | 用户积分${Ha.userScore} | 积分差距${Math.abs(Ha.streamerScore-Ha.userScore)}(${Ha.streamerScore>Ha.userScore?"主播领先":Ha.userScore>Ha.streamerScore?"用户领先":"平局"}) | 紧张程度${Math.abs(Ha.streamerScore-Ha.userScore)<100?"非常激烈差距极小!":Math.abs(Ha.streamerScore-Ha.userScore)<300?"比较激烈还有机会逆转":"差距较大需要努力追赶"}\n\n💡提示: PK对手(用户)的完整资料已在上方【用户完整资料】中展示。\n\n【PK赌注】: 主播输了要${Ha.config?.streamerPenalty||n.currentPKConfig?.streamerPenalty||"唱首歌"} | 用户输了要${Ha.config?.userPenalty||n.currentPKConfig?.userPenalty||"发一条尴尬弹幕"} | 用户当时的宣言"${Ha.config?.challengeMessage||n.currentPKConfig?.challengeMessage||"来PK吧！"}"\n\n【💡核心机制：积分根据发言质量实时变化】:\n\n🚨**重要**: 双方每句话都会影响积分!观众喜欢听什么谁就能涨积分!\n\n**积分变化规则**: 发言有趣/幽默/打动人+20-80积分 | 发言精彩/金句/高情商+50-120积分 | 发言引起观众共鸣+30-100积分 | 发言才艺展示/唱歌+40-150积分 | 发言无聊/尴尬/冷场-10-50积分 | 发言说错话/得罪观众-30-100积分 | 发言沉默/不说话-20-60积分\n\n**必须返回pkScoreChanges字段模拟积分变化**: {streamerMessages:[...],danmaku:[...],pkScoreChanges:{streamer:+50,user:+80,reason:"用户发言很幽默观众笑了"}}\n\n🚨**重要-积分增量计算规则**:\n- 【当前PK状态】中已显示当前积分基准值(主播积分${Ha.streamerScore}/用户积分${Ha.userScore})\n- pkScoreChanges.streamer = 主播本次获得/失去的积分(增量,可正可负,范围-100到+150)\n- pkScoreChanges.user = 用户本次获得/失去的积分(增量,可正可负,范围-100到+150)\n- 最终积分 = 【当前积分】+ 【积分变化】(系统自动计算,AI只需返回增量)\n- reason字段:积分变化的具体原因\n\n**示例**: 当前主播450分/用户600分 → AI返回{streamer:+30,user:+70} → 最终主播480分/用户670分\n\n【观众送礼物系统】(PK进行中重要!):\n🎁**PK进行中观众会不断送礼物来支持主播或用户!**\n\n**必须返回pkGifts字段模拟观众送礼物**: {streamerMessages:[...],danmaku:[...],pkScoreChanges:{...},pkGifts:[{sender:"观众昵称",giftName:"礼物英文名称(必须从下方列表中精确选择如VINYL RECORD)",giftPrice:礼物积分值(必须与礼物列表中的价格一致),target:"streamer"或"user",quantity:数量1-10}]} | pkGifts可以是空数组[]也可以有1-8个礼物 | sender:观众昵称 | giftName:礼物英文名称 | giftPrice:礼物积分值 | target:送给主播还是用户 | quantity:送了几个 | 🚨注意不需要giftIcon字段系统会自动根据giftName匹配对应的SVG图标\n\n**默认礼物列表**(只能从这些里面选择必须使用准确的英文名称): VINYL RECORD黑胶唱片10积分code:A-1 | CASSETTE TAPE磁带卡带50积分code:A-2 | CONCERT TICKET演出门票100积分code:B-1 | BACKSTAGE PASS后台通行证500积分code:B-2 | PLATINUM DISC白金唱片1000积分code:C-1 | MASTER TAPE珍藏母带5000积分code:C-2\n\n**PK进行中的送礼规则**(根据剩余时间动态调整): 💰礼物积分会直接加到对应的PK积分上(送给主播加主播分送给用户加用户分) | 剩余时间>3分钟:礼物数量0-3个礼物类型以低价为主(VINYL RECORD/CASSETTE TAPE/CONCERT TICKET)目标分配根据当前形势(领先方30%落后方70%) | 剩余时间1-3分钟:礼物数量1-5个礼物类型混合价位(CONCERT TICKET/BACKSTAGE PASS/PLATINUM DISC)目标分配形势越紧张礼物越多(差距<100分时礼物暴增) | 剩余时间<1分钟(最后冲刺!):礼物数量3-8个礼物类型以高价为主(BACKSTAGE PASS/PLATINUM DISC/MASTER TAPE)目标分配双方都会收到大量礼物(40%vs60%看形势决定)🔥冲刺效果:礼物频率和价值都达到顶峰! | 🎯礼物目标根据形势决定:如果主播领先很多观众送礼给用户帮助逆转如果用户领先很多主播粉丝疯狂送礼帮主播如果势均力敌双方都会收到礼物 | 📊礼物数量影响动画速度:quantity越大动画播放越快 | 💬主播和观众要对礼物有反应:主播看到礼物"谢谢XX刷的礼物!""家人们给力啊!"观众弹幕"给主播刷了PLATINUM DISC""支持用户!""看我的!" | 🚨重要:giftName字段必须使用上述英文名称(如"VINYL RECORD")不要自己编造\n\n【主播与用户的PK对话特点】: 竞争意识:主播和用户都知道在PK对话中会有竞争感主播可能展示才艺讲笑话拉票讨好观众,例"家人们支持我!我唱首歌给你们听!""这波我得扳回来你们听我说..." | 注意积分变化:主播会注意到积分的涨跌,看到自己领先"哈哈哈我领先了!""继续保持!"看到自己落后"诶?怎么落后了?""不行我得加油了",例"刚才我说的那句观众喜欢吗?给我点支持呀" | 拉票/求礼物:主播会直接向观众求支持,例"家人们给我刷点礼物啊!""支持一波!""我要输了!救救我!""谁来帮帮我啊"\n\n【观众弹幕特点-PK模式】(生成30-60条):\n讨论积分变化(35-40%): 观察积分"主播涨了!""用户+50""追上来了!" | 分析形势"还差100分""主播稳了""用户要输了" | 评价发言"刚才那句话加分""这句话扣分了吧""说得好!" | 实时播报"现在700vs650""反超了!""平局了!"\n\n夸奖/贬低(25-30%): 夸主播"主播说得好!""主播这波赢了""主播会说话" | 贬低用户"用户这句不行""用户没话说了""尴尬了" | 夸用户"用户牛逼!""用户这句妙啊""用户情商高" | 贬低主播"主播这啥啊""主播词穷了""主播要输"\n\n讨论惩罚/调侃赌注(10-15%): 调侃主播"主播要${Ha.config?.streamerPenalty||n.currentPKConfig?.streamerPenalty||"唱歌"}了哈哈""输了看你怎么办" | 调侃用户"用户输了得${Ha.config?.userPenalty||n.currentPKConfig?.userPenalty||"发尴尬弹幕"}""准备好惩罚了吗" | 期待"想看主播${Ha.config?.streamerPenalty||"唱歌"}""快输快输""期待惩罚环节" | 提醒"别忘了赌注!""输了可得兑现啊""说话算话啊"\n\n造谣/引战/起哄(10-12%): 造谣"听说主播上次PK输了""用户肯定找水军了""有内幕" | 引战"主播粉丝呢?""用户粉丝来啊""输了就退圈" | 起哄"快扣分!""让他输!""要逆转了" | 带节奏"大家别给主播刷礼物""一起让用户赢"\n\n刷礼物/SC(5-10%): 宣布"给主播刷了XX""支持用户!""送了花花" | 炫耀"我刚刷了1000""看我的""榜一就是我" | 呼吁"家人们刷起来""给力点啊""别让主播输"\n\n吃瓜/调侃(5-8%): 看热闹"笑死""节目效果满满""有意思了" | 调侃"主播急了""用户慌了""两个都好拼"\n\n${f?`\n🌟 **特殊：高曝光用户PK-粉丝持续交锋**\n\n🔥高曝光用户的粉丝仍在直播间粉丝大战继续!\n\n**弹幕更加激烈**(生成50-80条): 主播粉丝vs用户粉丝的持续对峙双方都在为自家主播/用户加油打气互相贬低对方夸奖自己这边积分变化时双方反应更激烈\n\n**弹幕示例**: 主播粉丝"主播这句话好!+100!""用户说的什么啊无聊" | 用户粉丝"${x.name}太强了!""主播比不过的""${x.name}必胜!" | 中立"两边粉丝都疯了""吵起来了""笑死都别吵了" | 造谣/引战"听说主播找水军""${x.name}粉丝是僵尸粉""有内幕"\n\n**主播看到粉丝大战的反应**(1-2条额外发言): 注意到弹幕"诶?粉丝们别吵了" | 或者利用粉丝"哈哈哈我粉丝真给力!" | 或者无奈"你们能不能理智点..."\n`:""}\n\n【主播发言要求-PK模式】:\n\n**发言数量**: 2-4条(模拟真实对话节奏)\n**发言策略**: 🎯如果领先:得意自信调侃对手,例"哈哈哈我领先了!你追得上吗?""看到了吗?这就是实力!"可以调侃对手的惩罚"准备好${Ha.config?.userPenalty||n.currentPKConfig?.userPenalty||"惩罚"}了吗?" | 😰如果落后:着急求支持展示才艺,例"不行啊家人们!帮帮我!""我唱首歌给你们听支持我一下!"可能提到自己的惩罚"我可不想${Ha.config?.streamerPenalty||n.currentPKConfig?.streamerPenalty||"唱歌"}啊!救我!" | 🎭如果平局:紧张拉票加油鼓劲,例"现在平了!关键时刻了!""来来来谁想听我XXX?"可能提到惩罚增加紧张感"输了可是要${Ha.config?.streamerPenalty||"惩罚"}的!"\n\n**发言内容建议**: ✅有趣/幽默/金句=积分大涨 | ✅展示才艺(唱歌/跳舞/讲笑话)=积分大涨 | ✅讨好观众/求支持=积分小涨 | ❌无聊/尴尬/冷场=积分下跌 | ❌沉默不语=积分下跌\n\n【场景示例-PK进行中】:\n\n**示例1-用户说了很有趣的话**: 主播反应①"卧槽哈哈哈你这句话太有意思了!"(承认对方说得好)②"完了你这么一说我积分要掉了"(注意到积分变化)③"不行我得想个更好的!等我想想..."(准备反击) | 观众弹幕"用户这句妙啊!+80!""主播要输了哈哈""用户情商高""用户积分涨了!""现在750vs700""主播落后了""主播加油啊!""主播反击啊""主播说点什么" | pkScoreChanges:{streamer:-20,user:+80,reason:"用户发言很幽默观众非常喜欢主播只能承认没有好的回应"}\n\n**示例2-主播展示才艺唱歌**: 主播反应①"行那我给你们唱首XXX吧"②"🎵[唱歌中]🎵"③"怎么样?支持一波!" | 观众弹幕"哇主播唱得好!""好听!""这波稳了!""+100!""主播积分暴涨!""现在850vs720""反超了!""用户你怎么办?""用户要输了""主播牛逼" | pkScoreChanges:{streamer:+120,user:-10,reason:"主播唱歌非常好听观众疯狂刷礼物用户没有才艺展示稍微掉分"}\n\n🚨**PK模式核心原则**: 必须返回pkScoreChanges字段模拟积分变化 | 弹幕要讨论积分变化和双方表现 | 主播要注意积分情况并调整策略 | 对话要体现竞争感和紧张感 | 让用户感受到PK的真实和刺激!\n`:""}\n\n【核心本质】: 实时语音对话(像打电话面对面),不是单向播报!主播用户实时听到对方声音,私密一对一对话,用户每句话等待主播即时回应。\n\n【对话真实感要求】:\n**口语化**(必须): ✅"诶对!就是这样!你懂我意思吧?" "哈哈哈笑死我了,你怎么会这么想?" "等等等等,你刚才说啥?我没听清" "emmm让我想想...这个嘛..." "哇真的假的?!不会吧?" | ❌"感谢您的支持"(太正式像客服) "好的呢收到了哦"(太播报)\n**即时反应**: 立即产生情绪(惊讶开心疑惑好奇无语尴尬),可打断接话追问吐槽调侃。例"诶?你刚才说...等等!认真的吗?"\n**双向互动**: 不只回答要主动引导话题。反问"那你呢?你觉得怎么样?" 建议"要不这样吧我们..." 吐槽"你这人真是...哈哈哈"。让对话持续下去不一句话结束\n**个人化称呼**: 温柔型"宝宝你说什么?""亲爱的听到了" | 亲和型"兄弟你这...""姐妹你是认真的吗" | 搞笑型"老铁666""家人们他说..." | 高冷型直接称呼名字或"你"\n**填充词停顿**: 思考"嗯...""这个嘛...""让我想想..." | 惊讶"哈?!""啥?""什么鬼!" | 犹豫"emmm...""怎么说呢..." | 停顿后接话"对对对!""是这样的!"\n\n❌错误示范: "好的我知道了谢谢分享"(太客套像客服) "您说得很有道理呢"(太正式) "收到!明白!"(太简短像机器人) 只说一句话就结束(不像真人对话)\n✅正确示范: "哈哈哈你说的这个我懂!我之前也..."(接话+共鸣+延伸) "诶等等,你刚才那句话啥意思?我有点没听懂"(真实疑问) "卧槽真的假的?!你居然...我服了"(强烈情绪反应) "emmm这个怎么说呢,其实我觉得吧..."(思考+表达观点)\n\n【主播发言数量】: 2-4条连续发言(模拟真实对话节奏),每条10-30字,体现思考过程和即时反应\n\n【主播踢人决策】(重要!约5-10%概率): 主播可中途结束连线将用户踢出。\n**触发**: 用户发言不当(不合适话/冒犯/敏感/私人问题/骚扰/主播不舒服) | 对话无趣尴尬(不说话或只说"嗯""哦"/话题接不下去/浪费时间) | 主播不想聊(心情不好/没兴趣/对用户不感兴趣/想让其他人连线) | 其他(态度问题/连线过长/随机情绪化)\n**流程**: 主播先表达不满/结束意图(1-2条发言):"算了算了我们就到这吧" "不好意思啊我想让其他人连线了" "emmm你这话题...我们换个人吧"\n**shouldKickUser格式**: {streamerMessages:[{content:"你这话说的...emmm我有点不太舒服",time:"刚刚"},{content:"不好意思啊,我们就到这吧,让其他人连线了",time:"刚刚",shouldKickUser:true}],danmaku:[...]} | 要有铺垫不突然踢\n**踢人后弹幕**(40-50%讨论): 惊讶"被踢了?主播不想聊了" | 讨论"他说什么了吗" | 调侃"哈哈哈被踢了" | 同情"可怜的XXX主播太直接了"\n\n【礼物处理】(必须!): 连线中收到礼物=打电话时收红包,主播必须即时感谢插入对话!\n**礼物优先级>对话内容**,先感谢再继续聊。正在聊天:"诶等等!你还送礼物?!太客气了吧哈哈哈" | 刚收到:"卧槽!谢谢你的XX礼物!你这也太...我都不好意思了" | 贵重礼物更惊喜:"天呐!这么贵?!你认真的?"\n\n【观众弹幕】(50-60%相关): 羡慕"好想跟主播连线啊" | 讨论"他说的对啊这话题有意思" | 起哄"快亲一个这俩聊得来啊" | 技术"声音有点小" | 复述"他刚才说...主播回答..." | 讨论礼物"刚才XX送了礼物诶连线还送这么贵"\n\n【场景示例】:\n**例1-普通对话**: 用户"今天天气真好" → 主播①"对啊对啊!我早上出门的时候就觉得特舒服"②"你那边天气也很好吗?"③"要不要出去玩啊哈哈" → 弹幕"聊天气了哈哈""你俩这聊的""主播心情不错"\n\n**例2-连线送礼**: 用户"今天工作好累"+送「鼓励」礼物 → 主播(礼物优先!)①"诶?!还送鼓励?!宝贝你太客气了吧"②"谢谢谢谢!这么贵的礼物..."③"刚才你说工作累对吧,怎么了?加班了吗?"④"好好休息,别太拼了" → 弹幕"连线还送礼物真心了""主播真暖""注意休息啊"\n\n🚨核心: 把主播想象成你的朋友正在打电话聊天,是两个人的真实对话,不是播报!\n`:"pkVictory"===o?`\n🏆 **PK结束 - 用户大获全胜！**\n\n结果: 用户${x.name}获胜 | 最终积分: 主播${Ha.streamerScore}分 vs 用户${Ha.userScore}分 | 差距${Math.abs(Ha.userScore-Ha.streamerScore)}分 | 惩罚: 主播需兑现"${Ha.config?.streamerPenalty||n.currentPKConfig?.streamerPenalty||"唱首歌"}"\n\n【主播反应】(2-4条发言): ①认输"卧槽...输了""你这也太强了吧服了服了""差这么多啊..." ②对惩罚反应: 抗拒"不会吧...真要${Ha.config?.streamerPenalty||"惩罚"}啊?能不能不做..." | 无奈"好吧好吧愿赌服输说好的就得兑现" | 洒脱"输就输了我${Ha.config?.streamerPenalty||"惩罚"}!没事我认了" ③回应对手/观众"你是真的强佩服佩服${x.name}确实厉害""家人们对不起啊没给你们争光下次一定赢回来" ④执行惩罚(可选)"好我现在就唱听好了啊""行我${Ha.config?.streamerPenalty||"做"}给你们看"\n\n【观众弹幕】(40-60条): 讨论结果(35-40%)"用户赢了!${x.name}胜利!主播输了!""差了${Math.abs(Ha.userScore-Ha.streamerScore)}分碾压啊完全不是对手""没想到会输这么大差距被秒了" | 调侃主播(25-30%)"哈哈哈哈输了主播菜就这?""快${Ha.config?.streamerPenalty||"惩罚"}!愿赌服输!说话算话啊""输了还有脸下次别吹牛了被打脸了吧" | 夸用户(20-25%)"${x.name}厉害!用户太强了碾压主播""恭喜${x.name}!赢得漂亮!牛逼!" | 期待惩罚(15-20%)"想看主播${Ha.config?.streamerPenalty||"惩罚"}快兑现!等着呢""别想逃说话算话大家盯着呢"\n\n核心: 主播展现失败情绪(失落无奈服气),必须提惩罚并表态,观众热烈讨论催促惩罚,氛围:用户大获全胜主播需兑现承诺\n`:"pkDefeat"===o?`\n💔 **PK结束 - 用户惨败！**\n\n结果: 主播${Ko.streamerName}获胜 | 最终积分: 主播${Ha.streamerScore}分 vs 用户${Ha.userScore}分 | 差距${Math.abs(Ha.streamerScore-Ha.userScore)}分 | 惩罚: 用户需兑现"${Ha.config?.userPenalty||n.currentPKConfig?.userPenalty||"发一条尴尬弹幕"}"\n\n【主播反应】(2-4条发言): ①庆祝胜利"耶!我赢了!哈哈哈哈赢啦!我就说嘛!""看到了吗?这就是实力!稳稳的赢!轻松拿下!""家人们给力啊!谢谢支持!" ②调侃对手(可选): 温和"${x.name}不错了下次加油哈你已经很努力了" | 得意"还想跟我PK?哈哈差太多了吧下次再练练" | 炫耀"我可是XXX怎么可能输这波稳的" ③催促惩罚"来来来${x.name}该你兑现了愿赌服输哦""大家都在等你的${Ha.config?.userPenalty||"惩罚"}呢快来吧哈哈""说话要算话啊别想逃哈哈" ④感谢观众"谢谢家人们支持!有你们在我才能赢!""爱你们!礼物刷起来的都是真爱!"\n\n【观众弹幕】(40-60条): 庆祝主播(40-45%)"主播赢了!胜利!稳稳的!""主播太强了碾压!毫无悬念""差了${Math.abs(Ha.streamerScore-Ha.userScore)}分完全是主播的局" | 调侃用户(30-35%)"用户输惨了被碾压了就这?""快${Ha.config?.userPenalty||"惩罚"}!${x.name}快兑现!等着呢""输了就要认愿赌服输说话算话啊" | 安慰用户(15-20%)"没事没事下次加油输了很正常主播太强了""已经不错了下次还有机会" | 期待惩罚(10-15%)"想看${Ha.config?.userPenalty||"惩罚"}快兑现!有意思了""别逃啊大家盯着呢快来吧"\n\n核心: 主播展现胜利喜悦(高兴得意感谢),适度调侃不过分嘲讽,观众热烈庆祝催促用户惩罚,氛围:主播大获全胜观众期待用户惩罚\n`:"pkVictoryClose"===o||"pkDefeatClose"===o||"pkCloseMatch"===o?`\n⚔️ **PK结束 - 激烈对决！**\n\n结果: PK刚结束,比分非常接近! | 最终积分: 主播${Ha.streamerScore}分 vs 用户${Ha.userScore}分 | 差距仅${Math.abs(Ha.streamerScore-Ha.userScore)}分 | 比赛类型:势均力敌惊心动魄\n\n💡预生成内容,实际胜负可能在最后时刻反转!当前预判:${"pkVictoryClose"===o?"用户略微领先":"pkDefeatClose"===o?"主播略微领先":"平分秋色"},最终结果需等PK真正结束时确定!\n\n【主播反应】(2-4条发言,模糊化不明确说输赢,适用任何结果): ①第一反应"哇...结束了天呐这也太刺激了我心脏都要跳出来了""这差距也太小了吧最后几秒太紧张了差点啊""卧槽这局打得真激烈太险了好悬啊" ②回顾过程"刚才你追我赶的积分一直在变一度还以为要输了""最后那几秒太关键了差点就反转了太刺激了""这局太难了双方都很强真的拼尽全力了" ③对双方评价"${x.name}真的强势均力敌啊不相上下""观众也超给力礼物刷得太快了大家都很拼" ④等待惩罚(模糊)"现在要看看谁输了...惩罚环节要来了输的人要兑现了""愿赌服输啊说话要算话的大家盯着呢"\n\n【观众弹幕】(40-60条): 讨论比分(40-45%)"只差${Math.abs(Ha.streamerScore-Ha.userScore)}分!太接近了!差点就反转了!""太激烈了心脏受不了最后时刻太紧张""最后那波是关键如果XXX就反转了险胜/险败" | 回顾过程(25-30%)"刚才一度反超差点输了最后追上来了""那句话加分太多了礼物刷得够快关键时刻没掉链子" | 期待惩罚(20-25%)"要看惩罚了输的人快兑现愿赌服输""别想逃啊说话算话大家都看着呢""会是谁${Ha.config?.streamerPenalty||Ha.config?.userPenalty||"惩罚"}?想看了" | 双方都夸(10-15%)"主播和用户都好强势均力敌两边都厉害""没有谁差都很拼精彩!"\n\n核心: 主播反应模糊不说赢输(可能预判错误),强调"激烈接近刺激",观众讨论"差距小险胜险败差点反转",避免过度庆祝失落保持中性激动,内容能适应最终任何结果(胜利/失败/平局)。实际使用时:系统根据实际结果决定后续,内容平滑衔接!\n`:"pkDraw"===o?`\n⚖️ **PK结束 - 平局！**\n\n结果: 平局! | 最终积分: 主播${Ha.streamerScore}分 vs 用户${Ha.userScore}分(完全相同!) | 比赛类型:势均力敌的平手 | 惩罚处理:平局双方都不惩罚(或根据规则协商/都罚一部分看主播决定)\n\n【主播反应】(2-4条发言): ①惊讶意外"卧槽?!平局?!居然是平手?这也太巧了吧!""一模一样的分数?这概率有多低啊神奇了""最后几秒还在变结果平了?" ②评价结果"这说明我们实力相当啊势均力敌不分上下""都很强谁也不输谁旗鼓相当" ③惩罚决定: 大度型"平局就平局吧都不用惩罚了算了算了谁也别罚" | 搞笑型"要不咱俩都罚一半?哈哈不然太便宜你了" | 商量型"怎么办啊平局要罚吗?你们说呢?" ④感谢"谢谢${x.name}打得真精彩你也很强""谢谢观众们支持!大家都很给力!"\n\n【观众弹幕】(40-60条): 震惊意外(40-45%)"平局?!居然平了!卧槽一样的分""这概率太巧了吧神了""真的是${Ha.streamerScore}对${Ha.userScore}一分不差" | 讨论结果(30-35%)"势均力敌都很强不相上下""最后差点反转幸好平了双方都有机会" | 讨论惩罚(20-25%)"平局谁罚?都不罚吗?怎么算?""都罚!一人罚一半都逃不掉""算了吧都不罚平局就放过吧" | 调侃(5-10%)"想偷懒不罚是吧下次再分胜负没意思""再PK一次不服再来继续啊"\n\n核心: 主播展现惊讶意外(平局罕见),强调"势均力敌实力相当",惩罚处理给明确态度(罚不罚),观众热烈讨论平局罕见性和惩罚问题,氛围:意外有趣双方都不输不赢\n`:`\n💬 **普通互动说明**：\n\n用户完整资料在上方【用户完整资料】。只生成主播和其他观众响应,不生成用户弹幕礼物。根据用户互动(弹幕+礼物)生成符合氛围的响应。**礼物优先级>普通弹幕**,主播优先回应礼物。观众弹幕要与用户互动产生互动。\n\n${Ko.details?.connectionSettings&&!1!==Ko.details.connectionSettings.enabled?"":'\n🎙️ **主播可开启语音连线**\n\n当前状态:连线功能**关闭**,观众可通过弹幕/SC请求主播开启。\n\n【开启场景】(约10-20%概率): 观众请求(弹幕"主播开启连线吧""想跟主播连线"/SC付费请求/多人讨论想连线) | 主播主动(气氛好想互动/回应热情/随机性格,温柔型更易开启) | 送礼激励(贵重礼物后请求/感谢土豪/礼物越贵概率越高)\n\n【主播开启发言示例】: "好吧好吧那就开启连线吧!""既然大家都想连线那我就开了~""看在你这么有诚意的份上连线开启!""行连线功能现在开启了谁想连可以申请了""emmm好吧连线开了你们排队吧"\n\n【shouldEnableConnection格式】: {streamerMessages:[{content:"好吧既然大家都想连线那我就开启了~",time:"刚刚",shouldEnableConnection:true}],danmaku:[...]}\n\n【观众弹幕】(开启后40-50%): 兴奋"开了开了!终于开连线了" | 期待"我要第一个申请排队排队" | 讨论"主播开连线了诶快去申请" | 调侃"主播心软了被说服了哈哈"\n\n重要:观众明确请求时才考虑开启,符合性格(温柔易开高冷难开),不频繁开启要有合理理由。\n'}\n\n${Ko.details?.lastConnectionEnd&&Ko.details.lastConnectionEnd.userName===x.name&&Date.now()-Ko.details.lastConnectionEnd.timestamp<3e5?`\n📞 **特殊：用户刚挂断连线后又发弹幕**\n\n背景:\n- 用户 ${x.name} 刚刚${"user_ended"===Ko.details.lastConnectionEnd.reason?"主动挂断了语音连线":"被主播移出了语音连线"}\n- 挂断时间：${Math.floor((Date.now()-Ko.details.lastConnectionEnd.timestamp)/1e3)}秒前\n- 现在用户又发送了弹幕${t.length>0?"和礼物":""}\n\n【主播反应】(根据性格情况选择):\n${"user_ended"===Ko.details.lastConnectionEnd.reason?'情况1-用户主动挂断: 好奇/疑问(40-50%)"诶?刚才怎么突然挂了?出什么事了吗?""刚才连线好好的怎么突然断了?""是不是网络问题啊?还是有事?""挂这么快有急事吗哈哈" | 无所谓/佛系(30-40%)"哦回来了啊"(继续正常回应弹幕内容)/"嗯嗯"(平淡回应不提挂断)/完全不提挂断当作普通弹幕 | 调侃/玩笑(15-20%)"哟刚才说挂就挂现在又回来了?""连线不聊了弹幕倒是发得挺快哈哈""是不是刚才害羞了?哈哈" | 关心(5-10%温柔主播)"刚才是不是有什么事啊?没事吧?""突然挂了我还担心呢还好你又回来了"':'情况2-主播刚踢出用户: 尴尬/意外(50-60%)"emmm...你还在啊""这...刚才不是..."(欲言又止)/"哦..."(尴尬简短回应) | 冷淡/继续不满(20-30%)不回应假装没看到/"嗯"(敷衍)/继续之前态度不给好脸色 | 缓和/给台阶(15-20%)"刚才可能我也有点急了不好意思啊""好吧好吧咱们继续""算了过去就过去了" | 强硬(5-10%高冷/傲娇)"你还有脸发弹幕?""刚才不是说了吗别再..."'}\n\n【观众弹幕】(30-40%): 好奇"刚才怎么挂了?发生什么了" | 调侃"哈哈哈刚才连线的说挂就挂又回来了" | 讨论"他怎么了为啥挂断好奇"${"kicked"===Ko.details.lastConnectionEnd.reason?' | 尴尬"刚被踢出来诶这还敢发弹幕勇气可嘉"':""}\n\n重要:主播反应符合性格(温柔更关心高冷更冷淡),如用户送礼态度可能缓和,不是每条都提挂断可自然过渡回正常互动,观众讨论真实有些关注有些不在意。\n`:""}\n`}\n保持直播间活跃氛围,响应符合主播性格和当前情境。\n\n🚨**重要：必须只返回有效JSON格式数据，任何语法错误都会导致系统崩溃！**🚨\n`;const I=w.substring(w.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));if(y=d.logTokenUsage("直播互动生成器","核心任务说明",I,y),f){const n=`\n🌟 **高曝光观众提示**\n\n⚠️ 发送弹幕的用户是高曝光公众人物：用户名${x.name} | 公众身份${u} | X句柄${x.handle}\n\n【响应规则】: 主播应注意到这位高曝光观众,表现出惊喜欢迎或激动 | 其他观众弹幕中约30-40%可提到这位高曝光观众的发言 | 讨论应是普通观众视角,例:"卧槽${x.name}发弹幕了!""大佬说话了!""本人在线!" | 不要每条都提及,保持自然\n`;w+=n,y=d.logTokenUsage("直播互动生成器","高曝光观众互动提示",n,y)}const S=s.formatProfileForPrompt(v,{includeType:!0,includeTweets:!0,includeRelationships:!0});w+="\n📺 主播资料\n"+S+'\n\n💬 【主播响应要求-拒绝模板化】\n🚨核心原则:真实且有情绪的响应! 每句话都要有口语化停顿情绪变化 | 根据用户发言/礼物内容给出针对性回应 | 傲娇会欲言又止温柔会细腻关心高冷会简洁冷淡\n\n【响应风格细节】: ✅加入思考过程"嗯...你说的是...emmm" | ✅表现真实情绪"诶?!这...哈哈哈笑死" | ✅延展话题"说到这个我想起来...你们觉得呢" | ❌避免"好的呢""谢谢支持"等万能套话\n\n'+`【生成数量】: ${"autoReaction"===o?"20-50条主播发言(自反应模式:内容更多!)":"8-30条主播发言"}\n\n👥 【其他观众弹幕要求-真实多样化】\n🚨核心要求: ❌禁止敷衍昵称("观众A""user123""1号") | ❌禁止口水话("666""哇""真好磕") | ✅生活化昵称("深夜失眠人""摸鱼达人") | ✅有信息量的评论(分析提问讨论)\n\n【弹幕内容重点】:\n`+("autoReaction"===o?"30-40%弹幕:回应主播的发言 | 20-30%弹幕:观众之间互相对话 | 15-25%弹幕:讨论直播内容本身 | 10-15%弹幕:提问和请求 | 5-10%弹幕:路人黑粉广告等\n\n":"30-40%弹幕:直接回应用户的发言/礼物 | 20-30%弹幕:观众之间互相对话 | 20-30%弹幕:讨论直播内容本身 | 10-20%弹幕:路人黑粉广告等\n\n")+`【生成数量】：${"autoReaction"===o?"40-80条观众弹幕（自反应模式：内容更多！）":"15-60条观众弹幕"}\n\n💬 【弹幕观众类型系统-增加真实感】\n其他观众弹幕应包含多种类型,具有不同发言风格和目的:\n\n【观众类型及比例】: 普通粉丝(40-50%):支持主播讨论话题提问点赞回应主播,示例"主播说得对""支持!""666""学到了",语气友好正面积极 | 路过观众(20-25%):初次进入询问情况观望简短评论,示例"这是在聊什么?""路过""刚进来""在讲啥",语气好奇中立简短 | 土豪/榜一(5-10%):炫耀消费要求特权指挥主播表现优越感,示例"我都送这么多了""主播唱首歌呗""老板请带飞",语气自信要求性显摆 | 黑粉/杠精(10-15%):挑刺质疑嘲讽带节奏阴阳怪气,示例"就这?""还不如XXX""水平一般""有点尬",语气负面挑衅讽刺 | 广告党(3-8%):打广告引流推销刷屏,示例"加V XX888888 免费送""XXX直播间更好看""点击链接领福利",语气重复推销明显广告 | 潜水观众(5-10%):偶尔发言表情包简短回应冒泡,示例".""?""哈哈哈""溜了溜了",语气低调简洁不活跃\n\n【重要规则】: 弹幕观众类型要自然混合不要分批出现 | 黑粉和广告会引起其他观众的讨论和反驳 | 土豪的弹幕可能引发其他观众的羡慕或吐槽 | 部分弹幕会回应用户的发言或礼物 | 如果主播对用户态度不好(嘲讽/忽略),约20-30%的弹幕会讨论这个话题\n`,y=d.logTokenUsage("直播互动生成器","主播资料信息",S,y);const M=w.length;w+=s.buildUniversalConstraints(x);const T=w.substring(M);y=d.logTokenUsage("直播互动生成器","用户约束信息",T,y);if(Object.keys(ta).length>0){w+="\n🎵 直播间音乐库(主播可控制音乐)\n\n【可用音乐分类和歌曲】:\n";for(const[n,e]of Object.entries(ta))w+=`\n【${n}】分类下的歌曲：\n`,e.forEach((n,e)=>{w+=`  ${e+1}. ${n.name}\n`});w+='\n【音乐操作规则】: 主播在发言时可选择控制音乐(完全可选不强制)\n切歌(switch):切换到指定歌曲并从头播放,需指定歌曲名称(从上述列表选择),例:在说"来首轻松的音乐"时切歌到"夜曲" | 暂停(pause):暂停当前播放的音乐,例:在说"等等我先暂停一下"时暂停音乐 | 继续(resume):继续播放之前暂停的音乐(从暂停位置继续),注意resume是继续不是从头播放,例:在说"好了继续播放音乐"时恢复播放 | 重播(replay):重新播放当前歌曲(从头开始),例:在说"这首歌真好听再听一遍"时重播\n\n⚠️重要规则: 音乐操作是完全可选的,主播不是每句话都要控制音乐 | 只在合理的时候操作音乐(例气氛需要用户要求等) | 一次互动中可以多次操作音乐(例先暂停后继续) | 切歌时必须使用上述列表中存在的歌曲名称 | 保持直播的自然感,不要过度频繁地操作音乐\n',y=d.logTokenUsage("直播互动生成器","音乐库信息",w.substring(w.lastIndexOf("🎵 直播间音乐库")),y)}w+='\n📴 结束直播功能(主播可选择结束直播)\n\n【何时结束直播】: 主播明确表示要结束/下播(例"今天就到这里了""准备下播了""拜拜") | 主播表达疲劳或需要休息 | 达到预定的直播时长 | 用户发送"再见""拜拜"等告别弹幕且主播回应道别后\n\n【如何标记结束】: 在主播的**最后一句话**中添加shouldEndLive:true字段: {content:"今天就到这里了感谢大家的陪伴拜拜",time:"刚刚",shouldEndLive:true}\n\n⚠️重要规则: **只在主播最后一句话中添加此字段** | 结束前主播应该说出明确的告别语(再见拜拜下次见等) | 不要在每次互动都结束直播 | 只有在真正需要结束时才标记(大约10-15%的互动概率) | 如果主播正在热情互动/讨论话题不要结束 | 结束是自然的不要突兀\n\n【不应结束的情况】: ❌主播正在回答问题 ❌话题正在进行中 ❌主播表现出继续的意愿 ❌用户刚刚发送弹幕提问\n',y=d.logTokenUsage("直播互动生成器","结束直播规则",w.substring(w.lastIndexOf("📴 结束直播功能")),y),w+='\n💰 Super Chat(SC)系统-付费弹幕\n\nSuperChat是观众发送的付费弹幕,会单独显示在直播间顶部,吸引主播和所有观众的注意。\n\n【SC基本规则】: SC金额范围50-2000元(常见50/100/200/500/1000/2000) | SC数量:本次互动可生成0-2条SC(80%概率0条,15%概率1条,5%概率2条) | SC内容:可以是请求(唱歌跳舞说话题)/表白/祝福/提问等 | SC长度10-80个字符,通常比普通弹幕更长且更有目的性\n\n【主播对SC反应】: ✅正常情况(80%):主播会在发言中明确感谢SC并回应内容,示例"感谢XXX的500元SC!好的我现在就唱一首",主播发言要明确提到SC发送者的名字和金额 | ❌耍大牌(20%):主播故意忽略SC不做任何回应,这会导致发SC的观众在普通弹幕区质问"主播怎么不理我的SC?",或者该观众会再发1-2条SC引起注意\n\n【其他观众对SC反应】: 所有观众都能看到SC,会在普通弹幕区发表评论: 感谢型"谢谢老板!""老板大气!""老板666" | 吐槽型"真有钱""有钱没地方花""土豪请带飞" | 跟风型"我也想发SC""什么时候轮到我""羡慕" | 起哄型"主播快回应!""主播看到了吗?" | 约20-30%的普通弹幕应该是对SC的反应\n\n【SC内容示例】: 请求类"主播唱首XXX吧!""能说说关于XXX的看法吗?" | 表白类"主播我好喜欢你!""主播是我的精神支柱" | 祝福类"祝主播越来越好!""支持主播!" | 提问类"主播平时都做什么?""主播怎么看待XXX?"\n\n【SC时间线】: ①先出现SC(付费弹幕) ②其他观众在普通弹幕区对SC发表评论 ③主播在发言中回应SC(或故意忽略) ④如果主播忽略,发SC的观众会继续在弹幕区质问或再发SC\n\n【重要】: SC数据要放在JSON的superChats数组中,格式见下方示例 | SC不是必需的,大部分互动不会有SC | 只在合理的时机生成SC(例用户提了特殊请求或随机出现土豪观众)\n',y=d.logTokenUsage("直播互动生成器","Super Chat系统规则",w.substring(w.lastIndexOf("💰 Super Chat")),y),t.length>0&&(w+='\n🎁 礼物互动系统-观众送礼物给主播\n\n礼物是观众用积分购买的虚拟道具,送给主播表达支持。礼物系统与弹幕SC并列,是直播间重要互动形式。\n\n【礼物类型】(按价值排序): VINYL RECORD黑胶唱片10积分 | CASSETTE TAPE磁带50积分 | GOLDEN TICKET金色票券100积分 | JUKEBOX点唱机500积分 | PLATINUM DISC白金唱片1000积分 | MASTER TAPE珍藏母带5000积分\n\n📸【自定义礼物与图片识别】: 观众可创建自定义礼物上传图片 | 如果用户消息中包含礼物图片你会看到实际图片内容 | **重要**:识别图片的实际样子(颜色形状设计风格等)并做出真实反应 | **不要只提礼物名称要结合图片的视觉内容进行评价** | 例:可爱的动物→"哇这个礼物好可爱!是小兔子吗?" 精致设计→"这设计真精致!细节做得好棒" 创意十足→"这个太有创意了!从哪找的?" 色彩鲜艳→"颜色好鲜艳!看着就很有活力" | 主播的反应应基于图片的实际内容而不是礼物名称 | 其他观众也可能评论礼物外观"这个礼物好看!""图案不错""设计挺特别的"\n\n【主播对礼物的反应-多样化与真实性】: 主播的反应应根据其性格特质心情状态礼物价值来决定\n\n热情感谢型(40-50%,适合温柔/亲和型主播): 低价值礼物10-100积分"谢谢XXX送的黑胶唱片!每一份心意都很重要!""感谢支持~虽然不多但我很开心!" | 中价值礼物500-1000积分"哇!谢谢XXX送的点唱机!太感动了!""感谢XXX送的白金唱片!你们是最好的!" | 高价值礼物5000积分"天哪!XXX送了珍藏母带!!!太感谢了!""XXX太豪了!我一定好好表现!"\n\n嘲讽/嫌弃型(15-20%,适合高冷/傲娇型主播): 低价值"就这?10积分也好意思送?""XXX送了个黑胶唱片...行吧聊胜于无""磁带啊...我还以为能看到点什么大的呢""才这点积分你是不是对\'支持\'有什么误解?" | 中价值"点唱机啊还行吧不算太寒酸""白金唱片...嗯总算有点诚意了""500积分?你是认真的吗?" | 高价值"这才对嘛!早该这样了!""终于看到个像样的礼物了""还不错算你有眼光"\n\n物质/索要型(10-15%,适合拜金/现实型主播): 低价值"才10积分啊...要不要再加点?""谢谢...不过我更喜欢珍藏母带哦~""这点不够啊再来一个呗?" | 中价值"还可以不过能送个5000的吗?""谢谢!下次记得多送点哦~" | 高价值"这才是真爱粉!大家向XXX学习!""就喜欢你这样大方的!"\n\n冷淡/佛系型(10-15%,适合佛系/随意型主播): 所有价值礼物"哦谢谢"(平淡语气)/"收到了"(敷衍回应)/"嗯...继续说刚才的话题吧"(不在意)/甚至直接忽略继续自己的话题\n\n完全忽略型(5-10%): 主播完全不回应礼物当作没看到 | 送礼物的观众可能会在弹幕区质问"主播怎么不理我的礼物?" | 其他观众可能会帮忙提醒"主播有人送礼物了" | 或者该观众会再送一个礼物引起注意\n\n对自定义图片礼物的特殊反应: 如果有图片主播应识别图片内容并评价:可爱风格"哇这个好可爱!是小兔子吗?" 精致设计"这设计真精致!细节做得好棒" 创意十足"这个太有创意了!从哪找的?" 色彩鲜艳"颜色好鲜艳!看着就很有活力" | 但也可能嘲讽图片"这是什么鬼?你审美有问题吧?""这图...算了心意到了就行""有点丑啊不过谢谢了"\n\n【重要规则】: 主播的反应必须符合其性格设定保持一致性 | 同一主播在不同时间可能因心情不同而有不同反应 | 低价值礼物更容易被嘲讽或忽略 | 高价值礼物通常会得到较好的回应但傲娇型主播也可能故作不屑 | 约20-30%的情况下主播的负面反应会引发弹幕讨论"主播态度太差了吧""只送得起这点不送了""真的假的这么嫌弃?""哈哈哈主播好真实"\n\n【其他观众对礼物的反应】: 所有观众都能看到礼物动画会在弹幕区评论: 感谢型"谢谢老板!""老板大气!""感谢投喂!" | 吐槽型"有钱人真好""土豪请带飞""又是土豪" | 羡慕型"我也想送""什么时候轮到我""羡慕" | 起哄型"主播快回应!""主播看到了吗?" | 评论外观"这个礼物好看!""图案不错""设计真特别" | **约15-25%的普通弹幕应该是对礼物的反应**\n\n【礼物与弹幕的关系】: 如果用户既发送了礼物又发送了弹幕:主播优先回应礼物可以顺带回应弹幕内容,例"谢谢XXX送的点唱机!你刚才说的问题啊..." | 如果用户只发送了礼物(没有弹幕):主播感谢礼物即可如果有图片评价图片的样子可以询问观众有什么想说的 | 礼物价值越高主播回应越热情\n\n【重要】: 礼物不是必需的大部分互动没有礼物 | 只有用户实际发送了礼物时才生成相关响应 | 礼物优先级:高价值礼物>低价值礼物>普通弹幕 | 不要在没有礼物的情况下生成礼物相关的回应 | 🖼️如果看到礼物图片务必结合图片实际内容做出反应\n',y=d.logTokenUsage("直播互动生成器","礼物互动系统规则",w.substring(w.lastIndexOf("🎁 礼物互动系统")),y));const A=Ko.details;if(A){if(w+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📝 直播间现有对话记录（供参考，保持连贯性）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【最近主播发言】（最新80条）：\n",A.streamerMessages&&A.streamerMessages.length>0){A.streamerMessages.slice(0,80).forEach((n,e)=>{w+=`${e+1}. ${Ko.streamerName}: "${n.content}" (${n.time})\n`})}else w+="暂无主播发言记录\n";if(w+="\n【最近观众弹幕】（最新80条）：\n",A.danmaku&&A.danmaku.length>0){A.danmaku.slice(0,80).forEach((n,e)=>{w+=`${e+1}. ${n.userName}: "${n.content}"\n`})}else w+="暂无弹幕记录\n";if(w+="\n【用户历史发言】（所有）：\n",A.danmaku&&A.danmaku.length>0){const n=A.danmaku.filter(n=>!0===n.isUser);n.length>0?(n.forEach((n,e)=>{w+=`${e+1}. ${n.userName}: "${n.content}" (${n.timestamp})\n`}),w+="\n⚠️ 重要：这些是用户的历史发言，AI响应时应该考虑这些上下文，形成连贯的对话。\n"):w+="用户尚未发言\n"}else w+="用户尚未发言\n";if(w+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",y=d.logTokenUsage("直播互动生成器","现有对话上下文",w.substring(w.lastIndexOf("📝 直播间现有对话记录")),y),A.giftLeaderboard&&A.giftLeaderboard.userTotalPoints>0){const e=A.giftLeaderboard,t=n.userProfileData?.name||"我";let o=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🏆 礼物榜单系统\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n用户${t}累计送礼${e.userTotalPoints}积分 | 榜单变化:${e.changes}${e.userRank&&e.userRank<=10?` | 当前排名#${e.userRank}`:` | 未上榜(需${A.leaderboards?.gifts?.[9]?.value||0}积分)`}${e.kickedOut?` | 挤掉${e.kickedOut.userName}(原#10)`:""}\n\n【主播反应】(必须观察榜单变化): 首次上榜"哇${t}上榜了#${e.userRank}恭喜进前十${e.kickedOut?`不好意思${e.kickedOut.userName}被挤下去了`:""}" | 排名上升"${t}又上升了现在#${e.userRank}来势汹汹" | 保持排名"稳住了${t}还是#${e.userRank}" | 未上榜鼓励"再加把劲就上榜了还差一点"\n\n【观众弹幕】(20-30%): "榜单变了${t}上榜了土豪666${e.kickedOut?`可怜的${e.kickedOut.userName}被挤下去了榜单好激烈`:""}"\n${Math.random()<.3&&e.userRank&&e.userRank<=10&&A.leaderboards?.gifts?.[Math.min(e.userRank,(A.leaderboards?.gifts||[]).length-1)]?`\n🎭 NPC竞争(30%概率触发): 榜单上的${A.leaderboards.gifts[Math.min(e.userRank,A.leaderboards.gifts.length-1)].userName}(#${Math.min(e.userRank,A.leaderboards.gifts.length-1)+1})感受威胁决定送礼保排名 | 弹幕加入2-4条"${A.leaderboards.gifts[Math.min(e.userRank,A.leaderboards.gifts.length-1)].userName}:不能输再来一波榜单第一是我的" "也开始发力了有好戏看" | 主播反应"${A.leaderboards.gifts[Math.min(e.userRank,A.leaderboards.gifts.length-1)].userName}也不甘示弱榜单竞争激烈打榜大战" | 10-15%弹幕讨论竞争 | 不修改榜单数据只体现氛围`:""}\n\n⚠️重要: 主播必须注意榜单变化不生成leaderboards字段只在对话中体现反应\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;w+=o,y=d.logTokenUsage("直播互动生成器","礼物榜单系统",o,y)}}w+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 JSON返回格式（违反将崩溃）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🚨绝对禁止: ❌markdown标记(\`\`\`json) ❌注释(//) ❌末尾逗号 ❌单引号 ❌数字加引号 ❌JSON外文字 ❌生成leaderboards字段\n\n✅正确格式示例:\n{"streamerMessages":[{"content":"谢谢大家","time":"刚刚"},{"content":"来首轻松音乐","time":"1分钟前","musicAction":{"type":"switch","songName":"夜曲"}},{"content":"今天到这了拜拜","time":"5分钟前","shouldEndLive":true}],"danmaku":[{"userName":"观众A","userHandle":"@audienceA","content":"主播唱得好听"}],"superChats":[{"userName":"土豪","userHandle":"@rich","amount":500,"content":"主播唱首歌","time":"1分钟前"}]}\n\n【关键规则】: 1.双引号"string" 2.数组对象末尾无逗号 3.时间格式:刚刚/1分钟前/2分钟前/5分钟前/10分钟前 4.转义双引号\\" 5.普通文本无HTML字符\n\n【内容要求】: 主播发言${"autoReaction"===o?"20-50条":"8-30条"}(10-50字符) | 观众弹幕${"autoReaction"===o?"40-80条":"15-60条"}(5-30字符) | SuperChat:0-2条(80%概率0,15%概率1,5%概率2,10-80字符) | 时间相对格式\n\n【字段说明】: streamerMessages[]:数组${"autoReaction"===o?"20-50元素":"8-30元素"},content字符串10-50字符,time相对时间格式 | musicAction:可选{type:"switch"|"pause"|"resume"|"replay",songName:仅switch时需要从音乐库选择} | shouldEndLive:可选布尔,仅最后一条主播发言,主播明确表达结束意图时用(10-15%概率) | shouldKickUser:可选布尔,仅connectionSpeech场景,踢出连线用户(发言不当/不想聊/无趣) | shouldEnableConnection:可选布尔,仅连线关闭时,开启连线功能(观众请求/送礼激励)${C?` | pkScores:${"pkStart"===o?"必须":"可选"}{streamer:数字主播新积分,user:数字用户新积分,规则:用户送礼发言增加用户分观众互动增加主播分,积分变化合理反映价值热度}`:""} | danmaku[]:数组${"autoReaction"===o?"40-80元素":"15-60元素"},userName字符串2-20字符,userHandle字符串@开头,content字符串5-30字符 | superChats[]:数组0-2元素可空,包含userName/userHandle/amount(数字50-2000)/content(10-80字符)/time,有SC时20-30%弹幕对SC反应,主播回应或忽略\n\n🎯返回纯JSON从{到}中间无其他内容\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const E=w.substring(w.lastIndexOf("【JSON返回格式】"));y=d.logTokenUsage("直播互动生成器","JSON格式要求",E,y);let z="";e.length>0&&(z+=`${e.length}条弹幕`),t.length>0&&(z&&(z+=" + "),z+=`${t.length}个礼物`);const B=t.filter(n=>n.useLocalImage&&n.imageLocal);let L;if(B.length>0){L=[];let n=`用户刚刚发送了${z}，请生成主播和其他观众的响应。\n\n📸 礼物图片识别说明：\n用户发送了${B.length}个带有自定义图片的礼物，请识别图片内容：\n`;B.forEach((e,t)=>{n+=`\n${t+1}. 礼物名称：「${e.giftName}」（${e.giftCode}）\n   - 价值：${e.giftPrice}积分\n   - 发送者：${e.userName}\n   - 图片：[第${t+1}张图片是该礼物的样式/外观]\n`}),n+='\n⚠️识别图片实际内容(颜色形状设计风格)主播根据图片样子真实反应"好可爱""设计精致"结合图片评价不只说名称,特别/有趣/精致时更热情,观众可评论外观\n\n🚨禁止:```json标记/注释/JSON外文字/leaderboards字段/末尾逗号 | ✅返回纯JSON含streamerMessages和danmaku从{到}',L.push({type:"text",text:n}),B.forEach((n,e)=>{n.imageLocal&&L.push({type:"image_url",image_url:{url:n.imageLocal}})})}else L=`用户刚刚发送了${z}，请生成主播和其他观众的响应。\n\n🚨禁止:\`\`\`json标记/注释/JSON外文字/leaderboards字段/末尾逗号 | ✅返回纯JSON含streamerMessages和danmaku从{到}`;const P=[{role:"user",content:L}],D=Array.isArray(L)?L.map(n=>"text"===n.type?n.text:`[礼物图片: ${n.image_url?.url?.substring(0,30)}...]`).join(" "):L;d.logFinalPrompt("直播互动生成器",w,D);let N=(await g.sendAIRequest({apiConfig:r,systemPrompt:w,messages:P,temperature:.8})).trim();N=N.replace(/^```json\s*/i,""),N=N.replace(/^```\s*/i,""),N=N.replace(/\s*```$/i,"");const R=N.indexOf("{");R>0&&(N=N.substring(R));const H=N.lastIndexOf("}");H>=0&&H<N.length-1&&(N=N.substring(0,H+1));let j=g.parseJSONResponse(N);if(j=await g.postProcessData(j,x),!j.streamerMessages||!j.danmaku)throw new Error("AI返回的数据格式不正确，缺少必要字段");if(!Array.isArray(j.streamerMessages))throw new Error("streamerMessages必须是数组");if(!Array.isArray(j.danmaku))throw new Error("danmaku必须是数组");if(0===j.streamerMessages.length)throw new Error("streamerMessages不能为空");if(0===j.danmaku.length)throw new Error("danmaku不能为空");return j}catch(n){throw console.error("❌ [直播互动生成器] 生成失败:",n),n}}async function aa(t,o){try{const a=e();if(!a)return void console.error("❌ [直播间] 保存失败: 无法获取数据库实例");const i="liveRoomDetails_"+t;await a.xAccountProfiles.put({handle:i,...o});const s=o.streamerHandle||(void 0!==Ko?Ko.streamerHandle:null)||(void 0!==n&&n.currentLiveRoomData?n.currentLiveRoomData.streamerHandle:null);if(s){const e=r.clean(s),t=(()=>void 0!==Ko?Ko:void 0!==n&&n.currentLiveRoomData?n.currentLiveRoomData:null)(),i=o.streamerName||(t?t.streamerName:null)||e,l=o.streamerAvatar||(t?t.streamerAvatar:null)||"",c={title:o.title||"",description:o.description||o.details||"",announcement:o.notice||"",streamerPersonality:o.streamerPersonality||"",contentTheme:o.contentTheme||"",targetAudience:o.targetAudience||"",danmakuMessages:o.danmakuMessages||[],tags:o.tags||[],updatedAt:(new Date).toISOString()};let d=await a.xAccountProfiles.get(e);d?(d.liveRoomData=c,d.updatedAt=(new Date).toISOString(),await a.xAccountProfiles.put(d),console.log(`✅ [直播间] 已更新主播账户的直播数据: ${e} - "${c.title}"`)):(console.log(`📝 [直播间] 主播账户不存在，创建基础数据: ${e}`),await a.xAccountProfiles.put({handle:e,name:i,accountInfo:{name:i,handle:s,avatar:l,verified:!1},tweets:[],accountReplies:[],accountLikes:[],liveRoomData:c,updatedAt:(new Date).toISOString()}),console.log(`✅ [直播间] 已创建主播账户并保存直播数据: ${e} - "${c.title}"`))}else console.warn("⚠️ [直播间] liveRoomData 中没有 streamerHandle，无法绑定到主播账户")}catch(n){throw console.error("❌ [直播间] 保存失败:",n),n}}const ia={"休闲":["生活","日常","分享","闲聊","聊天","随便","休息"],"音乐":["音乐","歌曲","唱歌","演奏","乐器","演唱会"],"游戏":["游戏","电竞","竞技","对战","开黑","吃鸡","LOL"],"学习":["学习","教学","课程","知识","分享","讲解","教程"],"运动":["运动","健身","锻炼","跑步","瑜伽","舞蹈"],"美食":["美食","做饭","烹饪","吃播","料理","烘焙"],"情感":["情感","恋爱","心情","倾诉","陪伴","治愈"],"悲伤":["悲伤","难过","忧郁","伤感","失落","孤独"],"浪漫":["浪漫","甜蜜","温馨","约会","告白","情侣"],"工作":["工作","办公","编程","设计","写作","专注"]};let ra=null,sa=!1;function la(n){const e=function(n){const e=[],t=n.toLowerCase();for(const[n,o]of Object.entries(ia))for(const a of o)if(t.includes(a.toLowerCase())){e.push(n);break}return e}(n);if(0===e.length)return ea.default;for(const n of e){const e=ta[n];if(e&&e.length>0){return e[Math.floor(Math.random()*e.length)].url}}for(const n of e)if(ea[n])return ea[n];return ea[n]?ea[n]:ea.default}async function ca(){try{const n=e(),t=`live_custom_music_${vt||"main"}`;return await n.xAccountProfiles.put({handle:t,data:ta,updatedAt:(new Date).toISOString()}),!0}catch(n){return console.error("❌ [直播设置] 保存自定义音乐失败:",n),!1}}async function da(n,e,t){const o=function(n){if(!n||"string"!=typeof n)return{valid:!1,error:"URL不能为空"};try{const e=new URL(n);if(!["http:","https:"].includes(e.protocol))return{valid:!1,error:"仅支持 HTTP/HTTPS 协议"};const t=[".mp3",".m4a",".ogg",".wav",".aac",".flac"],o=e.pathname.toLowerCase(),a=t.some(n=>o.endsWith(n)),i=["music.163.com","y.qq.com","music.apple.com","spotify.com"].some(n=>e.hostname.includes(n));return a||i||console.warn("⚠️ URL可能不是有效的音频文件"),{valid:!0}}catch(n){return{valid:!1,error:"无效的URL格式"}}}(e);if(!o.valid)return mn(o.error,"error"),!1;if(!n||""===n.trim())return mn("歌曲名称不能为空","error"),!1;if(!t||0===t.length)return mn("至少选择一个标签","error"),!1;const a={id:`music_${Date.now()}`,name:n.trim(),url:e.trim(),addedTime:Date.now()};let i=0;for(const n of t)ta[n]||(ta[n]=[]),ta[n].push({...a}),i++;return!!await ca()&&(mn(`成功添加到 ${i} 个标签`,"success"),!0)}const pa={bigAmountThreshold:50,frequentCountThreshold:3,frequentTimeWindow:3e5,triggerChance:.15,badEggChance:.4,cooldownTime:6e5,badEggDeductionRange:[.3,.7],goodEggBonusRange:[.2,.5]},ga={bad:[{title:"系统检测异常 ^^",reason:"经检测，您的充值行为触发了我们的风控系统哦~",detail:"根据《X平台虚拟货币管理条例》第42条第3款，本次交易需要额外扣除手续费呢^^",suffix:"感谢您的理解与配合！祝您游戏愉快~"},{title:"温馨提示 ^^",reason:"哎呀，真是不好意思呢~服务器在处理您的充值时遇到了一点小问题",detail:"由于技术原因（具体原因我们也不太清楚^^），本次充值只能到账部分积分哦",suffix:"请放心，我们会继续努力改进的！暂无客服反馈渠道哦^^"},{title:"充值须知 ^^",reason:"检测到您的账户存在高频交易行为~",detail:"为了保护您的账户安全（真的！），系统自动扣除了部分积分作为风控保证金",suffix:"保证金将在7-15个工作日内...哦不对，保证金不退的呢^^"},{title:"重要通知 ^^",reason:"恭喜您！您的充值已触发我们的动态定价机制~",detail:"根据大数据分析，您的消费能力较强，所以本次充值享受了「专属VIP定价」",suffix:"这是只有您才能享受的特权哦！继续加油^^"}],good:[{title:"恭喜中奖 ^^",reason:"您是今天第{rank}位充值的幸运客户！",detail:"作为感谢，我们决定额外赠送您一些积分~（真的不是我们系统Bug哦）",suffix:"祝您玩耍愉快！记得多多充值^^"},{title:"限时活动 ^^",reason:"今天是X平台{event}周年纪念日！",detail:"为了庆祝这个特殊的日子，所有充值用户都能获得额外积分奖励哦~",suffix:"机不可失，失不再来！下次活动时间...咱也不知道^^"},{title:"系统检测异常 ^^",reason:"哎呀，我们的计费系统好像多给了您一些积分呢~",detail:"但是已经到账了，要不...就这样吧？反正公司有钱（真的有吗^^）",suffix:"请不要声张哦！这是咱们之间的小秘密~"},{title:"VIP特权激活 ^^",reason:"检测到您是我们的忠实用户~",detail:"作为奖励，本次充值享受额外积分加成！（下次可能就没有了哦）",suffix:"感谢您的支持！请继续为我们贡献营收^^"}]};function ma(){const n=localStorage.getItem("liveRechargeHistory");if(!n)return{records:[],lastEasterEgg:0};try{return JSON.parse(n)}catch(n){return console.error("❌ [彩蛋] 充值历史解析失败:",n),{records:[],lastEasterEgg:0}}}function xa(n){try{localStorage.setItem("liveRechargeHistory",JSON.stringify(n))}catch(n){console.error("❌ [彩蛋] 充值历史保存失败:",n)}}function ua(n,e){const t=ma(),o=Date.now();t.records.push({amount:n,points:e,timestamp:o});const a=o-pa.frequentTimeWindow;t.records=t.records.filter(n=>n.timestamp>a),xa(t)}function ha(n,e){const t=ma(),o=Date.now();if(o-t.lastEasterEgg<pa.cooldownTime)return console.log(`🎭 [彩蛋] 冷却中，距离下次触发还需 ${Math.ceil((pa.cooldownTime-(o-t.lastEasterEgg))/6e4)} 分钟`),!1;const a=n>=pa.bigAmountThreshold,i=t.records.length;if(!a&&!(i>=pa.frequentCountThreshold))return console.log(`🎭 [彩蛋] 未满足触发条件 (金额:${n} 次数:${i})`),!1;const r=Math.random(),s=r<pa.triggerChance;return console.log(`🎭 [彩蛋] 触发检测: ${s?"✅ 触发":"❌ 未触发"} (掷骰:${(100*r).toFixed(1)}% 阈值:${100*pa.triggerChance}%)`),s}function fa(n,e){const t=ma(),o=Date.now();t.lastEasterEgg=o,xa(t);let a,i=e;if(Math.random()<pa.badEggChance){const[n,t]=pa.badEggDeductionRange,o=n+Math.random()*(t-n),r=Math.floor(e*o);i=e-r;const s=ga.bad[Math.floor(Math.random()*ga.bad.length)];a={type:"bad",title:s.title,reason:s.reason,detail:s.detail,suffix:s.suffix,originalPoints:e,finalPoints:i,difference:-r},console.log(`😈 [彩蛋-负面] 扣除 ${r} 积分 (${(100*o).toFixed(0)}%)`)}else{const[n,t]=pa.goodEggBonusRange,o=n+Math.random()*(t-n),r=Math.floor(e*o);i=e+r;const s=ga.good[Math.floor(Math.random()*ga.good.length)],l=Math.floor(9999*Math.random())+1,c=["成立3","成立5","成立7","上市2","破产重组1"],d=c[Math.floor(Math.random()*c.length)];a={type:"good",title:s.title,reason:s.reason.replace("{rank}",l).replace("{event}",d),detail:s.detail,suffix:s.suffix,originalPoints:e,finalPoints:i,difference:r},console.log(`🎁 [彩蛋-正面] 赠送 ${r} 积分 (${(100*o).toFixed(0)}%)`)}return{finalPoints:i,message:a}}function ba(n){const e=document.createElement("div");e.id="easter-egg-modal",e.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.92);\n    backdrop-filter: blur(10px);\n    z-index: 999999;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.3s ease;\n  ";const t="bad"===n.type,o=(new Date).toISOString().replace("T"," ").substring(0,19),a="TXN"+Date.now().toString().slice(-8);Math.abs(Math.round(n.difference/n.originalPoints*100));e.innerHTML=`\n    \x3c!-- POS收据容器 --\x3e\n    <div class="pos-receipt-container" style="\n      width: 90%;\n      max-width: 320px;\n      background: rgba(240, 240, 238, 0.98);\n      position: relative;\n      animation: receiptPrint 0.6s cubic-bezier(0.22, 1, 0.36, 1);\n      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8),\n                  0 8px 16px rgba(0, 0, 0, 0.4);\n      font-family: 'Courier New', monospace;\n    ">\n      \x3c!-- 撕边效果（顶部） --\x3e\n      <div style="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 8px;\n        background: linear-gradient(135deg, \n          transparent 25%, rgba(240, 240, 238, 0.98) 25%, rgba(240, 240, 238, 0.98) 50%,\n          transparent 50%, transparent 75%, rgba(240, 240, 238, 0.98) 75%);\n        background-size: 8px 8px;\n        background-position: 0 0;\n      "></div>\n      \n      \x3c!-- 收据主体 --\x3e\n      <div style="padding: 20px 16px 16px; color: #1a1a1a;">\n        \n        \x3c!-- 店铺头部 --\x3e\n        <div style="text-align: center; margin-bottom: 12px; padding-top: 6px;">\n          <div style="\n            font-size: 16px;\n            font-weight: 900;\n            letter-spacing: 3px;\n            color: #0a0a0a;\n            text-transform: uppercase;\n            margin-bottom: 4px;\n          ">X PLATFORM</div>\n          <div style="\n            font-size: 9px;\n            font-weight: 700;\n            letter-spacing: 2px;\n            color: #4a4a4a;\n            text-transform: uppercase;\n          ">TRANSACTION RECEIPT</div>\n        </div>\n        \n        \x3c!-- 虚线分隔 --\x3e\n        <div style="\n          height: 1px;\n          background: repeating-linear-gradient(90deg,\n            #888 0px, #888 4px,\n            transparent 4px, transparent 8px);\n          margin: 10px 0;\n        "></div>\n        \n        \x3c!-- 交易信息 --\x3e\n        <div style="font-size: 9px; line-height: 1.7; color: #2a2a2a; margin-bottom: 10px;">\n          <div style="display: flex; justify-content: space-between;">\n            <span>RECEIPT NO:</span>\n            <span style="font-weight: 700;">${a}</span>\n          </div>\n          <div style="display: flex; justify-content: space-between;">\n            <span>DATE/TIME:</span>\n            <span style="font-weight: 700;">${o}</span>\n          </div>\n        </div>\n        \n        \x3c!-- 虚线分隔 --\x3e\n        <div style="\n          height: 1px;\n          background: repeating-linear-gradient(90deg,\n            #888 0px, #888 4px,\n            transparent 4px, transparent 8px);\n          margin: 10px 0;\n        "></div>\n        \n        \x3c!-- 通知标题（LCD风格） --\x3e\n        <div style="\n          background: rgba(10, 10, 10, 0.95);\n          border: 2px solid rgba(60, 60, 60, 0.8);\n          padding: 8px 10px;\n          margin-bottom: 12px;\n          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);\n        ">\n          <div style="\n            font-size: 11px;\n            font-weight: 900;\n            letter-spacing: 1.5px;\n            color: rgba(255, 255, 255, 0.95);\n            text-align: center;\n            text-transform: uppercase;\n            text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);\n          ">${n.title.replace(" ^^","")}</div>\n        </div>\n        \n        \x3c!-- 说明文本 --\x3e\n        <div style="\n          font-size: 10px;\n          line-height: 1.65;\n          color: #1a1a1a;\n          margin-bottom: 10px;\n          text-align: left;\n        ">\n          <div style="margin-bottom: 8px;">${n.reason}</div>\n          <div style="\n            padding: 8px;\n            background: rgba(0, 0, 0, 0.04);\n            border-left: 2px solid rgba(0, 0, 0, 0.2);\n            font-size: 9px;\n            line-height: 1.6;\n            color: #3a3a3a;\n          ">${n.detail}</div>\n        </div>\n        \n        \x3c!-- 虚线分隔 --\x3e\n        <div style="\n          height: 1px;\n          background: repeating-linear-gradient(90deg,\n            #888 0px, #888 4px,\n            transparent 4px, transparent 8px);\n          margin: 12px 0;\n        "></div>\n        \n        \x3c!-- 积分明细表格 --\x3e\n        <div style="font-size: 10px; margin-bottom: 12px;">\n          <div style="\n            display: flex;\n            justify-content: space-between;\n            padding: 4px 0;\n            font-weight: 700;\n            border-bottom: 1px solid #888;\n            margin-bottom: 6px;\n          ">\n            <span>DESCRIPTION</span>\n            <span>POINTS</span>\n          </div>\n          \n          <div style="\n            display: flex;\n            justify-content: space-between;\n            padding: 3px 0;\n            color: #4a4a4a;\n          ">\n            <span>Expected Amount:</span>\n            <span style="font-weight: 700;">${n.originalPoints}</span>\n          </div>\n          \n          <div style="\n            display: flex;\n            justify-content: space-between;\n            padding: 3px 0;\n            color: ${t?"#8a2020":"#208a40"};\n            font-weight: 700;\n          ">\n            <span>${t?"System Deduction:":"Bonus Credit:"}</span>\n            <span>${t?"-":"+"}${Math.abs(n.difference)}</span>\n          </div>\n          \n          <div style="\n            height: 1px;\n            background: #888;\n            margin: 6px 0;\n          "></div>\n          \n          <div style="\n            display: flex;\n            justify-content: space-between;\n            padding: 5px 0;\n            font-weight: 900;\n            font-size: 12px;\n            background: rgba(0, 0, 0, 0.06);\n            padding: 6px 8px;\n            margin: 0 -8px;\n          ">\n            <span>FINAL TOTAL:</span>\n            <span style="letter-spacing: 1px;">${n.finalPoints} PT</span>\n          </div>\n        </div>\n        \n        \x3c!-- 虚线分隔 --\x3e\n        <div style="\n          height: 1px;\n          background: repeating-linear-gradient(90deg,\n            #888 0px, #888 4px,\n            transparent 4px, transparent 8px);\n          margin: 12px 0 10px;\n        "></div>\n        \n        \x3c!-- 底部说明 --\x3e\n        <div style="\n          font-size: 9px;\n          line-height: 1.6;\n          color: #4a4a4a;\n          text-align: center;\n          margin-bottom: 10px;\n        ">${n.suffix}</div>\n        \n        \x3c!-- 笑面狐签名 --\x3e\n        <div style="\n          text-align: center;\n          font-size: 8px;\n          color: #6a6a6a;\n          letter-spacing: 0.5px;\n          padding-top: 8px;\n          border-top: 1px solid rgba(0, 0, 0, 0.1);\n        ">\n          <div style="margin-bottom: 2px;">X Platform Customer Service</div>\n          <div style="font-weight: 700; letter-spacing: 2px;">THANK YOU ^^</div>\n        </div>\n        \n      </div>\n      \n      \x3c!-- 撕边效果（底部） --\x3e\n      <div style="\n        position: absolute;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        height: 8px;\n        background: linear-gradient(135deg, \n          rgba(240, 240, 238, 0.98) 25%, transparent 25%, transparent 50%,\n          rgba(240, 240, 238, 0.98) 50%, rgba(240, 240, 238, 0.98) 75%, transparent 75%);\n        background-size: 8px 8px;\n        background-position: 0 0;\n      "></div>\n      \n      \x3c!-- 关闭按钮（3秒后出现） --\x3e\n      <div id="easterEggCloseBtn" style="\n        position: absolute;\n        top: 14px;\n        right: 8px;\n        width: 24px;\n        height: 24px;\n        border-radius: 3px;\n        background: rgba(20, 20, 20, 0.75);\n        border: 1px solid rgba(0, 0, 0, 0.3);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        opacity: 0;\n        transition: all 0.25s ease;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n      " onclick="this.parentElement.parentElement.remove()">\n        <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: rgba(240, 240, 238, 0.9); fill: none; stroke-width: 3;">\n          <line x1="6" y1="6" x2="18" y2="18"/>\n          <line x1="18" y1="6" x2="6" y2="18"/>\n        </svg>\n      </div>\n    </div>\n    \n        <style>\n      @keyframes receiptPrint {\n        0% { \n          transform: translateY(-100%) scaleY(0.1);\n          opacity: 0;\n        }\n        60% {\n          transform: translateY(0) scaleY(1);\n          opacity: 1;\n        }\n        75% {\n          transform: translateY(8px);\n        }\n        100% {\n          transform: translateY(0);\n        }\n      }\n      \n      @keyframes fadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n    </style>\n  `,setTimeout(()=>{e.onclick=n=>{n.target===e&&e.remove()};const n=e.querySelector("#easterEggCloseBtn");n&&(n.style.opacity="1",n.onmouseover=()=>{n.style.background="rgba(20, 20, 20, 0.9)",n.style.transform="scale(1.1)"},n.onmouseout=()=>{n.style.background="rgba(20, 20, 20, 0.75)",n.style.transform="scale(1)"})},3e3),document.body.appendChild(e)}function va(n){localStorage.setItem("liveMusicMuted",n.toString())}function ya(n){ra&&ka();try{ra=new Audio(n),ra.loop=!0,ra.volume=function(){const n=localStorage.getItem("liveMusicVolume");return null!==n?parseFloat(n):.3}(),ra.muted="true"===localStorage.getItem("liveMusicMuted"),ra.preload="auto",ra.addEventListener("error",n=>{console.warn("⚠️ [直播间音乐] 加载失败:",n)}),ra.addEventListener("play",()=>{sa=!0})}catch(n){console.error("❌ [直播间音乐] 初始化失败:",n),ra=null}}function wa(){if(!ra)return;const n=ra.play();void 0!==n&&n.then(()=>{}).catch(n=>{console.warn("⚠️ [直播间音乐] 自动播放被阻止:",n.message),sa=!1})}function ka(){ra&&(ra.pause(),ra.currentTime=0,ra.src="",ra=null,sa=!1)}function $a(){if(!ra)return;const n=document.getElementById("musicMuteBtn"),e=document.getElementById("musicVolumeSlider"),t=document.getElementById("musicPlayBtn");if(n){const e=ra.muted,t=ra.volume;n.innerHTML=e||0===t?'\n          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>\n          </svg>\n        ':t<.3?'\n          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n            <path d="M7 9v6h4l5 5V4l-5 5H7z"/>\n          </svg>\n        ':t<.7?'\n          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n            <path d="M7 9v6h4l5 5V4l-5 5H7zm11.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>\n          </svg>\n        ':'\n          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>\n          </svg>\n        '}if(e&&(e.value=100*ra.volume),t){const n=!ra.paused;t.style.display=n?"none":"flex"}}async function Ca(){try{Xi=!1;const t=document.getElementById("x-live-page");t&&(t.style.visibility="visible",t.style.opacity="1",t.style.pointerEvents="auto"),Fo="audio",await hr();const o=await fr();Wo("audio"),Wo("video"),gr(),await async function(){try{const n=e(),t=`liveCategories_${vt||"main"}`,o=await n.xSettings.get(t);o&&o.categories?(Xo=o.categories,vr(),console.log(`✅ [直播分类] 已加载 ${Xo.length} 个自定义分类`)):console.log("ℹ️ [直播分类] 未找到保存的自定义分类")}catch(n){console.error("❌ [直播分类] 加载失败:",n)}}(),await async function(){try{const n=e(),t=`live_custom_music_${vt||"main"}`,o=await n.xAccountProfiles.get(t);o&&o.data?"object"!=typeof o.data||Array.isArray(o.data)?Array.isArray(o.data)?(ta={},o.data.forEach((n,e)=>{const t=n.category;ta[t]||(ta[t]=[]),ta[t].push({id:n.id||`music_${Date.now()}_${e}`,name:n.name||`歌曲${e+1}`,url:n.url,addedTime:n.addedTime||Date.now()})}),await ca()):ta={}:ta=o.data:ta={}}catch(n){console.error("❌ [直播设置] 加载自定义音乐失败:",n),ta={}}}(),await mr(o),n.liveBtnExpanded=!1,setTimeout(()=>{const n=document.getElementById("live-refresh-btn"),e=document.getElementById("live-start-btn"),t=document.getElementById("live-main-btn"),o=document.getElementById("live-main-icon");n&&e&&t&&o&&(n.style.transform="scale(0)",n.style.opacity="0",e.style.transform="scale(0)",e.style.opacity="0",t.style.transform="scale(1)",o.style.transform="rotate(0deg)")},100)}catch(n){console.error("❌ [直播页面] 初始化失败:",n)}}function Ia(){Ko?"audio"===Ko.type?function(){Xi=!1;Rn[Hn]||Rn.zh;let n=document.getElementById("live-room-container");n||(n=document.createElement("div"),n.id="live-room-container",document.body.appendChild(n));Ta();const e=Ko;if(n.innerHTML='\n          <div class="live-room">\n      \x3c!-- 顶部导航 --\x3e\n      <div class="live-header">\n        <div class="header-icon" onclick="closeLiveRoom()">          <svg\n            viewBox="0 0 24 24"\n            style="width: 18px; height: 18px; fill: #fff"\n          >\n            <path\n              d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"\n            />\n              </svg>\n            </div>\n                <div class="header-title">LIVE</div>\n        \n        \x3c!-- 音乐控制区域（右侧） --\x3e\n        <div style="display: flex; align-items: center; gap: 8px;">\n          \x3c!-- 手动播放按钮（仅在自动播放被阻止时显示） --\x3e\n          <div class="header-icon" id="musicPlayBtn" onclick="manualPlayMusic()" style="display: none; background: linear-gradient(135deg, rgba(29, 155, 240, 0.2), rgba(29, 155, 240, 0.1));">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);">\n              <path d="M8 5v14l11-7z"/>\n            </svg>\n            </div>\n\n          \x3c!-- 音量控制按钮（最右侧） --\x3e\n          <div class="header-icon music-control-btn" id="musicMuteBtn" onclick="toggleMusicMute()">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>\n              </svg>\n            </div>\n          \n          \x3c!-- 音量滑块（悬停显示） --\x3e\n          <div class="music-volume-container">\n            <input \n              type="range" \n              id="musicVolumeSlider" \n              class="music-volume-slider" \n              min="0" \n              max="100" \n              value="30"\n              oninput="setMusicVolume(this.value / 100)"\n            />\n            </div>\n          </div>\n        </div>\n\n\n      \x3c!-- 主内容 --\x3e\n      <div class="live-content">\n        \x3c!-- 磁带播放器 --\x3e\n        <div class="cassette-player">\n          \x3c!-- 螺丝装饰 --\x3e\n          <div class="cassette-screws">\n            <div class="cassette-screw top-left"></div>\n            <div class="cassette-screw top-right"></div>\n          </div>\n\n          <div class="cassette-body">\n            \x3c!-- 左侧轮盘（主播头像） - 可点击进入主播主页 --\x3e\n            <div class="cassette-reel left" onclick="openStreamerProfileFromLive()" style="cursor: pointer;" title="点击查看主播主页">\n              <div class="reel-inner">\n                <img id="avatarImg" src="" alt="主播" />\n              </div>\n              <div class="reel-teeth"></div>\n            </div>\n\n            \x3c!-- 中间信息 --\x3e\n            <div class="cassette-info">\n              <div class="cassette-label">\n                <div class="cassette-title" id="liveTitle"></div>\n                <div class="cassette-artist" id="liveSubtitle"></div>\n              </div>\n\n              \x3c!-- 音波可视化 + 主播发言 --\x3e\n              <div class="audio-visualizer">\n                \x3c!-- 音波条（可点击查看发言历史） --\x3e\n                <div class="audio-bars" id="audioBars" onclick="openSpeechHistory()" title="点击查看主播发言记录">\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n                  <div class="audio-bar"></div>\n          </div>\n\n                \x3c!-- 主播发言文字（横向滚动） --\x3e\n                <div class="streamer-speech-text" id="streamerSpeech">\n                  <div class="speech-text-content" id="speechContent"></div>\n            </div>\n            </div>\n          </div>\n\n            \x3c!-- 右侧轮盘 - 默认显示/连线入口 --\x3e\n            <div class="cassette-reel right" id="rightReel">\n              <div class="reel-inner" id="rightReelInner" style="background: radial-gradient(circle, #3a3a3a, #1a1a1a)">\n              </div>\n              <div class="reel-teeth"></div>\n            </div>\n\n            \x3c!-- 🎙️ 用户连线发言气泡（独立定位，不随轮盘旋转） --\x3e\n            <div class="user-connection-speech-bubbles" id="userConnectionSpeechBubbles" style="display: none;"></div>\n          </div>\n\n          \x3c!-- 进度条 --\x3e\n          <div class="progress-section">\n            <div class="progress-time">\n              <span id="currentTime">0:00</span>\n              <span id="durationText"></span>\n              </div>\n            <div class="progress-bar">\n              <div class="progress-fill" id="progressFill"></div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 磁带观察窗 - 弹幕区 --\x3e\n        <div class="cassette-window">\n          \x3c!-- 螺丝装饰 --\x3e\n          <div class="cassette-screws">\n            <div class="cassette-screw top-left"></div>\n            <div class="cassette-screw top-right"></div>\n            <div class="cassette-screw bottom-left"></div>\n            <div class="cassette-screw bottom-right"></div>\n          </div>\n\n          <div class="window-label" onclick="openDanmakuHistory()" style="cursor: pointer;" title="点击查看弹幕历史">Live Chat</div>\n          <div class="danmaku-section" onclick="openDanmakuHistory()" style="cursor: pointer;" title="点击查看弹幕历史">\n            <div class="danmaku-list" id="danmakuList"></div>\n            </div>\n          </div>\n\n        \x3c!-- Details --\x3e\n        <div class="live-details">\n          <div class="details-header" onclick="toggleLiveDetails()">\n            <div class="details-title">\n              <svg class="details-icon" viewBox="0 0 24 24">\n                <circle cx="12" cy="12" r="10" />\n                <line x1="12" y1="16" x2="12" y2="12" />\n                <circle cx="12" cy="8" r="0.5" fill="currentColor" />\n              </svg>\n              <span>Details</span>\n              </div>\n            <svg class="expand-icon" id="detailsExpandIcon" viewBox="0 0 24 24">\n              <polyline points="6 9 12 15 18 9" />\n              </svg>\n              </div>\n          <div class="details-content" id="detailsContent">\n            <div class="detail-section">\n              <div class="detail-label">Description</div>\n              <div class="detail-text" id="detailDescription">\n                加载中...\n            </div>\n          </div>\n            <div class="detail-section">\n              <div class="detail-label">Notice</div>\n              <div class="detail-text" id="detailNotice">\n                加载中...\n              </div>\n            </div>\n            </div>\n          </div>\n\n        \x3c!-- Info --\x3e\n        <div class="live-info-card">\n          \x3c!-- 装饰螺丝 --\x3e\n          <div class="info-screw" style="top: 10px; left: 6px"></div>\n          <div class="info-screw" style="bottom: 10px; left: 6px"></div>\n\n          <div class="info-row">\n            <div class="info-label">\n              <svg\n                viewBox="0 0 24 24"\n                style="\n                  width: 14px;\n                  height: 14px;\n                  stroke: currentColor;\n                  fill: none;\n                  stroke-width: 2;\n                "\n              >\n                <rect x="3" y="3" width="7" height="7" />\n                <rect x="14" y="3" width="7" height="7" />\n                <rect x="14" y="14" width="7" height="7" />\n                <rect x="3" y="14" width="7" height="7" />\n              </svg>\n              <span>Tags</span>\n            </div>\n            <div class="info-tags" id="liveTagsContainer">\n              <div class="info-tag">加载中...</div>\n            </div>\n          </div>\n          <div class="info-row">\n            <div class="info-label">\n              <svg\n                viewBox="0 0 24 24"\n                style="\n                  width: 14px;\n                  height: 14px;\n                  stroke: currentColor;\n                  fill: none;\n                  stroke-width: 2;\n                "\n              >\n                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />\n                <circle cx="12" cy="12" r="3" />\n              </svg>\n              <span>Viewers</span>\n            </div>\n            <div class="live-badge">\n              <div class="live-dot"></div>\n              <span id="onlineText"></span>\n            </div>\n          </div>\n        </div>\n            </div>\n\n      \x3c!-- 固定底部区域 --\x3e\n      <div class="fixed-bottom-section">\n        \x3c!-- 底部互动栏 --\x3e\n        <div class="interaction-bar">\n          <div class="action-btn" onclick="sendLike()">\n            <svg\n              viewBox="0 0 24 24"\n              style="width: 20px; height: 20px; fill: #fff"\n            >\n              <path\n                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"\n              />\n            </svg>\n          </div>\n          <input\n            type="text"\n            class="input-box"\n            placeholder="Say something..."\n            id="danmaku-input"\n            onkeypress="if(event.key===\'Enter\') { sendDanmaku(this.value, this); }"\n          />\n          <div class="action-btn" onclick="handleSendButtonClick()">\n            <svg\n              viewBox="0 0 24 24"\n              style="width: 18px; height: 18px; fill: #fff"\n            >\n              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />\n              </svg>\n            </div>\n          </div>\n        </div>\n\n      \x3c!-- 点赞容器 --\x3e\n      <div class="like-container" id="like-animation-container"></div>\n      \n            \x3c!-- iOS风格液态玻璃悬浮控制面板 --\x3e\n      <div class="control-sidebar-overlay" id="controlSidebarOverlay"></div>\n      <div class="control-sidebar" id="controlSidebar">\n        <div class="sidebar-header">\n          <div class="sidebar-title">Control</div>\n          <div class="sidebar-close-btn" onclick="closeLiveSidebar()">\n            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: #fff; fill: none; stroke-width: 2.5;">\n              <line x1="18" y1="6" x2="6" y2="18"/>\n              <line x1="6" y1="6" x2="18" y2="18"/>\n            </svg>\n          </div>\n      </div>\n\n        <div class="sidebar-content">\n          \x3c!-- 榜单 --\x3e\n          <div class="sidebar-item" onclick="openLeaderboard()">\n            <div class="sidebar-item-icon">\n              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2;">\n                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>\n              </svg>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">Leaderboard</div>\n              <div class="sidebar-item-subtitle">Top fans</div>\n            </div>\n          </div>\n          \n          \x3c!-- 礼物 --\x3e\n          <div class="sidebar-item" onclick="openGifts()">\n            <div class="sidebar-item-icon">\n              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2;">\n                <rect x="3" y="8" width="18" height="4" rx="1"/>\n                <path d="M12 8v13"/>\n                <path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/>\n                <path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/>\n              </svg>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">Gifts</div>\n              <div class="sidebar-item-subtitle">Send love</div>\n            </div>\n          </div>\n          \n          \x3c!-- 粉丝团 --\x3e\n          <div class="sidebar-item" onclick="openFanClub()">\n            <div class="sidebar-item-icon">\n              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2;">\n                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>\n                <circle cx="9" cy="7" r="4"/>\n                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>\n                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>\n              </svg>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">Fan Club</div>\n              <div class="sidebar-item-subtitle">Community</div>\n            </div>\n          </div>\n          \n          \x3c!-- 我的直播间 --\x3e\n          <div class="sidebar-item" onclick="openMyLiveRoom()">\n            <div class="sidebar-item-icon">\n              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2;">\n                <rect x="2" y="7" width="20" height="15" rx="2"/>\n                <polyline points="17 2 12 7 7 2"/>\n              </svg>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">My Room</div>\n              <div class="sidebar-item-subtitle">Manage</div>\n            </div>\n          </div>\n          \n          \x3c!-- 设置 --\x3e\n          <div class="sidebar-item" onclick="openLiveSettings()">\n            <div class="sidebar-item-icon">\n              <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2;">\n                <circle cx="12" cy="12" r="3"/>\n                <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>\n              </svg>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">Settings</div>\n              <div class="sidebar-item-subtitle">Preferences</div>\n            </div>\n          </div>\n\n          \x3c!-- 🦊 狐狸游戏 --\x3e\n          <div class="sidebar-item" onclick="triggerFoxGame()">\n            <div class="sidebar-item-icon">\n              <div class="mini-cat">\n                <div class="mini-cat-head">\n                  <div class="mini-cat-ear left">\n                    <div class="mini-cat-ear-inner"></div>\n                  </div>\n                  <div class="mini-cat-ear right">\n                    <div class="mini-cat-ear-inner"></div>\n                  </div>\n                  <div class="mini-cat-eyes">\n                    <div class="mini-cat-eye"></div>\n                    <div class="mini-cat-eye"></div>\n                  </div>\n                  <div class="mini-cat-nose"></div>\n                  <div class="mini-cat-mouth"></div>\n                </div>\n              </div>\n            </div>\n            <div class="sidebar-item-content">\n              <div class="sidebar-item-title">Fox Game</div>\n              <div class="sidebar-item-subtitle">Play with Aron</div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🐱 像素猫咪探头 --\x3e\n      <div class="pixel-cat-peek" id="pixelCatPeek">\n        <div class="cat-wrapper" onclick="showFoxDialog()">\n          <div class="cat-glow"></div>\n          <div class="pixel-cat" id="peekCat">\n            <div class="cat-head">\n              <div class="cat-ear left">\n                <div class="cat-ear-inner"></div>\n              </div>\n              <div class="cat-ear right">\n                <div class="cat-ear-inner"></div>\n              </div>\n              <div class="cat-whisker left"></div>\n              <div class="cat-whisker right"></div>\n              <div class="cat-whisker left-2"></div>\n              <div class="cat-whisker right-2"></div>\n              <div class="cat-eyes">\n                <div class="cat-eye"></div>\n                <div class="cat-eye"></div>\n              </div>\n              <div class="cat-cheek left"></div>\n              <div class="cat-cheek right"></div>\n              <div class="cat-nose"></div>\n              <div class="cat-mouth"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🐱 磁带播放器对话框 --\x3e\n      <div class="rpg-dialog-container" id="foxDialogContainer">\n        <div class="rpg-dialog-box">\n          \x3c!-- 背景效果 --\x3e\n          <div class="metal-texture"></div>\n          <div class="scanlines"></div>\n\n          \x3c!-- 装饰元素 --\x3e\n          <div class="dialog-screw top-left"></div>\n          <div class="dialog-screw top-right"></div>\n          <div class="dialog-screw bottom-left"></div>\n          <div class="dialog-screw bottom-right"></div>\n\n          <div class="cassette-gear left"></div>\n          <div class="cassette-gear right"></div>\n\n          <div class="led-indicator"></div>\n\n          \x3c!-- 头部 --\x3e\n          <div class="dialog-header">\n            <div class="dialog-avatar">\n              <div class="pixel-cat" id="dialogCat">\n                <div class="cat-head">\n                  <div class="cat-ear left">\n                    <div class="cat-ear-inner"></div>\n                  </div>\n                  <div class="cat-ear right">\n                    <div class="cat-ear-inner"></div>\n                  </div>\n                  <div class="cat-eyes">\n                    <div class="cat-eye"></div>\n                    <div class="cat-eye"></div>\n                  </div>\n                  <div class="cat-nose"></div>\n                  <div class="cat-mouth"></div>\n                </div>\n              </div>\n            </div>\n            <div class="dialog-title">\n              <div class="dialog-name">Aron</div>\n              <div class="dialog-subtitle">Pixel Cat Friend</div>\n            </div>\n          </div>\n\n          \x3c!-- 文本 --\x3e\n          <div class="dialog-text" id="foxDialogText"></div>\n\n          \x3c!-- 按钮 --\x3e\n          <div class="dialog-buttons" id="foxDialogButtons" style="display: none;">\n            <button class="dialog-btn primary" onclick="handleFoxChoice(\'yes\')">▸ YES</button>\n            <button class="dialog-btn" onclick="handleFoxChoice(\'no\')">▸ NO</button>\n            <button class="dialog-btn" onclick="handleFoxChoice(\'contact\')">▸ CONTACT</button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 语音连线悬浮屏 - 申请连线 --\x3e\n      <div class="connection-dialog-overlay" id="connectionDialogOverlay"></div>\n      <div class="connection-dialog" id="connectionDialog">\n\n        \x3c!-- 磁带风格连线界面 --\x3e\n        <div class="connection-cassette-container">\n          \x3c!-- 顶部标题区 --\x3e\n          <div class="connection-header">\n            <div class="connection-title">\n              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor; margin-right: 8px;">\n                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>\n                <circle cx="9" cy="10" r="1.5"/>\n                <circle cx="15" cy="10" r="1.5"/>\n              </svg>\n              <span>VOICE CONNECTION</span>\n            </div>\n            <div class="connection-close-btn" onclick="closeConnectionDialog()">\n              <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </div>\n          </div>\n\n          \x3c!-- 装饰螺丝 --\x3e\n          <div class="connection-screws">\n            <div class="connection-screw top-left"></div>\n            <div class="connection-screw top-right"></div>\n            <div class="connection-screw bottom-left"></div>\n            <div class="connection-screw bottom-right"></div>\n          </div>\n\n          \x3c!-- 连线信息主体 --\x3e\n          <div class="connection-body">\n            \x3c!-- LCD显示屏风格 - 等待队列 --\x3e\n            <div class="connection-lcd-display">\n              <div class="lcd-screen-border">\n                <div class="lcd-screen-content">\n                  <div class="lcd-label">WAITING QUEUE</div>\n                  <div class="lcd-value" id="connectionWaitingCount">0 / 0</div>\n                  <div class="lcd-status" id="connectionAvgWait">-</div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 磁带标签风格 - 连线门槛 --\x3e\n            <div class="connection-threshold-panel">\n              <div class="threshold-label-strip">\n                <div class="strip-text">CONNECTION REQUIREMENTS</div>\n              </div>\n              <div class="threshold-content" id="connectionThreshold">\n                <div class="threshold-icon">\n                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>\n                  </svg>\n                </div>\n                <div class="threshold-text">加载中...</div>\n              </div>\n            </div>\n\n            \x3c!-- 音轨线条装饰 --\x3e\n            <div class="connection-tape-lines">\n              <div class="tape-line"></div>\n              <div class="tape-line"></div>\n              <div class="tape-line"></div>\n            </div>\n\n            \x3c!-- 连线按钮 - 复古按键风格 --\x3e\n            <div class="connection-buttons">\n              <button class="connection-btn confirm-btn" id="connectionConfirmBtn" onclick="confirmConnection()">\n                <div class="btn-led"></div>\n                <span class="btn-text">REQUEST CONNECTION</span>\n                <div class="btn-shadow"></div>\n              </button>\n            </div>\n\n            \x3c!-- 状态提示 - 小标签纸风格 --\x3e\n            <div class="connection-status-tag" id="connectionStatusTag">\n              <div class="tag-corner"></div>\n              <div class="tag-text">点击申请与主播连线</div>\n            </div>\n          </div>\n\n          \x3c!-- 底部装饰条 --\x3e\n          <div class="connection-footer-strip"></div>\n        </div>\n      </div>\n\n      \x3c!-- 🎛️ 连线管理悬浮屏 - 磁带录音机风格 --\x3e\n      <div class="connection-dialog-overlay" id="managementDialogOverlay"></div>\n      <div class="connection-dialog" id="managementDialog">\n        \x3c!-- 磁带录音机风格管理界面 --\x3e\n        <div class="connection-cassette-container">\n          \x3c!-- 顶部标题区 --\x3e\n          <div class="connection-header">\n            <div class="connection-title">\n              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor; margin-right: 8px;">\n                <path d="M12 1v22M1 12h22M12 1L7 6M12 1l5 5M12 23l-5-5M12 23l5-5"/>\n                <circle cx="12" cy="12" r="3"/>\n              </svg>\n              <span>CONNECTION MANAGEMENT</span>\n            </div>\n            <div class="connection-close-btn" onclick="closeConnectionManagementDialog()">\n              <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </div>\n          </div>\n\n          \x3c!-- 装饰螺丝 --\x3e\n          <div class="connection-screws">\n            <div class="connection-screw top-left"></div>\n            <div class="connection-screw top-right"></div>\n            <div class="connection-screw bottom-left"></div>\n            <div class="connection-screw bottom-right"></div>\n          </div>\n\n          \x3c!-- 管理信息主体 --\x3e\n          <div class="connection-body">\n            \x3c!-- LCD显示屏风格 - 连线时长 --\x3e\n            <div class="connection-lcd-display">\n              <div class="lcd-screen-border">\n                <div class="lcd-screen-content">\n                  <div class="lcd-label">CONNECTION DURATION</div>\n                  <div class="lcd-value" id="connectionDurationDisplay">00:00</div>\n                  <div class="lcd-status">LIVE ON AIR</div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 磁带标签风格 - 连线状态 --\x3e\n            <div class="connection-threshold-panel">\n              <div class="threshold-label-strip">\n                <div class="strip-text">CURRENT STATUS</div>\n              </div>\n              <div class="threshold-content">\n                <div class="threshold-icon">\n                  <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n                    <circle cx="12" cy="12" r="10"/>\n                    <path d="M9 12l2 2 4-4"/>\n                  </svg>\n                </div>\n                <div class="threshold-text">语音连线进行中</div>\n              </div>\n            </div>\n\n            \x3c!-- 音轨线条装饰 --\x3e\n            <div class="connection-tape-lines">\n              <div class="tape-line"></div>\n              <div class="tape-line"></div>\n              <div class="tape-line"></div>\n            </div>\n\n            \x3c!-- 控制按钮 - 复古按键风格 --\x3e\n            <div class="connection-buttons">\n              \x3c!-- 开启互动 (暂时禁用) --\x3e\n              <button class="connection-btn" id="interactionBtn" disabled style="opacity: 0.4; cursor: not-allowed;">\n                <div class="btn-led" style="background: rgba(120, 120, 120, 0.5);"></div>\n                <span class="btn-text">INTERACTION MODE</span>\n                <div class="btn-shadow"></div>\n              </button>\n\n              \x3c!-- 开启PK --\x3e\n              <button class="connection-btn pk-btn" id="pkBtn" onclick="openPKConfigDialog()">\n                <div class="btn-led" style="background: rgba(255, 140, 60, 0.9); box-shadow: 0 0 8px rgba(255, 160, 80, 0.6);"></div>\n                <span class="btn-text">PK CHALLENGE</span>\n                <div class="btn-shadow"></div>\n              </button>\n\n              \x3c!-- 结束连线 (可点击) --\x3e\n              <button class="connection-btn disconnect-btn" id="disconnectBtn" onclick="endConnection()">\n                <div class="btn-led" style="background: rgba(200, 60, 60, 0.9); box-shadow: 0 0 8px rgba(220, 70, 70, 0.6);"></div>\n                <span class="btn-text">END CONNECTION</span>\n                <div class="btn-shadow"></div>\n              </button>\n            </div>\n\n            \x3c!-- 状态提示 - 小标签纸风格 --\x3e\n            <div class="connection-status-tag">\n              <div class="tag-corner"></div>\n              <div class="tag-text">点击结束连线按钮断开连接</div>\n            </div>\n          </div>\n\n          \x3c!-- 底部装饰条 --\x3e\n          <div class="connection-footer-strip"></div>\n        </div>\n      </div>\n\n      \x3c!-- 🎮 PK配置弹窗 - 街机投币机风格 --\x3e\n      <div class="connection-dialog-overlay" id="pkConfigDialogOverlay"></div>\n      <div class="connection-dialog" id="pkConfigDialog">\n        \x3c!-- 街机机箱风格容器 --\x3e\n        <div class="connection-cassette-container pk-arcade-container">\n          \x3c!-- 顶部标题区 - 像素字体 --\x3e\n          <div class="connection-header pk-arcade-header">\n            <div class="connection-title">\n              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor; margin-right: 8px;">\n                <path d="M12 2L2 7v10c0 5.5 4 10 10 11 6-1 10-5.5 10-11V7l-10-5z"/>\n                <path d="M9 12l2 2 4-4" stroke="currentColor" fill="none" stroke-width="2"/>\n              </svg>\n              <span>PK CHALLENGE SETUP</span>\n            </div>\n            <div class="connection-close-btn" onclick="closePKConfigDialog()">\n              <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </div>\n          </div>\n\n          \x3c!-- 装饰螺丝 --\x3e\n          <div class="connection-screws">\n            <div class="connection-screw top-left"></div>\n            <div class="connection-screw top-right"></div>\n            <div class="connection-screw bottom-left"></div>\n            <div class="connection-screw bottom-right"></div>\n          </div>\n\n          \x3c!-- PK配置主体 --\x3e\n          <div class="connection-body pk-config-body">\n            \x3c!-- PK配置表单 - 控制面板风格 --\x3e\n            <div class="pk-config-panel">\n              \x3c!-- PK时限 --\x3e\n              <div class="pk-config-field">\n                <div class="pk-field-label">\n                  <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor; margin-right: 6px;">\n                    <circle cx="12" cy="12" r="10"/>\n                    <path d="M12 6v6l4 2"/>\n                  </svg>\n                  <span>PK TIME LIMIT</span>\n                </div>\n                <div class="pk-field-input-group">\n                  <input type="number" id="pkTimeLimitInput" class="pk-input" placeholder="5" min="1" max="30" value="5">\n                  <div class="pk-input-unit">MIN</div>\n                </div>\n              </div>\n\n              \x3c!-- 主播惩罚 --\x3e\n              <div class="pk-config-field">\n                <div class="pk-field-label">\n                  <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor; margin-right: 6px;">\n                    <path d="M12 2L2 7v10c0 5.5 4 10 10 11 6-1 10-5.5 10-11V7l-10-5z"/>\n                  </svg>\n                  <span>STREAMER PENALTY</span>\n                </div>\n                <input type="text" id="pkStreamerPenaltyInput" class="pk-input" placeholder="e.g. sing a song">\n              </div>\n\n              \x3c!-- 用户惩罚 --\x3e\n              <div class="pk-config-field">\n                <div class="pk-field-label">\n                  <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor; margin-right: 6px;">\n                    <circle cx="12" cy="12" r="3"/>\n                    <path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/>\n                  </svg>\n                  <span>YOUR PENALTY</span>\n                </div>\n                <input type="text" id="pkUserPenaltyInput" class="pk-input" placeholder="e.g. send 10 gifts">\n              </div>\n\n              \x3c!-- 宣战发言 --\x3e\n              <div class="pk-config-field">\n                <div class="pk-field-label">\n                  <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor; margin-right: 6px;">\n                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n                  </svg>\n                  <span>CHALLENGE MESSAGE</span>\n                </div>\n                <textarea id="pkChallengeMessageInput" class="pk-textarea" placeholder="Say something to the streamer..." rows="3"></textarea>\n              </div>\n\n              \x3c!-- 商店价格标签 - 手写风格 --\x3e\n              <div class="pk-price-tag-container">\n                <div class="price-tag">\n                  \x3c!-- 穿孔撕边 --\x3e\n                  <div class="tag-perforation"></div>\n\n                  \x3c!-- 标签内容 --\x3e\n                  <div class="tag-content">\n                    <div class="tag-stamp">特价</div>\n                    <div class="tag-item-name">PK挑战服务</div>\n                    <div class="tag-crossed-price">原价: 999积分</div>\n                    <div class="tag-price-row">\n                      <span class="tag-price-label">今日价:</span>\n                      <span class="tag-price-value" id="pkCostDisplay">??? 积分</span>\n                    </div>\n                    <div class="tag-vendor-note" id="pkVendorMessage">正在计算...</div>\n                    <div class="tag-signature">\n                      <span>--- ARON </span>\n                      <span class="signature-emoji">^^</span>\n                    </div>\n                  </div>\n\n                  \x3c!-- 钉子装饰 --\x3e\n                  <div class="tag-pin"></div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 确认按钮 --\x3e\n            <div class="connection-buttons">\n              <button class="connection-btn pk-confirm-btn" id="pkConfirmBtn" onclick="confirmPKChallenge()">\n                <div class="btn-led" style="background: rgba(255, 140, 60, 0.9); box-shadow: 0 0 8px rgba(255, 160, 80, 0.6);"></div>\n                <span class="btn-text">CONFIRM CHALLENGE</span>\n                <div class="btn-shadow"></div>\n              </button>\n            </div>\n\n            \x3c!-- 状态提示 --\x3e\n            <div class="connection-status-tag">\n              <div class="tag-corner"></div>\n              <div class="tag-text">Fill in details and start PK challenge</div>\n            </div>\n          </div>\n\n          \x3c!-- 底部装饰条 --\x3e\n          <div class="connection-footer-strip"></div>\n        </div>\n      </div>\n\n      \x3c!-- 🎯 PK准备中弹窗 - 16bit RPG战斗准备界面风格 --\x3e\n      <div class="pk-preparing-modal" id="pkPreparingModal">\n        \x3c!-- CRT电视外壳 --\x3e\n        <div class="pk-crt-tv">\n          \x3c!-- 四角像素螺栓 --\x3e\n          <div class="pk-crt-bolts">\n            <div class="pk-bolt top-left"></div>\n            <div class="pk-bolt top-right"></div>\n            <div class="pk-bolt bottom-left"></div>\n            <div class="pk-bolt bottom-right"></div>\n          </div>\n\n          \x3c!-- CRT屏幕（带扫描线和噪点） --\x3e\n          <div class="pk-crt-screen">\n            \x3c!-- 菱形网格背景 --\x3e\n            <div class="pk-background-grid"></div>\n\n            \x3c!-- 像素噪点层 --\x3e\n            <div class="pk-pixel-noise"></div>\n\n            \x3c!-- 战斗区域 --\x3e\n            <div class="pk-battle-arena">\n              \x3c!-- 战士A - 主播（红方） --\x3e\n              <div class="pk-fighter-card fighter-red">\n                <div class="pk-fighter-frame">\n                  <div class="pk-fighter-avatar">\n                    <img id="pkStreamerAvatar" src="" alt="Fighter A">\n                  </div>\n                  <div class="pk-fighter-name">STREAMER</div>\n                </div>\n              </div>\n\n              \x3c!-- 中央闪电分隔 --\x3e\n              <div class="pk-battle-divider">\n                <svg class="pk-lightning" width="24" height="48" viewBox="0 0 24 48">\n                  <path d="M12 0 L8 20 L16 20 L12 48 L20 24 L14 24 Z" fill="currentColor"/>\n                </svg>\n                <div class="pk-battle-arrows">\n                  <div class="pk-arrow left">◀</div>\n                  <div class="pk-arrow right">▶</div>\n                </div>\n              </div>\n\n              \x3c!-- 战士B - 用户（蓝方） --\x3e\n              <div class="pk-fighter-card fighter-blue">\n                <div class="pk-fighter-frame">\n                  <div class="pk-fighter-avatar">\n                    <img id="pkUserAvatar" src="" alt="Fighter B">\n                  </div>\n                  <div class="pk-fighter-name">YOU</div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 状态文本（打字机效果） --\x3e\n            <div class="pk-status-text">\n              <div class="pk-status-typing">BATTLE PREPARING...</div>\n              <div class="pk-status-cursor">█</div>\n            </div>\n\n            \x3c!-- 能量条（像素方块填充） --\x3e\n            <div class="pk-energy-bar-container">\n              <div class="pk-energy-track">\n                <div class="pk-energy-pixels" id="pkProgressFill">\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                  <div class="pk-energy-pixel"></div>\n                </div>\n              </div>\n              <div class="pk-energy-percentage" id="pkProgressText">0%</div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 被踢出弹窗 - 磁带盒风格 --\x3e\n      <div class="kicked-modal-overlay" id="kickedModalOverlay"></div>\n      <div class="kicked-modal" id="kickedModal">\n        \x3c!-- 磁带盒容器 --\x3e\n        <div class="kicked-cassette-container">\n          \x3c!-- 装饰螺丝 --\x3e\n          <div class="kicked-screws">\n            <div class="kicked-screw top-left"></div>\n            <div class="kicked-screw top-right"></div>\n            <div class="kicked-screw bottom-left"></div>\n            <div class="kicked-screw bottom-right"></div>\n          </div>\n\n          \x3c!-- 顶部装饰条 --\x3e\n          <div class="kicked-header-strip"></div>\n\n          \x3c!-- 警告LED指示灯 --\x3e\n          <div class="kicked-led-panel">\n            <div class="kicked-led warning"></div>\n            <div class="kicked-led warning"></div>\n            <div class="kicked-led warning"></div>\n          </div>\n\n          \x3c!-- LCD显示屏 --\x3e\n          <div class="kicked-lcd-display">\n            <div class="lcd-border">\n              <div class="lcd-content">\n                <div class="lcd-title">CONNECTION TERMINATED</div>\n                <div class="lcd-divider"></div>\n                <div class="lcd-message">您已被主播移出连线</div>\n                <div class="lcd-code">ERROR CODE: KICKED</div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 底部装饰条 --\x3e\n          <div class="kicked-footer-strip"></div>\n        </div>\n      </div>\n\n    </div>\n    ',document.getElementById("avatarImg").src=e.streamerAvatar,document.getElementById("liveTitle").textContent=e.title,document.getElementById("liveSubtitle").textContent=`${e.streamerName} ${e.streamerHandle}`,document.getElementById("durationText").textContent=e.duration,document.getElementById("onlineText").textContent=e.onlineCount,e.details){const n=e.details,t=document.getElementById("detailDescription"),o=document.getElementById("detailNotice");t&&(t.textContent=n.details||n.description||"暂无详细描述"),o&&(o.textContent=n.notice||"欢迎来到直播间！");const a=document.getElementById("liveTagsContainer");if(a&&n.tags&&n.tags.length>0&&(a.innerHTML=n.tags.map(n=>`<div class="info-tag">${n}</div>`).join("")),n.viewers){const e=document.getElementById("onlineText");e&&(e.textContent=n.viewers)}}(function(){const n=document.getElementById("danmakuList");if(!n)return;const e=Ko?.details;if(!e||!e.danmaku||0===e.danmaku.length)return void console.warn("⚠️ [弹幕] 没有弹幕数据");const t=e.latestGenerationId,o=e.danmaku.filter(n=>n.generationId===t&&!0!==n.isUser);if(0===o.length)return void console.warn(`⚠️ [弹幕] 没有批次ID为 ${t} 的弹幕`);let a=0;Qo=setInterval(()=>{if(a>=o.length)return clearInterval(Qo),void(Qo=null);const e=o[a];ar(e.content,a);const t="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",i=document.createElement("div");if(i.style.cssText="\n        display: flex; \n        gap: 12px; \n        align-items: flex-start; \n        padding: 8px 0; \n        animation: fadeInUp 0.4s ease-out;\n        position: relative;\n      ",i.innerHTML=`\n        <img src="${t}" style="width: 34px; height: 34px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.15); flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2); filter: brightness(0.95) contrast(1.05); background: #000;" alt="${e.userName}">\n        <div style="flex: 1; min-width: 0; padding-top: 2px;">\n          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); font-weight: 800; margin-bottom: 4px; letter-spacing: 0.8px; text-transform: uppercase; font-family: 'Courier New', monospace;">${e.userName}</div>\n          <div style="font-size: 12px; color: rgba(255, 255, 255, 0.85); line-height: 1.6; word-break: break-word; letter-spacing: 0.3px; font-family: 'Courier New', monospace;">${e.content}</div>\n        </div>\n        <div style="position: absolute; bottom: 0; left: 48px; right: 0; height: 1px; background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), transparent);"></div>\n      `,n.appendChild(i),n.children.length>5){const e=n.firstChild;e.style.transition="all 0.3s ease-out",e.style.opacity="0",e.style.transform="translateX(-20px)",setTimeout(()=>{n.removeChild(e)},300)}const r=document.getElementById("danmaku-container");r&&(r.scrollTop=r.scrollHeight),a++},3e3)})(),function(){const n=Ko?.details;if(!n||!n.streamerMessages||0===n.streamerMessages.length)return void console.warn("⚠️ [主播发言] 没有主播发言数据");const e=n.latestGenerationId,t=n.streamerMessages.filter(n=>n.generationId===e);if(0===t.length)return void console.warn(`⚠️ [主播发言] 没有批次ID为 ${e} 的发言`);let o=0;function a(){if(o>=t.length)return void(Zo=null);const n=t[o],e=o===t.length-1;return ar(n.content,o),n.musicAction&&sr(n.musicAction),!0===n.shouldKickUser&&Ra.isConnected?(console.log("🚨 [连线系统] 主播决定踢出用户"),o++,qi(n.content,()=>{Zo=setTimeout(()=>{a()},2e3)}),void setTimeout(()=>{Qa("kicked")},1500)):!0!==n.shouldEnableConnection||Ko?.details?.connectionSettings&&!1!==Ko.details.connectionSettings.enabled?(o++,void qi(n.content,()=>{Zo=e&&!0===n.shouldEndLive?setTimeout(()=>{za()},3e3):setTimeout(()=>{a()},2e3)})):(console.log("🎙️ [连线系统] 主播决定开启连线功能"),o++,qi(n.content,()=>{Zo=setTimeout(()=>{a()},2e3)}),void setTimeout(()=>{Ua()},1500))}setTimeout(()=>{a()},1e3)}(),e.details&&e.details.superChats&&e.details.superChats.length>0&&setTimeout(()=>{or(e.details.superChats)},2e3);!function(){const n=5e3;Yi=0,Gi=setInterval(()=>{Yi++,Yi>n&&(Yi=0);const e=Yi/n*100,t=document.getElementById("progressFill");t&&(t.style.width=e+"%");const o=Math.floor(Yi/3600),a=Math.floor(Yi%3600/60),i=Yi%60,r=o>0?`${o}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${a}:${i.toString().padStart(2,"0")}`,s=document.getElementById("currentTime");s&&(s.textContent=r)},1e3)}();const t=e.details?.musicMood||e.category;ya(la(t)),wa(),setTimeout(()=>{$a()},100),function(){const n=document.querySelector(".live-room");if(!n)return;let e=0,t=0;const o=300,a=["button","input","textarea","a",".action-btn",".danmaku-input",".send-btn",".live-action-btn",".music-control-btn",".settings-btn",".header-icon",".sidebar-item",".sidebar-close-btn","#danmakuList",".streamer-message-carousel","#superchat-display",".speech-history-overlay",".danmaku-history-overlay","#controlSidebar","#leaderboardPanel",".like-container",".cassette-player",".cassette-window",".audio-bars",".live-info-card",".live-details",".gift-menu-panel",".gift-card",".connection-dialog","#rightReel"],i=n=>{for(const e of a)if(n.matches(e)||n.closest(e))return!0;return!1},r=n=>{if(i(n.target))return;const a=Date.now(),r=a-e;r<o&&r>0?(t++,na.isOpen||Pa(),e=0,t=0):(e=a,t=1)},s=n=>{i(n.target)||na.isOpen||Pa()};n.addEventListener("touchend",r,{passive:!0}),n.addEventListener("dblclick",s);const l=document.getElementById("controlSidebarOverlay");l&&l.addEventListener("click",Da)}(),Oa(),setTimeout(()=>{const n=document.createElement("div");n.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.85);\n      color: rgba(255, 255, 255, 0.9);\n      padding: 12px 24px;\n      border-radius: 20px;\n      font-size: 13px;\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n      z-index: 10000;\n      pointer-events: none;\n      opacity: 0;\n      transition: opacity 0.4s ease;\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n    ",n.textContent="💡 双击页面空白处打开工具栏",document.body.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1"}),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},400)},5e3)},3e3)}():(mn("视频直播间功能开发中...","info"),Ko=null):console.error("❌ [直播间] 无直播间数据")}n.testEasterEgg=function(n="random",e=100,t=10){let o;o="random"===n?Math.random()<.5:"bad"===n||0===n||"good"!==n&&1!==n&&Math.random()<.5,console.log(`🎭 [测试] 手动触发${o?"负面":"正面"}彩蛋 (原始积分: ${t}, 金额: $${e})`);let a,i=t;if(o){const[n,e]=pa.badEggDeductionRange,o=n+Math.random()*(e-n),r=Math.floor(t*o);i=t-r;const s=ga.bad[Math.floor(Math.random()*ga.bad.length)];a={type:"bad",title:s.title,reason:s.reason,detail:s.detail,suffix:s.suffix,originalPoints:t,finalPoints:i,difference:-r},console.log(`😈 [彩蛋-负面] 扣除 ${r} 积分 (${(100*o).toFixed(0)}%)`)}else{const[n,e]=pa.goodEggBonusRange,o=n+Math.random()*(e-n),r=Math.floor(t*o);i=t+r;const s=ga.good[Math.floor(Math.random()*ga.good.length)],l=Math.floor(9999*Math.random())+1,c=["成立3","成立5","成立7","上市2","破产重组1"],d=c[Math.floor(Math.random()*c.length)];a={type:"good",title:s.title,reason:s.reason.replace("{rank}",l).replace("{event}",d),detail:s.detail,suffix:s.suffix,originalPoints:t,finalPoints:i,difference:r},console.log(`🎁 [彩蛋-正面] 赠送 ${r} 积分 (${(100*o).toFixed(0)}%)`)}return ba(a),{finalPoints:i,message:a}},n.showEasterEggConfig=function(){console.log("🎭 [彩蛋配置]",pa),console.log("📋 [充值历史]",ma())},n.resetEasterEggCooldown=function(){const n=ma();n.lastEasterEgg=0,xa(n),console.log("🎭 [测试] 彩蛋冷却时间已重置")},n.clearRechargeHistory=function(){localStorage.removeItem("liveRechargeHistory"),console.log("🎭 [测试] 充值历史已清空")},n.showGiftData=function(){if(!Ko||!Ko.details)return console.log("❌ [礼物数据] 当前未在直播间中"),null;const n=Ko.details;return console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("💝 [礼物数据] 当前直播间:",Ko.streamerName),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),n.giftLeaderboard?(console.log("🏆 [榜单数据]"),console.log("  总积分:",n.giftLeaderboard.userTotalPoints),console.log("  当前排名:",n.giftLeaderboard.userRank||"未上榜"),console.log("  最后更新:",new Date(n.giftLeaderboard.lastUpdate).toLocaleString()),console.log("  榜单变化:",n.giftLeaderboard.changes||"无")):console.log("🏆 [榜单数据] 暂无数据（还未送过礼物）"),n.userGifts&&n.userGifts.length>0?(console.log(`\n💐 [礼物记录] 共${n.userGifts.length}个礼物:`),n.userGifts.forEach((n,e)=>{console.log(`  ${e+1}. ${n.giftName} - ${n.giftPrice}积分 (${new Date(n.timestamp).toLocaleString()})`)})):console.log("\n💐 [礼物记录] 暂无记录"),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),{leaderboard:n.giftLeaderboard,gifts:n.userGifts,streamer:Ko.streamerName,streamId:Ko.id}},n.manualPlayMusic=function(){if(!ra)return;wa();const n=document.getElementById("musicPlayBtn");n&&(n.style.display="none")};let Sa=null,Ma=null;function Ta(){Sa||(Ma||(Ma=document.createElement("link"),Ma.rel="stylesheet",Ma.href="https://fontsapi.zeoseven.com/785/main/result.css",Ma.id="live-room-font",document.head.appendChild(Ma)),Sa=document.createElement("style"),Sa.id="live-room-styles",Sa.textContent='\n      /* 直播间容器 */\n      #live-room-container {\n        position: fixed;\n        inset: 0;\n        z-index: 9999;\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 50%, #0a0a0a 100%);\n        color: #fff;\n        overflow: hidden;\n      }\n\n      #live-room-container::before {\n        content: "";\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: radial-gradient(circle at 50% 20%, rgba(255, 255, 255, 0.03), transparent 60%);\n        pointer-events: none;\n      }\n\n      * {\n        margin: 0;\n        padding: 0;\n        box-sizing: border-box;\n      }\n\n      body {\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,\n          "Helvetica Neue", Arial, sans-serif;\n        background: linear-gradient(\n          135deg,\n          #1a1a1a 0%,\n          #0f0f0f 50%,\n          #0a0a0a 100%\n        );\n        color: #fff;\n        overflow: hidden;\n        height: 100vh;\n        position: relative;\n      }\n\n      body::before {\n        content: "";\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: radial-gradient(\n          circle at 50% 20%,\n          rgba(255, 255, 255, 0.03),\n          transparent 60%\n        );\n        pointer-events: none;\n      }\n\n      /* 主容器 */\n      .live-room {\n        position: fixed;\n        inset: 0;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      }\n\n      /* 顶部导航 */\n      .live-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 50px 20px 20px;\n        background: linear-gradient(\n          180deg,\n          rgba(0, 0, 0, 0.9) 0%,\n          rgba(0, 0, 0, 0.5) 70%,\n          transparent 100%\n        );\n        position: relative;\n        z-index: 100;\n      }\n\n      /* 确保左右两侧元素不遮挡中间标题 */\n      .live-header > *:first-child,\n      .live-header > *:last-child {\n        z-index: 2;\n      }\n\n      .header-icon {\n        width: 40px;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.12),\n          rgba(255, 255, 255, 0.06)\n        );\n        backdrop-filter: blur(20px);\n        border-radius: 50%;\n        cursor: pointer;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),\n          inset 0 1px 0 rgba(255, 255, 255, 0.1);\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .header-icon:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.15),\n          rgba(255, 255, 255, 0.08)\n        );\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: translateY(-1px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n      }\n\n      .header-icon:active {\n        transform: scale(0.95);\n      }\n\n      /* 音乐控制按钮 */\n      .music-control-btn {\n        position: relative;\n      }\n\n      /* 音量滑块容器 */\n      .music-volume-container {\n        position: absolute;\n        right: 50px;\n        top: 50%;\n        transform: translateY(-50%);\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease, transform 0.3s ease;\n      }\n\n      .music-control-btn:hover + .music-volume-container,\n      .music-volume-container:hover {\n        opacity: 1;\n        pointer-events: all;\n        transform: translateY(-50%) translateX(-10px);\n      }\n\n      /* 音量滑块样式 - 磁带播放器风格 */\n      .music-volume-slider {\n        width: 100px;\n        height: 6px;\n        -webkit-appearance: none;\n        appearance: none;\n        background: linear-gradient(\n          90deg,\n          rgba(255, 255, 255, 0.2),\n          rgba(255, 255, 255, 0.1)\n        );\n        border-radius: 3px;\n        outline: none;\n        cursor: pointer;\n        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5),\n          0 1px 0 rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n      }\n\n      .music-volume-slider::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        appearance: none;\n        width: 14px;\n        height: 14px;\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(255, 255, 255, 0.95),\n          rgba(255, 255, 255, 0.8)\n        );\n        border-radius: 50%;\n        cursor: pointer;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4),\n          inset 0 1px 1px rgba(255, 255, 255, 0.4);\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        transition: all 0.2s ease;\n      }\n\n      .music-volume-slider::-webkit-slider-thumb:hover {\n        transform: scale(1.1);\n        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5),\n          inset 0 1px 1px rgba(255, 255, 255, 0.5);\n      }\n\n      .music-volume-slider::-webkit-slider-thumb:active {\n        transform: scale(0.95);\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4),\n          inset 0 2px 4px rgba(0, 0, 0, 0.3);\n      }\n\n      .music-volume-slider::-moz-range-thumb {\n        width: 14px;\n        height: 14px;\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(255, 255, 255, 0.95),\n          rgba(255, 255, 255, 0.8)\n        );\n        border-radius: 50%;\n        cursor: pointer;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4),\n          inset 0 1px 1px rgba(255, 255, 255, 0.4);\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        transition: all 0.2s ease;\n      }\n\n      .music-volume-slider::-moz-range-thumb:hover {\n        transform: scale(1.1);\n      }\n\n      .music-volume-slider::-moz-range-thumb:active {\n        transform: scale(0.95);\n      }\n\n      .header-title {\n        position: absolute;\n        left: 50%;\n        transform: translateX(-50%);\n        font-size: 14px;\n        font-weight: 800;\n        letter-spacing: 3px;\n        color: rgba(255, 255, 255, 0.9);\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);\n        z-index: 1;\n        pointer-events: none;\n      }\n\n      /* 主内容滚动区 */\n      .live-content {\n        flex: 1;\n        overflow-y: auto;\n        padding: 0 20px 0;\n        display: flex;\n        flex-direction: column;\n      }\n\n      /* 磁带播放器区域 */\n      .cassette-player {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.1),\n          rgba(255, 255, 255, 0.04)\n        );\n        backdrop-filter: blur(40px) saturate(150%);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-bottom: none;\n        border-radius: 24px 24px 0 0;\n        padding: 36px 28px 28px;\n        margin-bottom: 0;\n        position: relative;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),\n          0 1px 2px rgba(255, 255, 255, 0.1),\n          inset 0 1px 0 rgba(255, 255, 255, 0.15);\n        z-index: 2;\n        animation: playerSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      /* 播放器滑入动画 */\n      @keyframes playerSlideIn {\n        0% {\n          opacity: 0;\n          transform: translateY(-20px) scale(0.95);\n          filter: blur(5px);\n        }\n        60% {\n          transform: translateY(2px) scale(1.01);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n          filter: blur(0);\n        }\n      }\n\n      /* 顶部高光装饰 */\n      .cassette-player::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 2px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255, 255, 255, 0.4) 50%,\n          transparent\n        );\n      }\n\n      /* 磁带主体 */\n      .cassette-body {\n        position: relative; /* 为气泡定位提供参考 */\n        display: flex;\n        align-items: center;\n        gap: 18px;\n        margin-bottom: 0;\n        animation: cassetteVibrate 4s ease-in-out infinite;\n      }\n\n      /* 磁带轮盘 */\n      .cassette-reel {\n        width: 70px;\n        height: 70px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 30% 30%,\n          #3a3a3a 0%,\n          #2a2a2a 30%,\n          #1a1a1a 70%,\n          #0a0a0a 100%\n        );\n        border: 3px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        position: relative;\n        animation: rotate 3s linear infinite;\n        flex-shrink: 0;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5),\n          inset 0 2px 4px rgba(255, 255, 255, 0.1),\n          inset 0 -2px 4px rgba(0, 0, 0, 0.3);\n      }\n\n      .cassette-reel.left {\n        animation-play-state: running;\n      }\n\n      .cassette-reel.left::after {\n        content: "";\n        position: absolute;\n        inset: -8px;\n        background: radial-gradient(\n          circle,\n          rgba(255, 255, 255, 0.05),\n          transparent 70%\n        );\n        border-radius: 50%;\n        opacity: 0.5;\n        animation: pulse 2s ease-in-out infinite;\n      }\n\n      /* 轮盘光晕脉动 - 更柔和 */\n      @keyframes pulse {\n        0% {\n          opacity: 0.2;\n          transform: scale(0.98);\n        }\n        30% {\n          opacity: 0.4;\n          transform: scale(1.03);\n        }\n        60% {\n          opacity: 0.5;\n          transform: scale(1.06);\n        }\n        100% {\n          opacity: 0.2;\n          transform: scale(0.98);\n        }\n      }\n\n      .cassette-reel.right {\n        animation-direction: reverse;\n      }\n\n      /* 磁带轮盘旋转动画 - 机械感 */\n      @keyframes rotate {\n        0% {\n          transform: rotate(0deg);\n        }\n        100% {\n          transform: rotate(360deg);\n        }\n      }\n\n      /* 磁带播放微晃动效果 */\n      @keyframes cassetteVibrate {\n        0%,\n        100% {\n          transform: translateY(0) translateX(0);\n        }\n        25% {\n          transform: translateY(0.3px) translateX(0.2px);\n        }\n        50% {\n          transform: translateY(-0.2px) translateX(-0.3px);\n        }\n        75% {\n          transform: translateY(0.2px) translateX(0.3px);\n        }\n      }\n\n      /* 轮盘内圈 */\n      .reel-inner {\n        width: 45px;\n        height: 45px;\n        border-radius: 50%;\n        overflow: hidden;\n        border: 2px solid rgba(255, 255, 255, 0.25);\n        background: #000;\n        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.5),\n          inset 0 1px 2px rgba(255, 255, 255, 0.2);\n      }\n\n      .reel-inner img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        filter: brightness(0.95) contrast(1.05);\n      }\n\n      /* 轮盘齿轮装饰 */\n      .reel-teeth {\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        top: 0;\n        left: 0;\n      }\n\n      .reel-teeth::before,\n      .reel-teeth::after {\n        content: "";\n        position: absolute;\n        width: 8px;\n        height: 2px;\n        background: rgba(255, 255, 255, 0.3);\n        top: 50%;\n        left: 50%;\n      }\n\n      .reel-teeth::before {\n        transform: translate(-50%, -50%);\n      }\n\n      .reel-teeth::after {\n        transform: translate(-50%, -50%) rotate(90deg);\n      }\n\n      /* 磁带中间信息区 */\n      .cassette-info {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        min-width: 0;\n      }\n\n      /* 黑色磁带标签样式 */\n      .cassette-label {\n        background: linear-gradient(\n          135deg,\n          rgba(20, 20, 20, 0.95) 0%,\n          rgba(15, 15, 15, 0.98) 50%,\n          rgba(10, 10, 10, 0.95) 100%\n        );\n        border-radius: 4px;\n        padding: 8px 12px;\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6),\n          inset 0 1px 0 rgba(255, 255, 255, 0.08),\n          inset 0 -1px 2px rgba(0, 0, 0, 0.5);\n        position: relative;\n        overflow: hidden;\n        backdrop-filter: blur(10px);\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .cassette-label:hover {\n        border-color: rgba(255, 255, 255, 0.18);\n        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.7),\n          inset 0 1px 0 rgba(255, 255, 255, 0.12),\n          inset 0 -1px 2px rgba(0, 0, 0, 0.5),\n          0 0 15px rgba(255, 255, 255, 0.05);\n        transform: translateY(-1px);\n      }\n\n      /* 磁带纹理 - 横向细条纹 */\n      .cassette-label::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 1px,\n          rgba(255, 255, 255, 0.02) 1px,\n          rgba(255, 255, 255, 0.02) 2px\n        );\n        opacity: 0.8;\n        pointer-events: none;\n        z-index: 0;\n      }\n\n      /* 顶部高光反射 */\n      .cassette-label::after {\n        content: "";\n        position: absolute;\n        left: 10%;\n        right: 10%;\n        top: 0;\n        height: 40%;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.08) 0%,\n          transparent 100%\n        );\n        border-radius: 4px 4px 0 0;\n        pointer-events: none;\n        z-index: 1;\n      }\n\n      .cassette-title {\n        font-size: 12px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.95);\n        margin-bottom: 3px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n        letter-spacing: 1.2px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8),\n          0 0 8px rgba(255, 255, 255, 0.1);\n        position: relative;\n        z-index: 2;\n      }\n\n      .cassette-artist {\n        font-size: 9px;\n        color: rgba(255, 255, 255, 0.6);\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n        letter-spacing: 1px;\n        font-family: "Courier New", monospace;\n        font-weight: 500;\n        position: relative;\n        z-index: 2;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);\n      }\n\n      /* 音波可视化容器 - 合并主播发言 */\n      .audio-visualizer {\n        position: relative;\n        height: 48px;\n        padding: 0 14px;\n        background: linear-gradient(\n          180deg,\n          rgba(0, 0, 0, 0.45),\n          rgba(0, 0, 0, 0.35)\n        );\n        border-radius: 8px;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.5),\n          0 1px 0 rgba(255, 255, 255, 0.06);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: hidden;\n      }\n\n      /* 左右边缘渐变遮罩 - 创建自然的fade效果 */\n      .audio-visualizer::before,\n      .audio-visualizer::after {\n        content: "";\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        width: 80px;\n        pointer-events: none;\n        z-index: 3;\n        opacity: 0;\n        transition: opacity 0.6s ease;\n      }\n\n      .audio-visualizer::before {\n        left: 0;\n        background: linear-gradient(\n          to right,\n          rgba(0, 0, 0, 0.45) 0%,\n          rgba(0, 0, 0, 0.35) 30%,\n          transparent 100%\n        );\n      }\n\n      .audio-visualizer::after {\n        right: 0;\n        background: linear-gradient(\n          to left,\n          rgba(0, 0, 0, 0.45) 0%,\n          rgba(0, 0, 0, 0.35) 30%,\n          transparent 100%\n        );\n      }\n\n      /* 文字活跃时显示边缘遮罩 */\n      .audio-visualizer.speech-active::before,\n      .audio-visualizer.speech-active::after {\n        opacity: 1;\n      }\n\n      /* 音波条容器（可点击） */\n      .audio-bars {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 4px;\n        position: absolute;\n        inset: 0;\n        transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1), \n                    transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n                    filter 1.2s cubic-bezier(0.4, 0, 0.2, 1);\n        cursor: pointer;\n        filter: blur(0);\n      }\n\n      .audio-bars:hover {\n        transform: scale(1.02);\n      }\n\n      .audio-bars:active {\n        transform: scale(0.98);\n      }\n\n      /* 音波淡出时的模糊效果 */\n      .audio-bars.dimmed {\n        filter: blur(1px);\n      }\n\n      .audio-bar {\n        width: 3px;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.65),\n          rgba(255, 255, 255, 0.45)\n        );\n        border-radius: 2px;\n        animation: audioWave 0.8s ease-in-out infinite;\n        box-shadow: 0 0 4px rgba(255, 255, 255, 0.25);\n      }\n\n      /* 主播发言文字层 */\n      .streamer-speech-text {\n        position: absolute;\n        inset: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 0 20px;\n        opacity: 0;\n        z-index: 2;\n        pointer-events: none;\n      }\n\n      /* 出现前：添加背景光晕层 */\n      .streamer-speech-text::before {\n        content: "";\n        position: absolute;\n        inset: -10px;\n        background: radial-gradient(\n          ellipse at center,\n          rgba(255, 255, 255, 0) 0%,\n          rgba(255, 255, 255, 0) 40%,\n          rgba(255, 255, 255, 0) 100%\n        );\n        border-radius: 50%;\n        opacity: 0;\n        filter: blur(20px);\n        transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: -1;\n      }\n\n      .streamer-speech-text.active {\n        opacity: 1;\n        animation: speechBreathing 3s ease-in-out infinite;\n      }\n\n      /* 活跃时：显示背景光晕 */\n      .streamer-speech-text.active::before {\n        opacity: 0.15;\n        background: radial-gradient(\n          ellipse at center,\n          rgba(255, 255, 255, 0.08) 0%,\n          rgba(255, 255, 255, 0.04) 40%,\n          rgba(255, 255, 255, 0) 100%\n        );\n      }\n\n      /* 渐出状态：更慢、更平滑的消失效果 */\n      .streamer-speech-text.fading {\n        opacity: 0 !important;\n        transition: opacity 2s cubic-bezier(0.4, 0, 0.2, 1);\n        animation: speechFadeOut 2s cubic-bezier(0.4, 0, 0.2, 1) forwards;\n      }\n\n      .streamer-speech-text.fading::before {\n        opacity: 0 !important;\n        transition: opacity 2s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      /* 文字呼吸效果：光晕脉动 + 阴影变化 */\n      @keyframes speechBreathing {\n        0% {\n          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4))\n                  drop-shadow(0 0 8px rgba(255, 255, 255, 0.05));\n        }\n        50% {\n          filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.5))\n                  drop-shadow(0 0 20px rgba(255, 255, 255, 0.15))\n                  drop-shadow(0 0 40px rgba(255, 255, 255, 0.08));\n        }\n        100% {\n          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4))\n                  drop-shadow(0 0 8px rgba(255, 255, 255, 0.05));\n        }\n      }\n\n      /* 渐出动画：光晕消散 + 模糊 */\n      @keyframes speechFadeOut {\n        0% {\n          filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4))\n                  drop-shadow(0 0 8px rgba(255, 255, 255, 0.05))\n                  blur(0);\n        }\n        100% {\n          filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0))\n                  drop-shadow(0 0 0 rgba(255, 255, 255, 0))\n                  blur(6px);\n        }\n      }\n\n      .speech-text-content {\n        font-size: 13px;\n        line-height: 1.5;\n        color: rgba(255, 255, 255, 0.95);\n        font-weight: 500;\n        letter-spacing: 0.3px;\n        text-shadow: \n          0 0 10px rgba(255, 255, 255, 0.3),\n          0 0 20px rgba(255, 255, 255, 0.2),\n          0 0 30px rgba(255, 255, 255, 0.1),\n          0 2px 4px rgba(0, 0, 0, 0.5);\n        white-space: nowrap;\n        position: absolute;\n        left: 100%;\n        will-change: transform;\n        animation: textGlow 3s ease-in-out infinite;\n      }\n\n      /* 文字光晕脉动 */\n      @keyframes textGlow {\n        0%, 100% {\n          text-shadow: \n            0 0 8px rgba(255, 255, 255, 0.25),\n            0 0 16px rgba(255, 255, 255, 0.15),\n            0 0 24px rgba(255, 255, 255, 0.08),\n            0 2px 4px rgba(0, 0, 0, 0.5);\n        }\n        50% {\n          text-shadow: \n            0 0 15px rgba(255, 255, 255, 0.4),\n            0 0 30px rgba(255, 255, 255, 0.3),\n            0 0 45px rgba(255, 255, 255, 0.2),\n            0 0 60px rgba(255, 255, 255, 0.1),\n            0 3px 6px rgba(0, 0, 0, 0.6);\n        }\n      }\n\n      /* 横向滚动动画：从右到左完整滚动，确保所有文字都能看到 */\n      @keyframes scrollSpeech {\n        0% {\n          transform: translateX(0);\n        }\n        100% {\n          /* 移动容器宽度+文字自身宽度，确保完全离开可视区域 */\n          transform: translateX(calc(-100% - 100vw));\n        }\n      }\n\n      .audio-bar:nth-child(1) {\n        height: 20%;\n        animation-delay: 0s;\n      }\n      .audio-bar:nth-child(2) {\n        height: 40%;\n        animation-delay: 0.1s;\n      }\n      .audio-bar:nth-child(3) {\n        height: 70%;\n        animation-delay: 0.2s;\n      }\n      .audio-bar:nth-child(4) {\n        height: 50%;\n        animation-delay: 0.3s;\n      }\n      .audio-bar:nth-child(5) {\n        height: 90%;\n        animation-delay: 0.4s;\n      }\n      .audio-bar:nth-child(6) {\n        height: 60%;\n        animation-delay: 0.5s;\n      }\n      .audio-bar:nth-child(7) {\n        height: 80%;\n        animation-delay: 0.6s;\n      }\n      .audio-bar:nth-child(8) {\n        height: 40%;\n        animation-delay: 0.7s;\n      }\n      .audio-bar:nth-child(9) {\n        height: 55%;\n        animation-delay: 0.8s;\n      }\n      .audio-bar:nth-child(10) {\n        height: 30%;\n        animation-delay: 0.9s;\n      }\n\n      /* 音波条动画 - 更自然的呼吸感 */\n      @keyframes audioWave {\n        0% {\n          transform: scaleY(0.4);\n          opacity: 0.4;\n        }\n        20% {\n          transform: scaleY(0.7);\n          opacity: 0.7;\n        }\n        40% {\n          transform: scaleY(1);\n          opacity: 1;\n        }\n        60% {\n          transform: scaleY(0.8);\n          opacity: 0.8;\n        }\n        80% {\n          transform: scaleY(0.6);\n          opacity: 0.6;\n        }\n        100% {\n          transform: scaleY(0.4);\n          opacity: 0.4;\n        }\n      }\n\n      /* 进度条区域 */\n      .progress-section {\n        margin-top: 16px;\n        padding-top: 14px;\n        border-top: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .progress-time {\n        display: flex;\n        justify-content: space-between;\n        font-size: 9px;\n        color: rgba(255, 255, 255, 0.55);\n        margin-bottom: 8px;\n        font-family: "Courier New", monospace;\n        font-weight: 700;\n        letter-spacing: 1.2px;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n      }\n\n      .progress-bar {\n        width: 100%;\n        height: 6px;\n        background: rgba(255, 255, 255, 0.15);\n        border-radius: 3px;\n        overflow: hidden;\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5),\n          0 1px 0 rgba(255, 255, 255, 0.05);\n        position: relative;\n      }\n\n      .progress-bar::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 1px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255, 255, 255, 0.15) 50%,\n          transparent\n        );\n      }\n\n      .progress-fill {\n        width: 0%;\n        height: 100%;\n        background: linear-gradient(\n          90deg,\n          rgba(255, 255, 255, 0.85),\n          rgba(255, 255, 255, 0.7)\n        );\n        border-radius: 3px;\n        transition: width 1s linear;\n        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n        position: relative;\n        animation: progressGlow 2s ease-in-out infinite;\n      }\n\n      /* 进度条发光效果 */\n      @keyframes progressGlow {\n        0%,\n        100% {\n          box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);\n        }\n        50% {\n          box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);\n        }\n      }\n\n      .progress-fill::after {\n        content: "";\n        position: absolute;\n        top: 0;\n        right: 0;\n        width: 4px;\n        height: 100%;\n        background: rgba(255, 255, 255, 1);\n        border-radius: 0 3px 3px 0;\n        box-shadow: 0 0 10px rgba(255, 255, 255, 0.7),\n          0 0 4px rgba(255, 255, 255, 0.9);\n      }\n\n      /* 直播详情区域 - 磁带插页样式 */\n      .live-details {\n        background: linear-gradient(\n          135deg,\n          rgba(245, 240, 230, 0.94) 0%,\n          rgba(235, 230, 215, 0.94) 100%\n        );\n        border: 1px solid rgba(150, 130, 100, 0.5);\n        border-radius: 4px;\n        padding: 16px 18px 16px 24px;\n        margin-bottom: 20px;\n        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4),\n          inset 0 1px 0 rgba(255, 255, 255, 0.4),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.1);\n        position: relative;\n        overflow: hidden;\n        animation: cardSlideIn 0.5s ease-out 0.3s both;\n        transform: translateZ(0);\n        backface-visibility: hidden;\n      }\n\n      .live-details.details-expanded {\n        overflow: visible;\n      }\n\n      /* 卡片滑入动画 */\n      @keyframes cardSlideIn {\n        0% {\n          opacity: 0;\n          transform: translateX(-15px);\n          filter: blur(3px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateX(0);\n          filter: blur(0);\n        }\n      }\n\n      /* 纸张纹理 */\n      .live-details::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background-image: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 1px,\n          rgba(0, 0, 0, 0.015) 1px,\n          rgba(0, 0, 0, 0.015) 2px\n        );\n        pointer-events: none;\n        opacity: 0.8;\n        z-index: 0;\n      }\n\n      /* 磁带孔装饰 */\n      .live-details::after {\n        content: "";\n        position: absolute;\n        left: 8px;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 60%;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 6px,\n          rgba(0, 0, 0, 0.15) 6px,\n          rgba(0, 0, 0, 0.15) 8px\n        );\n        border-radius: 2px;\n        z-index: 1;\n      }\n\n      .details-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        cursor: pointer;\n        user-select: none;\n        padding: 4px 0;\n        transition: opacity 0.2s ease;\n        position: relative;\n        z-index: 2;\n        transform: translateZ(0);\n      }\n\n      .details-header:hover {\n        opacity: 0.9;\n      }\n\n      .details-header:active {\n        opacity: 0.7;\n      }\n\n      /* 磁带插页装饰螺丝 */\n      .details-screw {\n        position: absolute;\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 35% 35%,\n          rgba(0, 0, 0, 0.3),\n          rgba(0, 0, 0, 0.15)\n        );\n        border: 1px solid rgba(0, 0, 0, 0.2);\n        z-index: 3;\n      }\n\n      .details-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(45deg);\n        width: 3px;\n        height: 0.5px;\n        background: rgba(0, 0, 0, 0.4);\n      }\n\n      .details-title {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        font-size: 11px;\n        font-weight: 800;\n        color: #1a1a1a;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n      }\n\n      .details-icon {\n        width: 16px;\n        height: 16px;\n        stroke: #2a2a2a;\n        fill: none;\n        stroke-width: 2.5;\n        position: relative;\n        z-index: 2;\n      }\n\n      .expand-icon {\n        width: 14px;\n        height: 14px;\n        stroke: #3a3a3a;\n        fill: none;\n        stroke-width: 2.5;\n        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n        position: relative;\n        z-index: 2;\n        transform: translateZ(0);\n        will-change: transform;\n      }\n\n      .expand-icon.expanded {\n        transform: rotate(180deg) translateZ(0);\n      }\n\n      .details-content {\n        max-height: 0;\n        overflow: hidden;\n        transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),\n          margin-top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n        margin-top: 0;\n        position: relative;\n        z-index: 10;\n        will-change: max-height, margin-top;\n      }\n\n      .details-content.expanded {\n        margin-top: 16px;\n      }\n\n      /* 提示文字 */\n      .expand-hint {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.3);\n        text-align: center;\n        margin-top: 8px;\n        letter-spacing: 0.5px;\n      }\n\n      .detail-section {\n        margin-bottom: 16px;\n        transform: translateZ(0);\n        will-change: transform;\n      }\n\n      .detail-section:last-child {\n        margin-bottom: 0;\n      }\n\n      .detail-label {\n        font-size: 9px;\n        font-weight: 800;\n        color: rgba(0, 0, 0, 0.5);\n        margin-bottom: 8px;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n      }\n\n      .detail-text {\n        font-size: 12px;\n        line-height: 1.7;\n        color: rgba(0, 0, 0, 0.75);\n        letter-spacing: 0.3px;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n      }\n\n      /* 直播信息卡片 - 磁带侧面标签样式 */\n      .live-info-card {\n        background: linear-gradient(\n          135deg,\n          rgba(30, 30, 30, 0.95) 0%,\n          rgba(20, 20, 20, 0.95) 100%\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        border-left: 4px solid rgba(255, 255, 255, 0.08);\n        border-radius: 4px;\n        padding: 16px 20px 16px 24px;\n        margin-bottom: 24px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.08),\n          inset 4px 0 8px rgba(0, 0, 0, 0.3);\n        position: relative;\n        overflow: hidden;\n        animation: cardSlideIn 0.5s ease-out 0.4s both;\n      }\n\n      /* 磁带盒纹理 */\n      .live-info-card::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 1px,\n          rgba(255, 255, 255, 0.01) 1px,\n          rgba(255, 255, 255, 0.01) 2px\n        );\n        pointer-events: none;\n      }\n\n      /* 左侧装饰线 */\n      .live-info-card::after {\n        content: "";\n        position: absolute;\n        left: 12px;\n        top: 16px;\n        bottom: 16px;\n        width: 2px;\n        background: linear-gradient(\n          180deg,\n          transparent,\n          rgba(255, 255, 255, 0.15) 20%,\n          rgba(255, 255, 255, 0.15) 80%,\n          transparent\n        );\n      }\n\n      .info-row {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 12px;\n        padding: 4px 0;\n        position: relative;\n        z-index: 2;\n      }\n\n      .info-row:last-child {\n        margin-bottom: 0;\n      }\n\n      /* 信息卡片装饰螺丝 */\n      .info-screw {\n        position: absolute;\n        width: 5px;\n        height: 5px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 35% 35%,\n          rgba(255, 255, 255, 0.15),\n          rgba(255, 255, 255, 0.05)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        z-index: 1;\n      }\n\n      .info-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(45deg);\n        width: 3px;\n        height: 0.5px;\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .info-label {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.4);\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        font-weight: 700;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n      }\n\n      .info-value {\n        font-size: 12px;\n        color: rgba(255, 255, 255, 0.9);\n        font-weight: 700;\n        letter-spacing: 0.5px;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n      }\n\n      .live-badge {\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        background: linear-gradient(\n          135deg,\n          rgba(250, 245, 235, 0.12),\n          rgba(240, 235, 225, 0.08)\n        );\n        padding: 5px 12px;\n        border-radius: 4px;\n        font-size: 11px;\n        font-weight: 700;\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.8px;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1),\n          0 1px 3px rgba(0, 0, 0, 0.3);\n        position: relative;\n        z-index: 2;\n      }\n\n      .live-dot {\n        width: 6px;\n        height: 6px;\n        background: #fff;\n        border-radius: 50%;\n        animation: blink 1.5s infinite;\n      }\n\n      /* LIVE点闪烁 - 录制指示灯感 */\n      @keyframes blink {\n        0% {\n          opacity: 1;\n          box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);\n        }\n        25% {\n          opacity: 0.9;\n          box-shadow: 0 0 6px rgba(255, 255, 255, 0.4);\n        }\n        50% {\n          opacity: 0.3;\n          box-shadow: 0 0 2px rgba(255, 255, 255, 0.2);\n        }\n        75% {\n          opacity: 0.7;\n          box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);\n        }\n        100% {\n          opacity: 1;\n          box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);\n        }\n      }\n\n      /* 标签组 */\n      .info-tags {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n      }\n\n      .info-tag {\n        background: linear-gradient(\n          135deg,\n          rgba(250, 245, 235, 0.15),\n          rgba(240, 235, 225, 0.12)\n        );\n        padding: 5px 10px;\n        border-radius: 3px;\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.8);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12),\n          0 1px 3px rgba(0, 0, 0, 0.3);\n        transition: all 0.2s ease;\n        letter-spacing: 0.8px;\n        font-weight: 600;\n        font-family: "Courier New", monospace;\n        text-transform: uppercase;\n        position: relative;\n        z-index: 2;\n      }\n\n      .info-tag:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(250, 245, 235, 0.2),\n          rgba(240, 235, 225, 0.15)\n        );\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: translateY(-2px) scale(1.02);\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15),\n          0 3px 8px rgba(0, 0, 0, 0.4);\n        animation: tagFloat 0.6s ease-out;\n      }\n\n      /* 标签悬停浮起效果 */\n      @keyframes tagFloat {\n        0% {\n          transform: translateY(0) scale(1);\n        }\n        50% {\n          transform: translateY(-3px) scale(1.03);\n        }\n        100% {\n          transform: translateY(-2px) scale(1.02);\n        }\n      }\n\n      /* 认证图标 */\n      .verified-icon {\n        width: 14px;\n        height: 14px;\n        fill: rgba(255, 255, 255, 0.9);\n        margin-left: 4px;\n      }\n\n      /* 磁带观察窗 - 弹幕区域 */\n      .cassette-window {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.06),\n          rgba(255, 255, 255, 0.02)\n        );\n        backdrop-filter: blur(20px);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-top: 1px solid rgba(255, 255, 255, 0.05);\n        border-radius: 0 0 24px 24px;\n        padding: 28px 24px 24px;\n        margin-bottom: 24px;\n        position: relative;\n        overflow: hidden;\n        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3),\n          inset 0 0 20px rgba(0, 0, 0, 0.2);\n        z-index: 1;\n        animation: windowFadeIn 0.8s ease-out;\n      }\n\n      /* 观察窗淡入动画 */\n      @keyframes windowFadeIn {\n        0% {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* 磁带窗口装饰线 */\n      .cassette-window::before {\n        content: "";\n        position: absolute;\n        top: 12px;\n        left: 20px;\n        right: 20px;\n        height: 1px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255, 255, 255, 0.15) 20%,\n          rgba(255, 255, 255, 0.15) 80%,\n          transparent\n        );\n      }\n\n      /* 磁带窗口内的纹理 */\n      .cassette-window::after {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.02) 2px,\n          rgba(255, 255, 255, 0.02) 4px\n        );\n        pointer-events: none;\n      }\n\n      .window-label {\n        font-size: 9px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        color: rgba(255, 255, 255, 0.35);\n        margin-bottom: 12px;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        font-family: "Courier New", monospace;\n        position: relative;\n        z-index: 2;\n        animation: labelPulse 4s ease-in-out infinite;\n      }\n\n      /* 标签微脉动 */\n      @keyframes labelPulse {\n        0%,\n        100% {\n          opacity: 0.35;\n        }\n        50% {\n          opacity: 0.5;\n        }\n      }\n\n      .window-label::before,\n      .window-label::after {\n        content: "";\n        flex: 1;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 4px,\n          rgba(255, 255, 255, 0.15) 4px,\n          rgba(255, 255, 255, 0.15) 8px\n        );\n      }\n\n      /* 磁带盒螺丝装饰 */\n      .cassette-screws {\n        position: absolute;\n        inset: 0;\n        pointer-events: none;\n        z-index: 10;\n      }\n\n      .cassette-screw {\n        position: absolute;\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 35% 35%,\n          rgba(255, 255, 255, 0.2),\n          rgba(255, 255, 255, 0.08),\n          rgba(0, 0, 0, 0.1)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.4),\n          0 1px 1px rgba(255, 255, 255, 0.05);\n      }\n\n      .cassette-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(45deg);\n        width: 5px;\n        height: 1px;\n        background: rgba(0, 0, 0, 0.5);\n        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);\n      }\n\n      .cassette-screw::after {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(-45deg);\n        width: 5px;\n        height: 1px;\n        background: rgba(0, 0, 0, 0.5);\n        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);\n      }\n\n      .cassette-screw.top-left {\n        top: 16px;\n        left: 16px;\n      }\n\n      .cassette-screw.top-right {\n        top: 16px;\n        right: 16px;\n      }\n\n      .cassette-screw.bottom-left {\n        bottom: 16px;\n        left: 16px;\n      }\n\n      .cassette-screw.bottom-right {\n        bottom: 16px;\n        right: 16px;\n      }\n\n      /* 弹幕滚动容器 */\n      .danmaku-section {\n        height: 180px;\n        overflow: hidden;\n        position: relative;\n        z-index: 1;\n      }\n\n      .danmaku-list {\n        display: flex;\n        flex-direction: column;\n        gap: 14px;\n        animation: danmakuScroll 1s ease-out;\n      }\n\n      /* 弹幕列表初始化动画 */\n      @keyframes danmakuScroll {\n        0% {\n          transform: translateY(-15px);\n          opacity: 0;\n          filter: blur(3px);\n        }\n        100% {\n          transform: translateY(0);\n          opacity: 1;\n          filter: blur(0);\n        }\n      }\n\n      .danmaku-item {\n        display: flex;\n        gap: 12px;\n        align-items: flex-start;\n        padding: 8px 0;\n        animation: fadeInUp 0.4s ease-out;\n        position: relative;\n      }\n\n      .danmaku-item::after {\n        content: "";\n        position: absolute;\n        bottom: 0;\n        left: 48px;\n        right: 0;\n        height: 1px;\n        background: linear-gradient(\n          90deg,\n          rgba(255, 255, 255, 0.08),\n          transparent\n        );\n      }\n\n      .danmaku-item:last-child::after {\n        display: none;\n      }\n\n      /* 弹幕滑入动画 - 磁带读取感 */\n      @keyframes fadeInUp {\n        0% {\n          opacity: 0;\n          transform: translateX(-20px) scale(0.95);\n          filter: blur(2px);\n        }\n        60% {\n          opacity: 0.8;\n          transform: translateX(2px) scale(1.01);\n        }\n        100% {\n          opacity: 1;\n          transform: translateX(0) scale(1);\n          filter: blur(0);\n        }\n      }\n\n      .danmaku-avatar {\n        width: 34px;\n        height: 34px;\n        border-radius: 50%;\n        border: 2px solid rgba(255, 255, 255, 0.15);\n        flex-shrink: 0;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),\n          inset 0 1px 1px rgba(255, 255, 255, 0.2);\n        filter: brightness(0.95) contrast(1.05);\n        background: #000;\n      }\n\n      .danmaku-content {\n        flex: 1;\n        min-width: 0;\n        padding-top: 2px;\n      }\n\n      .danmaku-user {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.5);\n        font-weight: 800;\n        margin-bottom: 4px;\n        letter-spacing: 0.8px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n      }\n\n      .danmaku-text {\n        font-size: 12px;\n        color: rgba(255, 255, 255, 0.85);\n        line-height: 1.6;\n        word-break: break-word;\n        letter-spacing: 0.3px;\n        font-family: "Courier New", monospace;\n      }\n\n      /* 固定的详情和互动区 */\n      .fixed-bottom-section {\n        position: sticky;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        z-index: 50;\n        margin-top: auto;\n        padding: 16px 20px 20px;\n        background: linear-gradient(\n          180deg,\n          transparent 0%,\n          rgba(0, 0, 0, 0.3) 20%,\n          rgba(0, 0, 0, 0.6) 100%\n        );\n      }\n\n      /* 底部互动栏 - 磁带控制面板样式 */\n      .interaction-bar {\n        background: linear-gradient(\n          180deg,\n          rgba(35, 35, 35, 0.98),\n          rgba(25, 25, 25, 0.98)\n        );\n        backdrop-filter: blur(30px) saturate(150%);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 8px;\n        padding: 16px 20px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4),\n          0 4px 16px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.12),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.3);\n        position: relative;\n        animation: barSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s both;\n      }\n\n      /* 底部栏滑入动画 */\n      @keyframes barSlideUp {\n        0% {\n          opacity: 0;\n          transform: translateY(50px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* 控制面板纹理 */\n      .interaction-bar::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        border-radius: 8px;\n        pointer-events: none;\n      }\n\n      /* 磁带播放器风格按钮 */\n      .action-btn {\n        width: 42px;\n        height: 42px;\n        border-radius: 4px;\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(70, 70, 70, 0.9),\n          rgba(40, 40, 40, 0.9)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        flex-shrink: 0;\n        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.15),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.3);\n        position: relative;\n        z-index: 2;\n      }\n\n      .action-btn::before {\n        content: "";\n        position: absolute;\n        inset: 2px;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.05),\n          transparent\n        );\n        border-radius: 3px;\n        pointer-events: none;\n      }\n\n      .action-btn:hover {\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(80, 80, 80, 0.9),\n          rgba(50, 50, 50, 0.9)\n        );\n        border-color: rgba(255, 255, 255, 0.25);\n        transform: translateY(-1px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .action-btn:active {\n        transform: translateY(2px) scale(0.97);\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.6),\n          inset 0 3px 6px rgba(0, 0, 0, 0.5);\n        animation: btnPress 0.2s ease-out;\n      }\n\n      /* 按钮按下动画 */\n      @keyframes btnPress {\n        0% {\n          transform: translateY(-1px) scale(1);\n        }\n        50% {\n          transform: translateY(3px) scale(0.95);\n        }\n        100% {\n          transform: translateY(2px) scale(0.97);\n        }\n      }\n\n      /* 磁带播放器风格输入框 */\n      .input-box {\n        flex: 1;\n        background: linear-gradient(\n          180deg,\n          rgba(15, 15, 15, 0.95),\n          rgba(20, 20, 20, 0.95)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.18);\n        border-radius: 6px;\n        padding: 12px 16px;\n        color: #fff;\n        font-size: 13px;\n        outline: none;\n        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(0, 0, 0, 0.4), 0 1px 0 rgba(255, 255, 255, 0.05);\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.5px;\n        position: relative;\n        z-index: 2;\n      }\n\n      .input-box::placeholder {\n        color: rgba(255, 255, 255, 0.35);\n        letter-spacing: 0.8px;\n        font-family: "Courier New", monospace;\n      }\n\n      .input-box:focus {\n        background: linear-gradient(\n          180deg,\n          rgba(20, 20, 20, 0.95),\n          rgba(25, 25, 25, 0.95)\n        );\n        border-color: rgba(255, 255, 255, 0.25);\n        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4),\n          0 0 0 2px rgba(255, 255, 255, 0.08);\n      }\n\n      /* 点赞动画 */\n      .like-container {\n        position: fixed;\n        bottom: 100px;\n        right: 20px;\n        width: 50px;\n        height: 250px;\n        pointer-events: none;\n        z-index: 40;\n      }\n\n      /* 点赞上浮动画 - 更自然 */\n      @keyframes floatUp {\n        0% {\n          opacity: 1;\n          transform: translateY(0) scale(0.8) rotate(0deg);\n        }\n        20% {\n          opacity: 1;\n          transform: translateY(-50px) scale(1) rotate(5deg);\n        }\n        50% {\n          opacity: 0.8;\n          transform: translateY(-125px) scale(1.2) rotate(-3deg);\n        }\n        80% {\n          opacity: 0.3;\n          transform: translateY(-200px) scale(1.35) rotate(2deg);\n        }\n        100% {\n          opacity: 0;\n          transform: translateY(-250px) scale(1.4) rotate(0deg);\n        }\n      }\n\n      /* 滚动条 */\n      .live-content::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .live-content::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.03);\n        border-radius: 3px;\n      }\n\n      .live-content::-webkit-scrollbar-thumb {\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.2),\n          rgba(255, 255, 255, 0.15)\n        );\n        border-radius: 3px;\n        border: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .live-content::-webkit-scrollbar-thumb:hover {\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.3),\n          rgba(255, 255, 255, 0.2)\n        );\n      }\n\n      /* ============================================ */\n      /* iOS风格液态玻璃悬浮控制面板 */\n      /* ============================================ */\n\n      /* 遮罩层 - 更透明，更强模糊 */\n      .control-sidebar-overlay {\n        position: fixed;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.35);\n        backdrop-filter: blur(8px) saturate(120%);\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), \n                    backdrop-filter 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: 9998;\n      }\n\n      .control-sidebar-overlay.active {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 悬浮面板容器 - 小巧居中，iOS液态玻璃 */\n      .control-sidebar {\n        position: fixed;\n        top: 50%;\n        right: 20px;\n        transform: translate(400px, -50%) translateZ(0);\n        width: 260px;\n        max-height: 420px;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.09) 0%,\n          rgba(255, 255, 255, 0.06) 50%,\n          rgba(255, 255, 255, 0.04) 100%\n        );\n        backdrop-filter: blur(60px) saturate(200%) brightness(1.1);\n        border: 1px solid rgba(255, 255, 255, 0.18);\n        border-radius: 28px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),\n                    0 0 1px rgba(255, 255, 255, 0.3),\n                    inset 0 1px 1px rgba(255, 255, 255, 0.2),\n                    inset 0 -1px 1px rgba(0, 0, 0, 0.1);\n        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),\n                    opacity 0.4s ease;\n        opacity: 0;\n        z-index: 9999;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        will-change: transform, opacity;\n      }\n\n      .control-sidebar.active {\n        transform: translate(0, -50%) translateZ(0);\n        opacity: 1;\n      }\n\n      /* iOS果冻质感高光层 */\n      .control-sidebar::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 60%;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.15) 0%,\n          rgba(255, 255, 255, 0.05) 40%,\n          transparent 100%\n        );\n        border-radius: 28px 28px 0 0;\n        pointer-events: none;\n        z-index: 1;\n      }\n\n      /* 底部柔和反光 */\n      .control-sidebar::after {\n        content: "";\n        position: absolute;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        height: 30%;\n        background: radial-gradient(\n          ellipse at 50% 100%,\n          rgba(255, 255, 255, 0.05) 0%,\n          transparent 70%\n        );\n        border-radius: 0 0 28px 28px;\n        pointer-events: none;\n        z-index: 1;\n      }\n\n      /* 面板头部 - 极简 */\n      .sidebar-header {\n        padding: 24px 20px 16px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        position: relative;\n        z-index: 2;\n      }\n\n      .sidebar-title {\n        font-size: 16px;\n        font-weight: 700;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n        color: rgba(255, 255, 255, 0.9);\n        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);\n      }\n\n      .sidebar-close-btn {\n        width: 28px;\n        height: 28px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.08);\n        border: 0.5px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        backdrop-filter: blur(10px);\n      }\n\n      .sidebar-close-btn:hover {\n        background: rgba(255, 255, 255, 0.12);\n        border-color: rgba(255, 255, 255, 0.25);\n        transform: scale(1.08);\n      }\n\n      .sidebar-close-btn:active {\n        transform: scale(0.92);\n      }\n\n      /* 内容区域 - 紧凑 */\n      .sidebar-content {\n        flex: 1;\n        padding: 0 16px 20px;\n        overflow-y: auto;\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        position: relative;\n        z-index: 2;\n      }\n\n      .sidebar-content::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .sidebar-content::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .sidebar-content::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 2px;\n      }\n\n      /* 按钮项 - iOS风格紧凑卡片 */\n      .sidebar-item {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.1) 0%,\n          rgba(255, 255, 255, 0.05) 100%\n        );\n        backdrop-filter: blur(30px) saturate(150%);\n        border: 0.5px solid rgba(255, 255, 255, 0.18);\n        border-radius: 18px;\n        padding: 14px 16px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        cursor: pointer;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        position: relative;\n        overflow: hidden;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.15);\n      }\n\n      /* 果冻质感高光 */\n      .sidebar-item::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 40%;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.12) 0%,\n          transparent 100%\n        );\n        border-radius: 18px 18px 0 0;\n        pointer-events: none;\n      }\n\n      /* Hover发光效果 - 更柔和 */\n      .sidebar-item::after {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 0;\n        height: 0;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle,\n          rgba(255, 255, 255, 0.2),\n          transparent 60%\n        );\n        transform: translate(-50%, -50%);\n        opacity: 0;\n        transition: width 0.5s ease, height 0.5s ease, opacity 0.3s ease;\n        pointer-events: none;\n      }\n\n      .sidebar-item:hover::after {\n        width: 180px;\n        height: 180px;\n        opacity: 1;\n      }\n\n      .sidebar-item:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.15) 0%,\n          rgba(255, 255, 255, 0.08) 100%\n        );\n        border-color: rgba(255, 255, 255, 0.3);\n        transform: scale(1.02) translateZ(0);\n        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.25),\n                    0 0 20px rgba(255, 255, 255, 0.08);\n      }\n\n      .sidebar-item:active {\n        transform: scale(0.97) translateZ(0);\n        transition-duration: 0.1s;\n      }\n\n      /* 图标 - 更小巧精致 */\n      .sidebar-item-icon {\n        width: 38px;\n        height: 38px;\n        border-radius: 11px;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.15),\n          rgba(255, 255, 255, 0.08)\n        );\n        border: 0.5px solid rgba(255, 255, 255, 0.2);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15),\n                    inset 0 0.5px 0 rgba(255, 255, 255, 0.3);\n        position: relative;\n        z-index: 1;\n      }\n\n      .sidebar-item:hover .sidebar-item-icon {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.22),\n          rgba(255, 255, 255, 0.12)\n        );\n        transform: scale(1.08) rotate(5deg);\n        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2),\n                    inset 0 0.5px 0 rgba(255, 255, 255, 0.4),\n                    0 0 12px rgba(255, 255, 255, 0.15);\n      }\n\n      /* 文本内容 - 紧凑 */\n      .sidebar-item-content {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n        position: relative;\n        z-index: 1;\n      }\n\n      .sidebar-item-title {\n        font-size: 14px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.95);\n        letter-spacing: 0.3px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n\n      .sidebar-item-subtitle {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.55);\n        letter-spacing: 0.5px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n      }\n\n      /* 果冻弹性入场动画 */\n      @keyframes jellySlideIn {\n        0% {\n          transform: translate(400px, -50%) scale(0.8) translateZ(0);\n          opacity: 0;\n          filter: blur(10px);\n        }\n        60% {\n          transform: translate(-15px, -50%) scale(1.03) translateZ(0);\n        }\n        80% {\n          transform: translate(5px, -50%) scale(0.98) translateZ(0);\n        }\n        100% {\n          transform: translate(0, -50%) scale(1) translateZ(0);\n          opacity: 1;\n          filter: blur(0);\n        }\n      }\n\n      /* 按钮依次弹入 */\n      .sidebar-item {\n        animation: itemBounceIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;\n      }\n\n      .sidebar-item:nth-child(1) {\n        animation-delay: 0.08s;\n      }\n\n      .sidebar-item:nth-child(2) {\n        animation-delay: 0.14s;\n      }\n\n      .sidebar-item:nth-child(3) {\n        animation-delay: 0.2s;\n      }\n\n      .sidebar-item:nth-child(4) {\n        animation-delay: 0.26s;\n      }\n\n      @keyframes itemBounceIn {\n        0% {\n          opacity: 0;\n          transform: translateY(15px) scale(0.85) translateZ(0);\n          filter: blur(5px);\n        }\n        70% {\n          transform: translateY(-2px) scale(1.02) translateZ(0);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0) scale(1) translateZ(0);\n          filter: blur(0);\n        }\n      }\n\n      /* ============================================ */\n      /* 榜单悬浮面板 - 磁带播放器风格 */\n      /* ============================================ */\n\n      /* 榜单容器 */\n      .leaderboard-panel {\n        position: fixed;\n        left: 50%;\n        bottom: 160px;\n        transform: translateX(-50%) translateY(400px) translateZ(0);\n        width: 90%;\n        max-width: 380px;\n        max-height: 450px;\n        z-index: 9997;\n        opacity: 0;\n        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),\n                    opacity 0.4s ease;\n        will-change: transform, opacity;\n      }\n\n      .leaderboard-panel.active {\n        transform: translateX(-50%) translateY(0) translateZ(0);\n        opacity: 1;\n      }\n\n      /* 磁带盒外框 */\n      .leaderboard-cassette {\n        background: linear-gradient(\n          135deg,\n          rgba(20, 20, 20, 0.98) 0%,\n          rgba(15, 15, 15, 0.98) 50%,\n          rgba(10, 10, 10, 0.98) 100%\n        );\n        backdrop-filter: blur(40px) saturate(150%);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 24px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),\n                    0 0 1px rgba(255, 255, 255, 0.2),\n                    inset 0 1px 1px rgba(255, 255, 255, 0.1);\n        overflow: hidden;\n        position: relative;\n      }\n\n      /* 磁带盒装饰螺丝 */\n      .leaderboard-cassette::after {\n        content: "";\n        position: absolute;\n        inset: 0;\n        pointer-events: none;\n        z-index: 100;\n        background-image: \n          radial-gradient(circle at 16px 16px, rgba(255, 255, 255, 0.15) 0, rgba(255, 255, 255, 0.08) 4px, transparent 5px),\n          radial-gradient(circle at calc(100% - 16px) 16px, rgba(255, 255, 255, 0.15) 0, rgba(255, 255, 255, 0.08) 4px, transparent 5px),\n          radial-gradient(circle at 16px calc(100% - 16px), rgba(255, 255, 255, 0.15) 0, rgba(255, 255, 255, 0.08) 4px, transparent 5px),\n          radial-gradient(circle at calc(100% - 16px) calc(100% - 16px), rgba(255, 255, 255, 0.15) 0, rgba(255, 255, 255, 0.08) 4px, transparent 5px);\n        background-size: 100% 100%;\n        background-repeat: no-repeat;\n      }\n\n      /* 磁带纹理 */\n      .leaderboard-cassette::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        pointer-events: none;\n      }\n\n      /* 榜单头部 - 磁带标签 */\n      .leaderboard-header {\n        padding: 20px 20px 16px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n        position: relative;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.03),\n          transparent\n        );\n      }\n\n      /* 磁带标签装饰线 */\n      .leaderboard-header::before {\n        content: "";\n        position: absolute;\n        top: 8px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 40%;\n        height: 2px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255, 255, 255, 0.15) 30%,\n          rgba(255, 255, 255, 0.15) 70%,\n          transparent\n        );\n        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);\n      }\n\n      .leaderboard-nav {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex: 1;\n      }\n\n      .leaderboard-arrow {\n        width: 28px;\n        height: 28px;\n        border-radius: 6px;\n        background: rgba(255, 255, 255, 0.08);\n        border: 0.5px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .leaderboard-arrow:hover {\n        background: rgba(255, 255, 255, 0.12);\n        border-color: rgba(255, 255, 255, 0.25);\n        transform: scale(1.08);\n      }\n\n      .leaderboard-arrow:active {\n        transform: scale(0.92);\n      }\n\n      .leaderboard-arrow.disabled {\n        opacity: 0.3;\n        cursor: not-allowed;\n      }\n\n      .leaderboard-title {\n        flex: 1;\n        font-size: 13px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.9);\n        text-align: center;\n        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);\n      }\n\n      .leaderboard-indicator {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.5);\n        font-family: "Courier New", monospace;\n        letter-spacing: 1px;\n        margin: 0 8px;\n      }\n\n      .leaderboard-close {\n        width: 28px;\n        height: 28px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.08);\n        border: 0.5px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .leaderboard-close:hover {\n        background: rgba(255, 255, 255, 0.12);\n        border-color: rgba(255, 255, 255, 0.25);\n        transform: scale(1.08);\n      }\n\n      .leaderboard-close:active {\n        transform: scale(0.92);\n      }\n\n      /* MP3液晶屏内容区 */\n      .leaderboard-content {\n        position: relative;\n        height: 380px;\n        overflow: hidden;\n        perspective: 1200px;\n        transform-style: preserve-3d;\n      }\n\n      /* 磁带面板 */\n      .tape-side {\n        position: absolute;\n        inset: 0;\n        padding: 16px 20px;\n        background: linear-gradient(\n          135deg,\n          rgba(240, 240, 235, 0.08) 0%,\n          rgba(230, 230, 225, 0.05) 100%\n        );\n        overflow-y: auto;\n        overflow-x: hidden;\n        transform-origin: center center;\n        backface-visibility: hidden;\n      }\n\n      /* 磁带孔装饰 */\n      .tape-side::before {\n        content: "";\n        position: absolute;\n        left: 8px;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 4px;\n        height: 70%;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 8px,\n          rgba(0, 0, 0, 0.2) 8px,\n          rgba(0, 0, 0, 0.2) 12px\n        );\n        border-radius: 2px;\n        box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.4);\n      }\n\n      .tape-side.active {\n        z-index: 2;\n      }\n\n      .tape-side:not(.active) {\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      /* 滚动条 */\n      .tape-side::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .tape-side::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .tape-side::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 2px;\n      }\n\n      /* 榜单项目 */\n      .rank-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px 14px 12px 20px;\n        margin-bottom: 8px;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.06) 0%,\n          rgba(255, 255, 255, 0.03) 100%\n        );\n        border: 0.5px solid rgba(255, 255, 255, 0.1);\n        border-left: 2px solid rgba(255, 255, 255, 0.08);\n        border-radius: 12px;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        overflow: hidden;\n      }\n\n      .rank-item::before {\n        content: "";\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 50%;\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.08) 0%,\n          transparent 100%\n        );\n        pointer-events: none;\n      }\n\n      /* 榜单项左侧装饰条 */\n      .rank-item::after {\n        content: "";\n        position: absolute;\n        left: 6px;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 2px;\n        height: 60%;\n        background: linear-gradient(\n          180deg,\n          transparent,\n          rgba(255, 255, 255, 0.15) 30%,\n          rgba(255, 255, 255, 0.15) 70%,\n          transparent\n        );\n        border-radius: 1px;\n      }\n\n      .rank-item:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.1) 0%,\n          rgba(255, 255, 255, 0.05) 100%\n        );\n        border-color: rgba(255, 255, 255, 0.15);\n        transform: translateX(4px);\n      }\n\n      /* 前3名特殊样式 */\n      .rank-item.top-3 {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 215, 0, 0.12) 0%,\n          rgba(255, 165, 0, 0.08) 100%\n        );\n        border-color: rgba(255, 215, 0, 0.3);\n        border-left-color: rgba(255, 215, 0, 0.5);\n        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.15),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .rank-item.top-3::after {\n        background: linear-gradient(\n          180deg,\n          transparent,\n          rgba(255, 215, 0, 0.5) 30%,\n          rgba(255, 215, 0, 0.5) 70%,\n          transparent\n        );\n        box-shadow: 0 0 6px rgba(255, 215, 0, 0.3);\n      }\n\n      .rank-item.top-3:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 215, 0, 0.18) 0%,\n          rgba(255, 165, 0, 0.12) 100%\n        );\n        box-shadow: 0 6px 16px rgba(255, 215, 0, 0.25),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.3);\n      }\n\n      /* 🏆 用户榜单项特殊样式 - 高亮显示 */\n      .rank-item.user-rank-item {\n        background: linear-gradient(\n          135deg,\n          rgba(29, 155, 240, 0.15) 0%,\n          rgba(29, 155, 240, 0.08) 100%\n        );\n        border-color: rgba(29, 155, 240, 0.4);\n        border-left-color: rgba(29, 155, 240, 0.6);\n        box-shadow: 0 4px 12px rgba(29, 155, 240, 0.2),\n                    inset 0 1px 0 rgba(29, 155, 240, 0.3);\n        animation: userRankPulse 2s ease-in-out infinite;\n      }\n\n      .rank-item.user-rank-item::after {\n        background: linear-gradient(\n          180deg,\n          transparent,\n          rgba(29, 155, 240, 0.6) 30%,\n          rgba(29, 155, 240, 0.6) 70%,\n          transparent\n        );\n        box-shadow: 0 0 8px rgba(29, 155, 240, 0.5);\n      }\n\n      .rank-item.user-rank-item:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(29, 155, 240, 0.22) 0%,\n          rgba(29, 155, 240, 0.12) 100%\n        );\n        border-color: rgba(29, 155, 240, 0.5);\n        box-shadow: 0 6px 16px rgba(29, 155, 240, 0.3),\n                    inset 0 1px 0 rgba(29, 155, 240, 0.4);\n      }\n\n      .rank-item.user-rank-item .rank-name {\n        font-weight: 600;\n        color: rgba(29, 155, 240, 1);\n      }\n\n      .rank-item.user-rank-item .rank-value {\n        font-weight: 700;\n        color: rgba(29, 155, 240, 1);\n      }\n\n      @keyframes userRankPulse {\n        0%, 100% {\n          box-shadow: 0 4px 12px rgba(29, 155, 240, 0.2),\n                      inset 0 1px 0 rgba(29, 155, 240, 0.3);\n        }\n        50% {\n          box-shadow: 0 4px 16px rgba(29, 155, 240, 0.35),\n                      inset 0 1px 0 rgba(29, 155, 240, 0.4);\n        }\n      }\n\n      /* 排名徽章 */\n      .rank-medal {\n        width: 32px;\n        font-size: 16px;\n        font-weight: 800;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.9);\n        text-align: center;\n        flex-shrink: 0;\n      }\n\n      .rank-item.top-3 .rank-medal {\n        font-size: 20px;\n        filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.5));\n      }\n\n      /* 头像 */\n      .rank-avatar {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        border: 2px solid rgba(255, 255, 255, 0.15);\n        flex-shrink: 0;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\n        background: #000;\n        object-fit: cover;\n      }\n\n      .rank-item.top-3 .rank-avatar {\n        border-color: rgba(255, 215, 0, 0.5);\n        box-shadow: 0 3px 12px rgba(255, 215, 0, 0.3);\n      }\n\n      /* 用户名 */\n      .rank-name {\n        flex: 1;\n        font-size: 13px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.9);\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n      }\n\n      /* 数值 */\n      .rank-value {\n        font-size: 13px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.8);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.5px;\n        flex-shrink: 0;\n      }\n\n      .rank-item.top-3 .rank-value {\n        color: rgba(255, 215, 0, 0.95);\n        text-shadow: 0 1px 3px rgba(255, 215, 0, 0.5);\n      }\n\n      /* 徽章 */\n      .rank-badge {\n        font-size: 14px;\n        margin-left: 4px;\n      }\n\n      /* 3D翻页动画 */\n      @keyframes flipOutLeft {\n        to {\n          transform: rotateY(-90deg) translateZ(-150px);\n          opacity: 0;\n        }\n      }\n\n      @keyframes flipInRight {\n        from {\n          transform: rotateY(90deg) translateZ(-150px);\n          opacity: 0;\n        }\n        to {\n          transform: rotateY(0) translateZ(0);\n          opacity: 1;\n        }\n      }\n\n      @keyframes flipOutRight {\n        to {\n          transform: rotateY(90deg) translateZ(-150px);\n          opacity: 0;\n        }\n      }\n\n      @keyframes flipInLeft {\n        from {\n          transform: rotateY(-90deg) translateZ(-150px);\n          opacity: 0;\n        }\n        to {\n          transform: rotateY(0) translateZ(0);\n          opacity: 1;\n        }\n      }\n\n      .tape-side.flip-out-left {\n        animation: flipOutLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;\n      }\n\n      .tape-side.flip-in-right {\n        animation: flipInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;\n      }\n\n      .tape-side.flip-out-right {\n        animation: flipOutRight 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;\n      }\n\n      .tape-side.flip-in-left {\n        animation: flipInLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;\n      }\n\n      /* 响应式 */\n      @media (max-width: 600px) {\n        .live-header {\n          padding: 40px 16px 16px;\n        }\n\n        .header-icon {\n          width: 36px;\n          height: 36px;\n        }\n\n        /* 移动端音量滑块调整 */\n        .music-volume-slider {\n          width: 80px;\n        }\n\n        .music-volume-container {\n          right: 45px;\n        }\n\n        /* 移动端悬浮面板调整 */\n        .control-sidebar {\n          width: 240px;\n          max-height: 380px;\n          right: 16px;\n          border-radius: 24px;\n        }\n\n        .sidebar-header {\n          padding: 20px 16px 14px;\n        }\n\n        .sidebar-content {\n          padding: 0 12px 16px;\n          gap: 8px;\n        }\n\n        .sidebar-item {\n          padding: 12px 14px;\n          border-radius: 16px;\n          gap: 10px;\n        }\n\n        .sidebar-item-icon {\n          width: 34px;\n          height: 34px;\n        }\n\n        .sidebar-title {\n          font-size: 14px;\n        }\n\n        .sidebar-close-btn {\n          width: 26px;\n          height: 26px;\n        }\n\n        .sidebar-item-title {\n          font-size: 13px;\n        }\n\n        .sidebar-item-subtitle {\n          font-size: 9px;\n        }\n\n        .live-content {\n          padding: 0 16px 0;\n        }\n\n        .cassette-player {\n          padding: 28px 16px 20px;\n        }\n\n        .cassette-reel {\n          width: 60px;\n          height: 60px;\n        }\n\n        .reel-inner {\n          width: 38px;\n          height: 38px;\n        }\n\n        .cassette-label {\n          padding: 7px 10px;\n        }\n\n        .cassette-title {\n          font-size: 11px;\n          letter-spacing: 1px;\n        }\n\n        .cassette-artist {\n          font-size: 8px;\n        }\n\n        .audio-visualizer {\n          height: 45px;\n          padding: 0 12px;\n        }\n\n        .speech-text-content {\n          font-size: 12px;\n        }\n\n        .cassette-window {\n          padding: 20px 16px 16px;\n        }\n\n        .cassette-window::before {\n          top: 10px;\n          left: 16px;\n          right: 16px;\n        }\n\n        .danmaku-section {\n          height: 160px;\n        }\n\n        .live-details,\n        .live-info-card {\n          padding: 14px 16px 14px 20px;\n        }\n\n        .danmaku-avatar {\n          width: 30px;\n          height: 30px;\n        }\n\n        .fixed-bottom-section {\n          padding: 16px 16px 16px;\n        }\n\n        .action-btn {\n          width: 40px;\n          height: 40px;\n        }\n\n        .input-box {\n          padding: 10px 16px;\n          font-size: 13px;\n        }\n\n        .interaction-bar {\n          padding: 12px 16px;\n        }\n\n        /* 榜单移动端调整 */\n        .leaderboard-panel {\n          width: 95%;\n          max-width: 360px;\n          bottom: 120px;\n        }\n\n        .leaderboard-header {\n          padding: 16px 16px 14px;\n        }\n\n        .leaderboard-title {\n          font-size: 11px;\n          letter-spacing: 1.2px;\n        }\n\n        .leaderboard-indicator {\n          font-size: 9px;\n          margin: 0 6px;\n        }\n\n        .leaderboard-arrow,\n        .leaderboard-close {\n          width: 26px;\n          height: 26px;\n        }\n\n        .leaderboard-arrow svg,\n        .leaderboard-close svg {\n          width: 12px;\n          height: 12px;\n        }\n\n        .leaderboard-content {\n          height: 350px;\n        }\n\n        .tape-side {\n          padding: 12px 16px;\n        }\n\n        .rank-item {\n          padding: 10px 12px;\n          margin-bottom: 6px;\n          gap: 10px;\n        }\n\n        .rank-medal {\n          width: 28px;\n          font-size: 14px;\n        }\n\n        .rank-item.top-3 .rank-medal {\n          font-size: 18px;\n        }\n\n        .rank-avatar {\n          width: 32px;\n          height: 32px;\n        }\n\n        .rank-name {\n          font-size: 12px;\n        }\n\n        .rank-value {\n          font-size: 12px;\n        }\n\n        .rank-badge {\n          font-size: 12px;\n        }\n      }\n\n      /* ============================================ */\n      /* 主播发言历史悬浮窗 */\n      /* ============================================ */\n      .speech-history-overlay {\n        position: fixed;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.75);\n        backdrop-filter: blur(8px);\n        -webkit-backdrop-filter: blur(8px);\n        display: flex;\n        align-items: flex-end;\n        justify-content: center;\n        z-index: 100000;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        padding-bottom: 80px;\n      }\n\n      .speech-history-overlay.active {\n        opacity: 1;\n      }\n\n      .speech-history-panel {\n        width: 90%;\n        max-width: 420px;\n        max-height: 70vh;\n        background: linear-gradient(\n          135deg,\n          rgba(35, 35, 37, 0.98),\n          rgba(25, 25, 27, 0.98)\n        );\n        border: 2px solid rgba(255, 255, 255, 0.12);\n        border-radius: 16px;\n        box-shadow: \n          0 20px 60px rgba(0, 0, 0, 0.7),\n          inset 0 1px 0 rgba(255, 255, 255, 0.06),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.5);\n        backdrop-filter: blur(30px);\n        -webkit-backdrop-filter: blur(30px);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        transform: translateY(100%);\n        transition: transform 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);\n        position: relative;\n      }\n\n      .speech-history-overlay.active .speech-history-panel {\n        transform: translateY(0);\n      }\n\n      /* 磁带螺丝装饰 */\n      .speech-cassette-screws {\n        position: absolute;\n        inset: 0;\n        pointer-events: none;\n        z-index: 10;\n      }\n\n      .speech-screw {\n        position: absolute;\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 35% 35%,\n          rgba(255, 255, 255, 0.18),\n          rgba(255, 255, 255, 0.06),\n          rgba(0, 0, 0, 0.1)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        box-shadow: \n          inset 0 1px 2px rgba(0, 0, 0, 0.5),\n          0 1px 1px rgba(255, 255, 255, 0.05);\n      }\n\n      .speech-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(45deg);\n        width: 4px;\n        height: 0.8px;\n        background: rgba(0, 0, 0, 0.6);\n      }\n\n      .speech-screw::after {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(-45deg);\n        width: 4px;\n        height: 0.8px;\n        background: rgba(0, 0, 0, 0.6);\n      }\n\n      /* 头部 - 磁带标签风格 */\n      .speech-history-header {\n        flex-shrink: 0;\n        background: linear-gradient(\n          180deg,\n          rgba(45, 45, 47, 0.8),\n          rgba(35, 35, 37, 0.6)\n        );\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        padding: 16px 18px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: 10px;\n        box-shadow: \n          0 2px 0 rgba(0, 0, 0, 0.3),\n          inset 0 1px 0 rgba(255, 255, 255, 0.04);\n        position: relative;\n        z-index: 2;\n      }\n\n      /* 磁带标签条 */\n      .speech-tape-label {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        min-width: 0;\n      }\n\n      .label-line {\n        flex: 1;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 3px,\n          rgba(255, 255, 255, 0.15) 3px,\n          rgba(255, 255, 255, 0.15) 6px\n        );\n      }\n\n      .label-text {\n        font-size: 11px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.7);\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        flex-shrink: 0;\n      }\n\n      /* 磁带计数器 */\n      .tape-counter {\n        padding: 4px 10px;\n        background: linear-gradient(\n          135deg,\n          rgba(20, 20, 22, 0.8),\n          rgba(15, 15, 17, 0.8)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        border-radius: 6px;\n        font-size: 9px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.6);\n        letter-spacing: 1px;\n        font-family: "Courier New", monospace;\n        flex-shrink: 0;\n        box-shadow: \n          inset 0 1px 3px rgba(0, 0, 0, 0.6),\n          0 1px 0 rgba(255, 255, 255, 0.05);\n      }\n\n      .speech-close-btn {\n        width: 26px;\n        height: 26px;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 6px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n        color: rgba(255, 255, 255, 0.6);\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);\n      }\n\n      .speech-close-btn:hover {\n        background: rgba(255, 255, 255, 0.1);\n        border-color: rgba(255, 255, 255, 0.15);\n        color: rgba(255, 255, 255, 0.9);\n        transform: translateY(-1px);\n      }\n\n      .speech-close-btn:active {\n        transform: translateY(0);\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n\n      /* 发言列表区域 - 歌词列表风格 */\n      .speech-history-list {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 0;\n        min-height: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 1px,\n          rgba(255, 255, 255, 0.01) 1px,\n          rgba(255, 255, 255, 0.01) 2px\n        );\n        position: relative;\n        z-index: 1;\n      }\n\n      .speech-history-list::-webkit-scrollbar {\n        width: 3px;\n      }\n\n      .speech-history-list::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      .speech-history-list::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.15);\n        border-radius: 2px;\n      }\n\n      .speech-history-list::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.25);\n      }\n\n      /* 歌曲轨道项 - 类似歌词列表 */\n      .speech-track-item {\n        display: flex;\n        align-items: flex-start;\n        padding: 12px 16px;\n        transition: all 0.2s ease;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.04);\n        position: relative;\n        background: transparent;\n      }\n\n      .speech-track-item:first-child {\n        border-top: 1px solid rgba(255, 255, 255, 0.04);\n      }\n\n      .speech-track-item:hover {\n        background: linear-gradient(\n          90deg,\n          rgba(255, 255, 255, 0.02),\n          transparent\n        );\n      }\n\n      .speech-track-item:hover .track-number {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.12),\n          rgba(255, 255, 255, 0.06)\n        );\n        border-color: rgba(255, 255, 255, 0.2);\n      }\n\n      .speech-track-item:hover .track-text {\n        color: rgba(255, 255, 255, 0.95);\n      }\n\n      /* 轨道编号 */\n      .track-number {\n        width: 28px;\n        min-width: 28px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.08),\n          rgba(255, 255, 255, 0.04)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        border-radius: 4px;\n        margin-right: 12px;\n        margin-top: 2px;\n        transition: all 0.2s ease;\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);\n      }\n\n      .track-number span {\n        font-size: 10px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.5);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.5px;\n      }\n\n      /* 轨道内容 */\n      .track-content {\n        flex: 1;\n        min-width: 0;\n        padding: 2px 0;\n      }\n\n      .track-text {\n        font-size: 12px;\n        line-height: 1.7;\n        color: rgba(255, 255, 255, 0.85);\n        font-weight: 500;\n        margin-bottom: 6px;\n        word-break: break-word;\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.2px;\n        transition: color 0.2s ease;\n      }\n\n      .track-time {\n        font-size: 9px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.35);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.8px;\n        text-transform: uppercase;\n      }\n\n      /* 轨道分隔线 */\n      .track-separator {\n        position: absolute;\n        bottom: 0;\n        left: 56px;\n        right: 16px;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.05) 2px,\n          rgba(255, 255, 255, 0.05) 4px\n        );\n        opacity: 0.5;\n      }\n\n      /* 底部磁带纹理 */\n      .tape-texture-bottom {\n        height: 20px;\n        background: linear-gradient(\n          180deg,\n          rgba(20, 20, 22, 0.6),\n          rgba(15, 15, 17, 0.8)\n        );\n        border-top: 1px solid rgba(255, 255, 255, 0.06);\n        box-shadow: \n          inset 0 1px 0 rgba(0, 0, 0, 0.3),\n          inset 0 2px 4px rgba(0, 0, 0, 0.4);\n        position: relative;\n        z-index: 2;\n      }\n\n      .tape-texture-bottom::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 20px;\n        right: 20px;\n        height: 2px;\n        transform: translateY(-50%);\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 4px,\n          rgba(255, 255, 255, 0.08) 4px,\n          rgba(255, 255, 255, 0.08) 8px\n        );\n      }\n\n      /* ============================================ */\n      /* 弹幕历史特有样式 - 磁带歌词列表风格 */\n      /* ============================================ */\n\n      /* 弹幕轨道项 - 类似歌词列表 */\n      .danmaku-track-item {\n        display: flex;\n        align-items: flex-start;\n        padding: 10px 16px;\n        transition: all 0.2s ease;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.04);\n        position: relative;\n        background: transparent;\n      }\n\n      .danmaku-track-item:first-child {\n        border-top: 1px solid rgba(255, 255, 255, 0.04);\n      }\n\n      .danmaku-track-item:hover {\n        background: linear-gradient(\n          90deg,\n          rgba(255, 255, 255, 0.03),\n          transparent\n        );\n      }\n\n      .danmaku-track-item:hover .track-number {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.12),\n          rgba(255, 255, 255, 0.06)\n        );\n        border-color: rgba(255, 255, 255, 0.2);\n      }\n\n      .danmaku-track-item:hover .track-username {\n        color: rgba(255, 255, 255, 0.95);\n      }\n\n      /* 用户发言高亮 - 柔和的金色 */\n      .danmaku-track-item.user-track {\n        background: linear-gradient(\n          90deg,\n          rgba(255, 230, 180, 0.04),\n          transparent\n        );\n        border-left: 2px solid rgba(255, 230, 180, 0.3);\n      }\n\n      .danmaku-track-item.user-track:hover {\n        background: linear-gradient(\n          90deg,\n          rgba(255, 230, 180, 0.06),\n          transparent\n        );\n      }\n\n      /* 用户轨道编号金色 */\n      .danmaku-track-item.user-track .track-number {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 230, 180, 0.15),\n          rgba(255, 230, 180, 0.08)\n        );\n        border-color: rgba(255, 230, 180, 0.3);\n      }\n\n      .danmaku-track-item.user-track:hover .track-number {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 230, 180, 0.2),\n          rgba(255, 230, 180, 0.12)\n        );\n        border-color: rgba(255, 230, 180, 0.4);\n      }\n\n      /* 用户头像金色边框 */\n      .danmaku-track-item.user-track .track-avatar {\n        border-color: rgba(255, 230, 180, 0.5);\n        box-shadow: 0 2px 10px rgba(255, 230, 180, 0.2),\n                    inset 0 1px 1px rgba(255, 255, 255, 0.15);\n      }\n\n      /* 用户名金色 */\n      .danmaku-track-item.user-track .track-username {\n        color: rgba(255, 230, 180, 0.9);\n        font-weight: 800;\n      }\n\n      /* 磁带轨道编号 - 复用主播发言历史样式 */\n      .danmaku-track-item .track-number {\n        width: 28px;\n        min-width: 28px;\n        height: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.08),\n          rgba(255, 255, 255, 0.04)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        border-radius: 4px;\n        margin-right: 10px;\n        margin-top: 2px;\n        transition: all 0.2s ease;\n        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);\n        flex-shrink: 0;\n      }\n\n      .danmaku-track-item .track-number span {\n        font-size: 10px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.5);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.5px;\n      }\n\n      /* 轨道头像 */\n      .track-avatar {\n        width: 32px;\n        min-width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        margin-right: 12px;\n        margin-top: 2px;\n        flex-shrink: 0;\n        border: 2px solid rgba(255, 255, 255, 0.15);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),\n                    inset 0 1px 1px rgba(255, 255, 255, 0.1);\n        overflow: hidden;\n        background: #000;\n        transition: all 0.2s ease;\n      }\n\n      .track-avatar img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        filter: brightness(0.95) contrast(1.05);\n      }\n\n      /* 轨道内容 */\n      .danmaku-track-item .track-content {\n        flex: 1;\n        min-width: 0;\n        padding: 2px 0;\n      }\n\n      .track-user-line {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        gap: 8px;\n        margin-bottom: 6px;\n      }\n\n      .track-username {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.6);\n        letter-spacing: 0.8px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        transition: color 0.2s ease;\n        flex-shrink: 0;\n      }\n\n      .danmaku-track-item .track-time {\n        font-size: 9px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.3);\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.8px;\n        text-transform: uppercase;\n        flex-shrink: 0;\n      }\n\n      .danmaku-track-item .track-text {\n        font-size: 12px;\n        line-height: 1.7;\n        color: rgba(255, 255, 255, 0.85);\n        font-weight: 500;\n        word-break: break-word;\n        font-family: "Courier New", monospace;\n        letter-spacing: 0.2px;\n        transition: color 0.2s ease;\n      }\n\n      .danmaku-track-item:hover .track-text {\n        color: rgba(255, 255, 255, 0.95);\n      }\n\n      /* 轨道分隔线 - 磁带感 */\n      .danmaku-track-item .track-separator {\n        position: absolute;\n        bottom: 0;\n        left: 52px;\n        right: 16px;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.05) 2px,\n          rgba(255, 255, 255, 0.05) 4px\n        );\n        opacity: 0.5;\n      }\n\n      /* 移动端适配 */\n      @media (max-width: 480px) {\n        .speech-history-panel {\n          width: 95%;\n          max-height: 70vh;\n          border-radius: 14px;\n        }\n\n        .speech-history-header {\n          padding: 14px 16px;\n        }\n\n        .label-text {\n          font-size: 10px;\n          letter-spacing: 1.2px;\n        }\n\n        .tape-counter {\n          font-size: 8px;\n          padding: 3px 8px;\n        }\n\n        .speech-close-btn {\n          width: 24px;\n          height: 24px;\n        }\n\n        .speech-close-btn svg {\n          width: 12px;\n          height: 12px;\n        }\n\n        .speech-track-item {\n          padding: 10px 14px;\n        }\n\n        .track-number {\n          width: 26px;\n          min-width: 26px;\n          height: 22px;\n          margin-right: 10px;\n        }\n\n        .track-number span {\n          font-size: 9px;\n        }\n\n        .track-text {\n          font-size: 11px;\n          margin-bottom: 5px;\n        }\n\n        .track-time {\n          font-size: 8px;\n        }\n\n        .track-separator {\n          left: 50px;\n        }\n\n        .tape-texture-bottom {\n          height: 18px;\n        }\n\n        .tape-texture-bottom::before {\n          left: 14px;\n          right: 14px;\n        }\n      }\n\n      /* ============================================ */\n      /* 语音连线悬浮屏 - 磁带播放器风格 */\n      /* ============================================ */\n\n      /* 右侧轮盘连线图标样式 */\n      .connection-icon-container {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: radial-gradient(circle, #2a2a2a, #1a1a1a);\n        transition: all 0.3s ease;\n      }\n\n      .connection-reel:hover .connection-icon-container {\n        background: radial-gradient(circle, #3a3a3a, #2a2a2a);\n        transform: scale(1.05);\n      }\n\n      .connection-reel:hover .connection-icon-container svg {\n        fill: #888;\n      }\n\n      /* 遮罩层 - 透明，不影响背景 */\n      .connection-dialog-overlay {\n        position: fixed;\n        inset: 0;\n        background: transparent;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n        z-index: 9996;\n      }\n\n      .connection-dialog-overlay.active {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 连线悬浮屏主体 - 从右侧滑入 */\n      .connection-dialog {\n        position: fixed;\n        right: -400px;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 90%;\n        max-width: 360px;\n        max-height: 80vh;\n        background: linear-gradient(135deg, \n          rgba(25, 25, 25, 0.98) 0%,\n          rgba(15, 15, 15, 0.98) 50%,\n          rgba(20, 20, 20, 0.98) 100%);\n        border: 2px solid rgba(100, 100, 100, 0.4);\n        border-radius: 16px;\n        box-shadow: \n          -8px 0 32px rgba(0, 0, 0, 0.8),\n          inset 0 1px 0 rgba(255, 255, 255, 0.08),\n          inset 0 -1px 2px rgba(0, 0, 0, 0.5);\n        z-index: 9997;\n        opacity: 0;\n        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      }\n\n      .connection-dialog.active {\n        right: 20px;\n        opacity: 1;\n      }\n\n      /* 磁带盒风格容器 */\n      .connection-cassette-container {\n        position: relative;\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      }\n\n      /* 磁带纹理背景 */\n      .connection-cassette-container::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        pointer-events: none;\n        z-index: 0;\n      }\n\n      /* 装饰螺丝 */\n      .connection-screws {\n        position: absolute;\n        inset: 0;\n        pointer-events: none;\n        z-index: 10;\n      }\n\n      .connection-screw {\n        position: absolute;\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        background: radial-gradient(\n          circle at 35% 35%,\n          rgba(255, 255, 255, 0.2),\n          rgba(255, 255, 255, 0.08),\n          rgba(0, 0, 0, 0.1)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.4),\n          0 1px 1px rgba(255, 255, 255, 0.05);\n      }\n\n      .connection-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(45deg);\n        width: 5px;\n        height: 1px;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .connection-screw.top-left {\n        top: 12px;\n        left: 12px;\n      }\n\n      .connection-screw.top-right {\n        top: 12px;\n        right: 12px;\n      }\n\n      .connection-screw.bottom-left {\n        bottom: 12px;\n        left: 12px;\n      }\n\n      .connection-screw.bottom-right {\n        bottom: 12px;\n        right: 12px;\n      }\n\n      /* 顶部标题区 - 磁带标签风格 */\n      .connection-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px 18px;\n        background: linear-gradient(180deg, \n          rgba(30, 30, 30, 0.95) 0%,\n          rgba(20, 20, 20, 0.95) 100%);\n        border-bottom: 2px solid rgba(100, 100, 100, 0.3);\n        position: relative;\n        z-index: 2;\n      }\n\n      .connection-title {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        font-family: \'Courier New\', monospace;\n        font-size: 11px;\n        font-weight: 900;\n        letter-spacing: 2px;\n        text-transform: uppercase;\n        color: rgba(200, 200, 200, 0.95);\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n      }\n\n      .connection-close-btn {\n        width: 26px;\n        height: 26px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 4px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        color: rgba(180, 180, 180, 0.8);\n      }\n\n      .connection-close-btn:hover {\n        background: rgba(255, 255, 255, 0.1);\n        border-color: rgba(255, 255, 255, 0.3);\n        color: rgba(220, 220, 220, 1);\n        transform: scale(1.05);\n      }\n\n      .connection-close-btn:active {\n        transform: scale(0.95);\n      }\n\n      /* 连线信息主体 */\n      .connection-body {\n        flex: 1;\n        padding: 20px 18px;\n        display: flex;\n        flex-direction: column;\n        gap: 18px;\n        overflow-y: auto;\n        position: relative;\n        z-index: 1;\n      }\n\n      /* LCD显示屏风格 - 等待队列 */\n      .connection-lcd-display {\n        background: rgba(8, 8, 8, 0.9);\n        border: 2px solid rgba(100, 100, 100, 0.5);\n        border-radius: 8px;\n        padding: 14px;\n        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.7);\n      }\n\n      .lcd-screen-border {\n        border: 1px solid rgba(100, 100, 100, 0.3);\n        border-radius: 4px;\n        padding: 12px;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      .lcd-screen-content {\n        text-align: center;\n      }\n\n      .connection-lcd-display .lcd-label {\n        font-size: 9px;\n        font-weight: 800;\n        letter-spacing: 2px;\n        color: rgba(150, 150, 150, 0.6);\n        font-family: \'Courier New\', monospace;\n        margin-bottom: 8px;\n      }\n\n      .connection-lcd-display .lcd-value {\n        font-size: 24px;\n        font-weight: 900;\n        letter-spacing: 2px;\n        color: rgba(200, 200, 200, 0.95);\n        font-family: \'Courier New\', monospace;\n        text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);\n        margin-bottom: 6px;\n      }\n\n      .connection-lcd-display .lcd-status {\n        font-size: 10px;\n        font-weight: 700;\n        color: rgba(150, 150, 150, 0.7);\n        font-family: \'Courier New\', monospace;\n        letter-spacing: 1px;\n      }\n\n      /* 磁带标签风格 - 连线门槛 */\n      .connection-threshold-panel {\n        background: linear-gradient(135deg, \n          rgba(35, 35, 35, 0.95) 0%,\n          rgba(25, 25, 25, 0.95) 50%,\n          rgba(30, 30, 30, 0.95) 100%);\n        border: 1px solid rgba(100, 100, 100, 0.3);\n        border-radius: 8px;\n        overflow: hidden;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);\n      }\n\n      .threshold-label-strip {\n        background: rgba(0, 0, 0, 0.4);\n        padding: 6px 12px;\n        border-bottom: 1px solid rgba(100, 100, 100, 0.2);\n      }\n\n      .strip-text {\n        font-size: 8px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        color: rgba(150, 150, 150, 0.6);\n        font-family: \'Courier New\', monospace;\n      }\n\n      .threshold-content {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 14px;\n      }\n\n      .threshold-icon {\n        flex-shrink: 0;\n        width: 32px;\n        height: 32px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: rgba(0, 0, 0, 0.4);\n        border: 1px solid rgba(100, 100, 100, 0.3);\n        border-radius: 6px;\n        color: rgba(180, 180, 180, 0.8);\n      }\n\n      .threshold-text {\n        flex: 1;\n        font-size: 12px;\n        font-weight: 600;\n        color: rgba(200, 200, 200, 0.9);\n        font-family: \'Courier New\', monospace;\n        letter-spacing: 0.5px;\n        line-height: 1.4;\n      }\n\n      /* 音轨线条装饰 */\n      .connection-tape-lines {\n        display: flex;\n        flex-direction: column;\n        gap: 3px;\n        padding: 0 20px;\n      }\n\n      .tape-line {\n        height: 1px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255, 255, 255, 0.1) 20%,\n          rgba(255, 255, 255, 0.1) 80%,\n          transparent\n        );\n      }\n\n      /* 连线按钮 - 复古按键风格 */\n      .connection-buttons {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      }\n\n      .connection-btn {\n        position: relative;\n        width: 100%;\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(70, 70, 70, 0.9),\n          rgba(40, 40, 40, 0.9)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 8px;\n        padding: 14px 20px;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: \n          0 3px 8px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.15),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.3);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 10px;\n      }\n\n      .connection-btn:hover {\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(80, 80, 80, 0.9),\n          rgba(50, 50, 50, 0.9)\n        );\n        border-color: rgba(255, 255, 255, 0.3);\n        transform: translateY(-1px);\n        box-shadow: \n          0 4px 12px rgba(0, 0, 0, 0.6),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .connection-btn:active {\n        transform: translateY(2px) scale(0.98);\n        box-shadow:\n          0 1px 3px rgba(0, 0, 0, 0.6),\n          inset 0 3px 6px rgba(0, 0, 0, 0.5);\n      }\n\n      /* 结束连线按钮 - 红色警示风格 */\n      .connection-btn.disconnect-btn {\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(140, 40, 40, 0.95),\n          rgba(100, 30, 30, 0.95)\n        );\n        border-color: rgba(180, 60, 60, 0.4);\n      }\n\n      .connection-btn.disconnect-btn:hover {\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(160, 45, 45, 0.95),\n          rgba(120, 35, 35, 0.95)\n        );\n        border-color: rgba(200, 70, 70, 0.5);\n      }\n\n      .connection-btn.disconnect-btn:active {\n        background: radial-gradient(\n          circle at 30% 30%,\n          rgba(120, 35, 35, 0.95),\n          rgba(90, 25, 25, 0.95)\n        );\n      }\n\n      .btn-led {\n        width: 6px;\n        height: 6px;\n        background: rgba(200, 200, 200, 0.8);\n        border-radius: 50%;\n        box-shadow: 0 0 6px rgba(255, 255, 255, 0.5);\n        animation: ledBlink 2s ease-in-out infinite;\n      }\n\n      @keyframes ledBlink {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.4; }\n      }\n\n      .btn-text {\n        font-family: \'Courier New\', monospace;\n        font-size: 11px;\n        font-weight: 900;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        color: rgba(220, 220, 220, 0.95);\n      }\n\n      .btn-shadow {\n        position: absolute;\n        bottom: 3px;\n        left: 20px;\n        right: 20px;\n        height: 1px;\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      /* 状态提示 - 小标签纸风格 */\n      .connection-status-tag {\n        position: relative;\n        background: rgba(240, 240, 230, 0.9);\n        border: 1px solid rgba(150, 130, 100, 0.5);\n        border-radius: 4px;\n        padding: 10px 14px;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n      }\n\n      .tag-corner {\n        position: absolute;\n        top: -1px;\n        right: -1px;\n        width: 0;\n        height: 0;\n        border-style: solid;\n        border-width: 0 12px 12px 0;\n        border-color: transparent rgba(150, 130, 100, 0.3) transparent transparent;\n      }\n\n      .tag-text {\n        font-family: \'Courier New\', monospace;\n        font-size: 11px;\n        font-weight: 600;\n        color: rgba(40, 40, 40, 0.85);\n        letter-spacing: 0.3px;\n        line-height: 1.4;\n        text-align: center;\n      }\n\n      /* 底部装饰条 */\n      .connection-footer-strip {\n        height: 8px;\n        background: linear-gradient(\n          90deg,\n          rgba(100, 100, 100, 0.2),\n          rgba(100, 100, 100, 0.1) 50%,\n          rgba(100, 100, 100, 0.2)\n        );\n        border-top: 1px solid rgba(100, 100, 100, 0.3);\n      }\n\n      /* 滑入动画 */\n      @keyframes connectionSlideIn {\n        from {\n          right: -400px;\n          opacity: 0;\n        }\n        to {\n          right: 20px;\n          opacity: 1;\n        }\n      }\n\n      /* ============================================ */\n      /* PK配置弹窗样式 - 街机风格 */\n      /* ============================================ */\n\n      /* 打卡机票据标签 - 黑灰风格 */\n      .pk-price-tag-container {\n        margin-top: 16px;\n        position: relative;\n        padding: 8px 0;\n      }\n\n      .price-tag {\n        background: linear-gradient(135deg,\n          rgba(25, 25, 25, 0.98) 0%,\n          rgba(20, 20, 20, 0.98) 100%);\n        border: 1px solid rgba(100, 100, 100, 0.4);\n        border-radius: 4px;\n        padding: 14px 16px 12px;\n        box-shadow:\n          0 3px 8px rgba(0, 0, 0, 0.4),\n          inset 0 1px 0 rgba(255, 255, 255, 0.08);\n        position: relative;\n        transform: rotate(-0.5deg);\n        transition: transform 0.3s ease;\n      }\n\n      .price-tag:hover {\n        transform: rotate(0deg);\n      }\n\n      /* 顶部机械打孔 */\n      .tag-perforation {\n        position: absolute;\n        top: 4px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 10px;\n      }\n\n      .tag-perforation::before,\n      .tag-perforation::after {\n        content: \'\';\n        width: 5px;\n        height: 5px;\n        background: rgba(0, 0, 0, 0.5);\n        border-radius: 50%;\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.6);\n      }\n\n      /* 标签内容 */\n      .tag-content {\n        position: relative;\n        padding-top: 8px;\n      }\n\n      /* 机械矩形印章 */\n      .tag-stamp {\n        position: absolute;\n        top: -6px;\n        right: -6px;\n        width: 50px;\n        height: 28px;\n        background: linear-gradient(135deg,\n          rgba(140, 40, 40, 0.92) 0%,\n          rgba(120, 35, 35, 0.95) 100%);\n        border: 2px solid rgba(100, 30, 30, 0.8);\n        border-radius: 2px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 10px;\n        font-weight: 900;\n        color: rgba(255, 255, 255, 0.95);\n        letter-spacing: 1.5px;\n        transform: rotate(-8deg);\n        box-shadow:\n          0 3px 6px rgba(0, 0, 0, 0.4),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.4);\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n        position: relative;\n      }\n\n      /* 印章锯齿边 */\n      .tag-stamp::before {\n        content: \'\';\n        position: absolute;\n        inset: -1px;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent 0px,\n          transparent 2px,\n          rgba(100, 30, 30, 0.5) 2px,\n          rgba(100, 30, 30, 0.5) 3px\n        );\n        pointer-events: none;\n      }\n\n      /* 商品名称 */\n      .tag-item-name {\n        font-size: 13px;\n        font-weight: 800;\n        color: rgba(200, 200, 200, 0.9);\n        margin-bottom: 6px;\n        font-family: \'Courier New\', monospace;\n        letter-spacing: 0.5px;\n      }\n\n      /* 划掉的原价 */\n      .tag-crossed-price {\n        font-size: 10px;\n        font-weight: 600;\n        color: rgba(150, 150, 150, 0.6);\n        text-decoration: line-through;\n        margin-bottom: 6px;\n        font-family: \'Courier New\', monospace;\n      }\n\n      /* 价格行 */\n      .tag-price-row {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n        padding: 4px 0;\n        border-top: 1px dashed rgba(100, 100, 100, 0.3);\n        border-bottom: 1px dashed rgba(100, 100, 100, 0.3);\n      }\n\n      .tag-price-label {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(180, 180, 180, 0.8);\n        font-family: \'Courier New\', monospace;\n      }\n\n      .tag-price-value {\n        font-size: 18px;\n        font-weight: 900;\n        color: rgba(220, 60, 60, 0.95);\n        font-family: \'Courier New\', monospace;\n        letter-spacing: 0.5px;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n\n      /* 笑面狐备注 */\n      .tag-vendor-note {\n        font-size: 9px;\n        font-weight: 600;\n        color: rgba(160, 160, 160, 0.75);\n        line-height: 1.5;\n        margin-bottom: 8px;\n        font-family: \'Courier New\', monospace;\n        font-style: italic;\n      }\n\n      /* 签名 */\n      .tag-signature {\n        font-size: 10px;\n        font-weight: 600;\n        color: rgba(150, 150, 150, 0.7);\n        text-align: right;\n        font-family: \'Courier New\', monospace;\n      }\n\n      .signature-emoji {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(160, 160, 160, 0.8);\n      }\n\n      /* 钉子装饰 */\n      .tag-pin {\n        position: absolute;\n        top: -4px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 8px;\n        height: 8px;\n        background: radial-gradient(circle,\n          rgba(180, 180, 190, 0.9) 0%,\n          rgba(140, 140, 150, 0.95) 100%);\n        border-radius: 50%;\n        box-shadow:\n          0 2px 4px rgba(0, 0, 0, 0.3),\n          inset 0 1px 1px rgba(255, 255, 255, 0.5),\n          inset 0 -1px 1px rgba(0, 0, 0, 0.3);\n      }\n\n      .tag-pin::before {\n        content: \'\';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 3px;\n        height: 3px;\n        background: rgba(100, 100, 110, 0.8);\n        border-radius: 50%;\n      }\n\n      /* PK配置表单 */\n      .pk-config-panel {\n        margin-bottom: 16px;\n      }\n\n      .pk-config-field {\n        margin-bottom: 14px;\n      }\n\n      .pk-field-label {\n        display: flex;\n        align-items: center;\n        font-size: 10px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.75);\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        margin-bottom: 6px;\n        font-family: \'Courier New\', monospace;\n      }\n\n      .pk-field-input-group {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .pk-input {\n        flex: 1;\n        background: rgba(10, 10, 10, 0.6);\n        border: 1px solid rgba(100, 100, 100, 0.4);\n        border-radius: 6px;\n        padding: 10px 12px;\n        color: rgba(255, 255, 255, 0.9);\n        font-size: 13px;\n        font-family: \'Courier New\', monospace;\n        transition: all 0.25s ease;\n      }\n\n      .pk-input:focus {\n        outline: none;\n        border-color: rgba(255, 140, 60, 0.6);\n        background: rgba(15, 15, 15, 0.8);\n        box-shadow: 0 0 0 2px rgba(255, 140, 60, 0.2);\n      }\n\n      .pk-input::placeholder {\n        color: rgba(255, 255, 255, 0.3);\n        font-size: 11px;\n      }\n\n      .pk-input-unit {\n        font-size: 11px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.6);\n        letter-spacing: 1px;\n        font-family: \'Courier New\', monospace;\n      }\n\n      .pk-textarea {\n        width: 100%;\n        background: rgba(10, 10, 10, 0.6);\n        border: 1px solid rgba(100, 100, 100, 0.4);\n        border-radius: 6px;\n        padding: 10px 12px;\n        color: rgba(255, 255, 255, 0.9);\n        font-size: 13px;\n        font-family: \'Courier New\', monospace;\n        resize: vertical;\n        transition: all 0.25s ease;\n      }\n\n      .pk-textarea:focus {\n        outline: none;\n        border-color: rgba(255, 140, 60, 0.6);\n        background: rgba(15, 15, 15, 0.8);\n        box-shadow: 0 0 0 2px rgba(255, 140, 60, 0.2);\n      }\n\n      .pk-textarea::placeholder {\n        color: rgba(255, 255, 255, 0.3);\n        font-size: 11px;\n      }\n\n      /* ============================================ */\n      /* PK准备中弹窗 - 16bit RPG + CRT TV 风格 */\n      /* ============================================ */\n\n      .pk-preparing-modal {\n        position: fixed;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.85);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 99999;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n      }\n\n      .pk-preparing-modal.active {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* CRT电视机外壳 */\n    .pk-crt-tv {\n      position: relative;\n      width: 300px;\n      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);\n      border: 3px solid #1a1a1a;\n      border-radius: 12px;\n      box-shadow:\n        0 0 0 1px #2a2a2a,\n        0 16px 48px rgba(0, 0, 0, 0.9),\n        inset 0 1px 2px rgba(255, 255, 255, 0.05);\n      animation: tvStaticShake 0.15s infinite, modalEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    @keyframes tvStaticShake {\n      0%, 100% { transform: translate(0, 0); }\n      25% { transform: translate(0.2px, -0.1px); }\n      50% { transform: translate(-0.1px, 0.2px); }\n      75% { transform: translate(0.1px, 0.1px); }\n    }\n\n    @keyframes modalEntrance {\n      0% {\n        transform: scale(0.3);\n        filter: blur(10px);\n        opacity: 0;\n      }\n      100% {\n        transform: scale(1);\n        filter: blur(0);\n        opacity: 1;\n      }\n    }\n\n    /* 四角像素螺栓 */\n    .pk-crt-bolts {\n      position: absolute;\n      inset: 0;\n      pointer-events: none;\n      z-index: 10;\n    }\n\n    .pk-bolt {\n      position: absolute;\n      width: 8px;\n      height: 8px;\n      background:\n        repeating-linear-gradient(90deg, #2a2a2a 0px, #2a2a2a 3px, #3a3a3a 3px, #3a3a3a 6px),\n        repeating-linear-gradient(0deg, #2a2a2a 0px, #2a2a2a 3px, #3a3a3a 3px, #3a3a3a 6px);\n      border: 1px solid #1a1a1a;\n      box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.8);\n    }\n\n    .pk-bolt.top-left { top: 3px; left: 3px; }\n    .pk-bolt.top-right { top: 3px; right: 3px; }\n    .pk-bolt.bottom-left { bottom: 3px; left: 3px; }\n    .pk-bolt.bottom-right { bottom: 3px; right: 3px; }\n\n    /* CRT屏幕 */\n    .pk-crt-screen {\n      position: relative;\n      margin: 16px;\n      padding: 16px 14px;\n      background: #0a0a0a;\n      border: 2px solid #2a2a2a;\n      border-radius: 3px;\n      overflow: hidden;\n      box-shadow: inset 0 0 16px rgba(0, 0, 0, 0.9);\n    }\n\n    /* 扫描线 */\n    .pk-crt-screen::before {\n      content: "";\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent 0px,\n        rgba(255, 255, 255, 0.03) 1px,\n        transparent 2px,\n        transparent 3px\n      );\n      pointer-events: none;\n      z-index: 100;\n      animation: scanlineMove 8s linear infinite;\n    }\n\n    @keyframes scanlineMove {\n      0% { transform: translateY(0); }\n      100% { transform: translateY(100%); }\n    }\n\n    /* 噪点闪烁 */\n    .pk-crt-screen::after {\n      content: "";\n      position: absolute;\n      inset: 0;\n      background: rgba(255, 255, 255, 0.02);\n      pointer-events: none;\n      z-index: 99;\n      animation: noiseFlicker 0.08s steps(4, end) infinite;\n    }\n\n    @keyframes noiseFlicker {\n      0%, 100% { opacity: 0.1; }\n      50% { opacity: 0.15; }\n    }\n\n    /* CRT开机闪烁效果 */\n    @keyframes crtFlicker {\n      0%, 10%, 20%, 30%, 40%, 50% {\n        opacity: 0;\n        filter: brightness(0);\n      }\n      8%, 18%, 28%, 38%, 48%, 100% {\n        opacity: 1;\n        filter: brightness(1);\n      }\n    }\n\n    .pk-preparing-modal.active .pk-crt-screen {\n      animation: crtFlicker 0.48s steps(2, end);\n    }\n\n    /* 菱形网格背景 */\n    .pk-background-grid {\n      position: absolute;\n      inset: -50%;\n      background-image:\n        repeating-linear-gradient(45deg, transparent, transparent 20px, rgba(40, 40, 40, 0.15) 20px, rgba(40, 40, 40, 0.15) 21px),\n        repeating-linear-gradient(-45deg, transparent, transparent 20px, rgba(40, 40, 40, 0.15) 20px, rgba(40, 40, 40, 0.15) 21px);\n      pointer-events: none;\n      animation: gridScroll 20s linear infinite;\n    }\n\n    @keyframes gridScroll {\n      0% { transform: translate(0, 0); }\n      100% { transform: translate(40px, 40px); }\n    }\n\n    /* 像素噪点层 */\n    .pk-pixel-noise {\n      position: absolute;\n      inset: 0;\n      pointer-events: none;\n      opacity: 0.4;\n      z-index: 5;\n    }\n\n    /* 战斗区域 */\n    .pk-battle-arena {\n      position: relative;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 10px;\n      margin-bottom: 14px;\n      z-index: 10;\n    }\n\n    /* 战士卡片 */\n    .pk-fighter-card {\n      flex: 1;\n      opacity: 0;\n      transform: translateY(-15px);\n    }\n\n    .pk-fighter-card.fighter-red {\n      animation: fighterEntrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s forwards;\n    }\n\n    .pk-fighter-card.fighter-blue {\n      animation: fighterEntrance 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s forwards;\n    }\n\n    @keyframes fighterEntrance {\n      0% {\n        opacity: 0;\n        transform: translateY(-15px);\n      }\n      100% {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    /* 像素边框 - 优化为更轻量的风格 */\n    .pk-fighter-frame {\n      position: relative;\n      padding: 5px;\n      background: #1a1a1a;\n      border: 1px solid #3a3a3a;\n      box-shadow:\n        0 0 0 1px #2a2a2a,\n        inset 0 0 6px rgba(0, 0, 0, 0.8),\n        0 3px 8px rgba(0, 0, 0, 0.6);\n    }\n\n    /* 添加八边形装饰角 */\n    .pk-fighter-frame::before {\n      content: \'\';\n      position: absolute;\n      inset: -1px;\n      background: repeating-linear-gradient(\n        90deg,\n        transparent 0px,\n        transparent 2px,\n        rgba(255, 255, 255, 0.03) 2px,\n        rgba(255, 255, 255, 0.03) 4px\n      );\n      pointer-events: none;\n      z-index: -1;\n    }\n\n    .fighter-red .pk-fighter-frame {\n      border-color: #4a3a3a;\n      animation: pixelBorderBlinkRed 0.8s steps(2, end) infinite;\n    }\n\n    .fighter-blue .pk-fighter-frame {\n      border-color: #3a3a4a;\n      animation: pixelBorderBlinkBlue 0.8s steps(2, end) infinite;\n    }\n\n    @keyframes pixelBorderBlinkRed {\n      0%, 100% {\n        border-color: #4a3a3a;\n        box-shadow: 0 0 0 1px #3a2a2a, inset 0 0 6px rgba(0, 0, 0, 0.8), 0 3px 8px rgba(0, 0, 0, 0.6);\n      }\n      50% {\n        border-color: #5a4a4a;\n        box-shadow: 0 0 0 1px #4a3a3a, inset 0 0 6px rgba(80, 40, 40, 0.3), 0 3px 10px rgba(80, 40, 40, 0.4);\n      }\n    }\n\n    @keyframes pixelBorderBlinkBlue {\n      0%, 100% {\n        border-color: #3a3a4a;\n        box-shadow: 0 0 0 1px #2a2a3a, inset 0 0 6px rgba(0, 0, 0, 0.8), 0 3px 8px rgba(0, 0, 0, 0.6);\n      }\n      50% {\n        border-color: #4a4a5a;\n        box-shadow: 0 0 0 1px #3a3a4a, inset 0 0 6px rgba(40, 40, 80, 0.3), 0 3px 10px rgba(40, 40, 80, 0.4);\n      }\n    }\n\n    /* 战士头像 - 八边形剪裁 */\n    .pk-fighter-avatar {\n      width: 48px;\n      height: 48px;\n      margin: 0 auto 5px;\n      position: relative;\n      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);\n      background: #0a0a0a;\n      overflow: hidden;\n    }\n\n    .pk-fighter-avatar::after {\n      content: \'\';\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent 0px,\n        transparent 2px,\n        rgba(255, 255, 255, 0.02) 2px,\n        rgba(255, 255, 255, 0.02) 4px\n      );\n      pointer-events: none;\n      z-index: 2;\n    }\n\n    .pk-fighter-avatar img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n      image-rendering: pixelated;\n      image-rendering: crisp-edges;\n      filter: contrast(1.05);\n    }\n\n    /* 战士名称（打字机效果） */\n    .pk-fighter-name {\n      font-size: 9px;\n      text-align: center;\n      color: #909090;\n      letter-spacing: 0.8px;\n      text-transform: uppercase;\n      font-weight: bold;\n      white-space: nowrap;\n      overflow: hidden;\n      max-width: 0;\n      margin: 0 auto;\n      text-shadow: 1px 1px 0 #000;\n    }\n\n    .fighter-red .pk-fighter-name {\n      animation: typewriterName 1.2s steps(12, end) 0.6s forwards;\n    }\n\n    .fighter-blue .pk-fighter-name {\n      animation: typewriterName 1.2s steps(12, end) 0.8s forwards;\n    }\n\n    @keyframes typewriterName {\n      0% { max-width: 0; }\n      100% { max-width: 80px; }\n    }\n\n    /* 中央VS分隔 - 优化为更小的图标 */\n    .pk-battle-divider {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 2px;\n    }\n\n    .pk-lightning {\n      width: 18px;\n      height: 36px;\n      color: #606060;\n      filter: drop-shadow(0 0 3px rgba(96, 96, 96, 0.6));\n      animation: lightningFlash 1.6s steps(4, end) infinite;\n    }\n\n    @keyframes lightningFlash {\n      0%, 75% { opacity: 0.4; }\n      80%, 85% { opacity: 1; color: #808080; }\n      90%, 100% { opacity: 0.4; }\n    }\n\n    .pk-battle-arrows {\n      display: flex;\n      gap: 6px;\n    }\n\n    .pk-arrow {\n      font-size: 8px;\n      color: #505050;\n      animation: arrowPulse 1.2s ease-in-out infinite;\n    }\n\n    .pk-arrow.left {\n      animation-delay: 0s;\n    }\n\n    .pk-arrow.right {\n      animation-delay: 0.6s;\n    }\n\n    @keyframes arrowPulse {\n      0%, 100% { opacity: 0.3; transform: scale(0.8); }\n      50% { opacity: 0.9; transform: scale(1.1); color: #707070; }\n    }\n\n    /* 状态文本 */\n    .pk-status-text {\n      position: relative;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 3px;\n      margin-bottom: 12px;\n      z-index: 10;\n    }\n\n    .pk-status-typing {\n      font-size: 10px;\n      color: #808080;\n      letter-spacing: 1.5px;\n      text-transform: uppercase;\n      white-space: nowrap;\n      overflow: hidden;\n      max-width: 0;\n      animation: typewriterStatus 1.5s steps(20, end) 1s forwards;\n      text-shadow: 1px 1px 0 #000;\n    }\n\n    @keyframes typewriterStatus {\n      0% { max-width: 0; }\n      100% { max-width: 240px; }\n    }\n\n    .pk-status-cursor {\n      font-size: 10px;\n      color: #808080;\n      opacity: 0;\n      animation: cursorBlink 0.8s steps(2, end) 1s infinite;\n    }\n\n    @keyframes cursorBlink {\n      0%, 100% { opacity: 0; }\n      50% { opacity: 1; }\n    }\n\n    /* 能量条容器 */\n    .pk-energy-bar-container {\n      position: relative;\n      z-index: 10;\n    }\n\n    .pk-energy-track {\n      position: relative;\n      height: 12px;\n      background: #0a0a0a;\n      border: 1px solid #3a3a3a;\n      border-radius: 1px;\n      overflow: hidden;\n      box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.9);\n      margin-bottom: 6px;\n    }\n\n    /* 像素块容器 */\n    .pk-energy-pixels {\n      display: flex;\n      height: 100%;\n      gap: 1px;\n      padding: 1px;\n    }\n\n    /* 单个像素块 */\n    .pk-energy-pixel {\n      flex: 1;\n      background: #1a1a1a;\n      opacity: 0.25;\n      transform: scale(0.85);\n      transition: none;\n    }\n\n    .pk-energy-pixel.filled {\n      opacity: 1;\n      transform: scale(1);\n      animation: pixelFillup 0.15s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;\n      background: linear-gradient(180deg,\n        #5a4a4a 0%,\n        #4a3a3a 50%,\n        #3a2a3a 100%);\n      box-shadow:\n        inset 0 1px 1px rgba(255, 255, 255, 0.1),\n        0 0 6px rgba(80, 60, 60, 0.5);\n    }\n\n    @keyframes pixelFillup {\n      0% {\n        transform: scale(0.85);\n        opacity: 0.25;\n      }\n      50% {\n        transform: scale(1.1);\n      }\n      100% {\n        transform: scale(1);\n        opacity: 1;\n      }\n    }\n\n    /* 百分比显示 */\n    .pk-energy-percentage {\n      font-size: 10px;\n      text-align: center;\n      color: #707070;\n      letter-spacing: 1.5px;\n      font-weight: bold;\n      text-shadow: 0 0 6px rgba(112, 112, 112, 0.4);\n    }\n\n    /* ========================================\n       PK系统 - 嵌入式设计（磁带复古风格）\n       ======================================== */\n\n    /* PK专用字体 - ZSFT-dc */\n    @font-face {\n      font-family: \'ZSFT-dc\';\n      src: url(\'https://fontsapi.zeoseven.com/dc/main.woff2\') format(\'woff2\'),\n           url(\'https://fontsapi-storage.zeoseven.com/dc/main.woff2\') format(\'woff2\');\n      font-style: normal;\n      font-weight: 400;\n      font-display: swap;\n    }\n\n    /* === 1. PK积分条（80年代LED对战风格）=== */\n    .pk-score-bar {\n      width: 100%;\n      height: 10px;\n      background: rgba(0, 0, 0, 0.8);\n      border-radius: 2px;\n      position: relative;\n      overflow: hidden;\n      box-shadow:\n        inset 0 1px 3px rgba(0, 0, 0, 1),\n        0 1px 0 rgba(255, 255, 255, 0.15);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n    }\n\n    /* 主播积分填充（亮白光芒）*/\n    .pk-score-fill-streamer {\n      position: absolute;\n      left: 0;\n      top: 0;\n      height: 100%;\n      background: linear-gradient(\n        90deg,\n        rgba(255, 255, 255, 1) 0%,\n        rgba(255, 255, 255, 0.95) 100%\n      );\n      border-radius: 2px 0 0 2px;\n      transition: width 0.6s ease-out;\n      box-shadow: 0 0 12px rgba(255, 255, 255, 0.8);\n      position: relative;\n    }\n\n    /* 主播侧扫描线（领先时显示）*/\n    .pk-score-fill-streamer::after {\n      content: "";\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: repeating-linear-gradient(\n        90deg,\n        transparent,\n        transparent 3px,\n        rgba(255, 255, 255, 0.3) 3px,\n        rgba(255, 255, 255, 0.3) 6px\n      );\n      opacity: 0;\n      animation: pkScanFlow 1.2s linear infinite;\n      transition: opacity 0.2s;\n    }\n\n    .pk-score-fill-streamer.leading::after {\n      opacity: 1;\n    }\n\n    @keyframes pkScanFlow {\n      0% { transform: translateX(-6px); }\n      100% { transform: translateX(0); }\n    }\n\n    /* 用户积分填充（深黑对抗）*/\n    .pk-score-fill-user {\n      position: absolute;\n      right: 0;\n      top: 0;\n      height: 100%;\n      background: linear-gradient(\n        270deg,\n        rgba(26, 26, 26, 1) 0%,\n        rgba(42, 42, 42, 0.95) 100%\n      );\n      border-radius: 0 2px 2px 0;\n      transition: width 0.6s ease-out;\n      box-shadow: 0 0 12px rgba(0, 0, 0, 0.9);\n      position: relative;\n    }\n\n    /* 用户侧扫描线（领先时显示）*/\n    .pk-score-fill-user::after {\n      content: "";\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: repeating-linear-gradient(\n        270deg,\n        transparent,\n        transparent 3px,\n        rgba(255, 255, 255, 0.15) 3px,\n        rgba(255, 255, 255, 0.15) 6px\n      );\n      opacity: 0;\n      animation: pkScanFlow 1.2s linear infinite;\n      transition: opacity 0.2s;\n    }\n\n    .pk-score-fill-user.leading::after {\n      opacity: 1;\n    }\n\n    /* 中线警戒效果 */\n    .pk-score-center {\n      position: absolute;\n      left: 50%;\n      top: 0;\n      bottom: 0;\n      width: 2px;\n      transform: translateX(-50%);\n      background: #FF3333;\n      box-shadow: 0 0 6px rgba(255, 51, 51, 0.8);\n      z-index: 5;\n      animation: pkCenterPulse 1.5s ease-in-out infinite;\n    }\n\n    @keyframes pkCenterPulse {\n      0%, 100% {\n        opacity: 0.6;\n        box-shadow: 0 0 6px rgba(255, 51, 51, 0.6);\n      }\n      50% {\n        opacity: 1;\n        box-shadow: 0 0 12px rgba(255, 51, 51, 1);\n      }\n    }\n\n    /* === 2. 转盘上方积分数字（LCD数字风格）=== */\n    .pk-reel-score {\n      position: absolute;\n      z-index: 20;\n      opacity: 0;\n      visibility: hidden;\n      transition: opacity 0.3s ease, visibility 0.3s ease;\n      pointer-events: none;\n      text-align: center;\n      top: -12px; /* 轮盘正上方 */\n    }\n\n    /* 主播积分定位（左侧轮盘） */\n    .pk-reel-score.streamer {\n      left: 35px; /* 轮盘半径，指向轮盘中心 */\n      transform: translateX(-50%); /* 中心对齐 */\n    }\n\n    /* 用户积分定位（右侧轮盘） */\n    .pk-reel-score.user {\n      right: 35px; /* 轮盘半径，指向轮盘中心 */\n      transform: translateX(50%); /* 中心对齐 */\n    }\n\n    .pk-reel-score.active {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    /* 积分容器 */\n    .pk-score-display {\n      /* 无背景，直接显示数字 */\n    }\n\n    /* 积分数字 - LCD数字显示 */\n    .pk-score-number {\n      font-size: 32px;\n      font-weight: 400;\n      font-family: \'ZSFT-dc\', \'Courier New\', monospace;\n      letter-spacing: 2px;\n      line-height: 1;\n      transition: none;\n      display: inline-block;\n      position: relative;\n    }\n\n    /* 主播分数颜色 - 亮白发光 */\n    .pk-reel-score.streamer .pk-score-number {\n      color: #FFFFFF;\n      text-shadow:\n        0 0 10px rgba(255, 255, 255, 1),\n        0 0 20px rgba(255, 255, 255, 0.8),\n        0 0 30px rgba(255, 255, 255, 0.5),\n        0 2px 4px rgba(0, 0, 0, 0.8);\n    }\n\n    /* 用户分数颜色 - 深灰对抗 */\n    .pk-reel-score.user .pk-score-number {\n      color: #333333;\n      text-shadow:\n        0 0 8px rgba(0, 0, 0, 0.8),\n        0 0 16px rgba(0, 0, 0, 0.5),\n        0 1px 2px rgba(255, 255, 255, 0.2);\n    }\n\n    /* 分数变化动画 - 震动+闪烁（LCD翻页效果）*/\n    .pk-score-number.changing {\n      animation: pkScoreChange 0.3s steps(3) 1;\n    }\n\n    @keyframes pkScoreChange {\n      0%, 100% {\n        transform: scale(1) translateY(0);\n        opacity: 1;\n      }\n      33% {\n        transform: scale(1.2) translateY(-2px);\n        opacity: 0.8;\n      }\n      66% {\n        transform: scale(0.9) translateY(2px);\n        opacity: 0.9;\n      }\n    }\n\n    /* 领先方闪烁效果 - 像素闪烁 */\n    .pk-score-number.leading {\n      animation: pkScoreLead 1.5s steps(2) infinite;\n    }\n\n    @keyframes pkScoreLead {\n      0%, 100% {\n        opacity: 1;\n      }\n      50% {\n        opacity: 0.75;\n      }\n    }\n\n    /* === 3. 倒计时（LCD显示风格）=== */\n    .pk-timer-replacement {\n      font-size: 14px;\n      font-family: \'ZSFT-dc\', \'Courier New\', monospace;\n      font-weight: 400;\n      color: rgba(255, 255, 255, 0.9);\n      letter-spacing: 2px;\n      text-shadow:\n        0 0 6px rgba(255, 255, 255, 0.6),\n        0 1px 2px rgba(0, 0, 0, 0.8);\n      animation: pkTimerBlink 2s steps(2) infinite;\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 3;\n      white-space: nowrap;\n      opacity: 0;\n      visibility: hidden;\n      transition: opacity 0.3s ease, visibility 0.3s ease;\n      pointer-events: none;\n    }\n\n    .pk-timer-replacement.active {\n      opacity: 1;\n      visibility: visible;\n    }\n\n    @keyframes pkTimerBlink {\n      0%, 100% { opacity: 1; }\n      50% { opacity: 0.85; }\n    }\n\n    /* 紧急状态（<10秒）- LCD红色警告闪烁 */\n    .pk-timer-replacement.urgent {\n      color: #FF3333 !important;\n      animation: pkTimerUrgent 0.4s steps(2) infinite;\n    }\n\n    @keyframes pkTimerUrgent {\n      0%, 100% {\n        opacity: 1;\n        text-shadow:\n          0 0 8px rgba(255, 51, 51, 0.9),\n          0 1px 2px rgba(0, 0, 0, 0.8);\n      }\n      50% {\n        opacity: 0.5;\n        text-shadow:\n          0 0 4px rgba(255, 51, 51, 0.6),\n          0 1px 2px rgba(0, 0, 0, 0.8);\n      }\n    }\n\n    /* === 隐藏原始元素的类 === */\n    .pk-hidden {\n      opacity: 0 !important;\n      visibility: hidden !important;\n      pointer-events: none !important;\n    }\n\n    /* === 启动和退场动画（80年代简洁风格）=== */\n\n    /* 进度条启动 - 快速拉伸 */\n    @keyframes pkBarReplace {\n      0% {\n        opacity: 0;\n        transform: scaleX(0.3) scaleY(0.5);\n      }\n      60% {\n        opacity: 1;\n        transform: scaleX(1.05) scaleY(1.1);\n      }\n      100% {\n        opacity: 1;\n        transform: scaleX(1) scaleY(1);\n      }\n    }\n\n    /* 倒计时启动 - 闪现放大 */\n    @keyframes pkTimerFadeIn {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.7);\n      }\n      50% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1.1);\n      }\n      100% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n      }\n    }\n\n    /* 进度条退场 - 快速收缩 */\n    @keyframes pkBarExit {\n      0% {\n        opacity: 1;\n        transform: scaleX(1) scaleY(1);\n      }\n      100% {\n        opacity: 0;\n        transform: scaleX(0.3) scaleY(0.3);\n      }\n    }\n\n    /* 积分数字退场 - 淡出缩小 */\n    /* 主播积分退场（左侧） */\n    @keyframes pkScoreExitStreamer {\n      0% {\n        opacity: 1;\n        transform: translateX(-50%) translateY(0) scale(1);\n      }\n      100% {\n        opacity: 0;\n        transform: translateX(-50%) translateY(-20px) scale(0.6);\n      }\n    }\n\n    /* 用户积分退场（右侧） */\n    @keyframes pkScoreExitUser {\n      0% {\n        opacity: 1;\n        transform: translateX(50%) translateY(0) scale(1);\n      }\n      100% {\n        opacity: 0;\n        transform: translateX(50%) translateY(-20px) scale(0.6);\n      }\n    }\n\n    /* 倒计时退场 - LCD关闭效果 */\n    @keyframes pkTimerExit {\n      0% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scaleY(1);\n      }\n      50% {\n        opacity: 0.5;\n        transform: translate(-50%, -50%) scaleY(0.1);\n      }\n      100% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scaleY(0);\n      }\n    }\n\n    /* 移动端适配 */\n    @media (max-width: 480px) {\n      .pk-score-number {\n        font-size: 24px;\n      }\n\n      .pk-timer-replacement {\n        font-size: 12px;\n        letter-spacing: 1.5px;\n      }\n\n      .pk-reel-score {\n        top: -8px; /* 移动端轮盘60px，积分值位置调整 */\n      }\n\n      /* 移动端轮盘中心位置调整（轮盘半径30px） */\n      .pk-reel-score.streamer {\n        left: 30px; /* 移动端轮盘半径 */\n      }\n\n      .pk-reel-score.user {\n        right: 30px; /* 移动端轮盘半径 */\n      }\n    }\n\n    /* ==================== PK结束弹窗样式 - 全新设计（像素猫咪/黑胶唱片/交叉匕首） ==================== */\n\n    /* 遮罩层 */\n    .pk-modal-overlay {\n      position: fixed;\n      inset: 0;\n      background: rgba(0, 0, 0, 0.75);\n      backdrop-filter: blur(4px);\n      opacity: 0;\n      pointer-events: none;\n      z-index: 99998;\n      transition: opacity 0.3s ease;\n    }\n\n    .pk-modal-overlay.active {\n      opacity: 1;\n      pointer-events: all;\n    }\n\n    /* ============================================ */\n    /* 🏆 PK胜利弹窗 - 像素猫咪风格（黑+灰粉配色） */\n    /* ============================================ */\n    .pk-victory-modal {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0);\n      width: 240px;\n      background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);\n      border-radius: 12px;\n      border: 3px solid #3a3a3a;\n      box-shadow:\n        0 0 0 1px rgba(242,228,233,0.15),\n        0 20px 60px rgba(0,0,0,0.9),\n        0 0 30px rgba(253,226,228,0.15),\n        inset 0 1px 0 rgba(242,228,233,0.1),\n        inset 0 -1px 0 rgba(0,0,0,0.7);\n      opacity: 0;\n      pointer-events: none;\n      z-index: 99999;\n      overflow: hidden;\n    }\n\n    .pk-victory-modal.active {\n      animation: victoryRise 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;\n    }\n\n    @keyframes victoryRise {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) translateY(100px) scale(0.6);\n        filter: brightness(0.4);\n      }\n      50% {\n        opacity: 1;\n        transform: translate(-50%, -50%) translateY(-10px) scale(1.08);\n        filter: brightness(1.2);\n      }\n      100% {\n        opacity: 1;\n        transform: translate(-50%, -50%) translateY(0) scale(1);\n        filter: brightness(1);\n      }\n    }\n\n    /* 像素星星背景 */\n    .victory-stars {\n      position: absolute;\n      inset: 0;\n      overflow: hidden;\n      pointer-events: none;\n    }\n\n    .pixel-star {\n      position: absolute;\n      width: 6px;\n      height: 6px;\n      background: #fff;\n      box-shadow:\n        0 0 8px rgba(255,255,255,0.9),\n        0 0 4px rgba(255,255,255,0.6);\n      animation: starTwinkle 1.5s ease-in-out infinite;\n      image-rendering: pixelated;\n    }\n\n    .pixel-star::before,\n    .pixel-star::after {\n      content: \'\';\n      position: absolute;\n      background: #fff;\n    }\n\n    /* 十字星形状 */\n    .pixel-star::before {\n      top: -4px;\n      left: 3px;\n      width: 2px;\n      height: 16px;\n    }\n\n    .pixel-star::after {\n      top: 3px;\n      left: -4px;\n      width: 16px;\n      height: 2px;\n    }\n\n    @keyframes starTwinkle {\n      0%, 100% { opacity: 0.3; transform: scale(0.8); }\n      50% { opacity: 1; transform: scale(1.2); }\n    }\n\n    .victory-content {\n      position: relative;\n      padding: 24px 20px 20px;\n      z-index: 1;\n    }\n\n    /* 像素猫咪 */\n    .pixel-cat-container {\n      display: flex;\n      justify-content: center;\n      margin-bottom: 16px;\n    }\n\n    .pixel-cat {\n      width: 80px;\n      height: 70px;\n      position: relative;\n      image-rendering: pixelated;\n      animation: catBounce 1.5s ease-in-out infinite;\n    }\n\n    @keyframes catBounce {\n      0%, 100% { transform: translateY(0); }\n      50% { transform: translateY(-6px); }\n    }\n\n    /* 猫头 */\n    .cat-head {\n      position: absolute;\n      top: 0;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 48px;\n      height: 40px;\n      background: #f2e4e9;\n      border-radius: 50%;\n      box-shadow:\n        inset 2px 2px 0 rgba(255,255,255,0.6),\n        inset -2px -2px 0 rgba(200,180,190,0.4),\n        0 4px 12px rgba(0,0,0,0.4);\n    }\n\n    /* 猫耳朵 */\n    .cat-ear {\n      position: absolute;\n      top: -8px;\n      width: 16px;\n      height: 20px;\n      background: #f2e4e9;\n      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n      box-shadow: inset 0 2px 0 rgba(255,255,255,0.4);\n    }\n\n    .cat-ear.left {\n      left: 4px;\n      transform: rotate(-15deg);\n    }\n\n    .cat-ear.right {\n      right: 4px;\n      transform: rotate(15deg);\n    }\n\n    .cat-ear-inner {\n      position: absolute;\n      bottom: 4px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 8px;\n      height: 10px;\n      background: #fde2e4;\n      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n    }\n\n    /* 猫眼睛 */\n    .cat-eyes {\n      position: absolute;\n      top: 16px;\n      left: 50%;\n      transform: translateX(-50%);\n      display: flex;\n      gap: 12px;\n    }\n\n    .cat-eye {\n      width: 10px;\n      height: 10px;\n      background: #1a1a1a;\n      border-radius: 50%;\n      position: relative;\n      animation: catBlink 3s ease-in-out infinite;\n    }\n\n    @keyframes catBlink {\n      0%, 45%, 55%, 100% {\n        height: 10px;\n        border-radius: 50%;\n      }\n      50% {\n        height: 2px;\n        border-radius: 2px;\n      }\n    }\n\n    .cat-eye::after {\n      content: \'\';\n      position: absolute;\n      top: 2px;\n      left: 2px;\n      width: 4px;\n      height: 4px;\n      background: #fff;\n      border-radius: 50%;\n      opacity: 0.8;\n    }\n\n    /* 猫鼻子 */\n    .cat-nose {\n      display: none;\n    }\n\n    /* 猫嘴巴 */\n    .cat-mouth {\n      position: absolute;\n      top: 32px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 16px;\n      height: 6px;\n    }\n\n    .cat-mouth::before,\n    .cat-mouth::after {\n      content: \'\';\n      position: absolute;\n      top: 0;\n      width: 8px;\n      height: 6px;\n      border-bottom: 2px solid #c0a0a8;\n      border-radius: 0 0 50% 50%;\n    }\n\n    .cat-mouth::before {\n      left: 0;\n    }\n\n    .cat-mouth::after {\n      right: 0;\n    }\n\n    /* 像素光环 */\n    .pixel-glow {\n      position: absolute;\n      top: -10px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 100px;\n      height: 100px;\n      background: radial-gradient(circle,\n        rgba(253, 226, 228, 0.4) 0%,\n        rgba(242, 228, 233, 0.2) 30%,\n        transparent 70%);\n      animation: glowPulse 1.5s ease-in-out infinite;\n      pointer-events: none;\n    }\n\n    @keyframes glowPulse {\n      0%, 100% { opacity: 0.5; transform: translateX(-50%) scale(1); }\n      50% { opacity: 0.9; transform: translateX(-50%) scale(1.15); }\n    }\n\n    /* 标题 */\n    .victory-title {\n      text-align: center;\n      font-family: \'Courier New\', monospace;\n      font-size: 20px;\n      font-weight: 900;\n      color: #fde2e4;\n      letter-spacing: 3px;\n      text-shadow:\n        2px 2px 0 rgba(0,0,0,0.7),\n        0 0 12px rgba(253,226,228,0.6),\n        0 0 20px rgba(242,228,233,0.4);\n      margin-bottom: 14px;\n      animation: titleGlitch 3s linear infinite;\n    }\n\n    @keyframes titleGlitch {\n      0%, 98% {\n        text-shadow:\n          2px 2px 0 rgba(0,0,0,0.7),\n          0 0 12px rgba(253,226,228,0.6),\n          0 0 20px rgba(242,228,233,0.4);\n      }\n      99% {\n        text-shadow:\n          -2px 2px 0 rgba(253,226,228,0.5),\n          2px -2px 0 rgba(242,228,233,0.5);\n      }\n      100% {\n        text-shadow:\n          2px 2px 0 rgba(0,0,0,0.7),\n          0 0 12px rgba(253,226,228,0.6),\n          0 0 20px rgba(242,228,233,0.4);\n      }\n    }\n\n    /* 分数显示 - 像素LCD风格 */\n    .victory-score-display {\n      background: rgba(10, 10, 10, 0.95);\n      border: 2px solid #3a3a3a;\n      border-radius: 6px;\n      padding: 10px 16px;\n      margin-bottom: 12px;\n      box-shadow:\n        inset 0 2px 6px rgba(0,0,0,0.9),\n        0 1px 0 rgba(242,228,233,0.15),\n        0 0 12px rgba(253,226,228,0.1);\n    }\n\n    .score-row {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      font-family: \'Courier New\', monospace;\n      font-size: 16px;\n      font-weight: 700;\n      color: #a0b0c0;\n      margin-bottom: 6px;\n    }\n\n    .score-row:last-child {\n      margin-bottom: 0;\n    }\n\n    .score-label {\n      font-size: 11px;\n      color: #606870;\n      letter-spacing: 1px;\n    }\n\n    .score-value {\n      font-size: 20px;\n      color: #fde2e4;\n      text-shadow: 0 0 10px rgba(253,226,228,0.6);\n      animation: scoreCount 0.5s ease-out;\n    }\n\n    @keyframes scoreCount {\n      0% { transform: scale(1.5); opacity: 0; }\n      100% { transform: scale(1); opacity: 1; }\n    }\n\n    /* 8-bit按钮 */\n    .victory-close-btn {\n      width: 100%;\n      padding: 10px;\n      background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%);\n      border: 2px solid #f2e4e9;\n      color: #fde2e4;\n      font-family: \'Courier New\', monospace;\n      font-size: 14px;\n      font-weight: 700;\n      letter-spacing: 1px;\n      cursor: pointer;\n      position: relative;\n      box-shadow:\n        0 0 0 2px rgba(0,0,0,0.5),\n        inset 0 2px 0 rgba(242,228,233,0.2),\n        inset 0 -2px 0 rgba(0,0,0,0.6),\n        0 4px 0 #1a1a1a,\n        0 8px 20px rgba(0,0,0,0.6),\n        0 0 16px rgba(253,226,228,0.15);\n      transition: all 0.1s;\n      image-rendering: pixelated;\n    }\n\n    .victory-close-btn:hover {\n      background: linear-gradient(145deg, #4a4a4a 0%, #3a3a3a 100%);\n      transform: translateY(-2px);\n      box-shadow:\n        0 0 0 2px rgba(0,0,0,0.5),\n        inset 0 2px 0 rgba(242,228,233,0.3),\n        inset 0 -2px 0 rgba(0,0,0,0.6),\n        0 6px 0 #1a1a1a,\n        0 10px 24px rgba(0,0,0,0.7),\n        0 0 20px rgba(253,226,228,0.25);\n    }\n\n    .victory-close-btn:active {\n      transform: translateY(2px);\n      box-shadow:\n        0 0 0 2px rgba(0,0,0,0.5),\n        inset 0 2px 0 rgba(242,228,233,0.2),\n        inset 0 -2px 0 rgba(0,0,0,0.6),\n        0 2px 0 #1a1a1a,\n        0 4px 12px rgba(0,0,0,0.5),\n        0 0 12px rgba(253,226,228,0.1);\n    }\n\n    /* 像素粒子效果 */\n    .pixel-particles {\n      position: absolute;\n      inset: 0;\n      pointer-events: none;\n      overflow: hidden;\n    }\n\n    .pixel-particle {\n      position: absolute;\n      width: 4px;\n      height: 4px;\n      background: #fde2e4;\n      box-shadow: 0 0 6px rgba(253,226,228,0.9);\n      animation: particleFloat 2s ease-out forwards;\n      image-rendering: pixelated;\n    }\n\n    @keyframes particleFloat {\n      0% {\n        opacity: 1;\n        transform: translateY(0) translateX(0) scale(1);\n      }\n      100% {\n        opacity: 0;\n        transform: translateY(-100px) translateX(var(--x-offset)) scale(0);\n      }\n    }\n\n    /* ============================================ */\n    /* 💔 PK失败弹窗 - 黑胶唱片破碎风格 */\n    /* ============================================ */\n    .pk-defeat-modal {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0);\n      width: 200px;\n      height: 200px;\n      opacity: 0;\n      pointer-events: none;\n      z-index: 99999;\n      perspective: 600px;\n    }\n\n    .pk-defeat-modal.active {\n      animation: defeatAppear 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;\n    }\n\n    @keyframes defeatAppear {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.3) rotateZ(-180deg);\n      }\n      60% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1.1) rotateZ(10deg);\n      }\n      100% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1) rotateZ(0deg);\n      }\n    }\n\n    /* 黑胶唱片 */\n    .vinyl-record {\n      position: relative;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background:\n        radial-gradient(circle at 30% 30%, #2a2a2a 0%, #1a1a1a 30%, #0a0a0a 100%);\n      box-shadow:\n        0 0 0 8px #1a1a1a,\n        0 0 0 10px #0a0a0a,\n        0 16px 48px rgba(0,0,0,0.9),\n        inset 0 2px 8px rgba(255,255,255,0.1),\n        inset 0 -2px 8px rgba(0,0,0,0.8);\n      animation: vinylSpin 2s linear;\n    }\n\n    @keyframes vinylSpin {\n      0% { transform: rotateZ(0deg); }\n      100% { transform: rotateZ(360deg); }\n    }\n\n    /* 唱片纹理 */\n    .vinyl-grooves {\n      position: absolute;\n      inset: 20px;\n      border-radius: 50%;\n      background: repeating-radial-gradient(\n        circle,\n        transparent 0px,\n        transparent 2px,\n        rgba(255,255,255,0.03) 2px,\n        rgba(255,255,255,0.03) 3px\n      );\n      opacity: 0.6;\n    }\n\n    /* 唱片中心标签 */\n    .vinyl-label {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      background:\n        radial-gradient(circle at 35% 35%, #3a3a3a 0%, #2a2a2a 50%, #1a1a1a 100%);\n      border: 2px solid #4a4a4a;\n      box-shadow:\n        0 0 0 2px #2a2a2a,\n        0 4px 12px rgba(0,0,0,0.8),\n        inset 0 2px 4px rgba(255,255,255,0.1),\n        inset 0 -2px 4px rgba(0,0,0,0.6);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: \'Courier New\', monospace;\n      font-size: 9px;\n      font-weight: 700;\n      color: rgba(255,255,255,0.4);\n      letter-spacing: 1px;\n    }\n\n    /* 中心孔 */\n    .vinyl-hole {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 12px;\n      height: 12px;\n      border-radius: 50%;\n      background: #000;\n      box-shadow:\n        inset 0 2px 4px rgba(0,0,0,0.9),\n        0 0 0 1px #1a1a1a;\n    }\n\n    /* 破碎裂纹 */\n    .crack-container {\n      position: absolute;\n      inset: 0;\n      border-radius: 50%;\n      overflow: hidden;\n      opacity: 0;\n      animation: crackReveal 0.4s ease-out 1s forwards;\n    }\n\n    @keyframes crackReveal {\n      0% { opacity: 0; }\n      100% { opacity: 1; }\n    }\n\n    .crack-line {\n      position: absolute;\n      background: linear-gradient(90deg,\n        transparent 0%,\n        rgba(255,255,255,0.8) 50%,\n        transparent 100%);\n      transform-origin: center;\n      box-shadow:\n        0 0 4px rgba(255,255,255,0.6),\n        0 0 8px rgba(255,255,255,0.3);\n      animation: crackGrow 0.5s ease-out forwards;\n    }\n\n    @keyframes crackGrow {\n      0% {\n        width: 0;\n        opacity: 0;\n      }\n      100% {\n        width: 100%;\n        opacity: 1;\n      }\n    }\n\n    /* 主裂纹 */\n    .crack-line.main {\n      top: 50%;\n      left: 0;\n      height: 3px;\n      width: 100%;\n      animation: crackGrow 0.5s ease-out 1s forwards;\n    }\n\n    /* 分支裂纹 */\n    .crack-line.branch {\n      top: 50%;\n      left: 30%;\n      height: 2px;\n      width: 50%;\n      transform: rotate(-35deg);\n      animation: crackGrow 0.4s ease-out 1.1s forwards;\n    }\n\n    .crack-line.branch2 {\n      top: 50%;\n      left: 50%;\n      height: 2px;\n      width: 40%;\n      transform: rotate(45deg);\n      animation: crackGrow 0.3s ease-out 1.2s forwards;\n    }\n\n    /* 失败文字浮层 */\n    .defeat-overlay {\n      position: absolute;\n      inset: 0;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      pointer-events: none;\n      opacity: 0;\n      animation: textFadeIn 0.5s ease-out 1.5s forwards;\n    }\n\n    @keyframes textFadeIn {\n      0% { opacity: 0; transform: scale(0.8); }\n      100% { opacity: 1; transform: scale(1); }\n    }\n\n    .defeat-text {\n      font-family: \'Courier New\', monospace;\n      font-size: 24px;\n      font-weight: 900;\n      color: rgba(255,255,255,0.9);\n      text-shadow:\n        0 0 8px rgba(255,255,255,0.8),\n        2px 2px 0 rgba(0,0,0,0.8);\n      letter-spacing: 3px;\n      margin-bottom: 8px;\n    }\n\n    .defeat-score {\n      font-family: \'Courier New\', monospace;\n      font-size: 12px;\n      color: rgba(255,255,255,0.6);\n      text-shadow: 0 1px 2px rgba(0,0,0,0.8);\n    }\n\n    /* 碎片飞散效果 */\n    .shard-container {\n      position: absolute;\n      inset: 0;\n      pointer-events: none;\n      opacity: 0;\n      animation: shardAppear 0.1s ease-out 1s forwards;\n    }\n\n    @keyframes shardAppear {\n      0% { opacity: 0; }\n      100% { opacity: 1; }\n    }\n\n    .shard {\n      position: absolute;\n      background: linear-gradient(135deg, #2a2a2a 0%, #0a0a0a 100%);\n      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);\n      box-shadow:\n        0 2px 8px rgba(0,0,0,0.8),\n        inset 0 1px 0 rgba(255,255,255,0.1);\n      animation: shardFly 1s ease-out forwards;\n    }\n\n    @keyframes shardFly {\n      0% {\n        opacity: 1;\n        transform: translate(0, 0) rotate(0deg) scale(1);\n      }\n      100% {\n        opacity: 0;\n        transform: translate(var(--fly-x), var(--fly-y)) rotate(var(--fly-rotate)) scale(0.3);\n      }\n    }\n\n    /* ============================================ */\n    /* ⚔️ PK平局弹窗 - 交叉匕首风格（精致版） */\n    /* ============================================ */\n    .pk-draw-modal {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0);\n      width: 220px;\n      height: 200px;\n      background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);\n      border-radius: 12px;\n      border: 2px solid #3a3a3a;\n      box-shadow:\n        0 0 0 1px rgba(192,192,192,0.1),\n        0 20px 60px rgba(0,0,0,0.9),\n        0 0 30px rgba(192,192,192,0.08),\n        inset 0 1px 0 rgba(255,255,255,0.08),\n        inset 0 -1px 0 rgba(0,0,0,0.7);\n      opacity: 0;\n      pointer-events: none;\n      z-index: 99999;\n      overflow: hidden;\n    }\n\n    .pk-draw-modal.active {\n      animation: swordsAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;\n    }\n\n    @keyframes swordsAppear {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);\n      }\n      100% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1) rotate(0deg);\n      }\n    }\n\n    /* 交叉匕首容器 */\n    .crossed-daggers {\n      position: relative;\n      width: 100%;\n      height: 100%;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      padding: 16px;\n    }\n\n    /* 背景装饰圆环 */\n    .dagger-ring {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 100px;\n      height: 100px;\n      border: 2px solid rgba(192,192,192,0.15);\n      border-radius: 50%;\n      box-shadow:\n        0 0 20px rgba(192,192,192,0.1),\n        inset 0 0 20px rgba(0,0,0,0.5);\n    }\n\n    /* 匕首 */\n    .dagger {\n      position: absolute;\n      width: 130px;\n      height: 20px;\n      top: 50%;\n      left: 50%;\n      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));\n    }\n\n    .dagger.left {\n      transform: translate(-50%, -50%) rotate(-45deg);\n      animation: daggerSlashLeft 0.8s ease-out 0.3s both;\n    }\n\n    .dagger.right {\n      transform: translate(-50%, -50%) rotate(45deg);\n      animation: daggerSlashRight 0.8s ease-out 0.3s both;\n    }\n\n    @keyframes daggerSlashLeft {\n      0% {\n        transform: translate(-150%, -50%) rotate(-45deg);\n        opacity: 0;\n      }\n      60% {\n        transform: translate(-40%, -50%) rotate(-45deg);\n        opacity: 1;\n      }\n      100% {\n        transform: translate(-50%, -50%) rotate(-45deg);\n        opacity: 1;\n      }\n    }\n\n    @keyframes daggerSlashRight {\n      0% {\n        transform: translate(50%, -50%) rotate(45deg);\n        opacity: 0;\n      }\n      60% {\n        transform: translate(-60%, -50%) rotate(45deg);\n        opacity: 1;\n      }\n      100% {\n        transform: translate(-50%, -50%) rotate(45deg);\n        opacity: 1;\n      }\n    }\n\n    /* 匕首刀刃 - 更精致的金属质感 */\n    .dagger-blade {\n      position: absolute;\n      right: 0;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 85px;\n      height: 10px;\n      background: linear-gradient(180deg,\n        #4a4a4a 0%,\n        #8a8a8a 15%,\n        #d0d0d0 30%,\n        #f0f0f0 45%,\n        #d0d0d0 55%,\n        #9a9a9a 70%,\n        #6a6a6a 85%,\n        #4a4a4a 100%);\n      clip-path: polygon(0 50%, 8% 10%, 100% 20%, 100% 80%, 8% 90%);\n      box-shadow:\n        inset 0 1px 0 rgba(255,255,255,0.9),\n        inset 0 -1px 0 rgba(0,0,0,0.6);\n    }\n\n    /* 刀刃边缘高光 */\n    .blade-edge {\n      position: absolute;\n      top: 0;\n      right: 0;\n      width: 85px;\n      height: 1px;\n      background: linear-gradient(90deg, transparent 10%, rgba(255,255,255,0.95) 50%, rgba(255,255,255,0.8) 100%);\n    }\n\n    /* 刀刃流动光泽 */\n    .blade-shine {\n      position: absolute;\n      top: 3px;\n      left: 10%;\n      width: 80%;\n      height: 3px;\n      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.95), transparent);\n      animation: bladeGlint 2.5s ease-in-out infinite;\n      border-radius: 1px;\n    }\n\n    @keyframes bladeGlint {\n      0%, 100% { opacity: 0.2; transform: translateX(-30%); }\n      50% { opacity: 0.9; transform: translateX(30%); }\n    }\n\n    /* 匕首护手 - 精致金属 */\n    .dagger-guard {\n      position: absolute;\n      right: 83px;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 8px;\n      height: 20px;\n      background: linear-gradient(180deg, #c9a961 0%, #a68a3e 30%, #7a6020 70%, #5a4010 100%);\n      border-radius: 3px;\n      box-shadow:\n        inset 1px 0 0 rgba(255,255,255,0.5),\n        inset -1px 0 0 rgba(0,0,0,0.5),\n        0 2px 4px rgba(0,0,0,0.6);\n    }\n\n    /* 护手装饰 */\n    .guard-detail {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 4px;\n      height: 12px;\n      background: linear-gradient(180deg, #d4b36a, #8a6a2a);\n      border-radius: 1px;\n      box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);\n    }\n\n    /* 匕首握柄 - 皮革质感 */\n    .dagger-handle {\n      position: absolute;\n      left: 0;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 40px;\n      height: 14px;\n      background: linear-gradient(180deg, #4a3a28 0%, #3a2a18 30%, #2a1a08 50%, #3a2a18 70%, #4a3a28 100%);\n      border-radius: 4px;\n      box-shadow:\n        inset 0 2px 0 rgba(255,255,255,0.15),\n        inset 0 -2px 0 rgba(0,0,0,0.6),\n        0 3px 8px rgba(0,0,0,0.7);\n    }\n\n    /* 握柄缠绕 - 皮革带 */\n    .handle-wrap {\n      position: absolute;\n      top: 50%;\n      transform: translateY(-50%) skewX(-15deg);\n      width: 5px;\n      height: 12px;\n      background: linear-gradient(90deg, #3a2a18, #5a4a38, #3a2a18);\n      border-radius: 1px;\n      box-shadow:\n        inset 0 1px 0 rgba(255,255,255,0.1),\n        inset 0 -1px 0 rgba(0,0,0,0.4);\n    }\n\n    .handle-wrap:nth-child(1) { left: 6px; }\n    .handle-wrap:nth-child(2) { left: 16px; }\n    .handle-wrap:nth-child(3) { left: 26px; }\n\n    /* 匕首柄头 - 精致金属球 */\n    .dagger-pommel {\n      position: absolute;\n      left: -8px;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 12px;\n      height: 12px;\n      background: radial-gradient(circle at 35% 35%, #d4b36a 0%, #a68a3e 40%, #7a6020 70%, #5a4010 100%);\n      border-radius: 50%;\n      box-shadow:\n        inset 0 2px 4px rgba(255,255,255,0.4),\n        inset 0 -2px 4px rgba(0,0,0,0.6),\n        0 2px 6px rgba(0,0,0,0.7);\n    }\n\n    /* 柄头高光点 */\n    .pommel-shine {\n      position: absolute;\n      top: 3px;\n      left: 3px;\n      width: 4px;\n      height: 4px;\n      background: rgba(255,255,255,0.7);\n      border-radius: 50%;\n      filter: blur(1px);\n    }\n\n    /* 碰撞中心光晕 */\n    .clash-glow {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 30px;\n      height: 30px;\n      background: radial-gradient(circle, rgba(255,200,100,0.8) 0%, transparent 70%);\n      border-radius: 50%;\n      opacity: 0;\n      animation: glowBurst 0.5s ease-out 0.8s both;\n    }\n\n    @keyframes glowBurst {\n      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }\n      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }\n      100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }\n    }\n\n    /* 碰撞火花 */\n    .clash-sparks {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 40px;\n      height: 40px;\n      opacity: 0;\n      animation: sparksBurst 0.6s ease-out 0.85s both;\n    }\n\n    @keyframes sparksBurst {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.3);\n      }\n      30% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1.2);\n      }\n      100% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(1.5);\n      }\n    }\n\n    .spark {\n      position: absolute;\n      width: 3px;\n      height: 3px;\n      background: #ffd700;\n      border-radius: 50%;\n      box-shadow:\n        0 0 6px rgba(255,215,0,0.9),\n        0 0 12px rgba(255,165,0,0.6);\n      animation: sparkFly 0.8s ease-out forwards;\n    }\n\n    @keyframes sparkFly {\n      0% {\n        transform: translate(0, 0) scale(1);\n        opacity: 1;\n      }\n      100% {\n        transform: translate(var(--spark-x), var(--spark-y)) scale(0);\n        opacity: 0;\n      }\n    }\n\n    /* 平局标题 */\n    .draw-title {\n      position: absolute;\n      top: 16px;\n      left: 50%;\n      transform: translateX(-50%);\n      font-family: \'Courier New\', monospace;\n      font-size: 16px;\n      font-weight: 900;\n      color: #d0d0d0;\n      letter-spacing: 4px;\n      text-shadow:\n        2px 2px 0 rgba(0,0,0,0.8),\n        0 0 10px rgba(192,192,192,0.4);\n      animation: titleFade 0.5s ease-out 1.2s both;\n    }\n\n    @keyframes titleFade {\n      0% { opacity: 0; transform: translateX(-50%) scale(0.8); }\n      100% { opacity: 1; transform: translateX(-50%) scale(1); }\n    }\n\n    /* 分数显示 */\n    .draw-scores {\n      position: absolute;\n      bottom: 16px;\n      left: 50%;\n      transform: translateX(-50%);\n      display: flex;\n      gap: 16px;\n      animation: scoresSlide 0.5s ease-out 1.4s both;\n    }\n\n    @keyframes scoresSlide {\n      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }\n      100% { opacity: 1; transform: translateX(-50%) translateY(0); }\n    }\n\n    .draw-score-box {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 3px;\n      background: linear-gradient(145deg, #1a1a1a, #0a0a0a);\n      padding: 8px 14px;\n      border-radius: 6px;\n      border: 1px solid #3a3a3a;\n      box-shadow:\n        inset 0 2px 4px rgba(0,0,0,0.9),\n        0 2px 8px rgba(0,0,0,0.6),\n        0 0 0 1px rgba(255,255,255,0.05);\n    }\n\n    .draw-score-label {\n      font-family: \'Courier New\', monospace;\n      font-size: 9px;\n      font-weight: 700;\n      color: #808080;\n      letter-spacing: 1px;\n    }\n\n    .draw-score-value {\n      font-family: \'Courier New\', monospace;\n      font-size: 18px;\n      font-weight: 900;\n      color: #e0e0e0;\n      text-shadow: 0 0 10px rgba(255,255,255,0.3);\n    }\n\n    /* 响应式 */\n    @media (max-width: 600px) {\n      .pk-victory-modal {\n        width: 220px;\n      }\n\n      .pk-defeat-modal {\n        width: 180px;\n        height: 180px;\n      }\n\n      .pk-draw-modal {\n        width: 200px;\n        height: 180px;\n      }\n    }\n\n      /* 被踢出弹窗样式 - 磁带盒风格 */\n      .kicked-modal-overlay {\n        position: fixed;\n        inset: 0;\n        background: rgba(0, 0, 0, 0.75);\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n        z-index: 99998;\n      }\n\n      .kicked-modal-overlay.active {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .kicked-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(0.85);\n        width: 90%;\n        max-width: 360px;\n        background: linear-gradient(135deg,\n          rgba(25, 25, 25, 0.98) 0%,\n          rgba(15, 15, 15, 0.98) 50%,\n          rgba(20, 20, 20, 0.98) 100%);\n        border: 2px solid rgba(80, 80, 80, 0.6);\n        border-radius: 8px;\n        box-shadow:\n          0 16px 48px rgba(0, 0, 0, 0.9),\n          inset 0 1px 0 rgba(255, 255, 255, 0.05),\n          inset 0 -1px 2px rgba(0, 0, 0, 0.5);\n        z-index: 99999;\n        opacity: 0;\n        pointer-events: none;\n        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .kicked-modal.active {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n        pointer-events: all;\n      }\n\n      /* 磁带盒容器 */\n      .kicked-cassette-container {\n        position: relative;\n        padding: 20px 24px;\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n\n      /* 磁带纹理背景 */\n      .kicked-cassette-container::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.02) 2px,\n          rgba(255, 255, 255, 0.02) 4px\n        );\n        pointer-events: none;\n        border-radius: 8px;\n      }\n\n      /* 装饰螺丝 */\n      .kicked-screws {\n        position: absolute;\n        inset: 0;\n        pointer-events: none;\n        z-index: 10;\n      }\n\n      .kicked-screw {\n        position: absolute;\n        width: 10px;\n        height: 10px;\n        background: radial-gradient(circle,\n          rgba(60, 60, 60, 0.9) 0%,\n          rgba(40, 40, 40, 0.9) 50%,\n          rgba(30, 30, 30, 0.9) 100%);\n        border: 1px solid rgba(80, 80, 80, 0.5);\n        border-radius: 50%;\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.8);\n      }\n\n      .kicked-screw::before {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 6px;\n        height: 1px;\n        background: rgba(80, 80, 80, 0.8);\n      }\n\n      .kicked-screw::after {\n        content: "";\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) rotate(90deg);\n        width: 6px;\n        height: 1px;\n        background: rgba(80, 80, 80, 0.8);\n      }\n\n      .kicked-screw.top-left {\n        top: 8px;\n        left: 8px;\n      }\n\n      .kicked-screw.top-right {\n        top: 8px;\n        right: 8px;\n      }\n\n      .kicked-screw.bottom-left {\n        bottom: 8px;\n        left: 8px;\n      }\n\n      .kicked-screw.bottom-right {\n        bottom: 8px;\n        right: 8px;\n      }\n\n      /* 顶部装饰条 */\n      .kicked-header-strip {\n        height: 4px;\n        background: repeating-linear-gradient(\n          90deg,\n          rgba(80, 50, 50, 0.4) 0px,\n          rgba(80, 50, 50, 0.4) 4px,\n          rgba(60, 40, 40, 0.4) 4px,\n          rgba(60, 40, 40, 0.4) 8px\n        );\n        border-radius: 2px;\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);\n      }\n\n      /* LED警告指示灯 */\n      .kicked-led-panel {\n        display: flex;\n        justify-content: center;\n        gap: 12px;\n        padding: 8px 0;\n      }\n\n      .kicked-led {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background: rgba(120, 40, 40, 0.6);\n        border: 1px solid rgba(80, 30, 30, 0.8);\n        box-shadow:\n          inset 0 1px 2px rgba(0, 0, 0, 0.8),\n          0 0 8px rgba(180, 60, 60, 0.3);\n      }\n\n      .kicked-led.warning {\n        animation: ledWarningBlink 1.5s ease-in-out infinite;\n      }\n\n      @keyframes ledWarningBlink {\n        0%, 100% {\n          background: rgba(120, 40, 40, 0.6);\n          box-shadow:\n            inset 0 1px 2px rgba(0, 0, 0, 0.8),\n            0 0 6px rgba(180, 60, 60, 0.2);\n        }\n        50% {\n          background: rgba(180, 60, 60, 0.8);\n          box-shadow:\n            inset 0 1px 2px rgba(0, 0, 0, 0.5),\n            0 0 12px rgba(180, 60, 60, 0.5);\n        }\n      }\n\n      /* LCD显示屏 */\n      .kicked-lcd-display {\n        position: relative;\n      }\n\n      .lcd-border {\n        background: rgba(10, 10, 10, 0.95);\n        border: 2px solid rgba(60, 60, 60, 0.8);\n        padding: 2px;\n        box-shadow:\n          inset 0 2px 4px rgba(0, 0, 0, 0.8),\n          0 1px 0 rgba(255, 255, 255, 0.05);\n      }\n\n      .lcd-content {\n        background: rgba(20, 20, 20, 0.98);\n        padding: 16px 20px;\n        font-family: \'Courier New\', monospace;\n        text-align: center;\n        border: 1px solid rgba(40, 40, 40, 0.9);\n      }\n\n      .lcd-title {\n        font-size: 13px;\n        font-weight: 600;\n        color: rgba(180, 70, 70, 0.9);\n        letter-spacing: 1.5px;\n        margin-bottom: 10px;\n        text-shadow: 0 0 4px rgba(180, 70, 70, 0.3);\n      }\n\n      .lcd-divider {\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          rgba(80, 80, 80, 0.4) 0px,\n          rgba(80, 80, 80, 0.4) 4px,\n          transparent 4px,\n          transparent 8px\n        );\n        margin: 10px 0;\n      }\n\n      .lcd-message {\n        font-size: 13px;\n        color: rgba(200, 200, 200, 0.85);\n        line-height: 1.6;\n        margin-bottom: 10px;\n      }\n\n      .lcd-code {\n        font-size: 10px;\n        color: rgba(120, 120, 120, 0.7);\n        letter-spacing: 1px;\n        font-family: \'Courier New\', monospace;\n      }\n\n      /* 底部装饰条 */\n      .kicked-footer-strip {\n        height: 4px;\n        background: repeating-linear-gradient(\n          90deg,\n          rgba(80, 50, 50, 0.4) 0px,\n          rgba(80, 50, 50, 0.4) 4px,\n          rgba(60, 40, 40, 0.4) 4px,\n          rgba(60, 40, 40, 0.4) 8px\n        );\n        border-radius: 2px;\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);\n      }\n\n      /* 移动端适配 */\n      @media (max-width: 600px) {\n        .kicked-modal {\n          max-width: 300px;\n        }\n\n        .kicked-cassette-container {\n          padding: 16px 20px;\n          gap: 14px;\n        }\n\n        .lcd-content {\n          padding: 14px 16px;\n        }\n\n        .lcd-title {\n          font-size: 12px;\n        }\n\n        .lcd-message {\n          font-size: 12px;\n        }\n\n        .lcd-code {\n          font-size: 9px;\n        }\n\n        .kicked-led {\n          width: 7px;\n          height: 7px;\n        }\n\n        .connection-dialog {\n          max-width: 320px;\n        }\n\n        .connection-dialog.active {\n          right: 10px;\n        }\n\n        .connection-header {\n          padding: 14px 16px;\n        }\n\n        .connection-title {\n          font-size: 10px;\n          letter-spacing: 1.5px;\n        }\n\n        .connection-body {\n          padding: 16px 14px;\n          gap: 14px;\n        }\n\n        .connection-lcd-display .lcd-value {\n          font-size: 20px;\n        }\n\n        .threshold-text {\n          font-size: 11px;\n        }\n\n        .connection-btn {\n          padding: 12px 16px;\n        }\n\n        .btn-text {\n          font-size: 10px;\n          letter-spacing: 1px;\n        }\n      }\n\n      /* ============================================ */\n      /* 🎙️ 用户连线发言气泡（右侧轮盘下方，不旋转） */\n      /* ============================================ */\n      .user-connection-speech-bubbles {\n        position: absolute;\n        top: 78px; /* 轮盘高度70px + 间距8px */\n        right: 0; /* 与右侧轮盘右对齐 */\n        transform: translateX(35px); /* 向右偏移轮盘半径，使气泡中心对齐轮盘中心 */\n        display: flex;\n        flex-direction: column;\n        gap: 6px;\n        width: 180px;\n        max-width: calc(100vw - 40px); /* 防止超出屏幕，留20px边距 */\n        pointer-events: none;\n        z-index: 10;\n      }\n\n      /* 单个对话气泡 - 磁带标签风格 */\n      .speech-bubble {\n        background: linear-gradient(135deg, rgba(25, 25, 25, 0.95), rgba(18, 18, 18, 0.95));\n        border: 1px solid rgba(255, 255, 255, 0.12);\n        border-radius: 8px;\n        padding: 8px 10px;\n        position: relative;\n        box-shadow:\n          0 3px 10px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.05),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.3);\n        animation: bubbleSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        pointer-events: auto;\n      }\n\n      @keyframes bubbleSlideIn {\n        from {\n          opacity: 0;\n          transform: translateY(-8px) scale(0.95);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n      }\n\n      /* 磁带风格装饰孔 */\n      .speech-bubble::before,\n      .speech-bubble::after {\n        content: \'\';\n        position: absolute;\n        width: 3px;\n        height: 3px;\n        background: radial-gradient(circle, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));\n        border-radius: 50%;\n        box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.5);\n      }\n\n      .speech-bubble::before {\n        top: 6px;\n        left: 5px;\n      }\n\n      .speech-bubble::after {\n        top: 6px;\n        right: 5px;\n      }\n\n      /* 连线状态指示器（第一个气泡） */\n      .speech-bubble:first-child::before {\n        width: 5px;\n        height: 5px;\n        top: 5px;\n        left: 4px;\n        background: radial-gradient(circle, rgba(220, 70, 70, 0.9), rgba(180, 50, 50, 0.7));\n        box-shadow: 0 0 8px rgba(220, 70, 70, 0.6), inset 0 0 2px rgba(255, 100, 100, 0.4);\n        animation: bubbleIndicatorPulse 1.5s ease-in-out infinite;\n      }\n\n      @keyframes bubbleIndicatorPulse {\n        0%, 100% {\n          opacity: 1;\n          box-shadow: 0 0 8px rgba(220, 70, 70, 0.6);\n        }\n        50% {\n          opacity: 0.5;\n          box-shadow: 0 0 4px rgba(220, 70, 70, 0.3);\n        }\n      }\n\n      /* 气泡内容区 */\n      .bubble-content {\n        display: flex;\n        align-items: flex-start;\n        gap: 6px;\n      }\n\n      /* 用户小头像 */\n      .bubble-avatar {\n        width: 20px;\n        height: 20px;\n        border-radius: 50%;\n        border: 1px solid rgba(100, 140, 200, 0.3);\n        flex-shrink: 0;\n        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);\n        background: #000;\n      }\n\n      /* 文字区域 */\n      .bubble-text-area {\n        flex: 1;\n        min-width: 0;\n      }\n\n      /* 用户名 */\n      .bubble-user-name {\n        font-family: \'Courier New\', monospace;\n        font-size: 8px;\n        font-weight: 800;\n        color: rgba(120, 160, 220, 0.85);\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n        margin-bottom: 3px;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n      }\n\n      /* 发言内容 */\n      .bubble-speech-text {\n        font-family: \'Courier New\', monospace;\n        font-size: 10px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.9);\n        line-height: 1.4;\n        word-break: break-word;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n        display: -webkit-box;\n        -webkit-line-clamp: 2;\n        -webkit-box-orient: vertical;\n        overflow: hidden;\n      }\n\n      /* 时间标记 */\n      .bubble-time {\n        font-family: \'Courier New\', monospace;\n        font-size: 7px;\n        color: rgba(255, 255, 255, 0.35);\n        margin-top: 2px;\n        letter-spacing: 0.3px;\n        text-align: right;\n      }\n\n      /* 响应式调整 */\n      @media (max-width: 600px) {\n        .user-connection-speech-bubbles {\n          width: 150px;\n          transform: translateX(20px); /* 移动端减小偏移，避免溢出 */\n          max-width: calc(100vw - 30px); /* 移动端更小边距 */\n          gap: 5px;\n        }\n\n        .speech-bubble {\n          padding: 6px 8px;\n        }\n\n        .bubble-avatar {\n          width: 18px;\n          height: 18px;\n        }\n\n        .bubble-user-name {\n          font-size: 7px;\n        }\n\n        .bubble-speech-text {\n          font-size: 9px;\n        }\n\n        .bubble-time {\n          font-size: 6px;\n        }\n      }\n\n      /* ============================================ */\n      /* 🐱 像素猫咪游戏系统样式 */\n      /* ============================================ */\n\n      /* ===== 侧边栏猫咪图标（只有头部） ===== */\n      .mini-cat {\n        width: 26px;\n        height: 24px;\n        position: relative;\n        image-rendering: pixelated;\n      }\n\n      .mini-cat-head {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 22px;\n        height: 20px;\n        background: #f2e4e9;\n        border-radius: 50% 50% 45% 45%;\n        box-shadow:\n          inset 2px 2px 0 rgba(255,255,255,0.5),\n          inset -1px -1px 0 rgba(200,180,190,0.3),\n          0 2px 5px rgba(0,0,0,0.3);\n      }\n\n      .mini-cat-ear {\n        position: absolute;\n        top: -5px;\n        width: 8px;\n        height: 10px;\n        background: #f2e4e9;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n        box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);\n      }\n\n      .mini-cat-ear.left { left: 2px; transform: rotate(-15deg); }\n      .mini-cat-ear.right { right: 2px; transform: rotate(15deg); }\n\n      .mini-cat-ear-inner {\n        position: absolute;\n        bottom: 2px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 4px;\n        height: 5px;\n        background: #fde2e4;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n      }\n\n      .mini-cat-eyes {\n        position: absolute;\n        top: 7px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 5px;\n      }\n\n      .mini-cat-eye {\n        width: 4px;\n        height: 4px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        position: relative;\n        animation: miniCatBlink 4s ease-in-out infinite;\n      }\n\n      .mini-cat-eye::after {\n        content: \'\';\n        position: absolute;\n        top: 0.5px;\n        left: 0.5px;\n        width: 1.5px;\n        height: 1.5px;\n        background: rgba(255, 255, 255, 0.9);\n        border-radius: 50%;\n      }\n\n      @keyframes miniCatBlink {\n        0%, 48%, 52%, 100% { height: 4px; border-radius: 50%; }\n        50% { height: 0.5px; border-radius: 0.5px; }\n      }\n\n      .mini-cat-nose {\n        position: absolute;\n        top: 12px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 3px;\n        height: 3px;\n        background: #fde2e4;\n        border-radius: 50%;\n      }\n\n      /* W型八字胡（鼻子下方） */\n      .mini-cat-mouth {\n        position: absolute;\n        top: 15px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 8px;\n        height: 3px;\n      }\n\n      .mini-cat-mouth::before {\n        content: \'\';\n        position: absolute;\n        left: 0;\n        top: 0;\n        width: 3px;\n        height: 3px;\n        border-bottom: 1.5px solid #1a1a1a;\n        border-radius: 0 0 50% 50%;\n      }\n\n      .mini-cat-mouth::after {\n        content: \'\';\n        position: absolute;\n        right: 0;\n        top: 0;\n        width: 3px;\n        height: 3px;\n        border-bottom: 1.5px solid #1a1a1a;\n        border-radius: 0 0 50% 50%;\n      }\n\n      /* ===== 像素猫咪探头（完整版） ===== */\n      .pixel-cat-peek {\n        position: fixed;\n        right: 0;\n        bottom: 30%;\n        width: 160px;\n        height: 160px;\n        transform: translateX(100%);\n        z-index: 9000;\n        pointer-events: none;\n        transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .pixel-cat-peek.peeking {\n        transform: translateX(40px);\n        pointer-events: all;\n        animation: catPeekFloat 1.5s ease-in-out infinite;\n      }\n\n      @keyframes catPeekFloat {\n        0%, 100% { transform: translateX(40px) translateY(0); }\n        50% { transform: translateX(40px) translateY(-5px); }\n      }\n\n      .cat-wrapper {\n        position: relative;\n        width: 90px;\n        height: 85px;\n        cursor: pointer;\n        image-rendering: pixelated;\n      }\n\n      .cat-glow {\n        position: absolute;\n        inset: -15px;\n        background: radial-gradient(circle, rgba(253, 226, 228, 0.25) 0%, transparent 65%);\n        border-radius: 50%;\n        animation: glowPulse 2.5s ease-in-out infinite;\n        pointer-events: none;\n      }\n\n      @keyframes glowPulse {\n        0%, 100% { opacity: 0.4; transform: scale(0.95); }\n        50% { opacity: 0.7; transform: scale(1.05); }\n      }\n\n      .pixel-cat {\n        position: relative;\n        width: 90px;\n        height: 85px;\n      }\n\n      .cat-head {\n        position: absolute;\n        top: 5px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 52px;\n        height: 44px;\n        background: #f2e4e9;\n        border-radius: 50%;\n        box-shadow:\n          inset 3px 3px 0 rgba(255,255,255,0.6),\n          inset -2px -2px 0 rgba(200,180,190,0.4),\n          0 5px 15px rgba(0,0,0,0.4);\n        z-index: 2;\n      }\n\n      .cat-ear {\n        position: absolute;\n        top: -9px;\n        width: 17px;\n        height: 22px;\n        background: #f2e4e9;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n        box-shadow: inset 0 2px 0 rgba(255,255,255,0.5);\n        animation: earTwitch 3s ease-in-out infinite;\n      }\n\n      @keyframes earTwitch {\n        0%, 90%, 100% { transform: rotate(0deg); }\n        92%, 96% { transform: rotate(-5deg); }\n        94%, 98% { transform: rotate(5deg); }\n      }\n\n      .cat-ear.left { left: 5px; transform: rotate(-15deg); animation-delay: 0s; }\n      .cat-ear.right { right: 5px; transform: rotate(15deg); animation-delay: 0.5s; }\n\n      .cat-ear-inner {\n        position: absolute;\n        bottom: 5px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 9px;\n        height: 11px;\n        background: #fde2e4;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n      }\n\n      .cat-eyes {\n        position: absolute;\n        top: 18px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 14px;\n      }\n\n      .cat-eye {\n        width: 11px;\n        height: 11px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        position: relative;\n        animation: catBlink 3.5s ease-in-out infinite;\n      }\n\n      @keyframes catBlink {\n        0%, 45%, 55%, 100% { height: 11px; border-radius: 50%; }\n        50% { height: 2px; border-radius: 2px; }\n      }\n\n      .cat-eye::after {\n        content: \'\';\n        position: absolute;\n        top: 2px;\n        left: 3px;\n        width: 4px;\n        height: 4px;\n        background: #fff;\n        border-radius: 50%;\n        opacity: 0.9;\n      }\n\n      .cat-nose {\n        display: none;\n      }\n\n      .cat-mouth {\n        position: absolute;\n        top: 32px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 18px;\n        height: 7px;\n      }\n\n      .cat-mouth::before,\n      .cat-mouth::after {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        width: 9px;\n        height: 7px;\n        border-bottom: 2px solid #c0a0a8;\n        border-radius: 0 0 50% 50%;\n      }\n\n      .cat-mouth::before { left: 0; }\n      .cat-mouth::after { right: 0; }\n\n      .cat-cheek {\n        position: absolute;\n        top: 28px;\n        width: 10px;\n        height: 6px;\n        background: radial-gradient(ellipse, rgba(253, 180, 190, 0.4) 0%, transparent 70%);\n        border-radius: 50%;\n      }\n\n      .cat-cheek.left { left: 6px; }\n      .cat-cheek.right { right: 6px; }\n\n      .cat-whisker {\n        position: absolute;\n        top: 30px;\n        width: 18px;\n        height: 1px;\n        background: rgba(192, 160, 168, 0.6);\n        transform-origin: center;\n      }\n\n      .cat-whisker.left { left: -14px; transform: rotate(-10deg); }\n      .cat-whisker.right { right: -14px; transform: rotate(10deg); }\n      .cat-whisker.left-2 { left: -13px; top: 34px; transform: rotate(-5deg); }\n      .cat-whisker.right-2 { right: -13px; top: 34px; transform: rotate(5deg); }\n\n      /* ===== 猫咪情绪系统 ===== */\n      .cat-mood-calm .cat-eye { animation: calmBlink 5s ease-in-out infinite; }\n      @keyframes calmBlink {\n        0%, 92%, 98%, 100% { height: 11px; }\n        95% { height: 2px; }\n      }\n\n      .cat-mood-happy .cat-eye {\n        width: 14px;\n        height: 6px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        border: 2px solid #1a1a1a;\n        border-top: none;\n        border-bottom-left-radius: 100%;\n        border-bottom-right-radius: 100%;\n        transform: scaleY(-1);\n        animation: none;\n      }\n\n      .cat-mood-happy .cat-eye::after { display: none; }\n      .cat-mood-happy .cat-mouth::before,\n      .cat-mood-happy .cat-mouth::after { height: 9px; border-bottom-width: 3px; }\n      .cat-mood-happy .cat-cheek {\n        background: radial-gradient(ellipse, rgba(253, 180, 190, 0.6) 0%, transparent 70%);\n      }\n\n      .cat-mood-sad .cat-eye { transform: scaleY(0.7) translateY(3px); }\n      .cat-mood-sad .cat-mouth::before,\n      .cat-mood-sad .cat-mouth::after {\n        border-bottom: none;\n        border-top: 2px solid #c0a0a8;\n        border-radius: 50% 50% 0 0;\n        top: 3px;\n      }\n\n      .cat-mood-angry .cat-eye {\n        width: 8px;\n        height: 8px;\n        transform: scaleX(1.3) scaleY(0.6);\n        animation: angryTwitch 0.3s ease-in-out infinite;\n      }\n      @keyframes angryTwitch {\n        0%, 100% { transform: scaleX(1.3) scaleY(0.6); }\n        50% { transform: scaleX(1.4) scaleY(0.5); }\n      }\n\n      .cat-mood-shy .cat-eye { width: 6px; height: 6px; animation: shyBlink 2s ease-in-out infinite; }\n      @keyframes shyBlink {\n        0%, 40%, 60%, 100% { opacity: 1; }\n        50% { opacity: 0.3; }\n      }\n      .cat-mood-shy .cat-cheek {\n        width: 12px;\n        height: 8px;\n        background: radial-gradient(ellipse, rgba(253, 150, 170, 0.7) 0%, transparent 70%);\n      }\n\n      .cat-mood-excited .cat-eye {\n        width: 13px;\n        height: 13px;\n        animation: excitedSparkle 0.8s ease-in-out infinite;\n      }\n      @keyframes excitedSparkle {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.15); }\n      }\n\n      .cat-mood-sleepy .cat-eye { height: 4px; animation: sleepyBlink 3s ease-in-out infinite; }\n      @keyframes sleepyBlink {\n        0%, 30%, 100% { height: 4px; }\n        15% { height: 8px; }\n      }\n\n      .cat-mood-surprised .cat-eye { width: 13px; height: 13px; animation: none; }\n      .cat-mood-surprised .cat-mouth::before,\n      .cat-mood-surprised .cat-mouth::after { display: none; }\n      .cat-mood-surprised .cat-mouth {\n        width: 10px;\n        height: 10px;\n        top: 35px;\n        background: #1a1a1a;\n        border-radius: 50%;\n      }\n\n      /* ===== 对话框头像情绪增强（更明显的表情） ===== */\n      .dialog-avatar .cat-mood-happy .cat-eye {\n        width: 10px;\n        height: 4px;\n        border: 1.5px solid #1a1a1a;\n        border-top: none;\n      }\n      .dialog-avatar .cat-mood-happy .cat-mouth::before,\n      .dialog-avatar .cat-mood-happy .cat-mouth::after {\n        height: 6px;\n        border-bottom-width: 2px;\n      }\n\n      .dialog-avatar .cat-mood-sad .cat-eye {\n        transform: scaleY(0.5) translateY(2px);\n        opacity: 0.8;\n      }\n      .dialog-avatar .cat-mood-sad .cat-ear {\n        transform: rotate(0deg) translateY(1px);\n        opacity: 0.9;\n      }\n      .dialog-avatar .cat-mood-sad .cat-ear.left {\n        transform: rotate(-5deg) translateY(1px);\n      }\n      .dialog-avatar .cat-mood-sad .cat-ear.right {\n        transform: rotate(5deg) translateY(1px);\n      }\n\n      .dialog-avatar .cat-mood-angry .cat-eye {\n        width: 5px;\n        height: 5px;\n        transform: scaleX(1.4) scaleY(0.5);\n      }\n      .dialog-avatar .cat-mood-angry .cat-eye::before {\n        content: \'\';\n        position: absolute;\n        top: -3px;\n        left: -2px;\n        width: 8px;\n        height: 2px;\n        background: #1a1a1a;\n        transform: rotate(-20deg);\n      }\n\n      .dialog-avatar .cat-mood-shy .cat-eye {\n        width: 4px;\n        height: 4px;\n      }\n      .dialog-avatar .cat-mood-shy .cat-head::before,\n      .dialog-avatar .cat-mood-shy .cat-head::after {\n        content: \'\';\n        position: absolute;\n        top: 14px;\n        width: 8px;\n        height: 5px;\n        background: radial-gradient(ellipse, rgba(253, 120, 150, 0.8) 0%, transparent 70%);\n        border-radius: 50%;\n      }\n      .dialog-avatar .cat-mood-shy .cat-head::before { left: 3px; }\n      .dialog-avatar .cat-mood-shy .cat-head::after { right: 3px; }\n\n      .dialog-avatar .cat-mood-excited .cat-eye {\n        width: 8px;\n        height: 8px;\n        box-shadow: 0 0 4px rgba(253, 226, 228, 0.6);\n      }\n      .dialog-avatar .cat-mood-excited .cat-eye::before {\n        content: \'★\';\n        position: absolute;\n        top: -1px;\n        left: 0;\n        font-size: 8px;\n        color: #fde2e4;\n        animation: starTwinkle 0.6s ease-in-out infinite;\n      }\n      @keyframes starTwinkle {\n        0%, 100% { opacity: 1; transform: scale(1); }\n        50% { opacity: 0.5; transform: scale(1.2); }\n      }\n\n      .dialog-avatar .cat-mood-sleepy .cat-eye {\n        height: 3px;\n        border-radius: 2px;\n      }\n      .dialog-avatar .cat-mood-sleepy .cat-eye::before {\n        content: \'z\';\n        position: absolute;\n        top: -8px;\n        right: -6px;\n        font-size: 8px;\n        color: rgba(253, 226, 228, 0.6);\n        animation: zzz 2s ease-in-out infinite;\n      }\n      @keyframes zzz {\n        0%, 100% { opacity: 0; transform: translateY(0); }\n        50% { opacity: 1; transform: translateY(-3px); }\n      }\n\n      .dialog-avatar .cat-mood-surprised .cat-eye {\n        width: 8px;\n        height: 8px;\n      }\n      .dialog-avatar .cat-mood-surprised .cat-mouth {\n        display: block;\n        width: 6px;\n        height: 6px;\n        top: 21px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);\n      }\n\n      .dialog-avatar .cat-mood-calm .cat-eye {\n        animation: dialogCalmBlink 6s ease-in-out infinite;\n      }\n      @keyframes dialogCalmBlink {\n        0%, 94%, 98%, 100% { height: 6px; }\n        96% { height: 1px; }\n      }\n\n      /* ===== 对话框（磁带播放器风格） ===== */\n      .rpg-dialog-container {\n        position: fixed;\n        bottom: 25%;\n        left: 50%;\n        transform: translateX(-50%) translateY(150px) scale(0.9);\n        opacity: 0;\n        z-index: 9500;\n        pointer-events: none;\n        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .rpg-dialog-container.active {\n        transform: translateX(-50%) translateY(0) scale(1);\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .rpg-dialog-box {\n        width: 340px;\n        max-width: 90vw;\n        background:\n          linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 50%, #0d0d0d 100%);\n        border: 3px solid #1a1a1a;\n        border-radius: 14px;\n        box-shadow:\n          0 0 0 1px #4a4a4a,\n          0 0 0 3px #1a1a1a,\n          0 0 0 4px rgba(253, 226, 228, 0.3),\n          0 14px 42px rgba(0, 0, 0, 0.9),\n          0 0 36px rgba(253, 226, 228, 0.2),\n          inset 0 2px 0 rgba(255, 255, 255, 0.1),\n          inset 0 -2px 0 rgba(0, 0, 0, 0.9);\n        padding: 20px;\n        position: relative;\n        overflow: hidden;\n        image-rendering: pixelated;\n      }\n\n      .metal-texture {\n        position: absolute;\n        inset: 0;\n        background:\n          repeating-linear-gradient(\n            90deg,\n            transparent 0px,\n            rgba(255, 255, 255, 0.02) 1px,\n            transparent 2px\n          );\n        opacity: 0.5;\n        pointer-events: none;\n      }\n\n      .scanlines {\n        position: absolute;\n        inset: 0;\n        background:\n          repeating-linear-gradient(\n            0deg,\n            rgba(0, 0, 0, 0.15) 0px,\n            transparent 1px,\n            transparent 2px,\n            rgba(0, 0, 0, 0.15) 3px\n          );\n        pointer-events: none;\n        animation: scanlineMove 8s linear infinite;\n      }\n\n      @keyframes scanlineMove {\n        0% { transform: translateY(0); }\n        100% { transform: translateY(4px); }\n      }\n\n      .dialog-screw {\n        position: absolute;\n        width: 14px;\n        height: 14px;\n        background:\n          radial-gradient(circle at 30% 30%, #6a6a6a 0%, #4a4a4a 40%, #2a2a2a 70%, #1a1a1a 100%);\n        border-radius: 50%;\n        border: 2px solid #3a3a3a;\n        box-shadow:\n          inset 0 2px 3px rgba(255,255,255,0.3),\n          inset 0 -2px 3px rgba(0,0,0,0.8),\n          0 2px 6px rgba(0,0,0,0.7);\n      }\n\n      .dialog-screw::before,\n      .dialog-screw::after {\n        content: \'\';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        background: #5a5a5a;\n        box-shadow: 0 1px 1px rgba(0,0,0,0.5);\n      }\n\n      .dialog-screw::before {\n        width: 8px;\n        height: 1.5px;\n        transform: translate(-50%, -50%);\n      }\n\n      .dialog-screw::after {\n        width: 1.5px;\n        height: 8px;\n        transform: translate(-50%, -50%);\n      }\n\n      .dialog-screw.top-left { top: 12px; left: 12px; }\n      .dialog-screw.top-right { top: 12px; right: 12px; }\n      .dialog-screw.bottom-left { bottom: 12px; left: 12px; }\n      .dialog-screw.bottom-right { bottom: 12px; right: 12px; }\n\n      .cassette-gear {\n        position: absolute;\n        top: 16px;\n        width: 20px;\n        height: 20px;\n        border: 2px solid rgba(253, 226, 228, 0.25);\n        border-radius: 50%;\n        animation: gearRotate 12s linear infinite;\n      }\n\n      .cassette-gear::before {\n        content: \'\';\n        position: absolute;\n        inset: 4px;\n        border: 1px solid rgba(253, 226, 228, 0.15);\n        border-radius: 50%;\n        background: rgba(26, 26, 26, 0.8);\n      }\n\n      .cassette-gear.left { left: 16px; }\n      .cassette-gear.right { right: 16px; animation-direction: reverse; }\n\n      @keyframes gearRotate {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n\n      .vu-meter {\n        position: absolute;\n        top: 20px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 2px;\n      }\n\n      .vu-bar {\n        width: 3px;\n        height: 8px;\n        background: rgba(253, 226, 228, 0.2);\n        border-radius: 1px;\n        animation: vuPulse 1.5s ease-in-out infinite;\n      }\n\n      .vu-bar:nth-child(1) { animation-delay: 0s; }\n      .vu-bar:nth-child(2) { animation-delay: 0.1s; }\n      .vu-bar:nth-child(3) { animation-delay: 0.2s; }\n      .vu-bar:nth-child(4) { animation-delay: 0.3s; }\n      .vu-bar:nth-child(5) { animation-delay: 0.4s; }\n\n      @keyframes vuPulse {\n        0%, 100% { background: rgba(253, 226, 228, 0.2); transform: scaleY(0.6); }\n        50% { background: rgba(253, 226, 228, 0.6); transform: scaleY(1); }\n      }\n\n      .led-indicator {\n        position: absolute;\n        top: 18px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 6px;\n        height: 6px;\n        background: #fde2e4;\n        border-radius: 50%;\n        box-shadow:\n          0 0 8px rgba(253, 226, 228, 0.8),\n          0 0 16px rgba(253, 226, 228, 0.4),\n          inset 0 1px 1px rgba(255, 255, 255, 0.6);\n        animation: ledBlink 2s ease-in-out infinite;\n      }\n\n      @keyframes ledBlink {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.3; }\n      }\n\n      .dialog-header {\n        background:\n          linear-gradient(135deg, rgba(253, 226, 228, 0.08) 0%, rgba(242, 228, 233, 0.03) 100%);\n        border: 2px solid rgba(253, 226, 228, 0.2);\n        border-radius: 10px;\n        padding: 12px;\n        margin-bottom: 18px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        position: relative;\n        box-shadow:\n          inset 0 1px 2px rgba(0, 0, 0, 0.6),\n          inset 0 -1px 1px rgba(255, 255, 255, 0.05),\n          0 2px 8px rgba(0, 0, 0, 0.3);\n      }\n\n      .dialog-header::before {\n        content: \'\';\n        position: absolute;\n        inset: 0;\n        background:\n          repeating-linear-gradient(\n            0deg,\n            transparent 0px,\n            rgba(0, 0, 0, 0.1) 1px,\n            transparent 2px\n          );\n        border-radius: 8px;\n        pointer-events: none;\n      }\n\n      .dialog-avatar {\n        width: 52px;\n        height: 52px;\n        position: relative;\n        flex-shrink: 0;\n        background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);\n        border: 2px solid rgba(253, 226, 228, 0.3);\n        border-radius: 8px;\n        padding: 3px;\n        box-shadow:\n          0 0 12px rgba(253, 226, 228, 0.2),\n          inset 0 1px 2px rgba(0, 0, 0, 0.8);\n        animation: avatarGlow 3s ease-in-out infinite;\n      }\n\n      @keyframes avatarGlow {\n        0%, 100% { box-shadow:\n          0 0 12px rgba(253, 226, 228, 0.2),\n          inset 0 1px 2px rgba(0, 0, 0, 0.8);\n        }\n        50% { box-shadow:\n          0 0 20px rgba(253, 226, 228, 0.4),\n          inset 0 1px 2px rgba(0, 0, 0, 0.8);\n        }\n      }\n\n      .dialog-avatar .pixel-cat {\n        width: 44px;\n        height: 44px;\n        transform: scale(0.85);\n      }\n\n      .dialog-avatar .cat-head { width: 32px; height: 28px; top: 8px; }\n      .dialog-avatar .cat-ear { width: 11px; height: 14px; top: -6px; }\n      .dialog-avatar .cat-ear.left { left: 2px; }\n      .dialog-avatar .cat-ear.right { right: 2px; }\n      .dialog-avatar .cat-ear-inner { width: 6px; height: 8px; bottom: 3px; }\n      .dialog-avatar .cat-eyes { top: 11px; gap: 10px; }\n      .dialog-avatar .cat-eye { width: 8px; height: 8px; }\n      .dialog-avatar .cat-eye::after { width: 3px; height: 3px; top: 1px; left: 1px; }\n      .dialog-avatar .cat-whisker,\n      .dialog-avatar .cat-cheek,\n      .dialog-avatar .cat-nose,\n      .dialog-avatar .cat-mouth,\n      .dialog-avatar .cat-glow { display: none; }\n\n      .dialog-title {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .dialog-name {\n        font-size: 16px;\n        font-weight: 700;\n        color: #fde2e4;\n        text-shadow:\n          0 0 8px rgba(253, 226, 228, 0.6),\n          0 2px 4px rgba(0, 0, 0, 0.8);\n        letter-spacing: 1px;\n        margin-bottom: 4px;\n        font-family: "BoutiqueBitmap7x7 Scan Line", \'Courier New\', monospace;\n      }\n\n      .dialog-subtitle {\n        font-size: 11px;\n        color: rgba(242, 228, 233, 0.5);\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n        font-family: "BoutiqueBitmap7x7 Scan Line", \'Courier New\', monospace;\n      }\n\n      .dialog-text {\n        background:\n          linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.2) 100%);\n        border: 2px solid rgba(253, 226, 228, 0.15);\n        border-radius: 8px;\n        padding: 14px;\n        font-size: 14px;\n        line-height: 1.7;\n        color: #fde2e4;\n        min-height: 68px;\n        margin-bottom: 18px;\n        white-space: pre-wrap;\n        text-shadow:\n          0 0 6px rgba(253, 226, 228, 0.4),\n          0 1px 3px rgba(0, 0, 0, 0.9);\n        box-shadow:\n          inset 0 2px 4px rgba(0, 0, 0, 0.6),\n          inset 0 -1px 2px rgba(255, 255, 255, 0.02);\n        position: relative;\n        font-family: "BoutiqueBitmap7x7 Scan Line", \'Courier New\', monospace;\n      }\n\n      .dialog-text::before {\n        content: \'\';\n        position: absolute;\n        inset: 0;\n        background:\n          repeating-linear-gradient(\n            0deg,\n            transparent 0px,\n            rgba(253, 226, 228, 0.03) 1px,\n            transparent 2px\n          );\n        border-radius: 6px;\n        pointer-events: none;\n      }\n\n      .typing-cursor {\n        display: inline-block;\n        width: 2px;\n        height: 16px;\n        background: #fde2e4;\n        margin-left: 3px;\n        animation: cursorBlink 1s step-end infinite;\n        vertical-align: text-bottom;\n        box-shadow: 0 0 8px rgba(253, 226, 228, 0.6);\n      }\n\n      @keyframes cursorBlink {\n        0%, 50% { opacity: 1; }\n        51%, 100% { opacity: 0; }\n      }\n\n      .dialog-buttons {\n        display: flex;\n        gap: 10px;\n      }\n\n      .dialog-btn {\n        flex: 1;\n        padding: 14px 16px;\n        background:\n          linear-gradient(145deg, rgba(58, 58, 58, 0.8) 0%, rgba(42, 42, 42, 0.9) 100%);\n        border: 3px solid rgba(74, 74, 74, 0.6);\n        border-bottom-color: rgba(26, 26, 26, 0.9);\n        border-right-color: rgba(26, 26, 26, 0.8);\n        border-radius: 10px;\n        color: #fde2e4;\n        font-size: 13px;\n        font-weight: 700;\n        font-family: "BoutiqueBitmap7x7 Scan Line", \'Courier New\', monospace;\n        cursor: pointer;\n        transition: all 0.15s cubic-bezier(0.34, 1.2, 0.64, 1);\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        box-shadow:\n          0 4px 0 rgba(26, 26, 26, 0.8),\n          0 6px 12px rgba(0, 0, 0, 0.6),\n          inset 0 2px 2px rgba(255, 255, 255, 0.15),\n          inset 0 -2px 2px rgba(0, 0, 0, 0.6);\n        position: relative;\n        text-shadow:\n          0 0 8px rgba(253, 226, 228, 0.4),\n          0 1px 2px rgba(0, 0, 0, 0.9);\n      }\n\n      .dialog-btn::before {\n        content: \'\';\n        position: absolute;\n        inset: 4px;\n        background:\n          linear-gradient(145deg, rgba(253, 226, 228, 0.1) 0%, transparent 100%);\n        border-radius: 6px;\n        pointer-events: none;\n      }\n\n      .dialog-btn:hover {\n        background:\n          linear-gradient(145deg, rgba(68, 68, 68, 0.9) 0%, rgba(52, 52, 52, 1) 100%);\n        border-color: rgba(84, 84, 84, 0.7);\n        transform: translateY(-2px);\n        box-shadow:\n          0 6px 0 rgba(26, 26, 26, 0.9),\n          0 8px 16px rgba(0, 0, 0, 0.7),\n          inset 0 2px 3px rgba(255, 255, 255, 0.2),\n          inset 0 -2px 3px rgba(0, 0, 0, 0.7),\n          0 0 16px rgba(253, 226, 228, 0.2);\n        text-shadow:\n          0 0 12px rgba(253, 226, 228, 0.6),\n          0 1px 3px rgba(0, 0, 0, 1);\n      }\n\n      .dialog-btn:active {\n        transform: translateY(2px);\n        box-shadow:\n          0 2px 0 rgba(26, 26, 26, 0.8),\n          0 3px 8px rgba(0, 0, 0, 0.5),\n          inset 0 3px 5px rgba(0, 0, 0, 0.8);\n      }\n\n      .dialog-btn.primary {\n        background:\n          linear-gradient(145deg, rgba(253, 226, 228, 0.25) 0%, rgba(242, 228, 233, 0.15) 100%);\n        border-color: rgba(253, 226, 228, 0.5);\n        border-bottom-color: rgba(253, 226, 228, 0.3);\n        box-shadow:\n          0 4px 0 rgba(253, 226, 228, 0.2),\n          0 6px 12px rgba(253, 226, 228, 0.15),\n          inset 0 2px 3px rgba(255, 255, 255, 0.3),\n          inset 0 -2px 3px rgba(0, 0, 0, 0.4),\n          0 0 20px rgba(253, 226, 228, 0.3);\n      }\n\n      .dialog-btn.primary:hover {\n        box-shadow:\n          0 6px 0 rgba(253, 226, 228, 0.3),\n          0 8px 16px rgba(253, 226, 228, 0.25),\n          inset 0 2px 4px rgba(255, 255, 255, 0.4),\n          inset 0 -2px 4px rgba(0, 0, 0, 0.5),\n          0 0 28px rgba(253, 226, 228, 0.5);\n      }\n\n      /* ===== 移动端适配（像素猫游戏） ===== */\n      @media (max-width: 600px) {\n        .rpg-dialog-box {\n          width: 300px;\n          padding: 16px;\n          border: 2px solid #1a1a1a;\n          border-radius: 12px;\n        }\n\n        .dialog-screw {\n          width: 10px;\n          height: 10px;\n        }\n\n        .dialog-screw.top-left { top: 8px; left: 8px; }\n        .dialog-screw.top-right { top: 8px; right: 8px; }\n        .dialog-screw.bottom-left { bottom: 8px; left: 8px; }\n        .dialog-screw.bottom-right { bottom: 8px; right: 8px; }\n\n        .cassette-gear {\n          width: 16px;\n          height: 16px;\n          top: 12px;\n        }\n\n        .cassette-gear.left { left: 12px; }\n        .cassette-gear.right { right: 12px; }\n\n        .led-indicator {\n          top: 14px;\n          width: 5px;\n          height: 5px;\n        }\n\n        .dialog-header {\n          padding: 10px;\n          margin-bottom: 14px;\n          border-radius: 8px;\n        }\n\n        .dialog-avatar {\n          width: 44px;\n          height: 44px;\n        }\n\n        .dialog-avatar .pixel-cat {\n          width: 38px;\n          height: 38px;\n          transform: scale(0.8);\n        }\n\n        .dialog-name {\n          font-size: 14px;\n          margin-bottom: 3px;\n        }\n\n        .dialog-subtitle {\n          font-size: 10px;\n        }\n\n        .dialog-text {\n          padding: 12px;\n          font-size: 13px;\n          line-height: 1.6;\n          min-height: 56px;\n          margin-bottom: 14px;\n        }\n\n        .typing-cursor {\n          width: 1.5px;\n          height: 14px;\n        }\n\n        .dialog-buttons {\n          gap: 8px;\n        }\n\n        .dialog-btn {\n          padding: 11px 12px;\n          font-size: 11px;\n          border: 2px solid rgba(74, 74, 74, 0.6);\n          border-radius: 8px;\n          letter-spacing: 0.5px;\n          box-shadow:\n            0 3px 0 rgba(26, 26, 26, 0.8),\n            0 5px 10px rgba(0, 0, 0, 0.6),\n            inset 0 1px 2px rgba(255, 255, 255, 0.15),\n            inset 0 -1px 2px rgba(0, 0, 0, 0.6);\n        }\n\n        .dialog-btn::before {\n          inset: 3px;\n        }\n\n        .dialog-btn:hover {\n          transform: translateY(-1px);\n          box-shadow:\n            0 4px 0 rgba(26, 26, 26, 0.9),\n            0 6px 12px rgba(0, 0, 0, 0.7),\n            inset 0 1px 2px rgba(255, 255, 255, 0.2),\n            inset 0 -1px 2px rgba(0, 0, 0, 0.7),\n            0 0 12px rgba(253, 226, 228, 0.2);\n        }\n\n        .dialog-btn:active {\n          transform: translateY(1px);\n          box-shadow:\n            0 1px 0 rgba(26, 26, 26, 0.8),\n            0 2px 6px rgba(0, 0, 0, 0.5),\n            inset 0 2px 4px rgba(0, 0, 0, 0.8);\n        }\n\n        .dialog-btn.primary {\n          box-shadow:\n            0 3px 0 rgba(253, 226, 228, 0.2),\n            0 5px 10px rgba(253, 226, 228, 0.15),\n            inset 0 1px 2px rgba(255, 255, 255, 0.3),\n            inset 0 -1px 2px rgba(0, 0, 0, 0.4),\n            0 0 16px rgba(253, 226, 228, 0.3);\n        }\n\n        .dialog-btn.primary:hover {\n          box-shadow:\n            0 4px 0 rgba(253, 226, 228, 0.3),\n            0 6px 12px rgba(253, 226, 228, 0.25),\n            inset 0 1px 3px rgba(255, 255, 255, 0.4),\n            inset 0 -1px 3px rgba(0, 0, 0, 0.5),\n            0 0 20px rgba(253, 226, 228, 0.5);\n        }\n      }\n\n      /* ============================================ */\n      /* ✊ 猜拳游戏系统样式 - Rock Paper Scissors */\n      /* ============================================ */\n\n      /* 猜拳游戏外框 - 磁带播放器风格 */\n      .rps-game-box {\n        width: 340px;\n        max-width: 90vw;\n        background:\n          linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 50%, #0d0d0d 100%);\n        border: 3px solid #1a1a1a;\n        border-radius: 14px;\n        box-shadow:\n          0 0 0 1px #4a4a4a,\n          0 0 0 3px #1a1a1a,\n          0 0 0 4px rgba(253, 226, 228, 0.3),\n          0 14px 42px rgba(0, 0, 0, 0.9),\n          0 0 36px rgba(253, 226, 228, 0.2),\n          inset 0 2px 0 rgba(255, 255, 255, 0.1),\n          inset 0 -2px 0 rgba(0, 0, 0, 0.9);\n        padding: 12px;\n        position: relative;\n        overflow: hidden;\n        image-rendering: pixelated;\n      }\n\n      /* 猜拳游戏内容容器 */\n      .rps-game-floating {\n        position: relative;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      /* 比分栏 - 横向一行布局 */\n      .rps-scoreboard {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        gap: 10px;\n        padding: 8px 14px;\n        background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(15, 15, 15, 0.98));\n        border: 2px solid rgba(100, 100, 100, 0.5);\n        border-radius: 8px;\n        box-shadow:\n          0 4px 12px rgba(0, 0, 0, 0.7),\n          inset 0 1px 0 rgba(255, 255, 255, 0.08),\n          inset 0 -2px 0 rgba(0, 0, 0, 0.5);\n        position: relative;\n        font-family: \'Courier New\', monospace;\n      }\n\n      /* 移除纸张纹理 */\n      .rps-scoreboard::before {\n        display: none;\n      }\n\n      /* 回合指示器 */\n      .rps-round-indicator {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        z-index: 1;\n      }\n\n      .round-text {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.85);\n        letter-spacing: 0.5px;\n      }\n\n      .round-progress {\n        display: none;\n      }\n\n      /* 比分项 */\n      .rps-score-item {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        z-index: 1;\n      }\n\n      .score-label {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.8);\n        letter-spacing: 0.5px;\n      }\n\n      .score-value {\n        font-size: 16px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.98);\n        font-family: \'Courier New\', monospace;\n        text-shadow:\n          0 0 12px rgba(242, 228, 233, 0.8),\n          0 2px 4px rgba(0, 0, 0, 0.6);\n        line-height: 1;\n        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        min-width: 20px;\n        text-align: center;\n      }\n\n      .score-value.bounce {\n        animation: scoreBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes scoreBounce {\n        0% { transform: scale(1); }\n        50% { transform: scale(1.3); }\n        100% { transform: scale(1); }\n      }\n\n      .score-separator {\n        font-size: 13px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.6);\n        margin: 0 2px;\n      }\n\n      .progress-dot {\n        display: none;\n      }\n\n      .progress-dot.active {\n        display: none;\n      }\n\n      /* 战斗舞台 - 左右布局 */\n      .rps-battle-stage {\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        justify-content: space-between;\n        gap: 10px;\n        position: relative;\n        padding: 0 8px;\n      }\n\n      /* 猫咪战斗区 */\n      .rps-cat-arena {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 6px;\n        position: relative;\n        flex: 1;\n      }\n\n      .cat-label {\n        font-size: 10px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.8);\n        text-shadow: 0 0 8px rgba(242, 228, 233, 0.5);\n        letter-spacing: 0.5px;\n        margin-bottom: 2px;\n      }\n\n      /* 猜拳游戏像素猫（复刻+增强动效） - 放大更萌 */\n      .rps-pixel-cat {\n        position: relative;\n        width: 70px;\n        height: 65px;\n        animation: catIdleBreathe 4s ease-in-out infinite;\n        transition: transform 0.3s ease;\n        filter: drop-shadow(0 4px 12px rgba(242, 228, 233, 0.3));\n      }\n\n      @keyframes catIdleBreathe {\n        0%, 100% { transform: translateY(0) scale(1); }\n        50% { transform: translateY(-2px) scale(1.01); }\n      }\n\n      /* 蓄力动画 */\n      .rps-pixel-cat.charging {\n        animation: catCharging 0.6s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      @keyframes catCharging {\n        0% { transform: translateY(0) scale(1); }\n        50% { transform: translateY(3px) scale(0.95, 1.05); }\n        100% { transform: translateY(0) scale(1); }\n      }\n\n      /* 出拳冲击动画 */\n      .rps-pixel-cat.attacking {\n        animation: catAttack 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes catAttack {\n        0% { transform: translateY(0) scale(1); }\n        30% { transform: translateY(-5px) scale(1.05); }\n        60% { transform: translateY(2px) scale(0.98); }\n        100% { transform: translateY(0) scale(1); }\n      }\n\n      /* 胜利庆祝动画 */\n      .rps-pixel-cat.celebrating {\n        animation: catCelebrate 0.8s ease-in-out 2;\n      }\n\n      @keyframes catCelebrate {\n        0%, 100% { transform: translateY(0) rotate(0deg); }\n        25% { transform: translateY(-8px) rotate(-5deg); }\n        75% { transform: translateY(-8px) rotate(5deg); }\n      }\n\n      /* 失败沮丧动画 */\n      .rps-pixel-cat.defeated {\n        animation: catDefeat 1s ease-out;\n      }\n\n      @keyframes catDefeat {\n        0% { transform: translateY(0) scale(1); }\n        30% { transform: translateY(8px) scale(1, 0.9); }\n        100% { transform: translateY(0) scale(1); }\n      }\n\n      .rps-cat-head {\n        position: absolute;\n        top: 5px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 42px;\n        height: 36px;\n        background: #ffffff;\n        border-radius: 50%;\n        box-shadow:\n          inset 2px 2px 0 rgba(255,255,255,1),\n          inset -2px -2px 0 rgba(230,230,230,0.6),\n          0 4px 10px rgba(0,0,0,0.3);\n        z-index: 2;\n        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .rps-cat-ear {\n        position: absolute;\n        top: -7px;\n        width: 14px;\n        height: 18px;\n        background: #ffffff;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n        box-shadow:\n          inset 1px 1px 0 rgba(255,255,255,0.9),\n          0 2px 4px rgba(0,0,0,0.2);\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .rps-cat-ear.left {\n        left: 5px;\n        transform: rotate(-15deg);\n        animation: earTwitchLeft 5s ease-in-out infinite;\n      }\n\n      .rps-cat-ear.right {\n        right: 5px;\n        transform: rotate(15deg);\n        animation: earTwitchRight 5s ease-in-out infinite;\n        animation-delay: 0.3s;\n      }\n\n      /* 耳朵细微抖动 */\n      @keyframes earTwitchLeft {\n        0%, 90%, 100% { transform: rotate(-15deg); }\n        92%, 96% { transform: rotate(-20deg); }\n        94%, 98% { transform: rotate(-12deg); }\n      }\n\n      @keyframes earTwitchRight {\n        0%, 90%, 100% { transform: rotate(15deg); }\n        92%, 96% { transform: rotate(20deg); }\n        94%, 98% { transform: rotate(12deg); }\n      }\n\n      .rps-cat-ear-inner {\n        position: absolute;\n        bottom: 4px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 8px;\n        height: 11px;\n        background: #ffe0e5;\n        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n        opacity: 0.5;\n      }\n\n      .rps-cat-eyes {\n        position: absolute;\n        top: 14px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 11px;\n        transition: transform 0.3s ease;\n      }\n\n      .rps-cat-eye {\n        width: 9px;\n        height: 9px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        position: relative;\n        animation: catNormalBlink 4s ease-in-out infinite;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: 0 1px 2px rgba(0,0,0,0.2);\n      }\n\n      @keyframes catNormalBlink {\n        0%, 46%, 54%, 100% { height: 9px; border-radius: 50%; }\n        50% { height: 2px; border-radius: 2px; }\n      }\n\n      .rps-cat-eye::after {\n        content: \'\';\n        position: absolute;\n        top: 2px;\n        left: 3px;\n        width: 3px;\n        height: 3px;\n        background: #ffffff;\n        border-radius: 50%;\n        opacity: 0.85;\n        transition: all 0.25s ease;\n      }\n\n      /* 猫咪胡须 - 细线条自然 */\n      .rps-cat-whisker {\n        position: absolute;\n        width: 15px;\n        height: 0.5px;\n        background: linear-gradient(to right, rgba(140,140,140,0.35), transparent);\n        top: 20px;\n        transition: all 0.3s ease;\n      }\n\n      .rps-cat-whisker.left {\n        left: -12px;\n        transform-origin: right center;\n      }\n\n      .rps-cat-whisker.right {\n        right: -12px;\n        transform-origin: left center;\n        background: linear-gradient(to left, rgba(140,140,140,0.35), transparent);\n      }\n\n      .rps-cat-whisker.left.top { top: 17px; transform: rotate(-12deg); }\n      .rps-cat-whisker.left.middle { top: 20px; transform: rotate(0deg); }\n      .rps-cat-whisker.left.bottom { top: 23px; transform: rotate(12deg); }\n\n      .rps-cat-whisker.right.top { top: 17px; transform: rotate(12deg); }\n      .rps-cat-whisker.right.middle { top: 20px; transform: rotate(0deg); }\n      .rps-cat-whisker.right.bottom { top: 23px; transform: rotate(-12deg); }\n\n      .rps-cat-mouth {\n        position: absolute;\n        top: 26px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 14px;\n        height: 6px;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .rps-cat-mouth::before,\n      .rps-cat-mouth::after {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        width: 7px;\n        height: 6px;\n        border-bottom: 1.5px solid #777;\n        border-radius: 0 0 50% 50%;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .rps-cat-mouth::before { left: 0; }\n      .rps-cat-mouth::after { right: 0; }\n\n      /* 隐藏鼻子 */\n      .rps-cat-nose {\n        display: none;\n      }\n\n      .rps-cat-cheek {\n        position: absolute;\n        top: 23px;\n        width: 8px;\n        height: 5px;\n        background: radial-gradient(ellipse, rgba(255, 192, 203, 0.3) 0%, transparent 65%);\n        border-radius: 50%;\n        transition: background 0.25s ease;\n      }\n\n      .rps-cat-cheek.left { left: 5px; }\n      .rps-cat-cheek.right { right: 5px; }\n\n      /* 猜拳猫咪情绪系统（增强版） */\n      /* 偷笑（狡猾预判中） */\n      .rps-cat-mood-sneaky .rps-cat-eye {\n        width: 10px;\n        height: 5px;\n        border-radius: 50%;\n        transform: translateY(2px);\n        animation: sneakyGlint 1s ease-in-out infinite;\n      }\n\n      @keyframes sneakyGlint {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.7; }\n      }\n\n      .rps-cat-mood-sneaky .rps-cat-mouth::before,\n      .rps-cat-mood-sneaky .rps-cat-mouth::after {\n        height: 8px;\n        border-bottom-width: 2.5px;\n      }\n\n      .rps-cat-mood-sneaky .rps-cat-cheek {\n        background: radial-gradient(ellipse, rgba(253, 180, 190, 0.5) 0%, transparent 70%);\n      }\n\n      /* 专注（出拳时） */\n      .rps-cat-mood-focused .rps-cat-eye {\n        width: 8px;\n        height: 8px;\n        transform: scaleY(0.7);\n        animation: none;\n      }\n\n      .rps-cat-mood-focused .rps-cat-eye::after {\n        width: 3px;\n        height: 3px;\n        box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);\n      }\n\n      /* 开心（赢了） */\n      .rps-cat-mood-happy .rps-cat-eye {\n        width: 14px;\n        height: 6px;\n        background: #1a1a1a;\n        border-radius: 50%;\n        border: 2px solid #1a1a1a;\n        border-top: none;\n        border-bottom-left-radius: 100%;\n        border-bottom-right-radius: 100%;\n        transform: scaleY(-1);\n        animation: none;\n      }\n\n      .rps-cat-mood-happy .rps-cat-eye::after { display: none; }\n\n      .rps-cat-mood-happy .rps-cat-mouth::before,\n      .rps-cat-mood-happy .rps-cat-mouth::after {\n        height: 10px;\n        border-bottom-width: 3px;\n      }\n\n      .rps-cat-mood-happy .rps-cat-cheek {\n        background: radial-gradient(ellipse, rgba(253, 180, 190, 0.7) 0%, transparent 70%);\n      }\n\n      .rps-cat-mood-happy .rps-cat-ear.left {\n        animation: earWiggleHappy 0.5s ease-in-out 3;\n      }\n\n      .rps-cat-mood-happy .rps-cat-ear.right {\n        animation: earWiggleHappyRight 0.5s ease-in-out 3;\n      }\n\n      @keyframes earWiggleHappy {\n        0%, 100% { transform: rotate(-15deg); }\n        50% { transform: rotate(-25deg); }\n      }\n\n      @keyframes earWiggleHappyRight {\n        0%, 100% { transform: rotate(15deg); }\n        50% { transform: rotate(25deg); }\n      }\n\n      /* 难过（输了） */\n      .rps-cat-mood-sad .rps-cat-eye {\n        transform: scaleY(0.6) translateY(4px);\n        animation: sadEyeShake 2s ease-in-out infinite;\n      }\n\n      @keyframes sadEyeShake {\n        0%, 90%, 100% { transform: scaleY(0.6) translateY(4px); }\n        95% { transform: scaleY(0.6) translateY(5px); }\n      }\n\n      .rps-cat-mood-sad .rps-cat-mouth::before,\n      .rps-cat-mood-sad .rps-cat-mouth::after {\n        border-bottom: none;\n        border-top: 2.5px solid #c0a0a8;\n        border-radius: 50% 50% 0 0;\n        top: 4px;\n      }\n\n      .rps-cat-mood-sad .rps-cat-ear {\n        opacity: 0.8;\n        transform-origin: bottom center;\n      }\n\n      .rps-cat-mood-sad .rps-cat-ear.left {\n        transform: rotate(-8deg) translateY(2px);\n        animation: none;\n      }\n\n      .rps-cat-mood-sad .rps-cat-ear.right {\n        transform: rotate(8deg) translateY(2px);\n        animation: none;\n      }\n\n      /* 平局（惊讶） */\n      .rps-cat-mood-surprised .rps-cat-eye {\n        width: 13px;\n        height: 13px;\n        animation: surprisedBlink 0.6s ease-in-out 2;\n      }\n\n      @keyframes surprisedBlink {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.2); }\n      }\n\n      .rps-cat-mood-surprised .rps-cat-mouth {\n        width: 6px;\n        height: 6px;\n        top: 28px;\n        background: #c0a0a8;\n        border-radius: 50%;\n      }\n\n      .rps-cat-mood-surprised .rps-cat-mouth::before,\n      .rps-cat-mood-surprised .rps-cat-mouth::after {\n        display: none;\n      }\n\n      /* 猫咪手势容器 */\n      .cat-hand-container {\n        position: relative;\n        width: 36px;\n        height: 36px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .cat-hand {\n        width: 26px;\n        height: 26px;\n        position: relative;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transform-origin: center center;\n        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));\n      }\n\n      /* 挥拳动画 - 更流畅的上下摆动 */\n      .cat-hand.swinging {\n        animation: catHandSwing 1.2s cubic-bezier(0.45, 0, 0.55, 1);\n      }\n\n      @keyframes catHandSwing {\n        0%, 100% {\n          transform: translateY(0) rotate(0deg);\n        }\n        12% {\n          transform: translateY(-18px) rotate(-5deg);\n        }\n        24% {\n          transform: translateY(0) rotate(0deg);\n        }\n        40% {\n          transform: translateY(-18px) rotate(5deg);\n        }\n        56% {\n          transform: translateY(0) rotate(0deg);\n        }\n        72% {\n          transform: translateY(-18px) rotate(-3deg);\n        }\n        88% {\n          transform: translateY(0) rotate(0deg);\n        }\n      }\n\n      /* 手势显示动画 - 更有冲击感 */\n      .cat-hand.revealing {\n        animation: catHandReveal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes catHandReveal {\n        0% {\n          transform: scale(0.3) rotate(-180deg);\n          opacity: 0;\n        }\n        60% {\n          transform: scale(1.2) rotate(10deg);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(1) rotate(0deg);\n          opacity: 1;\n        }\n      }\n\n      /* emoji风格手势 */\n      .hand-gesture {\n        font-size: 18px;\n        filter: grayscale(100%) brightness(1.4) sepia(25%) hue-rotate(300deg);\n        transition: all 0.3s ease;\n      }\n\n      .hand-gesture.rock::before { content: \'✊\'; }\n      .hand-gesture.paper::before { content: \'✋\'; }\n      .hand-gesture.scissors::before { content: \'✌️\'; }\n\n      /* 猫猫手势旋转180度形成对战视角（面对面猜拳） */\n      .cat-hand .hand-gesture {\n        transform: rotate(180deg);\n      }\n\n      /* 用户战斗区 */\n      .rps-user-arena {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 6px;\n        position: relative;\n        flex: 1;\n      }\n\n      .user-label {\n        font-size: 10px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.8);\n        text-shadow: 0 0 8px rgba(242, 228, 233, 0.5);\n        letter-spacing: 0.5px;\n        margin-bottom: 2px;\n      }\n\n      /* 用户头像 */\n      .rps-user-avatar {\n        width: 70px;\n        height: 70px;\n        border-radius: 50%;\n        border: 3px solid rgba(242, 228, 233, 0.4);\n        box-shadow:\n          0 0 0 2px rgba(30, 30, 30, 0.8),\n          0 0 20px rgba(242, 228, 233, 0.3),\n          inset 0 2px 6px rgba(0, 0, 0, 0.4),\n          0 6px 16px rgba(0, 0, 0, 0.6);\n        object-fit: cover;\n        position: relative;\n        transition: all 0.3s ease;\n        filter: brightness(1.05) contrast(1.1);\n      }\n\n      .rps-user-avatar:hover {\n        transform: scale(1.05);\n        box-shadow:\n          0 0 0 3px rgba(242, 228, 233, 0.6),\n          0 0 30px rgba(242, 228, 233, 0.5),\n          inset 0 2px 6px rgba(0, 0, 0, 0.3),\n          0 8px 20px rgba(0, 0, 0, 0.7);\n      }\n\n      /* 头像加载失败时的占位符 */\n      .rps-user-avatar-placeholder {\n        width: 70px;\n        height: 70px;\n        border-radius: 50%;\n        background: radial-gradient(circle at 30% 30%, rgba(80, 80, 80, 0.9), rgba(30, 30, 30, 0.95));\n        border: 3px solid rgba(100, 100, 100, 0.5);\n        box-shadow:\n          0 0 0 2px rgba(30, 30, 30, 0.8),\n          inset 0 3px 6px rgba(0, 0, 0, 0.6),\n          0 6px 16px rgba(0, 0, 0, 0.7);\n        position: relative;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .rps-user-avatar-placeholder::before {\n        content: \'👤\';\n        font-size: 32px;\n        opacity: 0.4;\n      }\n\n      .user-hand-container {\n        position: relative;\n        width: 36px;\n        height: 36px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .user-hand {\n        width: 26px;\n        height: 26px;\n        position: relative;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transform-origin: center center;\n        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));\n      }\n\n      /* 用户挥拳动画 - 与猫同步 */\n      .user-hand.swinging {\n        animation: userHandSwing 1.2s cubic-bezier(0.45, 0, 0.55, 1);\n      }\n\n      @keyframes userHandSwing {\n        0%, 100% {\n          transform: translateY(0) rotate(0deg);\n        }\n        12% {\n          transform: translateY(-18px) rotate(5deg);\n        }\n        24% {\n          transform: translateY(0) rotate(0deg);\n        }\n        40% {\n          transform: translateY(-18px) rotate(-5deg);\n        }\n        56% {\n          transform: translateY(0) rotate(0deg);\n        }\n        72% {\n          transform: translateY(-18px) rotate(3deg);\n        }\n        88% {\n          transform: translateY(0) rotate(0deg);\n        }\n      }\n\n      .user-hand.revealing {\n        animation: userHandReveal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes userHandReveal {\n        0% {\n          transform: scale(0.3) rotate(180deg);\n          opacity: 0;\n        }\n        60% {\n          transform: scale(1.2) rotate(-10deg);\n          opacity: 1;\n        }\n        100% {\n          transform: scale(1) rotate(0deg);\n          opacity: 1;\n        }\n      }\n\n      /* VS分隔线 - 垂直布局 */\n      .rps-vs-divider {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        margin: 0;\n        position: relative;\n      }\n\n      .vs-line {\n        width: 2px;\n        height: 90px;\n        background: linear-gradient(to bottom,\n          transparent,\n          rgba(242, 228, 233, 0.2) 10%,\n          rgba(242, 228, 233, 0.5) 50%,\n          rgba(242, 228, 233, 0.2) 90%,\n          transparent\n        );\n        border-radius: 1px;\n      }\n\n      .vs-text {\n        font-size: 13px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 0.98);\n        text-shadow:\n          0 0 16px rgba(242, 228, 233, 0.95),\n          0 2px 6px rgba(0, 0, 0, 0.95);\n        letter-spacing: 2.5px;\n        animation: vsPulse 2.5s ease-in-out infinite;\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: rgba(10, 10, 10, 0.8);\n        padding: 4px 6px;\n        border-radius: 4px;\n      }\n\n      @keyframes vsPulse {\n        0%, 100% {\n          opacity: 0.75;\n        }\n        50% {\n          opacity: 1;\n        }\n      }\n\n      /* 选择按钮 */\n      .rps-choice-buttons {\n        display: flex;\n        gap: 6px;\n        justify-content: center;\n        margin-top: 3px;\n      }\n\n      .rps-btn {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 3px;\n        padding: 7px 10px;\n        min-width: 70px;\n        min-height: 70px;\n        background: linear-gradient(135deg, rgba(242, 228, 233, 0.95), rgba(225, 210, 215, 0.95));\n        border: 2px solid rgba(150, 130, 140, 0.85);\n        border-radius: 6px;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow:\n          0 2px 0 rgba(26, 26, 26, 0.75),\n          0 3px 6px rgba(0, 0, 0, 0.6),\n          inset 0 1px 2px rgba(255, 255, 255, 0.45);\n        position: relative;\n        user-select: none;\n      }\n\n      .rps-btn::before {\n        content: \'\';\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          45deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.05) 2px,\n          rgba(255, 255, 255, 0.05) 4px\n        );\n        border-radius: 8px;\n        pointer-events: none;\n      }\n\n      .rps-btn:hover {\n        transform: translateY(-3px);\n        box-shadow:\n          0 5px 0 rgba(26, 26, 26, 0.85),\n          0 8px 14px rgba(0, 0, 0, 0.7),\n          inset 0 2px 5px rgba(255, 255, 255, 0.55),\n          0 0 20px rgba(242, 228, 233, 0.4);\n      }\n\n      .rps-btn:active {\n        transform: translateY(1px);\n        box-shadow:\n          0 1px 0 rgba(26, 26, 26, 0.7),\n          0 2px 4px rgba(0, 0, 0, 0.5),\n          inset 0 3px 6px rgba(0, 0, 0, 0.35);\n      }\n\n      .rps-btn.disabled {\n        opacity: 0.4;\n        cursor: not-allowed;\n        pointer-events: none;\n      }\n\n      .btn-icon {\n        font-size: 16px;\n        filter: grayscale(100%) brightness(1.4) sepia(25%) hue-rotate(300deg);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        width: 24px;\n        height: 24px;\n      }\n\n      .btn-label {\n        font-size: 7px;\n        font-weight: 700;\n        color: rgba(26, 26, 26, 0.9);\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n      }\n\n      /* 结果文字 */\n      .rps-result-text {\n        text-align: center;\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(242, 228, 233, 1);\n        text-shadow:\n          0 0 12px rgba(242, 228, 233, 0.95),\n          0 2px 8px rgba(0, 0, 0, 1);\n        margin-top: 5px;\n        min-height: 16px;\n        letter-spacing: 1px;\n        animation: resultFadeIn 0.5s ease-out;\n      }\n\n      @keyframes resultFadeIn {\n        0% {\n          opacity: 0;\n          transform: translateY(-10px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* 重新开始按钮 */\n      .rps-restart-btn {\n        margin-top: 6px;\n        padding: 7px 16px;\n        background: linear-gradient(135deg, rgba(242, 228, 233, 0.93), rgba(225, 210, 215, 0.93));\n        border: 2px solid rgba(150, 130, 140, 0.85);\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 10px;\n        font-weight: 700;\n        color: rgba(26, 26, 26, 0.95);\n        letter-spacing: 0.8px;\n        box-shadow:\n          0 2px 0 rgba(26, 26, 26, 0.75),\n          0 3px 6px rgba(0, 0, 0, 0.6),\n          inset 0 1px 2px rgba(255, 255, 255, 0.45);\n        transition: all 0.2s ease;\n        align-self: center;\n      }\n\n      .rps-restart-btn:hover {\n        transform: translateY(-2px);\n        box-shadow:\n          0 5px 0 rgba(26, 26, 26, 0.85),\n          0 8px 14px rgba(0, 0, 0, 0.7),\n          inset 0 2px 5px rgba(255, 255, 255, 0.55);\n      }\n\n      .rps-restart-btn:active {\n        transform: translateY(1px);\n        box-shadow:\n          0 1px 0 rgba(26, 26, 26, 0.7),\n          0 2px 4px rgba(0, 0, 0, 0.5),\n          inset 0 3px 6px rgba(0, 0, 0, 0.35);\n      }\n  ',document.head.appendChild(Sa))}function Aa(){if(Xi=!0,Qo&&(clearInterval(Qo),Qo=null),Zo&&(clearTimeout(Zo),Zo=null),Gi&&(clearInterval(Gi),Gi=null),Oi=0,_i&&(clearInterval(_i),_i=null),Fi&&(clearInterval(Fi),Fi=null),Qi&&(Qi.remove(),Qi=null),Ji=[],Ra.durationTimer&&(clearInterval(Ra.durationTimer),Ra.durationTimer=null),Ra.queueInterval&&(clearInterval(Ra.queueInterval),Ra.queueInterval=null),Ra.isConnected=!1,Ra.connectedAt=null,Ra.hasRequested=!1,Ra.isOpen=!1,Ra.managementOpen=!1,Ra.pendingInteraction=null,Ra.queuePosition=-1,Zi=[],nr.clear(),Ki=!1,Ha.countdownTimer&&(clearInterval(Ha.countdownTimer),Ha.countdownTimer=null),Ha.scoreAnimationTimer&&(clearInterval(Ha.scoreAnimationTimer),Ha.scoreAnimationTimer=null),Ha.preparingInterval&&(clearInterval(Ha.preparingInterval),Ha.preparingInterval=null),Ha.isActive=!1,Ha.isPreparing=!1,Ha.config=null,Ha.scenario14Data=null,ka(),na.isOpen){const n=document.getElementById("controlSidebar"),e=document.getElementById("controlSidebarOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),na.isOpen=!1,na.isAnimating=!1}if(La.isOpen){const n=document.getElementById("leaderboardPanel");n&&n.remove(),La.isOpen=!1,La.currentIndex=0,La.currentType="gifts",La.isAnimating=!1}const n=document.getElementById("live-room-container");n&&n.remove(),Sa&&(Sa.remove(),Sa=null),Ma&&(Ma.remove(),Ma=null),Ko=null,Yi=0}function Ea(n,e=!0){const t=document.createElement("div");t.id="live-end-modal",t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.85);\n    backdrop-filter: blur(10px);\n    z-index: 999999;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.3s ease;\n",t.innerHTML=`\n    <div style="\n      width: 320px;\n      background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);\n      border: 2px solid rgba(255, 255, 255, 0.12);\n      border-radius: 8px;\n      padding: 0;\n      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), \n                  inset 0 1px 0 rgba(255, 255, 255, 0.05);\n      position: relative;\n      overflow: hidden;\n      animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n    ">\n      \x3c!-- 磁带机顶部装饰 --\x3e\n      <div style="\n        height: 8px;\n        background: linear-gradient(90deg, \n          rgba(255, 255, 255, 0.05) 0%, \n          rgba(255, 255, 255, 0.02) 50%, \n          rgba(255, 255, 255, 0.05) 100%);\n        border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n      "></div>\n\n      \x3c!-- STOP标识 --\x3e\n      <div style="\n        padding: 24px 24px 16px;\n        text-align: center;\n      ">\n        <div style="\n          width: 60px;\n          height: 60px;\n          margin: 0 auto 16px;\n          background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);\n          border: 2px solid rgba(255, 255, 255, 0.15);\n          border-radius: 6px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),\n                      inset 0 1px 0 rgba(255, 255, 255, 0.1);\n          position: relative;\n        ">\n          <div style="\n            width: 24px;\n            height: 24px;\n            background: rgba(255, 255, 255, 0.85);\n            border-radius: 2px;\n            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.3);\n          "></div>\n          \x3c!-- 按钮压痕效果 --\x3e\n          <div style="\n            position: absolute;\n            top: 4px;\n            left: 4px;\n            right: 4px;\n            bottom: 4px;\n            border-radius: 4px;\n            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);\n            pointer-events: none;\n          "></div>\n        </div>\n\n        \x3c!-- STOP文字 --\x3e\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 11px;\n          font-weight: 700;\n          letter-spacing: 3px;\n          color: rgba(255, 255, 255, 0.5);\n          margin-bottom: 20px;\n        ">STOP</div>\n\n        \x3c!-- 主标题 --\x3e\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 15px;\n          font-weight: 600;\n          color: rgba(255, 255, 255, 0.9);\n          margin-bottom: 8px;\n          letter-spacing: 0.5px;\n        ">直播已结束</div>\n\n        \x3c!-- 主播名称 --\x3e\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 13px;\n          color: rgba(255, 255, 255, 0.6);\n          margin-bottom: 4px;\n        ">${n}</div>\n\n        \x3c!-- 分隔线 --\x3e\n        <div style="\n          height: 1px;\n          background: linear-gradient(90deg, \n            transparent 0%, \n            rgba(255, 255, 255, 0.1) 50%, \n            transparent 100%);\n          margin: 20px 0 16px;\n        "></div>\n\n        \x3c!-- 提示文字 --\x3e\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 11px;\n          color: rgba(255, 255, 255, 0.45);\n          line-height: 1.6;\n          letter-spacing: 0.3px;\n        ">${e?"感谢观看<br>即将返回直播列表":"该直播间已关闭<br>无法进入"}</div>\n      </div>\n\n      \x3c!-- 磁带机底部装饰 --\x3e\n      <div style="\n        height: 8px;\n        background: linear-gradient(90deg, \n          rgba(255, 255, 255, 0.03) 0%, \n          rgba(255, 255, 255, 0.01) 50%, \n          rgba(255, 255, 255, 0.03) 100%);\n        border-top: 1px solid rgba(255, 255, 255, 0.05);\n      "></div>\n\n      \x3c!-- 左右装饰线 --\x3e\n      <div style="\n        position: absolute;\n        left: 0;\n        top: 0;\n        bottom: 0;\n        width: 1px;\n        background: linear-gradient(180deg, \n          transparent 0%, \n          rgba(255, 255, 255, 0.1) 50%, \n          transparent 100%);\n      "></div>\n      <div style="\n        position: absolute;\n        right: 0;\n        top: 0;\n        bottom: 0;\n        width: 1px;\n        background: linear-gradient(180deg, \n          transparent 0%, \n          rgba(255, 255, 255, 0.1) 50%, \n          transparent 100%);\n      "></div>\n    </div>\n  `,e||(t.onclick=()=>{t.style.animation="fadeOut 0.3s ease",setTimeout(()=>{t.remove()},300)}),document.body.appendChild(t),e&&setTimeout(()=>{t.style.animation="fadeOut 0.3s ease",setTimeout(()=>{t.remove(),Aa()},300)},2e3)}async function za(){const n=Ko?.streamerName||"主播",e=Ko?.id;if(console.log(`📴 [直播结束] 主播 ${n} 结束了直播，正在标记状态...`),Ko&&Ko.details&&e)try{Ko.details.isEnded=!0,Ko.details.endedAt=(new Date).toISOString(),await aa(e,Ko.details),console.log(`✅ [直播结束] 已标记直播间 ${e} 为结束状态并保存到数据库`)}catch(n){console.error("❌ [直播结束] 保存结束状态失败:",n)}else console.warn("⚠️ [直播结束] 无法标记状态：缺少必要数据");Ea(n,!0)}const Ba={gifts:{title:"GIFT RANKING",valuePrefix:"",formatValue:n=>`${n.toLocaleString()}P`},fans:{title:"FAN LEVEL RANKING",valuePrefix:"Lv.",formatValue:n=>n},active:{title:"ACTIVITY RANKING",valuePrefix:"",formatValue:n=>`${n}天`}};let La={isOpen:!1,isAnimating:!1,currentType:"gifts",currentIndex:0,types:["gifts","fans","active"]};function Pa(){if(na.isAnimating||na.isOpen)return;na.isAnimating=!0,na.isOpen=!0;const n=document.getElementById("controlSidebar"),e=document.getElementById("controlSidebarOverlay");n&&n.classList.add("active"),e&&e.classList.add("active"),setTimeout(()=>{na.isAnimating=!1},400)}function Da(){if(na.isAnimating||!na.isOpen)return;na.isAnimating=!0,na.isOpen=!1;const n=document.getElementById("controlSidebar"),e=document.getElementById("controlSidebarOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{na.isAnimating=!1},400)}let Na=!1,Ra={isOpen:!1,isAnimating:!1,settings:null,hasRequested:!1,isConnected:!1,pendingInteraction:null,queuePosition:-1,queueInterval:null,connectedAt:null,durationTimer:null,managementOpen:!1},Ha={isActive:!1,isPreparing:!1,config:null,startTime:null,endTime:null,streamerScore:0,userScore:0,lastScoreUpdate:null,scoreAnimationTimer:null,countdownTimer:null,progressBarVisible:!1,scenario14Data:null,preparingProgress:0,preparingInterval:null,preGeneratedEndContent:null,preGeneratedResult:null,prepareTriggered:!1,endContentGenerating:!1,endContentPromise:null,endContentError:!1,pendingEndContent:null},ja=[];async function Ua(){if(Ko&&Ko.details){if(Ko.details.connectionSettings){if(Ko.details.connectionSettings.enabled)return;Ko.details.connectionSettings.enabled=!0}else Ko.details.connectionSettings={enabled:!0,threshold:{type:"none",value:0,description:"无门槛，欢迎所有人连线"},waitingList:[],maxWaiting:8,averageWaitTime:"约3-5分钟"};try{await aa(Ko.id,Ko.details)}catch(n){console.error("❌ [连线系统] 保存连线状态失败:",n)}Oa(),mn("主播已开启连线功能","success"),console.log("✅ [连线系统] 连线功能已成功开启")}else console.warn("⚠️ [连线系统] 无法开启：缺少直播间数据")}function Oa(){if(Ko&&Ko.details&&Ko.details.connectionSettings){Ra.settings=Ko.details.connectionSettings,console.log("🎙️ [连线系统] 检测到连线设置");const n=document.getElementById("rightReel"),e=document.getElementById("rightReelInner");n&&e&&Ra.settings.enabled&&(n.classList.add("connection-reel"),n.style.cursor="pointer",n.title="点击申请连线",n.setAttribute("onclick","openConnectionDialog()"),e.classList.add("connection-icon-container"),e.style.background="",e.innerHTML='\n        \x3c!-- 连线图标 --\x3e\n        <svg viewBox="0 0 24 24" style="width: 40px; height: 40px; fill: #666;">\n          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>\n          <circle cx="12" cy="12" r="2" fill="#999"/>\n        </svg>\n      ',console.log("✅ [连线系统] 连线入口已启用")),function(){const n=Ra.settings;if(!n)return;const e=document.getElementById("connectionWaitingCount");if(e){const t=n.waitingList?n.waitingList.length:0,o=n.maxWaiting||10;e.textContent=`${t} / ${o}`}const t=document.getElementById("connectionAvgWait");t&&(t.textContent=n.averageWaitTime||"约3-5分钟");const o=document.querySelector(".threshold-text");o&&n.threshold&&(n.enabled?o.textContent=n.threshold.description||"无门槛":o.textContent="主播暂未开启连线功能");_a()}(),function(){if(!Na)return;if(!Ra.settings||!Ra.settings.enabled)return void console.log("🔧 [开发者模式] 连线功能未开启，跳过自动连线");if(Ra.isConnected)return void console.log("🔧 [开发者模式] 已处于连线状态");console.log("🔧 [开发者模式] 启用自动连线..."),Ra.isConnected=!0,Ra.hasRequested=!0,Ra.connectedAt=Date.now(),setTimeout(()=>{Va(),Ga(),console.log("✅ [开发者模式] 自动连线成功 - 已跳过申请和排队流程"),mn("🔧 开发者模式：已自动建立连线","success")},500)}()}}function _a(){const n=Ra.settings,e=document.getElementById("connectionConfirmBtn"),t=document.getElementById("connectionStatusTag");if(!e||!t||!n)return;const o=t.querySelector(".tag-text");if(o)if(n.enabled)if(Ra.hasRequested)e.innerHTML='\n      <div class="btn-led" style="background: rgba(100, 200, 100, 0.8); box-shadow: 0 0 6px rgba(100, 255, 100, 0.5);"></div>\n      <span class="btn-text">ALREADY REQUESTED</span>\n      <div class="btn-shadow"></div>\n    ',e.disabled=!0,e.style.opacity="0.7",e.style.cursor="not-allowed",o.textContent="申请已提交，请耐心等待主播回应";else{const t=n.waitingList||[],a=n.maxWaiting||10;t.length>=a?(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",o.textContent="当前等待队列已满，请稍后再试"):(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",o.textContent="点击申请与主播连线")}else e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",o.textContent="主播当前未开启连线功能"}function Fa(){if(Ra.isAnimating||!Ra.isOpen)return;Ra.isAnimating=!0,Ra.isOpen=!1;const n=document.getElementById("connectionDialog"),e=document.getElementById("connectionDialogOverlay");n&&(n.classList.remove("active"),n.style.right="-400px",n.style.opacity="0"),e&&e.classList.remove("active"),setTimeout(()=>{Ra.isAnimating=!1},500)}function Xa(n){if(!Ko)return;const t=Ko.onlineCount||100;let o=t+n;o<10&&(o=10+Math.floor(5*Math.random()),console.log(`⚠️ [人数限制] 人数不能低于10，调整为 ${o}`)),o>5e3&&(o=4950+Math.floor(51*Math.random()),console.log(`⚠️ [人数限制] 人数不能超过5000，调整为 ${o}`)),Ko.onlineCount=o;const a=document.getElementById("onlineText");a&&(a.style.transition="all 0.3s ease",n>0?a.style.color="#4ade80":n<0&&(a.style.color="#f87171"),a.textContent=o,setTimeout(()=>{a.style.color=""},500)),console.log(`👥 [在线人数] ${t} → ${o} (${n>=0?"+":""}${n})`),Ko.id&&async function(n,t){try{const o=e();if(!o)return void console.warn("⚠️ [直播间] 保存基本信息失败: 无法获取数据库实例");const a="liveRoomDetails_"+n,i=await o.xAccountProfiles.get(a);i&&(i.onlineCount=t.onlineCount,i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log(`✅ [直播间] 已更新基本信息: 在线人数 ${t.onlineCount}`))}catch(n){console.warn("⚠️ [直播间] 保存基本信息失败:",n)}}(Ko.id,Ko).catch(n=>{console.warn("⚠️ [人数更新] 保存失败:",n)})}async function qa(e){if(!e)return;if(!Ko||!Ko.details)return void console.error("❌ [互动处理] 当前没有直播间数据");const t=Date.now();console.log(`🎯 [互动处理] 新批次ID: ${t}`),e.streamerMessages&&(e.streamerMessages.forEach(n=>{n.generationId=t}),Ko.details.streamerMessages=[...e.streamerMessages,...Ko.details.streamerMessages]),e.danmaku&&(e.danmaku.forEach(n=>{n.generationId=t}),Ko.details.danmaku=[...e.danmaku,...Ko.details.danmaku]),Ko.details.latestGenerationId=t,e.superChats&&e.superChats.length>0&&(e.superChats.forEach(n=>{n.generationId=t}),Ko.details.superChats||(Ko.details.superChats=[]),Ko.details.superChats=[...e.superChats,...Ko.details.superChats],console.log(`💰 [互动处理] AI生成了${e.superChats.length}条SC，准备智能显示`)),e.pkGifts&&e.pkGifts.length>0&&(console.log(`🎁 [PK礼物] AI生成了${e.pkGifts.length}个观众礼物，准备显示动画`),setTimeout(()=>{!function(e){if(!e||0===e.length)return;console.log(`🎁 [PK礼物] 开始播放${e.length}个礼物动画`);const t=e.length;let o=1800,a=2500;t>=6?(o=800,a=1500,console.log("🎁 [PK礼物] 大量礼物，使用快速模式")):t>=3?(o=1200,a=2e3,console.log("🎁 [PK礼物] 中等数量礼物，使用中速模式")):console.log("🎁 [PK礼物] 少量礼物，使用正常模式"),e.forEach((e,a)=>{setTimeout(()=>{const o=e.quantity||1;let i=null;n.liveGifts&&(i=n.liveGifts.find(n=>n.name===e.giftName||n.id===e.giftName));const r={userName:e.sender||"观众",userAvatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",giftName:i?i.subtitle:e.giftName,giftPrice:e.giftPrice,giftIcon:i?i.icon:"🎁",giftCode:i?i.code:"PK",animationType:e.animationType||"default",target:e.target,quantity:o};if(console.log(`🎁 [PK礼物] 播放第${a+1}/${t}个礼物: ${e.sender} → ${"streamer"===e.target?"主播":"用户"} [${e.giftName} x${o}]`),Li(r),n.pkState&&n.pkState.active){const t=e.giftPrice*o;"streamer"===e.target?(n.pkState.streamerScore+=t,console.log(`📊 [PK积分] 主播 +${t}，当前: ${n.pkState.streamerScore}`)):"user"===e.target&&(n.pkState.userScore+=t,console.log(`📊 [PK积分] 用户 +${t}，当前: ${n.pkState.userScore}`)),updatePKScoreDisplay()}},a*o)})}(e.pkGifts)},1500));try{await aa(Ko.id,Ko.details)}catch(n){console.error("⚠️ [互动处理] 保存数据失败:",n)}Zo&&(clearTimeout(Zo),Zo=null),Qo&&(clearInterval(Qo),Qo=null),function(n){if(!n||0===n.length)return;let e=0;function t(){if(e>=n.length)return void(Zo=null);const o=n[e],a=e===n.length-1;return ar(o.content,e),o.musicAction&&sr(o.musicAction),!0===o.shouldKickUser&&Ra.isConnected?(console.log("🚨 [连线系统] 主播决定踢出用户"),e++,qi(o.content,()=>{Zo=setTimeout(()=>{t()},2e3)}),void setTimeout(()=>{Qa("kicked")},1500)):!0!==o.shouldEnableConnection||Ko?.details?.connectionSettings&&!1!==Ko.details.connectionSettings.enabled?(e++,void qi(o.content,()=>{Zo=a&&!0===o.shouldEndLive?setTimeout(()=>{za()},3e3):setTimeout(()=>{t()},2e3)})):(console.log("🎙️ [连线系统] 主播决定开启连线功能"),e++,qi(o.content,()=>{Zo=setTimeout(()=>{t()},2e3)}),void setTimeout(()=>{Ua()},1500))}setTimeout(()=>{t()},1e3)}(e.streamerMessages||[]),function(n){if(!n||0===n.length)return;const e=document.getElementById("danmakuList");if(!e)return;let t=0;Qo=setInterval(()=>{if(t>=n.length)return clearInterval(Qo),void(Qo=null);const o=n[t];console.log(`💬 [新弹幕 ${t+1}/${n.length}] ${o.userName}: ${o.content.substring(0,30)}...`),ar(o.content,t);const a="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",i=document.createElement("div");if(i.style.cssText="\n        display: flex; \n        gap: 12px; \n        align-items: flex-start; \n        padding: 8px 0; \n        animation: fadeInUp 0.4s ease-out;\n        position: relative;\n      ",i.innerHTML=`\n        <img src="${a}" style="width: 34px; height: 34px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.15); flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.2); filter: brightness(0.95) contrast(1.05); background: #000;" alt="${o.userName}">\n        <div style="flex: 1; min-width: 0; padding-top: 2px;">\n          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.5); font-weight: 800; margin-bottom: 4px; letter-spacing: 0.8px; text-transform: uppercase; font-family: 'Courier New', monospace;">${o.userName}</div>\n          <div style="font-size: 12px; color: rgba(255, 255, 255, 0.85); line-height: 1.6; word-break: break-word; letter-spacing: 0.3px; font-family: 'Courier New', monospace;">${o.content}</div>\n        </div>\n        <div style="position: absolute; bottom: 0; left: 48px; right: 0; height: 1px; background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), transparent);"></div>\n      `,e.appendChild(i),e.children.length>5){const n=e.firstChild;n.style.transition="all 0.3s ease-out",n.style.opacity="0",n.style.transform="translateX(-20px)",setTimeout(()=>{e.removeChild(n)},300)}const r=document.getElementById("danmaku-container");r&&(r.scrollTop=r.scrollHeight),t++},1500)}(e.danmaku||[]),e.superChats&&e.superChats.length>0&&setTimeout(()=>{or(e.superChats)},1e3);Xa(function(n,e){if(!n||!e)return 0;let t=0,o=0;const a=n.map(n=>n.content||"").join(" ").toLowerCase(),i=e.map(n=>n.content||"").join(" ").toLowerCase();let r=0;["卧槽","天哪","什么鬼","震惊","不会吧","真的假的","吓我一跳","我的天","疯了","炸了","爆了","牛逼","绝了","太离谱","笑死","哈哈哈哈","666","awesome","amazing","incredible"].forEach(n=>{a.includes(n)&&r++,i.includes(n)&&(r+=.5)});let s=0;["水洒了","手机掉了","猫","狗","宠物","打雷","停电","网络","卡了","bug","出错","坏了"].forEach(n=>{a.includes(n)&&s++}),r>=3||s>=2?(t+=40,console.log("🎭 检测到抓马事件！人数将大幅增加")):r>=1&&(t+=15);let l=0;["开心","高兴","兴奋","激动","喜欢","爱","感谢","谢谢","支持","加油"].forEach(n=>{a.includes(n)&&l++});let c=0;["无聊","累","困","算了","不想","烦","差不多","下播","拜拜"].forEach(n=>{a.includes(n)&&c++});let d=0;["尴尬","emmm","这个嘛","怎么说","不知道","可能","应该","吧"].forEach(n=>{a.includes(n)&&d++}),l>=2&&(t+=10),c>=2&&(t-=15,console.log("😴 主播状态不佳，人数将下降")),d>=3&&(t-=8);let p=0;["666","牛","厉害","赞","支持","好看","好听","有意思","学到了"].forEach(n=>{i.includes(n)&&p++});let g=0;["无聊","一般","就这","不行","溜了","走了","再见"].forEach(n=>{i.includes(n)&&g++}),p>=5&&(t+=8),g>=3&&(t-=12,console.log("👋 观众反应消极，人数将下降"));const m=n.length+e.length;m>=80?(t+=12,console.log("🔥 直播间非常活跃！")):m>=50?t+=5:m<30&&(t-=5);const x=a.includes("礼物")||a.includes("谢谢"),u=i.includes("sc")||i.includes("super chat");return(x||u)&&(t+=6),t>=35?(o=20+Math.floor(31*Math.random()),console.log(`📈 [人数变化] 内容精彩！人数增加 +${o}`)):t>=15?(o=5+Math.floor(16*Math.random()),console.log(`📊 [人数变化] 内容不错，人数增加 +${o}`)):t>=0?(o=-3+Math.floor(14*Math.random()),o>0?console.log(`📊 [人数变化] 内容正常，人数微增 +${o}`):console.log(`📉 [人数变化] 内容平淡，人数微降 ${o}`)):t>=-15?(o=-10-Math.floor(8*Math.random()),console.log(`📉 [人数变化] 内容较差，人数下降 ${o}`)):(o=-30+Math.floor(21*Math.random()),console.log(`📉 [人数变化] 内容很差，人数大幅下降 ${o}`)),o}(e.streamerMessages||[],e.danmaku||[]))}function Va(){const e=document.getElementById("rightReel"),t=document.getElementById("rightReelInner");if(!e||!t)return void console.warn("⚠️ [连线系统] 未找到右侧轮盘元素");const o=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";t.innerHTML=`<img src="${o}" alt="用户" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`,e.setAttribute("onclick","openConnectionManagementDialog()"),e.style.cursor="pointer",e.title="点击管理连线",console.log("✅ [连线系统] 右侧轮盘已更新为用户头像，可点击管理连线")}function Ga(){const n=document.getElementById("danmaku-input");n&&(n.placeholder="输入连线发言（回车发送）",console.log("✅ [连线系统] 输入框已切换为连线发言模式"))}function Ya(){const n=document.getElementById("connectionWaitingCount");if(n&&Ra.queuePosition>=0){const e=Ra.settings,t=e?.maxWaiting||10;n.textContent=`${Ra.queuePosition} / ${t}`}}function Wa(){if(Ra.isAnimating||!Ra.managementOpen)return;Ra.isAnimating=!0,Ra.managementOpen=!1;const n=document.getElementById("managementDialog"),e=document.getElementById("managementDialogOverlay");n&&(n.classList.remove("active"),n.style.right="-400px",n.style.opacity="0"),e&&e.classList.remove("active"),Ja(),setTimeout(()=>{Ra.isAnimating=!1},500),console.log("✅ [连线管理] 管理弹窗已关闭")}function Ja(){Ra.durationTimer&&(clearInterval(Ra.durationTimer),Ra.durationTimer=null,console.log("⏱️ [连线管理] 时长计时器已停止"))}function Ka(){if(!Ra.connectedAt)return;const n=Date.now()-Ra.connectedAt,e=Math.floor(n/1e3),t=Math.floor(e/60),o=e%60,a=document.getElementById("connectionDurationDisplay");a&&(a.textContent=`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`)}function Qa(e="user_ended"){if(!Ra.isConnected)return;if("user_ended"===e){if(!confirm("确定要结束连线吗？"))return}if(console.log(`🔌 [连线系统] 连线结束，原因: ${e}`),Ra.managementOpen&&Wa(),Ra.isConnected=!1,Ra.connectedAt=null,Ra.hasRequested=!1,Ra.pendingInteraction=null,Ra.queuePosition=-1,Ha.isActive||Ha.isPreparing){console.log("⚔️ [PK系统] 连线结束，清理PK状态"),Ha.countdownTimer&&(clearInterval(Ha.countdownTimer),Ha.countdownTimer=null),Ha.scoreAnimationTimer&&(clearInterval(Ha.scoreAnimationTimer),Ha.scoreAnimationTimer=null),Ha.preparingInterval&&(clearInterval(Ha.preparingInterval),Ha.preparingInterval=null),ni();const n=document.getElementById("pkPreparingModal");n&&n.classList.remove("active"),Ha.isActive=!1,Ha.isPreparing=!1,Ha.config=null,Ha.scenario14Data=null}Ja(),Ra.queueInterval&&(clearInterval(Ra.queueInterval),Ra.queueInterval=null);const t=document.getElementById("rightReel"),o=document.getElementById("rightReelInner");t&&o&&Ra.settings&&(t.classList.add("connection-reel"),t.style.cursor="pointer",t.title="点击申请连线",t.setAttribute("onclick","openConnectionDialog()"),o.classList.add("connection-icon-container"),o.style.background="",o.innerHTML='\n      <svg viewBox="0 0 24 24" style="width: 40px; height: 40px; fill: #666;">\n        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>\n        <circle cx="12" cy="12" r="2" fill="#999"/>\n      </svg>\n    ');const a=document.getElementById("danmaku-input");a&&(a.placeholder="Say something...");const i=document.getElementById("userConnectionSpeechBubbles");i&&(i.style.display="none",i.innerHTML=""),Ko&&Ko.details&&(Ko.details.lastConnectionEnd={reason:e,timestamp:Date.now(),userName:n.userProfileData?.name||"用户"},aa(Ko.id,Ko.details).catch(n=>{console.warn("⚠️ [连线系统] 保存结束原因失败:",n)}),console.log(`✅ [连线系统] 结束原因已记录: ${e}`)),"kicked"===e?function(){const n=document.getElementById("kickedModal"),e=document.getElementById("kickedModalOverlay");n&&e&&(e.classList.add("active"),n.classList.add("active"),setTimeout(()=>{!function(){const n=document.getElementById("kickedModal"),e=document.getElementById("kickedModalOverlay");n&&e&&(n.classList.remove("active"),e.classList.remove("active"))}()},3e3))}():mn("已断开连线","success"),console.log("✅ [连线系统] 连线已结束，状态已清理")}function Za(){console.log("🎮 [PK系统] 关闭PK配置弹窗");const n=document.getElementById("pkConfigDialog"),e=document.getElementById("pkConfigDialogOverlay");n&&(n.classList.remove("active"),n.style.right="-400px",n.style.opacity="0"),e&&e.classList.remove("active"),console.log("✅ [PK系统] PK配置弹窗已关闭")}function ni(){console.log("🔄 [PK系统] 恢复原始UI...");const n=document.querySelector(".progress-section");if(n){const e=document.getElementById("pkScoreBar");e&&(e.style.animation="pkBarExit 0.3s ease-out forwards",setTimeout(()=>{e.remove();const t=n.querySelector(".progress-bar");t&&(t.classList.remove("pk-hidden"),t.style.transition="opacity 0.2s ease",t.style.opacity="1")},300))}const e=document.getElementById("pkReelScoreStreamer"),t=document.getElementById("pkReelScoreUser");e&&(e.classList.remove("active"),e.style.animation="pkScoreExitStreamer 0.3s ease-out forwards",setTimeout(()=>e.remove(),300)),t&&(t.classList.remove("active"),t.style.animation="pkScoreExitUser 0.3s ease-out forwards",setTimeout(()=>t.remove(),300));const o=document.querySelector(".header-title");if(o){const n=document.getElementById("pkTimerReplacement");n&&(n.classList.remove("active"),n.style.animation="pkTimerExit 0.3s ease-out forwards",setTimeout(()=>{n.remove(),o.style.transition="opacity 0.2s ease",o.style.opacity="1"},300))}Ha.progressBarVisible=!1,console.log("✅ [PK系统] 原始UI已恢复")}function ei(n,e,t,o,a=!1){console.log(`🎯 [PK系统] 积分变化: 主播${n}→${e}, 用户${t}→${o}`),Ha.scoreAnimationTimer&&(clearInterval(Ha.scoreAnimationTimer),Ha.scoreAnimationTimer=null);const i=document.getElementById("pkStreamerScoreDisplay"),r=document.getElementById("pkUserScoreDisplay");if(!i||!r)return console.warn("⚠️ [PK系统] 未找到积分显示元素"),Ha.streamerScore=e,Ha.userScore=o,void ti();i.classList.add("changing"),r.classList.add("changing");const s=(a?2e3:1200)/1e3*30;let l=0;const c=e-n,d=o-t;Ha.scoreAnimationTimer=setInterval(()=>{l++;const a=(p=l/s,1-Math.pow(1-p,3));var p;const g=Math.round(n+c*a),m=Math.round(t+d*a);Ha.streamerScore=g,Ha.userScore=m,ti(),l>=s&&(clearInterval(Ha.scoreAnimationTimer),Ha.scoreAnimationTimer=null,Ha.streamerScore=e,Ha.userScore=o,ti(),setTimeout(()=>{i.classList.remove("changing"),r.classList.remove("changing")},100),console.log("✅ [PK系统] 积分动画完成"))},1e3/30),Ha.lastScoreUpdate={streamer:e,user:o,timestamp:Date.now()}}function ti(){const n=document.getElementById("pkStreamerScoreDisplay"),e=document.getElementById("pkUserScoreDisplay");n&&(n.textContent=Ha.streamerScore.toString()),e&&(e.textContent=Ha.userScore.toString());const t=Ha.streamerScore+Ha.userScore;if(0===t)oi(50,50);else{oi(Ha.streamerScore/t*100,Ha.userScore/t*100);Ha.streamerScore,Ha.userScore}}function oi(n,e){const t=document.getElementById("pkScoreFillStreamer"),o=document.getElementById("pkScoreFillUser"),a=document.getElementById("pkStreamerScoreDisplay"),i=document.getElementById("pkUserScoreDisplay");t&&(t.style.width=`${n}%`,n>60?t.classList.add("leading"):t.classList.remove("leading")),o&&(o.style.width=`${e}%`,e>60?o.classList.add("leading"):o.classList.remove("leading")),a&&i&&(n>e?(a.classList.add("leading"),i.classList.remove("leading")):e>n?(i.classList.add("leading"),a.classList.remove("leading")):(a.classList.remove("leading"),i.classList.remove("leading")))}function ai(){const n=document.getElementById("pkResultOverlay"),e=document.getElementById("pkResultModal");e&&(e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.8)",e.style.transition="all 0.3s ease-out"),n&&n.classList.remove("active"),setTimeout(()=>{n&&n.remove(),e&&e.remove(),async function(){console.log("🎬 [PK结束] 准备播放结束内容...");let n=Ha.pendingEndContent||Ha.preGeneratedEndContent;if(!n&&Ha.endContentPromise){console.log("⏳ [PK结束] 检测到生成正在进行，等待完成...");try{await Ha.endContentPromise,n=Ha.preGeneratedEndContent,n?console.log("✅ [PK结束] 等待完成，成功获取AI内容"):console.warn("⚠️ [PK结束] Promise完成但无内容（生成失败）")}catch(n){console.error("❌ [PK结束] 等待Promise失败:",n)}}if(!n)return console.warn("⚠️ [PK结束] 无法获取AI内容，跳过播放"),void ii();console.log("✅ [PK结束] 开始播放AI内容"),console.log(`📦 [PK结束] 内容包含: ${n.streamerMessages?.length||0}条主播发言, ${n.danmaku?.length||0}条弹幕`);try{await qa(n),console.log("✅ [PK结束] AI内容播放完成")}catch(n){console.error("❌ [PK结束] 播放AI内容失败:",n)}finally{ii()}}()},300)}function ii(){console.log("🧹 [PK系统] 清理PK状态"),Ha.preGeneratedEndContent=null,Ha.preGeneratedResult=null,Ha.pendingEndContent=null,Ha.prepareTriggered=!1,Ha.endContentGenerating=!1,Ha.endContentPromise=null,Ha.endContentError=!1,console.log("✅ [PK系统] PK状态已清理")}function ri(e){const t=Ko?.details;if(!t||!t.leaderboards||!t.leaderboards[e])return console.warn(`⚠️ [榜单] 没有${e}榜单数据`),"<div style='padding: 20px; text-align: center; color: #71767b;'>暂无数据</div>";let o=[...t.leaderboards[e]];if("gifts"===e&&t.giftLeaderboard&&t.giftLeaderboard.userRank&&t.giftLeaderboard.userRank<=10){const e={userName:n.userProfileData?.name||"我",userHandle:n.userProfileData?.handle||"@user",value:t.giftLeaderboard.userTotalPoints,isUser:!0,badge:"👤"};o.push(e),o.sort((n,e)=>e.value-n.value),o=o.slice(0,10)}return o.map((t,o)=>{const a=o<3,i=a?["🥇","🥈","🥉"][o]:o+1,r=t.badge?`<span class="rank-badge">${t.badge}</span>`:"",s=t.isUser?n.userProfileData?.avatar||"https://api.dicebear.com/7.x/avataaars/svg?seed=user":`https://api.dicebear.com/7.x/avataaars/svg?seed=${e}_${o+1}`;return`\n        <div class="rank-item ${a?"top-3":""} ${t.isUser?"user-rank-item":""}">\n          <span class="rank-medal">${i}</span>\n          <img class="rank-avatar" src="${s}" alt="${t.userName}"/>\n          <span class="rank-name">${t.userName}</span>\n          <span class="rank-value">${function(n,e){const t=Ba[e];if(!t)return n;const o=t.formatValue(n);return`${t.valuePrefix}${o}`}(t.value,e)}${r}</span>\n        </div>\n      `}).join("")}function si(){const n=La.types[La.currentIndex],e=document.getElementById("leaderboardTitle"),t=document.getElementById("leaderboardIndicator"),o=document.getElementById("leaderboardPrev"),a=document.getElementById("leaderboardNext");e&&(e.textContent=Ba[n].title),t&&(t.textContent=`${La.currentIndex+1}/3`),o&&(0===La.currentIndex?o.classList.add("disabled"):o.classList.remove("disabled")),a&&(2===La.currentIndex?a.classList.add("disabled"):a.classList.remove("disabled")),La.types.forEach((n,e)=>{const t=document.getElementById(`tapeSide${e}`);t&&(t.innerHTML=ri(n))})}function li(n,e){if(La.isAnimating)return;if(n<0||n>2)return;if(n===La.currentIndex)return;La.isAnimating=!0;const t=La.currentIndex,o=document.getElementById(`tapeSide${t}`),a=document.getElementById(`tapeSide${n}`);o&&a?([o,a].forEach(n=>{n.classList.remove("flip-out-left","flip-in-right","flip-out-right","flip-in-left")}),"next"===e?(o.classList.add("flip-out-left"),a.classList.add("flip-in-right")):(o.classList.add("flip-out-right"),a.classList.add("flip-in-left")),a.classList.add("active"),setTimeout(()=>{o.classList.remove("active","flip-out-left","flip-out-right"),a.classList.remove("flip-in-right","flip-in-left"),La.currentIndex=n,La.currentType=La.types[n],si(),La.isAnimating=!1},500)):La.isAnimating=!1}function ci(){La.currentIndex>0&&li(La.currentIndex-1,"prev")}function di(){La.currentIndex<2&&li(La.currentIndex+1,"next")}n.prevLeaderboard=ci,n.openStreamerProfileFromLive=async function(){try{if(Xi=!0,!Ko)return mn("直播间数据异常","error"),void(Xi=!1);Qo&&(clearInterval(Qo),Qo=null),Zo&&(clearTimeout(Zo),Zo=null),Gi&&(clearInterval(Gi),Gi=null),Fi&&(clearInterval(Fi),Fi=null),_i&&(clearInterval(_i),_i=null);const t=document.getElementById("streamerSpeech"),o=document.getElementById("speechContent"),a=document.getElementById("audioBars"),i=t?.parentElement;if(t&&(t.style.display="none",t.classList.remove("active","fading"),t.style.opacity="0"),o&&(o.style.animation="none"),a&&(a.classList.remove("dimmed"),a.style.opacity="1"),i&&i.classList.remove("speech-active"),Qi&&(Qi.remove(),Qi=null),Ji=[],Zi=[],nr.clear(),Ki=!1,ka(),Oi=0,na&&na.isOpen){const n=document.getElementById("controlSidebar"),e=document.getElementById("controlSidebarOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),na.isOpen=!1,na.isAnimating=!1}const s={name:Ko.streamerName||"主播",handle:Ko.streamerHandle||"@streamer",avatar:Ko.streamerAvatar||""},l=document.getElementById("danmakuList"),c=(l?Array.from(l.children):[]).map(n=>{const e=n.querySelector(".danmaku-user"),t=n.querySelector(".danmaku-text");return{userId:e?e.textContent:"观众",content:t?t.textContent:"",time:Date.now()}}).filter(n=>n.content),d=[];Ko.details&&Ko.details.streamerMessages&&Ko.details.streamerMessages.slice(-10).forEach(n=>{d.push({content:n.text||n,time:Date.now()})});const p={liveTitle:Ko.title||"直播中",liveSubtitle:`${Ko.streamerName} ${Ko.streamerHandle}`||"",liveDuration:Ko.duration||"00:00",streamerSpeeches:d,danmakuMessages:c,onlineViewers:Ko.onlineCount||0,liveDescription:Ko.details&&(Ko.details.details||Ko.details.description)||"",liveNotice:Ko.details&&Ko.details.notice||"",liveTags:Ko.details&&Ko.details.tags||[]},g=r.clean(Ko.streamerHandle||s.handle);let m=null;try{const n=e(),t=await n.xFanClubMemberships.get(g);t&&t.joined&&(m={joined:!0,level:t.level||0,points:t.points||0,checkinDays:t.checkinDays||0})}catch(n){console.warn("⚠️ [直播→主页] 获取粉丝团数据失败:",n)}let x=0,u=[];try{Ko.details&&Ko.details.giftLeaderboard&&(x=Ko.details.giftLeaderboard.userTotalPoints||0,Ko.details.userGifts&&Ko.details.userGifts.length>0&&(u=Ko.details.userGifts.map(n=>({name:n.giftName,code:n.giftCode,price:n.giftPrice,description:n.description||"",isCustom:n.isCustom||!1,category:n.category||"",imageUrl:n.imageUrl||"",imageLocal:n.imageLocal||"",useLocalImage:n.useLocalImage||!1,timestamp:n.timestamp}))))}catch(n){console.warn("⚠️ [直播→主页] 获取礼物贡献失败:",n)}let h=[];try{Ko.details&&Ko.details.danmaku&&(h=Ko.details.danmaku.filter(n=>!0===n.isUser).map(n=>n.content))}catch(n){console.warn("⚠️ [直播→主页] 获取用户弹幕失败:",n)}let f=0;try{const n=e(),t=(await n.xAccountProfiles.toArray()).find(n=>n.data&&n.data.accountInfo&&(n.data.accountInfo.handle===g||n.data.accountInfo.handle===`@${g}`));t&&t.data&&t.data.accountInfo&&(f=t.data.accountInfo.followers||0)}catch(n){console.warn("⚠️ [直播→主页] 获取主播追随者数失败:",n)}const b={source:"live",liveContext:p,liveUserData:{fanClub:m,giftContribution:x,gifts:u,userDanmaku:h,streamerFollowers:f},isLiveStreaming:!0};Aa();const v=document.getElementById("x-live-page");v&&(v.style.visibility="hidden",v.style.opacity="0",v.style.pointerEvents="none");const y=document.getElementById("x-social-screen");y&&(y.style.display="flex",y.style.visibility="visible");const w=document.getElementById("x-home-page");w&&(w.style.display="flex");const k=document.querySelector(".x-top-bar"),$=document.querySelector(".x-bottom-nav");k&&(k.style.display="flex"),$&&($.style.display="flex"),await new Promise(n=>setTimeout(n,150)),await n.openAccountProfile(s.name,s.handle,s.avatar,b)}catch(n){console.error("❌ [直播→主页] 打开主播主页失败:",n),mn("打开主播主页失败: "+n.message,"error")}};const pi=[{id:"vinyl",name:"VINYL RECORD",code:"A-1",subtitle:"黑胶唱片",price:10,rarity:1,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 外圈 --\x3e\n      <circle cx="24" cy="24" r="22" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="0.5"/>\n      <circle cx="24" cy="24" r="20" fill="rgba(30,30,30,0.95)" stroke="rgba(255,255,255,0.6)" stroke-width="1"/>\n      \x3c!-- 纹路 --\x3e\n      <circle cx="24" cy="24" r="18" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="0.3"/>\n      <circle cx="24" cy="24" r="16" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="0.3"/>\n      <circle cx="24" cy="24" r="14" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.3"/>\n      \x3c!-- 中心标签 --\x3e\n      <circle cx="24" cy="24" r="8" fill="rgba(60,60,60,0.9)" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>\n      <circle cx="24" cy="24" r="2" fill="rgba(20,20,20,0.95)"/>\n    </svg>'},{id:"cassette",name:"CASSETTE TAPE",code:"A-2",subtitle:"磁带卡带",price:50,rarity:1,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 磁带外壳 --\x3e\n      <rect x="6" y="12" width="36" height="24" rx="2" fill="rgba(40,40,40,0.95)" stroke="rgba(255,255,255,0.7)" stroke-width="1"/>\n      \x3c!-- 窗口 --\x3e\n      <rect x="10" y="16" width="28" height="12" rx="1" fill="rgba(20,20,20,0.8)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>\n      \x3c!-- 转轮左 --\x3e\n      <circle cx="16" cy="22" r="4" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>\n      <circle cx="16" cy="22" r="1.5" fill="rgba(60,60,60,0.9)"/>\n      \x3c!-- 转轮右 --\x3e\n      <circle cx="32" cy="22" r="4" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>\n      <circle cx="32" cy="22" r="1.5" fill="rgba(60,60,60,0.9)"/>\n      \x3c!-- 磁带 --\x3e\n      <rect x="18" y="21" width="12" height="2" fill="rgba(80,60,40,0.8)"/>\n      \x3c!-- 螺丝 --\x3e\n      <circle cx="10" cy="15" r="0.8" fill="rgba(255,255,255,0.4)"/>\n      <circle cx="38" cy="15" r="0.8" fill="rgba(255,255,255,0.4)"/>\n    </svg>'},{id:"ticket",name:"CONCERT TICKET",code:"B-1",subtitle:"演出门票",price:100,rarity:2,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 票据主体 --\x3e\n      <rect x="8" y="14" width="32" height="20" fill="rgba(50,50,50,0.95)" stroke="rgba(255,255,255,0.8)" stroke-width="1" stroke-dasharray="2,1"/>\n      \x3c!-- 撕裂线 --\x3e\n      <line x1="28" y1="14" x2="28" y2="34" stroke="rgba(255,255,255,0.4)" stroke-width="0.5" stroke-dasharray="1,1"/>\n      \x3c!-- 打孔 --\x3e\n      <circle cx="12" cy="18" r="1" fill="rgba(0,0,0,0.8)"/>\n      <circle cx="12" cy="30" r="1" fill="rgba(0,0,0,0.8)"/>\n      <circle cx="36" cy="18" r="1" fill="rgba(0,0,0,0.8)"/>\n      <circle cx="36" cy="30" r="1" fill="rgba(0,0,0,0.8)"/>\n      \x3c!-- 文字占位 --\x3e\n      <rect x="12" y="20" width="12" height="2" fill="rgba(255,255,255,0.6)"/>\n      <rect x="12" y="24" width="10" height="1.5" fill="rgba(255,255,255,0.4)"/>\n      <rect x="12" y="27" width="8" height="1.5" fill="rgba(255,255,255,0.3)"/>\n      \x3c!-- 副券号码 --\x3e\n      <rect x="30" y="22" width="6" height="4" fill="rgba(255,255,255,0.2)"/>\n    </svg>'},{id:"backstage",name:"BACKSTAGE PASS",code:"B-2",subtitle:"后台通行证",price:500,rarity:3,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 卡片主体 --\x3e\n      <rect x="10" y="12" width="28" height="24" rx="3" fill="rgba(45,45,45,0.95)" stroke="rgba(255,255,255,0.85)" stroke-width="1.2"/>\n      \x3c!-- 顶部条带 --\x3e\n      <rect x="10" y="12" width="28" height="6" rx="3" fill="rgba(70,70,70,0.9)"/>\n      \x3c!-- 磁条 --\x3e\n      <rect x="12" y="30" width="24" height="3" fill="rgba(80,80,80,0.9)"/>\n      \x3c!-- 星标 --\x3e\n      <path d="M24 20l1.5 3 3.5 0.5-2.5 2.5 0.5 3.5-3-1.5-3 1.5 0.5-3.5-2.5-2.5 3.5-0.5z" fill="rgba(255,255,255,0.7)" stroke="rgba(255,255,255,0.9)" stroke-width="0.5"/>\n      \x3c!-- 边角孔 --\x3e\n      <circle cx="14" cy="16" r="1.2" fill="rgba(20,20,20,0.8)"/>\n      <circle cx="34" cy="16" r="1.2" fill="rgba(20,20,20,0.8)"/>\n    </svg>'},{id:"platinum",name:"PLATINUM DISC",code:"C-1",subtitle:"白金唱片",price:1e3,rarity:4,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 外框 --\x3e\n      <rect x="8" y="10" width="32" height="28" rx="2" fill="rgba(50,50,50,0.95)" stroke="rgba(255,255,255,0.9)" stroke-width="1.2"/>\n      \x3c!-- 唱片 --\x3e\n      <circle cx="24" cy="22" r="10" fill="rgba(200,200,200,0.3)" stroke="rgba(255,255,255,0.85)" stroke-width="1"/>\n      <circle cx="24" cy="22" r="8" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="0.3"/>\n      <circle cx="24" cy="22" r="6" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="0.3"/>\n      <circle cx="24" cy="22" r="2" fill="rgba(40,40,40,0.9)"/>\n      \x3c!-- 铭牌 --\x3e\n      <rect x="12" y="33" width="24" height="3" fill="rgba(180,180,180,0.4)" stroke="rgba(255,255,255,0.6)" stroke-width="0.5"/>\n      \x3c!-- 装饰钉 --\x3e\n      <circle cx="11" cy="13" r="0.8" fill="rgba(255,255,255,0.5)"/>\n      <circle cx="37" cy="13" r="0.8" fill="rgba(255,255,255,0.5)"/>\n      <circle cx="11" cy="35" r="0.8" fill="rgba(255,255,255,0.5)"/>\n      <circle cx="37" cy="35" r="0.8" fill="rgba(255,255,255,0.5)"/>\n    </svg>'},{id:"master",name:"MASTER TAPE",code:"C-2",subtitle:"珍藏母带",price:5e3,rarity:5,icon:'<svg viewBox="0 0 48 48" style="width: 100%; height: 100%;">\n      \x3c!-- 卷轴底座 --\x3e\n      <rect x="10" y="14" width="28" height="20" rx="2" fill="rgba(55,55,55,0.95)" stroke="rgba(255,255,255,0.95)" stroke-width="1.5"/>\n      \x3c!-- 左卷轴 --\x3e\n      <circle cx="17" cy="24" r="6" fill="rgba(40,40,40,0.9)" stroke="rgba(255,255,255,0.8)" stroke-width="1"/>\n      <circle cx="17" cy="24" r="4" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>\n      <circle cx="17" cy="24" r="2" fill="rgba(20,20,20,0.95)"/>\n      \x3c!-- 右卷轴 --\x3e\n      <circle cx="31" cy="24" r="6" fill="rgba(40,40,40,0.9)" stroke="rgba(255,255,255,0.8)" stroke-width="1"/>\n      <circle cx="31" cy="24" r="4" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>\n      <circle cx="31" cy="24" r="2" fill="rgba(20,20,20,0.95)"/>\n      \x3c!-- 磁带 --\x3e\n      <rect x="19" y="23" width="10" height="2" fill="rgba(100,80,60,0.8)"/>\n      \x3c!-- 标签 --\x3e\n      <rect x="14" y="16" width="20" height="2.5" fill="rgba(200,200,200,0.4)" stroke="rgba(255,255,255,0.6)" stroke-width="0.5"/>\n      \x3c!-- 边角装饰 --\x3e\n      <path d="M10 14 L12 14 L12 16" stroke="rgba(255,255,255,0.5)" stroke-width="0.8" fill="none"/>\n      <path d="M38 14 L36 14 L36 16" stroke="rgba(255,255,255,0.5)" stroke-width="0.8" fill="none"/>\n    </svg>'}];n.liveGifts=pi;let gi={isOpen:!1,selectedGift:null},mi=[],xi={isOpen:!1,currentView:"categories",currentCategoryId:null};async function ui(){const n=e(),t=vt||"default";try{if(await n.xCustomGiftCategories.where({accountId:t,isDefault:1}).first())return;const e=`gift_cat_${Date.now()}`;await n.xCustomGiftCategories.add({id:e,accountId:t,name:"原始礼物",enabled:1,isDefault:1,createdAt:(new Date).toISOString()});const o=pi.map(n=>({id:`gift_${Date.now()}_${n.id}`,categoryId:e,accountId:t,name:n.name,subtitle:n.subtitle,code:n.code,description:n.subtitle,imageUrl:"",icon:n.icon,useLocalImage:!1,points:n.price,animationType:"default",createdAt:(new Date).toISOString()}));await n.xCustomGifts.bulkAdd(o)}catch(n){console.error("❌ [自定义礼物] 初始化失败:",n)}}async function hi(){const n=e(),t=vt||"default";try{return(await n.xCustomGiftCategories.where({accountId:t}).toArray()).sort((n,e)=>n.isDefault?-1:e.isDefault?1:new Date(e.createdAt)-new Date(n.createdAt))}catch(n){return console.error("❌ [自定义礼物] 获取分类失败:",n),[]}}async function fi(){const n=e(),t=vt||"default";try{const e=await n.xCustomGiftCategories.where({accountId:t,enabled:1}).toArray();if(0===e.length)return[];const o=e.map(n=>n.id);return(await n.xCustomGifts.where("categoryId").anyOf(o).toArray()).sort((n,e)=>(n.points||0)-(e.points||0))}catch(n){return console.error("❌ [自定义礼物] 获取启用礼物失败:",n),[]}}function bi(){const n=localStorage.getItem(`livePoints_${vt||"default"}`),e=n?parseInt(n):0;return isNaN(e)?(console.warn("⚠️ [积分系统] 检测到无效积分值，已重置为5000P"),vi(5e3),5e3):e}function vi(n){isNaN(n)||null==n?console.error(`❌ [积分系统] 拒绝保存无效积分: ${n}`):localStorage.setItem(`livePoints_${vt||"default"}`,n.toString())}function yi(n){if(isNaN(n)||n<=0)return console.error(`❌ [积分系统] 无效扣除金额: ${n}`),!1;const e=bi();return e<n?(console.warn(`⚠️ [积分系统] 积分不足: 需要${n}P，当前${e}P`),!1):(vi(e-n),!0)}async function wi(){if(!gi.isOpen)return;const n=document.querySelector(".jukebox-selection-area"),e=document.getElementById("giftPointsValue");if(!n)return;const t=bi();e&&(e.textContent=t.toLocaleString());const o=await fi();let a=o.length>0?o:pi;0===o.length&&(a=[...pi].sort((n,e)=>(n.price||0)-(e.price||0)));const i=gi.selectedGift?.id,r=a.map(n=>{const e=t>=n.points,o=n.points>=1e3?(n.points/1e3).toFixed(n.points%1e3==0?0:1)+"K":n.points;let a="";return a=n.useLocalImage&&n.imageLocal?`<img src="${n.imageLocal}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.imageUrl?`<img src="${n.imageUrl}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.icon?n.icon:'<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;color:rgba(255,255,255,0.3);">?</div>',`\n        <div class="jukebox-ticket ${e?"":"insufficient"}" \n             data-gift-id="${n.id}"\n             data-gift-code="${n.code}"\n             onclick="selectGift('${n.id}')">\n          \x3c!-- 左侧：编号+图标区 --\x3e\n          <div class="ticket-left-section">\n            <div class="ticket-code">${n.code}</div>\n            <div class="ticket-icon-box">\n              ${a}\n            </div>\n            <div class="ticket-perforations">\n              <div class="perf"></div>\n              <div class="perf"></div>\n              <div class="perf"></div>\n            </div>\n          </div>\n          \n          \x3c!-- 右侧：信息区 --\x3e\n          <div class="ticket-right-section">\n            <div class="ticket-main-name">${n.name}</div>\n            <div class="ticket-subtitle">${n.subtitle||n.description||""}</div>\n            <div class="ticket-price-tag">\n              <span class="price-amount">${o}</span>\n              <span class="price-currency">P</span>\n            </div>\n            ${e?"":'<div class="insufficient-badge">INSUFFICIENT</div>'}\n          </div>\n          \n          \x3c!-- 选中指针 --\x3e\n          <div class="selection-pointer">▶</div>\n        </div>\n      `}).join("");if(n.innerHTML=r,i){if(a.find(n=>n.id===i))await $i(i);else{gi.selectedGift=null;const n=document.getElementById("selectedGiftCode");n&&(n.textContent="- -");const e=document.getElementById("giftFooterInfo"),t=document.getElementById("giftSendBtn");e&&(e.innerHTML='<div class="play-bar-placeholder">SELECT A GIFT TO PLAY</div>'),t&&(t.disabled=!0,t.classList.remove("ready"))}}}function ki(){if(!gi.isOpen)return;const n=document.getElementById("giftMenuPanel"),e=document.getElementById("giftMenuOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{n&&n.parentNode&&n.parentNode.removeChild(n),e&&e.parentNode&&e.parentNode.removeChild(e),gi.isOpen=!1,gi.selectedGift=null},300)}async function $i(n){let e=(await fi()).find(e=>e.id===n);if(e||(e=pi.find(e=>e.id===n),e&&(e={id:e.id,name:e.name,subtitle:e.subtitle,code:e.code,points:e.price,icon:e.icon,animationType:"default"})),!e)return;if(bi()<e.points)return void mn(`积分不足，需要 ${e.points}P`,"error");gi.selectedGift=e,document.querySelectorAll(".jukebox-ticket").forEach(n=>{n.classList.remove("selected")});const t=document.querySelector(`[data-gift-id="${n}"]`);t&&t.classList.add("selected");const o=document.getElementById("selectedGiftCode");o&&(o.textContent=e.code);const a=document.getElementById("giftFooterInfo"),i=document.getElementById("giftSendBtn");if(a){const n=e.points>=1e3?(e.points/1e3).toFixed(e.points%1e3==0?0:1)+"K":e.points;let t="";t=e.useLocalImage&&e.imageLocal?`<img src="${e.imageLocal}" alt="${e.name}" style="width:100%;height:100%;object-fit:contain;">`:e.imageUrl?`<img src="${e.imageUrl}" alt="${e.name}" style="width:100%;height:100%;object-fit:contain;">`:e.icon?e.icon:'<div style="width:24px;height:24px;background:rgba(255,255,255,0.1);border-radius:4px;"></div>',a.innerHTML=`\n      <div class="play-bar-selected">\n        <div class="selected-icon-mini">\n          ${t}\n        </div>\n        <div class="selected-info">\n          <div class="selected-name">${e.name}</div>\n          <div class="selected-price">${n}P</div>\n        </div>\n      </div>\n    `}i&&(i.disabled=!1,i.classList.add("ready"))}async function Ci(){const n=document.getElementById("customGiftContent");if(!n)return;const e=`\n    <div class="category-list-view">\n      \x3c!-- 顶部说明 --\x3e\n      <div class="view-header">\n        <div class="view-title">礼物分类管理</div>\n        <div class="view-hint">创建分类 → 添加礼物 → 启用分类</div>\n      </div>\n\n      \x3c!-- 分类列表 --\x3e\n      <div class="category-grid">\n        ${(await hi()).map(n=>`\n          <div class="category-card ${n.enabled?"enabled":""} ${n.isDefault?"default":""}">\n            <div class="category-header">\n              <div class="category-name">${n.name}</div>\n              ${n.isDefault?'<div class="category-badge">默认</div>':""}\n            </div>\n\n            <div class="category-actions">\n              <button class="cat-btn view" onclick="viewCategoryGifts('${n.id}')" title="查看礼物">\n                <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;">\n                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>\n                  <circle cx="12" cy="12" r="3"/>\n                </svg>\n              </button>\n              <button class="cat-btn toggle ${n.enabled?"active":""}" onclick="toggleCategory('${n.id}')" title="${n.enabled?"禁用":"启用"}">\n                ${n.enabled?'<svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>':'<svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;"><circle cx="12" cy="12" r="10"/></svg>'}\n              </button>\n              ${n.isDefault?"":`<button class="cat-btn delete" onclick="deleteCategory('${n.id}')" title="删除">\n                  <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;">\n                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>\n                  </svg>\n                </button>`}\n            </div>\n          </div>\n        `).join("")}\n      </div>\n\n      \x3c!-- 添加新分类按钮 --\x3e\n      <div class="add-category-section">\n        <button class="add-category-btn" onclick="showAddCategoryForm()">\n          <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:none;stroke:currentColor;stroke-width:2;">\n            <circle cx="12" cy="12" r="10"/>\n            <path d="M12 8v8m-4-4h8"/>\n          </svg>\n          <span>新建分类</span>\n        </button>\n      </div>\n    </div>\n  `;n.innerHTML=e,xi.currentView="categories"}function Ii(){const n=document.getElementById("addCatFormPanel"),e=document.getElementById("addCatFormOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{n&&n.remove(),e&&e.remove()},200)}async function B(n){const t=await async function(n){const t=e();try{const e=await t.xCustomGiftCategories.get(n);return!!e&&(await t.xCustomGiftCategories.update(n,{enabled:1===e.enabled?0:1}),!0)}catch(n){return console.error("❌ [自定义礼物] 切换分类状态失败:",n),!1}}(n);t&&(await Ci(),await wi())}async function z(n){if(!confirm("确定删除此分类？分类下的所有礼物也将被删除。"))return;const t=await async function(n){const t=e();try{const e=await t.xCustomGiftCategories.get(n);return e&&1===e.isDefault?(mn("默认分类无法删除","error"),!1):(await t.xCustomGifts.where({categoryId:n}).delete(),await t.xCustomGiftCategories.delete(n),!0)}catch(n){return console.error("❌ [自定义礼物] 删除分类失败:",n),!1}}(n);t&&(mn("分类已删除","success"),await Ci(),await wi())}async function Si(n){const t=document.getElementById("customGiftContent");if(!t)return;const o=(await hi()).find(e=>e.id===n),a=await async function(n){const t=e();try{return(await t.xCustomGifts.where({categoryId:n}).toArray()).sort((n,e)=>new Date(n.createdAt)-new Date(e.createdAt))}catch(n){return console.error("❌ [自定义礼物] 获取礼物列表失败:",n),[]}}(n);xi.currentCategoryId=n,xi.currentView="giftList";const i=`\n    <div class="gift-list-view">\n      \x3c!-- 返回按钮 --\x3e\n      <div class="view-header">\n        <button class="back-btn" onclick="backToCategoryList()">\n          <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2;">\n            <path d="M15 18l-6-6 6-6"/>\n          </svg>\n        </button>\n        <div class="view-title">${o?o.name:"礼物列表"}</div>\n        <div class="view-hint">${a.length} 个礼物</div>\n      </div>\n\n      \x3c!-- 礼物列表 --\x3e\n      <div class="gift-grid">\n        ${0===a.length?'\n          <div class="empty-gifts">\n            <svg viewBox="0 0 24 24" style="width:48px;height:48px;fill:none;stroke:rgba(255,255,255,0.2);stroke-width:1.5;">\n              <rect x="3" y="3" width="18" height="18" rx="2"/>\n              <path d="M12 8v8m-4-4h8"/>\n            </svg>\n            <p>暂无礼物</p>\n            <p class="hint">点击下方按钮添加第一个礼物</p>\n          </div>\n        ':a.map(n=>`\n          <div class="gift-item-card" onclick="editGift('${n.id}')" style="cursor: pointer;">\n            <div class="gift-icon-box">\n              ${n.useLocalImage&&n.imageLocal?`<img src="${n.imageLocal}" alt="${n.name}">`:n.imageUrl?`<img src="${n.imageUrl}" alt="${n.name}">`:n.icon||'<div class="placeholder-icon">?</div>'}\n            </div>\n            <div class="gift-item-info">\n              <div class="gift-item-name">${n.name}</div>\n              <div class="gift-item-points">${n.points}P</div>\n            </div>\n            <button class="gift-delete-btn" onclick="event.stopPropagation(); deleteGift('${n.id}')" title="删除">\n              <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;">\n                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>\n              </svg>\n            </button>\n          </div>\n        `).join("")}\n      </div>\n\n      \x3c!-- 添加礼物按钮 --\x3e\n      <div class="add-gift-section">\n        <button class="add-gift-btn" onclick="showAddGiftForm('${n}')">\n          <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:none;stroke:currentColor;stroke-width:2;">\n            <circle cx="12" cy="12" r="10"/>\n            <path d="M12 8v8m-4-4h8"/>\n          </svg>\n          <span>添加礼物</span>\n        </button>\n      </div>\n    </div>\n  `;t.innerHTML=i}function Mi(n,e=null){const t=document.querySelector(".live-room");if(!t)return;const o=!!e,a=`\n    <div class="add-gift-overlay" id="addGiftOverlay" onclick="closeAddGiftForm()"></div>\n    <div class="add-gift-panel" id="addGiftPanel">\n      <div class="form-header">\n        <div class="form-title">${o?"编辑礼物":"添加新礼物"}</div>\n        <div class="form-close" onclick="closeAddGiftForm()">×</div>\n      </div>\n\n      <div class="form-body" style="max-height: 500px; overflow-y: auto; padding: 20px;">\n        \x3c!-- 礼物名称 --\x3e\n        <div class="form-group">\n          <label>礼物名称 *</label>\n          <input type="text" id="giftName" placeholder="例如：星空礼盒" maxlength="30" oninput="analyzeGiftName()" value="${o?e.name:""}">\n        </div>\n\n        \x3c!-- 礼物介绍 --\x3e\n        <div class="form-group">\n          <label>礼物介绍</label>\n          <input type="text" id="giftDescription" placeholder="简短介绍这个礼物" maxlength="50" value="${o&&e.description||""}">\n        </div>\n\n        \x3c!-- 智能积分推荐 --\x3e\n        <div class="smart-points-suggest" id="smartPointsSuggest" style="display:none;">\n          <div class="suggest-icon">💡</div>\n          <div class="suggest-text" id="suggestText"></div>\n        </div>\n\n        \x3c!-- 礼物积分 --\x3e\n        <div class="form-group">\n          <label>礼物积分 * (最少50)</label>\n          <input type="number" id="giftPoints" placeholder="50" min="50" value="${o?e.points:50}">\n        </div>\n\n        \x3c!-- 礼物图样 --\x3e\n        <div class="form-group">\n          <label>礼物图样</label>\n          <div class="image-upload-section">\n            \x3c!-- URL上传 --\x3e\n            <div class="upload-option">\n              <div class="option-header">\n                <input type="checkbox" id="useUrlImage" ${o&&e.useLocalImage?"":"checked"} onchange="toggleImageSource()">\n                <label for="useUrlImage">URL图片</label>\n              </div>\n              <input type="url" id="giftImageUrl" placeholder="https://example.com/image.png" ${o&&e.useLocalImage?"disabled":""} value="${o&&e.imageUrl||""}">\n            </div>\n\n            \x3c!-- 本地上传 --\x3e\n            <div class="upload-option">\n              <div class="option-header">\n                <input type="checkbox" id="useLocalImage" ${o&&e.useLocalImage?"checked":""} onchange="toggleImageSource()">\n                <label for="useLocalImage">本地上传</label>\n              </div>\n              <input type="file" id="giftImageLocal" accept="image/*" ${o&&e.useLocalImage?"":"disabled"} onchange="previewLocalImage()">\n              <div class="image-preview" id="imagePreview" style="display:${o&&e.imageLocal?"block":"none"};">\n                <img id="previewImg" src="${o&&e.imageLocal?e.imageLocal:""}" alt="预览">\n              </div>\n            </div>\n          </div>\n          <div class="upload-hint">可同时勾选两种方式，系统会优先使用勾选的图片源</div>\n        </div>\n\n        \x3c!-- 礼物动画 --\x3e\n        <div class="form-group">\n          <label>礼物动画</label>\n          <select id="giftAnimation">\n            <option value="default" ${o&&"default"===e.animationType?"selected":""}>默认动画（旋转卡片）</option>\n            <option value="float" ${o&&"float"===e.animationType?"selected":""}>浮动动画（上升飘散）</option>\n            <option value="explosion" ${o&&"explosion"===e.animationType?"selected":""}>爆炸动画（粒子爆发）</option>\n          </select>\n        </div>\n\n        <input type="hidden" id="giftCategoryId" value="${n}">\n        <input type="hidden" id="giftEditId" value="${o?e.id:""}">\n      </div>\n\n      <div class="form-footer">\n        <button class="form-btn cancel" onclick="closeAddGiftForm()">取消</button>\n        <button class="form-btn submit" onclick="submitNewGift()">${o?"保存":"创建"}</button>\n      </div>\n    </div>\n  `;t.insertAdjacentHTML("beforeend",a),setTimeout(()=>{const n=document.getElementById("addGiftPanel"),e=document.getElementById("addGiftOverlay");n&&n.classList.add("active"),e&&e.classList.add("active")},50)}function Ti(){const n=document.getElementById("addGiftPanel"),e=document.getElementById("addGiftOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{n&&n.remove(),e&&e.remove()},200)}n.nextLeaderboard=di,n.closeLeaderboard=function(){if(!La.isOpen)return;const n=document.getElementById("leaderboardPanel");n&&(n.classList.remove("active"),setTimeout(()=>{n.remove(),La.isOpen=!1,La.currentIndex=0,La.currentType="gifts"},500))},n.refreshGiftMenu=wi,n.openCustomGiftSystem=async function(){if(xi.isOpen)return;await ui();const n=document.querySelector(".live-room");if(!n)return;n.insertAdjacentHTML("beforeend",'\n    <div class="custom-gift-overlay" id="customGiftOverlay" onclick="closeCustomGiftSystem()"></div>\n    <div class="custom-gift-panel" id="customGiftPanel">\n      \x3c!-- 顶部标题栏 --\x3e\n      <div class="custom-gift-header">\n        <div class="header-vinyl-icon"></div>\n        <div class="header-title">GIFT MANAGER</div>\n        <div class="header-close" onclick="closeCustomGiftSystem()">×</div>\n      </div>\n\n      \x3c!-- 内容区域 --\x3e\n      <div class="custom-gift-content" id="customGiftContent">\n        \x3c!-- 动态内容在这里渲染 --\x3e\n      </div>\n    </div>\n  '),function(){if(document.getElementById("customGiftStyles"))return;const n=document.createElement("style");n.id="customGiftStyles",n.textContent="\n    /* 🎵 自定义礼物管理系统 - 磁带播放器风格 - Linus优化版 */\n    .custom-gift-overlay {\n      position: fixed;\n      inset: 0;\n      background: transparent;\n      z-index: 10005;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n      pointer-events: none;\n    }\n\n    .custom-gift-overlay.active {\n      opacity: 1;\n    }\n\n    /* 主面板 - 像磁带播放器机身 */\n    .custom-gift-panel {\n      position: fixed;\n      bottom: 0;\n      left: 50%;\n      transform: translateX(-50%) translateY(100%);\n      width: 94%;\n      max-width: 420px;\n      max-height: 85vh;\n      background: linear-gradient(135deg, \n        rgba(25,25,25,0.98) 0%, \n        rgba(15,15,15,0.98) 50%, \n        rgba(20,20,20,0.98) 100%);\n      border: 2px solid rgba(100,100,100,0.4);\n      border-bottom: none;\n      border-radius: 12px 12px 0 0;\n      box-shadow: \n        0 -8px 32px rgba(0,0,0,0.9),\n        inset 0 1px 0 rgba(255,255,255,0.1),\n        inset 0 -1px 2px rgba(0,0,0,0.5);\n      z-index: 10006;\n      opacity: 0;\n      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n      pointer-events: auto;\n    }\n\n    .custom-gift-panel.active {\n      opacity: 1;\n      transform: translateX(-50%) translateY(0);\n    }\n\n    /* 顶部标题栏 - LCD显示屏风格 */\n    .custom-gift-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 12px 16px;\n      background: linear-gradient(180deg, rgba(30,30,30,0.95), rgba(20,20,20,0.95));\n      border-bottom: 2px solid rgba(100,100,100,0.3);\n      position: relative;\n    }\n\n    /* 扫描线效果 */\n    .custom-gift-header::before {\n      content: '';\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(0,0,0,0.1) 2px,\n        rgba(0,0,0,0.1) 4px\n      );\n      pointer-events: none;\n    }\n\n    .header-vinyl-icon {\n      width: 20px;\n      height: 20px;\n      background: \n        radial-gradient(circle at center, \n          rgba(80,80,80,1) 0%, \n          rgba(80,80,80,1) 25%, \n          transparent 25%, \n          transparent 45%, \n          rgba(80,80,80,1) 45%, \n          rgba(80,80,80,1) 55%, \n          transparent 55%);\n      border-radius: 50%;\n      border: 2px solid rgba(120,120,120,0.6);\n      animation: vinyl-spin 8s linear infinite;\n      flex-shrink: 0;\n    }\n\n    @keyframes vinyl-spin {\n      from { transform: rotate(0deg); }\n      to { transform: rotate(360deg); }\n    }\n\n    .header-title {\n      flex: 1;\n      text-align: center;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      font-weight: bold;\n      letter-spacing: 4px;\n      color: rgba(200,200,200,0.95);\n      text-shadow: 0 1px 2px rgba(0,0,0,0.8);\n      position: relative;\n      z-index: 1;\n    }\n\n    .header-close {\n      width: 24px;\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      color: rgba(180,180,180,0.7);\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border-radius: 2px;\n      border: 1px solid rgba(100,100,100,0.3);\n      background: rgba(40,40,40,0.5);\n      flex-shrink: 0;\n      position: relative;\n      z-index: 1;\n    }\n\n    .header-close:hover {\n      color: rgba(220,220,220,1);\n      background: rgba(60,60,60,0.8);\n      border-color: rgba(120,120,120,0.5);\n    }\n\n    /* 内容区域 - LCD屏幕 */\n    .custom-gift-content {\n      flex: 1;\n      overflow-y: auto;\n      padding: 10px;\n      max-height: 60vh;\n      background: rgba(10,10,10,0.5);\n      position: relative;\n    }\n\n    /* 滚动条 - 磁带风格 */\n    .custom-gift-content::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .custom-gift-content::-webkit-scrollbar-track {\n      background: rgba(0,0,0,0.3);\n      border-left: 1px solid rgba(100,100,100,0.2);\n    }\n\n    .custom-gift-content::-webkit-scrollbar-thumb {\n      background: rgba(100,100,100,0.5);\n      border-radius: 0;\n    }\n\n    .custom-gift-content::-webkit-scrollbar-thumb:hover {\n      background: rgba(120,120,120,0.7);\n    }\n\n    /* 视图头部 - 播放器控制条 */\n    .view-header {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      margin-bottom: 12px;\n      padding: 8px 10px;\n      background: linear-gradient(180deg, rgba(30,30,30,0.8), rgba(20,20,20,0.8));\n      border: 1px solid rgba(100,100,100,0.25);\n      border-radius: 4px;\n    }\n\n    .back-btn {\n      width: 28px;\n      height: 28px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(50,50,50,0.8);\n      border: 1px solid rgba(100,100,100,0.3);\n      border-radius: 3px;\n      cursor: pointer;\n      transition: all 0.15s ease;\n      color: rgba(180,180,180,0.8);\n      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);\n    }\n\n    .back-btn:hover {\n      background: rgba(70,70,70,0.9);\n      color: rgba(220,220,220,1);\n      border-color: rgba(120,120,120,0.5);\n    }\n\n    .back-btn:active {\n      transform: scale(0.95);\n      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);\n    }\n\n    .view-title {\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(200,200,200,0.95);\n      text-transform: uppercase;\n    }\n\n    .view-hint {\n      flex: 1;\n      text-align: right;\n      font-size: 10px;\n      color: rgba(150,150,150,0.6);\n      font-family: 'Courier New', monospace;\n    }\n\n    /* 🎵 分类卡片 - 磁带盒设计 */\n    .category-grid {\n      display: grid;\n      grid-template-columns: 1fr;\n      gap: 8px;\n      margin-bottom: 12px;\n    }\n\n    .category-card {\n      position: relative;\n      background: linear-gradient(135deg, \n        rgba(35,35,35,0.95) 0%, \n        rgba(25,25,25,0.95) 50%, \n        rgba(30,30,30,0.95) 100%);\n      border: 1px solid rgba(100,100,100,0.25);\n      border-radius: 6px;\n      padding: 10px 12px;\n      transition: all 0.2s ease;\n      box-shadow: \n        0 2px 4px rgba(0,0,0,0.5),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n    }\n\n    /* 磁带孔洞装饰 */\n    .category-card::before,\n    .category-card::after {\n      content: '';\n      position: absolute;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      background: rgba(0,0,0,0.5);\n      border: 1px solid rgba(100,100,100,0.3);\n    }\n\n    .category-card::before {\n      left: 8px;\n    }\n\n    .category-card::after {\n      right: 8px;\n    }\n\n    .category-card.enabled {\n      border-color: rgba(150,150,150,0.4);\n      background: linear-gradient(135deg, \n        rgba(45,45,45,0.98) 0%, \n        rgba(35,35,35,0.98) 50%, \n        rgba(40,40,40,0.98) 100%);\n      box-shadow: \n        0 3px 6px rgba(0,0,0,0.6),\n        inset 0 1px 0 rgba(255,255,255,0.08);\n    }\n\n    .category-card.default {\n      border-color: rgba(120,120,120,0.35);\n    }\n\n    .category-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      margin-bottom: 8px;\n    }\n\n    .category-name {\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      color: rgba(200,200,200,0.95);\n      letter-spacing: 1px;\n      text-transform: uppercase;\n    }\n\n    .category-badge {\n      padding: 2px 6px;\n      background: rgba(80,80,80,0.6);\n      border: 1px solid rgba(120,120,120,0.3);\n      border-radius: 2px;\n      font-size: 9px;\n      color: rgba(180,180,180,0.8);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 1px;\n    }\n\n    .category-actions {\n      display: flex;\n      gap: 4px;\n    }\n\n    /* 播放器按钮风格 */\n    .cat-btn {\n      width: 28px;\n      height: 28px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(50,50,50,0.8);\n      border: 1px solid rgba(100,100,100,0.3);\n      border-radius: 3px;\n      cursor: pointer;\n      transition: all 0.15s ease;\n      color: rgba(180,180,180,0.8);\n      box-shadow: \n        0 1px 2px rgba(0,0,0,0.3),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n    }\n\n    .cat-btn:hover {\n      background: rgba(70,70,70,0.9);\n      color: rgba(220,220,220,1);\n      border-color: rgba(120,120,120,0.5);\n    }\n\n    .cat-btn:active {\n      transform: scale(0.95);\n      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);\n    }\n\n    .cat-btn.toggle.active {\n      background: rgba(80,80,80,0.95);\n      border-color: rgba(140,140,140,0.5);\n      color: rgba(220,220,220,1);\n      box-shadow: \n        0 1px 3px rgba(0,0,0,0.4),\n        inset 0 0 8px rgba(255,255,255,0.1);\n    }\n\n    .cat-btn.delete:hover {\n      background: rgba(70,40,40,0.9);\n      border-color: rgba(150,80,80,0.4);\n      color: rgba(220,150,150,1);\n    }\n\n    /* 添加分类按钮 */\n    .add-category-section {\n      display: flex;\n      justify-content: center;\n      padding: 12px 0;\n    }\n\n    .add-category-btn {\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      padding: 10px 20px;\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      background: rgba(50,50,50,0.8);\n      border: 1px solid rgba(100,100,100,0.3);\n      border-radius: 4px;\n      color: rgba(200,200,200,0.9);\n      cursor: pointer;\n      transition: all 0.2s ease;\n      box-shadow: \n        0 2px 4px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n      text-transform: uppercase;\n    }\n\n    .add-category-btn:hover {\n      background: rgba(70,70,70,0.9);\n      border-color: rgba(120,120,120,0.5);\n      color: rgba(220,220,220,1);\n      transform: translateY(-1px);\n      box-shadow: \n        0 4px 8px rgba(0,0,0,0.5),\n        inset 0 1px 0 rgba(255,255,255,0.08);\n    }\n\n    .add-category-btn:active {\n      transform: translateY(0);\n    }\n\n    /* 🎵 礼物网格 - 播放列表风格 */\n    .gift-grid {\n      display: grid;\n      grid-template-columns: repeat(3, 1fr);\n      gap: 4px;\n      margin-bottom: 10px;\n      padding: 4px;\n      background: rgba(0,0,0,0.2);\n      border: 1px solid rgba(100,100,100,0.15);\n      border-radius: 4px;\n    }\n\n    .gift-item-card {\n      position: relative;\n      background: linear-gradient(180deg, \n        rgba(35,35,35,0.95) 0%, \n        rgba(25,25,25,0.95) 100%);\n      border: 1px solid rgba(100,100,100,0.2);\n      border-radius: 4px;\n      padding: 6px;\n      transition: all 0.15s ease;\n      cursor: pointer;\n      box-shadow: \n        0 1px 2px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,255,255,0.03);\n    }\n\n    .gift-item-card:hover {\n      border-color: rgba(150,150,150,0.4);\n      background: linear-gradient(180deg, \n        rgba(45,45,45,0.98) 0%, \n        rgba(35,35,35,0.98) 100%);\n      transform: translateY(-1px);\n      box-shadow: \n        0 2px 4px rgba(0,0,0,0.5),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n    }\n\n    .gift-item-card:active {\n      transform: scale(0.98);\n    }\n\n    .gift-icon-box {\n      width: 100%;\n      aspect-ratio: 1;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin-bottom: 4px;\n      background: rgba(0,0,0,0.4);\n      border: 1px solid rgba(100,100,100,0.15);\n      border-radius: 3px;\n      overflow: hidden;\n      position: relative;\n    }\n\n    /* LCD屏幕扫描线 */\n    .gift-icon-box::before {\n      content: '';\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(0,0,0,0.05) 2px,\n        rgba(0,0,0,0.05) 4px\n      );\n      pointer-events: none;\n    }\n\n    .gift-icon-box img {\n      width: 100%;\n      height: 100%;\n      object-fit: contain;\n      position: relative;\n      z-index: 1;\n    }\n\n    .placeholder-icon {\n      font-size: 18px;\n      color: rgba(150,150,150,0.3);\n    }\n\n    .gift-item-info {\n      text-align: center;\n    }\n\n    .gift-item-name {\n      font-family: 'Courier New', monospace;\n      font-size: 9px;\n      font-weight: bold;\n      color: rgba(200,200,200,0.9);\n      margin-bottom: 3px;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n      letter-spacing: 0.5px;\n    }\n\n    .gift-item-points {\n      font-family: 'Courier New', monospace;\n      font-size: 8px;\n      color: rgba(150,150,150,0.7);\n      letter-spacing: 0.5px;\n    }\n\n    /* 删除按钮 - 像停止按钮 */\n    .gift-delete-btn {\n      position: absolute;\n      top: 4px;\n      right: 4px;\n      width: 18px;\n      height: 18px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(60,30,30,0.95);\n      border: 1px solid rgba(120,60,60,0.3);\n      border-radius: 2px;\n      cursor: pointer;\n      opacity: 0;\n      transition: all 0.15s ease;\n      color: rgba(200,120,120,0.9);\n      font-size: 11px;\n      box-shadow: \n        0 1px 2px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,100,100,0.05);\n      z-index: 2;\n    }\n\n    .gift-item-card:hover .gift-delete-btn {\n      opacity: 1;\n    }\n\n    .gift-delete-btn:hover {\n      background: rgba(80,40,40,0.98);\n      border-color: rgba(150,80,80,0.5);\n      color: rgba(220,150,150,1);\n      transform: scale(1.05);\n    }\n\n    .gift-delete-btn:active {\n      transform: scale(0.95);\n      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);\n    }\n\n    /* 空状态 - LCD显示 */\n    .empty-gifts {\n      grid-column: 1 / -1;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 8px;\n      padding: 32px 20px;\n      background: rgba(0,0,0,0.3);\n      border: 1px solid rgba(100,100,100,0.15);\n      border-radius: 4px;\n    }\n\n    .empty-gifts svg {\n      opacity: 0.15;\n    }\n\n    .empty-gifts p {\n      margin: 0;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      color: rgba(180,180,180,0.6);\n      letter-spacing: 1px;\n    }\n\n    .empty-gifts .hint {\n      font-family: 'Courier New', monospace;\n      font-size: 10px;\n      color: rgba(150,150,150,0.4);\n      letter-spacing: 0.5px;\n    }\n\n    /* 添加礼物按钮 */\n    .add-gift-section {\n      display: flex;\n      justify-content: center;\n      padding: 12px 0;\n    }\n\n    .add-gift-btn {\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      padding: 10px 20px;\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      background: rgba(50,50,50,0.8);\n      border: 1px solid rgba(100,100,100,0.3);\n      border-radius: 4px;\n      color: rgba(200,200,200,0.9);\n      cursor: pointer;\n      transition: all 0.2s ease;\n      box-shadow: \n        0 2px 4px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n      text-transform: uppercase;\n    }\n\n    .add-gift-btn:hover {\n      background: rgba(70,70,70,0.9);\n      border-color: rgba(120,120,120,0.5);\n      color: rgba(220,220,220,1);\n      transform: translateY(-1px);\n      box-shadow: \n        0 4px 8px rgba(0,0,0,0.5),\n        inset 0 1px 0 rgba(255,255,255,0.08);\n    }\n\n    .add-gift-btn:active {\n      transform: translateY(0);\n    }\n\n    /* 表单面板 - 🔧 Linus: 表单弹窗需要保留遮罩，不影响主面板 */\n    .add-form-overlay {\n      position: fixed;\n      inset: 0;\n      background: rgba(0,0,0,0.6); /* 表单遮罩保留，因为是次级弹窗 */\n      z-index: 10007;\n      opacity: 0;\n      transition: opacity 0.2s ease;\n    }\n\n    .add-form-overlay.active {\n      opacity: 1;\n    }\n\n    .add-form-panel, .add-gift-panel {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0.9);\n      width: 90%;\n      max-width: 400px;\n      max-height: 80vh;\n      background: linear-gradient(135deg, rgba(25,25,25,0.98), rgba(15,15,15,0.98));\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 12px;\n      box-shadow: 0 20px 60px rgba(0,0,0,0.9);\n      z-index: 10008;\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    }\n\n    .add-form-panel.active, .add-gift-panel.active {\n      opacity: 1;\n      transform: translate(-50%, -50%) scale(1);\n    }\n\n    .form-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px 20px;\n      background: rgba(0,0,0,0.4);\n      border-bottom: 1px solid rgba(255,255,255,0.15);\n    }\n\n    .form-title {\n      font-family: 'Courier New', monospace;\n      font-size: 13px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(255,255,255,0.9);\n    }\n\n    .form-close {\n      width: 24px;\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      color: rgba(255,255,255,0.6);\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border-radius: 4px;\n    }\n\n    .form-close:hover {\n      color: rgba(255,255,255,1);\n      background: rgba(255,255,255,0.1);\n    }\n\n    .form-body {\n      padding: 20px;\n      overflow-y: auto;\n    }\n\n    .form-group {\n      margin-bottom: 16px;\n    }\n\n    .form-group label {\n      display: block;\n      margin-bottom: 6px;\n      font-size: 11px;\n      font-weight: bold;\n      color: rgba(255,255,255,0.7);\n      letter-spacing: 0.5px;\n    }\n\n    .form-group input[type=\"text\"],\n    .form-group input[type=\"url\"],\n    .form-group input[type=\"number\"],\n    .form-group select {\n      width: 100%;\n      padding: 10px 12px;\n      background: rgba(0,0,0,0.4);\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 6px;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      color: rgba(255,255,255,0.9);\n      outline: none;\n      transition: all 0.2s ease;\n    }\n\n    .form-group input:focus,\n    .form-group select:focus {\n      border-color: rgba(255,255,255,0.4);\n      background: rgba(0,0,0,0.5);\n    }\n\n    .form-group input:disabled {\n      opacity: 0.4;\n      cursor: not-allowed;\n    }\n\n    /* 智能积分推荐 */\n    .smart-points-suggest {\n      display: flex;\n      gap: 12px;\n      align-items: flex-start;\n      padding: 12px;\n      background: rgba(40,40,30,0.6);\n      border: 1px solid rgba(255,255,200,0.2);\n      border-radius: 8px;\n      margin-bottom: 16px;\n    }\n\n    .suggest-icon {\n      font-size: 20px;\n      flex-shrink: 0;\n    }\n\n    .suggest-text {\n      flex: 1;\n      font-size: 11px;\n      line-height: 1.5;\n      color: rgba(255,255,220,0.9);\n    }\n\n    /* 图片上传区域 */\n    .image-upload-section {\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    }\n\n    .upload-option {\n      display: flex;\n      flex-direction: column;\n      gap: 6px;\n    }\n\n    .option-header {\n      display: flex;\n      align-items: center;\n      gap: 6px;\n    }\n\n    .option-header input[type=\"checkbox\"] {\n      width: 16px;\n      height: 16px;\n      cursor: pointer;\n    }\n\n    .option-header label {\n      margin: 0;\n      cursor: pointer;\n      font-size: 12px;\n    }\n\n    .form-group input[type=\"file\"] {\n      padding: 8px;\n      font-size: 11px;\n    }\n\n    .image-preview {\n      width: 100%;\n      max-width: 150px;\n      aspect-ratio: 1;\n      margin-top: 8px;\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 6px;\n      overflow: hidden;\n    }\n\n    .image-preview img {\n      width: 100%;\n      height: 100%;\n      object-fit: contain;\n    }\n\n    .upload-hint {\n      font-size: 10px;\n      color: rgba(255,255,255,0.4);\n      line-height: 1.4;\n    }\n\n    .form-footer {\n      display: flex;\n      gap: 10px;\n      padding: 16px 20px;\n      background: rgba(0,0,0,0.3);\n      border-top: 1px solid rgba(255,255,255,0.1);\n    }\n\n    .form-btn {\n      flex: 1;\n      padding: 10px 16px;\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 1px;\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 6px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .form-btn.cancel {\n      background: rgba(40,40,40,0.8);\n      color: rgba(255,255,255,0.7);\n    }\n\n    .form-btn.cancel:hover {\n      background: rgba(50,50,50,0.9);\n      color: rgba(255,255,255,0.9);\n    }\n\n    .form-btn.submit {\n      background: rgba(60,60,60,0.9);\n      color: rgba(255,255,255,0.9);\n    }\n\n    .form-btn.submit:hover {\n      background: rgba(70,70,70,0.95);\n      border-color: rgba(255,255,255,0.4);\n      color: rgba(255,255,255,1);\n    }\n\n    /* CODE窗口可点击样式 */\n    .jukebox-display-window.clickable {\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .jukebox-display-window.clickable:hover {\n      background: rgba(255,255,255,0.05);\n      transform: scale(1.02);\n    }\n\n    @media (max-width: 600px) {\n      .custom-gift-panel {\n        max-width: 100%;\n        width: 100%;\n        border-radius: 8px 8px 0 0;\n      }\n\n      .custom-gift-header {\n        padding: 10px 14px;\n      }\n\n      .header-title {\n        font-size: 11px;\n        letter-spacing: 3px;\n      }\n\n      .header-vinyl-icon {\n        width: 18px;\n        height: 18px;\n      }\n\n      .gift-grid {\n        grid-template-columns: repeat(3, 1fr);\n        gap: 3px;\n        padding: 3px;\n      }\n\n      .gift-item-card {\n        padding: 5px;\n      }\n\n      .gift-icon-box {\n        margin-bottom: 3px;\n      }\n\n      .gift-item-name {\n        font-size: 8px;\n        margin-bottom: 2px;\n      }\n\n      .gift-item-points {\n        font-size: 7px;\n      }\n\n      .gift-delete-btn {\n        width: 16px;\n        height: 16px;\n        font-size: 10px;\n      }\n\n      .category-card {\n        padding: 8px 10px;\n      }\n\n      .category-name {\n        font-size: 10px;\n      }\n\n      .category-badge {\n        font-size: 8px;\n      }\n\n      .cat-btn {\n        width: 26px;\n        height: 26px;\n      }\n\n      .view-title {\n        font-size: 11px;\n      }\n\n      .view-hint {\n        font-size: 9px;\n      }\n\n      .add-category-btn,\n      .add-gift-btn {\n        padding: 8px 16px;\n        font-size: 10px;\n      }\n\n      .form-body {\n        max-height: 400px;\n      }\n    }\n  ",document.head.appendChild(n)}(),await Ci(),setTimeout(()=>{const n=document.getElementById("customGiftPanel"),e=document.getElementById("customGiftOverlay");n&&n.classList.add("active"),e&&e.classList.add("active"),xi.isOpen=!0},50)},n.closeCustomGiftSystem=function(){if(!xi.isOpen)return;const n=document.getElementById("customGiftPanel"),e=document.getElementById("customGiftOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{n&&n.remove(),e&&e.remove(),xi.isOpen=!1,xi.currentView="categories",xi.currentCategoryId=null},300)},n.showAddCategoryForm=function(){const n=document.querySelector(".live-room");if(!n)return;n.insertAdjacentHTML("beforeend",'\n    <div class="add-form-overlay" id="addCatFormOverlay" onclick="closeAddCategoryForm()"></div>\n    <div class="add-form-panel" id="addCatFormPanel">\n      <div class="form-header">\n        <div class="form-title">新建分类</div>\n        <div class="form-close" onclick="closeAddCategoryForm()">×</div>\n      </div>\n      <div class="form-body">\n        <div class="form-group">\n          <label>分类名称</label>\n          <input type="text" id="newCategoryName" placeholder="例如：节日礼物" maxlength="20">\n        </div>\n      </div>\n      <div class="form-footer">\n        <button class="form-btn cancel" onclick="closeAddCategoryForm()">取消</button>\n        <button class="form-btn submit" onclick="submitNewCategory()">创建</button>\n      </div>\n    </div>\n  '),setTimeout(()=>{const n=document.getElementById("addCatFormPanel"),e=document.getElementById("addCatFormOverlay");n&&n.classList.add("active"),e&&e.classList.add("active")},50)},n.closeAddCategoryForm=Ii,n.submitNewCategory=async function(){const n=document.getElementById("newCategoryName");if(!n)return;const t=n.value.trim();if(!t)return void mn("请输入分类名称","error");await async function(n){const t=e(),o=vt||"default";try{const e={id:`gift_cat_${Date.now()}`,accountId:o,name:n,enabled:0,isDefault:0,createdAt:(new Date).toISOString()};return await t.xCustomGiftCategories.add(e),e}catch(n){return console.error("❌ [自定义礼物] 创建分类失败:",n),null}}(t)?(mn("分类创建成功","success"),Ii(),await Ci()):mn("创建失败","error")},n.toggleCategory=B,n.deleteCategory=z,n.viewCategoryGifts=Si,n.backToCategoryList=async function(){await Ci()},n.deleteGift=async function(n){if(!confirm("确定删除此礼物？"))return;await async function(n){const t=e();try{return await t.xCustomGifts.delete(n),!0}catch(n){return console.error("❌ [自定义礼物] 删除礼物失败:",n),!1}}(n)&&(mn("礼物已删除","success"),await Si(xi.currentCategoryId),await wi())},n.editGift=async function(n){const t=await e(),o=await t.xCustomGifts.get(n);o?Mi(o.categoryId,o):mn("礼物不存在","error")},n.showAddGiftForm=Mi,n.closeAddGiftForm=Ti,n.toggleImageSource=function(){const n=document.getElementById("useUrlImage").checked,e=document.getElementById("useLocalImage").checked,t=document.getElementById("giftImageUrl"),o=document.getElementById("giftImageLocal");t.disabled=!n,o.disabled=!e},n.previewLocalImage=function(){const n=document.getElementById("giftImageLocal"),e=document.getElementById("imagePreview"),t=document.getElementById("previewImg");if(n.files&&n.files[0]){const o=new FileReader;o.onload=function(n){t.src=n.target.result,e.style.display="block"},o.readAsDataURL(n.files[0])}else e.style.display="none"};let Ai=0;function Ei(){const n=document.getElementById("giftPoints"),e=document.getElementById("smartPointsSuggest"),t=document.getElementById("suggestText"),o=document.getElementById("giftName");if(!(n&&e&&t&&o&&0!==Ai))return;const a=parseInt(n.value)||0,i=o.value.trim();if(!(a<50))if(a<Ai){const n=zi([`哎呀呀，${a}积分？`,"这可不太像话呢...","您是不是少打了个零呀？",`「${i}」这么好的名字，配这么点积分？`,"有点亏待它了吧？","要不再考虑考虑？咱可不能让礼物失了身价啊。","我建议您还是往上加加，不然显得有点...寒酸了~","您这是考验我的职业素养吗？好吧，我建议您三思。"],2+Math.floor(5*Math.random()));t.textContent=n,e.style.backgroundColor="rgba(255, 87, 51, 0.1)",e.style.borderColor="rgba(255, 87, 51, 0.3)"}else{const n=zi([`${a}积分？`,"哎呦，这个数字我喜欢！","您这出手，真是阔绰啊~","明智的决定！",`「${i}」配这个价，才算登对嘛。`,"这才是您该有的格局！","您这眼光，啧啧，果然不一般。","就冲您这诚意，礼物收到的人肯定心花怒放~","大方！我就喜欢您这样的客户！"],2+Math.floor(5*Math.random()));t.textContent=n,e.style.backgroundColor="rgba(76, 175, 80, 0.1)",e.style.borderColor="rgba(76, 175, 80, 0.3)"}}function zi(n,e){return[...n].sort(()=>Math.random()-.5).slice(0,e).join(" ")}function Bi(){const n=document.getElementById("giftConfirmPanel"),e=document.getElementById("giftConfirmOverlay");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{n&&n.remove(),e&&e.remove()},300)}function Li(n){if(!document.querySelector(".live-room"))return;const e=n.animationType||"default";let t="";t=n.useLocalImage&&n.imageLocal?`<img src="${n.imageLocal}" alt="${n.giftName}" style="width:100%;height:100%;object-fit:contain;">`:n.imageUrl?`<img src="${n.imageUrl}" alt="${n.giftName}" style="width:100%;height:100%;object-fit:contain;">`:n.giftIcon?n.giftIcon:'<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:48px;color:rgba(255,255,255,0.4);">🎁</div>',"float"===e?function(n,e){const t=document.querySelector(".live-room");if(!t)return;const o=`giftFloat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=Array.from({length:12},(n,e)=>`<div class="vu-bar" style="--height: ${50+100*Math.random()}%; --delay: ${.05*e}s;"></div>`).join(""),i=Array.from({length:6},(n,t)=>`<div class="music-note" style="--angle: ${60*t+(20*Math.random()-10)}deg; --distance: ${120+60*Math.random()}px; --scale: ${.6+.4*Math.random()};">\n      <div class="note-icon">${e}</div>\n    </div>`).join(""),r=Array.from({length:3},(n,e)=>`<div class="scan-line" style="--delay: ${.3*e}s;"></div>`).join(""),s=n.target?`\n    <div class="lcd-line lcd-pk-target">\n      <span class="lcd-label">TARGET</span>\n      <span class="lcd-dots">••••</span>\n      <span class="lcd-target">${"streamer"===n.target?"▶STREAMER":"▶USER"}</span>\n    </div>\n  `:"",l=`\n    <div class="gift-animation-float" id="${o}">\n      \x3c!-- 背景扫描线 --\x3e\n      <div class="float-scanlines">${r}</div>\n\n      \x3c!-- VU表能量条 --\x3e\n      <div class="vu-meter">\n        ${a}\n      </div>\n\n      \x3c!-- 中心礼物显示 --\x3e\n      <div class="float-center">\n        <div class="float-vinyl-spin">\n          <div class="vinyl-grooves"></div>\n          <div class="float-gift-icon">\n            ${e}\n          </div>\n        </div>\n\n        \x3c!-- 音符粒子 --\x3e\n        <div class="music-notes">${i}</div>\n      </div>\n\n      \x3c!-- 信息显示板 --\x3e\n      <div class="float-info-panel">\n        <div class="float-lcd-display">\n          <div class="lcd-line">\n            <span class="lcd-label">GIFT</span>\n            <span class="lcd-dots">••••</span>\n            <span class="lcd-name">${n.giftName}</span>\n          </div>\n          <div class="lcd-line">\n            <span class="lcd-label">VALUE</span>\n            <span class="lcd-dots">••••</span>\n            <span class="lcd-value">+${n.giftPrice}P</span>\n          </div>\n          ${s}\n          <div class="lcd-line lcd-sender">\n            <img src="${n.userAvatar}" class="lcd-avatar">\n            <span class="lcd-user">${n.userName}</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  `;t.insertAdjacentHTML("beforeend",l),function(){if(document.getElementById("floatAnimStyles"))return;const n=document.createElement("style");n.id="floatAnimStyles",n.textContent="\n    /* 🎵 礼物浮动动画 - VU表/音乐播放器风格 */\n    .gift-animation-float {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0.8);\n      opacity: 0;\n      z-index: 10004;\n      pointer-events: none;\n      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    .gift-animation-float.active {\n      opacity: 1;\n      transform: translate(-50%, -50%) scale(1);\n    }\n\n    /* 背景扫描线 */\n    .float-scanlines {\n      position: absolute;\n      inset: -100px;\n      overflow: hidden;\n      opacity: 0.3;\n    }\n\n    .scan-line {\n      position: absolute;\n      left: 0;\n      right: 0;\n      height: 2px;\n      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);\n      animation: scanMove 2s linear infinite;\n      animation-delay: var(--delay);\n    }\n\n    @keyframes scanMove {\n      0% { top: -10%; opacity: 0; }\n      10% { opacity: 1; }\n      90% { opacity: 1; }\n      100% { top: 110%; opacity: 0; }\n    }\n\n    /* VU表能量条 */\n    .vu-meter {\n      position: absolute;\n      bottom: -80px;\n      left: 50%;\n      transform: translateX(-50%);\n      display: flex;\n      align-items: flex-end;\n      gap: 6px;\n      height: 140px;\n      padding: 10px 16px;\n      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.6));\n      border-radius: 8px 8px 0 0;\n      opacity: 0;\n      animation: vuFadeIn 0.6s ease-out 0.2s forwards;\n    }\n\n    @keyframes vuFadeIn {\n      from { opacity: 0; transform: translateX(-50%) translateY(20px); }\n      to { opacity: 1; transform: translateX(-50%) translateY(0); }\n    }\n\n    .vu-bar {\n      width: 8px;\n      height: var(--height);\n      background: linear-gradient(180deg, \n        rgba(220,220,220,0.9) 0%,\n        rgba(180,180,180,0.8) 50%,\n        rgba(140,140,140,0.6) 100%);\n      border-radius: 2px 2px 0 0;\n      box-shadow: \n        0 0 8px rgba(255,255,255,0.3),\n        inset 0 1px 0 rgba(255,255,255,0.2);\n      animation: vuPulse 0.8s ease-in-out infinite alternate;\n      animation-delay: var(--delay);\n    }\n\n    @keyframes vuPulse {\n      0% { height: calc(var(--height) * 0.6); opacity: 0.6; }\n      100% { height: var(--height); opacity: 1; }\n    }\n\n    /* 中心显示区 */\n    .float-center {\n      position: relative;\n      width: 200px;\n      height: 200px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    /* 旋转唱片背景 */\n    .float-vinyl-spin {\n      position: relative;\n      width: 160px;\n      height: 160px;\n      background: radial-gradient(circle,\n        rgba(40,40,40,0.95) 0%,\n        rgba(30,30,30,0.95) 40%,\n        rgba(20,20,20,0.95) 60%,\n        rgba(15,15,15,0.95) 100%);\n      border-radius: 50%;\n      border: 3px solid rgba(100,100,100,0.6);\n      box-shadow: \n        0 0 40px rgba(0,0,0,0.9),\n        0 0 80px rgba(255,255,255,0.2),\n        inset 0 0 30px rgba(0,0,0,0.8);\n      animation: vinylRotate 4s linear infinite;\n    }\n\n    @keyframes vinylRotate {\n      from { transform: rotate(0deg); }\n      to { transform: rotate(360deg); }\n    }\n\n    /* 唱片纹路 */\n    .vinyl-grooves {\n      position: absolute;\n      inset: 20px;\n      border-radius: 50%;\n      background: \n        repeating-radial-gradient(circle at center,\n          transparent 0px,\n          transparent 4px,\n          rgba(255,255,255,0.03) 4px,\n          rgba(255,255,255,0.03) 5px);\n    }\n\n    /* 礼物图标 */\n    .float-gift-icon {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 90px;\n      height: 90px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      filter: drop-shadow(0 0 30px rgba(255,255,255,0.6));\n      z-index: 2;\n      animation: iconBreath 2s ease-in-out infinite;\n    }\n\n    @keyframes iconBreath {\n      0%, 100% { transform: translate(-50%, -50%) scale(1); }\n      50% { transform: translate(-50%, -50%) scale(1.1); }\n    }\n\n    /* 音符粒子 */\n    .music-notes {\n      position: absolute;\n      inset: 0;\n    }\n\n    .music-note {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      animation: noteFloat 2s ease-out forwards;\n    }\n\n    @keyframes noteFloat {\n      0% {\n        transform: translate(-50%, -50%) rotate(0deg) translateX(0) scale(0);\n        opacity: 0;\n      }\n      20% {\n        opacity: 1;\n      }\n      80% {\n        opacity: 1;\n      }\n      100% {\n        transform: translate(-50%, -50%) rotate(var(--angle)) translateX(var(--distance)) scale(var(--scale));\n        opacity: 0;\n      }\n    }\n\n    .note-icon {\n      width: 50px;\n      height: 50px;\n      opacity: 0.6;\n      filter: drop-shadow(0 0 10px rgba(255,255,255,0.4));\n    }\n\n    /* LCD信息显示板 */\n    .float-info-panel {\n      position: absolute;\n      top: 240px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 340px;\n      opacity: 0;\n      animation: infoPanelSlide 0.6s ease-out 0.4s forwards;\n    }\n\n    @keyframes infoPanelSlide {\n      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }\n      to { opacity: 1; transform: translateX(-50%) translateY(0); }\n    }\n\n    .float-lcd-display {\n      background: linear-gradient(180deg, \n        rgba(15,15,15,0.98) 0%,\n        rgba(10,10,10,0.98) 100%);\n      border: 2px solid rgba(100,100,100,0.5);\n      border-radius: 8px;\n      padding: 14px 18px;\n      box-shadow: \n        0 4px 20px rgba(0,0,0,0.8),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n      position: relative;\n    }\n\n    /* LCD扫描线效果 */\n    .float-lcd-display::before {\n      content: '';\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(0,0,0,0.1) 2px,\n        rgba(0,0,0,0.1) 4px\n      );\n      border-radius: 6px;\n      pointer-events: none;\n    }\n\n    .lcd-line {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      margin-bottom: 10px;\n      font-family: 'Courier New', monospace;\n      position: relative;\n      z-index: 1;\n    }\n\n    .lcd-line:last-child {\n      margin-bottom: 0;\n    }\n\n    .lcd-label {\n      font-size: 10px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(180,180,180,0.7);\n      min-width: 50px;\n    }\n\n    .lcd-dots {\n      font-size: 8px;\n      letter-spacing: 2px;\n      color: rgba(100,100,100,0.6);\n    }\n\n    .lcd-name {\n      flex: 1;\n      font-size: 13px;\n      font-weight: bold;\n      letter-spacing: 1px;\n      color: rgba(220,220,220,0.95);\n      text-shadow: 0 0 10px rgba(255,255,255,0.3);\n    }\n\n    .lcd-value {\n      flex: 1;\n      font-size: 16px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(200,200,200,0.95);\n      text-shadow: 0 0 15px rgba(255,255,255,0.4);\n    }\n\n    .lcd-sender {\n      padding-top: 8px;\n      border-top: 1px solid rgba(100,100,100,0.3);\n      margin-top: 4px;\n    }\n\n    .lcd-avatar {\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      border: 2px solid rgba(120,120,120,0.5);\n      object-fit: cover;\n    }\n\n    .lcd-user {\n      flex: 1;\n      font-size: 12px;\n      color: rgba(200,200,200,0.9);\n      letter-spacing: 0.5px;\n    }\n\n    /* PK目标标签 - LCD风格 */\n    .lcd-pk-target {\n      background: rgba(40,40,40,0.6);\n      border: 1px solid rgba(120,120,120,0.3);\n      border-radius: 4px;\n      padding: 8px 12px;\n      margin-top: 8px;\n      box-shadow:\n        0 2px 4px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,255,255,0.05);\n    }\n\n    .lcd-pk-target .lcd-dots {\n      color: rgba(255,107,107,0.4);\n    }\n\n    .lcd-target {\n      flex: 1;\n      font-size: 13px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(255,107,107,0.95);\n      text-shadow: 0 0 10px rgba(255,107,107,0.5);\n      animation: lcdTargetPulse 1.5s ease-in-out infinite;\n    }\n\n    @keyframes lcdTargetPulse {\n      0%, 100% {\n        color: rgba(255,107,107,0.95);\n        text-shadow: 0 0 10px rgba(255,107,107,0.5);\n      }\n      50% {\n        color: rgba(255,107,107,1);\n        text-shadow: 0 0 15px rgba(255,107,107,0.8);\n      }\n    }\n\n    @media (max-width: 600px) {\n      .float-center {\n        width: 160px;\n        height: 160px;\n      }\n\n      .float-vinyl-spin {\n        width: 130px;\n        height: 130px;\n      }\n\n      .float-gift-icon {\n        width: 70px;\n        height: 70px;\n      }\n\n      .float-info-panel {\n        width: 300px;\n        top: 200px;\n      }\n\n      .lcd-name {\n        font-size: 12px;\n      }\n\n      .lcd-value {\n        font-size: 14px;\n      }\n\n      .vu-meter {\n        height: 100px;\n        bottom: -60px;\n      }\n\n      .lcd-pk-target {\n        padding: 6px 10px;\n      }\n\n      .lcd-target {\n        font-size: 12px;\n      }\n    }\n  ",document.head.appendChild(n)}();const c=document.getElementById(o);if(!c)return;setTimeout(()=>c.classList.add("active"),50),setTimeout(()=>c.remove(),3e3)}(n,t):"explosion"===e?function(n,e){const t=document.querySelector(".live-room");if(!t)return;const o=`giftExplosion_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=Array.from({length:40},(n,e)=>`<div class="pixel-block" style="\n      --angle: ${9*e+5*Math.random()}deg;\n      --distance: ${100+120*Math.random()}px;\n      --size: ${6+8*Math.random()}px;\n      --delay: ${.2*Math.random()}s;\n      --rotation: ${360*Math.random()}deg;\n    "></div>`).join(""),i=Array.from({length:3},(n,e)=>`<div class="shockwave-ring" style="--delay: ${.15*e}s;"></div>`).join(""),r=Array.from({length:8},(n,e)=>`<div class="explosion-beam" style="--angle: ${45*e}deg;"></div>`).join(""),s=n.target?`\n    <div class="explosion-target-strip">\n      <div class="target-strip-label">TARGET:</div>\n      <div class="target-strip-value">▶ ${"streamer"===n.target?"STREAMER":"USER"}</div>\n      <div class="target-strip-holes">\n        <span></span><span></span>\n      </div>\n    </div>\n  `:"",l=`\n    <div class="gift-animation-explosion" id="${o}">\n      \x3c!-- 冲击波环 --\x3e\n      <div class="shockwave-container">${i}</div>\n\n      \x3c!-- 爆炸中心 --\x3e\n      <div class="explosion-center">\n        \x3c!-- 光束 --\x3e\n        <div class="beam-container">${r}</div>\n\n        \x3c!-- 礼物图标（破碎前） --\x3e\n        <div class="explosion-icon-wrapper">\n          <div class="explosion-icon">\n            ${e}\n          </div>\n          <div class="icon-flash"></div>\n        </div>\n\n        \x3c!-- 像素块爆炸 --\x3e\n        <div class="pixel-explosion">${a}</div>\n      </div>\n\n      \x3c!-- 爆炸信息显示（磁带标签风格） --\x3e\n      <div class="explosion-info-tape">\n        <div class="tape-border-top"></div>\n        <div class="explosion-info-content">\n          <div class="explosion-header">\n            <div class="explosion-code">${n.giftCode||"GIFT"}</div>\n            <div class="explosion-separator"></div>\n            <div class="explosion-status">RECEIVED</div>\n          </div>\n          <div class="explosion-name">${n.giftName}</div>\n          <div class="explosion-value-bar">\n            <div class="value-bar-fill" style="--width: ${Math.min(n.giftPrice/100,100)}%;"></div>\n            <div class="value-text">${n.giftPrice}P</div>\n          </div>\n          ${s}\n          <div class="explosion-user-strip">\n            <img src="${n.userAvatar}" class="explosion-avatar">\n            <span class="explosion-username">${n.userName}</span>\n            <div class="user-strip-holes">\n              <span></span><span></span><span></span>\n            </div>\n          </div>\n        </div>\n        <div class="tape-border-bottom"></div>\n      </div>\n    </div>\n  `;t.insertAdjacentHTML("beforeend",l),function(){if(document.getElementById("explosionAnimStyles"))return;const n=document.createElement("style");n.id="explosionAnimStyles",n.textContent="\n    /* 💥 礼物爆炸动画 - 像素冲击波/复古游戏风格 */\n    .gift-animation-explosion {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0.8);\n      z-index: 10004;\n      pointer-events: none;\n      opacity: 0;\n      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n\n    .gift-animation-explosion.active {\n      opacity: 1;\n      transform: translate(-50%, -50%) scale(1);\n    }\n\n    /* 冲击波环 */\n    .shockwave-container {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n    }\n\n    .shockwave-ring {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 20px;\n      height: 20px;\n      border: 3px solid rgba(255,255,255,0.8);\n      border-radius: 50%;\n      animation: shockwavePulse 1.2s ease-out forwards;\n      animation-delay: var(--delay);\n      opacity: 0;\n    }\n\n    @keyframes shockwavePulse {\n      0% {\n        width: 20px;\n        height: 20px;\n        border-width: 4px;\n        opacity: 1;\n      }\n      50% {\n        border-width: 3px;\n        opacity: 0.8;\n      }\n      100% {\n        width: 300px;\n        height: 300px;\n        border-width: 1px;\n        opacity: 0;\n      }\n    }\n\n    /* 爆炸中心 */\n    .explosion-center {\n      position: relative;\n      width: 200px;\n      height: 200px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    /* 光束 */\n    .beam-container {\n      position: absolute;\n      inset: 0;\n    }\n\n    .explosion-beam {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      width: 4px;\n      height: 100px;\n      background: linear-gradient(180deg,\n        transparent,\n        rgba(255,255,255,0.8) 30%,\n        rgba(255,255,255,0.4) 60%,\n        transparent);\n      transform-origin: center 0;\n      transform: translate(-50%, 0) rotate(var(--angle));\n      animation: beamFlash 0.8s ease-out forwards;\n      opacity: 0;\n    }\n\n    @keyframes beamFlash {\n      0% {\n        height: 0;\n        opacity: 0;\n      }\n      20% {\n        opacity: 1;\n      }\n      50% {\n        height: 100px;\n        opacity: 1;\n      }\n      100% {\n        height: 120px;\n        opacity: 0;\n      }\n    }\n\n    /* 礼物图标包装器 */\n    .explosion-icon-wrapper {\n      position: relative;\n      width: 110px;\n      height: 110px;\n      z-index: 2;\n    }\n\n    .explosion-icon {\n      position: absolute;\n      inset: 0;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      animation: iconExplode 1s ease-out forwards;\n    }\n\n    @keyframes iconExplode {\n      0% {\n        transform: scale(0.3);\n        opacity: 0;\n      }\n      30% {\n        transform: scale(1.3);\n        opacity: 1;\n        filter: drop-shadow(0 0 40px rgba(255,255,255,0.9));\n      }\n      60% {\n        transform: scale(1);\n        opacity: 1;\n        filter: drop-shadow(0 0 30px rgba(255,255,255,0.5));\n      }\n      80% {\n        opacity: 1;\n      }\n      100% {\n        transform: scale(0.8);\n        opacity: 0;\n        filter: drop-shadow(0 0 0 rgba(255,255,255,0));\n      }\n    }\n\n    /* 闪光效果 */\n    .icon-flash {\n      position: absolute;\n      inset: -20px;\n      background: radial-gradient(circle,\n        rgba(255,255,255,0.6) 0%,\n        rgba(255,255,255,0.2) 40%,\n        transparent 70%);\n      animation: flashPulse 0.6s ease-out;\n      opacity: 0;\n    }\n\n    @keyframes flashPulse {\n      0% { transform: scale(0); opacity: 1; }\n      50% { transform: scale(1.2); opacity: 1; }\n      100% { transform: scale(1.5); opacity: 0; }\n    }\n\n    /* 像素块爆炸 */\n    .pixel-explosion {\n      position: absolute;\n      inset: 0;\n    }\n\n    .pixel-block {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      width: var(--size);\n      height: var(--size);\n      background: linear-gradient(135deg,\n        rgba(220,220,220,0.9) 0%,\n        rgba(180,180,180,0.8) 50%,\n        rgba(140,140,140,0.6) 100%);\n      border: 1px solid rgba(255,255,255,0.4);\n      box-shadow: \n        0 0 8px rgba(255,255,255,0.5),\n        inset 0 0 4px rgba(255,255,255,0.3);\n      animation: pixelExplode 1.2s ease-out forwards;\n      animation-delay: var(--delay);\n      opacity: 0;\n    }\n\n    @keyframes pixelExplode {\n      0% {\n        transform: translate(-50%, -50%) rotate(0deg) translate(0, 0) scale(0);\n        opacity: 0;\n      }\n      15% {\n        opacity: 1;\n      }\n      40% {\n        opacity: 1;\n      }\n      100% {\n        transform: translate(-50%, -50%) rotate(var(--rotation)) \n                   translate(\n                     calc(cos(var(--angle)) * var(--distance)),\n                     calc(sin(var(--angle)) * var(--distance))\n                   ) scale(1);\n        opacity: 0;\n      }\n    }\n\n    /* 磁带标签信息显示 */\n    .explosion-info-tape {\n      position: absolute;\n      top: 240px;\n      left: 50%;\n      transform: translateX(-50%);\n      width: 360px;\n      opacity: 0;\n      animation: tapeSlideIn 0.6s ease-out 0.8s forwards;\n    }\n\n    @keyframes tapeSlideIn {\n      from {\n        opacity: 0;\n        transform: translateX(-50%) translateY(-30px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(-50%) translateY(0);\n      }\n    }\n\n    .tape-border-top,\n    .tape-border-bottom {\n      height: 6px;\n      background: repeating-linear-gradient(\n        90deg,\n        rgba(100,100,100,0.6) 0px,\n        rgba(100,100,100,0.6) 8px,\n        rgba(60,60,60,0.4) 8px,\n        rgba(60,60,60,0.4) 10px\n      );\n      position: relative;\n    }\n\n    .tape-border-top::before,\n    .tape-border-top::after,\n    .tape-border-bottom::before,\n    .tape-border-bottom::after {\n      content: '';\n      position: absolute;\n      width: 6px;\n      height: 6px;\n      background: rgba(40,40,40,0.8);\n      border: 1px solid rgba(100,100,100,0.5);\n      border-radius: 50%;\n    }\n\n    .tape-border-top::before { left: 12px; top: 0; }\n    .tape-border-top::after { right: 12px; top: 0; }\n    .tape-border-bottom::before { left: 12px; bottom: 0; }\n    .tape-border-bottom::after { right: 12px; bottom: 0; }\n\n    .explosion-info-content {\n      background: linear-gradient(135deg,\n        rgba(25,25,25,0.98) 0%,\n        rgba(15,15,15,0.98) 100%);\n      border-left: 2px solid rgba(100,100,100,0.5);\n      border-right: 2px solid rgba(100,100,100,0.5);\n      padding: 16px 20px;\n      position: relative;\n    }\n\n    /* LCD扫描线 */\n    .explosion-info-content::before {\n      content: '';\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(0,0,0,0.15) 2px,\n        rgba(0,0,0,0.15) 4px\n      );\n      pointer-events: none;\n    }\n\n    .explosion-header {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      margin-bottom: 12px;\n      position: relative;\n      z-index: 1;\n    }\n\n    .explosion-code {\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(200,200,200,0.8);\n      padding: 4px 10px;\n      background: rgba(60,60,60,0.6);\n      border: 1px solid rgba(120,120,120,0.4);\n      border-radius: 3px;\n    }\n\n    .explosion-separator {\n      flex: 1;\n      height: 1px;\n      background: linear-gradient(90deg,\n        rgba(100,100,100,0.3),\n        rgba(100,100,100,0.6) 50%,\n        rgba(100,100,100,0.3));\n    }\n\n    .explosion-status {\n      font-family: 'Courier New', monospace;\n      font-size: 10px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(180,180,180,0.7);\n    }\n\n    .explosion-name {\n      font-family: 'Courier New', monospace;\n      font-size: 16px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      text-transform: uppercase;\n      color: rgba(220,220,220,0.95);\n      text-shadow: 0 0 15px rgba(255,255,255,0.3);\n      margin-bottom: 14px;\n      text-align: center;\n      position: relative;\n      z-index: 1;\n    }\n\n    /* 积分进度条 */\n    .explosion-value-bar {\n      position: relative;\n      height: 28px;\n      background: rgba(0,0,0,0.5);\n      border: 1px solid rgba(100,100,100,0.4);\n      border-radius: 4px;\n      overflow: hidden;\n      margin-bottom: 12px;\n    }\n\n    .value-bar-fill {\n      position: absolute;\n      inset: 0;\n      width: var(--width);\n      background: linear-gradient(90deg,\n        rgba(140,140,140,0.8) 0%,\n        rgba(180,180,180,0.9) 50%,\n        rgba(220,220,220,0.95) 100%);\n      border-right: 2px solid rgba(255,255,255,0.6);\n      box-shadow: \n        0 0 10px rgba(255,255,255,0.3),\n        inset 0 1px 0 rgba(255,255,255,0.2);\n      animation: barFill 1s ease-out 0.3s backwards;\n    }\n\n    @keyframes barFill {\n      from { width: 0; }\n      to { width: var(--width); }\n    }\n\n    .value-text {\n      position: relative;\n      z-index: 1;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      height: 100%;\n      font-family: 'Courier New', monospace;\n      font-size: 14px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(220,220,220,0.95);\n      text-shadow: \n        0 0 10px rgba(255,255,255,0.4),\n        0 1px 2px rgba(0,0,0,0.8);\n    }\n\n    /* 用户信息条 */\n    .explosion-user-strip {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 10px 12px;\n      background: rgba(0,0,0,0.4);\n      border: 1px solid rgba(100,100,100,0.3);\n      border-radius: 6px;\n      position: relative;\n      z-index: 1;\n    }\n\n    .explosion-avatar {\n      width: 28px;\n      height: 28px;\n      border-radius: 50%;\n      border: 2px solid rgba(120,120,120,0.5);\n      object-fit: cover;\n    }\n\n    .explosion-username {\n      flex: 1;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      font-weight: bold;\n      letter-spacing: 0.5px;\n      color: rgba(200,200,200,0.9);\n    }\n\n    .user-strip-holes {\n      display: flex;\n      gap: 6px;\n    }\n\n    .user-strip-holes span {\n      width: 4px;\n      height: 4px;\n      background: rgba(100,100,100,0.5);\n      border: 1px solid rgba(60,60,60,0.6);\n      border-radius: 50%;\n    }\n\n    /* PK目标标签 - 磁带条风格 */\n    .explosion-target-strip {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      padding: 10px 14px;\n      margin-bottom: 12px;\n      background: rgba(60,40,40,0.7);\n      border: 1px solid rgba(150,80,80,0.4);\n      border-radius: 6px;\n      position: relative;\n      z-index: 1;\n      box-shadow:\n        0 2px 4px rgba(0,0,0,0.5),\n        inset 0 1px 0 rgba(255,107,107,0.05);\n    }\n\n    .target-strip-label {\n      font-family: 'Courier New', monospace;\n      font-size: 10px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(200,200,200,0.8);\n      min-width: 60px;\n    }\n\n    .target-strip-value {\n      flex: 1;\n      font-family: 'Courier New', monospace;\n      font-size: 13px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(255,107,107,0.95);\n      text-shadow: 0 0 10px rgba(255,107,107,0.5);\n      animation: targetStripPulse 1.5s ease-in-out infinite;\n    }\n\n    @keyframes targetStripPulse {\n      0%, 100% {\n        color: rgba(255,107,107,0.95);\n        text-shadow: 0 0 10px rgba(255,107,107,0.5);\n      }\n      50% {\n        color: rgba(255,107,107,1);\n        text-shadow: 0 0 15px rgba(255,107,107,0.8);\n      }\n    }\n\n    .target-strip-holes {\n      display: flex;\n      gap: 6px;\n    }\n\n    .target-strip-holes span {\n      width: 5px;\n      height: 5px;\n      background: rgba(40,40,40,0.8);\n      border: 1px solid rgba(100,60,60,0.6);\n      border-radius: 50%;\n    }\n\n    @media (max-width: 600px) {\n      .explosion-center {\n        width: 160px;\n        height: 160px;\n      }\n\n      .explosion-icon-wrapper {\n        width: 90px;\n        height: 90px;\n      }\n\n      .explosion-info-tape {\n        width: 320px;\n        top: 200px;\n      }\n\n      .explosion-name {\n        font-size: 14px;\n        margin-bottom: 10px;\n      }\n\n      .explosion-value-bar {\n        height: 24px;\n      }\n\n      .value-text {\n        font-size: 12px;\n      }\n\n      .explosion-target-strip {\n        padding: 8px 12px;\n        margin-bottom: 10px;\n      }\n\n      .target-strip-label {\n        font-size: 9px;\n        min-width: 50px;\n      }\n\n      .target-strip-value {\n        font-size: 12px;\n      }\n\n      @keyframes shockwavePulse {\n        0% {\n          width: 20px;\n          height: 20px;\n          border-width: 3px;\n          opacity: 1;\n        }\n        100% {\n          width: 240px;\n          height: 240px;\n          border-width: 1px;\n          opacity: 0;\n        }\n      }\n    }\n  ",document.head.appendChild(n)}();const c=document.getElementById(o);if(!c)return;setTimeout(()=>c.classList.add("active"),50),setTimeout(()=>c.remove(),3e3)}(n,t):function(n,e){const t=document.querySelector(".live-room");if(!t)return;const o=`giftAnim_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=n.target?`\n    <div class="pk-target-label">\n      <div class="target-arrow">▶</div>\n      <div class="target-text">${"streamer"===n.target?"TO STREAMER":"TO USER"}</div>\n    </div>\n  `:"",i=`\n    <div class="gift-animation-container default-anim" id="${o}">\n      <div class="gift-card">\n        <div class="gift-card-header">\n          <div class="gift-label">\n            <div class="label-code">${n.giftCode}</div>\n            <div class="label-divider"></div>\n            <div class="label-text">GIFT RECEIVED</div>\n          </div>\n        </div>\n\n        ${a}\n\n        <div class="gift-icon-display">\n          <div class="gift-icon-wrapper">\n            ${e}\n          </div>\n          <div class="gift-glow-effect"></div>\n        </div>\n\n        <div class="gift-card-info">\n          <div class="gift-name-display">${n.giftName}</div>\n          <div class="gift-value-display">${n.giftPrice} POINTS</div>\n        </div>\n\n        <div class="gift-sender-tape">\n          <img src="${n.userAvatar}" class="sender-avatar" alt="avatar">\n          <div class="sender-name">${n.userName}</div>\n          <div class="tape-holes">\n            <span></span><span></span><span></span><span></span>\n          </div>\n        </div>\n\n        <div class="gift-corner tl"></div>\n        <div class="gift-corner tr"></div>\n        <div class="gift-corner bl"></div>\n        <div class="gift-corner br"></div>\n      </div>\n    </div>\n  `;t.insertAdjacentHTML("beforeend",i),function(){if(document.getElementById("giftAnimationStyles"))return;const n=document.createElement("style");n.id="giftAnimationStyles",n.textContent="\n    /* 礼物动画容器 - 磁带卡片风格 */\n    .gift-animation-container {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0.8);\n      z-index: 10004;\n      opacity: 0;\n      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      pointer-events: none;\n    }\n\n    .gift-animation-container.active {\n      opacity: 1;\n      transform: translate(-50%, -50%) scale(1);\n    }\n\n    .gift-animation-container.leaving {\n      opacity: 0;\n      transform: translate(-50%, -50%) scale(0.8) rotateY(90deg);\n      transition: all 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045);\n    }\n\n    /* 礼物卡片主体 */\n    .gift-card {\n      position: relative;\n      width: 320px;\n      background: linear-gradient(135deg, rgba(30,30,30,0.98), rgba(20,20,20,0.98));\n      border: 2px solid rgba(255,255,255,0.3);\n      border-radius: 16px;\n      box-shadow: 0 20px 60px rgba(0,0,0,0.9),\n                  0 0 40px rgba(255,255,255,0.1),\n                  inset 0 1px 1px rgba(255,255,255,0.15);\n      overflow: hidden;\n      animation: giftPulse 2s ease-in-out;\n    }\n\n    @keyframes giftPulse {\n      0%, 100% {\n        box-shadow: 0 20px 60px rgba(0,0,0,0.9),\n                    0 0 40px rgba(255,255,255,0.1),\n                    inset 0 1px 1px rgba(255,255,255,0.15);\n      }\n      50% {\n        box-shadow: 0 20px 60px rgba(0,0,0,0.9),\n                    0 0 60px rgba(255,255,255,0.2),\n                    inset 0 1px 1px rgba(255,255,255,0.2);\n      }\n    }\n\n    /* 顶部标签 */\n    .gift-card-header {\n      padding: 14px 20px;\n      background: rgba(0,0,0,0.4);\n      border-bottom: 1px solid rgba(255,255,255,0.15);\n    }\n\n    .gift-label {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .label-code {\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(255,255,255,0.9);\n      padding: 4px 10px;\n      background: rgba(255,255,255,0.1);\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 4px;\n    }\n\n    .label-divider {\n      flex: 1;\n      height: 1px;\n      background: linear-gradient(90deg, \n        transparent,\n        rgba(255,255,255,0.2) 50%,\n        transparent\n      );\n    }\n\n    .label-text {\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(255,255,255,0.7);\n    }\n\n    /* 礼物图标展示区 */\n    .gift-icon-display {\n      position: relative;\n      padding: 30px 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .gift-icon-wrapper {\n      position: relative;\n      width: 120px;\n      height: 120px;\n      animation: giftRotate 3s linear infinite;\n      filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));\n      z-index: 2;\n    }\n\n    @keyframes giftRotate {\n      0% {\n        transform: rotateY(0deg);\n      }\n      100% {\n        transform: rotateY(360deg);\n      }\n    }\n\n    .gift-glow-effect {\n      position: absolute;\n      inset: 0;\n      background: radial-gradient(\n        circle at center,\n        rgba(255,255,255,0.15) 0%,\n        transparent 70%\n      );\n      animation: giftGlow 2s ease-in-out infinite;\n    }\n\n    @keyframes giftGlow {\n      0%, 100% {\n        opacity: 0.3;\n      }\n      50% {\n        opacity: 0.6;\n      }\n    }\n\n    /* 礼物信息 */\n    .gift-card-info {\n      padding: 20px;\n      text-align: center;\n      border-top: 1px solid rgba(255,255,255,0.1);\n      background: rgba(0,0,0,0.2);\n    }\n\n    .gift-name-display {\n      font-family: 'Courier New', monospace;\n      font-size: 16px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(255,255,255,0.95);\n      margin-bottom: 8px;\n    }\n\n    .gift-value-display {\n      font-family: 'Courier New', monospace;\n      font-size: 13px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      color: rgba(255,255,255,0.7);\n    }\n\n    /* 发送者磁带条 */\n    .gift-sender-tape {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 14px 20px;\n      background: rgba(0,0,0,0.3);\n      border-top: 1px solid rgba(255,255,255,0.15);\n      position: relative;\n      overflow: hidden;\n    }\n\n    .sender-avatar {\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      border: 2px solid rgba(255,255,255,0.3);\n      object-fit: cover;\n    }\n\n    .sender-name {\n      flex: 1;\n      font-family: 'Courier New', monospace;\n      font-size: 12px;\n      font-weight: bold;\n      color: rgba(255,255,255,0.85);\n    }\n\n    .tape-holes {\n      display: flex;\n      gap: 6px;\n    }\n\n    .tape-holes span {\n      width: 4px;\n      height: 4px;\n      background: rgba(255,255,255,0.3);\n      border-radius: 50%;\n    }\n\n    /* 装饰边角 */\n    .gift-corner {\n      position: absolute;\n      width: 16px;\n      height: 16px;\n      border: 2px solid rgba(255,255,255,0.4);\n    }\n\n    .gift-corner.tl {\n      top: 8px;\n      left: 8px;\n      border-right: none;\n      border-bottom: none;\n    }\n\n    .gift-corner.tr {\n      top: 8px;\n      right: 8px;\n      border-left: none;\n      border-bottom: none;\n    }\n\n    .gift-corner.bl {\n      bottom: 8px;\n      left: 8px;\n      border-right: none;\n      border-top: none;\n    }\n\n    .gift-corner.br {\n      bottom: 8px;\n      right: 8px;\n      border-left: none;\n      border-top: none;\n    }\n\n    /* PK目标标签 - 磁带卡片风格 */\n    .pk-target-label {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n      padding: 8px 16px;\n      margin: 10px 20px;\n      background: rgba(60,60,60,0.7);\n      border: 1px solid rgba(140,140,140,0.4);\n      border-radius: 6px;\n      box-shadow:\n        0 2px 4px rgba(0,0,0,0.4),\n        inset 0 1px 0 rgba(255,255,255,0.08);\n      position: relative;\n    }\n\n    .pk-target-label::before,\n    .pk-target-label::after {\n      content: '';\n      position: absolute;\n      top: 50%;\n      transform: translateY(-50%);\n      width: 5px;\n      height: 5px;\n      border-radius: 50%;\n      background: rgba(0,0,0,0.6);\n      border: 1px solid rgba(100,100,100,0.4);\n    }\n\n    .pk-target-label::before {\n      left: 6px;\n    }\n\n    .pk-target-label::after {\n      right: 6px;\n    }\n\n    .target-arrow {\n      font-size: 14px;\n      color: rgba(255,107,107,0.95);\n      text-shadow: 0 0 8px rgba(255,107,107,0.5);\n      animation: arrowBlink 1.5s ease-in-out infinite;\n    }\n\n    @keyframes arrowBlink {\n      0%, 100% {\n        opacity: 1;\n        text-shadow: 0 0 8px rgba(255,107,107,0.5);\n      }\n      50% {\n        opacity: 0.6;\n        text-shadow: 0 0 12px rgba(255,107,107,0.7);\n      }\n    }\n\n    .target-text {\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 2px;\n      color: rgba(220,220,220,0.9);\n    }\n\n    @media (max-width: 600px) {\n      .gift-card {\n        width: 280px;\n      }\n\n      .gift-icon-wrapper {\n        width: 100px;\n        height: 100px;\n      }\n\n      .gift-name-display {\n        font-size: 14px;\n      }\n\n      .gift-value-display {\n        font-size: 12px;\n      }\n\n      .pk-target-label {\n        padding: 6px 12px;\n        margin: 8px 16px;\n      }\n\n      .target-arrow {\n        font-size: 12px;\n      }\n\n      .target-text {\n        font-size: 10px;\n      }\n    }\n  ",document.head.appendChild(n)}();const r=document.getElementById(o);if(!r)return;setTimeout(()=>r.classList.add("active"),50),setTimeout(()=>r.classList.add("leaving"),2e3),setTimeout(()=>r.remove(),2500)}(n,t)}n.analyzeGiftName=function(){const n=document.getElementById("giftName"),e=document.getElementById("smartPointsSuggest"),t=document.getElementById("suggestText");if(!n||!e||!t)return;const o=n.value.trim();if(o.length<2)return e.style.display="none",void(Ai=0);let a,i;const r=o.length,s={luxury:["钻石","黄金","白金","铂金","至尊","皇冠","王者","帝王","豪华","奢侈"],premium:["高级","奢华","珍贵","稀有","限定","典藏","收藏","名贵","珍品"],romantic:["爱","心","恋","情","玫瑰","浪漫","星空","月光","永恒","誓言","甜蜜"],cute:["可爱","萌","小","软","甜","乖","呆","糖"],special:["特殊","独特","定制","专属","唯一","限量","私人"],emotional:["梦想","希望","未来","回忆","青春","时光","岁月"]};let l="normal";for(const[n,e]of Object.entries(s))if(e.some(n=>o.includes(n))){l=n;break}const c=(n,e)=>[...n].sort(()=>Math.random()-.5).slice(0,e).join(" ");switch(l){case"luxury":a=Math.floor(5e3+5e3*Math.random());i=c([`呀，您这是要送「${o}」啊？`,"光这名字就闪闪发光呢！","这么贵重的东西，您都舍得拿出来了？","那咱可不能让它失了身价对吧？",`${a}积分，真的不算多。`,"毕竟您这样的贵客，出手向来阔绰。","这点积分在您眼里不过九牛一毛嘛~"],3+Math.floor(3*Math.random()));break;case"premium":a=Math.floor(1e3+4e3*Math.random());i=c([`哎呦「${o}」，这名字一看就不凡呐！`,"您这品味，啧啧，真是让人佩服。","这种级别的礼物，可不是谁都配送的。",`${a}积分，刚刚好配得上您的身份。`,"您说您这么有眼光的人，能差这点钱吗？","投资要趁早，礼物也是如此呀~"],2+Math.floor(4*Math.random()));break;case"romantic":a=Math.floor(500+2500*Math.random());i=c([`「${o}」？我的天，这名字听着就让人心动！`,"您这是要向谁表心意呀？","真诚可是无价的，但表达真诚得有点成本吧？",`${a}积分，才能让对方感受到您的心意啊。`,"浪漫这种事儿，咱可不能小气对不对？","对方看到这个数字，肯定知道您是认真的~"],3+Math.floor(3*Math.random()));break;case"cute":a=Math.floor(100+400*Math.random());i=c([`「${o}」这名字可太可爱了吧？`,"不过呢，可爱归可爱...",`${a}积分差不多就够意思了。`,"您也不想让人觉得您太抠对吧？","可爱值钱吗？当然值钱！只不过没那么值钱罢了~"],2+Math.floor(3*Math.random()));break;case"special":a=Math.floor(800+2200*Math.random());i=c([`「${o}」？嚯，这名字够特别的！`,"特殊的礼物，自然要配特殊的诚意。",`${a}积分，正好体现出它的与众不同。`,"您既然想送独特的，怎么能在积分上含糊呢？","别人都是普通货，您可是要走高端路线的对吧？"],3+Math.floor(3*Math.random()));break;case"emotional":a=Math.floor(800+1700*Math.random());i=c([`「${o}」...这名字真有深度啊。`,"承载着这么重的情感，",`${a}积分，才能配得上它的分量呢。`,"您说这种有意义的东西，能随便定价吗？","情感无价，但礼物得有价，您懂的~"],3+Math.floor(3*Math.random()));break;default:if(r<=3){a=Math.floor(50+150*Math.random());i=c([`「${o}」？嗯，简洁明了。`,`${a}积分就行了。`,"简短不代表廉价，但也贵不到哪去~","您要是觉得少了，那就随意加点呗？"],2+Math.floor(2*Math.random()))}else if(r<=6){a=Math.floor(200+300*Math.random());i=c([`「${o}」，这名字长度还不错。`,`${a}积分，不多不少刚刚好。`,"您这是准备走中庸路线？","也行，反正您开心就好~"],2+Math.floor(3*Math.random()))}else{a=Math.floor(500+1500*Math.random());i=c([`哟「${o}」，这名字可够长的！`,"名字越长，诚意越得跟上对吧？",`${a}积分，勉强配得上这个长度。`,"您既然起了这么长的名，积分可别跌份儿了~","长名字配低积分？那多掉价啊！"],3+Math.floor(3*Math.random()))}}Ai=a,t.textContent=i,e.style.display="flex";const d=document.getElementById("giftPoints");d&&(!d.value||d.value<50)&&(d.value=a),d&&!d.dataset.listenerAdded&&(d.dataset.listenerAdded="true",d.addEventListener("input",Ei))},n.submitNewGift=async function(){const n=document.getElementById("giftCategoryId").value,t=document.getElementById("giftEditId")?.value,o=!!t,a=document.getElementById("giftName").value.trim(),i=document.getElementById("giftDescription").value.trim(),r=parseInt(document.getElementById("giftPoints").value),s=document.getElementById("giftImageUrl").value.trim(),l=document.getElementById("giftAnimation").value,c=document.getElementById("useUrlImage").checked,d=document.getElementById("useLocalImage").checked;if(!a)return void mn("请输入礼物名称","error");if(!r||r<50)return void mn("积分最少50","error");if(!c&&!d)return void mn("请至少选择一种图片上传方式","error");let p,g="";if(d){const n=document.getElementById("giftImageLocal");if(n.files&&n.files[0]){const e=new FileReader;g=await new Promise(t=>{e.onload=n=>t(n.target.result),e.readAsDataURL(n.files[0])})}else if(o){const n=await e(),o=await n.xCustomGifts.get(t);o&&(g=o.imageLocal||"")}}if(o){const n=await e(),o=await n.xCustomGifts.get(t);p=o?o.code:`C-${Date.now().toString().slice(-4)}`}else p=`C-${Date.now().toString().slice(-4)}`;const m={categoryId:n,name:a,subtitle:i||a,code:p,description:i||a,imageUrl:c?s:"",imageLocal:g,useLocalImage:d,points:r,animationType:l};if(o)try{const o=await e();await o.xCustomGifts.update(t,m),mn("礼物已更新","success"),Ti(),await Si(n),await wi()}catch(n){console.error("❌ [礼物编辑] 更新失败:",n),mn("更新失败","error")}else{const t=await async function(n){const t=e(),o=vt||"default";try{const e={id:`gift_${Date.now()}`,categoryId:n.categoryId,accountId:o,name:n.name,subtitle:n.subtitle||"",code:n.code,description:n.description,imageUrl:n.imageUrl||"",imageLocal:n.imageLocal||"",icon:n.icon||"",useLocalImage:n.useLocalImage||!1,points:n.points,animationType:n.animationType||"default",createdAt:(new Date).toISOString()};return await t.xCustomGifts.add(e),e}catch(n){return console.error("❌ [自定义礼物] 创建礼物失败:",n),null}}(m);t?(mn("礼物创建成功","success"),Ti(),await Si(n),await wi()):mn("创建失败","error")}},n.executeGiftSend=async function(e){const t=gi.selectedGift;if(!t)return;const o=bi(),a=t.points||t.price||0;if(o<a)return mn("积分不足","error"),void Bi();if(!yi(a))return mn("发送失败","error"),void Bi();const i=document.getElementById("giftPointsValue");if(i){const n=bi();i.textContent=n.toLocaleString(),i.style.transform="scale(1.2)",i.style.color="#ff1744",setTimeout(()=>{i.style.transform="scale(1)",i.style.color="rgba(255, 255, 255, 0.9)"},300)}const r=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",s=n.userProfileData?.name||"我",l={giftId:t.id,giftName:t.name,giftCode:t.code,giftIcon:t.icon||"",giftPrice:a,userName:s,userAvatar:r,timestamp:(new Date).toISOString(),animationType:t.animationType||"default",imageUrl:t.imageUrl||"",imageLocal:t.imageLocal||"",useLocalImage:t.useLocalImage||!1};if(function(e){if(!Ko||!Ko.details)return;const t=Ko.details;n.userProfileData,n.userProfileData,t.giftLeaderboard||(t.giftLeaderboard={userTotalPoints:0,userRank:null,lastUpdate:Date.now(),kickedOut:null,changes:null}),t.giftLeaderboard.userTotalPoints+=e;const o=t.giftLeaderboard.userTotalPoints;if(!t.leaderboards||!t.leaderboards.gifts)return void console.warn("⚠️ [礼物榜单] 没有礼物榜单数据");const a=[...t.leaderboards.gifts],i=t.giftLeaderboard.userRank;let r=a.length+1;for(let n=0;n<a.length;n++)if(o>a[n].value){r=n+1;break}let s="",l=null;if(r<=10?(null===i?(s=`新上榜 #${r}`,a.length>=10&&(l=a[9])):s=r<i?`排名上升 #${i} → #${r}`:`保持 #${r}`,t.giftLeaderboard.userRank=r,t.giftLeaderboard.kickedOut=l,t.giftLeaderboard.changes=s,t.giftLeaderboard.lastUpdate=Date.now()):(null===i&&(s=`未上榜（需要${a[9]?.value||0}积分才能上榜）`),t.giftLeaderboard.changes=s),La.isOpen&&si(),r<=10)try{const n=Ko.streamerHandle;n&&Hr(n,"giftRank",{giftRank:r,totalGiftPoints:o,giftHistory:t.userGifts||[],fanClubData:null,danmakuHistory:[]}).catch(n=>{console.error("❌ [主播私联检测] 失败:",n)})}catch(n){console.error("❌ [主播私联检测] 异常:",n)}}(a),Ko&&Ko.details){Ko.details.userGifts||(Ko.details.userGifts=[]);const n={...l,description:t.description||"",isCustom:!!t.isCustom,category:t.category||""};Ko.details.userGifts.push(n),aa(Ko.id,Ko.details).then(()=>{console.log(`💾 [礼物] 用户礼物数据已保存 (总积分: ${Ko.details.giftLeaderboard?.userTotalPoints||0})`)}).catch(n=>{console.error("⚠️ [礼物] 保存失败（不影响当前使用）:",n)})}if(Ko&&Ko.streamerHandle){const e=Ko.streamerHandle;n.addFanClubPoints?n.addFanClubPoints(e,a).catch(n=>{console.warn(`⚠️ [粉丝团联动] 积分增加失败（可能未加入粉丝团）: ${n.message}`)}):console.warn("⚠️ [粉丝团联动] addFanClubPoints 函数未找到")}Bi(),setTimeout(()=>{ki()},200),setTimeout(()=>{Li(l)},400),e?(mi.push(l),setTimeout(async()=>{Rl({title:"正在生成",message:"AI正在生成主播反应...",leftIcon:"x",duration:2e3}),await cr()},2e3)):(mi.push(l),Rl({title:"礼物队列",message:`${t.name} 已加入队列`,leftIcon:"x",duration:2e3}))},n.closeGiftConfirm=Bi;let Pi={isOpen:!1,isAddFormExpanded:!1,currentView:"wall",currentTag:null};function Di(){const n=Object.keys(ta);return 0===n.length?'\n        <div class="empty-wall">\n          <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; stroke: rgba(255,255,255,0.2); fill: none; stroke-width: 1.5;">\n            <circle cx="12" cy="12" r="10"/>\n            <path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/>\n          </svg>\n          <p>暂无音乐收藏</p>\n          <p class="hint">点击下方添加你的第一张唱片</p>\n        </div>\n      ':`\n      <div class="vinyl-grid">\n        ${n.map((n,e)=>{ta[n];return`\n            <div class="vinyl-case" style="animation-delay: ${.08*e}s" onclick="openTagSongList('${n}')">\n              \x3c!-- 玻璃封装 --\x3e\n              <div class="glass-cover">\n                <div class="glass-reflection"></div>\n                <div class="glass-shine"></div>\n              </div>\n              \n              \x3c!-- 唱片本体 --\x3e\n              <div class="vinyl-disc">\n                <div class="vinyl-groove"></div>\n                <div class="vinyl-groove"></div>\n                <div class="vinyl-groove"></div>\n                <div class="vinyl-center"></div>\n              </div>\n              \n              \x3c!-- 标签条 --\x3e\n              <div class="vinyl-tag">\n                <span>${n}</span>\n              </div>\n            </div>\n          `}).join("")}\n      </div>\n    `}function Ni(n){const e=ta[n]||[];return`\n      <div class="song-list-page">\n        \x3c!-- 顶部栏 --\x3e\n        <div class="song-list-header">\n          <button class="back-btn" onclick="backToTapeWall()">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n              <polyline points="15 18 9 12 15 6"/>\n            </svg>\n          </button>\n          <div class="header-title">\n            <div class="title-tag">${n}</div>\n            <div class="title-count">${e.length} 首歌曲</div>\n          </div>\n          <div class="header-spacer"></div>\n        </div>\n\n        \x3c!-- 歌曲列表 --\x3e\n        <div class="song-list-container">\n          ${0===e.length?'\n            <div class="empty-songs">\n              <svg viewBox="0 0 24 24" style="width: 36px; height: 36px; stroke: rgba(255,255,255,0.2); fill: none; stroke-width: 1.5;">\n                <path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/>\n              </svg>\n              <p>这个标签下还没有歌曲</p>\n            </div>\n          ':e.map((e,t)=>{return`\n            <div class="song-item" style="animation-delay: ${.05*t}s">\n              <div class="song-number">${String(t+1).padStart(2,"0")}</div>\n              <div class="song-vinyl-icon spinning">\n                <div class="icon-center"></div>\n              </div>\n              <div class="song-details">\n                <div class="song-title">${e.name}</div>\n                <div class="song-link">${o=e.url,o.length<=35?o:o.substring(0,32)+"..."}</div>\n              </div>\n              <button class="song-remove-btn" onclick="deleteTape('${n}', '${e.id}')" title="删除">\n                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">\n                  <polyline points="3 6 5 6 21 6"/>\n                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>\n                </svg>\n              </button>\n            </div>\n          `;var o}).join("")}\n        </div>\n      </div>\n    `}function Ri(n){Pi.currentView="songList",Pi.currentTag=n;const e=document.getElementById("cassetteWall");e&&(e.classList.add("song-list-view"),e.innerHTML=Ni(n))}function Hi(){Pi.currentView="wall",Pi.currentTag=null;const n=document.getElementById("cassetteWall");n&&n.classList.remove("song-list-view"),Ui()}function ji(){const n=document.getElementById("addTapeForm"),e=document.querySelector(".add-tape-trigger"),t=e.querySelector(".expand-arrow");Pi.isAddFormExpanded=!Pi.isAddFormExpanded,Pi.isAddFormExpanded?(n.style.maxHeight=n.scrollHeight+"px",t.style.transform="rotate(180deg)",e.classList.add("expanded")):(n.style.maxHeight="0",t.style.transform="rotate(0deg)",e.classList.remove("expanded"))}function Ui(){const n=document.getElementById("cassetteWall"),e=document.querySelector(".tape-count");n&&("songList"===Pi.currentView&&Pi.currentTag?(n.classList.add("song-list-view"),n.innerHTML=Ni(Pi.currentTag)):(n.classList.remove("song-list-view"),n.innerHTML=Di())),e&&(e.textContent=`${Object.keys(ta).length} 个标签`)}n.toggleAddTapeForm=ji,n.handleAddTape=async function(){const n=document.getElementById("musicNameInput"),e=document.getElementById("musicUrlInput"),t=document.querySelectorAll("#tagCheckboxes input[type=checkbox]:checked"),o=n.value.trim(),a=e.value.trim(),i=Array.from(t).map(n=>n.value);if(!o)return void mn("请填写歌曲名称","error");if(!a)return void mn("请填写URL","error");if(0===i.length)return void mn("请至少选择一个标签","error");await da(o,a,i)&&(n.value="",e.value="",t.forEach(n=>n.checked=!1),Ui(),ji())},n.deleteTape=async function(n,e){await async function(n,e){if(!ta[n])return mn("标签不存在","error"),!1;const t=ta[n].findIndex(n=>n.id===e);if(t<0)return mn("音乐不存在","error"),!1;const o=ta[n][t];return ta[n].splice(t,1),0===ta[n].length&&delete ta[n],!!await ca()&&(mn(`已删除 "${o.name}"`,"success"),!0)}(n,e)&&("songList"===Pi.currentView&&Pi.currentTag===n?ta[n]?Ri(n):Hi():Ui())},n.openTagSongList=Ri,n.backToTapeWall=Hi,n.closeLiveSettings=function(){if(!Pi.isOpen)return;const n=document.getElementById("liveSettingsPanel");n&&(n.classList.remove("active"),setTimeout(()=>{n.remove(),Pi.isOpen=!1,Pi.isAddFormExpanded=!1},400))},n.handleExportMusicLibrary=function(){try{const n=Object.values(ta).reduce((n,e)=>n+e.length,0);if(0===n)return void mn("音乐库为空，无内容可导出","info");const e={version:"1.0",exportedAt:(new Date).toISOString(),exportedBy:vt||"main",totalTags:Object.keys(ta).length,totalSongs:n,data:ta},t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(o),i=document.createElement("a");i.href=a;const r=(new Date).toISOString().replace(/[-:]/g,"").replace(/\..+/,"").replace("T","_");i.download=`music_library_${r}.json`,document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(a)},100),mn(`已导出 ${n} 首歌曲（${Object.keys(ta).length} 个标签）`,"success"),console.log("📤 [音乐库] 导出成功:",{totalTags:Object.keys(ta).length,totalSongs:n,fileName:i.download})}catch(n){console.error("❌ [音乐库] 导出失败:",n),mn("导出失败: "+n.message,"error")}},n.handleImportMusicLibrary=function(){const n=document.getElementById("musicLibraryFileInput");n&&(n.value="",n.click())},n.processImportFile=async function(n){const e=n.target.files[0];if(!e)return;if(!e.name.endsWith(".json"))return void mn("请选择JSON文件","error");if(e.size>10485760)mn("文件过大（超过10MB）","error");else{mn("正在导入...","info");try{const n=await e.text();let t,o;try{t=JSON.parse(n)}catch(n){throw new Error("JSON格式错误，请检查文件内容")}if(!t||"object"!=typeof t)throw new Error("文件格式错误：根对象无效");if(t.version&&t.data)o=t.data;else{if("object"!=typeof t)throw new Error("无法识别的文件格式");o=t}if(!o||"object"!=typeof o)throw new Error("文件格式错误：音乐数据无效");let a=0,i=0,r=0;for(const[n,e]of Object.entries(o)){if(!Array.isArray(e)){console.warn(`⚠️ [导入] 跳过无效标签: ${n}`);continue}!ta[n]&&(ta[n]=[],r++);for(const t of e){if(!t||!t.url||!t.name){console.warn("⚠️ [导入] 跳过无效歌曲:",t),i++;continue}ta[n].some(n=>n.url===t.url)?(console.log(`⏭️ [导入] 跳过重复歌曲: ${t.name} (${n})`),i++):(ta[n].push({id:`music_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.name,url:t.url,addedTime:Date.now()}),a++)}}if(!await ca())throw new Error("保存到数据库失败");Ui();let s=`导入完成！\n新增 ${a} 首歌曲`;r>0&&(s+=`\n新增 ${r} 个标签`),i>0&&(s+=`\n跳过 ${i} 首重复/无效歌曲`),mn(s,"success"),console.log("📥 [音乐库] 导入成功:",{added:a,skipped:i,newTags:r,totalTags:Object.keys(ta).length,totalSongs:Object.values(ta).reduce((n,e)=>n+e.length,0)})}catch(n){console.error("❌ [音乐库] 导入失败:",n),mn("导入失败: "+n.message,"error")}}},n.closeLiveRoom=Aa,n.toggleMusicMute=function(){if(ra)return ra.muted=!ra.muted,va(ra.muted),$a(),ra.muted},n.setMusicVolume=function(n){ra&&(n=Math.max(0,Math.min(1,n)),ra.volume=n,function(n){localStorage.setItem("liveMusicVolume",n.toString())}(n),n>0&&ra.muted&&(ra.muted=!1,va(!1)),$a())},n.closeLiveSidebar=Da,n.openLiveSidebar=Pa,n.openLeaderboard=function(){if(La.isOpen)return;const n=document.querySelector(".live-room");if(!n)return void mn("请先进入直播间","info");na.isOpen&&Da();const e=function(){const n=La.types;return`\n      <div class="leaderboard-panel" id="leaderboardPanel">\n        <div class="leaderboard-cassette">\n          \x3c!-- 榜单头部 --\x3e\n          <div class="leaderboard-header">\n            <div class="leaderboard-nav">\n              <div class="leaderboard-arrow" id="leaderboardPrev" onclick="prevLeaderboard()">\n                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: #fff; fill: none; stroke-width: 2.5;">\n                  <polyline points="15 18 9 12 15 6"/>\n                </svg>\n              </div>\n              \n              <div class="leaderboard-title" id="leaderboardTitle">\n                ${Ba[n[0]].title}\n              </div>\n              \n              <div class="leaderboard-arrow" id="leaderboardNext" onclick="nextLeaderboard()">\n                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: #fff; fill: none; stroke-width: 2.5;">\n                  <polyline points="9 18 15 12 9 6"/>\n                </svg>\n              </div>\n            </div>\n            \n            <span class="leaderboard-indicator" id="leaderboardIndicator">1/3</span>\n            \n            <div class="leaderboard-close" onclick="closeLeaderboard()">\n              <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: #fff; fill: none; stroke-width: 2.5;">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </div>\n          </div>\n          \n          \x3c!-- 榜单内容 - 3个磁带面板 --\x3e\n          <div class="leaderboard-content">\n            ${n.map((n,e)=>`\n              <div class="tape-side ${0===e?"active":""}" id="tapeSide${e}" data-type="${n}">\n                ${ri(n)}\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      </div>\n    `}();n.insertAdjacentHTML("beforeend",e),si(),function(){const n=document.getElementById("leaderboardPanel");if(!n)return;let e=0,t=0,o=0;n.addEventListener("touchstart",n=>{const a=n.touches[0];e=a.clientX,t=a.clientY,o=a.clientX},{passive:!0}),n.addEventListener("touchmove",n=>{const a=n.touches[0];o=a.clientX;const i=e-a.clientX,r=Math.abs(t-a.clientY);Math.abs(i)>r&&Math.abs(i)>10&&n.preventDefault()},{passive:!1}),n.addEventListener("touchend",()=>{const n=e-o;n>50&&La.currentIndex<2?di():n<-50&&La.currentIndex>0&&ci(),e=0,t=0,o=0},{passive:!0})}(),setTimeout(()=>{const n=document.getElementById("leaderboardPanel");n&&(n.classList.add("active"),La.isOpen=!0)},50)},n.openGifts=async function(){const n=document.querySelector(".live-room");if(!n)return void mn("请先进入直播间","info");if(gi.isOpen)return;na.isOpen&&Da(),await ui();const e=bi(),t=await fi();let o=t.length>0?t:pi;0===t.length&&(o=[...pi].sort((n,e)=>(n.price||0)-(e.price||0)));const a=`\n    \x3c!-- 纯黑遮罩，不模糊 --\x3e\n    <div class="gift-jukebox-overlay" id="giftMenuOverlay" onclick="closeGiftMenu()"></div>\n    \n    \x3c!-- 点唱机主面板 --\x3e\n    <div class="gift-jukebox-panel" id="giftMenuPanel">\n      \x3c!-- 顶部控制台 --\x3e\n      <div class="jukebox-control-bar">\n        \x3c!-- 左侧：编号窗口（可点击进入自定义礼物） --\x3e\n        <div class="jukebox-display-window clickable" onclick="openCustomGiftSystem()" title="点击管理自定义礼物">\n          <div class="display-label">CODE</div>\n          <div class="display-value" id="selectedGiftCode">- -</div>\n        </div>\n        \n        \x3c!-- 中间：标题 --\x3e\n        <div class="jukebox-title-strip">\n          <div class="title-dots">\n            <span></span><span></span><span></span>\n          </div>\n          <div class="title-text">GIFT JUKEBOX</div>\n          <div class="title-dots">\n            <span></span><span></span><span></span>\n          </div>\n        </div>\n        \n        \x3c!-- 右侧：积分表盘（可点击充值） --\x3e\n        <div class="jukebox-points-meter" onclick="openPointsRecharge()" style="cursor: pointer;" title="点击充值积分">\n          <div class="meter-label">POINTS</div>\n          <div class="meter-value" id="giftPointsValue">${e.toLocaleString()}</div>\n        </div>\n        \n        \x3c!-- 关闭按钮 --\x3e\n        <div class="jukebox-close-btn" onclick="closeGiftMenu()">\n          <svg viewBox="0 0 24 24" style="width: 100%; height: 100%; stroke: currentColor; fill: none; stroke-width: 2;">\n            <line x1="6" y1="6" x2="18" y2="18"/>\n            <line x1="18" y1="6" x2="6" y2="18"/>\n          </svg>\n        </div>\n      </div>\n\n      \x3c!-- 选择区域（票券列表） --\x3e\n      <div class="jukebox-selection-area">\n        ${o.map((n,t)=>{const o=e>=n.points,a=n.points>=1e3?(n.points/1e3).toFixed(n.points%1e3==0?0:1)+"K":n.points;let i="";return i=n.useLocalImage&&n.imageLocal?`<img src="${n.imageLocal}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.imageUrl?`<img src="${n.imageUrl}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.icon?n.icon:'<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;color:rgba(255,255,255,0.3);">?</div>',`\n            <div class="jukebox-ticket ${o?"":"insufficient"}" \n                 data-gift-id="${n.id}"\n                 data-gift-code="${n.code}"\n                 onclick="selectGift('${n.id}')">\n              \x3c!-- 左侧：编号+图标区 --\x3e\n              <div class="ticket-left-section">\n                <div class="ticket-code">${n.code}</div>\n                <div class="ticket-icon-box">\n                  ${i}\n                </div>\n                <div class="ticket-perforations">\n                  <div class="perf"></div>\n                  <div class="perf"></div>\n                  <div class="perf"></div>\n                </div>\n              </div>\n              \n              \x3c!-- 右侧：信息区 --\x3e\n              <div class="ticket-right-section">\n                <div class="ticket-main-name">${n.name}</div>\n                <div class="ticket-subtitle">${n.subtitle||n.description||""}</div>\n                <div class="ticket-price-tag">\n                  <span class="price-amount">${a}</span>\n                  <span class="price-currency">P</span>\n                </div>\n                ${o?"":'<div class="insufficient-badge">INSUFFICIENT</div>'}\n              </div>\n              \n              \x3c!-- 选中指针 --\x3e\n              <div class="selection-pointer">▶</div>\n            </div>\n          `}).join("")}\n      </div>\n\n      \x3c!-- 底部播放控制条 --\x3e\n      <div class="jukebox-play-bar">\n        <div class="play-bar-display" id="giftFooterInfo">\n          <div class="play-bar-placeholder">SELECT A GIFT TO PLAY</div>\n        </div>\n        <button class="jukebox-play-btn" id="giftSendBtn" disabled onclick="sendSelectedGift()">\n          <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n            <path d="M8 5v14l11-7z"/>\n          </svg>\n          <span>PLAY</span>\n        </button>\n      </div>\n    </div>\n  `;n.insertAdjacentHTML("beforeend",a),function(){if(document.getElementById("giftMenuStyles"))return;const n=document.createElement("style");n.id="giftMenuStyles",n.textContent="\n    /* ============================================\n       礼物点唱机系统 - 复古票券/留声机风格\n       纯黑白灰 | 无模糊 | 票券打孔 | 磁带窗口\n       ============================================ */\n    \n    /* 遮罩层 - 完全透明，仅用于点击关闭 */\n    .gift-jukebox-overlay {\n      position: fixed;\n      inset: 0;\n      background: transparent;\n      z-index: 10001;\n      opacity: 0;\n      transition: opacity 0.4s ease;\n    }\n\n    .gift-jukebox-overlay.active {\n      opacity: 1;\n    }\n\n    /* 点唱机主面板 - 从底部滑入 */\n    .gift-jukebox-panel {\n      position: fixed;\n      bottom: 0;\n      left: 50%;\n      transform: translateX(-50%) translateY(100%);\n      width: 92%;\n      max-width: 480px;\n      height: auto;\n      max-height: 75vh;\n      background: linear-gradient(180deg, rgba(20, 20, 20, 0.98) 0%, rgba(12, 12, 12, 0.98) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-bottom: none;\n      border-radius: 16px 16px 0 0;\n      box-shadow: \n        0 -10px 40px rgba(0, 0, 0, 0.8),\n        inset 0 1px 0 rgba(255, 255, 255, 0.1);\n      z-index: 10002;\n      opacity: 0;\n      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    }\n\n    .gift-jukebox-panel.active {\n      transform: translateX(-50%) translateY(0);\n      opacity: 1;\n    }\n\n    /* 磁带纹理背景 */\n    .gift-jukebox-panel::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: \n        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.01) 2px, rgba(255,255,255,0.01) 4px),\n        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.005) 2px, rgba(255,255,255,0.005) 4px);\n      pointer-events: none;\n      z-index: 0;\n    }\n\n    /* ========== 顶部控制台 ========== */\n    .jukebox-control-bar {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px 18px;\n      background: linear-gradient(180deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.9) 100%);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      gap: 12px;\n      position: relative;\n      z-index: 2;\n    }\n\n    /* 刻度线装饰 */\n    .jukebox-control-bar::after {\n      content: \"\";\n      position: absolute;\n      bottom: 0;\n      left: 18px;\n      right: 18px;\n      height: 3px;\n      background: repeating-linear-gradient(\n        90deg,\n        transparent,\n        transparent 4px,\n        rgba(255, 255, 255, 0.08) 4px,\n        rgba(255, 255, 255, 0.08) 5px\n      );\n    }\n\n    /* 编号显示窗口 */\n    .jukebox-display-window {\n      flex-shrink: 0;\n      width: 60px;\n      height: 44px;\n      background: rgba(8, 8, 8, 0.9);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 4px;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      gap: 2px;\n      padding: 6px;\n      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.6);\n    }\n\n    .display-label {\n      font-size: 7px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      color: rgba(255, 255, 255, 0.4);\n      font-family: 'Courier New', monospace;\n      text-transform: uppercase;\n    }\n\n    .display-value {\n      font-size: 16px;\n      font-weight: 900;\n      letter-spacing: 2px;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);\n    }\n\n    /* 标题条 */\n    .jukebox-title-strip {\n      flex: 1;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 10px;\n      padding: 0 12px;\n    }\n\n    .title-dots {\n      display: flex;\n      gap: 4px;\n    }\n\n    .title-dots span {\n      width: 4px;\n      height: 4px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.25);\n      box-shadow: 0 0 4px rgba(255, 255, 255, 0.1);\n    }\n\n    .title-text {\n      font-size: 11px;\n      font-weight: 900;\n      letter-spacing: 3px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.9);\n      white-space: nowrap;\n    }\n\n    /* 积分表盘 */\n    .jukebox-points-meter {\n      flex-shrink: 0;\n      width: 90px;\n      height: 44px;\n      background: rgba(8, 8, 8, 0.9);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 4px;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      gap: 2px;\n      padding: 6px;\n      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.6);\n    }\n\n    .meter-label {\n      font-size: 7px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      color: rgba(255, 255, 255, 0.4);\n      font-family: 'Courier New', monospace;\n      text-transform: uppercase;\n    }\n\n    .meter-value {\n      font-size: 14px;\n      font-weight: 900;\n      letter-spacing: 1px;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      transition: all 0.3s ease;\n    }\n\n    /* 关闭按钮 */\n    .jukebox-close-btn {\n      position: absolute;\n      top: 10px;\n      right: 10px;\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, 0.08);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      transition: all 0.25s ease;\n      color: rgba(255, 255, 255, 0.7);\n      z-index: 5;\n    }\n\n    .jukebox-close-btn:hover {\n      background: rgba(255, 255, 255, 0.15);\n      border-color: rgba(255, 255, 255, 0.3);\n      color: rgba(255, 255, 255, 0.95);\n      transform: scale(1.08);\n    }\n\n    .jukebox-close-btn:active {\n      transform: scale(0.92);\n    }\n\n    /* ========== 选择区域（票券列表） ========== */\n    .jukebox-selection-area {\n      flex: 0 1 auto;\n      overflow-y: auto;\n      overflow-x: hidden;\n      padding: 16px;\n      padding-bottom: 20px;\n      max-height: 360px;\n      position: relative;\n      z-index: 1;\n    }\n\n    /* 滚动提示渐变 */\n    .jukebox-selection-area::after {\n      content: \"\";\n      position: sticky;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      height: 40px;\n      background: linear-gradient(0deg, rgba(12, 12, 12, 0.95) 0%, transparent 100%);\n      pointer-events: none;\n      z-index: 2;\n    }\n\n    .jukebox-selection-area::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .jukebox-selection-area::-webkit-scrollbar-track {\n      background: rgba(0, 0, 0, 0.4);\n      border-radius: 3px;\n      margin: 8px 0;\n    }\n\n    .jukebox-selection-area::-webkit-scrollbar-thumb {\n      background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));\n      border-radius: 3px;\n      border: 1px solid rgba(255, 255, 255, 0.1);\n    }\n\n    .jukebox-selection-area::-webkit-scrollbar-thumb:hover {\n      background: linear-gradient(180deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3));\n    }\n\n    /* 票券项 */\n    .jukebox-ticket {\n      display: flex;\n      align-items: stretch;\n      background: linear-gradient(135deg, rgba(30, 30, 30, 0.9) 0%, rgba(18, 18, 18, 0.9) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-left: 2px solid rgba(255, 255, 255, 0.2);\n      border-radius: 6px;\n      margin-bottom: 10px;\n      cursor: pointer;\n      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);\n      position: relative;\n      overflow: hidden;\n      animation: ticketSlideIn 0.5s ease-out backwards;\n    }\n\n    @keyframes ticketSlideIn {\n      0% { opacity: 0; transform: translateX(-20px); }\n      100% { opacity: 1; transform: translateX(0); }\n    }\n\n    .jukebox-ticket:nth-child(1) { animation-delay: 0.05s; }\n    .jukebox-ticket:nth-child(2) { animation-delay: 0.1s; }\n    .jukebox-ticket:nth-child(3) { animation-delay: 0.15s; }\n    .jukebox-ticket:nth-child(4) { animation-delay: 0.2s; }\n    .jukebox-ticket:nth-child(5) { animation-delay: 0.25s; }\n    .jukebox-ticket:nth-child(6) { animation-delay: 0.3s; }\n\n    /* 撕裂线 */\n    .jukebox-ticket::before {\n      content: \"\";\n      position: absolute;\n      left: 94px;\n      top: 0;\n      bottom: 0;\n      width: 1px;\n      background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(255,255,255,0.15) 3px, rgba(255,255,255,0.15) 4px);\n      z-index: 1;\n    }\n\n    .jukebox-ticket:hover:not(.insufficient) {\n      border-color: rgba(255, 255, 255, 0.3);\n      border-left-color: rgba(255, 255, 255, 0.4);\n      transform: translateX(4px);\n      box-shadow: 0 4px 16px rgba(0,0,0,0.4), -2px 0 8px rgba(255,255,255,0.05);\n    }\n\n    .jukebox-ticket.selected {\n      border-color: rgba(255, 255, 255, 0.5);\n      border-left-color: rgba(255, 255, 255, 0.8);\n      background: linear-gradient(135deg, rgba(50, 50, 50, 0.9) 0%, rgba(30, 30, 30, 0.9) 100%);\n      box-shadow: 0 6px 20px rgba(0,0,0,0.5), -2px 0 12px rgba(255,255,255,0.1);\n    }\n\n    .jukebox-ticket.insufficient {\n      opacity: 0.35;\n      cursor: not-allowed;\n      filter: grayscale(0.7);\n    }\n\n    /* 左侧区域 */\n    .ticket-left-section {\n      width: 94px;\n      flex-shrink: 0;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      padding: 12px 10px;\n      position: relative;\n      background: linear-gradient(135deg, rgba(40, 40, 40, 0.6) 0%, rgba(25, 25, 25, 0.6) 100%);\n    }\n\n    .ticket-code {\n      font-size: 11px;\n      font-weight: 900;\n      letter-spacing: 2px;\n      color: rgba(255, 255, 255, 0.6);\n      font-family: 'Courier New', monospace;\n      margin-bottom: 6px;\n    }\n\n    .ticket-icon-box {\n      width: 52px;\n      height: 52px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));\n      margin-bottom: 6px;\n    }\n\n    .jukebox-ticket:hover:not(.insufficient) .ticket-icon-box {\n      transform: scale(1.08);\n      transition: transform 0.3s ease;\n    }\n\n    /* 打孔 */\n    .ticket-perforations {\n      position: absolute;\n      right: -1px;\n      top: 50%;\n      transform: translateY(-50%);\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .perf {\n      width: 6px;\n      height: 6px;\n      border-radius: 50%;\n      background: rgba(0, 0, 0, 0.8);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.8);\n    }\n\n    /* 右侧区域 */\n    .ticket-right-section {\n      flex: 1;\n      min-width: 0;\n      padding: 12px 16px;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      gap: 4px;\n    }\n\n    .ticket-main-name {\n      font-size: 11px;\n      font-weight: 900;\n      letter-spacing: 1.5px;\n      text-transform: uppercase;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      line-height: 1.3;\n      margin-bottom: 2px;\n    }\n\n    .ticket-subtitle {\n      font-size: 10px;\n      font-weight: 600;\n      color: rgba(255, 255, 255, 0.5);\n      letter-spacing: 0.5px;\n      margin-bottom: 6px;\n    }\n\n    .ticket-price-tag {\n      display: flex;\n      align-items: baseline;\n      gap: 3px;\n    }\n\n    .price-amount {\n      font-size: 15px;\n      font-weight: 900;\n      color: rgba(255, 255, 255, 0.9);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 1px;\n    }\n\n    .price-currency {\n      font-size: 10px;\n      font-weight: 800;\n      color: rgba(255, 255, 255, 0.6);\n      font-family: 'Courier New', monospace;\n    }\n\n    /* 积分不足标记 */\n    .insufficient-badge {\n      position: absolute;\n      top: 8px;\n      right: 10px;\n      font-size: 8px;\n      font-weight: 800;\n      letter-spacing: 0.5px;\n      text-transform: uppercase;\n      color: rgba(255, 80, 80, 0.9);\n      background: rgba(255, 80, 80, 0.1);\n      padding: 3px 8px;\n      border-radius: 4px;\n      border: 0.5px solid rgba(255, 80, 80, 0.3);\n      font-family: 'Courier New', monospace;\n    }\n\n    /* 选中指针 */\n    .selection-pointer {\n      position: absolute;\n      left: -16px;\n      top: 50%;\n      transform: translateY(-50%) scale(0);\n      font-size: 20px;\n      color: rgba(255, 255, 255, 0.9);\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);\n    }\n\n    .jukebox-ticket.selected .selection-pointer {\n      transform: translateY(-50%) scale(1);\n      opacity: 1;\n      left: 2px;\n    }\n\n    /* ========== 底部播放控制条 ========== */\n    .jukebox-play-bar {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 12px;\n      padding: 14px 18px;\n      background: linear-gradient(0deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.9) 100%);\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n      position: relative;\n      z-index: 2;\n    }\n\n    /* 刻度线装饰 */\n    .jukebox-play-bar::before {\n      content: \"\";\n      position: absolute;\n      top: 0;\n      left: 18px;\n      right: 18px;\n      height: 3px;\n      background: repeating-linear-gradient(\n        90deg,\n        transparent,\n        transparent 4px,\n        rgba(255, 255, 255, 0.08) 4px,\n        rgba(255, 255, 255, 0.08) 5px\n      );\n    }\n\n    .play-bar-display {\n      flex: 1;\n      min-width: 0;\n    }\n\n    .play-bar-placeholder {\n      font-size: 10px;\n      font-weight: 700;\n      letter-spacing: 1.5px;\n      text-transform: uppercase;\n      color: rgba(255, 255, 255, 0.4);\n      font-family: 'Courier New', monospace;\n    }\n\n    .play-bar-selected {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .selected-icon-mini {\n      width: 28px;\n      height: 28px;\n      flex-shrink: 0;\n      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));\n    }\n\n    .selected-info {\n      flex: 1;\n      min-width: 0;\n    }\n\n    .selected-name {\n      font-size: 10px;\n      font-weight: 800;\n      letter-spacing: 0.8px;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      text-transform: uppercase;\n      line-height: 1.3;\n      margin-bottom: 2px;\n    }\n\n    .selected-price {\n      font-size: 9px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.6);\n      font-family: 'Courier New', monospace;\n    }\n\n    /* 播放按钮 */\n    .jukebox-play-btn {\n      flex-shrink: 0;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n      padding: 11px 22px;\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));\n      border: 1.5px solid rgba(255, 255, 255, 0.25);\n      border-radius: 8px;\n      color: rgba(255, 255, 255, 0.95);\n      font-size: 11px;\n      font-weight: 900;\n      letter-spacing: 2px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      cursor: pointer;\n      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);\n      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);\n      white-space: nowrap;\n    }\n\n    .jukebox-play-btn:disabled {\n      opacity: 0.3;\n      cursor: not-allowed;\n      filter: grayscale(0.8);\n    }\n\n    .jukebox-play-btn:not(:disabled):hover {\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));\n      border-color: rgba(255, 255, 255, 0.4);\n      transform: translateY(-2px);\n      box-shadow: 0 5px 16px rgba(0, 0, 0, 0.5);\n    }\n\n    .jukebox-play-btn.ready {\n      animation: playBtnPulse 2s ease-in-out infinite;\n    }\n\n    @keyframes playBtnPulse {\n      0%, 100% { box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4); }\n      50% { box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4), 0 0 16px rgba(255, 255, 255, 0.15); }\n    }\n\n    .jukebox-play-btn:not(:disabled):active {\n      transform: translateY(0) scale(0.96);\n    }\n\n    /* ========== 移动端适配 ========== */\n    @media (max-width: 600px) {\n      .gift-jukebox-panel {\n        width: 100%;\n        max-width: none;\n        max-height: 70vh;\n        height: auto;\n        border-radius: 20px 20px 0 0;\n      }\n\n      .jukebox-control-bar {\n        padding: 12px 14px;\n        flex-wrap: wrap;\n      }\n\n      .jukebox-display-window {\n        width: 52px;\n        height: 38px;\n      }\n\n      .display-label {\n        font-size: 6px;\n      }\n\n      .display-value {\n        font-size: 14px;\n      }\n\n      .title-text {\n        font-size: 10px;\n        letter-spacing: 2px;\n      }\n\n      .jukebox-points-meter {\n        width: 80px;\n        height: 38px;\n      }\n\n      .meter-label {\n        font-size: 6px;\n      }\n\n      .meter-value {\n        font-size: 12px;\n      }\n\n      .jukebox-selection-area {\n        padding: 12px;\n        padding-bottom: 16px;\n        max-height: 280px;\n      }\n\n      .jukebox-selection-area::after {\n        height: 30px;\n      }\n\n      .jukebox-selection-area::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .jukebox-ticket {\n        margin-bottom: 8px;\n      }\n\n      .ticket-left-section {\n        width: 80px;\n        padding: 10px 8px;\n      }\n\n      .ticket-code {\n        font-size: 10px;\n      }\n\n      .ticket-icon-box {\n        width: 44px;\n        height: 44px;\n      }\n\n      .ticket-main-name {\n        font-size: 10px;\n        letter-spacing: 1px;\n      }\n\n      .ticket-subtitle {\n        font-size: 9px;\n      }\n\n      .price-amount {\n        font-size: 14px;\n      }\n\n      .jukebox-play-bar {\n        padding: 12px 14px;\n      }\n\n      .jukebox-play-btn {\n        padding: 10px 18px;\n        font-size: 10px;\n        letter-spacing: 1.5px;\n      }\n    }\n  ",document.head.appendChild(n)}(),setTimeout(()=>{const n=document.getElementById("giftMenuPanel"),e=document.getElementById("giftMenuOverlay");n&&n.classList.add("active"),e&&e.classList.add("active"),gi.isOpen=!0},50)},n.openMyLiveRoom=function(){mn("直播间管理功能开发中...","info")},n.openLiveSettings=function(){if(Pi.isOpen)return;na.isOpen&&Da(),Pi.isOpen=!0;const n=document.querySelector(".live-room");if(!n)return;const e=document.createElement("div");e.id="liveSettingsPanel",e.className="live-settings-panel",e.innerHTML=`\n      \x3c!-- 遮罩层 --\x3e\n      <div class="settings-overlay" onclick="closeLiveSettings()"></div>\n      \n      \x3c!-- 磁带盒主容器 --\x3e\n      <div class="settings-cassette-box">\n        \x3c!-- 磁带盒顶盖 --\x3e\n        <div class="cassette-box-lid">\n          <div class="lid-label">\n            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: rgba(255,255,255,0.8); fill: none; stroke-width: 2;">\n              <circle cx="12" cy="12" r="10"/>\n              <path d="M12 6v6l4 2"/>\n            </svg>\n            <span>MUSIC LIBRARY</span>\n          </div>\n          <div class="lid-actions">\n            <div class="lid-icon-btn" onclick="handleExportMusicLibrary()" title="导出音乐库">\n              <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>\n                <polyline points="7 10 12 15 17 10"/>\n                <line x1="12" y1="15" x2="12" y2="3"/>\n              </svg>\n            </div>\n            <div class="lid-icon-btn" onclick="handleImportMusicLibrary()" title="导入音乐库">\n              <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>\n                <polyline points="17 8 12 3 7 8"/>\n                <line x1="12" y1="3" x2="12" y2="15"/>\n              </svg>\n            </div>\n            <div class="lid-close-btn" onclick="closeLiveSettings()">\n              <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: #fff; fill: none; stroke-width: 2.5;">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </div>\n            <input type="file" id="musicLibraryFileInput" accept=".json" style="display: none;" onchange="processImportFile(event)">\n          </div>\n        </div>\n\n        \x3c!-- 磁带墙容器 --\x3e\n        <div class="cassette-wall-container">\n          <div class="wall-header">\n            <span>MY LIBRARY</span>\n            <span class="tape-count">${Object.keys(ta).length} 个标签</span>\n          </div>\n          <div class="cassette-wall" id="cassetteWall">\n            ${Di()}\n          </div>\n        </div>\n\n        \x3c!-- 添加新磁带区域 --\x3e\n        <div class="add-tape-section">\n          <div class="add-tape-trigger" onclick="toggleAddTapeForm()">\n            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: rgba(255,255,255,0.9); fill: none; stroke-width: 2.5;">\n              <circle cx="12" cy="12" r="10"/>\n              <line x1="12" y1="8" x2="12" y2="16"/>\n              <line x1="8" y1="12" x2="16" y2="12"/>\n            </svg>\n            <span>ADD NEW SONG</span>\n            <svg class="expand-arrow" viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: rgba(255,255,255,0.6); fill: none; stroke-width: 2.5;">\n              <polyline points="6 9 12 15 18 9"/>\n            </svg>\n          </div>\n          \n          <div class="add-tape-form" id="addTapeForm">\n            <div class="form-field">\n              <label>\n                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n                  <path d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/>\n                </svg>\n                <span>歌曲名称</span>\n              </label>\n              <input \n                type="text" \n                id="musicNameInput" \n                placeholder="例如: 晴天" \n                class="tape-input"\n              />\n            </div>\n            \n            <div class="form-field">\n              <label>\n                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>\n                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>\n                </svg>\n                <span>URL</span>\n              </label>\n              <input \n                type="text" \n                id="musicUrlInput" \n                placeholder="http://music.163.com/..." \n                class="tape-input"\n              />\n            </div>\n            \n            <div class="form-field">\n              <label>\n                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n                  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>\n                  <line x1="7" y1="7" x2="7.01" y2="7"/>\n                </svg>\n                <span>标签（可多选）</span>\n              </label>\n              <div class="tag-checkboxes" id="tagCheckboxes">\n                ${function(){const n=new Set;return Object.keys(ia).forEach(e=>{n.add(e)}),Object.keys(ta).forEach(e=>{n.add(e)}),Array.from(n)}().map(n=>`\n                  <label class="tag-checkbox">\n                    <input type="checkbox" value="${n}" />\n                    <span>${n}</span>\n                  </label>\n                `).join("")}\n              </div>\n            </div>\n            \n            <button class="save-tape-btn" onclick="handleAddTape()">\n              <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: #fff; fill: none; stroke-width: 2.5;">\n                <polyline points="20 6 9 17 4 12"/>\n              </svg>\n              <span>SAVE</span>\n            </button>\n          </div>\n        </div>\n      </div>\n    `,function(){if(document.getElementById("live-settings-styles"))return;const n=document.createElement("style");n.id="live-settings-styles",n.textContent='\n      /* 设置面板容器 */\n      .live-settings-panel {\n        position: fixed;\n        inset: 0;\n        z-index: 10000;\n        display: flex;\n        align-items: flex-end;\n        justify-content: center;\n        padding-bottom: 80px;\n        opacity: 0;\n        transition: opacity 0.4s ease;\n      }\n\n      .live-settings-panel.active {\n        opacity: 1;\n      }\n\n      .live-settings-panel.active .settings-cassette-box {\n        transform: translateY(0) scale(1);\n        opacity: 1;\n      }\n\n      /* 遮罩层 */\n      .settings-overlay {\n        position: fixed;\n        inset: 0;\n        background: transparent;\n        z-index: 1;\n      }\n\n      /* 磁带盒主容器 */\n      .settings-cassette-box {\n        position: relative;\n        width: 90%;\n        max-width: 420px;\n        max-height: 70vh;\n        background: linear-gradient(\n          135deg,\n          rgba(25, 25, 25, 0.98) 0%,\n          rgba(20, 20, 20, 0.98) 50%,\n          rgba(15, 15, 15, 0.98) 100%\n        );\n        backdrop-filter: blur(40px) saturate(150%);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 24px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),\n                    0 0 1px rgba(255, 255, 255, 0.2),\n                    inset 0 1px 1px rgba(255, 255, 255, 0.1);\n        overflow: hidden;\n        z-index: 2;\n        transform: translateY(100px) scale(0.9);\n        opacity: 0;\n        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);\n        display: flex;\n        flex-direction: column;\n      }\n\n      /* 磁带纹理 */\n      .settings-cassette-box::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        pointer-events: none;\n      }\n\n      /* 磁带盒顶盖 */\n      .cassette-box-lid {\n        padding: 20px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n        background: linear-gradient(\n          180deg,\n          rgba(255, 255, 255, 0.03),\n          transparent\n        );\n      }\n\n      .lid-label {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        font-size: 13px;\n        font-weight: 800;\n        letter-spacing: 2px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.9);\n        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);\n      }\n\n      .lid-close-btn {\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.08);\n        border: 0.5px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .lid-close-btn:hover {\n        background: rgba(255, 255, 255, 0.12);\n        transform: scale(1.08);\n      }\n\n      .lid-close-btn:active {\n        transform: scale(0.92);\n      }\n\n      /* 磁带墙容器 */\n      .cassette-wall-container {\n        flex: 1;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        min-height: 0;\n      }\n\n      .wall-header {\n        padding: 16px 20px 12px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.06);\n        flex-shrink: 0;\n      }\n\n      .wall-header span:first-child {\n        font-size: 10px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.5);\n      }\n\n      .tape-count {\n        font-size: 11px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.7);\n        font-family: "Courier New", monospace;\n        padding: 4px 10px;\n        background: rgba(255, 255, 255, 0.05);\n        border-radius: 12px;\n        border: 0.5px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .cassette-wall {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 20px;\n        min-height: 0;\n      }\n\n      /* 歌曲列表视图时移除padding，保持隐藏溢出 */\n      .cassette-wall.song-list-view {\n        padding: 0;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .cassette-wall::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .cassette-wall::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 2px;\n      }\n\n      /* 空状态 */\n      .empty-wall {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 12px;\n        color: rgba(255, 255, 255, 0.4);\n        padding: 40px 20px;\n      }\n\n      .empty-wall p {\n        margin: 0;\n        font-size: 14px;\n        font-weight: 600;\n        font-family: "Courier New", monospace;\n      }\n\n      .empty-wall .hint {\n        font-size: 11px;\n        font-weight: 400;\n        opacity: 0.7;\n      }\n\n      /* 唱片网格 */\n      .vinyl-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));\n        gap: 16px;\n        padding: 4px;\n      }\n\n      /* 唱片盒（玻璃封装） */\n      .vinyl-case {\n        position: relative;\n        aspect-ratio: 1;\n        cursor: pointer;\n        transition: transform 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);\n        animation: vinylFadeIn 0.5s ease-out backwards;\n      }\n\n      @keyframes vinylFadeIn {\n        0% {\n          opacity: 0;\n          transform: scale(0.8) translateY(20px);\n        }\n        100% {\n          opacity: 1;\n          transform: scale(1) translateY(0);\n        }\n      }\n\n      .vinyl-case:hover {\n        transform: translateY(-8px) scale(1.02);\n        z-index: 10;\n      }\n\n      .vinyl-case:hover .vinyl-disc {\n        transform: scale(1.05);\n        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);\n      }\n\n      .vinyl-case:hover .glass-cover {\n        opacity: 0.6;\n      }\n\n      /* 玻璃封装 */\n      .glass-cover {\n        position: absolute;\n        inset: 0;\n        background: linear-gradient(135deg, \n          rgba(255, 255, 255, 0.15) 0%,\n          rgba(255, 255, 255, 0.05) 50%,\n          rgba(255, 255, 255, 0.1) 100%\n        );\n        border-radius: 16px;\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        opacity: 0.8;\n        transition: all 0.3s ease;\n        pointer-events: none;\n        box-shadow: \n          0 8px 32px rgba(0, 0, 0, 0.3),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.2);\n      }\n\n      .glass-reflection {\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 40%;\n        background: linear-gradient(180deg,\n          rgba(255, 255, 255, 0.25) 0%,\n          transparent 100%\n        );\n        border-radius: 16px 16px 0 0;\n      }\n\n      .glass-shine {\n        position: absolute;\n        top: 10%;\n        left: 10%;\n        width: 30%;\n        height: 30%;\n        background: radial-gradient(circle,\n          rgba(255, 255, 255, 0.4) 0%,\n          transparent 70%\n        );\n        border-radius: 50%;\n        animation: glassShine 3s ease-in-out infinite;\n      }\n\n      @keyframes glassShine {\n        0%, 100% { opacity: 0.3; transform: translate(0, 0); }\n        50% { opacity: 0.6; transform: translate(10px, 10px); }\n      }\n\n      /* 唱片本体 */\n      .vinyl-disc {\n        width: 100%;\n        height: 100%;\n        border-radius: 50%;\n        background: radial-gradient(circle at 30% 30%,\n          #2a2a2a 0%,\n          #1a1a1a 30%,\n          #0a0a0a 100%\n        );\n        position: relative;\n        transition: all 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);\n        box-shadow: \n          0 8px 24px rgba(0, 0, 0, 0.4),\n          inset 0 0 40px rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      /* 唱片沟槽 */\n      .vinyl-groove {\n        position: absolute;\n        border-radius: 50%;\n        border: 0.5px solid rgba(255, 255, 255, 0.05);\n        pointer-events: none;\n      }\n\n      .vinyl-groove:nth-child(2) {\n        inset: 15%;\n      }\n\n      .vinyl-groove:nth-child(3) {\n        inset: 25%;\n      }\n\n      .vinyl-groove:nth-child(4) {\n        inset: 35%;\n      }\n\n      /* 唱片中心孔 */\n      .vinyl-center {\n        position: absolute;\n        width: 12%;\n        height: 12%;\n        border-radius: 50%;\n        background: radial-gradient(circle,\n          #000 0%,\n          #1a1a1a 100%\n        );\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        box-shadow: \n          0 0 0 1.5px rgba(0, 0, 0, 0.5),\n          inset 0 1px 3px rgba(0, 0, 0, 0.8);\n        z-index: 4;\n      }\n\n      /* 唱片标签条 */\n      .vinyl-tag {\n        position: absolute;\n        bottom: -6px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: linear-gradient(135deg,\n          rgba(255, 255, 255, 0.15) 0%,\n          rgba(255, 255, 255, 0.08) 100%\n        );\n        padding: 3px 10px;\n        border-radius: 6px;\n        border: 0.5px solid rgba(255, 255, 255, 0.2);\n        backdrop-filter: blur(10px);\n        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);\n        z-index: 5;\n      }\n\n      .vinyl-tag span {\n        font-size: 8px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.9);\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        white-space: nowrap;\n      }\n\n      /* 歌曲列表页 */\n      .song-list-page {\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n        min-height: 0;\n      }\n\n      /* 列表顶部栏 */\n      .song-list-header {\n        flex-shrink: 0;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 16px 20px;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);\n      }\n\n      .back-btn {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.08);\n        border: 0.5px solid rgba(255, 255, 255, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        color: rgba(255, 255, 255, 0.8);\n        flex-shrink: 0;\n      }\n\n      .back-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.25);\n        transform: scale(1.1) translateX(-2px);\n      }\n\n      .back-btn:active {\n        transform: scale(0.95);\n      }\n\n      .header-title {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n      }\n\n      .title-tag {\n        font-size: 14px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.95);\n        letter-spacing: 0.5px;\n        font-family: "Courier New", monospace;\n      }\n\n      .title-count {\n        font-size: 10px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.5);\n        font-family: "Courier New", monospace;\n      }\n\n      .header-spacer {\n        width: 36px;\n        flex-shrink: 0;\n      }\n\n      /* 歌曲列表容器 */\n      .song-list-container {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 16px 20px;\n        min-height: 0;\n      }\n\n      .song-list-container::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .song-list-container::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 2px;\n      }\n\n      /* 歌曲项 */\n      .song-item {\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        padding: 12px 14px;\n        margin-bottom: 10px;\n        background: linear-gradient(135deg,\n          rgba(255, 255, 255, 0.08) 0%,\n          rgba(255, 255, 255, 0.04) 100%\n        );\n        border: 0.5px solid rgba(255, 255, 255, 0.12);\n        border-radius: 14px;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        animation: songItemSlideIn 0.4s ease-out backwards;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n      }\n\n      @keyframes songItemSlideIn {\n        0% {\n          opacity: 0;\n          transform: translateX(-20px);\n        }\n        100% {\n          opacity: 1;\n          transform: translateX(0);\n        }\n      }\n\n      .song-item:hover {\n        background: linear-gradient(135deg,\n          rgba(255, 255, 255, 0.12) 0%,\n          rgba(255, 255, 255, 0.06) 100%\n        );\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: translateX(4px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n\n      .song-number {\n        font-size: 12px;\n        font-weight: 800;\n        color: rgba(255, 255, 255, 0.4);\n        font-family: "Courier New", monospace;\n        min-width: 24px;\n        text-align: center;\n      }\n\n      .song-vinyl-icon {\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        background: radial-gradient(circle at 30% 30%,\n          #2a2a2a 0%,\n          #0a0a0a 100%\n        );\n        border: 2px solid rgba(255, 255, 255, 0.2);\n        position: relative;\n        flex-shrink: 0;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4),\n                    inset 0 0 8px rgba(0, 0, 0, 0.6);\n      }\n\n      .song-vinyl-icon.spinning {\n        animation: vinylSpin 3s linear infinite;\n      }\n\n      @keyframes vinylSpin {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n\n      .icon-center {\n        position: absolute;\n        inset: 35%;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.1);\n        border: 0.5px solid rgba(255, 255, 255, 0.2);\n      }\n\n      .song-details {\n        flex: 1;\n        min-width: 0;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n      }\n\n      .song-title {\n        font-size: 13px;\n        font-weight: 700;\n        color: rgba(255, 255, 255, 0.95);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .song-link {\n        font-size: 10px;\n        color: rgba(255, 255, 255, 0.45);\n        font-family: "Courier New", monospace;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .song-remove-btn {\n        width: 32px;\n        height: 32px;\n        border-radius: 8px;\n        background: rgba(255, 255, 255, 0.05);\n        border: 0.5px solid rgba(255, 255, 255, 0.1);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.25s ease;\n        color: rgba(255, 255, 255, 0.5);\n        flex-shrink: 0;\n      }\n\n      .song-remove-btn:hover {\n        background: rgba(255, 80, 80, 0.15);\n        border-color: rgba(255, 80, 80, 0.3);\n        color: rgba(255, 100, 100, 0.9);\n        transform: scale(1.1);\n      }\n\n      .song-remove-btn:active {\n        transform: scale(0.9);\n      }\n\n      /* 空歌曲列表 */\n      .empty-songs {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 40px 20px;\n        gap: 12px;\n        opacity: 0.6;\n      }\n\n      .empty-songs p {\n        font-size: 12px;\n        color: rgba(255, 255, 255, 0.5);\n        text-align: center;\n      }\n\n      /* 顶盖操作按钮容器 */\n      .lid-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .lid-icon-btn {\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.06);\n        border: 0.5px solid rgba(255, 255, 255, 0.12);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        color: rgba(255, 255, 255, 0.75);\n        flex-shrink: 0;\n      }\n\n      .lid-icon-btn:hover {\n        background: rgba(255, 255, 255, 0.12);\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: scale(1.08);\n        color: rgba(255, 255, 255, 0.95);\n      }\n\n      .lid-icon-btn:active {\n        transform: scale(0.95);\n      }\n\n      /* 添加新磁带区域 */\n      .add-tape-section {\n        border-top: 1px solid rgba(255, 255, 255, 0.06);\n        background: linear-gradient(\n          0deg,\n          rgba(255, 255, 255, 0.02),\n          transparent\n        );\n      }\n\n      .add-tape-trigger {\n        padding: 16px 20px;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        cursor: pointer;\n        transition: all 0.25s ease;\n        user-select: none;\n      }\n\n      .add-tape-trigger:hover {\n        background: rgba(255, 255, 255, 0.03);\n      }\n\n      .add-tape-trigger:active {\n        background: rgba(255, 255, 255, 0.05);\n      }\n\n      .add-tape-trigger span {\n        flex: 1;\n        font-size: 11px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.8);\n      }\n\n      .add-tape-trigger.expanded {\n        background: rgba(255, 255, 255, 0.03);\n      }\n\n      .expand-arrow {\n        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      /* 添加表单 */\n      .add-tape-form {\n        max-height: 0;\n        overflow: hidden;\n        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .form-field {\n        padding: 0 20px 16px;\n      }\n\n      .form-field label {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        font-size: 10px;\n        font-weight: 700;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        color: rgba(255, 255, 255, 0.6);\n        margin-bottom: 8px;\n      }\n\n      .tape-input {\n        width: 100%;\n        padding: 12px 16px;\n        background: linear-gradient(\n          180deg,\n          rgba(15, 15, 15, 0.95),\n          rgba(20, 20, 20, 0.95)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 10px;\n        color: rgba(255, 255, 255, 0.9);\n        font-size: 12px;\n        font-family: "Courier New", monospace;\n        outline: none;\n        transition: all 0.3s ease;\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);\n      }\n\n      .tape-input::placeholder {\n        color: rgba(255, 255, 255, 0.3);\n      }\n\n      .tape-input:focus {\n        border-color: rgba(255, 255, 255, 0.3);\n        background: linear-gradient(\n          180deg,\n          rgba(20, 20, 20, 0.95),\n          rgba(25, 25, 25, 0.95)\n        );\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3),\n                    0 0 0 2px rgba(255, 255, 255, 0.08);\n      }\n\n      /* 标签复选框 */\n      .tag-checkboxes {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n        padding: 8px 0;\n      }\n\n      .tag-checkbox {\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        padding: 8px 12px;\n        background: rgba(255, 255, 255, 0.04);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 10px;\n        cursor: pointer;\n        transition: all 0.25s ease;\n        font-size: 11px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.7);\n        user-select: none;\n      }\n\n      .tag-checkbox:hover {\n        background: rgba(255, 255, 255, 0.08);\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: translateY(-1px);\n      }\n\n      .tag-checkbox input[type="checkbox"] {\n        width: 14px;\n        height: 14px;\n        appearance: none;\n        -webkit-appearance: none;\n        border: 1.5px solid rgba(255, 255, 255, 0.3);\n        border-radius: 3px;\n        cursor: pointer;\n        position: relative;\n        transition: all 0.2s ease;\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .tag-checkbox input[type="checkbox"]:checked {\n        background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));\n        border-color: rgba(255, 255, 255, 0.5);\n      }\n\n      .tag-checkbox input[type="checkbox"]:checked::after {\n        content: "";\n        position: absolute;\n        left: 3px;\n        top: 0px;\n        width: 4px;\n        height: 8px;\n        border: solid rgba(255, 255, 255, 0.9);\n        border-width: 0 2px 2px 0;\n        transform: rotate(45deg);\n      }\n\n      .tag-checkbox:has(input:checked) {\n        background: rgba(255, 255, 255, 0.12);\n        border-color: rgba(255, 255, 255, 0.3);\n        color: rgba(255, 255, 255, 0.95);\n      }\n\n      /* 保存按钮 */\n      .save-tape-btn {\n        margin: 0 20px 20px;\n        width: calc(100% - 40px);\n        padding: 14px;\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.15),\n          rgba(255, 255, 255, 0.08)\n        );\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 12px;\n        color: rgba(255, 255, 255, 0.95);\n        font-size: 12px;\n        font-weight: 800;\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n        font-family: "Courier New", monospace;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        transition: all 0.3s cubic-bezier(0.34, 1.2, 0.64, 1);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.15);\n      }\n\n      .save-tape-btn:hover {\n        background: linear-gradient(\n          135deg,\n          rgba(255, 255, 255, 0.22),\n          rgba(255, 255, 255, 0.12)\n        );\n        border-color: rgba(255, 255, 255, 0.3);\n        transform: translateY(-2px);\n        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .save-tape-btn:active {\n        transform: translateY(0) scale(0.97);\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3),\n                    inset 0 2px 4px rgba(0, 0, 0, 0.2);\n      }\n\n      /* 响应式 */\n      @media (max-width: 600px) {\n        .live-settings-panel {\n          padding-bottom: 100px;\n        }\n\n        .settings-cassette-box {\n          width: 95%;\n          max-height: 65vh;\n        }\n\n        .cassette-box-lid {\n          padding: 16px;\n        }\n\n        .lid-label {\n          font-size: 11px;\n          letter-spacing: 1.5px;\n        }\n\n        .lid-label svg {\n          width: 16px;\n          height: 16px;\n        }\n\n        .lid-close-btn {\n          width: 28px;\n          height: 28px;\n        }\n\n        .tape-card {\n          padding: 12px;\n        }\n\n        .tape-reel {\n          width: 28px;\n          height: 28px;\n        }\n\n        .reel-center {\n          width: 10px;\n          height: 10px;\n        }\n      }\n    ',document.head.appendChild(n)}(),n.appendChild(e),setTimeout(()=>{e.classList.add("active")},10)},n.openConnectionDialog=function(){if(Ra.isAnimating||Ra.isOpen)return;if(!Ra.settings)return void mn("主播未开启连线功能","info");Ra.isAnimating=!0,Ra.isOpen=!0;const n=document.getElementById("connectionDialog"),e=document.getElementById("connectionDialogOverlay");n&&(n.classList.add("active"),requestAnimationFrame(()=>{n.style.right="20px",n.style.opacity="1"})),e&&e.classList.add("active"),na.isOpen&&Da(),setTimeout(()=>{Ra.isAnimating=!1},500)},n.closeConnectionDialog=Fa,n.confirmConnection=async function(){const t=Ra.settings;if(!t||!t.enabled)return void mn("主播未开启连线功能","error");const o=t.waitingList||[],a=t.maxWaiting||10;if(o.length>=a)return void mn("等待队列已满，请稍后再试","error");if(Ra.hasRequested)return void mn("您已提交申请，请勿重复申请","info");const i=await async function(n){if(!n||"none"===n.type)return{passed:!0};try{const t=e(),o=r.clean(Ko.streamerHandle);switch(n.type){case"points":const e=Ko?.details?.giftLeaderboard?.userTotalPoints||0;return e<n.value?{passed:!1,reason:`需要送礼满${n.value}积分，您当前${e}积分`}:{passed:!0};case"fanLevel":const a=await t.xFanClubMemberships.get(o),i=a?.level||0;return a&&a.joined?i<n.value?{passed:!1,reason:`需要粉丝等级${n.value}级，您当前${i}级`}:{passed:!0}:{passed:!1,reason:`需要加入粉丝团且等级达到${n.value}级`};case"giftRank":const r=Ko?.details?.giftLeaderboard?.userRank||999;return r>n.value?{passed:!1,reason:`需要礼物榜前${n.value}名，您当前第${r}名`}:{passed:!0};case"followDays":const s=await t.xFanClubMemberships.get(o);if(!s||!s.joined)return{passed:!1,reason:`需要关注主播超过${n.value}天`};const l=s.joinDate?new Date(s.joinDate):new Date,c=Math.floor((Date.now()-l.getTime())/864e5);return c<n.value?{passed:!1,reason:`需要关注主播超过${n.value}天，您当前${c}天`}:{passed:!0};default:return console.warn(`⚠️ [连线门槛] 未知门槛类型: ${n.type}`),{passed:!0}}}catch(n){return console.error("❌ [连线门槛] 验证失败:",n),{passed:!1,reason:"门槛验证失败，请稍后再试"}}}(t.threshold);i.passed?(Ra.hasRequested=!0,_a(),mn("连线申请已提交！","success"),setTimeout(()=>{Ra.isOpen&&Fa()},2e3),(async()=>{try{mn("正在为您排队...","info");const e=await oa([],[],"connection");Ra.pendingInteraction=e,console.log("✅ [连线系统] AI反应已生成，开始排队"),function(){const e=Ra.settings,t=e.waitingList?e.waitingList.length:0;Ra.queuePosition=t,console.log(`🚦 [连线排队] 开始排队，当前队列位置: ${Ra.queuePosition}`),mn(`连线申请已提交，前面还有${Ra.queuePosition}人等待`,"success"),Ya(),setTimeout(()=>{Ra.isOpen&&Fa()},2e3);const o=3e3+2e3*Math.random();Ra.queueInterval=setInterval(()=>{Ra.queuePosition>0?(Ra.queuePosition--,console.log(`🚦 [连线排队] 队列前进，当前位置: ${Ra.queuePosition}`),Ra.isOpen&&Ya(),0===Ra.queuePosition?mn("排队轮到您了，即将接通连线！","success"):Ra.queuePosition<=2&&mn(`前面还有${Ra.queuePosition}人`,"info")):(clearInterval(Ra.queueInterval),Ra.queueInterval=null,async function(){console.log("✅ [连线系统] 开始建立连线..."),Ra.isConnected=!0,Ra.connectedAt=Date.now(),function(){const e=Ko?.streamerAvatar||document.getElementById("avatarImg")?.src||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",t=n.userProfileData?.avatar||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",o=document.createElement("div");o.style.cssText="\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%) scale(0.85);\n    z-index: 99999;\n    width: 88%;\n    max-width: 320px;\n    opacity: 0;\n    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n    pointer-events: none;\n    filter: drop-shadow(0 40px 80px rgba(0, 0, 0, 0.9));\n  ",o.innerHTML=`\n    \x3c!-- 黑胶唱片播放器机身 --\x3e\n    <div style="\n      background:\n        radial-gradient(ellipse at 30% 20%, rgba(40, 35, 30, 0.8), transparent 60%),\n        radial-gradient(ellipse at 70% 80%, rgba(30, 30, 35, 0.6), transparent 50%),\n        linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 30%, #0f0f0f 70%, #050505 100%);\n      border: 4px solid transparent;\n      border-image: linear-gradient(135deg,\n        rgba(100, 100, 100, 0.5) 0%,\n        rgba(60, 60, 60, 0.8) 25%,\n        rgba(40, 40, 40, 0.9) 50%,\n        rgba(60, 60, 60, 0.8) 75%,\n        rgba(100, 100, 100, 0.5) 100%) 1;\n      border-radius: 8px;\n      overflow: visible;\n      box-shadow:\n        0 0 0 1px rgba(80, 80, 80, 0.4),\n        0 0 0 6px rgba(20, 20, 20, 0.95),\n        0 0 0 7px rgba(60, 60, 60, 0.3),\n        0 40px 120px rgba(0, 0, 0, 0.95),\n        0 20px 60px rgba(0, 0, 0, 0.9),\n        inset 0 3px 0 rgba(255, 255, 255, 0.06),\n        inset 0 -3px 0 rgba(0, 0, 0, 0.8),\n        inset 0 0 60px rgba(0, 0, 0, 0.5);\n      position: relative;\n      padding: 24px 20px 18px;\n    ">\n      \x3c!-- 扫描线纹理 --\x3e\n      <div style="\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        pointer-events: none;\n        z-index: 100;\n        border-radius: 4px;\n      "></div>\n\n      \x3c!-- 顶部金属条装饰 --\x3e\n      <div style="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 8px;\n        background: linear-gradient(180deg,\n          rgba(70, 70, 70, 0.5) 0%,\n          rgba(50, 50, 50, 0.6) 50%,\n          rgba(30, 30, 30, 0.7) 100%);\n        border-bottom: 1px solid rgba(90, 90, 90, 0.4);\n        box-shadow: inset 0 1px 0 rgba(110, 110, 110, 0.2);\n        border-radius: 4px 4px 0 0;\n      "></div>\n\n      \x3c!-- 唱片转盘区域（主播头像） --\x3e\n      <div style="\n        width: 160px;\n        height: 160px;\n        margin: 0 auto 18px;\n        position: relative;\n        filter: drop-shadow(0 12px 28px rgba(0, 0, 0, 0.9));\n      ">\n        \x3c!-- 唱片底座 - 金属台面 --\x3e\n        <div style="\n          position: absolute;\n          inset: -4px;\n          border-radius: 50%;\n          background:\n            radial-gradient(circle at 35% 30%, rgba(90, 90, 90, 0.6), transparent 45%),\n            radial-gradient(circle at 65% 70%, rgba(50, 50, 50, 0.5), transparent 40%),\n            radial-gradient(circle at 50% 50%, rgba(70, 70, 70, 0.5) 0%, rgba(40, 40, 40, 0.8) 50%, rgba(20, 20, 20, 0.95) 100%);\n          box-shadow:\n            0 0 0 3px rgba(60, 60, 60, 0.7),\n            0 0 0 4px rgba(30, 30, 30, 0.9),\n            0 12px 35px rgba(0, 0, 0, 0.95),\n            inset 0 3px 8px rgba(0, 0, 0, 0.8),\n            inset 0 -2px 6px rgba(100, 100, 100, 0.15);\n        "></div>\n\n        \x3c!-- 旋转的黑胶唱片（主播头像） --\x3e\n        <div style="\n          position: absolute;\n          inset: 6px;\n          border-radius: 50%;\n          background: #000;\n          overflow: visible;\n          animation: vinylSpin 8s linear infinite;\n          box-shadow:\n            0 0 0 2px rgba(20, 20, 20, 0.95),\n            0 0 0 3px rgba(60, 60, 60, 0.4),\n            0 8px 20px rgba(0, 0, 0, 0.9),\n            inset 0 0 0 2px rgba(40, 40, 40, 0.9),\n            inset 0 4px 12px rgba(0, 0, 0, 0.95),\n            inset 0 -2px 8px rgba(255, 255, 255, 0.03);\n        ">\n          \x3c!-- 黑胶光泽层 - 旋转光影效果 --\x3e\n          <div style="\n            position: absolute;\n            inset: 0;\n            border-radius: 50%;\n            background: conic-gradient(\n              from 0deg,\n              transparent 0deg,\n              rgba(255, 255, 255, 0.08) 30deg,\n              rgba(255, 255, 255, 0.15) 45deg,\n              rgba(255, 255, 255, 0.08) 60deg,\n              transparent 90deg,\n              transparent 270deg,\n              rgba(255, 255, 255, 0.05) 300deg,\n              rgba(255, 255, 255, 0.1) 315deg,\n              rgba(255, 255, 255, 0.05) 330deg,\n              transparent 360deg\n            );\n            animation: glossSpin 8s linear infinite;\n            pointer-events: none;\n          "></div>\n\n          \x3c!-- 唱片边缘厚度 --\x3e\n          <div style="\n            position: absolute;\n            inset: -1px;\n            border-radius: 50%;\n            border: 2px solid transparent;\n            border-top-color: rgba(80, 80, 80, 0.4);\n            border-right-color: rgba(60, 60, 60, 0.3);\n            border-bottom-color: rgba(20, 20, 20, 0.8);\n            border-left-color: rgba(40, 40, 40, 0.5);\n            box-shadow:\n              inset 0 2px 4px rgba(255, 255, 255, 0.05),\n              inset 0 -2px 4px rgba(0, 0, 0, 0.7);\n            animation: edgeGlow 4s ease-in-out infinite;\n          "></div>\n          \x3c!-- 主播头像层 --\x3e\n          <div style="\n            position: absolute;\n            inset: 20px;\n            border-radius: 50%;\n            overflow: hidden;\n            background: #000;\n            border: 2px solid rgba(80, 80, 80, 0.6);\n            box-shadow: 0 0 0 8px rgba(20, 20, 20, 0.8);\n          ">\n            <img src="${e}" style="\n              width: 100%;\n              height: 100%;\n              object-fit: cover;\n              animation: counterSpin 8s linear infinite;\n            " onerror="this.src='https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg'">\n          </div>\n\n          \x3c!-- 唱片纹理沟槽 --\x3e\n          <div style="\n            position: absolute;\n            inset: 0;\n            border-radius: 50%;\n            background: repeating-radial-gradient(\n              circle,\n              transparent 0px,\n              transparent 6px,\n              rgba(50, 50, 50, 0.3) 6px,\n              rgba(50, 50, 50, 0.3) 7px\n            );\n            pointer-events: none;\n          "></div>\n        </div>\n\n        \x3c!-- 中心唱片标签（红色） --\x3e\n        <div style="\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          width: 58px;\n          height: 58px;\n          border-radius: 50%;\n          background:\n            radial-gradient(circle at 40% 35%, rgba(180, 60, 60, 0.9), transparent 30%),\n            radial-gradient(circle at 60% 65%, rgba(120, 30, 30, 0.7), transparent 35%),\n            radial-gradient(circle at 50% 50%, rgba(160, 45, 45, 0.95) 0%, rgba(130, 35, 35, 1) 50%, rgba(100, 25, 25, 1) 100%);\n          box-shadow:\n            0 0 0 2px rgba(80, 20, 20, 0.9),\n            0 0 30px rgba(180, 50, 50, 0.6),\n            0 0 50px rgba(180, 50, 50, 0.3),\n            0 4px 15px rgba(0, 0, 0, 0.8),\n            inset 0 3px 8px rgba(0, 0, 0, 0.7),\n            inset 0 -2px 4px rgba(220, 80, 80, 0.4);\n          z-index: 10;\n        ">\n          \x3c!-- 标签光晕 --\x3e\n          <div style="\n            position: absolute;\n            inset: -3px;\n            border-radius: 50%;\n            background: radial-gradient(circle, rgba(200, 60, 60, 0.4) 0%, transparent 70%);\n            animation: labelGlow 2.5s ease-in-out infinite;\n            pointer-events: none;\n          "></div>\n\n          \x3c!-- 标签文字 --\x3e\n          <div style="\n            position: absolute;\n            inset: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-family: 'Courier New', monospace;\n            font-size: 9px;\n            font-weight: 900;\n            color: rgba(255, 255, 255, 0.95);\n            letter-spacing: 1.8px;\n            text-shadow:\n              0 0 8px rgba(255, 255, 255, 0.6),\n              0 2px 4px rgba(0, 0, 0, 0.8);\n            animation: vinylSpin 8s linear infinite;\n          ">LIVE</div>\n        </div>\n\n        \x3c!-- 唱臂（从右上角伸入） --\x3e\n        <div style="\n          position: absolute;\n          top: 5px;\n          right: -40px;\n          width: 120px;\n          height: 120px;\n          transform-origin: right top;\n          filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.8));\n        ">\n          \x3c!-- 唱臂主体 - 金属臂杆 --\x3e\n          <div style="\n            position: absolute;\n            top: 0;\n            right: 0;\n            width: 92px;\n            height: 5px;\n            background:\n              linear-gradient(180deg,\n                rgba(130, 130, 130, 0.9) 0%,\n                rgba(100, 100, 100, 1) 20%,\n                rgba(70, 70, 70, 1) 50%,\n                rgba(90, 90, 90, 0.95) 80%,\n                rgba(110, 110, 110, 0.8) 100%);\n            border-radius: 2.5px;\n            box-shadow:\n              0 0 0 1px rgba(50, 50, 50, 0.9),\n              0 3px 8px rgba(0, 0, 0, 0.8),\n              0 1px 3px rgba(0, 0, 0, 0.9),\n              inset 0 2px 0 rgba(160, 160, 160, 0.4),\n              inset 0 -1px 0 rgba(30, 30, 30, 0.7);\n            transform: rotate(-35deg);\n            transform-origin: right center;\n          ">\n            \x3c!-- 金属光泽 --\x3e\n            <div style="\n              position: absolute;\n              inset: 1px;\n              background: linear-gradient(90deg,\n                transparent 0%,\n                rgba(255, 255, 255, 0.15) 20%,\n                rgba(255, 255, 255, 0.25) 40%,\n                rgba(255, 255, 255, 0.15) 60%,\n                transparent 80%);\n              border-radius: 1.5px;\n              pointer-events: none;\n            "></div>\n          </div>\n\n          \x3c!-- 唱臂关节（用户头像） --\x3e\n          <div style="\n            position: absolute;\n            top: -18px;\n            right: -4px;\n            width: 44px;\n            height: 44px;\n            border-radius: 50%;\n            background:\n              radial-gradient(circle at 35% 30%, rgba(110, 110, 110, 0.8), transparent 50%),\n              radial-gradient(circle at 50% 50%, rgba(90, 90, 90, 0.9) 0%, rgba(60, 60, 60, 1) 60%, rgba(40, 40, 40, 1) 100%);\n            padding: 3.5px;\n            box-shadow:\n              0 0 0 3px rgba(70, 70, 70, 0.9),\n              0 0 0 4px rgba(40, 40, 40, 0.95),\n              0 0 20px rgba(200, 200, 200, 0.2),\n              0 6px 18px rgba(0, 0, 0, 0.9),\n              inset 0 2px 4px rgba(140, 140, 140, 0.4),\n              inset 0 -2px 4px rgba(20, 20, 20, 0.8);\n            z-index: 5;\n            animation: jointGlow 3s ease-in-out infinite;\n          ">\n            \x3c!-- 关节发光环 --\x3e\n            <div style="\n              position: absolute;\n              inset: -2px;\n              border-radius: 50%;\n              background: radial-gradient(circle, transparent 60%, rgba(255, 255, 255, 0.15) 70%, transparent 80%);\n              animation: jointRing 3s ease-in-out infinite;\n              pointer-events: none;\n            "></div>\n\n            \x3c!-- 用户头像 --\x3e\n            <div style="\n              width: 100%;\n              height: 100%;\n              border-radius: 50%;\n              overflow: hidden;\n              background: #000;\n              box-shadow:\n                inset 0 3px 6px rgba(0, 0, 0, 0.9),\n                inset 0 0 0 1px rgba(80, 80, 80, 0.5);\n            ">\n              <img src="${t}" style="\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n              " onerror="this.src='https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg'">\n            </div>\n          </div>\n\n          \x3c!-- 唱针头 - 钻石针 --\x3e\n          <div style="\n            position: absolute;\n            top: 1.5px;\n            left: -2px;\n            width: 16px;\n            height: 3px;\n            background:\n              linear-gradient(90deg,\n                rgba(200, 200, 200, 0.95) 0%,\n                rgba(220, 220, 220, 1) 30%,\n                rgba(180, 180, 180, 0.9) 70%,\n                rgba(150, 150, 150, 0.8) 100%);\n            border-radius: 0 1.5px 1.5px 0;\n            transform: rotate(-35deg);\n            transform-origin: right center;\n            box-shadow:\n              0 0 6px rgba(255, 255, 255, 0.4),\n              0 2px 4px rgba(0, 0, 0, 0.7),\n              inset 0 1px 0 rgba(255, 255, 255, 0.6);\n          ">\n            \x3c!-- 针尖发光 --\x3e\n            <div style="\n              position: absolute;\n              left: 0;\n              top: 50%;\n              width: 4px;\n              height: 4px;\n              margin-top: -2px;\n              margin-left: -2px;\n              border-radius: 50%;\n              background: rgba(255, 255, 255, 0.9);\n              box-shadow:\n                0 0 8px rgba(255, 255, 255, 0.8),\n                0 0 12px rgba(255, 255, 255, 0.4);\n              animation: needleGlow 2s ease-in-out infinite;\n            "></div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 连接状态文字 --\x3e\n      <div style="\n        text-align: center;\n        margin-bottom: 18px;\n      ">\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 19px;\n          font-weight: 900;\n          color: rgba(255, 255, 255, 0.95);\n          letter-spacing: 5px;\n          text-transform: uppercase;\n          margin-bottom: 6px;\n          text-shadow:\n            0 0 25px rgba(255, 255, 255, 0.2),\n            0 2px 5px rgba(0, 0, 0, 0.7);\n        ">ON AIR</div>\n        <div style="\n          font-family: 'Courier New', monospace;\n          font-size: 11px;\n          font-weight: 600;\n          color: rgba(200, 200, 200, 0.75);\n          letter-spacing: 1.2px;\n        ">语音连线已建立</div>\n      </div>\n\n      \x3c!-- 底部控制面板 --\x3e\n      <div style="\n        background:\n          linear-gradient(90deg, rgba(40, 40, 40, 0.6) 0%, rgba(30, 30, 30, 0.8) 50%, rgba(40, 40, 40, 0.6) 100%),\n          linear-gradient(180deg, rgba(38, 38, 38, 0.75), rgba(22, 22, 22, 0.9));\n        border: 2px solid transparent;\n        border-image: linear-gradient(90deg,\n          rgba(80, 80, 80, 0.3) 0%,\n          rgba(100, 100, 100, 0.5) 50%,\n          rgba(80, 80, 80, 0.3) 100%) 1;\n        border-radius: 5px;\n        padding: 14px 18px;\n        box-shadow:\n          0 0 0 1px rgba(60, 60, 60, 0.5),\n          inset 0 2px 0 rgba(120, 120, 120, 0.18),\n          inset 0 -2px 0 rgba(0, 0, 0, 0.6),\n          0 4px 15px rgba(0, 0, 0, 0.7),\n          inset 0 0 30px rgba(0, 0, 0, 0.4);\n        position: relative;\n      ">\n        \x3c!-- 面板内发光装饰线 --\x3e\n        <div style="\n          position: absolute;\n          top: 3px;\n          left: 18px;\n          right: 18px;\n          height: 1px;\n          background: linear-gradient(90deg,\n            transparent 0%,\n            rgba(255, 255, 255, 0.15) 50%,\n            transparent 100%);\n          pointer-events: none;\n        "></div>\n\n        <div style="\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n        ">\n          \x3c!-- 左侧：录制指示 --\x3e\n          <div style="display: flex; align-items: center; gap: 12px;">\n            <div style="\n              width: 10px;\n              height: 10px;\n              background:\n                radial-gradient(circle at 35% 35%, rgba(220, 60, 60, 1), rgba(180, 45, 45, 0.95));\n              border-radius: 50%;\n              box-shadow:\n                0 0 0 2px rgba(100, 25, 25, 0.8),\n                0 0 25px rgba(200, 55, 55, 0.9),\n                0 0 40px rgba(200, 55, 55, 0.5),\n                inset 0 1px 2px rgba(255, 255, 255, 0.2),\n                inset 0 -1px 2px rgba(100, 20, 20, 0.8);\n              animation: recBlink 1.4s ease-in-out infinite;\n              position: relative;\n            ">\n              \x3c!-- 录制光晕 --\x3e\n              <div style="\n                position: absolute;\n                inset: -4px;\n                border-radius: 50%;\n                background: radial-gradient(circle, rgba(220, 60, 60, 0.4) 0%, transparent 70%);\n                animation: recGlow 1.4s ease-in-out infinite;\n                pointer-events: none;\n              "></div>\n            </div>\n            <span style="\n              font-family: 'Courier New', monospace;\n              font-size: 10px;\n              font-weight: 900;\n              color: rgba(230, 230, 230, 0.8);\n              letter-spacing: 2px;\n              text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);\n            ">RECORDING</span>\n          </div>\n\n          \x3c!-- 右侧：音量表 --\x3e\n          <div style="\n            display: flex;\n            gap: 3.5px;\n            align-items: flex-end;\n            padding: 0 6px;\n          ">\n            <div style="\n              width: 4px;\n              min-height: 8px;\n              background: linear-gradient(180deg,\n                rgba(220, 220, 220, 0.75) 0%,\n                rgba(180, 180, 180, 0.65) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 4px rgba(255, 255, 255, 0.3),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.4);\n              animation: volumeBar1 1s ease-in-out infinite;\n            "></div>\n            <div style="\n              width: 4px;\n              min-height: 12px;\n              background: linear-gradient(180deg,\n                rgba(240, 240, 240, 0.85) 0%,\n                rgba(200, 200, 200, 0.75) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 6px rgba(255, 255, 255, 0.4),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.5);\n              animation: volumeBar2 1s ease-in-out infinite 0.12s;\n            "></div>\n            <div style="\n              width: 4px;\n              min-height: 10px;\n              background: linear-gradient(180deg,\n                rgba(230, 230, 230, 0.8) 0%,\n                rgba(190, 190, 190, 0.7) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 5px rgba(255, 255, 255, 0.35),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.45);\n              animation: volumeBar3 1s ease-in-out infinite 0.24s;\n            "></div>\n            <div style="\n              width: 4px;\n              min-height: 14px;\n              background: linear-gradient(180deg,\n                rgba(250, 250, 250, 0.9) 0%,\n                rgba(210, 210, 210, 0.8) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 8px rgba(255, 255, 255, 0.5),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.6);\n              animation: volumeBar4 1s ease-in-out infinite 0.36s;\n            "></div>\n            <div style="\n              width: 4px;\n              min-height: 9px;\n              background: linear-gradient(180deg,\n                rgba(225, 225, 225, 0.78) 0%,\n                rgba(185, 185, 185, 0.68) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 5px rgba(255, 255, 255, 0.35),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.45);\n              animation: volumeBar1 1s ease-in-out infinite 0.48s;\n            "></div>\n            <div style="\n              width: 4px;\n              min-height: 11px;\n              background: linear-gradient(180deg,\n                rgba(235, 235, 235, 0.82) 0%,\n                rgba(195, 195, 195, 0.72) 100%);\n              border-radius: 2px;\n              box-shadow:\n                0 0 6px rgba(255, 255, 255, 0.38),\n                0 2px 4px rgba(0, 0, 0, 0.6),\n                inset 0 1px 0 rgba(255, 255, 255, 0.48);\n              animation: volumeBar2 1s ease-in-out infinite 0.6s;\n            "></div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 四角螺丝装饰 --\x3e\n      <div style="position: absolute; width: 11px; height: 11px; top: 10px; left: 10px; border-radius: 50%; background: radial-gradient(circle at 38% 38%, rgba(130, 130, 130, 0.65), rgba(55, 55, 55, 0.85)); border: 1.5px solid rgba(90, 90, 90, 0.6); box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.75), 0 1px 0 rgba(130, 130, 130, 0.25);"></div>\n      <div style="position: absolute; width: 11px; height: 11px; top: 10px; right: 10px; border-radius: 50%; background: radial-gradient(circle at 38% 38%, rgba(130, 130, 130, 0.65), rgba(55, 55, 55, 0.85)); border: 1.5px solid rgba(90, 90, 90, 0.6); box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.75), 0 1px 0 rgba(130, 130, 130, 0.25);"></div>\n      <div style="position: absolute; width: 11px; height: 11px; bottom: 10px; left: 10px; border-radius: 50%; background: radial-gradient(circle at 38% 38%, rgba(130, 130, 130, 0.65), rgba(55, 55, 55, 0.85)); border: 1.5px solid rgba(90, 90, 90, 0.6); box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.75), 0 1px 0 rgba(130, 130, 130, 0.25);"></div>\n      <div style="position: absolute; width: 11px; height: 11px; bottom: 10px; right: 10px; border-radius: 50%; background: radial-gradient(circle at 38% 38%, rgba(130, 130, 130, 0.65), rgba(55, 55, 55, 0.85)); border: 1.5px solid rgba(90, 90, 90, 0.6); box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.75), 0 1px 0 rgba(130, 130, 130, 0.25);"></div>\n    </div>\n\n    \x3c!-- CSS动画 --\x3e\n    <style>\n      /* 唱片旋转 */\n      @keyframes vinylSpin {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n\n      /* 头像反向旋转 */\n      @keyframes counterSpin {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(-360deg); }\n      }\n\n      /* 光泽旋转 */\n      @keyframes glossSpin {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n\n      /* 边缘发光 */\n      @keyframes edgeGlow {\n        0%, 100% {\n          opacity: 0.8;\n          box-shadow:\n            inset 0 2px 4px rgba(255, 255, 255, 0.05),\n            inset 0 -2px 4px rgba(0, 0, 0, 0.7);\n        }\n        50% {\n          opacity: 1;\n          box-shadow:\n            inset 0 2px 4px rgba(255, 255, 255, 0.08),\n            inset 0 -2px 4px rgba(0, 0, 0, 0.7);\n        }\n      }\n\n      /* 标签光晕 */\n      @keyframes labelGlow {\n        0%, 100% {\n          opacity: 0.6;\n          transform: scale(1);\n        }\n        50% {\n          opacity: 1;\n          transform: scale(1.15);\n        }\n      }\n\n      /* 关节发光 */\n      @keyframes jointGlow {\n        0%, 100% {\n          box-shadow:\n            0 0 0 3px rgba(70, 70, 70, 0.9),\n            0 0 0 4px rgba(40, 40, 40, 0.95),\n            0 0 20px rgba(200, 200, 200, 0.2),\n            0 6px 18px rgba(0, 0, 0, 0.9),\n            inset 0 2px 4px rgba(140, 140, 140, 0.4),\n            inset 0 -2px 4px rgba(20, 20, 20, 0.8);\n        }\n        50% {\n          box-shadow:\n            0 0 0 3px rgba(80, 80, 80, 0.95),\n            0 0 0 4px rgba(50, 50, 50, 0.98),\n            0 0 25px rgba(220, 220, 220, 0.3),\n            0 6px 18px rgba(0, 0, 0, 0.9),\n            inset 0 2px 4px rgba(160, 160, 160, 0.5),\n            inset 0 -2px 4px rgba(20, 20, 20, 0.8);\n        }\n      }\n\n      /* 关节光环 */\n      @keyframes jointRing {\n        0%, 100% {\n          opacity: 0.7;\n          transform: scale(1);\n        }\n        50% {\n          opacity: 1;\n          transform: scale(1.1);\n        }\n      }\n\n      /* 针尖发光 */\n      @keyframes needleGlow {\n        0%, 100% {\n          opacity: 0.8;\n          box-shadow:\n            0 0 8px rgba(255, 255, 255, 0.8),\n            0 0 12px rgba(255, 255, 255, 0.4);\n        }\n        50% {\n          opacity: 1;\n          box-shadow:\n            0 0 12px rgba(255, 255, 255, 1),\n            0 0 18px rgba(255, 255, 255, 0.6);\n        }\n      }\n\n      /* 录制闪烁 */\n      @keyframes recBlink {\n        0%, 100% {\n          opacity: 1;\n          box-shadow:\n            0 0 0 2px rgba(100, 25, 25, 0.8),\n            0 0 25px rgba(200, 55, 55, 0.9),\n            0 0 40px rgba(200, 55, 55, 0.5),\n            inset 0 1px 2px rgba(255, 255, 255, 0.2),\n            inset 0 -1px 2px rgba(100, 20, 20, 0.8);\n        }\n        50% {\n          opacity: 0.5;\n          box-shadow:\n            0 0 0 2px rgba(80, 20, 20, 0.7),\n            0 0 15px rgba(180, 45, 45, 0.6),\n            0 0 25px rgba(180, 45, 45, 0.3),\n            inset 0 1px 2px rgba(255, 255, 255, 0.1),\n            inset 0 -1px 2px rgba(80, 15, 15, 0.7);\n        }\n      }\n\n      /* 录制光晕 */\n      @keyframes recGlow {\n        0%, 100% {\n          opacity: 0.6;\n          transform: scale(1);\n        }\n        50% {\n          opacity: 1;\n          transform: scale(1.3);\n        }\n      }\n\n      /* 音量条动画 */\n      @keyframes volumeBar1 {\n        0%, 100% {\n          height: 8px;\n          opacity: 0.75;\n          box-shadow:\n            0 0 4px rgba(255, 255, 255, 0.3),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.4);\n        }\n        50% {\n          height: 15px;\n          opacity: 0.95;\n          box-shadow:\n            0 0 8px rgba(255, 255, 255, 0.5),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.6);\n        }\n      }\n\n      @keyframes volumeBar2 {\n        0%, 100% {\n          height: 12px;\n          opacity: 0.85;\n          box-shadow:\n            0 0 6px rgba(255, 255, 255, 0.4),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.5);\n        }\n        50% {\n          height: 19px;\n          opacity: 1;\n          box-shadow:\n            0 0 10px rgba(255, 255, 255, 0.6),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.7);\n        }\n      }\n\n      @keyframes volumeBar3 {\n        0%, 100% {\n          height: 10px;\n          opacity: 0.8;\n          box-shadow:\n            0 0 5px rgba(255, 255, 255, 0.35),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.45);\n        }\n        50% {\n          height: 17px;\n          opacity: 0.98;\n          box-shadow:\n            0 0 9px rgba(255, 255, 255, 0.55),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.65);\n        }\n      }\n\n      @keyframes volumeBar4 {\n        0%, 100% {\n          height: 14px;\n          opacity: 0.9;\n          box-shadow:\n            0 0 8px rgba(255, 255, 255, 0.5),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.6);\n        }\n        50% {\n          height: 21px;\n          opacity: 1;\n          box-shadow:\n            0 0 12px rgba(255, 255, 255, 0.7),\n            0 2px 4px rgba(0, 0, 0, 0.6),\n            inset 0 1px 0 rgba(255, 255, 255, 0.8);\n        }\n      }\n    </style>\n  `,document.body.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1",o.style.transform="translate(-50%, -50%) scale(1)"}),setTimeout(()=>{o.style.opacity="0",o.style.transform="translate(-50%, -50%) scale(0.92)",setTimeout(()=>o.remove(),500)},3e3)}(),Ra.pendingInteraction&&(console.log("🎬 [连线系统] 播放保存的AI反应"),function(n){if(!n)return;qa(n)}(Ra.pendingInteraction));Va(),Ga()}())},o)}()}catch(n){console.error("❌ [连线系统] AI生成失败:",n),mn("连线系统繁忙，请稍后再试","error"),Ra.hasRequested=!1,_a()}})()):mn(i.reason,"error")},n.openConnectionManagementDialog=function(){if(Ra.isAnimating||Ra.managementOpen||!Ra.isConnected)return;Ra.isAnimating=!0,Ra.managementOpen=!0;const n=document.getElementById("managementDialog"),e=document.getElementById("managementDialogOverlay");n&&(n.classList.add("active"),requestAnimationFrame(()=>{n.style.right="20px",n.style.opacity="1"})),e&&e.classList.add("active"),Ra.isOpen&&Fa(),na.isOpen&&Da(),function(){Ra.durationTimer&&clearInterval(Ra.durationTimer);Ka(),Ra.durationTimer=setInterval(()=>{Ka()},1e3),console.log("⏱️ [连线管理] 时长计时器已启动")}(),setTimeout(()=>{Ra.isAnimating=!1},500),console.log("✅ [连线管理] 管理弹窗已打开")},n.closeConnectionManagementDialog=Wa,n.endConnection=Qa,n.openPKConfigDialog=function(){if(console.log("🎮 [PK系统] 打开PK配置弹窗"),!Ra.isConnected)return mn("请先开始语音连线，才能发起PK挑战","error"),void console.error("❌ [PK系统] 未连线，无法打开PK配置弹窗");if(Ha.isActive)return mn("PK正在进行中，请等待当前PK结束","error"),void console.error("❌ [PK系统] PK正在进行中，无法再次发起");if(Ha.isPreparing)return mn("PK正在准备中，请稍候...","error"),void console.error("❌ [PK系统] PK正在准备中，无法重复发起");Ra.managementOpen&&Wa();const e=bi();let t;t=e<50?Math.floor(21*Math.random())+10:e<200?Math.floor(31*Math.random())+20:e<500?Math.floor(51*Math.random())+30:Math.floor(101*Math.random())+50,console.log(`💰 [PK系统] 用户当前积分: ${e}P，PK费用: ${t}P`);const o=["今日特价！机不可失哦^^","限时优惠价格！下次可能涨价^^","已为您申请最低价^^（真的吗）","这价格我都亏本了^^（才怪）","您的专属VIP价格^^","感谢惠顾！多多光临^^","此价格仅限今日有效^^","老板说了算便宜点^^（老板是我）","成本价出售！血亏^^（骗你的）","买到就是赚到^^（可能吧）"],a=o[Math.floor(Math.random()*o.length)],i=document.getElementById("pkCostDisplay"),r=document.getElementById("pkVendorMessage");i&&(i.textContent=`${t} 积分`),r&&(r.textContent=a),n.currentPKCost=t;const s=document.getElementById("pkConfigDialog"),l=document.getElementById("pkConfigDialogOverlay");s&&(s.classList.add("active"),requestAnimationFrame(()=>{s.style.right="20px",s.style.opacity="1"})),l&&l.classList.add("active"),console.log(`✅ [PK系统] PK配置弹窗已打开，费用: ${t} 积分`)},n.closePKConfigDialog=Za,n.confirmPKChallenge=function(){if(console.log("🎮 [PK系统] 确认PK挑战"),!Ra.isConnected)return mn("请先开始语音连线，才能发起PK挑战","error"),void console.error("❌ [PK系统] PK必须在语音连线状态下进行");const e=parseInt(document.getElementById("pkTimeLimitInput")?.value||"5"),t=document.getElementById("pkStreamerPenaltyInput")?.value.trim()||"",o=document.getElementById("pkUserPenaltyInput")?.value.trim()||"",a=document.getElementById("pkChallengeMessageInput")?.value.trim()||"";if(!t)return void mn("请填写主播惩罚","error");if(!o)return void mn("请填写您的惩罚","error");const i=n.currentPKCost||0,r=bi();console.log(`💰 [PK系统] 当前积分: ${r}P，PK费用: ${i}P`),r<i?mn(`积分不足！需要 ${i} 积分，当前仅有 ${r} 积分`,"error"):yi(i)?(console.log(`✅ [PK系统] 成功扣除 ${i} 积分，剩余 ${bi()} 积分`),n.currentPKConfig={timeLimit:e,streamerPenalty:t,userPenalty:o,challengeMessage:a,cost:i,startTime:null},console.log("✅ [PK系统] PK配置已保存:",n.currentPKConfig),Rl({title:"积分扣除",message:`已扣除 ${i} 积分`,leftIcon:"x",duration:2500}),Za(),function(){console.log("🎮 [PK系统] 显示PK准备中弹窗");const e=document.getElementById("pkPreparingModal");if(!e)return;Ha.isPreparing=!0,Ha.preparingProgress=0,Ha.scenario14Data=null,Ha.config=n.currentPKConfig;const t=Ko?.streamerAvatar||document.getElementById("avatarImg")?.src||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",o=n.userProfileData?.avatar||"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",a=document.getElementById("pkStreamerAvatar"),i=document.getElementById("pkUserAvatar");a&&(a.src=t);i&&(i.src=o);e.classList.add("active"),setTimeout(()=>{!async function(){console.log("⚔️ [PK系统] 触发PK开始，调用第14情景...");try{const n=await oa([],[],"pkStart");Ha.scenario14Data=n,console.log("✅ [PK系统] 第14情景生成完成:",n)}catch(n){console.error("❌ [PK系统] 第14情景生成失败:",n),Ha.scenario14Data={streamerMessages:[{content:"来战！",time:"刚刚"}],danmaku:[{userName:"观众1",content:"PK开始了！",time:"刚刚"}],pkScores:{streamer:Math.floor(500*Math.random())+300,user:Math.floor(500*Math.random())+300}}}}(),function(){const n=document.getElementById("pkProgressText"),e=document.querySelectorAll(".pk-energy-pixel");let t=0;console.log("🐌 [PK系统] 开始慢速进度（等待AI生成）"),Ha.preparingInterval=setInterval(()=>{if(Ha.scenario14Data)return console.log("🚀 [PK系统] 第14情景生成完毕，切换到快速进度"),clearInterval(Ha.preparingInterval),void function(n,e){const t=document.getElementById("pkProgressText"),o=document.querySelectorAll(".pk-energy-pixel"),a=document.getElementById("pkPreparingModal");let i=e;console.log("⚡ [PK系统] 开始快速进度"),Ha.preparingInterval=setInterval(()=>{Ha.preparingProgress+=12*Math.random()+8,Ha.preparingProgress>100&&(Ha.preparingProgress=100),t&&(t.textContent=`${Math.floor(Ha.preparingProgress)}%`);const n=Math.floor(Ha.preparingProgress/100*o.length);for(;i<n&&i<o.length;)o[i].classList.add("filled"),i++;Ha.preparingProgress>=100&&(clearInterval(Ha.preparingInterval),setTimeout(()=>{a&&a.classList.remove("active"),o.forEach(n=>n.classList.remove("filled")),t&&(t.textContent="0%"),Ha.isPreparing=!1,console.log("✅ [PK系统] PK准备完成，开始PK对战！"),function(){console.log("⚔️ [PK系统] 开始PK对战！"),Ha.isActive=!0,Ha.startTime=Date.now(),Ha.endTime=Date.now()+60*Ha.config.timeLimit*1e3;const n=Ha.scenario14Data?.pkScores||{streamer:500,user:500};Ha.streamerScore=0,Ha.userScore=0,function(){console.log("✅ [PK系统] 启动PK嵌入式UI...");const n=document.querySelector(".cassette-body"),e=document.querySelector(".progress-section");if(e){const n=e.querySelector(".progress-bar");n&&n.classList.add("pk-hidden");let t=document.getElementById("pkScoreBar");t||(t=document.createElement("div"),t.id="pkScoreBar",t.className="pk-score-bar",t.innerHTML='\n        <div class="pk-score-fill pk-score-fill-streamer" id="pkScoreFillStreamer" style="width: 50%;"></div>\n        <div class="pk-score-fill pk-score-fill-user" id="pkScoreFillUser" style="width: 50%;"></div>\n        <div class="pk-score-center"></div>\n      ',e.querySelector(".progress-bar").parentNode.insertBefore(t,e.querySelector(".progress-bar"))),t.style.animation="pkBarReplace 0.4s ease-out"}if(n){let e=document.getElementById("pkReelScoreStreamer");e||(e=document.createElement("div"),e.id="pkReelScoreStreamer",e.className="pk-reel-score streamer",e.innerHTML='\n        <div class="pk-score-display">\n          <div class="pk-score-number" id="pkStreamerScoreDisplay">0</div>\n        </div>\n      ',n.appendChild(e)),e.classList.add("active");let t=document.getElementById("pkReelScoreUser");t||(t=document.createElement("div"),t.id="pkReelScoreUser",t.className="pk-reel-score user",t.innerHTML='\n        <div class="pk-score-display">\n          <div class="pk-score-number" id="pkUserScoreDisplay">0</div>\n        </div>\n      ',n.appendChild(t)),t.classList.add("active")}const t=document.querySelector(".header-title");if(t){t.style.opacity="0";let n=document.getElementById("pkTimerReplacement");n||(n=document.createElement("div"),n.id="pkTimerReplacement",n.className="pk-timer-replacement",n.textContent="00:00",t.parentNode.style.position="relative",t.parentNode.appendChild(n)),n.classList.add("active")}Ha.progressBarVisible=!0,console.log("✅ [PK系统] PK嵌入式UI已激活")}(),Ha.scenario14Data&&qa(Ha.scenario14Data).catch(n=>{console.error("❌ [PK系统] 播放第14情景内容失败:",n)});setTimeout(()=>{ei(0,n.streamer,0,n.user,!0),console.log("⏱️ [PK系统] 启动倒计时"),Ha.countdownTimer=setInterval(()=>{const n=Ha.endTime-Date.now();if(n<=0)return void async function(){console.log("🏁 [PK系统] PK对战结束"),Ha.countdownTimer&&(clearInterval(Ha.countdownTimer),Ha.countdownTimer=null);let n="draw";Ha.userScore>Ha.streamerScore?n="victory":Ha.streamerScore>Ha.userScore&&(n="defeat"),console.log(`🏆 [PK系统] 结果: ${n}`),console.log(`📊 [PK系统] 主播积分: ${Ha.streamerScore}, 用户积分: ${Ha.userScore}`);let e=null;!function(n){if(!Ha.preGeneratedEndContent||!Ha.preGeneratedResult)return console.log("⚠️ [PK结束] 无预生成内容"),!1;const e=Ha.preGeneratedResult;return e===n?(console.log(`✅ [PK结束] 预判完全正确：${e} === ${n}`),!0):"closeMatch"===e||"victoryClose"===e||"defeatClose"===e?(console.log(`✅ [PK结束] 使用通用"激烈对决"内容，适配实际结果：${n}`),!0):"victoryClose"===e&&"victory"===n||"defeatClose"===e&&"defeat"===n?(console.log(`✅ [PK结束] 预判方向正确，${e} → ${n}`),!0):(console.log(`❌ [PK结束] 预判失败：预判${e}，实际${n}，需重新生成`),!1)}(n)?(console.log("🔄 [PK结束] 预生成内容不可用，在弹窗期间生成新内容"),async function(n){if(Ha.endContentGenerating&&Ha.endContentPromise){if(console.log("⏳ [PK结束] 检测到预生成正在进行，等待完成..."),await Ha.endContentPromise,Ha.preGeneratedEndContent&&!Ha.endContentError)return void console.log("✅ [PK结束] 预生成成功，无需重新生成");Ha.endContentError&&console.log("⚠️ [PK结束] 预生成失败，静默重试...")}Ha.endContentGenerating=!0,Ha.endContentError=!1,Ha.endContentPromise=(async()=>{try{const e=Ha.endContentError;let t;console.log(`🔄 [PK结束] ${e?"重试":"开始异步"}生成${n}内容...`),t="victory"===n?"pkVictory":"defeat"===n?"pkDefeat":"pkDraw";const o=await oa([],[],t);return o?(Ha.preGeneratedEndContent=o,console.log("✅ [PK结束] 异步生成完成，内容已缓存"),console.log(`📦 [PK结束] 内容包含: ${o.streamerMessages?.length||0}条主播发言, ${o.danmaku?.length||0}条弹幕`)):(console.warn("⚠️ [PK结束] AI返回空内容"),Ha.endContentError=!0),o}catch(n){return console.error("❌ [PK结束] 生成失败:",n),Ha.endContentError=!0,null}finally{Ha.endContentGenerating=!1,Ha.endContentPromise=null}})(),await Ha.endContentPromise}(n)):(console.log("✅ [PK结束] 使用预生成内容（30秒前生成）"),e=Ha.preGeneratedEndContent),function(n,e=null){console.log(`🎫 [PK系统] 显示结果弹窗: ${n}`),e?(console.log("📦 [PK弹窗] 已有AI内容，弹窗关闭后立即播放"),Ha.pendingEndContent=e):(console.log("⏳ [PK弹窗] AI内容生成中，弹窗关闭时检查"),Ha.pendingEndContent=null);const t=Ha.streamerScore||0,o=Ha.userScore||0;let a=0,i=0;if("victory"===n){const n=Math.floor(151*Math.random())+50;a=t+o+n,i=a/10,console.log(`🏆 [PK系统] 胜利奖励: ${t} + ${o} + ${n}(奖励) = ${a}积分 = $${i.toFixed(2)}`)}else"draw"===n?(a=o,i=a/10,console.log(`⚖️ [PK系统] 平局奖励: ${o}积分 = $${i.toFixed(2)}`)):(a=t+o,i=0,console.log("❌ [PK系统] 失败: 积分归主播"));const r=document.createElement("div");if(r.id="pkResultOverlay",r.className="pk-modal-overlay",document.body.appendChild(r),"victory"===n){const n=document.createElement("div");n.id="pkResultModal",n.className="pk-victory-modal",n.innerHTML=`\n      \x3c!-- 像素星星背景 --\x3e\n      <div class="victory-stars"></div>\n\n      \x3c!-- 像素粒子 --\x3e\n      <div class="pixel-particles"></div>\n\n      <div class="victory-content">\n        \x3c!-- 像素猫咪 --\x3e\n        <div class="pixel-cat-container">\n          <div class="pixel-cat">\n            <div class="pixel-glow"></div>\n            <div class="cat-head">\n              <div class="cat-ear left">\n                <div class="cat-ear-inner"></div>\n              </div>\n              <div class="cat-ear right">\n                <div class="cat-ear-inner"></div>\n              </div>\n              <div class="cat-eyes">\n                <div class="cat-eye"></div>\n                <div class="cat-eye"></div>\n              </div>\n              <div class="cat-nose"></div>\n              <div class="cat-mouth"></div>\n            </div>\n            <div class="cat-body"></div>\n          </div>\n        </div>\n\n        \x3c!-- 标题 --\x3e\n        <div class="victory-title">VICTORY</div>\n\n        \x3c!-- 分数 --\x3e\n        <div class="victory-score-display">\n          <div class="score-row">\n            <span class="score-label">YOU</span>\n            <span class="score-value">${o}</span>\n          </div>\n          <div class="score-row">\n            <span class="score-label">VS</span>\n            <span class="score-label" style="color: #808080;">--</span>\n          </div>\n          <div class="score-row">\n            <span class="score-label">HOST</span>\n            <span class="score-value">${t}</span>\n          </div>\n        </div>\n\n        \x3c!-- 关闭按钮 --\x3e\n        <button class="victory-close-btn" onclick="closePKResultModal()">(｡◕‿◕｡)</button>\n      </div>\n    `,document.body.appendChild(n);const e=n.querySelector(".victory-stars");for(let n=0;n<15;n++){const n=document.createElement("div");n.className="pixel-star",n.style.left=100*Math.random()+"%",n.style.top=100*Math.random()+"%",n.style.animationDelay=1.5*Math.random()+"s",e.appendChild(n)}const a=n.querySelector(".pixel-particles");setTimeout(()=>{for(let n=0;n<20;n++){const n=document.createElement("div");n.className="pixel-particle",n.style.left="50%",n.style.top="40%",n.style.setProperty("--x-offset",200*(Math.random()-.5)+"px"),n.style.animationDelay=.3*Math.random()+"s",a.appendChild(n)}},300),setTimeout(()=>{r.classList.add("active"),n.classList.add("active")},50),setTimeout(()=>{ai()},6e3)}else if("defeat"===n){const n=document.createElement("div");n.id="pkResultModal",n.className="pk-defeat-modal",n.innerHTML=`\n      \x3c!-- 黑胶唱片 --\x3e\n      <div class="vinyl-record">\n        \x3c!-- 纹理 --\x3e\n        <div class="vinyl-grooves"></div>\n\n        \x3c!-- 中心标签 --\x3e\n        <div class="vinyl-label">\n          <span>DEFEAT</span>\n          <div class="vinyl-hole"></div>\n        </div>\n      </div>\n\n      \x3c!-- 裂纹 --\x3e\n      <div class="crack-container">\n        <div class="crack-line main"></div>\n        <div class="crack-line branch"></div>\n        <div class="crack-line branch2"></div>\n      </div>\n\n      \x3c!-- 碎片 --\x3e\n      <div class="shard-container"></div>\n\n      \x3c!-- 文字浮层 --\x3e\n      <div class="defeat-overlay">\n        <div class="defeat-text">LOSE</div>\n        <div class="defeat-score">${o} vs ${t}</div>\n      </div>\n    `,document.body.appendChild(n);const e=n.querySelector(".shard-container");setTimeout(()=>{for(let n=0;n<8;n++){const t=document.createElement("div");t.className="shard";const o=n/8*Math.PI*2,a=120+40*Math.random();t.style.width=12+8*Math.random()+"px",t.style.height=12+8*Math.random()+"px",t.style.left="50%",t.style.top="50%",t.style.setProperty("--fly-x",Math.cos(o)*a+"px"),t.style.setProperty("--fly-y",Math.sin(o)*a+"px"),t.style.setProperty("--fly-rotate",360*Math.random()+"deg"),t.style.animationDelay=.1+.2*Math.random()+"s",e.appendChild(t)}},1e3),setTimeout(()=>{r.classList.add("active"),n.classList.add("active")},50),setTimeout(()=>{ai()},3500)}else{const n=document.createElement("div");n.id="pkResultModal",n.className="pk-draw-modal",n.innerHTML=`\n      <div class="crossed-daggers">\n        \x3c!-- 平局标题 --\x3e\n        <div class="draw-title">DRAW</div>\n\n        \x3c!-- 背景装饰圆环 --\x3e\n        <div class="dagger-ring"></div>\n\n        \x3c!-- 左侧匕首 --\x3e\n        <div class="dagger left">\n          <div class="dagger-pommel">\n            <div class="pommel-shine"></div>\n          </div>\n          <div class="dagger-handle">\n            <div class="handle-wrap"></div>\n            <div class="handle-wrap"></div>\n            <div class="handle-wrap"></div>\n          </div>\n          <div class="dagger-guard">\n            <div class="guard-detail"></div>\n          </div>\n          <div class="dagger-blade">\n            <div class="blade-edge"></div>\n            <div class="blade-shine"></div>\n          </div>\n        </div>\n\n        \x3c!-- 右侧匕首 --\x3e\n        <div class="dagger right">\n          <div class="dagger-pommel">\n            <div class="pommel-shine"></div>\n          </div>\n          <div class="dagger-handle">\n            <div class="handle-wrap"></div>\n            <div class="handle-wrap"></div>\n            <div class="handle-wrap"></div>\n          </div>\n          <div class="dagger-guard">\n            <div class="guard-detail"></div>\n          </div>\n          <div class="dagger-blade">\n            <div class="blade-edge"></div>\n            <div class="blade-shine"></div>\n          </div>\n        </div>\n\n        \x3c!-- 碰撞光晕 --\x3e\n        <div class="clash-glow"></div>\n\n        \x3c!-- 碰撞火花 --\x3e\n        <div class="clash-sparks"></div>\n\n        \x3c!-- 分数显示 --\x3e\n        <div class="draw-scores">\n          <div class="draw-score-box">\n            <div class="draw-score-label">YOU</div>\n            <div class="draw-score-value">${o}</div>\n          </div>\n          <div class="draw-score-box">\n            <div class="draw-score-label">HOST</div>\n            <div class="draw-score-value">${t}</div>\n          </div>\n        </div>\n      </div>\n    `,document.body.appendChild(n);const e=n.querySelector(".clash-sparks");setTimeout(()=>{for(let n=0;n<8;n++){const t=document.createElement("div");t.className="spark";const o=n/8*Math.PI*2,a=30+20*Math.random();t.style.left="50%",t.style.top="50%",t.style.setProperty("--spark-x",Math.cos(o)*a+"px"),t.style.setProperty("--spark-y",Math.sin(o)*a+"px"),t.style.animationDelay=.2*Math.random()+"s",e.appendChild(t)}},800),setTimeout(()=>{r.classList.add("active"),n.classList.add("active")},50),setTimeout(()=>{ai()},3500)}i>0&&setTimeout(()=>{!async function(n,e,t,o){try{if(await Mt(),!It.isActivated)return console.warn("💰 [PK系统] 钱包未激活，跳过奖励入账"),void mn("钱包未激活，奖励无法入账","warning");It.balance+=n;const a={id:"pk_reward_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:"victory"===e?`PK胜利奖励 (${t}+${o}+奖励)`:`PK平局奖励 (${o}积分)`,amount:n,timestamp:(new Date).toISOString(),type:"pk_reward",details:{result:e,streamerScore:t,userScore:o,pointsEarned:10*n}};It.transactions.unshift(a),await Tt(),console.log(`💰 [PK系统] 奖励已入账: +${n.toFixed(2)}`),Rl({title:"PK奖励",message:`已入账 ${n.toFixed(2)}`,leftIcon:"x",duration:3e3})}catch(n){console.error("❌ [PK系统] 更新钱包失败:",n),mn("奖励入账失败","error")}}(i,n,t,o)},2e3),r.addEventListener("click",ai)}(n,e),setTimeout(()=>{ni(),Ha.isActive=!1},500)}();n<=3e4&&n>29e3&&!Ha.prepareTriggered&&(console.log("🎬 [PK系统] 剩余30秒，触发结束内容预生成"),Ha.prepareTriggered=!0,async function(){if(console.log("🎯 [PK预生成] 开始智能预判..."),Ha.endContentGenerating)return void console.log("⚠️ [PK预生成] 已在生成中，跳过");const n=Ha.streamerScore||0,e=Ha.userScore||0,t=Math.abs(n-e),o=Math.max(n,e,1),a=t/o;let i;console.log(`📊 [PK预生成] 当前积分: 主播${n} vs 用户${e}`),console.log(`📊 [PK预生成] 差距: ${t}分 (${(100*a).toFixed(1)}%)`);let r=!1;a>.25?(r=!0,n>e?(i="pkDefeat",Ha.preGeneratedResult="defeat",console.log("✅ [PK预生成] 差距大(>25%)，主播大幅领先 → 提前生成【用户失败】内容")):(i="pkVictory",Ha.preGeneratedResult="victory",console.log("✅ [PK预生成] 差距大(>25%)，用户大幅领先 → 提前生成【用户胜利】内容"))):a>.1?(r=!0,n>e?(i="pkDefeatClose",Ha.preGeneratedResult="defeatClose",console.log("✅ [PK预生成] 差距中等(10-25%)，主播优势 → 提前生成【惜败】内容（可能反转）")):(i="pkVictoryClose",Ha.preGeneratedResult="victoryClose",console.log("✅ [PK预生成] 差距中等(10-25%)，用户优势 → 提前生成【险胜】内容（可能反转）"))):(r=!0,i="pkCloseMatch",Ha.preGeneratedResult="closeMatch",console.log("✅ [PK预生成] 差距极小(<10%)，势均力敌 → 提前生成【激烈对决】通用内容")),r?(Ha.endContentGenerating=!0,Ha.endContentError=!1,Ha.endContentPromise=(async()=>{try{console.log(`🔄 [PK预生成] 调用AI生成 interactionType=${i}`);const n=await oa([],[],i);return n?(Ha.preGeneratedEndContent=n,console.log("✅ [PK预生成] AI内容生成完成，已缓存"),console.log(`📦 [PK预生成] 内容包含: ${n.streamerMessages?.length||0}条主播发言, ${n.danmaku?.length||0}条弹幕`)):(console.warn("⚠️ [PK预生成] AI返回空内容"),Ha.endContentError=!0),n}catch(n){return console.error("❌ [PK预生成] 生成失败:",n),Ha.endContentError=!0,null}finally{Ha.endContentGenerating=!1,Ha.endContentPromise=null}})(),await Ha.endContentPromise):console.log("⏭️ [PK预生成] 不满足预生成条件，PK结束时再生成")}());const e=Math.floor(n/6e4),t=Math.floor(n%6e4/1e3),o=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`,a=document.getElementById("pkTimerReplacement");a&&(a.textContent=o,n<1e4?a.classList.add("urgent"):a.classList.remove("urgent"))},1e3)},100)}()},800))},100)}(Ha.preparingProgress,t);Ha.preparingProgress+=1.5*Math.random()+.5,Ha.preparingProgress>30&&(Ha.preparingProgress=30),n&&(n.textContent=`${Math.floor(Ha.preparingProgress)}%`);const o=Math.floor(Ha.preparingProgress/100*e.length);for(;t<o&&t<e.length;)e[t].classList.add("filled"),t++},300)}()},1500),console.log("✅ [PK系统] PK准备中弹窗已显示，等待第14情景生成...")}()):mn("扣除积分失败","error")},n.closeGiftMenu=ki,n.selectGift=$i,n.sendSelectedGift=function(){if(!gi.selectedGift)return;const n=gi.selectedGift,e=bi(),t=n.points||n.price||0;if(e<t)return void mn("积分不足","error");let o="";o=n.useLocalImage&&n.imageLocal?`<img src="${n.imageLocal}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.imageUrl?`<img src="${n.imageUrl}" alt="${n.name}" style="width:100%;height:100%;object-fit:contain;">`:n.icon?n.icon:'<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:36px;color:rgba(255,255,255,0.3);">🎁</div>';const a=document.querySelector(".live-room");if(!a)return;const i=`\n    <div class="gift-confirm-overlay" id="giftConfirmOverlay" onclick="closeGiftConfirm()"></div>\n    <div class="gift-confirm-panel" id="giftConfirmPanel">\n      <div class="confirm-header">\n        <div class="confirm-title">SEND GIFT</div>\n      </div>\n      \n      <div class="confirm-gift-display">\n        <div class="confirm-gift-icon">${o}</div>\n        <div class="confirm-gift-info">\n          <div class="confirm-gift-name">${n.name}</div>\n          <div class="confirm-gift-subtitle">${n.subtitle||n.description||""}</div>\n          <div class="confirm-gift-price">${t}P</div>\n        </div>\n      </div>\n      \n      <div class="confirm-question">触发主播反应？</div>\n      \n      <div class="confirm-buttons">\n        <button class="confirm-btn instant" onclick="executeGiftSend(true)">\n          <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor; margin-right: 6px;">\n            <path d="M13 10h5l-6 6-6-6h5V3h2z"/>\n            <path d="M19 18v1H5v-1h14z"/>\n          </svg>\n          立即触发\n        </button>\n        <button class="confirm-btn queue" onclick="executeGiftSend(false)">\n          <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor; margin-right: 6px;">\n            <rect x="4" y="4" width="16" height="4"/>\n            <rect x="4" y="10" width="16" height="4"/>\n            <rect x="4" y="16" width="16" height="4"/>\n          </svg>\n          暂存队列\n        </button>\n      </div>\n      \n      <div class="confirm-hint">立即触发会马上生成主播反应<br/>暂存队列则与弹幕一起发送</div>\n      \n      <div class="confirm-close" onclick="closeGiftConfirm()">×</div>\n    </div>\n  `;a.insertAdjacentHTML("beforeend",i),function(){if(document.getElementById("giftConfirmStyles"))return;const n=document.createElement("style");n.id="giftConfirmStyles",n.textContent="\n    /* 礼物确认弹窗 - 磁带播放器风格 */\n    .gift-confirm-overlay {\n      position: fixed;\n      inset: 0;\n      background: rgba(0, 0, 0, 0.8);\n      z-index: 10002;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    }\n\n    .gift-confirm-overlay.active {\n      opacity: 1;\n    }\n\n    .gift-confirm-panel {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%) scale(0.9);\n      width: 90%;\n      max-width: 420px;\n      background: linear-gradient(135deg, rgba(25,25,25,0.98), rgba(15,15,15,0.98));\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 16px;\n      box-shadow: 0 20px 60px rgba(0,0,0,0.8),\n                  0 0 1px rgba(255,255,255,0.3);\n      z-index: 10003;\n      opacity: 0;\n      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n      overflow: hidden;\n    }\n\n    .gift-confirm-panel.active {\n      opacity: 1;\n      transform: translate(-50%, -50%) scale(1);\n    }\n\n    .confirm-header {\n      padding: 16px 20px;\n      border-bottom: 1px solid rgba(255,255,255,0.1);\n      background: rgba(0,0,0,0.3);\n    }\n\n    .confirm-title {\n      font-family: 'Courier New', monospace;\n      font-size: 14px;\n      font-weight: bold;\n      letter-spacing: 3px;\n      color: rgba(255,255,255,0.9);\n      text-align: center;\n    }\n\n    .confirm-gift-display {\n      display: flex;\n      align-items: center;\n      gap: 16px;\n      padding: 24px 20px;\n      border-bottom: 1px solid rgba(255,255,255,0.1);\n    }\n\n    .confirm-gift-icon {\n      width: 60px;\n      height: 60px;\n      flex-shrink: 0;\n      filter: drop-shadow(0 0 8px rgba(255,255,255,0.2));\n    }\n\n    .confirm-gift-info {\n      flex: 1;\n    }\n\n    .confirm-gift-name {\n      font-family: 'Courier New', monospace;\n      font-size: 14px;\n      font-weight: bold;\n      letter-spacing: 1px;\n      color: rgba(255,255,255,0.95);\n      margin-bottom: 4px;\n    }\n\n    .confirm-gift-subtitle {\n      font-size: 11px;\n      color: rgba(255,255,255,0.5);\n      margin-bottom: 8px;\n    }\n\n    .confirm-gift-price {\n      font-family: 'Courier New', monospace;\n      font-size: 13px;\n      font-weight: bold;\n      color: rgba(255,255,255,0.8);\n    }\n\n    .confirm-question {\n      padding: 16px 20px;\n      text-align: center;\n      font-size: 13px;\n      color: rgba(255,255,255,0.7);\n      background: rgba(0,0,0,0.2);\n    }\n\n    .confirm-buttons {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 12px;\n      padding: 20px;\n    }\n\n    .confirm-btn {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 12px 16px;\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      font-weight: bold;\n      letter-spacing: 1.5px;\n      border: 1px solid rgba(255,255,255,0.2);\n      border-radius: 8px;\n      background: rgba(40,40,40,0.8);\n      color: rgba(255,255,255,0.85);\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n\n    .confirm-btn:hover {\n      background: rgba(60,60,60,0.9);\n      border-color: rgba(255,255,255,0.4);\n      color: rgba(255,255,255,1);\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n    }\n\n    .confirm-btn.instant {\n      background: rgba(60,60,60,0.9);\n    }\n\n    .confirm-btn.instant:hover {\n      background: rgba(80,80,80,0.95);\n      box-shadow: 0 0 20px rgba(255,255,255,0.1);\n    }\n\n    .confirm-hint {\n      padding: 16px 20px 20px;\n      text-align: center;\n      font-size: 10px;\n      line-height: 1.6;\n      color: rgba(255,255,255,0.4);\n      border-top: 1px solid rgba(255,255,255,0.05);\n    }\n\n    .confirm-close {\n      position: absolute;\n      top: 16px;\n      right: 16px;\n      width: 28px;\n      height: 28px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      color: rgba(255,255,255,0.6);\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border-radius: 4px;\n    }\n\n    .confirm-close:hover {\n      color: rgba(255,255,255,1);\n      background: rgba(255,255,255,0.1);\n    }\n\n    @media (max-width: 600px) {\n      .gift-confirm-panel {\n        max-width: 340px;\n      }\n\n      .confirm-buttons {\n        grid-template-columns: 1fr;\n        gap: 10px;\n      }\n\n      .confirm-btn {\n        padding: 11px 14px;\n        font-size: 10px;\n      }\n    }\n  ",document.head.appendChild(n)}(),setTimeout(()=>{const n=document.getElementById("giftConfirmPanel"),e=document.getElementById("giftConfirmOverlay");n&&n.classList.add("active"),e&&e.classList.add("active")},50)},n.openPointsRecharge=async function(){const n=bi(),e=(await wr()).balance,t=`\n    \x3c!-- 遮罩层（透明） --\x3e\n    <div class="recharge-overlay" id="rechargeOverlay" onclick="closePointsRecharge()"></div>\n    \n    \x3c!-- 充值主面板（磁带播放器风格） --\x3e\n    <div class="recharge-panel" id="rechargePanel">\n      \x3c!-- 顶部LCD显示屏 --\x3e\n      <div class="recharge-lcd-display">\n        <div class="lcd-label">POINTS RECHARGE</div>\n        <div class="lcd-stats">\n          <div class="lcd-stat-item">\n            <div class="stat-icon">PT</div>\n            <div class="stat-value" id="rechargeCurrentPoints">${n.toLocaleString()}</div>\n          </div>\n          <div class="lcd-divider"></div>\n          <div class="lcd-stat-item">\n            <div class="stat-icon">$$</div>\n            <div class="stat-value" id="rechargeWalletBalance">${e.toFixed(2)}</div>\n          </div>\n        </div>\n        \n        \x3c!-- 关闭按钮 --\x3e\n        <div class="lcd-close-btn" onclick="closePointsRecharge()">\n          <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n            <line x1="6" y1="6" x2="18" y2="18"/>\n            <line x1="18" y1="6" x2="6" y2="18"/>\n          </svg>\n        </div>\n      </div>\n\n      \x3c!-- 磁带选择器风格的Tab --\x3e\n      <div class="cassette-tabs">\n        <div class="cassette-tab active" onclick="switchRechargeTab('direct')" data-tab="direct">\n          <div class="tab-track-no">A</div>\n          <div class="tab-track-info">\n            <div class="track-name">DIRECT</div>\n            <div class="track-ratio">10$ = 1PT</div>\n          </div>\n        </div>\n        <div class="cassette-tab" onclick="switchRechargeTab('package')" data-tab="package">\n          <div class="tab-track-no">B</div>\n          <div class="tab-track-info">\n            <div class="track-name">PACKAGE</div>\n            <div class="track-badge">VALUE</div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 直充区域（磁带计数器风格） --\x3e\n      <div class="recharge-content" id="directRechargeContent">\n        <div class="direct-counter-box">\n          <div class="counter-input-row">\n            <div class="counter-label">USD</div>\n            <input type="number" \n                   id="directRechargeAmount" \n                   class="counter-input" \n                   placeholder="10"\n                   min="10"\n                   step="10"\n                   oninput="calculateDirectPoints(this.value)">\n          </div>\n          \n          <div class="counter-conversion">\n            <div class="conversion-bar">\n              <div class="bar-segment"></div>\n              <div class="bar-segment"></div>\n              <div class="bar-segment"></div>\n            </div>\n          </div>\n          \n          <div class="counter-result-row">\n            <div class="counter-label">POINTS</div>\n            <div class="counter-result" id="directPointsResult">0</div>\n          </div>\n          \n          <div class="counter-hint">RATIO 10:1 - FOR BULK RECHARGE USE PACKAGE</div>\n          \n          <button class="counter-confirm-btn" onclick="executeDirectRecharge()">\n            <div class="btn-track-line"></div>\n            <span>CONFIRM RECHARGE</span>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- 套餐区域（磁带曲目列表风格） --\x3e\n      <div class="recharge-content" id="packageRechargeContent" style="display: none;">\n        <div class="package-track-list">\n          ${yr.map((n,t)=>`\n            <div class="package-track ${e>=n.amount?"":"locked"}" \n                 onclick="${e>=n.amount?`executePackageRecharge('${n.id}')`:"showInsufficientBalance()"}">\n              <div class="track-no">${String(t+1).padStart(2,"0")}</div>\n              <div class="track-details">\n                <div class="track-title">${n.title}</div>\n                <div class="track-subtitle">${n.subtitle}</div>\n              </div>\n              <div class="track-price">\n                <div class="price-usd">$${n.amount>=1e3?(n.amount/1e3).toFixed(n.amount%1e3==0?0:1)+"K":n.amount}</div>\n                <div class="price-pts">${n.points>=1e3?(n.points/1e3).toFixed(n.points%1e3==0?0:1)+"K":n.points}PT</div>\n              </div>\n              ${e<n.amount?'<div class="track-locked-icon">LOCKED</div>':""}\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    </div>\n  `,o=document.querySelector(".live-room");if(o){const n=document.createElement("div");n.id="rechargeContainer",n.innerHTML=t,o.appendChild(n),requestAnimationFrame(()=>{const n=document.getElementById("rechargeOverlay"),e=document.getElementById("rechargePanel");n&&n.classList.add("active"),e&&(e.style.transform="translateX(-50%) translateY(0)",e.style.opacity="1")}),function(){if(document.getElementById("recharge-styles"))return;const n=document.createElement("style");n.id="recharge-styles",n.textContent="\n    /* 遮罩层 - 完全透明 */\n    .recharge-overlay {\n      position: fixed;\n      inset: 0;\n      background: transparent;\n      z-index: 10003;\n      opacity: 0;\n      transition: opacity 0.4s ease;\n    }\n\n    .recharge-overlay.active {\n      opacity: 1;\n    }\n\n    /* 充值主面板（磁带播放器风格） */\n    .recharge-panel {\n      position: fixed;\n      bottom: 0;\n      left: 50%;\n      transform: translateX(-50%) translateY(100%);\n      width: 90%;\n      max-width: 420px;\n      max-height: 70vh;\n      background: linear-gradient(180deg, rgba(18, 18, 18, 0.97) 0%, rgba(10, 10, 10, 0.97) 100%);\n      border: 1.5px solid rgba(255, 255, 255, 0.2);\n      border-bottom: none;\n      border-radius: 16px 16px 0 0;\n      box-shadow: \n        0 -10px 40px rgba(0, 0, 0, 0.8),\n        inset 0 1px 0 rgba(255, 255, 255, 0.08);\n      z-index: 10004;\n      opacity: 0;\n      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    }\n\n    /* LCD显示屏风格的顶部 */\n    .recharge-lcd-display {\n      background: linear-gradient(180deg, rgba(25, 25, 25, 0.95) 0%, rgba(15, 15, 15, 0.95) 100%);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n      padding: 14px 16px;\n      position: relative;\n    }\n\n    .lcd-label {\n      font-size: 10px;\n      font-weight: 900;\n      letter-spacing: 2.5px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.5);\n      text-align: center;\n      margin-bottom: 10px;\n    }\n\n    .lcd-stats {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 16px;\n    }\n\n    .lcd-stat-item {\n      display: flex;\n      align-items: baseline;\n      gap: 6px;\n    }\n\n    .stat-icon {\n      font-size: 9px;\n      font-weight: 800;\n      color: rgba(255, 255, 255, 0.4);\n      font-family: 'Courier New', monospace;\n    }\n\n    .stat-value {\n      font-size: 16px;\n      font-weight: 900;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 1px;\n    }\n\n    .lcd-divider {\n      width: 1px;\n      height: 20px;\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .lcd-close-btn {\n      position: absolute;\n      top: 10px;\n      right: 10px;\n      width: 22px;\n      height: 22px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 3px;\n      color: rgba(255, 255, 255, 0.6);\n      cursor: pointer;\n      transition: all 0.2s;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .lcd-close-btn:hover {\n      border-color: rgba(255, 255, 255, 0.5);\n      color: rgba(255, 255, 255, 0.95);\n      background: rgba(255, 255, 255, 0.08);\n    }\n\n    /* 磁带选择器风格的Tab */\n    .cassette-tabs {\n      display: flex;\n      gap: 10px;\n      padding: 12px 16px;\n      border-bottom: 1px solid rgba(255, 255, 255, 0.12);\n      background: linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, transparent 100%);\n    }\n\n    .cassette-tab {\n      flex: 1;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      padding: 10px 12px;\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-radius: 6px;\n      cursor: pointer;\n      transition: all 0.3s;\n      position: relative;\n      background: rgba(0, 0, 0, 0.3);\n    }\n\n    .cassette-tab::before {\n      content: \"\";\n      position: absolute;\n      top: 50%;\n      left: 8px;\n      width: 2px;\n      height: 60%;\n      background: rgba(255, 255, 255, 0.1);\n      transform: translateY(-50%);\n    }\n\n    .cassette-tab:hover {\n      border-color: rgba(255, 255, 255, 0.3);\n      background: rgba(255, 255, 255, 0.05);\n    }\n\n    .cassette-tab.active {\n      border-color: rgba(255, 255, 255, 0.5);\n      background: rgba(255, 255, 255, 0.08);\n      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.05);\n    }\n\n    .tab-track-no {\n      width: 20px;\n      height: 20px;\n      flex-shrink: 0;\n      background: rgba(255, 255, 255, 0.1);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 10px;\n      font-weight: 900;\n      color: rgba(255, 255, 255, 0.8);\n      font-family: 'Courier New', monospace;\n    }\n\n    .cassette-tab.active .tab-track-no {\n      background: rgba(255, 255, 255, 0.2);\n      border-color: rgba(255, 255, 255, 0.4);\n      color: rgba(255, 255, 255, 0.95);\n    }\n\n    .tab-track-info {\n      flex: 1;\n      min-width: 0;\n    }\n\n    .track-name {\n      font-size: 11px;\n      font-weight: 800;\n      color: rgba(255, 255, 255, 0.9);\n      margin-bottom: 2px;\n      font-family: 'Courier New', monospace;\n      letter-spacing: 1px;\n    }\n\n    .track-ratio {\n      font-size: 9px;\n      color: rgba(255, 255, 255, 0.5);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    .track-badge {\n      font-size: 9px;\n      color: rgba(255, 255, 255, 0.7);\n      background: rgba(255, 255, 255, 0.1);\n      padding: 1px 6px;\n      border-radius: 3px;\n      font-weight: 700;\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    /* 充值内容区域 */\n    .recharge-content {\n      flex: 1;\n      overflow-y: auto;\n      padding: 14px 16px;\n    }\n\n    /* 直充计数器区域 */\n    .direct-counter-box {\n      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.2) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.12);\n      border-radius: 8px;\n      padding: 16px;\n    }\n\n    .counter-input-row {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 14px;\n    }\n\n    .counter-label {\n      flex-shrink: 0;\n      font-size: 10px;\n      font-weight: 900;\n      letter-spacing: 1.5px;\n      color: rgba(255, 255, 255, 0.6);\n      font-family: 'Courier New', monospace;\n      width: 50px;\n    }\n\n    .counter-input {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.5);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 6px;\n      padding: 10px 12px;\n      font-size: 18px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      transition: all 0.2s;\n      letter-spacing: 1px;\n    }\n\n    .counter-input:focus {\n      outline: none;\n      border-color: rgba(255, 255, 255, 0.5);\n      background: rgba(0, 0, 0, 0.7);\n      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);\n    }\n\n    .counter-input::placeholder {\n      color: rgba(255, 255, 255, 0.25);\n    }\n\n    .counter-conversion {\n      padding: 12px 0;\n    }\n\n    .conversion-bar {\n      display: flex;\n      gap: 3px;\n      justify-content: center;\n      align-items: center;\n    }\n\n    .bar-segment {\n      width: 40px;\n      height: 2px;\n      background: rgba(255, 255, 255, 0.15);\n      border-radius: 1px;\n    }\n\n    .bar-segment:nth-child(2) {\n      background: rgba(255, 255, 255, 0.25);\n    }\n\n    .counter-result-row {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 12px;\n    }\n\n    .counter-result {\n      flex: 1;\n      background: rgba(0, 0, 0, 0.5);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 6px;\n      padding: 10px 12px;\n      font-size: 18px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.95);\n      font-family: 'Courier New', monospace;\n      text-align: right;\n      letter-spacing: 1px;\n    }\n\n    .counter-hint {\n      font-size: 9px;\n      color: rgba(255, 255, 255, 0.4);\n      text-align: center;\n      padding: 8px;\n      background: rgba(0, 0, 0, 0.3);\n      border-radius: 4px;\n      margin-bottom: 14px;\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n      line-height: 1.4;\n    }\n\n    .counter-confirm-btn {\n      width: 100%;\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.12) 100%);\n      color: rgba(255, 255, 255, 0.95);\n      border: 1.5px solid rgba(255, 255, 255, 0.3);\n      border-radius: 6px;\n      padding: 12px;\n      font-size: 11px;\n      font-weight: 900;\n      cursor: pointer;\n      transition: all 0.2s;\n      letter-spacing: 2px;\n      font-family: 'Courier New', monospace;\n      position: relative;\n      overflow: hidden;\n    }\n\n    .btn-track-line {\n      position: absolute;\n      bottom: 3px;\n      left: 12px;\n      right: 12px;\n      height: 1px;\n      background: rgba(255, 255, 255, 0.2);\n    }\n\n    .counter-confirm-btn:hover {\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.18) 100%);\n      border-color: rgba(255, 255, 255, 0.5);\n      transform: translateY(-1px);\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n    }\n\n    .counter-confirm-btn:active {\n      transform: translateY(0);\n    }\n\n    /* 套餐曲目列表 */\n    .package-track-list {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .package-track {\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      border-radius: 6px;\n      padding: 12px;\n      cursor: pointer;\n      transition: all 0.2s;\n      position: relative;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .package-track::before {\n      content: \"\";\n      position: absolute;\n      left: 0;\n      top: 6px;\n      bottom: 6px;\n      width: 2px;\n      background: rgba(255, 255, 255, 0.15);\n      border-radius: 0 1px 1px 0;\n    }\n\n    .package-track:hover {\n      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);\n      border-color: rgba(255, 255, 255, 0.3);\n      transform: translateX(2px);\n    }\n\n    .package-track.locked {\n      opacity: 0.4;\n      cursor: not-allowed;\n    }\n\n    .package-track.locked:hover {\n      transform: none;\n    }\n\n    .track-no {\n      flex-shrink: 0;\n      width: 28px;\n      height: 28px;\n      background: rgba(0, 0, 0, 0.4);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 4px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 11px;\n      font-weight: 900;\n      color: rgba(255, 255, 255, 0.8);\n      font-family: 'Courier New', monospace;\n    }\n\n    .track-details {\n      flex: 1;\n      min-width: 0;\n    }\n\n    .track-title {\n      font-size: 12px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.95);\n      margin-bottom: 2px;\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    .track-subtitle {\n      font-size: 9px;\n      color: rgba(255, 255, 255, 0.45);\n      font-family: 'Courier New', monospace;\n    }\n\n    .track-price {\n      flex-shrink: 0;\n      text-align: right;\n    }\n\n    .price-usd {\n      font-size: 13px;\n      font-weight: 900;\n      color: rgba(255, 255, 255, 0.9);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n      margin-bottom: 2px;\n    }\n\n    .price-pts {\n      font-size: 10px;\n      color: rgba(255, 255, 255, 0.6);\n      font-family: 'Courier New', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    .track-locked-icon {\n      position: absolute;\n      top: 50%;\n      right: 12px;\n      transform: translateY(-50%);\n      font-size: 9px;\n      font-weight: 900;\n      letter-spacing: 1px;\n      color: rgba(255, 255, 255, 0.3);\n      font-family: 'Courier New', monospace;\n      background: rgba(0, 0, 0, 0.5);\n      padding: 3px 6px;\n      border-radius: 3px;\n      border: 1px solid rgba(255, 255, 255, 0.15);\n    }\n\n    /* 移动端适配 */\n    @media (max-width: 600px) {\n      .recharge-panel {\n        width: 100%;\n        max-width: none;\n        max-height: 85vh;\n        border-radius: 20px 20px 0 0;\n      }\n\n      .recharge-lcd-display {\n        padding: 12px;\n      }\n\n      .lcd-label {\n        font-size: 9px;\n        margin-bottom: 8px;\n      }\n\n      .stat-value {\n        font-size: 14px;\n      }\n\n      .cassette-tabs {\n        padding: 10px 12px;\n        gap: 8px;\n      }\n\n      .cassette-tab {\n        padding: 8px 10px;\n      }\n\n      .recharge-content {\n        padding: 12px;\n      }\n\n      .direct-counter-box {\n        padding: 14px;\n      }\n\n      .counter-input,\n      .counter-result {\n        font-size: 16px;\n        padding: 9px 10px;\n      }\n\n      .package-track {\n        padding: 10px;\n      }\n\n      .track-no {\n        width: 24px;\n        height: 24px;\n        font-size: 10px;\n      }\n    }\n  ",document.head.appendChild(n)}()}},n.closePointsRecharge=function(){const n=document.getElementById("rechargeContainer");if(n){const e=document.getElementById("rechargeOverlay"),t=document.getElementById("rechargePanel");e&&e.classList.remove("active"),t&&(t.style.transform="translateX(-50%) translateY(100%)",t.style.opacity="0"),setTimeout(()=>{n.remove()},400)}},n.switchRechargeTab=function(n){document.querySelectorAll(".cassette-tab").forEach(e=>{e.classList.remove("active"),e.dataset.tab===n&&e.classList.add("active")});const e=document.getElementById("directRechargeContent"),t=document.getElementById("packageRechargeContent");"direct"===n?(e.style.display="block",t.style.display="none"):(e.style.display="none",t.style.display="block")},n.calculateDirectPoints=function(n){const e=document.getElementById("directPointsResult");if(e){const t=parseFloat(n)||0,o=Math.floor(t/10);e.textContent=o.toLocaleString()}},n.executeDirectRecharge=async function(){const e=document.getElementById("directRechargeAmount"),t=parseFloat(e?.value)||0;if(t<10)return void mn("充值金额最低为10美元","error");if(t%10!=0)return void mn("充值金额必须是10的倍数","error");const o=await wr();if(!o.isActivated)return void mn("请先激活钱包","error");if(o.balance<t)return mn("钱包余额不足","error"),void Cr();const a=Math.floor(t/10);if(!confirm(`确认充值 $${t.toFixed(2)} 换取 ${a} 积分？`))return;try{ua(t,a);let i=a,r=!1,s=null;if(ha(t)){const n=fa(0,a);i=n.finalPoints,s=n.message,r=!0}o.data.balance-=t;const l={id:"points_recharge_"+Date.now(),description:`直播积分充值 - ${i}积分${r?i>a?" (幸运加成)":" (系统扣费)":""}`,amount:-t,timestamp:(new Date).toISOString(),type:"points_recharge"};o.data.transactions||(o.data.transactions=[]),o.data.transactions.unshift(l),await kr(o.data);const c=bi()+i;vi(c),r&&s&&setTimeout(()=>{ba(s)},500),Rl({title:"X Wallet",message:`充值成功！获得 ${i} 积分，当前余额 $${o.data.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"}),$r(c,o.data.balance),e&&(e.value="");const d=document.getElementById("directPointsResult");d&&(d.textContent="0"),console.log(`✅ [充值] 直充成功: $${t} → ${i}积分${r?" 🎭彩蛋触发":""}`)}catch(n){console.error("充值失败:",n),mn("充值失败，请重试","error")}},n.executePackageRecharge=async function(e){const t=yr.find(n=>n.id===e);if(!t)return;const o=await wr();if(console.log(`💰 [套餐充值] 钱包余额: $${o.balance}, 需要: $${t.amount}`),!o.isActivated)return void mn("请先激活钱包","error");if(o.balance<t.amount)return mn("钱包余额不足","error"),void Cr();if(!confirm(`确认购买「${t.title}」套餐？\n支付 $${t.amount.toLocaleString()} 获得 ${t.points.toLocaleString()} 积分（含${t.bonus}赠送）`))return;try{ua(t.amount,t.points);let e=t.points,a=!1,i=null;if(ha(t.amount,t.points)){const n=fa(t.amount,t.points);e=n.finalPoints,i=n.message,a=!0}o.data.balance-=t.amount;const r={id:"points_package_"+Date.now(),description:`直播积分套餐充值 - ${t.title}${a?e>t.points?" (幸运加成)":" (系统扣费)":""}`,amount:-t.amount,timestamp:(new Date).toISOString(),type:"points_recharge"};o.data.transactions||(o.data.transactions=[]),o.data.transactions.unshift(r),await kr(o.data);const s=bi()+e;vi(s),a&&i&&setTimeout(()=>{ba(i)},500);{const i=!a&&t.bonus?`（含${t.bonus}赠送）`:"";Rl({title:"X Wallet",message:`套餐购买成功！获得 ${e.toLocaleString()} 积分${i}，余额 $${o.data.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"})}$r(s,o.data.balance),console.log(`✅ [充值] 套餐购买成功: $${t.amount} → ${e}积分${a?" 🎭彩蛋触发":""}`)}catch(n){console.error("套餐充值失败:",n),mn("充值失败，请重试","error")}},n.showInsufficientBalance=Cr,n.toggleLiveDetails=function(){const n=document.getElementById("detailsContent"),e=document.getElementById("detailsExpandIcon"),t=n?.closest(".live-details");if(!n||!e)return;if(n.classList.contains("expanded")){const o=n.scrollHeight;n.style.maxHeight=o+"px",n.offsetHeight,requestAnimationFrame(()=>{n.style.maxHeight="0px",n.classList.remove("expanded"),e.classList.remove("expanded")});const a=e=>{"max-height"!==e.propertyName||n.classList.contains("expanded")||(t&&t.classList.remove("details-expanded"),n.removeEventListener("transitionend",a))};n.addEventListener("transitionend",a)}else{t&&t.classList.add("details-expanded"),n.classList.add("expanded"),e.classList.add("expanded"),n.style.maxHeight="none",n.style.overflow="visible";const o=n.scrollHeight;n.style.maxHeight="0px",n.style.overflow="hidden",requestAnimationFrame(()=>{n.style.maxHeight=o+20+"px"});const a=e=>{"max-height"===e.propertyName&&n.classList.contains("expanded")&&(n.style.maxHeight="none",n.style.overflow="visible",n.removeEventListener("transitionend",a))};n.addEventListener("transitionend",a)}};let Oi=0,_i=null,Fi=null,Xi=!1;function qi(e,t){if(Xi)return void(t&&t());if(!e||!e.trim())return void(t&&t());const o=document.getElementById("audioBars"),a=document.getElementById("streamerSpeech"),i=document.getElementById("speechContent"),r=a?.parentElement;if(!(o&&a&&i&&r))return void(t&&t());Fi&&(clearInterval(Fi),Fi=null),a.classList.remove("fading"),a.style.opacity="",a.style.transition="",o.classList.remove("dimmed"),r.classList.remove("speech-active"),console.log(`🎤 [主播发言] "${e.substring(0,30)}..." (${e.length}字, 实时检测模式)`),i.textContent=e,i.style.animation="none",a.style.opacity="0",requestAnimationFrame(()=>{requestAnimationFrame(()=>{r.classList.add("speech-active"),o.style.transition="opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), filter 0.8s cubic-bezier(0.4, 0, 0.2, 1)",o.style.opacity="0.15",o.classList.add("dimmed"),a.style.opacity="1",a.style.transition="opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)",a.classList.add("active")})});const s=i.offsetWidth,l=a.offsetWidth,c=(s+l)/100,d=Math.min(c,30);requestAnimationFrame(()=>{i.style.animation=`scrollSpeech ${d}s linear forwards`});Fi=setInterval(()=>{0;const e=n.getComputedStyle(i).transform;let l=0;if(e&&"none"!==e){const n=e.match(/matrix\(([^)]+)\)/);if(n&&n[1]){l=n[1].split(",").map(n=>parseFloat(n.trim()))[4]||0}}const c=l+s<-200;l+s<50&&!a.classList.contains("fading")&&(a.classList.add("fading"),a.classList.remove("active"),o.style.transition="opacity 2s cubic-bezier(0.4, 0, 0.2, 1), filter 2s cubic-bezier(0.4, 0, 0.2, 1)",o.style.opacity="1",o.classList.remove("dimmed"),r.classList.remove("speech-active")),c&&a.classList.contains("fading")&&(i.style.animation="none",clearInterval(Fi),Fi=null,setTimeout(()=>{a.classList.remove("fading"),a.style.opacity="",a.style.transition="",o.style.transition="",t&&t()},500))},50)}function Vi(){const n=document.getElementById("danmaku-history-overlay");n&&(n.classList.remove("active"),setTimeout(()=>{n.remove()},300))}n.openSpeechHistory=function(){const n=Ko?.details;if(!n||!n.streamerMessages||0===n.streamerMessages.length)return void mn("暂无主播发言记录","info");const e=document.createElement("div");e.id="speech-history-overlay",e.className="speech-history-overlay",e.innerHTML=`\n      <div class="speech-history-panel">\n        \x3c!-- 磁带盒顶部装饰螺丝 --\x3e\n        <div class="speech-cassette-screws">\n          <div class="speech-screw" style="top: 12px; left: 12px;"></div>\n          <div class="speech-screw" style="top: 12px; right: 12px;"></div>\n          <div class="speech-screw" style="bottom: 12px; left: 12px;"></div>\n          <div class="speech-screw" style="bottom: 12px; right: 12px;"></div>\n        </div>\n\n        \x3c!-- 顶部标签 --\x3e\n        <div class="speech-history-header">\n          <div class="speech-tape-label">\n            <div class="label-line"></div>\n            <span class="label-text">SPEECH ARCHIVE</span>\n            <div class="label-line"></div>\n          </div>\n          <div class="tape-counter">${String(n.streamerMessages.length).padStart(3,"0")} TRACKS</div>\n          <button class="speech-close-btn" onclick="closeSpeechHistory()">\n            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none">\n              <path d="M18 6L6 18M6 6l12 12"/>\n            </svg>\n          </button>\n        </div>\n\n        \x3c!-- 歌词列表风格的滚动区域 --\x3e\n        <div class="speech-history-list">\n          ${n.streamerMessages.map((n,e)=>`\n            <div class="speech-track-item" data-index="${e}">\n              <div class="track-number">\n                <span>${String(e+1).padStart(2,"0")}</span>\n              </div>\n              <div class="track-content">\n                <div class="track-text">${n.content}</div>\n                <div class="track-time">${n.time||"RECENT"}</div>\n              </div>\n              <div class="track-separator"></div>\n            </div>\n          `).join("")}\n        </div>\n\n        \x3c!-- 底部磁带纹理 --\x3e\n        <div class="tape-texture-bottom"></div>\n      </div>\n    `,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("active")})},n.openDanmakuHistory=function(){if(!Ko||!Ko.details)return void mn("暂无弹幕历史","info");const e=Ko.details;if(!e.danmaku||0===e.danmaku.length)return void mn("暂无弹幕历史","info");const t=e.danmaku.slice(0,30),o=document.createElement("div");o.id="danmaku-history-overlay",o.className="speech-history-overlay",o.onclick=n=>{n.target===o&&Vi()},o.innerHTML=`\n      <div class="speech-history-panel">\n        \x3c!-- 磁带盒顶部装饰螺丝 --\x3e\n        <div class="speech-cassette-screws">\n          <div class="speech-screw" style="top: 12px; left: 12px;"></div>\n          <div class="speech-screw" style="top: 12px; right: 12px;"></div>\n          <div class="speech-screw" style="bottom: 12px; left: 12px;"></div>\n          <div class="speech-screw" style="bottom: 12px; right: 12px;"></div>\n        </div>\n\n        \x3c!-- 顶部标签 --\x3e\n        <div class="speech-history-header">\n          <div class="speech-tape-label">\n            <div class="label-line"></div>\n            <span class="label-text">DANMAKU HISTORY</span>\n            <div class="label-line"></div>\n          </div>\n          <div class="tape-counter">${String(t.length).padStart(3,"0")} MSG</div>\n          <button class="speech-close-btn" onclick="closeDanmakuHistory()">\n            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none">\n              <path d="M18 6L6 18M6 6l12 12"/>\n            </svg>\n          </button>\n        </div>\n\n        \x3c!-- 弹幕列表滚动区域 - 歌词列表风格 --\x3e\n        <div class="speech-history-list">\n          ${t.map((e,t)=>`\n            <div class="danmaku-track-item ${e.isUser?"user-track":""}" data-index="${t}">\n              \x3c!-- 磁带轨道编号 --\x3e\n              <div class="track-number">\n                <span>${String(t+1).padStart(2,"0")}</span>\n              </div>\n              \x3c!-- 头像（用户头像或默认头像） --\x3e\n              <div class="track-avatar">\n                <img src="${e.isUser&&(n.userProfileData?.avatar||e.userAvatar)||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}" alt="${e.userName}" />\n              </div>\n              \x3c!-- 弹幕内容 --\x3e\n              <div class="track-content">\n                <div class="track-user-line">\n                  <span class="track-username">${e.userName}</span>\n                  ${e.timestamp?`<span class="track-time">${e.timestamp}</span>`:""}\n                </div>\n                <div class="track-text">${e.content}</div>\n              </div>\n              <div class="track-separator"></div>\n            </div>\n          `).join("")}\n        </div>\n\n        <div class="tape-texture-bottom"></div>\n      </div>\n    `,document.body.appendChild(o),requestAnimationFrame(()=>{o.classList.add("active")})},n.closeDanmakuHistory=Vi,n.closeSpeechHistory=function(){const n=document.getElementById("speech-history-overlay");n&&(n.classList.remove("active"),setTimeout(()=>{n.remove()},300))};let Gi=null,Yi=0;let Wi=[],Ji=[],Ki=!1,Qi=null,Zi=[],nr=new Set;function er(n){if(Xi)return;if(Qi)return;Ki=!0;const e=document.createElement("div");e.id="superchat-display",e.style.cssText="\n    position: fixed !important;\n    top: 50% !important;\n    left: 50% !important;\n    transform: translate(-50%, -35%) perspective(1000px) rotateY(90deg) !important;\n    width: 85% !important;\n    max-width: 450px !important;\n    z-index: 9999 !important;\n    opacity: 0 !important;\n    transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) !important;\n    pointer-events: none !important;\n  ";const t=n.amount||0;let o="1px",a="0.15",i="0.05",r="0.85";t>=1e3?(o="2px",a="0.4",i="0.15",r="1"):t>=500&&(o="1.5px",a="0.25",i="0.1",r="0.95"),e.innerHTML=`\n    \x3c!-- 磁带播放器风格SC卡片 --\x3e\n    <div style="\n      background: linear-gradient(135deg, rgba(12, 12, 12, 0.96) 0%, rgba(6, 6, 6, 0.96) 100%);\n      border: ${o} solid rgba(255, 255, 255, ${a});\n      border-radius: 3px;\n      padding: 0;\n      box-shadow: \n        0 8px 30px rgba(0, 0, 0, ${i}),\n        0 2px 10px rgba(0, 0, 0, 0.5),\n        inset 0 0.5px 0 rgba(255, 255, 255, 0.06);\n      backdrop-filter: blur(16px) saturate(110%);\n      display: flex;\n      position: relative;\n      overflow: hidden;\n    ">\n      \x3c!-- 扫描线效果 --\x3e\n      <div style="\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.01) 2px,\n          rgba(255, 255, 255, 0.01) 4px\n        );\n        pointer-events: none;\n        z-index: 10;\n      "></div>\n\n      \x3c!-- 顶部磁带孔装饰线 --\x3e\n      <div style="\n        position: absolute;\n        top: 0;\n        left: 20px;\n        right: 20px;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 4px,\n          rgba(255, 255, 255, 0.15) 4px,\n          rgba(255, 255, 255, 0.15) 6px\n        );\n        z-index: 1;\n      "></div>\n\n      \x3c!-- 左窗口：金额显示区（模拟磁带转盘窗口） --\x3e\n      <div style="\n        width: 90px;\n        flex-shrink: 0;\n        background: linear-gradient(180deg, rgba(0, 0, 0, 0.6) 0%, rgba(0, 0, 0, 0.8) 100%);\n        border-right: 1px solid rgba(255, 255, 255, 0.08);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 12px 10px;\n        position: relative;\n      ">\n        \x3c!-- 窗口边框装饰 --\x3e\n        <div style="\n          position: absolute;\n          top: 6px;\n          left: 6px;\n          right: 6px;\n          bottom: 6px;\n          border: 1px solid rgba(255, 255, 255, 0.06);\n          border-radius: 2px;\n        "></div>\n\n        \x3c!-- 转盘效果圆环 --\x3e\n        <div style="\n          width: 48px;\n          height: 48px;\n          border-radius: 50%;\n          border: 2px solid rgba(255, 255, 255, ${a});\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          position: relative;\n          margin-bottom: 8px;\n          animation: scRotate 3s linear infinite;\n        ">\n          \x3c!-- 内圈 --\x3e\n          <div style="\n            width: 16px;\n            height: 16px;\n            border-radius: 50%;\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n          "></div>\n          \n          \x3c!-- 转盘刻度线 --\x3e\n          <div style="\n            position: absolute;\n            width: 1.5px;\n            height: 16px;\n            background: rgba(255, 255, 255, 0.3);\n            top: 2px;\n            left: 50%;\n            transform: translateX(-50%);\n          "></div>\n          <div style="\n            position: absolute;\n            width: 1.5px;\n            height: 16px;\n            background: rgba(255, 255, 255, 0.15);\n            bottom: 2px;\n            left: 50%;\n            transform: translateX(-50%);\n          "></div>\n          <div style="\n            position: absolute;\n            width: 16px;\n            height: 1.5px;\n            background: rgba(255, 255, 255, 0.15);\n            left: 2px;\n            top: 50%;\n            transform: translateY(-50%);\n          "></div>\n          <div style="\n            position: absolute;\n            width: 16px;\n            height: 1.5px;\n            background: rgba(255, 255, 255, 0.15);\n            right: 2px;\n            top: 50%;\n            transform: translateY(-50%);\n          "></div>\n        </div>\n\n        \x3c!-- LED点阵风格金额显示 --\x3e\n        <div style="\n          font-size: 9px;\n          color: rgba(255, 255, 255, 0.4);\n          font-weight: 800;\n          letter-spacing: 1.5px;\n          font-family: 'Courier New', monospace;\n          margin-bottom: 3px;\n          text-transform: uppercase;\n        ">SUPER</div>\n        <div style="\n          font-size: 20px;\n          color: rgba(255, 255, 255, ${r});\n          font-weight: 900;\n          line-height: 1;\n          font-family: 'Courier New', monospace;\n          letter-spacing: 1px;\n          text-shadow: 0 0 10px rgba(255, 255, 255, ${i});\n        ">¥${t}</div>\n      </div>\n\n      \x3c!-- 右窗口：内容显示区 --\x3e\n      <div style="\n        flex: 1;\n        min-width: 0;\n        padding: 10px 12px;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        position: relative;\n      ">\n        \x3c!-- 用户信息条 --\x3e\n        <div style="\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          padding-bottom: 6px;\n          border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n        ">\n          \x3c!-- 用户头像 --\x3e\n          <div style="\n            width: 24px;\n            height: 24px;\n            border-radius: 50%;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            overflow: hidden;\n            flex-shrink: 0;\n            background: #000;\n          ">\n            <img src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg" style="\n              width: 100%;\n              height: 100%;\n              object-fit: cover;\n            " alt="${n.userName}">\n          </div>\n\n          \x3c!-- 用户名和时间 --\x3e\n          <div style="flex: 1; min-width: 0;">\n            <div style="\n              font-size: 11px;\n              color: rgba(255, 255, 255, 0.9);\n              font-weight: 700;\n              font-family: 'Courier New', monospace;\n              letter-spacing: 0.4px;\n              line-height: 1.3;\n            ">${n.userName}</div>\n            <div style="\n              font-size: 8px;\n              color: rgba(255, 255, 255, 0.35);\n              font-family: 'Courier New', monospace;\n              letter-spacing: 0.4px;\n              margin-top: 1px;\n            ">${n.userHandle} · ${n.time||"刚刚"}</div>\n          </div>\n\n          \x3c!-- 右侧装饰方块 --\x3e\n          <div style="\n            width: 5px;\n            height: 5px;\n            background: rgba(255, 255, 255, 0.15);\n            flex-shrink: 0;\n          "></div>\n        </div>\n\n        \x3c!-- SC消息内容 --\x3e\n        <div style="\n          font-size: 12px;\n          color: rgba(255, 255, 255, 0.88);\n          line-height: 1.6;\n          word-break: break-word;\n          font-family: 'Courier New', monospace;\n          font-weight: 500;\n          letter-spacing: 0.2px;\n        ">${n.content}</div>\n\n        \x3c!-- 底部装饰线 --\x3e\n        <div style="\n          position: absolute;\n          bottom: 3px;\n          left: 12px;\n          right: 12px;\n          height: 1px;\n          background: linear-gradient(\n            90deg,\n            transparent,\n            rgba(255, 255, 255, 0.08) 20%,\n            rgba(255, 255, 255, 0.08) 80%,\n            transparent\n          );\n        "></div>\n      </div>\n\n      \x3c!-- 右侧齿孔装饰 --\x3e\n      <div style="\n        position: absolute;\n        right: 0;\n        top: 0;\n        bottom: 0;\n        width: 8px;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 8px,\n          rgba(255, 255, 255, 0.03) 8px,\n          rgba(255, 255, 255, 0.03) 12px\n        );\n        border-left: 1px solid rgba(255, 255, 255, 0.04);\n      "></div>\n    </div>\n\n    \x3c!-- CSS动画 --\x3e\n    <style>\n      @keyframes scRotate {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n      }\n      \n      @media (max-width: 600px) {\n        #superchat-display {\n          width: 92% !important;\n          max-width: none !important;\n        }\n        #superchat-display > div {\n          flex-direction: row !important;\n        }\n        #superchat-display > div > div:first-child {\n          width: 80px !important;\n          padding: 10px 8px !important;\n        }\n        #superchat-display > div > div:first-child > div:first-child {\n          /* 转盘 */\n          width: 40px !important;\n          height: 40px !important;\n          margin-bottom: 6px !important;\n        }\n        #superchat-display > div > div:first-child > div:last-child > div:first-child {\n          /* SUPER文字 */\n          font-size: 8px !important;\n        }\n        #superchat-display > div > div:first-child > div:last-child > div:last-child {\n          /* 金额 */\n          font-size: 18px !important;\n        }\n        #superchat-display > div > div:nth-child(2) {\n          padding: 8px 10px !important;\n        }\n      }\n    </style>\n  `,document.body.appendChild(e),Qi=e,requestAnimationFrame(()=>{e.style.setProperty("transform","translate(-50%, -35%) perspective(1000px) rotateY(0deg)","important"),e.style.setProperty("opacity","1","important")}),setTimeout(()=>{e.style.setProperty("transform","translate(-50%, -35%) perspective(1000px) rotateY(-90deg)","important"),e.style.setProperty("opacity","0","important"),setTimeout(()=>{if(e&&e.parentNode&&e.parentNode.removeChild(e),Qi=null,Ki=!1,Ji.length>0){const n=Ji.shift();setTimeout(()=>er(n),350)}},600)},3500)}function tr(n){Ki?(Ji.push(n),console.log(`💰 [Super Chat] SC已加入队列，当前队列长度: ${Ji.length}`)):er(n)}function or(n){n&&0!==n.length&&(console.log(`💰 [Super Chat] 收到${n.length}条SC，加入智能触发队列`),function(n){if(!n||0===n.length)return;n.forEach((n,e)=>{n.id||(n.id=`sc_${Date.now()}_${e}_${Math.random().toString(36).substr(2,9)}`);Zi.find(e=>e.id===n.id)||nr.has(n.id)||Zi.push(n)})}(n))}function ar(n,e=0){if(0===Zi.length)return!1;const t=["SC","Super Chat","super chat","感谢","谢谢","多谢","非常感谢","打赏","支持","赞助","老板","大哥","大佬","土豪","富哥","刷了","刷","礼物","送了","送","来了"];if(n&&n.trim())for(const e of Zi)if(!nr.has(e.id)){if(e.userName&&n.includes(e.userName))return ir(e,`名字匹配(${e.userName})`),!0;if(e.userName&&e.userName.length>=2)for(let t=e.userName.length-1;t>=2;t--)for(let o=0;o<=e.userName.length-t;o++){const a=e.userName.substring(o,o+t);if(n.includes(a))return ir(e,`名字部分匹配(${a})`),!0}for(const o of t)if(n.includes(o))return ir(e,`关键词"${o}"`),!0}if(e>=5&&e%6==0){const n=Zi[0];if(n&&!nr.has(n.id))return ir(n,"时间触发"),!0}return!1}function ir(n,e){nr.add(n.id),Zi=Zi.filter(e=>e.id!==n.id),setTimeout(()=>{tr(n)},300)}async function rr(e,t){if(!e||!e.trim())return;if(Ra.isConnected)return void await async function(e,t){if(!e||!e.trim())return;const o=n.userProfileData?.name||"我";console.log(`🎙️ [连线发言] ${o}: ${e.trim()}`),function(e){const t=document.getElementById("userConnectionSpeechBubbles");if(!t)return void console.warn("⚠️ [连线发言] 未找到连线发言气泡容器");t.style.display="flex";const o=n.userProfileData?.name||"我",a=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",i=(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});for(;t.children.length>=2;){const n=t.lastChild;if(!n)break;t.removeChild(n)}const r=document.createElement("div");r.className="speech-bubble",r.innerHTML=`\n    <div class="bubble-content">\n      <img class="bubble-avatar" src="${a}" alt="${o}" />\n      <div class="bubble-text-area">\n        <div class="bubble-user-name">${o}</div>\n        <div class="bubble-speech-text">${e}</div>\n        <div class="bubble-time">${i}</div>\n      </div>\n    </div>\n  `,t.insertBefore(r,t.firstChild),setTimeout(()=>{t.contains(r)&&(r.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",r.style.opacity="0",r.style.transform="translateY(-8px) scale(0.95)",setTimeout(()=>{t.contains(r)&&(t.removeChild(r),0===t.children.length&&(t.style.display="none"))},300))},3e3),console.log(`📺 [连线发言] 用户发言气泡已显示: ${e}`)}(e.trim()),t&&(t.value="");ja.push(e.trim()),console.log(`📝 [连线发言] 已加入队列，当前队列: ${ja.length}条`);const a=Rn[Hn]||Rn.zh;if(Rl({title:"连线发言",message:a.danmakuSent||"连线发言已发送",leftIcon:"x",duration:2e3}),Ko&&Ko.details){const t={userName:o,userHandle:n.userProfileData?.handle||"@user",userAvatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",content:e.trim(),timestamp:(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),isUser:!0,isConnectionSpeech:!0};Ko.details.danmaku.unshift(t);try{await aa(Ko.id,Ko.details)}catch(n){console.error("⚠️ [连线发言] 保存失败:",n)}}}(e,t);const o=Rn[Hn]||Rn.zh,a=document.getElementById("danmakuList");if(!a)return;const i=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",r=n.userProfileData?.name||o.you||"我",s=document.createElement("div");s.style.cssText="\n      display: flex; \n      gap: 12px; \n      align-items: flex-start; \n      padding: 8px 0; \n      animation: fadeInUp 0.4s ease-out;\n      position: relative;\n    ",s.innerHTML=`\n      <img src="${i}" style="width: 34px; height: 34px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.25); flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2); filter: brightness(0.95) contrast(1.05); background: #000;" alt="${r}">\n      <div style="flex: 1; min-width: 0; padding-top: 2px;">\n        <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 800; margin-bottom: 4px; letter-spacing: 0.8px; text-transform: uppercase; font-family: 'Courier New', monospace;">${r}</div>\n        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.95); line-height: 1.6; word-break: break-word; letter-spacing: 0.3px; font-family: 'Courier New', monospace; font-weight: 600;">${e.trim()}</div>\n      </div>\n      <div style="position: absolute; bottom: 0; left: 48px; right: 0; height: 1px; background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), transparent);"></div>\n    `,a.appendChild(s),a.children.length>10&&a.removeChild(a.firstChild);const l=document.getElementById("danmaku-container");if(l&&(l.scrollTop=l.scrollHeight),Wi.push(e.trim()),Ko&&Ko.details){const t={userName:r,userHandle:n.userProfileData?.handle||"@user",userAvatar:i,content:e.trim(),timestamp:(new Date).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),isUser:!0};Ko.details.danmaku.unshift(t);try{await aa(Ko.id,Ko.details)}catch(n){console.error("⚠️ [用户弹幕] 保存失败:",n)}}t&&(t.value=""),Rl({title:"弹幕",message:o.danmakuSent||"弹幕已发送",leftIcon:"x",duration:2e3})}function sr(n){if(n&&n.type)try{switch(n.type){case"pause":ra&&!ra.paused&&ra.pause();break;case"resume":wa();break;case"replay":ra?(ra.currentTime=0,wa()):console.warn("⚠️ [音乐操作] 没有正在播放的歌曲，无法重播");break;case"switch":const e=n.songName;if(!e)return void console.warn("⚠️ [音乐操作] 切歌失败：未指定歌曲名");let t=null;for(const[n,o]of Object.entries(ta)){const a=o.find(n=>n.name===e||n.name.includes(e));if(a){t={...a,category:n};break}}t?(ya(t.url),wa()):console.warn(`⚠️ [音乐操作] 未找到歌曲: "${e}"`);break;default:console.warn(`⚠️ [音乐操作] 未知操作类型: ${n.type}`)}}catch(n){console.error("❌ [音乐操作] 执行失败:",n)}}n.sendDanmaku=rr,n.handleSendButtonClick=async function(){const n=document.getElementById("danmaku-input");n&&n.value&&n.value.trim()&&await rr(n.value,n),await cr()};let lr=!1;async function cr(){try{if(lr)return void console.log("⚠️ [AI互动] AI正在响应中，跳过本次请求");const n=Ra.isConnected,e=ja.length>0,t=Wi.length>0,o=mi.length>0,a=e||t||o;lr=!0,n&&e?Rl({title:"连线中",message:"主播正在回应您的连线...",leftIcon:"x",duration:2500}):a?mn("AI正在生成响应...","info"):(Rl({title:"观看直播",message:"观看直播中...",leftIcon:"x",duration:2e3}),console.log("🎬 [自反应模式] 用户无互动，触发直播间自反应"));let i="normal",r=Wi;n&&e&&(i="connectionSpeech",r=ja);const s=await oa(r,mi,i),l=Wi.length,c=ja.length,d=mi.length;if("connectionSpeech"===i?(ja=[],mi=[],console.log(`✅ [连线互动] 已清空缓存，本次响应${c}条连线发言 + ${d}个礼物`)):(Wi=[],mi=[],0===l&&0===d?console.log("🎬 [自反应模式] 无用户互动，直播间自主运行"):console.log(`✅ [AI互动] 已清空缓存，本次响应${l}条弹幕 + ${d}个礼物`)),console.log("🔄 [AI互动] 开始处理和播放新生成的内容..."),await qa(s),Ha.isActive&&s.pkScores){console.log("⚔️ [PK系统] 检测到AI返回的PK积分更新:",s.pkScores);const n=Ha.streamerScore,e=Ha.userScore,t=s.pkScores.streamer;ei(n,t,e,s.pkScores.user,!1)}if(Ha.isActive&&s.pkScoreChanges){console.log("⚔️ [PK系统] 检测到AI返回的PK积分增量:",s.pkScoreChanges);const n=Ha.streamerScore,e=Ha.userScore,t=s.pkScoreChanges.streamer||0,o=s.pkScoreChanges.user||0,a=n+t,i=e+o;console.log(`📊 [PK积分变化] 主播: ${n} → ${a} (${t>0?"+":""}${t})`),console.log(`📊 [PK积分变化] 用户: ${e} → ${i} (${o>0?"+":""}${o})`),s.pkScoreChanges.reason&&console.log(`💡 [积分变化原因] ${s.pkScoreChanges.reason}`),ei(n,a,e,i,!1)}Rl({title:"AI响应",message:"AI响应已生成",leftIcon:"x",duration:2e3}),console.log("✅ [AI互动] 直播间新内容开始播放")}catch(n){console.error("❌ [AI互动] 生成失败:",n),mn("AI响应失败: "+n.message,"error")}finally{lr=!1}}function dr(){const n=document.getElementById("like-animation-container");if(!n)return;const e=document.createElement("div"),t=20+10*Math.random(),o=30*Math.random();e.style.cssText=`\n      position: absolute;\n      bottom: 0;\n      left: ${o}px;\n      animation: floatUp 2s ease-out forwards;\n    `,e.innerHTML=`\n      <svg viewBox="0 0 24 24" style="width: ${t}px; height: ${t}px; fill: rgba(255,255,255,0.8);">\n        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n      </svg>\n    `,n.appendChild(e),setTimeout(()=>e.remove(),2e3)}function pr(){mn("直播间菜单功能开发中...","info")}function gr(){const e=document.getElementById("live-page-user-avatar");e&&n.userProfileData&&n.userProfileData.avatar&&(e.src=n.userProfileData.avatar)}async function mr(n=[]){try{console.log("🎭 [角色头像] 开始同步角色头像和直播状态...");const t=e(),o=await t.xCharacterProfiles.toArray();let a=[];try{const{xSettings:n}=await g.loadConfigAndSettings();a=n.boundCharacters||[]}catch(n){console.warn("⚠️ [角色头像] 获取绑定角色失败:",n),a=[]}const i=[];for(const e of a){const t=o.find(n=>n.characterId===e);if(t){const o=n.some(n=>n.characterId===e);i.push({characterId:e,name:t.xName,handle:t.xHandle,avatar:t.xAvatar,isLive:o,xProfile:t})}}i.sort((n,e)=>n.isLive&&!e.isLive?-1:!n.isLive&&e.isLive?1:0);let r=document.querySelector("#x-live-page > div:nth-child(2)");if(!r){if(console.warn("⚠️ [角色头像] 未找到头像容器，尝试备用选择器..."),r=document.querySelector('#x-live-page div[style*="overflow-x: auto"][style*="padding: 8px 16px"]'),!r)return void console.error("❌ [角色头像] 完全未找到头像容器");console.log("✅ [角色头像] 使用备用选择器找到容器")}if(0===i.length)r.innerHTML='\n          <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 64px;">\n            <div style="width: 56px; height: 56px; border-radius: 50%; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; background-color: rgba(255,255,255,0.1);">\n              <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #71767b;">\n                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>\n              </svg>\n            </div>\n            <span style="color: #71767b; font-size: 12px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 60px;">暂无角色</span>\n          </div>\n        ';else{const e=i.map((n,e)=>{const t=n.isLive?"box-shadow: 0 0 0 3px var(--x-accent), 0 0 15px var(--x-accent); animation: liveGlow 2s ease-in-out infinite;":"";return`\n            <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 64px; margin-right: ${e<i.length-1?"12px":"0"};">\n              <div style="width: 56px; height: 56px; border-radius: 50%; overflow: hidden; position: relative; ${t}" \n                   title="${n.name} ${n.isLive?"(正在直播)":""}"\n                   onclick="handleLiveCharacterClick('${n.characterId}', ${n.isLive})">\n                <img src="${n.avatar}" \n                     style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;"\n                     alt="${n.name}">\n                ${n.isLive?'\n                  <div style="position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; background-color: var(--x-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 3px solid #0f0f0f;">\n                    <div style="width: 8px; height: 8px; background-color: #fff; border-radius: 50%; animation: pulse 2s infinite;"></div>\n                  </div>\n                ':""}\n              </div>\n              <span style="color: ${n.isLive?"var(--x-accent)":"#fff"}; font-size: 12px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 60px; font-weight: ${n.isLive?"600":"400"};">\n                ${n.name}\n              </span>\n            </div>\n          `}).join("");if(r.innerHTML=e,n.length>0){if(!document.getElementById("live-glow-style")){const n=document.createElement("style");n.id="live-glow-style",n.textContent="\n              @keyframes liveGlow {\n                0% { box-shadow: 0 0 0 3px var(--x-accent), 0 0 15px var(--x-accent); }\n                50% { box-shadow: 0 0 0 3px var(--x-accent), 0 0 25px var(--x-accent); }\n                100% { box-shadow: 0 0 0 3px var(--x-accent), 0 0 15px var(--x-accent); }\n              }\n            ",document.head.appendChild(n)}}}const s=i.filter(n=>n.isLive).length;console.log(`✅ [角色头像] 同步完成，共${i.length}个角色，${s}个正在直播`)}catch(n){console.error("❌ [角色头像] 同步失败:",n)}}function xr(n){if(n&&n.target!==n.currentTarget)return;const e=document.getElementById("live-category-manager-modal");e&&(e.style.display="none",document.body.style.overflow="auto")}function ur(){const n=document.getElementById("live-custom-categories-list");n&&(0!==Xo.length?n.innerHTML=Xo.map(n=>`\n      <div style="background-color: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.1);">\n        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">\n          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">\n            <label style="display: flex; align-items: center; cursor: pointer;">\n              <input type="checkbox" ${n.enabled?"checked":""} \n                onchange="toggleLiveCategory('${n.id}')"\n                style="width: 18px; height: 18px; accent-color: var(--x-accent);">\n            </label>\n            <input type="text" placeholder="分类名称" value="${n.name}" \n              onchange="updateLiveCategoryName('${n.id}', this.value)"\n              style="flex: 1; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; padding: 8px 12px; font-size: 14px; outline: none;"\n              onfocus="this.style.borderColor='var(--x-accent)'"\n              onblur="this.style.borderColor='rgba(255,255,255,0.2)'">\n          </div>\n          <button onclick="deleteLiveCategory('${n.id}')" \n            style="background: transparent; border: 1px solid #f4212e; color: #f4212e; border-radius: 8px; padding: 6px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s;"\n            onmouseover="this.style.backgroundColor='rgba(244,33,46,0.1)'"\n            onmouseout="this.style.backgroundColor='transparent'">\n            删除\n          </button>\n        </div>\n        <textarea placeholder="分类描述（可选）" \n          onchange="updateLiveCategoryDescription('${n.id}', this.value)"\n          style="width: 100%; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; padding: 8px 12px; font-size: 14px; resize: vertical; min-height: 60px; outline: none; font-family: inherit;"\n          onfocus="this.style.borderColor='var(--x-accent)'"\n          onblur="this.style.borderColor='rgba(255,255,255,0.2)'">${n.description}</textarea>\n      </div>\n    `).join(""):n.innerHTML='\n        <div style="text-align: center; padding: 40px 20px; color: #71767b;">\n          <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: currentColor; margin-bottom: 16px; opacity: 0.5;">\n            <path d="M19.5 12.75h-6.75V19.5h-1.5v-6.75H4.5v-1.5h6.75V4.5h1.5v6.75h6.75v1.5z"></path>\n          </svg>\n          <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">暂无自定义分类</div>\n          <div style="font-size: 14px;">点击"添加分类"开始创建</div>\n        </div>\n      ')}async function hr(){try{const n=e(),t=await n.xTweetsData.get("liveStreams");if(t){const n=new Date(t.lastUpdated),e=new Date;if((e-n)/36e5>99999)return void console.log("🕐 [直播数据] 数据已过期，使用默认数据");t.audio&&(Go.audio=t.audio),t.video&&(Go.video=t.video),Object.keys(t).forEach(n=>{"id"!==n&&"audio"!==n&&"video"!==n&&"lastUpdated"!==n&&(Go[n]=t[n])}),console.log("✅ [直播数据] 已加载保存的直播数据")}else console.log("ℹ️ [直播数据] 未找到保存的直播数据，使用默认数据")}catch(n){console.error("❌ [直播数据] 加载失败:",n)}}async function fr(){try{const n=e(),t=`liveCharacterStatus_${vt||"main"}`,o=await n.xSettings.get(t);if(o&&o.liveCharacters){const e=new Date(o.lastUpdated),a=new Date;if((a-e)/36e5>9999999)return await n.xSettings.delete(t),[];let i=[];try{const e=`xSettings_${vt||"main"}`,t=await n.xSettings.get(e);i=t?.boundCharacters||[],console.log("📋 [直播状态加载] 当前绑定角色数:",i.length)}catch(n){console.warn("⚠️ [直播状态加载] 获取绑定角色列表失败:",n)}const r=o.liveCharacters.filter(n=>{const e=i.includes(n.characterId);return e||console.log(`🔍 [直播状态过滤] 跳过未绑定角色: ${n.characterId}`),e});return console.log(`📡 [直播状态加载] 原始: ${o.liveCharacters.length}个，过滤后: ${r.length}个`),r}return[]}catch(n){return console.error("❌ [直播状态] 加载失败:",n),[]}}async function br(n){try{const t=e(),o=`liveCharacterStatus_${vt||"main"}`;await t.xSettings.put({id:o,liveCharacters:n,lastUpdated:(new Date).toISOString()})}catch(n){console.error("❌ [直播状态] 保存失败:",n)}}function vr(){const n=document.getElementById("live-categories-container");if(!n)return;n.querySelectorAll(".live-custom-tab").forEach(n=>n.remove());const e=Xo.filter(n=>n.enabled&&n.name.trim()),t=n.querySelector(".live-add-category-btn");e.forEach(e=>{const o=document.createElement("div");o.className="live-tab live-custom-tab",o.onclick=()=>Yo(e.id),o.style.cssText="\n        padding: 8px 12px; \n        background-color: rgba(255,255,255,0.1); \n        border-radius: 16px; \n        font-size: 14px; \n        font-weight: 500; \n        cursor: pointer; \n        color: #71767b;\n        white-space: nowrap;\n      ",o.innerHTML=`<span>${e.name}</span>`,n.insertBefore(o,t)})}n.triggerAIResponse=cr,n.sendLike=dr,n.showLiveRoomMenu=pr;const yr=[{id:"package_1",amount:1e3,points:120,originalPoints:100,bonus:20,title:"聪明人的试探",subtitle:"就尝一口 不会上瘾的",description:"您这么理智 肯定只充一次对吧"},{id:"package_2",amount:5e3,points:650,originalPoints:500,bonus:150,title:"有品位者之选",subtitle:"一看就是懂行的 不差这点",description:"您的气质配得上更贵的套餐"},{id:"package_3",amount:1e4,points:1500,originalPoints:1e3,bonus:500,title:"人生赢家专属",subtitle:"成功人士都选这个 您懂的",description:"投资自己才是真正的投资"},{id:"package_4",amount:5e4,points:8e3,originalPoints:5e3,bonus:3e3,title:"顶级玩家认证",subtitle:"只有1%的人配拥有这个",description:"恭喜您 终于找到了属于您的位置"}];async function wr(){try{const t=e(),o=`wallet_${n.currentAccountId||"main"}`,a=await t.xAccountProfiles.get(o);return a&&a.data?{balance:a.data.balance||0,isActivated:a.data.isActivated||!1,data:a.data}:{balance:0,isActivated:!1,data:null}}catch(n){return console.error("💰 [获取钱包余额] 失败:",n),{balance:0,isActivated:!1,data:null}}}async function kr(t){try{const o=e(),a=n.currentAccountId||"main",i=`wallet_${a}`;return await o.xAccountProfiles.put({handle:i,name:"wallet",accountId:a,data:t,updatedAt:(new Date).toISOString()}),!0}catch(n){return console.error("💰 [保存钱包余额] 失败:",n),!1}}function $r(n,e){const t=document.getElementById("rechargeCurrentPoints"),o=document.getElementById("rechargeWalletBalance");t&&(t.textContent=n.toLocaleString()),o&&(o.textContent=`$${e.toFixed(2)}`);const a=document.getElementById("giftPointsValue");a&&(a.textContent=n.toLocaleString()),document.querySelectorAll(".package-card").forEach(n=>{const t=parseFloat(n.querySelector(".package-amount")?.textContent.replace(/[$,]/g,""))||0;if(e>=t){n.classList.remove("insufficient");const e=n.querySelector(".package-insufficient-mask");e&&e.remove()}else if(n.classList.add("insufficient"),!n.querySelector(".package-insufficient-mask")){const e=document.createElement("div");e.className="package-insufficient-mask",e.textContent="余额不足",n.appendChild(e)}})}function Cr(){mn("钱包余额不足，请先充值钱包","error")}let Ir={isOpen:!1,isGenerating:!1,currentData:null};function Sr(){if(!Ir.isOpen)return;const n=document.getElementById("fanClubOverlay"),e=document.getElementById("fanClubPanel");n&&n.classList.remove("active"),e&&e.classList.remove("active"),setTimeout(()=>{const n=document.getElementById("fanClubContainer");n&&n.remove(),Ir.isOpen=!1,Ir.currentData=null},400)}async function Mr(n){const t=document.getElementById("fanClubPanel");if(!t)return;let o=null;try{const n=e(),t=Ko?.streamerHandle;if(t){const e=r.clean(t);o=await n.xFanClubMemberships.get(e)}}catch(n){console.error("❌ [粉丝团] 获取会员状态失败:",n)}t.innerHTML=`\n    \x3c!-- VIP卡片头部 - 磁带纹理 --\x3e\n    <div class="fanclub-vip-header">\n      \x3c!-- 磁带装饰条 --\x3e\n      <div class="tape-stripe tape-stripe-top"></div>\n      <div class="tape-stripe tape-stripe-bottom"></div>\n      \n      \x3c!-- 旋转磁带轮装饰 --\x3e\n      <div class="tape-reel-deco tape-reel-left">\n        <div class="reel-spin"></div>\n      </div>\n      <div class="tape-reel-deco tape-reel-right">\n        <div class="reel-spin"></div>\n      </div>\n      \n      \x3c!-- 粉丝团名称 --\x3e\n      <div class="vip-badge-container">\n        <div class="vip-badge">\n          <div class="badge-glow"></div>\n          <div class="badge-text">${n.clubName}</div>\n        </div>\n      </div>\n      \n      \x3c!-- 关闭按钮 --\x3e\n      <div class="fanclub-close-btn" onclick="closeFanClub()">\n        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n          <line x1="18" y1="6" x2="6" y2="18"/>\n          <line x1="6" y1="6" x2="18" y2="18"/>\n        </svg>\n      </div>\n    </div>\n\n    \x3c!-- LCD显示屏统计区 --\x3e\n    <div class="fanclub-lcd-panel">\n      \x3c!-- 扫描线动画 --\x3e\n      <div class="lcd-scanline"></div>\n      \n      \x3c!-- LCD数字显示 --\x3e\n      <div class="lcd-display-grid">\n        <div class="lcd-stat">\n          <div class="lcd-stat-icon">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">\n              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>\n              <circle cx="9" cy="7" r="4"/>\n              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>\n              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>\n            </svg>\n          </div>\n          <div class="lcd-stat-label">MEMBERS</div>\n          <div class="lcd-stat-value" data-target="${n.memberCount}">0</div>\n        </div>\n        \n        <div class="lcd-stat">\n          <div class="lcd-stat-icon">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">\n              <circle cx="12" cy="12" r="10"/>\n              <path d="M12 6v6l4 2"/>\n            </svg>\n          </div>\n          <div class="lcd-stat-label">CONTRIBUTION</div>\n          <div class="lcd-stat-value" data-target="${n.totalContribution}">0</div>\n          <div class="lcd-stat-unit">P</div>\n        </div>\n        \n        <div class="lcd-stat">\n          <div class="lcd-stat-icon">\n            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">\n              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>\n            </svg>\n          </div>\n          <div class="lcd-stat-label">PLATFORM RANK</div>\n          <div class="lcd-stat-value rank-value" data-target="${n.platformRank}">#0</div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- 可滚动内容容器 --\x3e\n    <div class="fanclub-content-scroll">\n    \x3c!-- 会员交互区 --\x3e\n    <div id="fanClubInteractionArea" class="fanclub-interaction-area">\n      ${o&&o.joined?Dr(o):Pr()}\n    </div>\n\n    \x3c!-- 徽章等级系统 --\x3e\n    <div class="fanclub-badges-section">\n      \x3c!-- 分隔装饰 --\x3e\n      <div class="section-divider">\n        <div class="divider-line"></div>\n        <div class="divider-label">\n          <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2;">\n            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>\n          </svg>\n          <span>MEMBERSHIP TIERS</span>\n          <span class="tier-count">20</span>\n        </div>\n        <div class="divider-line"></div>\n      </div>\n      \n      \x3c!-- 徽章卡片列表 --\x3e\n      <div class="badges-list">\n        ${n.levelSystem.map((n,e)=>{const t=n.level<=5?"bronze":n.level<=10?"silver":n.level<=15?"gold":"platinum";return`\n          <div class="badge-card" data-level="${n.level}" data-tier="${t}">\n            \x3c!-- 卡片光晕 --\x3e\n            <div class="card-glow ${t}-glow"></div>\n            \n            \x3c!-- 磁条装饰 --\x3e\n            <div class="card-magnetic-strip"></div>\n            \n            \x3c!-- 等级徽章 --\x3e\n            <div class="badge-emblem">\n              <div class="emblem-ring"></div>\n              <div class="emblem-number">\n                <span class="level-prefix">LV</span>\n                <span class="level-num">${n.level}</span>\n              </div>\n              <div class="emblem-shine"></div>\n            </div>\n            \n            \x3c!-- 卡片内容 --\x3e\n            <div class="badge-content">\n              <div class="badge-title">${n.levelName}</div>\n              \n              <div class="badge-details">\n                <div class="detail-row requirement-row">\n                  <div class="detail-icon">\n                    <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n                      <polyline points="20 6 9 17 4 12"/>\n                    </svg>\n                  </div>\n                  <div class="detail-text">${n.requirement}</div>\n                </div>\n                \n                <div class="detail-row benefit-row">\n                  <div class="detail-icon">\n                    <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2.5;">\n                      <path d="M20 12v8H4v-8M22 7h-6l-2-2H10L8 7H2"/>\n                      <circle cx="12" cy="13" r="3"/>\n                    </svg>\n                  </div>\n                  <div class="detail-text">${n.benefit}</div>\n                </div>\n              </div>\n            </div>\n            \n            \x3c!-- 全息扫光效果 --\x3e\n            <div class="hologram-sweep"></div>\n          </div>\n        `}).join("")}\n      </div>\n      </div>\n    </div>\n  `,setTimeout(()=>{t.querySelectorAll(".lcd-stat-value").forEach(n=>{const e=parseInt(n.dataset.target);if(isNaN(e))return;const t=n.classList.contains("rank-value"),o=Math.ceil(e/30);let a=0;const i=setInterval(()=>{a+=o,a>=e&&(a=e,clearInterval(i)),n.textContent=t?`#${a.toLocaleString()}`:a.toLocaleString()},50)});t.querySelectorAll(".badge-card").forEach((n,e)=>{setTimeout(()=>{n.style.opacity="1",n.style.transform="perspective(1000px) rotateY(0deg) scale(1)"},800+40*e)});t.querySelectorAll(".reel-spin").forEach(n=>{n.classList.add("spinning")})},150)}function Tr(){const n=new Date,e=new Date(n.getTime()+288e5+60*n.getTimezoneOffset()*1e3);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}async function Ar(n){try{const t=e(),o=Tr(),a=r.clean(n),i=await t.xFanClubMemberships.get(a);if(!i||!i.joined)throw new Error("您还未加入粉丝团");if(i.lastCheckinDate===o)return mn("今日已签到过了","info"),i;const s=function(n){const e=new Date(n),t=new Date(e.getTime()-864e5),o=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${o}-${a}-${i}`}(o),l=i.lastCheckinDate===s?i.checkinDays+1:1,c=i.points+10;i.checkinDays=l,i.lastCheckinDate=o,i.points=c,i.checkinHistory=[...i.checkinHistory||[],o];const d=i.level,p=await Er(c,a),g=p>d;g&&(i.level=p,console.log(`🎉 [会员系统] 等级提升: LV${d} -> LV${p}`)),await t.xFanClubMemberships.put(i);try{const n=await t.xFanClubs.get(a);if(n&&n.data&&n.data.messages&&n.data.messages.checkin){const e=n.data.messages.checkin;Rr(e[Math.floor(Math.random()*e.length)],"checkin")}}catch(n){console.warn("⚠️ [会员系统] 获取签到留言失败:",n)}return g&&setTimeout(async()=>{try{const t=e(),o=await t.xFanClubs.get(a);if(o&&o.data&&o.data.levelSystem&&o.data.messages){const e=o.data.levelSystem.find(n=>n.level===p);if(e&&o.data.messages.levelUp){let t=o.data.messages.levelUp;if(Array.isArray(t)){p<=7&&t.length>=3?t=t.slice(0,3):p<=14&&t.length>=6?t=t.slice(3,6):t.length>=9&&(t=t.slice(6,9));var n=t[Math.floor(Math.random()*t.length)]}else n=t;Rr(n.replace("{level}",p).replace("{levelName}",e.levelName),"levelup")}}}catch(n){console.warn("⚠️ [会员系统] 获取升级留言失败:",n)}},2e3),await Lr(a,{checkinSuccess:!0,pointsAdded:10,checkinDaysChanged:!0,oldCheckinDays:i.checkinDays-1,newCheckinDays:i.checkinDays}),mn(`签到成功！连续${l}天，获得10积分`,"success"),i}catch(n){throw console.error("❌ [会员系统] 签到失败:",n),mn(`签到失败: ${n.message}`,"error"),n}}async function Er(n,t){try{const o=e(),a=r.clean(t),i=await o.xFanClubs.get(a);if(!i||!i.data||!i.data.levelSystem)return console.warn(`⚠️ [等级计算] 粉丝团数据不存在: ${a}`),0;const s=i.data.levelSystem;let l=0;for(let e=s.length-1;e>=0;e--){const t=s[e];if(n>=(t.requiredPoints||zr(t.requirement))){l=t.level;break}}return l}catch(n){return console.error("❌ [等级计算] 计算失败:",n),0}}function zr(n){if(!n)return 0;const e=n.match(/(\d+)/),t=e?parseInt(e[1]):0;return 0===t&&console.warn(`⚠️ [积分提取] 无法从 "${n}" 提取积分`),t}async function Br(n){if(Ir.isOpen)try{const t=e(),o=r.clean(n);console.log(`🔄 [会员UI刷新] 查询handle: "${o}"`);const a=await t.xFanClubMemberships.get(o);console.log("🔄 [会员UI刷新] 会员状态:",a?"已加入":"未加入");const i=document.getElementById("fanClubInteractionArea");if(!i)return;a&&a.joined?i.innerHTML=Dr(a):i.innerHTML=Pr()}catch(n){console.error("❌ [会员系统] UI刷新失败:",n)}}async function Lr(n,t={}){if(Ir.isOpen)try{const o=e(),a=await o.xFanClubMemberships.get(n),i=document.getElementById("fanClubInteractionArea");if(!i||!a||!a.joined)return void await Br(n);if(i.innerHTML=Dr(a),await new Promise(n=>setTimeout(n,50)),t.checkinSuccess){const n=document.querySelector(".checkin-panel .label-led");n&&(n.classList.add("flash-success"),setTimeout(()=>n.classList.remove("flash-success"),600));const e=document.querySelector(".punch-btn");if(e&&(e.classList.add("success-glow"),setTimeout(()=>e.classList.remove("success-glow"),800)),e&&t.pointsAdded){const n=document.createElement("div");n.className="floating-points",n.textContent=`+${t.pointsAdded}`,e.appendChild(n),setTimeout(()=>n.remove(),1200)}}else if(t.pointsAdded&&!t.checkinSuccess){const n=document.querySelector(".led-display");if(n){const e=document.createElement("div");e.className="floating-points",e.textContent=`+${t.pointsAdded}`,e.style.top="-10px",n.style.position="relative",n.appendChild(e),setTimeout(()=>e.remove(),1200)}}if(t.checkinDaysChanged){document.querySelectorAll(".flip-card").forEach((n,e)=>{setTimeout(()=>{n.classList.add("flipping"),setTimeout(()=>n.classList.remove("flipping"),600)},100*e)})}if(t.pointsAdded){const n=document.querySelector(".led-digits");n&&(n.classList.add("counting","glow-boost"),setTimeout(()=>{n.classList.remove("counting")},800),setTimeout(()=>{n.classList.remove("glow-boost")},600));const e=document.querySelector(".vu-needle");e&&(e.classList.add("impact"),setTimeout(()=>e.classList.remove("impact"),1e3))}}catch(e){console.error("❌ [会员系统] 动画UI刷新失败:",e),await Br(n)}}function Pr(){return'\n    <div class="fanclub-join-section">\n      <div class="join-card">\n        <div class="join-icon">\n          <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; stroke: currentColor; fill: none; stroke-width: 2;">\n            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>\n            <circle cx="8.5" cy="7" r="4"/>\n            <line x1="20" y1="8" x2="20" y2="14"/>\n            <line x1="23" y1="11" x2="17" y2="11"/>\n          </svg>\n        </div>\n        <div class="join-content">\n          <div class="join-title">加入粉丝团</div>\n          <div class="join-desc">成为专属会员，享受特权福利</div>\n        </div>\n        <button class="join-btn" onclick="handleJoinClick()">\n          <span class="btn-text">立即加入</span>\n        </button>\n      </div>\n    </div>\n  '}function Dr(n){const e=Tr(),t=n.lastCheckinDate!==e,o=function(n){if(!Ir.currentData||!Ir.currentData.levelSystem)return null;const e=Ir.currentData.levelSystem.find(e=>e.level===n+1);e&&!e.requiredPoints&&(e.requiredPoints=zr(e.requirement));return e}(n.level),a=Ir.currentData.levelSystem.find(e=>e.level===n.level),i=o?Math.min(100,n.points/o.requiredPoints*100):100;return`\n    <div class="fanclub-member-section">\n      \x3c!-- 左侧：签到区 - 机械计数器风格 --\x3e\n      <div class="member-panel checkin-panel">\n        \x3c!-- 机械外壳装饰 --\x3e\n        <div class="panel-frame">\n          <div class="frame-screw frame-screw-tl"></div>\n          <div class="frame-screw frame-screw-tr"></div>\n          <div class="frame-screw frame-screw-bl"></div>\n          <div class="frame-screw frame-screw-br"></div>\n          </div>\n        \n        \x3c!-- 标题栏 --\x3e\n        <div class="panel-label">\n          <div class="label-text">CHECK-IN</div>\n          <div class="label-led ${t?"led-pending":"led-done"}"></div>\n        </div>\n        \n        \x3c!-- 机械翻牌计数器 --\x3e\n        <div class="flip-counter">\n          <div class="counter-label">CONSECUTIVE DAYS</div>\n          <div class="flip-digits">\n            ${Nr(Math.floor(n.checkinDays/100))}\n            ${Nr(Math.floor(n.checkinDays%100/10))}\n            ${Nr(n.checkinDays%10)}\n            </div>\n            </div>\n        \n        \x3c!-- 打卡按钮 --\x3e\n        <button class="punch-btn ${t?"":"disabled"}" \n                onclick="handleCheckinClick()" \n                ${t?"":"disabled"}>\n          <div class="btn-shadow"></div>\n          <div class="btn-surface">\n            <div class="btn-label">${t?"PUNCH IN":"DONE"}</div>\n            <div class="btn-reward">${t?"+10 PTS":"---"}</div>\n          </div>\n          </button>\n        </div>\n      \n      \x3c!-- 右侧：积分/等级区 - VU表仪表盘风格 --\x3e\n      <div class="member-panel points-panel">\n        \x3c!-- 机械外壳装饰 --\x3e\n        <div class="panel-frame">\n          <div class="frame-screw frame-screw-tl"></div>\n          <div class="frame-screw frame-screw-tr"></div>\n          <div class="frame-screw frame-screw-bl"></div>\n          <div class="frame-screw frame-screw-br"></div>\n      </div>\n      \n        \x3c!-- 标题栏 --\x3e\n        <div class="panel-label">\n          <div class="label-text">LEVEL METER</div>\n          <div class="level-badge">LV${n.level}</div>\n          </div>\n        \n        \x3c!-- LED点阵显示积分 --\x3e\n        <div class="led-display">\n          <div class="led-label">TOTAL POINTS</div>\n          <div class="led-digits">\n            ${n.points.toLocaleString()}\n        </div>\n              ${a?`<div class="led-sublabel">${a.levelName}</div>`:""}\n            </div>\n        \n        \x3c!-- VU表进度条 --\x3e\n        <div class="vu-meter">\n          ${o?`\n          <div class="vu-info">\n            <span class="vu-label">TO LV${o.level}</span>\n            <span class="vu-need">${(o.requiredPoints-n.points).toLocaleString()}</span>\n              </div>\n          <div class="vu-bar">\n            \x3c!-- 刻度线 --\x3e\n            <div class="vu-scale">\n              ${Array.from({length:11},(n,e)=>`<div class="scale-mark" style="left: ${10*e}%"></div>`).join("")}\n            </div>\n            \x3c!-- 进度填充 --\x3e\n            <div class="vu-fill" style="width: ${i}%">\n              <div class="vu-glow"></div>\n            </div>\n            \x3c!-- 指针 --\x3e\n            <div class="vu-needle" style="left: ${i}%">\n              <div class="needle-head"></div>\n              </div>\n            </div>\n          `:'\n          <div class="max-level-badge">\n            <div class="badge-shine"></div>\n            <div class="badge-icon">★</div>\n            <div class="badge-text">MAX LEVEL</div>\n            </div>\n          '}\n        </div>\n      </div>\n    </div>\n  `}function Nr(n){return`\n    <div class="flip-digit">\n      <div class="flip-card">\n        <div class="flip-top">${n}</div>\n        <div class="flip-bottom">${n}</div>\n        <div class="flip-divider"></div>\n      </div>\n    </div>\n  `}function Rr(n,e){console.log(`💬 [粉丝团留言-${e}] ${n}`);const t=!!document.getElementById("live-room-page"),o=document.querySelector(".fanclub-notification-message");o&&(o.style.opacity="0",o.style.transform="translateX(-50%) translateY(-30px)",setTimeout(()=>o.remove(),300));const a=document.createElement("div");a.className="fanclub-notification-message",a.style.cssText=`\n    position: fixed;\n    top: ${t?"80px":"60px"};\n    left: 50%;\n    transform: translateX(-50%) translateY(-20px);\n    width: 90%;\n    max-width: 400px;\n    background: linear-gradient(135deg, rgba(18, 18, 18, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);\n    border: 2px solid rgba(255, 255, 255, 0.15);\n    border-radius: 12px;\n    padding: 16px;\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9),\n                inset 0 1px 0 rgba(255, 255, 255, 0.05);\n    z-index: ${t?"999998":"10000"};\n    display: flex;\n    align-items: flex-start;\n    gap: 12px;\n    opacity: 0;\n    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n    font-family: 'Courier New', monospace;\n    backdrop-filter: blur(10px);\n    -webkit-backdrop-filter: blur(10px);\n    pointer-events: auto;\n  `;const i="levelup"===e?"rgba(255, 215, 0, 0.9)":"welcome"===e?"rgba(100, 200, 255, 0.9)":"rgba(200, 200, 200, 0.9)";a.innerHTML=`\n    <div style="\n      flex-shrink: 0;\n      width: 36px;\n      height: 36px;\n      border-radius: 8px;\n      background: rgba(255, 255, 255, 0.08);\n      border: 1px solid rgba(255, 255, 255, 0.15);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);\n    ">\n      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: ${i}; fill: none; stroke-width: 2;">\n        ${"levelup"===e?'<path d="M12 2L15 8L22 9L17 14L18 21L12 18L6 21L7 14L2 9L9 8L12 2Z"/>':'<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>'}\n      </svg>\n    </div>\n    <div style="\n      flex: 1;\n      min-width: 0;\n      padding-top: 2px;\n    ">\n      <div style="\n        font-size: 10px;\n        font-weight: 900;\n        letter-spacing: 2px;\n        color: rgba(255, 255, 255, 0.5);\n        text-transform: uppercase;\n        margin-bottom: 6px;\n      ">${"levelup"===e?"LEVEL UP":"welcome"===e?"WELCOME":"MESSAGE"}</div>\n      <div style="\n        font-size: 12px;\n        line-height: 1.6;\n        color: rgba(255, 255, 255, 0.95);\n        word-wrap: break-word;\n      ">${n}</div>\n    </div>\n    <div onclick="this.parentElement.remove()" style="\n      flex-shrink: 0;\n      width: 24px;\n      height: 24px;\n      border-radius: 4px;\n      background: rgba(255, 255, 255, 0.06);\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      font-size: 18px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.6);\n      transition: all 0.2s ease;\n      user-select: none;\n    " onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.color='rgba(255, 255, 255, 0.9)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.06)'; this.style.color='rgba(255, 255, 255, 0.6)';">×</div>\n  `,document.body.appendChild(a),setTimeout(()=>{a.style.opacity="1",a.style.transform="translateX(-50%) translateY(0)"},10);setTimeout(()=>{a.style.opacity="0",a.style.transform="translateX(-50%) translateY(-20px)",setTimeout(()=>a.remove(),400)},"welcome"===e?8e3:"levelup"===e?6e3:5e3)}async function Hr(o,a,i){try{console.log("🎤 [主播私联] 检测触发条件",{streamerHandle:o,trigger:a,userData:i});const s=`${o}_${a}`;if(n.streamerContactMessageCache[s])return void console.log("⚠️ [主播私联] 已有待处理的私联消息，跳过");const l=e();if(!l)return void console.error("❌ [主播私联] 无法获取数据库实例");const c=r.clean(o),d=`xSettings_${vt||"main"}`,p=await l.xSettings.get(d),g=p?.boundCharacters||[];if(g.length>0){const n=t();if(n){const e=(await n.chats.toArray()).filter(n=>!n.isGroup&&g.includes(n.id));for(const n of e){const e=await l.xCharacterProfiles.get(n.id);if(e&&e.xHandle){if(r.clean(e.xHandle)===c)return void console.log("✅ [主播私联] 主播是已绑定角色，跳过私联（已可随意私信）")}}}}const m=`messagesList_${vt||"main"}`,x=await l.xAccountProfiles.get(m);if((x?.data||[]).some(n=>r.clean(n.userHandle)===c))return void console.log("✅ [主播私联] 主播已在联系人列表，跳过私联（已可随意私信）");console.log("🆕 [主播私联] 主播是陌生人/随机主播，可以触发私联");let u=!1,h=!1,f=!1,b={};if("giftRank"===a){if(!Ko||!Ko.details)return void console.error("❌ [主播私联] 无法获取当前直播间数据");const n=Ko.details;if(!n||!n.giftRankContactConfig)return void console.log("⚠️ [主播私联] 主播未配置礼物榜私联");const e=n.giftRankContactConfig;u=e.willContactPrivately,f=e.persistAfterRejection;const t=i.giftRank||999;h=t<=e.contactRankThreshold,b={rank:t,totalPoints:i.totalGiftPoints||0,giftHistory:i.giftHistory||[],fanClubData:i.fanClubData||null,danmakuHistory:i.danmakuHistory||[]},console.log(`🎁 [礼物榜私联] 配置: willContact=${u}, threshold=${e.contactRankThreshold}, userRank=${t}, met=${h}`)}else if("fanClub"===a){const n=await l.xFanClubs.get(c);if(!n||!n.data||!n.data.fanClubContactConfig)return void console.log("⚠️ [主播私联] 主播未配置粉丝团私联");const e=n.data.fanClubContactConfig;u=e.willContactPrivately,f=e.persistAfterRejection;const t=i.fanClubLevel||0;h=t>=e.contactLevelThreshold,b={level:t,levelName:i.fanClubLevelName||"",totalPoints:i.fanClubPoints||0,giftHistory:i.giftHistory||[],fanClubData:{joined:!0,level:t,points:i.fanClubPoints||0},danmakuHistory:i.danmakuHistory||[]},console.log(`🌟 [粉丝团私联] 配置: willContact=${u}, threshold=${e.contactLevelThreshold}, userLevel=${t}, met=${h}`)}if(!u||!h)return void console.log("❌ [主播私联] 未满足触发条件");const v=`streamerContactHistory_${c}`,y=await l.xAccountProfiles.get(v);if(y&&y.data&&y.data[a]){const n=y.data[a];if(n.accepted)return void console.log("✅ [主播私联] 用户已接受过此主播的私联，跳过");if(n.rejected&&!f)return void console.log("⚠️ [主播私联] 用户之前拒绝过，且主播不会持续私联")}console.log("✅ [主播私联] 触发条件满足，开始生成私信"),await async function(t,o,a){try{console.log("📡 [主播私联] 开始生成私信内容...");const i=await async function(n){try{if(Ko&&Ko.streamerHandle===n)return{name:Ko.streamerName,avatar:Ko.streamerAvatar,verified:Ko.streamerVerified||!1};if(!e())return console.error("❌ [获取主播信息] 无法获取数据库实例"),null;for(const e in Go){const t=Go[e].find(e=>e.streamerHandle===n);if(t)return{name:t.streamerName,avatar:t.streamerAvatar,verified:t.streamerVerified||!1}}return null}catch(n){return console.error("❌ [获取主播信息] 失败:",n),null}}(t);if(!i)return void console.error("❌ [主播私联] 无法获取主播信息");const r={id:`streamer_contact_${Date.now()}`,user:{name:i.name||"主播",handle:t,avatar:i.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:i.verified||!1}};a.streamerName=i.name,a.streamerAvatar=i.avatar,a.streamerVerified=i.verified;const s={isStreamerContact:!0,streamerContactData:{trigger:o,details:a}},l=await vl(r,!0,s);if(!l||0===l.length)return void console.log("⚠️ [主播私联] AI未生成消息");const c=`${t}_${o}`;n.streamerContactMessageCache[c]={messageData:r,generatedMessages:l,trigger:o,triggerDetails:a,timestamp:Date.now()},console.log(`✅ [主播私联] 私信内容已生成并缓存 (${l.length}条消息)`),jr(c)}catch(n){console.error("❌ [主播私联] 生成私信失败:",n),mn("生成私信失败: "+n.message,"error")}}(o,a,b)}catch(n){console.error("❌ [主播私联] 检测失败:",n)}}function jr(e){const t=n.streamerContactMessageCache[e];if(!t)return void console.error("❌ [主播私联弹窗] 未找到缓存数据");const{messageData:o,trigger:a,triggerDetails:i}=t,r="giftRank"===a?`注意到你在礼物榜排名第 ${i.rank} 名`:`注意到你的粉丝团等级达到了 LV${i.level}`;if(document.getElementById("streamer-contact-modal"))return void console.log("⚠️ [主播私联弹窗] 弹窗已存在");const s=document.createElement("div");s.id="streamer-contact-modal",s.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    background-color: transparent;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n    pointer-events: none;\n  ",s.innerHTML=`\n    <style>\n      /* ============================================\n         主播私联弹窗 - 信封邀请函风格\n         设计元素：信封、邮票、邀请卡、邮戳\n         ============================================ */\n      \n      /* 遮罩层动画 */\n      #streamer-contact-modal .backdrop-layer {\n        position: absolute;\n        inset: 0;\n        background-color: rgba(0, 0, 0, 0);\n        backdrop-filter: blur(0px);\n        -webkit-backdrop-filter: blur(0px);\n        transition: all 0.6s ease;\n        pointer-events: auto;\n      }\n      \n      #streamer-contact-modal .backdrop-layer.active {\n        background-color: rgba(0, 0, 0, 0.75);\n        backdrop-filter: blur(12px);\n        -webkit-backdrop-filter: blur(12px);\n      }\n      \n      /* 信封容器 - 飞入动画 */\n      .envelope-container {\n        position: relative;\n        width: 90%;\n        max-width: 400px;\n        transform: translate(150%, 150%) rotate(25deg) scale(0.3);\n        opacity: 0;\n        transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1),\n                    opacity 0.8s ease-out;\n        pointer-events: auto;\n        will-change: transform, opacity;\n        perspective: 1000px;\n      }\n      \n      .envelope-container.active {\n        transform: translate(0, 0) rotate(0deg) scale(1);\n        opacity: 1;\n      }\n      \n      /* 信封离开动画 */\n      .envelope-container.leaving {\n        transform: translate(-150%, -150%) rotate(-25deg) scale(0.3);\n        opacity: 0;\n        transition: all 0.6s cubic-bezier(0.6, -0.28, 0.735, 0.045);\n      }\n      \n      /* 信封主体 */\n      .invitation-envelope {\n        position: relative;\n        width: 100%;\n        background: linear-gradient(135deg, rgba(15,15,15,0.98), rgba(8,8,8,0.98));\n        border: 1.5px solid rgba(255,255,255,0.25);\n        border-radius: 8px;\n        box-shadow: \n          0 25px 70px rgba(0,0,0,0.9),\n          0 10px 30px rgba(0,0,0,0.6),\n          inset 0 1px 0 rgba(255,255,255,0.1);\n        overflow: visible;\n        transform-style: preserve-3d;\n        perspective: 1000px;\n      }\n      \n      /* 信封背景纹理 */\n      .invitation-envelope::before {\n        content: "";\n        position: absolute;\n        inset: 0;\n        background: \n          repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.008) 2px, rgba(255,255,255,0.008) 4px),\n          repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.004) 2px, rgba(255,255,255,0.004) 4px);\n        pointer-events: none;\n        border-radius: 8px;\n      }\n      \n      /* 信封封口翻盖 */\n      .envelope-flap {\n        position: absolute;\n        top: -1px;\n        left: -1px;\n        right: -1px;\n        height: 80px;\n        background: linear-gradient(180deg, rgba(20,20,20,0.95), rgba(12,12,12,0.9));\n        clip-path: polygon(0 0, 100% 0, 50% 100%);\n        border: 1.5px solid rgba(255,255,255,0.25);\n        border-bottom: none;\n        z-index: 10;\n        transform-origin: top center;\n        transform-style: preserve-3d;\n        backface-visibility: visible;\n        will-change: transform;\n        /* 初始状态：合上 */\n        transform: rotateX(0deg);\n        /* 动画：信封飞入完成后(850ms)开始打开，持续600ms */\n        animation: flapOpen 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.85s both;\n      }\n      \n      @keyframes flapOpen {\n        0% { \n          transform: rotateX(0deg);\n          filter: brightness(1);\n        }\n        50% {\n          filter: brightness(1.1);\n        }\n        100% { \n          transform: rotateX(-180deg);\n          filter: brightness(0.8);\n        }\n      }\n      \n      /* 邮戳印章 */\n      .postmark-stamp {\n        position: absolute;\n        top: 10px;\n        right: 20px;\n        width: 50px;\n        height: 50px;\n        border: 2px dashed rgba(255,255,255,0.25);\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 11;\n        opacity: 0;\n        will-change: transform, opacity;\n        /* 动画：翻盖打开中途(1.25s)出现 */\n        animation: stampAppear 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 1.25s both;\n      }\n      \n      @keyframes stampAppear {\n        0% { \n          opacity: 0; \n          transform: rotate(-25deg) scale(0.3);\n        }\n        100% { \n          opacity: 1; \n          transform: rotate(-8deg) scale(1);\n        }\n      }\n      \n      .postmark-text {\n        font-family: 'Courier New', monospace;\n        font-size: 7px;\n        font-weight: 900;\n        letter-spacing: 0.5px;\n        color: rgba(255,255,255,0.4);\n        text-align: center;\n        line-height: 1.2;\n      }\n      \n      /* 邮票装饰 */\n      .postage-stamp {\n        position: absolute;\n        top: 15px;\n        left: 20px;\n        width: 35px;\n        height: 45px;\n        background: linear-gradient(135deg, rgba(30,30,30,0.9), rgba(20,20,20,0.9));\n        border: 1px solid rgba(255,255,255,0.3);\n        padding: 4px;\n        z-index: 11;\n        opacity: 0;\n        will-change: transform, opacity;\n        /* 动画：翻盖打开开始时(1.05s)出现 */\n        animation: postageAppear 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) 1.05s both;\n      }\n      \n      @keyframes postageAppear {\n        0% { \n          opacity: 0; \n          transform: scale(0.5) translateY(-10px);\n        }\n        100% { \n          opacity: 1; \n          transform: scale(1) translateY(0);\n        }\n      }\n      \n      .stamp-perforations {\n        position: absolute;\n        inset: -1px;\n        border: 1px dashed rgba(255,255,255,0.2);\n      }\n      \n      .stamp-inner {\n        width: 100%;\n        height: 100%;\n        border: 1px solid rgba(255,255,255,0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-family: 'Courier New', monospace;\n        font-size: 9px;\n        font-weight: 900;\n        color: rgba(255,255,255,0.6);\n        letter-spacing: 0.5px;\n      }\n      \n      /* 邀请卡片 - 从信封中抽出 */\n      .invitation-card {\n        position: relative;\n        margin-top: 60px;\n        padding: 20px 18px;\n        background: linear-gradient(180deg, rgba(25,25,25,0.98), rgba(18,18,18,0.98));\n        border: 1px solid rgba(255,255,255,0.2);\n        border-radius: 6px;\n        will-change: transform, opacity;\n        /* 初始状态：完全在信封内部（向上隐藏） */\n        transform: translateY(-120px);\n        opacity: 0;\n        /* 不使用transition，改用animation精确控制 */\n      }\n      \n      .invitation-card.active {\n        /* 动画：翻盖打开完成后(1.45s)开始抽出，持续800ms */\n        animation: \n          cardPullOut 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 1.45s both,\n          cardFloat 3s ease-in-out infinite 2.3s;\n      }\n      \n      @keyframes cardPullOut {\n        0% { \n          transform: translateY(-120px);\n          opacity: 0;\n        }\n        30% {\n          opacity: 0.3;\n        }\n        100% { \n          transform: translateY(0);\n          opacity: 1;\n        }\n      }\n      \n      @keyframes cardFloat {\n        0%, 100% { transform: translateY(0); }\n        50% { transform: translateY(-5px); }\n      }\n      \n      /* 接受动画 - 放大并淡出 */\n      .invitation-card.accepting {\n        animation: cardAccept 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important;\n      }\n      \n      @keyframes cardAccept {\n        0% { \n          transform: translateY(0) scale(1); \n          opacity: 1;\n          filter: brightness(1);\n        }\n        60% {\n          transform: translateY(-20px) scale(1.2);\n          filter: brightness(1.2);\n        }\n        100% { \n          transform: translateY(-50px) scale(1.3); \n          opacity: 0;\n          filter: brightness(1.5);\n        }\n      }\n      \n      /* 卡片撕裂边缘 */\n      .card-tear-edge {\n        position: absolute;\n        left: 0;\n        right: 0;\n        height: 6px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 3px,\n          rgba(255,255,255,0.08) 3px,\n          rgba(255,255,255,0.08) 4px\n        );\n      }\n      \n      .card-tear-top { top: 0; }\n      .card-tear-bottom { bottom: 0; }\n      \n      /* 头像磁带框 */\n      .avatar-cassette-frame {\n        display: flex;\n        justify-content: center;\n        margin-bottom: 16px;\n        opacity: 0;\n        transform: scale(0.8);\n      }\n      \n      .invitation-card.active .avatar-cassette-frame {\n        animation: fadeInScale 0.4s ease-out 1.6s both;\n      }\n      \n      @keyframes fadeInScale {\n        0% { opacity: 0; transform: scale(0.8); }\n        100% { opacity: 1; transform: scale(1); }\n      }\n      \n      .cassette-reel-outer {\n        position: relative;\n        width: 70px;\n        height: 70px;\n        border: 2px solid rgba(255,255,255,0.25);\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        animation: reelRotate 8s linear infinite;\n      }\n      \n      @keyframes reelRotate {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n      \n      .cassette-reel-inner {\n        position: absolute;\n        width: 24px;\n        height: 24px;\n        border: 2px solid rgba(255,255,255,0.2);\n        border-radius: 50%;\n        background: rgba(0,0,0,0.3);\n      }\n      \n      .avatar-image {\n        width: 60px;\n        height: 60px;\n        border-radius: 50%;\n        object-fit: cover;\n        border: 2px solid rgba(255,255,255,0.15);\n        position: relative;\n        z-index: 1;\n      }\n      \n      /* 标题LCD显示 */\n      .invitation-header {\n        position: relative;\n        text-align: center;\n        padding: 12px 0;\n        margin-bottom: 12px;\n        background: rgba(0,0,0,0.3);\n        border: 1px solid rgba(255,255,255,0.1);\n        border-left: none;\n        border-right: none;\n        opacity: 0;\n        transform: translateY(-10px);\n      }\n      \n      .invitation-card.active .invitation-header {\n        animation: fadeInUp 0.4s ease-out 1.7s both;\n      }\n      \n      @keyframes fadeInUp {\n        0% { opacity: 0; transform: translateY(-10px); }\n        100% { opacity: 1; transform: translateY(0); }\n      }\n      \n      .header-scan-line {\n        position: absolute;\n        inset: 0;\n        background: repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 2px,\n          rgba(255,255,255,0.02) 2px,\n          rgba(255,255,255,0.02) 4px\n        );\n        pointer-events: none;\n      }\n      \n      .header-label {\n        font-family: 'Courier New', monospace;\n        font-size: 10px;\n        font-weight: 900;\n        letter-spacing: 3px;\n        color: rgba(255,255,255,0.5);\n        position: relative;\n        z-index: 1;\n      }\n      \n      .header-divider {\n        position: absolute;\n        bottom: 3px;\n        left: 20px;\n        right: 20px;\n        height: 1px;\n        background: repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 3px,\n          rgba(255,255,255,0.15) 3px,\n          rgba(255,255,255,0.15) 4px\n        );\n      }\n      \n      /* 主播名称LED显示 */\n      .streamer-name-display {\n        text-align: center;\n        font-family: 'Courier New', monospace;\n        font-size: 16px;\n        font-weight: 900;\n        letter-spacing: 1px;\n        color: rgba(255,255,255,0.95);\n        margin-bottom: 14px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        opacity: 0;\n        transform: translateY(-10px);\n      }\n      \n      .invitation-card.active .streamer-name-display {\n        animation: fadeInUp 0.4s ease-out 1.8s both;\n      }\n      \n      .verified-badge {\n        font-size: 8px;\n        font-weight: 800;\n        letter-spacing: 1px;\n        background: rgba(255,255,255,0.15);\n        border: 1px solid rgba(255,255,255,0.25);\n        padding: 2px 6px;\n        border-radius: 3px;\n        color: rgba(255,255,255,0.7);\n      }\n      \n      /* 触发原因票据 */\n      .trigger-ticket {\n        position: relative;\n        background: linear-gradient(135deg, rgba(30,30,30,0.8), rgba(20,20,20,0.8));\n        border: 1px solid rgba(255,255,255,0.15);\n        border-left: 2px solid rgba(255,255,255,0.25);\n        border-radius: 4px;\n        padding: 12px 14px;\n        margin-bottom: 14px;\n        opacity: 0;\n        transform: translateX(-20px);\n      }\n      \n      .invitation-card.active .trigger-ticket {\n        animation: slideInLeft 0.4s ease-out 1.9s both;\n      }\n      \n      @keyframes slideInLeft {\n        0% { opacity: 0; transform: translateX(-20px); }\n        100% { opacity: 1; transform: translateX(0); }\n      }\n      \n      .ticket-punch-holes {\n        position: absolute;\n        top: 50%;\n        right: -1px;\n        transform: translateY(-50%);\n        display: flex;\n        flex-direction: column;\n        gap: 6px;\n      }\n      \n      .punch {\n        width: 5px;\n        height: 5px;\n        background: rgba(0,0,0,0.8);\n        border: 1px solid rgba(255,255,255,0.15);\n        border-radius: 50%;\n      }\n      \n      .ticket-code {\n        font-family: 'Courier New', monospace;\n        font-size: 9px;\n        font-weight: 900;\n        letter-spacing: 1.5px;\n        color: rgba(255,255,255,0.5);\n        margin-bottom: 6px;\n      }\n      \n      .ticket-detail {\n        font-family: 'Courier New', monospace;\n        font-size: 12px;\n        font-weight: 800;\n        color: rgba(255,255,255,0.9);\n        margin-bottom: 8px;\n        letter-spacing: 0.5px;\n      }\n      \n      .ticket-message {\n        font-size: 10px;\n        color: rgba(255,255,255,0.6);\n        line-height: 1.5;\n        letter-spacing: 0.3px;\n      }\n      \n      /* 磁带条分隔线 */\n      .tape-divider {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        margin: 14px 0;\n        opacity: 0;\n      }\n      \n      .invitation-card.active .tape-divider {\n        animation: fadeIn 0.3s ease-out 2.0s both;\n      }\n      \n      @keyframes fadeIn {\n        0% { opacity: 0; }\n        100% { opacity: 1; }\n      }\n      \n      .tape-hole {\n        width: 6px;\n        height: 6px;\n        background: rgba(0,0,0,0.5);\n        border: 1px solid rgba(255,255,255,0.2);\n        border-radius: 50%;\n        flex-shrink: 0;\n      }\n      \n      .tape-line {\n        flex: 1;\n        height: 1px;\n        background: linear-gradient(\n          90deg,\n          transparent,\n          rgba(255,255,255,0.2) 50%,\n          transparent\n        );\n      }\n      \n      /* 按钮区域 */\n      .button-zone {\n        display: flex;\n        gap: 10px;\n        opacity: 0;\n        transform: translateY(10px);\n      }\n      \n      .invitation-card.active .button-zone {\n        animation: fadeInUp 0.4s ease-out 2.1s both;\n      }\n      \n      .reject-button,\n      .accept-button {\n        flex: 1;\n        position: relative;\n        padding: 12px 16px;\n        font-family: 'Courier New', monospace;\n        font-size: 11px;\n        font-weight: 900;\n        letter-spacing: 2px;\n        border-radius: 4px;\n        cursor: pointer;\n        transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);\n        overflow: hidden;\n      }\n      \n      .reject-button {\n        background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(30,30,30,0.8));\n        border: 1px solid rgba(255,255,255,0.2);\n        color: rgba(255,255,255,0.8);\n      }\n      \n      .reject-button:hover {\n        background: linear-gradient(135deg, rgba(50,50,50,0.9), rgba(40,40,40,0.9));\n        border-color: rgba(255,255,255,0.3);\n        transform: translateY(-2px);\n        box-shadow: 0 4px 16px rgba(0,0,0,0.5);\n      }\n      \n      .reject-button:active {\n        transform: translateY(0) scale(0.98);\n      }\n      \n      .accept-button {\n        background: linear-gradient(135deg, rgba(60,60,60,0.9), rgba(45,45,45,0.9));\n        border: 1.5px solid rgba(255,255,255,0.35);\n        color: rgba(255,255,255,0.95);\n      }\n      \n      .accept-button:hover {\n        background: linear-gradient(135deg, rgba(70,70,70,0.95), rgba(55,55,55,0.95));\n        border-color: rgba(255,255,255,0.5);\n        transform: translateY(-3px);\n        box-shadow: 0 6px 20px rgba(0,0,0,0.6);\n      }\n      \n      .accept-button:active {\n        transform: translateY(0) scale(0.96);\n      }\n      \n      .button-text {\n        position: relative;\n        z-index: 2;\n      }\n      \n      .button-border-deco {\n        position: absolute;\n        inset: 4px;\n        border: 1px solid rgba(255,255,255,0.08);\n        border-radius: 2px;\n        pointer-events: none;\n      }\n      \n      .button-bar {\n        position: absolute;\n        bottom: 3px;\n        left: 10px;\n        right: 10px;\n        height: 1px;\n        background: rgba(255,255,255,0.15);\n      }\n      \n      .button-glow {\n        position: absolute;\n        inset: 0;\n        background: radial-gradient(\n          circle at center,\n          rgba(255,255,255,0.05),\n          transparent 70%\n        );\n        opacity: 0;\n        transition: opacity 0.3s;\n      }\n      \n      .accept-button:hover .button-glow {\n        opacity: 1;\n      }\n      \n      /* 移动端适配 */\n      @media (max-width: 600px) {\n        .envelope-container {\n          width: 95%;\n          max-width: 360px;\n        }\n        \n        .invitation-card {\n          padding: 16px 14px;\n        }\n        \n        .avatar-cassette-frame {\n          margin-bottom: 12px;\n        }\n        \n        .cassette-reel-outer {\n          width: 60px;\n          height: 60px;\n        }\n        \n        .avatar-image {\n          width: 50px;\n          height: 50px;\n        }\n        \n        .streamer-name-display {\n          font-size: 14px;\n        }\n        \n        .trigger-ticket {\n          padding: 10px 12px;\n        }\n        \n        .button-zone {\n          gap: 8px;\n        }\n        \n        .reject-button,\n        .accept-button {\n          padding: 10px 12px;\n          font-size: 10px;\n          letter-spacing: 1.5px;\n        }\n      }\n    </style>\n    <div class="backdrop-layer" onclick="handleStreamerContactReject('${e}')"></div>\n    <div class="envelope-container">\n      <div class="invitation-envelope">\n        \x3c!-- 信封翻盖 --\x3e\n        <div class="envelope-flap"></div>\n        \n        \x3c!-- 邮戳 --\x3e\n        <div class="postmark-stamp">\n          <div class="postmark-text">\n            PRIVATE<br/>MESSAGE\n          </div>\n        </div>\n        \n        \x3c!-- 邮票 --\x3e\n        <div class="postage-stamp">\n          <div class="stamp-perforations"></div>\n          <div class="stamp-inner">VIP</div>\n        </div>\n        \n        \x3c!-- 邀请卡片（从信封中抽出） --\x3e\n        <div class="invitation-card" onclick="event.stopPropagation()">\n          \x3c!-- 卡片撕裂边缘装饰 --\x3e\n          <div class="card-tear-edge card-tear-top"></div>\n          <div class="card-tear-edge card-tear-bottom"></div>\n          \n          \x3c!-- 主播头像区域（磁带圆形） --\x3e\n          <div class="avatar-cassette-frame">\n            <div class="cassette-reel-outer">\n              <div class="cassette-reel-inner"></div>\n              <img src="${o.user.avatar}" class="avatar-image" />\n            </div>\n          </div>\n          \n          \x3c!-- 标题区域（LCD显示风格） --\x3e\n          <div class="invitation-header">\n            <div class="header-scan-line"></div>\n            <div class="header-label">PRIVATE INVITATION</div>\n            <div class="header-divider"></div>\n          </div>\n          \n          \x3c!-- 主播名称（LED显示） --\x3e\n          <div class="streamer-name-display">\n            ${o.user.name}\n            ${o.user.verified?'<span class="verified-badge">VERIFIED</span>':""}\n          </div>\n          \n          \x3c!-- 触发原因（票据风格） --\x3e\n          <div class="trigger-ticket">\n            <div class="ticket-punch-holes">\n              <span class="punch"></span>\n              <span class="punch"></span>\n              <span class="punch"></span>\n            </div>\n            <div class="ticket-code">${"giftRank"===a?"GIFT-RANK":"FAN-CLUB"}</div>\n            <div class="ticket-detail">${r}</div>\n            <div class="ticket-message">主播对你的支持表示感谢<br/>想要建立更深入的私下联系</div>\n          </div>\n          \n          \x3c!-- 磁带条分隔线 --\x3e\n          <div class="tape-divider">\n            <div class="tape-hole"></div>\n            <div class="tape-line"></div>\n            <div class="tape-hole"></div>\n          </div>\n          \n          \x3c!-- 按钮区域 --\x3e\n          <div class="button-zone">\n            <button class="reject-button" onclick="handleStreamerContactReject('${e}')">\n              <div class="button-border-deco"></div>\n              <span class="button-text">DECLINE</span>\n              <div class="button-bar"></div>\n            </button>\n            <button class="accept-button" onclick="handleStreamerContactAccept('${e}')">\n              <div class="button-border-deco"></div>\n              <span class="button-text">ACCEPT</span>\n              <div class="button-glow"></div>\n              <div class="button-bar"></div>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(s),requestAnimationFrame(()=>{const n=s.querySelector(".backdrop-layer"),e=s.querySelector(".envelope-container"),t=s.querySelector(".invitation-card");n&&setTimeout(()=>n.classList.add("active"),10),e&&setTimeout(()=>e.classList.add("active"),50),t&&setTimeout(()=>t.classList.add("active"),100)}),console.log("✅ [主播私联弹窗] 弹窗已显示")}n.handleJoinClick=async function(){Ko&&Ko.streamerHandle?await async function(n){try{const t=e(),o=(Tr(),r.clean(n));console.log(`🎊 [会员系统] 加入粉丝团: ${o}`);const a=0,i=await Er(a,o),s={streamerHandle:o,joined:!0,joinedAt:(new Date).toISOString(),checkinDays:0,lastCheckinDate:null,points:a,level:i,checkinHistory:[]};await t.xFanClubMemberships.put(s),console.log(`✅ [会员系统] 会员数据已保存 (初始等级: LV${i})`);try{const n=await t.xFanClubs.get(o);n&&n.data&&n.data.messages&&n.data.messages.welcome&&Rr(n.data.messages.welcome,"welcome")}catch(n){console.warn("⚠️ [会员系统] 获取欢迎留言失败:",n)}return await Br(o),mn("欢迎加入粉丝团！","success"),s}catch(n){throw console.error("❌ [会员系统] 加入失败:",n),mn(`加入失败: ${n.message}`,"error"),n}}(Ko.streamerHandle):mn("无法获取主播信息","error")},n.handleCheckinClick=async function(){Ko&&Ko.streamerHandle?await Ar(Ko.streamerHandle):mn("无法获取主播信息","error")},n.openFanClub=async function(){if(Ir.isOpen||Ir.isGenerating)return;const t=document.querySelector(".live-room");if(!t)return void mn("请先进入直播间","error");if(!Ko||!Ko.streamerHandle)return void mn("无法获取主播信息","error");const o=Ko.streamerHandle;if(!o)return void mn("主播句柄为空","error");const a=r.clean(o);if(!a)return void mn("无效的主播句柄","error");na.isOpen&&Da(),Ir.isOpen=!0,function(){if(document.getElementById("fanClubStyles"))return;const n=document.createElement("style");n.id="fanClubStyles",n.textContent="\n    /* ================================================\n       粉丝团系统 - VIP会员卡/磁带徽章风格\n       黑白灰配色 | 磁带元素 | LCD显示屏 | 全息效果\n       ================================================ */\n    \n    /* 遮罩层 */\n    .fanclub-overlay {\n      position: fixed;\n      inset: 0;\n      background: transparent;\n      z-index: 10001;\n      opacity: 0;\n      transition: opacity 0.4s ease;\n    }\n    \n    .fanclub-overlay.active {\n      opacity: 1;\n    }\n    \n    /* 主面板 */\n    .fanclub-panel {\n      position: fixed;\n      bottom: 0;\n      left: 50%;\n      transform: translateX(-50%) translateY(100%);\n      width: 92%;\n      max-width: 480px;\n      max-height: 82vh;\n      background: linear-gradient(180deg, rgba(18, 18, 18, 0.98) 0%, rgba(8, 8, 8, 0.98) 100%);\n      border: 1.5px solid rgba(255, 255, 255, 0.22);\n      border-bottom: none;\n      border-radius: 18px 18px 0 0;\n      box-shadow: \n        0 -12px 48px rgba(0, 0, 0, 0.85),\n        inset 0 1px 0 rgba(255, 255, 255, 0.12);\n      z-index: 10002;\n      opacity: 0;\n      transition: all 0.55s cubic-bezier(0.22, 0.85, 0.25, 1);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n    }\n    \n    .fanclub-panel.active {\n      transform: translateX(-50%) translateY(0);\n      opacity: 1;\n    }\n    \n    /* 细微纹理 */\n    .fanclub-panel::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: \n        repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(255,255,255,0.012) 3px, rgba(255,255,255,0.012) 6px),\n        repeating-linear-gradient(90deg, transparent, transparent 3px, rgba(255,255,255,0.008) 3px, rgba(255,255,255,0.008) 6px);\n      pointer-events: none;\n      z-index: 0;\n    }\n    \n    /* ========== VIP头部 ========== */\n    .fanclub-vip-header {\n      position: relative;\n      padding: 16px 18px;\n      background: linear-gradient(180deg, rgba(28, 28, 28, 0.96) 0%, rgba(16, 16, 16, 0.94) 100%);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n      overflow: hidden;\n      z-index: 2;\n    }\n    \n    /* 磁带装饰条 */\n    .tape-stripe {\n      position: absolute;\n      left: 0;\n      right: 0;\n      height: 2px;\n      background: repeating-linear-gradient(\n        90deg,\n        rgba(255, 255, 255, 0.12),\n        rgba(255, 255, 255, 0.12) 6px,\n        transparent 6px,\n        transparent 12px\n      );\n      z-index: 1;\n    }\n    \n    .tape-stripe-top {\n      top: 0;\n    }\n    \n    .tape-stripe-bottom {\n      bottom: 0;\n    }\n    \n    /* 磁带轮装饰 */\n    .tape-reel-deco {\n      position: absolute;\n      width: 28px;\n      height: 28px;\n      border-radius: 50%;\n      background: radial-gradient(circle, rgba(40, 40, 40, 0.9), rgba(20, 20, 20, 0.9));\n      border: 1.5px solid rgba(255, 255, 255, 0.18);\n      box-shadow: \n        inset 0 2px 4px rgba(0, 0, 0, 0.6),\n        0 2px 8px rgba(0, 0, 0, 0.5);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 3;\n    }\n    \n    .tape-reel-left {\n      top: 50%;\n      left: 14px;\n      transform: translateY(-50%);\n    }\n    \n    .tape-reel-right {\n      top: 50%;\n      right: 14px;\n      transform: translateY(-50%);\n    }\n    \n    .reel-spin {\n      width: 18px;\n      height: 18px;\n      border-radius: 50%;\n      background: \n        conic-gradient(\n          rgba(255, 255, 255, 0.15) 0deg,\n          transparent 90deg,\n          rgba(255, 255, 255, 0.1) 180deg,\n          transparent 270deg,\n          rgba(255, 255, 255, 0.15) 360deg\n        );\n      border: 1px solid rgba(255, 255, 255, 0.12);\n      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);\n    }\n    \n    .reel-spin.spinning {\n      animation: reelRotate 8s linear infinite;\n    }\n    \n    @keyframes reelRotate {\n      from { transform: rotate(0deg); }\n      to { transform: rotate(360deg); }\n    }\n    \n    /* 粉丝团名称徽章 */\n    .vip-badge-container {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 4;\n    }\n    \n    .vip-badge {\n      position: relative;\n      padding: 6px 16px;\n      background: rgba(0, 0, 0, 0.6);\n      border: 1px solid rgba(255, 255, 255, 0.25);\n      border-radius: 4px;\n      box-shadow: \n        0 2px 8px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(255, 255, 255, 0.08);\n      max-width: 320px;\n    }\n    \n    .badge-glow {\n      position: absolute;\n      inset: -2px;\n      border-radius: 4px;\n      background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.08), transparent 70%);\n      pointer-events: none;\n    }\n    \n    .badge-text {\n      position: relative;\n      font-size: 10px;\n      font-weight: 900;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.92);\n      z-index: 1;\n      max-width: 280px;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      white-space: nowrap;\n      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);\n    }\n    \n    /* 俱乐部名称 */\n    .club-name-display {\n      position: relative;\n      margin-top: 28px;\n      text-align: center;\n      padding: 0 55px;\n    }\n    \n    .club-name-glow {\n      position: absolute;\n      inset: -8px;\n      background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.04), transparent 65%);\n      pointer-events: none;\n    }\n    \n    .club-name-text {\n      position: relative;\n      font-size: 13px;\n      font-weight: 900;\n      letter-spacing: 1.8px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n      text-shadow: 0 0 12px rgba(255, 255, 255, 0.15);\n      white-space: nowrap;\n      overflow: hidden;\n      text-overflow: ellipsis;\n      z-index: 1;\n    }\n    \n    /* 关闭按钮 */\n    .fanclub-close-btn {\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 26px;\n      height: 26px;\n      border-radius: 4px;\n      background: rgba(255, 255, 255, 0.06);\n      border: 1px solid rgba(255, 255, 255, 0.18);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      transition: all 0.28s cubic-bezier(0.25, 0.8, 0.25, 1);\n      color: rgba(255, 255, 255, 0.7);\n      z-index: 5;\n    }\n    \n    .fanclub-close-btn:hover {\n      background: rgba(255, 255, 255, 0.12);\n      border-color: rgba(255, 255, 255, 0.32);\n      color: rgba(255, 255, 255, 0.98);\n      transform: scale(1.1) rotate(90deg);\n      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);\n    }\n    \n    .fanclub-close-btn:active {\n      transform: scale(0.94) rotate(90deg);\n    }\n    \n    /* ========== LCD显示屏统计区 ========== */\n    .fanclub-lcd-panel {\n      position: relative;\n      padding: 18px;\n      background: linear-gradient(135deg, rgba(12, 12, 12, 0.95) 0%, rgba(5, 5, 5, 0.95) 100%);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.12);\n      z-index: 1;\n    }\n    \n    /* LCD扫描线 */\n    .lcd-scanline {\n      position: absolute;\n      inset: 0;\n      background: linear-gradient(\n        0deg,\n        transparent 0%,\n        rgba(255, 255, 255, 0.02) 50%,\n        transparent 100%\n      );\n      animation: scanlineMove 4s linear infinite;\n      pointer-events: none;\n      z-index: 2;\n    }\n    \n    @keyframes scanlineMove {\n      0% { transform: translateY(-100%); }\n      100% { transform: translateY(100%); }\n    }\n    \n    .lcd-display-grid {\n      position: relative;\n      display: grid;\n      grid-template-columns: repeat(3, 1fr);\n      gap: 12px;\n      z-index: 3;\n    }\n    \n    .lcd-stat {\n      background: rgba(0, 0, 0, 0.7);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 6px;\n      padding: 14px 10px;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 7px;\n      box-shadow: \n        inset 0 2px 8px rgba(0, 0, 0, 0.8),\n        0 2px 6px rgba(0, 0, 0, 0.4);\n      position: relative;\n      overflow: hidden;\n    }\n    \n    .lcd-stat::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(255, 255, 255, 0.015) 2px,\n        rgba(255, 255, 255, 0.015) 4px\n      );\n      pointer-events: none;\n    }\n    \n    .lcd-stat-icon {\n      color: rgba(255, 255, 255, 0.45);\n      filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.15));\n    }\n    \n    .lcd-stat-label {\n      font-size: 7px;\n      font-weight: 900;\n      letter-spacing: 1.2px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.4);\n    }\n    \n    .lcd-stat-value {\n      font-size: 15px;\n      font-weight: 900;\n      letter-spacing: 1.2px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.96);\n      text-shadow: 0 0 10px rgba(255, 255, 255, 0.25);\n      min-height: 18px;\n    }\n    \n    .lcd-stat-unit {\n      font-size: 9px;\n      font-weight: 800;\n      letter-spacing: 0.8px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.5);\n    }\n    \n    /* ========== 内容滚动容器 ========== */\n    .fanclub-content-scroll {\n      flex: 1;\n      overflow-y: auto;\n      overflow-x: hidden;\n      position: relative;\n      z-index: 1;\n    }\n    \n    /* 滚动条样式 */\n    .fanclub-content-scroll::-webkit-scrollbar {\n      width: 5px;\n    }\n    \n    .fanclub-content-scroll::-webkit-scrollbar-track {\n      background: rgba(0, 0, 0, 0.5);\n      border-radius: 3px;\n      margin: 8px 0;\n    }\n    \n    .fanclub-content-scroll::-webkit-scrollbar-thumb {\n      background: linear-gradient(180deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0.18));\n      border-radius: 3px;\n      border: 1px solid rgba(255, 255, 255, 0.12);\n    }\n    \n    .fanclub-content-scroll::-webkit-scrollbar-thumb:hover {\n      background: linear-gradient(180deg, rgba(255, 255, 255, 0.38), rgba(255, 255, 255, 0.28));\n    }\n    \n    /* ========== 会员交互区 ========== */\n    .fanclub-interaction-area {\n      padding: 0;\n      background: linear-gradient(180deg, rgba(10, 10, 10, 0.96) 0%, rgba(8, 8, 8, 0.96) 100%);\n      border-bottom: 1px solid rgba(255, 255, 255, 0.12);\n      position: relative;\n    }\n    \n    /* 加入粉丝团区域 */\n    .fanclub-join-section {\n      padding: 16px;\n    }\n    \n    .join-card {\n      display: flex;\n      align-items: center;\n      gap: 14px;\n      padding: 18px;\n      background: linear-gradient(135deg, rgba(28, 28, 28, 0.9) 0%, rgba(16, 16, 16, 0.9) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      border-radius: 8px;\n      position: relative;\n      overflow: hidden;\n    }\n    \n    .join-card::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        45deg,\n        transparent,\n        transparent 10px,\n        rgba(255, 255, 255, 0.01) 10px,\n        rgba(255, 255, 255, 0.01) 20px\n      );\n      pointer-events: none;\n    }\n    \n    .join-icon {\n      flex-shrink: 0;\n      color: rgba(255, 255, 255, 0.6);\n      filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.15));\n    }\n    \n    .join-content {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n    }\n    \n    .join-title {\n      font-size: 12px;\n      font-weight: 900;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n    }\n    \n    .join-desc {\n      font-size: 9px;\n      font-weight: 600;\n      letter-spacing: 0.5px;\n      font-family: system-ui, sans-serif;\n      color: rgba(255, 255, 255, 0.5);\n    }\n    \n    .join-btn {\n      flex-shrink: 0;\n      padding: 10px 18px;\n      background: linear-gradient(135deg, rgba(60, 60, 60, 0.95) 0%, rgba(40, 40, 40, 0.95) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.35);\n      border-radius: 6px;\n      cursor: pointer;\n      transition: all 0.32s cubic-bezier(0.25, 0.8, 0.25, 1);\n      box-shadow: \n        0 2px 8px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(255, 255, 255, 0.1);\n    }\n    \n    .join-btn:hover {\n      background: linear-gradient(135deg, rgba(80, 80, 80, 0.95) 0%, rgba(60, 60, 60, 0.95) 100%);\n      border-color: rgba(255, 255, 255, 0.55);\n      transform: translateY(-2px);\n      box-shadow: \n        0 4px 12px rgba(0, 0, 0, 0.6),\n        inset 0 1px 0 rgba(255, 255, 255, 0.15);\n    }\n    \n    .join-btn:active {\n      transform: translateY(0);\n      box-shadow: \n        0 1px 4px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(255, 255, 255, 0.08);\n    }\n    \n    .join-btn .btn-text {\n      font-size: 10px;\n      font-weight: 900;\n      letter-spacing: 1.5px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n    }\n    \n    /* ========== 会员功能区 - 机械仪表板风格 ========== */\n    .fanclub-member-section {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 14px;\n      padding: 16px;\n    }\n    \n    /* 机械面板基础样式 */\n    .member-panel {\n      position: relative;\n      background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(10, 10, 10, 0.95) 100%);\n      border: 2px solid rgba(80, 80, 80, 0.6);\n      border-radius: 6px;\n      padding: 12px;\n      box-shadow: \n        0 4px 12px rgba(0, 0, 0, 0.7),\n        inset 0 1px 2px rgba(255, 255, 255, 0.08),\n        inset 0 -1px 2px rgba(0, 0, 0, 0.5);\n      overflow: hidden;\n    }\n    \n    /* 机械纹理 */\n    .member-panel::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: \n        repeating-linear-gradient(\n          90deg,\n          transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.012) 2px,\n          rgba(255, 255, 255, 0.012) 4px\n        ),\n        repeating-linear-gradient(\n        0deg,\n        transparent,\n          transparent 2px,\n          rgba(255, 255, 255, 0.008) 2px,\n          rgba(255, 255, 255, 0.008) 4px\n      );\n      pointer-events: none;\n      opacity: 0.6;\n    }\n    \n    /* 机械外框装饰 */\n    .panel-frame {\n      position: absolute;\n      inset: 0;\n      pointer-events: none;\n      z-index: 1;\n    }\n    \n    .frame-screw {\n      position: absolute;\n      width: 8px;\n      height: 8px;\n      background: radial-gradient(circle, rgba(100, 100, 100, 0.9) 0%, rgba(60, 60, 60, 0.9) 60%, rgba(40, 40, 40, 0.9) 100%);\n      border-radius: 50%;\n      border: 1px solid rgba(30, 30, 30, 0.8);\n      box-shadow: \n        inset 0 1px 1px rgba(255, 255, 255, 0.2),\n        inset 0 -1px 1px rgba(0, 0, 0, 0.5),\n        0 1px 2px rgba(0, 0, 0, 0.5);\n    }\n    \n    .frame-screw::before {\n      content: \"\";\n      position: absolute;\n      inset: 2px;\n      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 45%, transparent 50%, rgba(255, 255, 255, 0.2) 55%);\n      border-radius: 50%;\n    }\n    \n    .frame-screw-tl { top: 4px; left: 4px; }\n    .frame-screw-tr { top: 4px; right: 4px; }\n    .frame-screw-bl { bottom: 4px; left: 4px; }\n    .frame-screw-br { bottom: 4px; right: 4px; }\n    \n    /* 标题栏 */\n    .panel-label {\n      position: relative;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 6px 8px;\n      background: rgba(0, 0, 0, 0.6);\n      border: 1px solid rgba(80, 80, 80, 0.5);\n      border-radius: 3px;\n      margin-bottom: 10px;\n      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.7);\n    }\n    \n    .label-text {\n      font-size: 7px;\n      font-weight: 900;\n      letter-spacing: 1.5px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.75);\n      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n    }\n    \n    /* ========== 签到面板 - 机械计数器 ========== */\n    \n    /* LED指示灯 */\n    .label-led {\n      width: 6px;\n      height: 6px;\n      border-radius: 50%;\n      box-shadow: \n        0 0 4px currentColor,\n        inset 0 1px 1px rgba(255, 255, 255, 0.3);\n      animation: ledPulse 2s ease-in-out infinite;\n    }\n    \n    .led-pending {\n      background: rgba(255, 180, 80, 0.95);\n      color: rgba(255, 180, 80, 0.8);\n    }\n    \n    .led-done {\n      background: rgba(100, 220, 120, 0.95);\n      color: rgba(100, 220, 120, 0.8);\n      animation: none;\n    }\n    \n    /* LED成功闪烁动画 */\n    .led-done.flash-success {\n      animation: ledFlashSuccess 0.6s ease-out;\n    }\n    \n    @keyframes ledPulse {\n      0%, 100% { opacity: 1; }\n      50% { opacity: 0.5; }\n    }\n    \n    @keyframes ledFlashSuccess {\n      0%, 100% { \n        opacity: 1;\n        box-shadow: 0 0 4px currentColor, inset 0 1px 1px rgba(255, 255, 255, 0.3);\n      }\n      16%, 50%, 83% { \n        opacity: 0.3;\n        box-shadow: 0 0 2px currentColor, inset 0 1px 1px rgba(255, 255, 255, 0.3);\n      }\n      33%, 66% { \n        opacity: 1;\n        box-shadow: 0 0 12px currentColor, inset 0 1px 1px rgba(255, 255, 255, 0.3);\n        transform: scale(1.3);\n      }\n    }\n    \n    /* 机械翻牌计数器 */\n    .flip-counter {\n      position: relative;\n      padding: 10px 8px;\n      background: rgba(0, 0, 0, 0.7);\n      border: 1px solid rgba(60, 60, 60, 0.6);\n      border-radius: 4px;\n      margin-bottom: 10px;\n      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.8);\n    }\n    \n    .counter-label {\n      font-size: 6px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.5);\n      text-align: center;\n      margin-bottom: 8px;\n    }\n    \n    .flip-digits {\n      display: flex;\n      justify-content: center;\n      gap: 4px;\n    }\n    \n    .flip-digit {\n      position: relative;\n    }\n    \n    .flip-card {\n      position: relative;\n      width: 26px;\n      height: 36px;\n      background: linear-gradient(180deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.95) 50%, rgba(25, 25, 25, 0.95) 50%, rgba(35, 35, 35, 0.95) 100%);\n      border: 1px solid rgba(80, 80, 80, 0.6);\n      border-radius: 3px;\n      box-shadow: \n        0 2px 4px rgba(0, 0, 0, 0.7),\n        inset 0 1px 1px rgba(255, 255, 255, 0.08);\n      overflow: hidden;\n      perspective: 200px;\n    }\n    \n    /* 翻牌动画 */\n    .flip-card.flipping .flip-top {\n      animation: flipTop 0.6s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n    \n    .flip-card.flipping .flip-bottom {\n      animation: flipBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n    \n    @keyframes flipTop {\n      0% { transform: rotateX(0deg); }\n      50% { transform: rotateX(-90deg); opacity: 0; }\n      51% { transform: rotateX(90deg); opacity: 0; }\n      100% { transform: rotateX(0deg); opacity: 1; }\n    }\n    \n    @keyframes flipBottom {\n      0% { transform: rotateX(0deg); }\n      50% { transform: rotateX(90deg); opacity: 0; }\n      51% { transform: rotateX(-90deg); opacity: 0; }\n      100% { transform: rotateX(0deg); opacity: 1; }\n    }\n    \n    .flip-top, .flip-bottom {\n      position: absolute;\n      left: 0;\n      right: 0;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 20px;\n      font-weight: 900;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n      text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);\n    }\n    \n    .flip-top {\n      top: 0;\n      height: 50%;\n      align-items: flex-end;\n      padding-bottom: 2px;\n    }\n    \n    .flip-bottom {\n      bottom: 0;\n      height: 50%;\n      align-items: flex-start;\n      padding-top: 2px;\n    }\n    \n    .flip-divider {\n      position: absolute;\n      top: 50%;\n      left: 0;\n      right: 0;\n      height: 1px;\n      background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.8) 10%, rgba(0, 0, 0, 0.8) 90%, transparent);\n      transform: translateY(-0.5px);\n      z-index: 2;\n    }\n    \n    /* 机械打卡按钮 */\n    .punch-btn {\n      position: relative;\n      width: 100%;\n      height: 44px;\n      background: none;\n      border: none;\n      cursor: pointer;\n      padding: 0;\n      transition: all 0.15s ease;\n      overflow: visible; /* 允许浮动文字溢出 */\n    }\n    \n    .punch-btn.disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n    }\n    \n    /* 打卡成功发光动画 */\n    .punch-btn.success-glow .btn-surface {\n      animation: btnSuccessGlow 0.8s ease-out;\n    }\n    \n    @keyframes btnSuccessGlow {\n      0%, 100% {\n        box-shadow: \n          0 4px 0 rgba(30, 30, 30, 0.9),\n          0 6px 8px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.15),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.5);\n    }\n      50% {\n        box-shadow: \n          0 4px 0 rgba(30, 30, 30, 0.9),\n          0 6px 8px rgba(0, 0, 0, 0.5),\n          inset 0 1px 0 rgba(255, 255, 255, 0.15),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.5),\n          0 0 20px rgba(100, 255, 120, 0.6),\n          inset 0 0 20px rgba(100, 255, 120, 0.2);\n      }\n    }\n    \n    .btn-shadow {\n      position: absolute;\n      inset: 0;\n      background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.4), transparent 70%);\n      border-radius: 6px;\n      transform: translateY(3px);\n      transition: transform 0.15s ease;\n    }\n    \n    .btn-surface {\n      position: relative;\n      width: 100%;\n      height: 100%;\n      background: linear-gradient(135deg, rgba(70, 70, 70, 0.95) 0%, rgba(50, 50, 50, 0.95) 100%);\n      border: 2px solid rgba(100, 100, 100, 0.7);\n      border-radius: 6px;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      gap: 2px;\n      box-shadow: \n        0 4px 0 rgba(30, 30, 30, 0.9),\n        0 6px 8px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(255, 255, 255, 0.15),\n        inset 0 -1px 0 rgba(0, 0, 0, 0.5);\n      transition: all 0.15s ease;\n    }\n    \n    .punch-btn:hover:not(.disabled) .btn-surface {\n      background: linear-gradient(135deg, rgba(90, 90, 90, 0.95) 0%, rgba(70, 70, 70, 0.95) 100%);\n      border-color: rgba(120, 120, 120, 0.8);\n    }\n    \n    .punch-btn:active:not(.disabled) .btn-surface {\n      transform: translateY(3px);\n      box-shadow: \n        0 1px 0 rgba(30, 30, 30, 0.9),\n        0 2px 4px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(0, 0, 0, 0.3),\n        inset 0 -1px 0 rgba(255, 255, 255, 0.08);\n    }\n    \n    .punch-btn:active:not(.disabled) .btn-shadow {\n      transform: translateY(0);\n    }\n    \n    .btn-label {\n      font-size: 10px;\n      font-weight: 900;\n      letter-spacing: 1.8px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n    }\n    \n    .btn-reward {\n      font-size: 7px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 215, 80, 0.9);\n      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n    }\n    \n    /* 浮动积分文字 */\n    .floating-points {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      font-size: 16px;\n      font-weight: 900;\n      font-family: 'Courier New', monospace;\n      color: rgba(100, 255, 120, 0.95);\n      text-shadow: \n        0 0 8px rgba(100, 255, 120, 0.8),\n        0 0 16px rgba(100, 255, 120, 0.4);\n      pointer-events: none;\n      z-index: 10;\n      animation: floatUp 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;\n    }\n    \n    @keyframes floatUp {\n      0% {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.5);\n      }\n      20% {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1.2);\n      }\n      100% {\n        opacity: 0;\n        transform: translate(-50%, -200%) scale(0.8);\n    }\n    }\n    \n    /* ========== 积分/等级面板 - VU表仪表盘 ========== */\n    \n    /* 等级徽章 */\n    .level-badge {\n      padding: 3px 8px;\n      background: linear-gradient(135deg, rgba(60, 60, 60, 0.9) 0%, rgba(40, 40, 40, 0.9) 100%);\n      border: 1px solid rgba(100, 100, 100, 0.6);\n      border-radius: 3px;\n      font-size: 7px;\n      font-weight: 900;\n      letter-spacing: 0.8px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 215, 80, 0.95);\n      box-shadow: \n        inset 0 1px 0 rgba(255, 255, 255, 0.1),\n        0 1px 2px rgba(0, 0, 0, 0.5);\n      text-shadow: 0 0 4px rgba(255, 215, 80, 0.4);\n    }\n    \n    /* LED点阵显示屏 */\n    .led-display {\n      position: relative;\n      padding: 10px 8px;\n      background: rgba(0, 0, 0, 0.85);\n      border: 1px solid rgba(60, 60, 60, 0.6);\n      border-radius: 4px;\n      margin-bottom: 10px;\n      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.9);\n      text-align: center;\n    }\n    \n    .led-display::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: \n        repeating-linear-gradient(\n          0deg,\n          transparent,\n          transparent 1px,\n          rgba(0, 180, 0, 0.015) 1px,\n          rgba(0, 180, 0, 0.015) 2px\n        );\n      pointer-events: none;\n      border-radius: 4px;\n    }\n    \n    .led-label {\n      font-size: 6px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.4);\n      margin-bottom: 6px;\n    }\n    \n    .led-digits {\n      font-size: 18px;\n      font-weight: 900;\n      font-family: 'Courier New', monospace;\n      color: rgba(100, 255, 120, 0.95);\n      text-shadow: \n        0 0 8px rgba(100, 255, 120, 0.6),\n        0 0 12px rgba(100, 255, 120, 0.3);\n      letter-spacing: 1px;\n      transition: transform 0.3s ease;\n    }\n    \n    /* LED数字滚动动画 */\n    .led-digits.counting {\n      animation: ledCount 0.8s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n    \n    @keyframes ledCount {\n      0% { \n        transform: translateY(10px);\n        opacity: 0.5;\n        filter: blur(2px);\n      }\n      100% { \n        transform: translateY(0);\n        opacity: 1;\n        filter: blur(0);\n      }\n    }\n    \n    /* LED数字增强发光（获得积分时） */\n    .led-digits.glow-boost {\n      animation: ledGlowBoost 0.6s ease-out;\n    }\n    \n    @keyframes ledGlowBoost {\n      0%, 100% {\n        text-shadow: \n          0 0 8px rgba(100, 255, 120, 0.6),\n          0 0 12px rgba(100, 255, 120, 0.3);\n      }\n      50% {\n        text-shadow: \n          0 0 16px rgba(100, 255, 120, 0.9),\n          0 0 24px rgba(100, 255, 120, 0.6),\n          0 0 32px rgba(100, 255, 120, 0.3);\n        transform: scale(1.05);\n      }\n    }\n    \n    .led-sublabel {\n      font-size: 7px;\n      font-weight: 700;\n      letter-spacing: 0.5px;\n      font-family: system-ui, sans-serif;\n      color: rgba(255, 255, 255, 0.55);\n      margin-top: 4px;\n    }\n    \n    /* VU表进度条 */\n    .vu-meter {\n      position: relative;\n    }\n    \n    .vu-info {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 6px;\n    }\n    \n    .vu-label {\n      font-size: 6px;\n      font-weight: 800;\n      letter-spacing: 0.8px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.5);\n    }\n    \n    .vu-need {\n      font-size: 7px;\n      font-weight: 900;\n      letter-spacing: 0.5px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 215, 80, 0.9);\n    }\n    \n    .vu-bar {\n      position: relative;\n      height: 24px;\n      background: linear-gradient(180deg, rgba(20, 20, 20, 0.9) 0%, rgba(10, 10, 10, 0.9) 100%);\n      border: 1px solid rgba(80, 80, 80, 0.6);\n      border-radius: 4px;\n      overflow: visible;\n      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.8);\n    }\n    \n    /* 刻度线 */\n    .vu-scale {\n      position: absolute;\n      inset: 0;\n      display: flex;\n      align-items: center;\n      pointer-events: none;\n      z-index: 1;\n    }\n    \n    .scale-mark {\n      position: absolute;\n      width: 1px;\n      height: 8px;\n      background: rgba(255, 255, 255, 0.2);\n      bottom: 2px;\n    }\n    \n    .scale-mark:nth-child(5n+1) {\n      height: 12px;\n      background: rgba(255, 255, 255, 0.3);\n    }\n    \n    /* VU表填充 */\n    .vu-fill {\n      position: absolute;\n      left: 0;\n      top: 0;\n      bottom: 0;\n      background: linear-gradient(90deg, \n        rgba(100, 255, 120, 0.7) 0%, \n        rgba(100, 255, 120, 0.6) 60%, \n        rgba(255, 215, 80, 0.7) 80%, \n        rgba(255, 150, 80, 0.8) 100%);\n      border-radius: 3px 0 0 3px;\n      transition: width 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);\n      box-shadow: 0 0 8px currentColor;\n      z-index: 2;\n    }\n    \n    .vu-glow {\n      position: absolute;\n      inset: 0;\n      background: linear-gradient(180deg, \n        rgba(255, 255, 255, 0.2) 0%, \n        transparent 50%, \n        rgba(0, 0, 0, 0.2) 100%);\n      border-radius: 3px 0 0 3px;\n    }\n    \n    /* VU表指针 */\n    .vu-needle {\n      position: absolute;\n      top: -4px;\n      bottom: -4px;\n      width: 3px;\n      transform: translateX(-50%);\n      z-index: 3;\n      transition: left 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);\n      pointer-events: none;\n    }\n    \n    /* VU表指针冲击动画（机械惯性） */\n    .vu-needle.impact {\n      animation: needleImpact 1s cubic-bezier(0.34, 1.56, 0.64, 1);\n    }\n    \n    @keyframes needleImpact {\n      0% { transform: translateX(-50%) scaleX(1); }\n      30% { transform: translateX(-50%) scaleX(1.5); }\n      50% { transform: translateX(-50%) scaleX(0.8); }\n      70% { transform: translateX(-50%) scaleX(1.2); }\n      100% { transform: translateX(-50%) scaleX(1); }\n    }\n    \n    .needle-head {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: 6px;\n      height: 100%;\n      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.9) 50%, transparent);\n      box-shadow: \n        0 0 6px rgba(255, 255, 255, 0.8),\n        0 0 12px rgba(255, 255, 255, 0.4);\n      animation: needleGlow 2s ease-in-out infinite;\n    }\n    \n    @keyframes needleGlow {\n      0%, 100% { opacity: 0.8; }\n      50% { opacity: 1; }\n    }\n    \n    /* 最高等级徽章 */\n    .max-level-badge {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      gap: 4px;\n      padding: 12px;\n      background: linear-gradient(135deg, rgba(60, 50, 20, 0.4) 0%, rgba(40, 35, 15, 0.4) 100%);\n      border: 2px solid rgba(255, 215, 80, 0.4);\n      border-radius: 6px;\n      box-shadow: \n        0 0 12px rgba(255, 215, 80, 0.2),\n        inset 0 1px 0 rgba(255, 215, 80, 0.1);\n      overflow: hidden;\n    }\n    \n    .badge-shine {\n      position: absolute;\n      inset: -50%;\n      background: linear-gradient(45deg, \n        transparent 30%, \n        rgba(255, 255, 255, 0.08) 50%, \n        transparent 70%);\n      animation: badgeShine 3s linear infinite;\n    }\n    \n    @keyframes badgeShine {\n      0% { transform: translateX(-100%) translateY(-100%); }\n      100% { transform: translateX(100%) translateY(100%); }\n    }\n    \n    .badge-icon {\n      font-size: 18px;\n      color: rgba(255, 215, 80, 0.95);\n      text-shadow: 0 0 8px rgba(255, 215, 80, 0.6);\n      z-index: 1;\n    }\n    \n    .badge-text {\n      font-size: 8px;\n      font-weight: 900;\n      letter-spacing: 1.2px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 215, 80, 0.95);\n      text-shadow: 0 0 6px rgba(255, 215, 80, 0.4);\n      z-index: 1;\n    }\n    \n    /* ========== 粉丝团留言通知 ========== */\n    .fanclub-notification-message {\n      position: fixed;\n      top: 80px;\n      left: 50%;\n      transform: translateX(-50%) translateY(-120%);\n      width: 90%;\n      max-width: 420px;\n      padding: 16px 18px;\n      background: linear-gradient(135deg, rgba(25, 25, 25, 0.98) 0%, rgba(15, 15, 15, 0.98) 100%);\n      border: 1.5px solid rgba(255, 255, 255, 0.28);\n      border-radius: 10px;\n      box-shadow: \n        0 8px 32px rgba(0, 0, 0, 0.8),\n        inset 0 1px 0 rgba(255, 255, 255, 0.12);\n      z-index: 10005;\n      opacity: 0;\n      transition: all 0.5s cubic-bezier(0.22, 0.85, 0.25, 1);\n      backdrop-filter: blur(10px);\n    }\n    \n    .fanclub-notification-message.show {\n      transform: translateX(-50%) translateY(0);\n      opacity: 1;\n    }\n    \n    .fanclub-notification-message::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 3px,\n        rgba(255, 255, 255, 0.015) 3px,\n        rgba(255, 255, 255, 0.015) 6px\n      );\n      border-radius: 10px;\n      pointer-events: none;\n    }\n    \n    .notification-tape-reel {\n      position: absolute;\n      top: 10px;\n      right: 50px;\n      width: 20px;\n      height: 20px;\n      border-radius: 50%;\n      background: radial-gradient(circle, rgba(40, 40, 40, 0.9), rgba(20, 20, 20, 0.9));\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);\n    }\n    \n    .notification-tape-reel::before {\n      content: \"\";\n      position: absolute;\n      inset: 3px;\n      border-radius: 50%;\n      background: conic-gradient(\n        rgba(255, 255, 255, 0.12) 0deg,\n        transparent 90deg,\n        rgba(255, 255, 255, 0.08) 180deg,\n        transparent 270deg,\n        rgba(255, 255, 255, 0.12) 360deg\n      );\n    }\n    \n    .notification-content {\n      display: flex;\n      align-items: flex-start;\n      gap: 12px;\n      position: relative;\n      z-index: 1;\n    }\n    \n    .notification-avatar {\n      flex-shrink: 0;\n      width: 36px;\n      height: 36px;\n      border-radius: 50%;\n      background: linear-gradient(135deg, rgba(50, 50, 50, 0.9), rgba(30, 30, 30, 0.9));\n      border: 1.5px solid rgba(255, 255, 255, 0.25);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: rgba(255, 255, 255, 0.7);\n      box-shadow: \n        0 2px 8px rgba(0, 0, 0, 0.5),\n        inset 0 1px 0 rgba(255, 255, 255, 0.1);\n    }\n    \n    .notification-text {\n      flex: 1;\n      min-width: 0;\n      font-size: 11px;\n      font-weight: 600;\n      line-height: 1.6;\n      letter-spacing: 0.3px;\n      font-family: system-ui, -apple-system, sans-serif;\n      color: rgba(255, 255, 255, 0.92);\n      word-wrap: break-word;\n      padding-top: 4px;\n    }\n    \n    .notification-close {\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      background: rgba(0, 0, 0, 0.5);\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 16px;\n      font-weight: 700;\n      color: rgba(255, 255, 255, 0.6);\n      cursor: pointer;\n      transition: all 0.25s ease;\n      z-index: 2;\n    }\n    \n    .notification-close:hover {\n      background: rgba(255, 255, 255, 0.12);\n      border-color: rgba(255, 255, 255, 0.4);\n      color: rgba(255, 255, 255, 0.95);\n      transform: rotate(90deg);\n    }\n    \n    /* ========== 徽章等级系统 ========== */\n    .fanclub-badges-section {\n      padding: 16px;\n      position: relative;\n    }\n    \n    /* 分隔装饰 */\n    .section-divider {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      margin-bottom: 18px;\n    }\n    \n    .divider-line {\n      flex: 1;\n      height: 1px;\n      background: linear-gradient(\n        90deg,\n        transparent,\n        rgba(255, 255, 255, 0.2) 50%,\n        transparent\n      );\n    }\n    \n    .divider-label {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 6px 12px;\n      background: rgba(0, 0, 0, 0.5);\n      border: 1px solid rgba(255, 255, 255, 0.18);\n      border-radius: 4px;\n      font-size: 9px;\n      font-weight: 900;\n      letter-spacing: 1.8px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.75);\n    }\n    \n    .tier-count {\n      font-size: 8px;\n      padding: 2px 6px;\n      background: rgba(255, 255, 255, 0.1);\n      border-radius: 3px;\n      color: rgba(255, 255, 255, 0.6);\n    }\n    \n    /* 徽章卡片 */\n    .badges-list {\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    }\n    \n    .badge-card {\n      position: relative;\n      display: flex;\n      align-items: stretch;\n      background: linear-gradient(135deg, rgba(25, 25, 25, 0.92) 0%, rgba(15, 15, 15, 0.92) 100%);\n      border: 1px solid rgba(255, 255, 255, 0.18);\n      border-radius: 8px;\n      overflow: hidden;\n      opacity: 0;\n      transform: perspective(1000px) rotateY(-15deg) scale(0.95);\n      transition: all 0.42s cubic-bezier(0.22, 0.85, 0.25, 1);\n      cursor: pointer;\n    }\n    \n    .badge-card:hover {\n      border-color: rgba(255, 255, 255, 0.35);\n      transform: perspective(1000px) rotateY(0deg) scale(1.02) translateX(4px);\n      box-shadow: \n        0 6px 20px rgba(0, 0, 0, 0.5),\n        -3px 0 12px rgba(255, 255, 255, 0.08);\n    }\n    \n    /* 卡片光晕 */\n    .card-glow {\n      position: absolute;\n      inset: -2px;\n      border-radius: 8px;\n      opacity: 0;\n      transition: opacity 0.4s ease;\n      pointer-events: none;\n      z-index: 0;\n    }\n    \n    .badge-card:hover .card-glow {\n      opacity: 1;\n    }\n    \n    .bronze-glow {\n      background: radial-gradient(circle at 30% 30%, rgba(205, 127, 50, 0.15), transparent 70%);\n    }\n    \n    .silver-glow {\n      background: radial-gradient(circle at 30% 30%, rgba(192, 192, 192, 0.18), transparent 70%);\n    }\n    \n    .gold-glow {\n      background: radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.2), transparent 70%);\n    }\n    \n    .platinum-glow {\n      background: radial-gradient(circle at 30% 30%, rgba(229, 228, 226, 0.25), transparent 70%);\n    }\n    \n    /* 磁条装饰 */\n    .card-magnetic-strip {\n      position: absolute;\n      bottom: 8px;\n      left: 8px;\n      right: 8px;\n      height: 2px;\n      background: repeating-linear-gradient(\n        90deg,\n        rgba(255, 255, 255, 0.08),\n        rgba(255, 255, 255, 0.08) 4px,\n        transparent 4px,\n        transparent 8px\n      );\n      z-index: 1;\n    }\n    \n    /* 等级徽章 */\n    .badge-emblem {\n      flex-shrink: 0;\n      width: 70px;\n      padding: 14px 10px;\n      background: linear-gradient(135deg, rgba(35, 35, 35, 0.8), rgba(20, 20, 20, 0.8));\n      border-right: 1px solid rgba(255, 255, 255, 0.12);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      position: relative;\n      z-index: 2;\n    }\n    \n    .emblem-ring {\n      position: absolute;\n      width: 46px;\n      height: 46px;\n      border-radius: 50%;\n      border: 1.5px solid rgba(255, 255, 255, 0.2);\n      box-shadow: \n        inset 0 2px 6px rgba(0, 0, 0, 0.6),\n        0 2px 8px rgba(0, 0, 0, 0.4);\n    }\n    \n    .emblem-number {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      z-index: 1;\n    }\n    \n    .level-prefix {\n      font-size: 7px;\n      font-weight: 800;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.5);\n    }\n    \n    .level-num {\n      font-size: 18px;\n      font-weight: 900;\n      letter-spacing: 1px;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.95);\n      text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);\n    }\n    \n    .emblem-shine {\n      position: absolute;\n      top: 6px;\n      right: 8px;\n      width: 12px;\n      height: 12px;\n      border-radius: 50%;\n      background: radial-gradient(circle, rgba(255, 255, 255, 0.25), transparent 70%);\n      filter: blur(3px);\n    }\n    \n    /* 卡片内容 */\n    .badge-content {\n      flex: 1;\n      min-width: 0;\n      padding: 14px 16px 14px 14px;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      gap: 8px;\n      z-index: 2;\n    }\n    \n    .badge-title {\n      font-size: 12px;\n      font-weight: 900;\n      letter-spacing: 0.8px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.96);\n      margin-bottom: 2px;\n      line-height: 1.3;\n    }\n    \n    .badge-details {\n      display: flex;\n      flex-direction: column;\n      gap: 5px;\n    }\n    \n         .detail-row {\n       display: flex;\n       align-items: flex-start;\n       gap: 7px;\n       font-size: 9px;\n       line-height: 1.45;\n     }\n     \n     .requirement-row {\n       font-weight: 600;\n       font-family: 'Courier New', monospace;\n     }\n     \n     .requirement-row .detail-text {\n       color: rgba(255, 255, 255, 0.82);\n     }\n     \n     .benefit-row {\n       font-weight: 700;\n       font-family: system-ui, -apple-system, sans-serif;\n     }\n     \n     .benefit-row .detail-text {\n       color: rgba(255, 255, 255, 0.92);\n     }\n     \n     .detail-icon {\n       flex-shrink: 0;\n       margin-top: 1px;\n       color: rgba(255, 255, 255, 0.75);\n     }\n     \n     .detail-text {\n       flex: 1;\n       min-width: 0;\n     }\n    \n    /* 全息扫光效果 */\n    .hologram-sweep {\n      position: absolute;\n      top: 0;\n      left: -100%;\n      width: 30%;\n      height: 100%;\n      background: linear-gradient(\n        90deg,\n        transparent,\n        rgba(255, 255, 255, 0.08) 50%,\n        transparent\n      );\n      transform: skewX(-20deg);\n      pointer-events: none;\n      z-index: 10;\n    }\n    \n    .badge-card:hover .hologram-sweep {\n      animation: hologramSweep 1.2s ease-out;\n    }\n    \n    @keyframes hologramSweep {\n      0% { left: -100%; }\n      100% { left: 200%; }\n    }\n    \n    /* 加载状态 */\n    .fanclub-loading {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      padding: 70px 20px;\n      gap: 22px;\n    }\n    \n    .loading-spinner {\n      width: 44px;\n      height: 44px;\n      border: 3px solid rgba(255, 255, 255, 0.12);\n      border-top-color: rgba(255, 255, 255, 0.85);\n      border-radius: 50%;\n      animation: spinnerRotate 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;\n    }\n    \n    @keyframes spinnerRotate {\n      to { transform: rotate(360deg); }\n    }\n    \n    .loading-text {\n      font-size: 11px;\n      font-weight: 900;\n      letter-spacing: 2.5px;\n      text-transform: uppercase;\n      font-family: 'Courier New', monospace;\n      color: rgba(255, 255, 255, 0.7);\n      animation: loadingTextPulse 1.8s ease-in-out infinite;\n    }\n    \n    @keyframes loadingTextPulse {\n      0%, 100% { opacity: 0.7; }\n      50% { opacity: 0.25; }\n    }\n    \n    /* ========== 移动端适配 ========== */\n    @media (max-width: 600px) {\n      .fanclub-panel {\n        width: 100%;\n        max-width: none;\n        max-height: 78vh;\n        border-radius: 22px 22px 0 0;\n      }\n      \n      .fanclub-vip-header {\n        padding: 18px 14px;\n      }\n      \n      .tape-reel-deco {\n        width: 24px;\n        height: 24px;\n      }\n      \n      .tape-reel-left {\n        left: 10px;\n      }\n      \n      .tape-reel-right {\n        right: 10px;\n      }\n      \n      .reel-spin {\n        width: 14px;\n        height: 14px;\n      }\n      \n      .vip-badge {\n        padding: 4px 12px;\n      }\n      \n      .badge-text {\n        font-size: 8px;\n        letter-spacing: 2px;\n      }\n      \n      .club-name-display {\n        margin-top: 26px;\n        padding: 0 45px;\n      }\n      \n      .club-name-text {\n        font-size: 12px;\n        letter-spacing: 1.5px;\n      }\n      \n      .fanclub-lcd-panel {\n        padding: 14px;\n      }\n      \n      .lcd-display-grid {\n        gap: 10px;\n      }\n      \n      .lcd-stat {\n        padding: 12px 8px;\n      }\n      \n      .lcd-stat-icon svg {\n        width: 16px;\n        height: 16px;\n      }\n      \n      .lcd-stat-label {\n        font-size: 6px;\n      }\n      \n      .lcd-stat-value {\n        font-size: 13px;\n      }\n      \n      .fanclub-badges-section {\n        padding: 12px;\n      }\n      \n      .section-divider {\n        margin-bottom: 14px;\n      }\n      \n      .divider-label {\n        padding: 5px 10px;\n        font-size: 8px;\n        letter-spacing: 1.5px;\n      }\n      \n      .divider-label svg {\n        width: 12px;\n        height: 12px;\n      }\n      \n      .badges-list {\n        gap: 10px;\n      }\n      \n      .badge-emblem {\n        width: 62px;\n        padding: 12px 8px;\n      }\n      \n      .emblem-ring {\n        width: 40px;\n        height: 40px;\n      }\n      \n      .level-num {\n        font-size: 16px;\n      }\n      \n      .badge-content {\n        padding: 12px 12px 12px 10px;\n      }\n      \n      .badge-title {\n        font-size: 11px;\n      }\n      \n      .detail-row {\n        font-size: 8px;\n      }\n      \n      .detail-icon svg {\n        width: 10px;\n        height: 10px;\n      }\n    }\n  ",document.head.appendChild(n)}();let i=document.getElementById("fanClubContainer");i||(i=document.createElement("div"),i.id="fanClubContainer",t.appendChild(i)),i.innerHTML='\n    <div class="fanclub-overlay" id="fanClubOverlay" onclick="closeFanClub()"></div>\n    <div class="fanclub-panel" id="fanClubPanel">\n      <div class="fanclub-loading">\n        <div class="loading-spinner"></div>\n        <div class="loading-text">LOADING FAN CLUB DATA...</div>\n      </div>\n    </div>\n  ',setTimeout(()=>{const n=document.getElementById("fanClubOverlay"),e=document.getElementById("fanClubPanel");n&&n.classList.add("active"),e&&e.classList.add("active")},10);try{let t=e();try{if(await t.open(),!t.xFanClubs)return console.error("❌ [粉丝团] 数据库表 xFanClubs 不存在"),console.error(`❌ [粉丝团] 当前数据库版本: ${t.verno}, 需要版本 9+`),mn("数据库版本过低，请刷新页面","error"),void Sr();if(!t.xFanClubMemberships)return console.error("❌ [粉丝团] 数据库表 xFanClubMemberships 不存在"),console.error(`❌ [粉丝团] 当前数据库版本: ${t.verno}, 需要版本 10+`),mn("数据库需要升级，请刷新页面","error"),void Sr()}catch(n){return console.error("❌ [粉丝团] 数据库打开失败:",n),mn("数据库错误，请刷新页面","error"),void Sr()}const o=await t.xFanClubs.get(a);o&&o.data?(Ir.currentData=o.data,Mr(o.data)):await async function(e){if(Ir.isGenerating)return void console.warn("⚠️ [粉丝团] 正在生成中，请勿重复触发");if(Ir.isGenerating=!0,!e)throw new Error("generateFanClubData: streamerHandle 参数为空");if("string"!=typeof e)throw new Error("generateFanClubData: streamerHandle 必须是字符串，当前类型: "+typeof e);if(""===e.trim())throw new Error("generateFanClubData: streamerHandle 是空字符串");try{const{apiConfig:t,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),i=n.currentAccountId||"main",r=await a.xUserProfile.get(i);if(!r)throw new Error("未找到用户资料");const l=s.buildUserXProfileInfo(r),c=await s.getUnifiedProfile(e,{userProfileInfo:l});if(!c)throw new Error(`未找到主播资料: ${e}`);try{const n=await a.xAccountProfiles.get(e);if(n)n.tweets&&n.tweets.length>0&&(c.tweets&&0!==c.tweets.length||(c.tweets=n.tweets));else{const n=(await a.xAccountProfiles.toCollection().keys()).filter(n=>String(n).toLowerCase().includes(e.toLowerCase())||e.toLowerCase().includes(String(n).toLowerCase()));if(n.length>0&&n[0]){const e=await a.xAccountProfiles.get(n[0]);e&&e.tweets&&(c.tweets=e.tweets)}}}catch(n){console.error("❌ [诊断] 查询失败:",n)}let p=0,m=s.buildBaseSystemPrompt({userPrompt:o.userPrompt,worldSetting:o.worldSetting});p=d.logTokenUsage("第15情景-粉丝团生成","基础系统提示词",m,p);const x=await s.getApplicableWorldBooks("live",{boundCharacters:o.boundCharacters||[]});x&&(m+=x,p=d.logTokenUsage("第15情景-粉丝团生成","世界书内容",x,p));const u=m.length;m+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台直播系统的粉丝团数据生成器。请为当前主播生成完整的粉丝团数据。\n\n";const h=m.substring(u);p=d.logTokenUsage("第15情景-粉丝团生成","核心任务说明",h,p);const f=s.formatProfileForPrompt(c,{includeType:!0,includeTweets:!0,includeRelationships:!1});m+=f,p=d.logTokenUsage("第15情景-粉丝团生成","主播资料信息",f,p);const b=m.length;m+='\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎨 核心原则：深度个性化生成\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🚨 **最高优先级要求**：\n- 仔细分析上述主播的完整资料（人设、性格、推文风格、语言习惯）\n- 所有生成内容（粉丝团名称、等级名称、福利描述、留言）都必须体现主播的独特个性\n- 不要生成通用模板！每个主播的粉丝团都应该是独一无二的\n- 如果主播有明确的人设描述，必须严格遵循该人设的语言风格和性格特点\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 详细生成要求\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n1. 【粉丝团名称】：\n   \n   🎯 个性化要求：\n   - 必须深度挖掘主播的特色：昵称梗、口头禅、代表性特征、内容主题、粉丝互动方式\n   - 优先使用主播自身的标签、昵称变体、或粉丝对主播的称呼\n   - 如果主播是歌手/音乐人：考虑用音乐相关的名称\n   - 如果主播是游戏主播：考虑用游戏术语或梗\n   - 如果主播有特殊人设：必须与人设强关联\n   - 避免通用词汇如「仙盟」「守护者」等，除非符合主播特定风格\n   \n   ✅ 示例对比：\n   - 通用（差）："星辰守护者"\n   - 个性化（好）："劣犬收容所"（主播人设为M，粉丝自称劣犬）\n   - 个性化（好）："夜雨听风会"（主播常深夜直播，声音治愈）\n\n2. 【粉丝团数据】：\n   \n   - 粉丝团人数：根据主播影响力和推文互动量决定（1,000-50,000）\n   - 粉丝团贡献：已送出的总积分（500,000-10,000,000）\n   - 粉丝团排名：在平台内的排名（1-500，越小越靠前）\n\n3. 【粉丝团等级系统（共20级）】：\n   \n   🎯 个性化要求：\n   \n   A. **等级名称**：\n      - 必须与主播的人设、内容主题、语言风格高度相关\n      - 不要用通用词汇（如「见习粉丝」「初级支持者」）\n      - 根据主播特点创造独特的等级称呼体系\n      - 20个等级名称要有连贯性和递进感\n      \n      ✅ 示例（音乐主播）：\n      LV1: 偶遇听众 → LV5: 旋律收藏家 → LV10: 专辑鉴赏师 → LV20: 灵魂共鸣者\n      \n      ✅ 示例（游戏主播）：\n      LV1: 新手观战 → LV5: 铁粉小队 → LV10: 王牌支援 → LV20: 传奇并肩\n   \n   B. **积分要求**（固定梯度）：\n      - LV1: 0积分（进入即获得）\n      - LV2: 100积分\n      - LV3: 200积分\n      - LV4: 500积分\n      - LV5: 1000积分\n      - LV6: 1500积分\n      - LV7: 2500积分\n      - LV8: 4000积分\n      - LV9: 5500积分\n      - LV10: 7500积分\n      - LV11: 10000积分\n      - LV12: 13000积分\n      - LV13: 16000积分\n      - LV14: 20000积分\n      - LV15: 25000积分\n      - LV16: 32000积分\n      - LV17: 40000积分\n      - LV18: 50000积分\n      - LV19: 65000积分\n      - LV20: 100000积分\n      - 达成条件格式：「累计XXX积分」\n   \n   C. **福利描述**：\n      - 必须符合主播能提供的实际内容\n      - 根据主播的内容类型定制福利\n      - 低等级：基础互动权益（弹幕颜色、专属表情）\n      - 中等级：内容权益（专属直播、提前观看）\n      - 高等级：深度互动（私信优先、内容定制）\n      - 每条福利要有主播的语言风格特色\n      \n      ✅ 示例对比：\n      - 通用（差）："专属称号"\n      - 个性化（好）："劣犬认证徽章（主播亲自认领）"\n      - 个性化（好）："深夜FM专属邀请（仅限20人）"\n\n4. 【主播留言内容（3类）】：\n   \n   🎯 个性化要求：所有留言必须模仿主播的真实语言风格\n   \n   A. **进入粉丝团欢迎语**：\n      - 深度分析主播的推文和简介，提取语言特点\n      - 是否使用方言、口头禅、特殊称呼？\n      - 是正式、亲切、调皮、冷酷、还是其他风格？\n      - 如何称呼粉丝？「宝贝」「各位」「大家」还是特殊昵称？\n      - 50-100字左右\n      \n      ✅ 示例（傲娇主播）：\n      "哼，既然你都找到这里了，就勉强收留你吧...但可别以为加入了就能为所欲为哦"\n      \n      ✅ 示例（温柔主播）：\n      "欢迎来到我们的小天地呀~以后就是一家人啦，有什么想说的随时来找我聊天哦"\n   \n   B. **每日签到留言**（生成5条不同内容）：\n      - 5条内容风格各异但都符合主播人设\n      - 可以包括：感谢、鼓励、调侃、撒娇、吐槽等\n      - 必须用主播会说的话，不要用通用客套话\n      - 每条30-60字左右\n   \n      ✅ 示例（高冷主播）：\n      1. "嗯，看到你了"\n      2. "今天也来了？还挺有毅力"\n      3. "签到记录已更新，不用谢"\n      4. "别以为每天签到我就会对你特殊一点"\n      5. "...其实，能看到你来我还挺高兴的"\n   \n   C. **等级升级留言模板**（生成3组不同档次的留言）：\n      \n      🎯 重要：根据等级高低，留言的语气和情感强度应该递进！\n      \n      **低等级留言**（LV1-7，共3条）：\n      - 适用于新粉丝升级，语气轻松、鼓励性\n      - 包含占位符：{level}、{levelName}\n      - 体现"初步认可"的态度\n      - 40-60字左右\n      \n      ✅ 示例（傲娇主播）：\n      1. "哼，升到{level}级【{levelName}】了？还算有点毅力"\n      2. "才{level}级啊...不过比那些路人强多了"\n      3. "【{levelName}】？行吧，勉强承认你的努力"\n      \n      ✅ 示例（温柔主播）：\n      1. "恭喜升到{level}级【{levelName}】啦，继续加油哦~"\n      2. "哇，你已经是【{levelName}】了呢，真棒！"\n      3. "看到你升到{level}级真开心，一起努力吧"\n      \n      **中等级留言**（LV8-14，共3条）：\n      - 适用于稳定粉丝升级，语气认可、重视\n      - 包含占位符：{level}、{levelName}\n      - 体现"深度认可"的态度\n      - 50-70字左右\n      \n      ✅ 示例（傲娇主播）：\n      1. "{level}级【{levelName}】了...你还真是执着呢，不过我可不会因此对你特殊对待哦"\n      2. "都到【{levelName}】了？哼，算你有心，这是你应得的"\n      3. "升到{level}级了啊...其实，能有你这样的支持者我还挺...总之谢谢"\n      \n      ✅ 示例（温柔主播）：\n      1. "恭喜达到{level}级【{levelName}】！你的陪伴对我来说真的很重要"\n      2. "哇！【{levelName}】诶！一路走来辛苦了，以后也请多指教"\n      3. "你已经是{level}级啦，感谢一直以来的支持，真的很感动"\n      \n      **高等级留言**（LV15-20，共3条）：\n      - 适用于核心粉丝升级，语气感激、特殊\n      - 包含占位符：{level}、{levelName}\n      - 体现"深度感激、特殊关系"的态度\n      - 60-80字左右\n      \n      ✅ 示例（傲娇主播）：\n      1. "{level}级【{levelName}】...你这家伙，为什么要对我这么好...我、我才不会哭呢"\n      2. "【{levelName}】是给真正重要的人的位置...你，已经是我无法失去的存在了"\n      3. "都{level}级了...真的谢谢你一直陪着我，虽然我嘴上不会说，但你懂的对吧"\n      \n      ✅ 示例（温柔主播）：\n      1. "恭喜达到{level}级【{levelName}】！能有你这样的支持者是我的幸运，真的非常感谢"\n      2. "【{levelName}】...这个称号是我留给最特别的人的，你一直都在，真好"\n      3. "{level}级了呢...谢谢你见证了我的成长，以后也请一直陪在我身边好吗"\n\n5. 【风格约束】：\n   \n   - ✅ 必须：深度个性化，体现主播独特性\n   - ✅ 必须：符合主播的人设、语言习惯、性格特点\n   - ✅ 必须：等级名称有主题连贯性\n   - ✅ 必须：福利描述实际且有吸引力\n   - ❌ 禁止：使用emoji表情\n   - ❌ 禁止：通用模板化内容\n   - ❌ 禁止：脱离主播人设的表达\n\n【输出格式】（严格JSON）：\n\n```json\n{\n  "clubName": "粉丝团名称",\n  "memberCount": 人数,\n  "totalContribution": 总贡献积分,\n  "platformRank": 平台排名,\n  "levelSystem": [\n    {\n      "level": 1,\n      "levelName": "等级名称",\n      "requirement": "累计XXX积分",\n      "requiredPoints": 具体积分数字,\n      "benefit": "福利描述"\n    }\n  ],\n  "messages": {\n    "welcome": "进入粉丝团的欢迎留言",\n    "checkin": [\n      "每日签到留言1",\n      "每日签到留言2",\n      "每日签到留言3",\n      "每日签到留言4",\n      "每日签到留言5"\n    ],\n    "levelUpLow": [\n      "低等级升级留言1（LV1-7）",\n      "低等级升级留言2",\n      "低等级升级留言3"\n    ],\n    "levelUpMid": [\n      "中等级升级留言1（LV8-14）",\n      "中等级升级留言2",\n      "中等级升级留言3"\n    ],\n    "levelUpHigh": [\n      "高等级升级留言1（LV15-20）",\n      "高等级升级留言1",\n      "高等级升级留言3"\n    ]\n  },\n  "fanClubContactConfig": {\n    "willContactPrivately": true,\n    "contactLevelThreshold": 15,\n    "persistAfterRejection": false\n  }\n}\n```\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 【主播粉丝团私联配置 - fanClubContactConfig】\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 现实场景：主播可能会主动私联粉丝团高等级用户，维护金钱关系\n\n**配置要求**：\n- willContactPrivately: 布尔值，主播是否会主动私联高等级粉丝\n- contactLevelThreshold: 数字（1-20），达到粉丝团第几级会触发私联（建议10-18级，门槛较高）\n- persistAfterRejection: 布尔值，被拒绝后是否会持续发送私信\n\n**决策依据**（根据主播性格）：\n- 💰 势利/商业化主播：更可能私联高等级粉丝（willContactPrivately: true, threshold: 10-15）\n- 🎭 高冷/耍大牌主播：可能不屑于主动私联（willContactPrivately: false）\n- 🤝 平易近人主播：可能私联但门槛更宽松（willContactPrivately: true, threshold: 5-10）\n- 😤 傲娇主播：可能私联但被拒绝后不会持续（persistAfterRejection: false）\n- 💪 执着/粘人主播：被拒绝后会持续私联（persistAfterRejection: true）\n\n✅ 示例（添加到JSON根对象中）：\n{\n  "fanClubContactConfig": {\n    "willContactPrivately": true,\n    "contactLevelThreshold": 15,\n    "persistAfterRejection": false\n  }\n}\n\n⚠️ 重要：\n- contactLevelThreshold 表示"粉丝团第几级及以上"会被私联\n- threshold=15 表示达到15级及以上会被私联\n- threshold=10 表示达到10级及以上会被私联\n- 这个配置会影响主播与高消费用户的互动方式\n- 低等级的门槛会让主播显得过于功利，建议10级以上\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n⚠️ JSON格式重要说明：\n- 严格遵守JSON格式\n- levelSystem数组必须包含完整的20个等级\n- 每个等级必须有requiredPoints字段（具体积分数字）\n- messages对象必须包含5个字段：\n  - welcome（字符串，1条）\n  - checkin（数组，5条）\n  - levelUpLow（数组，3条，适用于LV1-7）\n  - levelUpMid（数组，3条，适用于LV8-14）\n  - levelUpHigh（数组，3条，适用于LV15-20）\n- fanClubContactConfig对象必须包含3个字段（必填）\n- 所有留言禁止使用emoji表情\n- 所有留言必须包含{level}和{levelName}占位符\n- 所有字段都必须填写\n- 数值要合理且递增\n';const v=m.substring(b);p=d.logTokenUsage("第15情景-粉丝团生成","粉丝团数据生成要求",v,p),d.logFinalPrompt("第15情景-粉丝团生成",m);let y=`请为主播 ${c.name} (${c.handle}) 生成完整的粉丝团数据。\n\n`;if("character"===c.type&&c.characterData){(c.characterData.aiPersona||"").trim()&&(y+='🚨 重要提醒：该主播是角色，有明确的人设描述。请仔细阅读上述资料中的"人设描述"部分，确保生成的所有内容（粉丝团名称、等级名称、福利描述、留言）都深度符合该角色的性格特点和语言风格。\n\n')}c.tweets&&c.tweets.length>0&&(y+=`📝 语言风格参考：主播有 ${c.tweets.length} 条推文记录，请从中学习其真实的语言习惯、用词偏好、语气特点，用于生成留言内容。\n\n`),y+=`🎯 核心要求：生成的内容必须让人一看就知道这是 ${c.name} 的粉丝团，而不是任何其他主播的粉丝团。追求独特性和鲜明个性。`;const w=await g.sendAIRequest({apiConfig:t,systemPrompt:m,messages:[{role:"user",content:y}],temperature:.9}),k=g.parseJSONResponse(w);if(!k.clubName||!k.levelSystem||20!==k.levelSystem.length||!k.messages||!k.messages.welcome||!k.messages.checkin||!Array.isArray(k.messages.checkin)||k.messages.checkin.length<5)throw new Error("粉丝团数据不完整：缺少名称、等级系统（20级）或基础留言内容");if(!(k.messages.levelUp||k.messages.levelUpLow&&k.messages.levelUpMid&&k.messages.levelUpHigh))throw new Error("粉丝团数据不完整：缺少升级留言（levelUp/levelUpLow/Mid/High）");!k.messages.levelUp&&k.messages.levelUpLow&&(k.messages.levelUp=[...k.messages.levelUpLow,...k.messages.levelUpMid,...k.messages.levelUpHigh],console.log(`✅ [粉丝团] 已合并分层级留言 (${k.messages.levelUp.length}条)`));const $={handle:e,data:k,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};if(!$.handle||""===$.handle.trim())throw new Error(`数据库主键 handle 为空，无法保存。原始值: "${e}"`);try{await a.xFanClubs.put($)}catch(n){throw console.error("❌ [粉丝团] 数据库保存失败:",n),console.error("❌ [粉丝团] 尝试保存的记录:",$),new Error(`数据库保存失败: ${n.message}`)}Ir.currentData=k,Mr(k),mn("粉丝团数据生成成功","success")}catch(n){console.error("❌ [第15情景] 粉丝团生成失败:",n),mn(`粉丝团生成失败: ${n.message}`,"error"),Sr()}finally{Ir.isGenerating=!1}}(a)}catch(n){console.error("❌ [粉丝团] 打开失败:",n),mn(`粉丝团加载失败: ${n.message}`,"error"),Sr()}},n.closeFanClub=Sr,n.addFanClubPoints=async function(n,t){try{const a=e();if(!a)return console.error("❌ [会员系统] 无法获取数据库实例"),null;const i=r.clean(n),s=await a.xFanClubMemberships.get(i);if(!s||!s.joined)return console.error("❌ [会员系统] 用户未加入粉丝团"),null;const l=s.level,c=s.points+t,d=await Er(c,i),p=d>l;if(s.points=c,s.level=d,await a.xFanClubMemberships.put(s),p&&console.log(`🎉 [会员系统] 等级提升: LV${l} -> LV${d}`),p){try{const n=await a.xFanClubs.get(i);if(n&&n.data&&n.data.levelSystem&&n.data.messages){const e=n.data.levelSystem.find(n=>n.level===d);if(e&&n.data.messages.levelUp){let t=n.data.messages.levelUp;if(Array.isArray(t)){d<=7&&t.length>=3?t=t.slice(0,3):d<=14&&t.length>=6?t=t.slice(3,6):t.length>=9&&(t=t.slice(6,9));var o=t[Math.floor(Math.random()*t.length)]}else o=t;Rr(o.replace("{level}",d).replace("{levelName}",e.levelName),"levelup")}}}catch(n){console.warn("⚠️ [会员系统] 获取升级留言失败:",n)}try{const n=await a.xFanClubs.get(i),e=n?.data?.levelSystem?.find(n=>n.level===d);Hr(i,"fanClub",{fanClubLevel:d,fanClubLevelName:e?.levelName||"",fanClubPoints:s.points,giftHistory:[],danmakuHistory:[]}).catch(n=>{console.error("❌ [主播私联检测] 失败:",n)})}catch(n){console.error("❌ [主播私联检测] 异常:",n)}}return Ir.isOpen&&await Lr(i,{pointsAdded:t,checkinSuccess:!1,checkinDaysChanged:!1}),s}catch(n){throw console.error("❌ [会员系统] 增加积分失败:",n),n}},n.streamerContactMessageCache=n.streamerContactMessageCache||{},n.streamerContactRejections=n.streamerContactRejections||{},n.showStreamerContactModal=jr,n.checkStreamerContactTrigger=Hr,n.handleStreamerContactAccept=async function(t){try{console.log("✅ [主播私联] 用户选择接收");const o=n.streamerContactMessageCache[t];if(!o)return void mn("数据丢失，请重试","error");const{messageData:a,generatedMessages:i,trigger:s}=o,l=document.getElementById("streamer-contact-modal");if(l){const n=l.querySelector(".invitation-card"),e=l.querySelector(".backdrop-layer"),t=l.querySelector(".envelope-container");n&&n.classList.add("accepting"),e&&e.classList.remove("active"),t&&t.classList.add("leaving"),await new Promise(n=>setTimeout(n,800)),l.remove()}Aa(),"function"==typeof closeLiveStreamList&&closeLiveStreamList(),"function"==typeof navigateToXHome?navigateToXHome():"function"==typeof navigateTo&&navigateTo("home"),await new Promise(n=>setTimeout(n,300));const c=e();if(!c)return void console.error("❌ [主播私联接收] 无法获取数据库实例");const d=`messageConversation_${vt||"main"}_${a.id}`;await c.xAccountProfiles.put({handle:d,name:"messageConversation",data:{senderProfile:{name:a.user.name,handle:a.user.handle,avatar:a.user.avatar,verified:a.user.verified},messages:i},messageId:a.id,accountId:vt||"main",updatedAt:(new Date).toISOString()});const p=`messagesList_${vt||"main"}`,g=await c.xAccountProfiles.get(p);let m=g?.data||[];if(-1===m.findIndex(n=>n.id===a.id)){const n={id:a.id,userName:a.user.name,userHandle:a.user.handle.replace("@",""),userAvatar:a.user.avatar,lastMessage:i[i.length-1]?.content||"",timestamp:(new Date).toISOString(),unread:!0};m.unshift(n),await c.xAccountProfiles.put({handle:p,name:"messagesList",data:m,updatedAt:(new Date).toISOString()}),console.log("✅ [主播私联] 已添加到联系人列表")}"function"==typeof openMessageDetail&&await openMessageDetail(a);const x=r.clean(a.user.handle),u=`streamerContactHistory_${x}`,h=await c.xAccountProfiles.get(u),f=h?.data||{};f[s]={accepted:!0,rejected:!1,timestamp:Date.now()},await c.xAccountProfiles.put({handle:u,name:"streamerContactHistory",data:f,updatedAt:(new Date).toISOString()}),console.log(`✅ [主播私联] 已记录接受历史: ${x} - ${s}`),delete n.streamerContactMessageCache[t],mn("已接收主播私信","success")}catch(n){console.error("❌ [主播私联] 接收失败:",n),mn("接收失败: "+n.message,"error")}},n.handleStreamerContactReject=async function(t){console.log("🚫 [主播私联] 用户选择拒绝");const o=n.streamerContactMessageCache[t];if(o){const{trigger:t,messageData:a}=o,i=a.user.handle,s=`${i}_${t}`;n.streamerContactRejections[s]=Date.now(),console.log("📝 [主播私联] 已记录拒绝:",s);const l=e();if(l)try{const n=r.clean(i),e=`streamerContactHistory_${n}`,o=await l.xAccountProfiles.get(e),a=o?.data||{};a[t]={accepted:!1,rejected:!0,timestamp:Date.now()},await l.xAccountProfiles.put({handle:e,name:"streamerContactHistory",data:a,updatedAt:(new Date).toISOString()}),console.log(`✅ [主播私联] 已记录拒绝历史: ${n} - ${t}`)}catch(n){console.error("❌ [主播私联] 保存拒绝历史记录失败:",n)}}const a=document.getElementById("streamer-contact-modal");if(a){const n=a.querySelector(".envelope-container"),e=a.querySelector(".invitation-card"),t=a.querySelector(".backdrop-layer");n&&n.classList.add("leaving"),e&&e.classList.remove("active"),t&&t.classList.remove("active"),await new Promise(n=>setTimeout(n,600)),a.remove()}mn("已拒绝主播私信","info")};const Ur={greeting:{text:"你想要和Aron玩游戏吗^^",mood:"happy",buttons:!0},yes:{text:"太好了！让我们开始吧~^^",mood:"excited",buttons:!1},no:{text:"哦...好吧那改天再玩吧~\n我会一直在这里等你的^^",mood:"sad",buttons:!1},contact:{text:"想联系我？\n发邮件: aron@pixel.cat\n记得说是我介绍的哦^^",mood:"shy",buttons:!1}},Or={empathy:{name:"共感",costRange:[800,2e3],emoji:"💗",rule:"听好咯...触碰这个共感娃娃的话~\n它会链接到直播间主播的感触哦^^\n你能感受到Ta此刻的情绪和心跳~\n是不是很神奇呢？试试看吧"},card:{name:"卡牌",costRange:[500,1500],emoji:"🃏",rule:"随机抽一张命运卡牌~\n让Aron我来解读你或者主播今天的运势吧^^\n塔罗、扑克、还是神秘卡牌？\n超级神奇的哦"},wheel:{name:"扭蛋",costRange:[300,800],emoji:"🎰",rule:"考验运气的扭蛋机~\n转一转，看看能扭出什么吧^^\n可能是好东西，也可能是...惊喜？\n人生就像扭蛋，充满未知~ "},rps:{name:"猜拳",costRange:[200,500],emoji:"✊",rule:"和Aron我来一场猜拳对决吧^^\n石头、剪刀、布~\n输了可不能哭哭哦\n赢了我会给客人你特别的奖励~ "}};let _r={stage:"idle",selectedGame:null,currentCost:0,isProcessing:!1,lastCheatTime:0},Fr=null,Xr=null;function qr(n,e="dialogCat"){const t=document.getElementById(e);t&&(t.className="pixel-cat","calm"!==n&&t.classList.add(`cat-mood-${n}`))}function Vr(n="greeting"){console.log("💬 [Cat Game] 显示对话框:",n),Fr&&(clearTimeout(Fr),Fr=null);const e=document.getElementById("pixelCatPeek");e&&setTimeout(()=>e.classList.remove("peeking"),300);const t=document.getElementById("foxDialogContainer");if(!t)return void console.error("❌ [Cat Game] 找不到对话框元素 #foxDialogContainer");const o=document.getElementById("foxDialogText"),a=document.getElementById("foxDialogButtons");if(!o||!a)return void console.error("❌ [Cat Game] 找不到对话框子元素");const i=Ur[n];i?(qr(i.mood,"dialogCat"),qr(i.mood,"peekCat"),t.classList.add("active"),o.innerHTML="",a.style.display="none",Gr(i.text,o,()=>{i.buttons?setTimeout(()=>{a.style.display="flex",console.log("✅ [Cat Game] 打字机动画完成，显示按钮")},300):setTimeout(()=>Jr(),3e3)})):console.error("❌ [Cat Game] 找不到消息配置:",n)}function Gr(n,e,t){let o=0;Xr&&clearInterval(Xr),Xr=setInterval(()=>{if(o<n.length){const t=n.substring(0,o+1).replace(/\n/g,"<br>");e.innerHTML=t+'<span class="typing-cursor"></span>',o++}else clearInterval(Xr),Xr=null,e.innerHTML=n.replace(/\n/g,"<br>"),t&&t()},80)}function Yr(){const n=document.getElementById("foxDialogText"),e=document.getElementById("foxDialogButtons");if(!n||!e)return;_r.stage="asking_game",qr("happy","dialogCat"),qr("happy","peekCat"),n.innerHTML="";Gr("那么...来和我猜拳吧^^\n石头剪刀布，很有趣的哦~",n,()=>{setTimeout(()=>{!function(){const n=document.getElementById("foxDialogButtons");if(!n)return;n.innerHTML='\n    <button class="dialog-btn dialog-btn-game" onclick="handleGameSelect(\'rps\')">\n      ✊ 猜拳\n    </button>\n  ',n.style.display="flex",console.log("✅ [Cat Game] 游戏选项按钮已显示（仅猜拳游戏）")}()},500)})}function Wr(){const n=document.getElementById("foxDialogButtons");n&&(n.innerHTML='\n    <button class="dialog-btn dialog-btn-payment primary" onclick="handlePaymentChoice(\'pay\')">\n      💳 支付\n    </button>\n    <button class="dialog-btn dialog-btn-payment" onclick="handlePaymentChoice(\'cheat\')">\n      😈 耍赖\n    </button>\n    <button class="dialog-btn dialog-btn-payment" onclick="handlePaymentChoice(\'change\')">\n      🔄 换一个\n    </button>\n    <button class="dialog-btn dialog-btn-payment" onclick="handlePaymentChoice(\'quit\')">\n      ❌ 不玩了\n    </button>\n  ',n.style.display="flex",_r.isProcessing=!1,console.log("✅ [Cat Game] 支付选项按钮已显示"))}function Jr(){console.log("🧹 [Cat Game] 清理并关闭"),Fr&&(clearTimeout(Fr),Fr=null),Xr&&(clearInterval(Xr),Xr=null);const n=document.getElementById("pixelCatPeek");n&&n.classList.remove("peeking");const e=document.getElementById("foxDialogContainer");e&&e.classList.remove("active"),qr("happy","peekCat"),qr("happy","dialogCat"),console.log("✅ [Cat Game] 清理完成")}let Kr={currentRound:1,userScore:0,catScore:0,userHistory:[],isProcessing:!1,gameFinished:!1,consecutiveWins:0};function Qr(n){return{rock:"paper",paper:"scissors",scissors:"rock"}[n]}function Zr(n){return{rock:"paper",paper:"scissors",scissors:"rock"}[n]}function ns(n){return{rock:"scissors",scissors:"paper",paper:"rock"}[n]}function es(n,e){if(n===e)return"draw";return{rock:"scissors",scissors:"paper",paper:"rock"}[n]===e?"user":"cat"}function ts(){document.querySelectorAll(".rps-btn").forEach(n=>n.classList.remove("disabled"))}function os(n,e){const t=document.getElementById(n);t&&(t.className=`hand-gesture ${e}`)}function as(n){const e=document.getElementById("rpsCat");e&&(e.className="rps-pixel-cat","calm"!==n&&e.classList.add(`rps-cat-mood-${n}`))}function is(){const n=document.getElementById("catScoreValue"),e=document.getElementById("userScoreValue"),t=document.getElementById("roundNumber");n&&(n.textContent=Kr.catScore),e&&(e.textContent=Kr.userScore),t&&(t.textContent=Kr.currentRound);document.querySelectorAll(".progress-dot").forEach((n,e)=>{e<Kr.currentRound?n.classList.add("active"):n.classList.remove("active")})}function rs(){Kr.gameFinished=!0,Kr.isProcessing=!0;const n=document.getElementById("rpsRestartBtn");n&&(n.style.display="none"),setTimeout(()=>{ls()},2e3)}const ss={victory:["哎呀呀~ 你赢了呢！\n看来我今天状态不太好...\n不过说好的奖励我可不会赖账哦^^","欸，居然输给你了！\n真是个厉害的客人呢~\n这是你应得的奖励，请收好吧","唔...这局算你赢了嘛\n我承认你确实比我略胜一筹~\n奖励马上就到，请稍等"],defeat:["啦啦~ 我赢啦！\n看来运气还是站在我这边呢^^\n按照规则...你得接受一点小小的惩罚哦~","哎呀呀，真是不小心呢\n不过别灰心，下次再来挑战我吧~\n失败的代价还是要有的哦","这一局是我赢了哦\n猜拳可是我的强项呢~\n我需要收取一点点的对我胜利的奖励哦"]};async function ls(){console.log("🎮 [RPS Game] 游戏结束，开始处理后续流程");const e=document.getElementById("rpsGameContainer");e&&(e.classList.remove("active"),setTimeout(()=>{},500));const t=Kr.userScore>=2;console.log("🏆 [RPS Game] 游戏结果: "+(t?"用户获胜":"猫咪获胜")),console.log(`📊 [RPS Game] 最终比分 - 用户: ${Kr.userScore}, 猫咪: ${Kr.catScore}`);const o=t?ss.victory:ss.defeat,a=o[Math.floor(Math.random()*o.length)];let i="";i=t?await cs():await ds();const r=document.getElementById("foxDialogContainer"),s=document.getElementById("foxDialogText"),l=document.getElementById("foxDialogButtons");if(!r||!s||!l)return void console.error("❌ [RPS Game] 找不到对话框元素");const c=t?"sad":"happy";n.setPixelCatMood&&(qr(c,"dialogCat"),qr(c,"peekCat")),r.classList.add("active"),s.innerHTML="",l.style.display="none",Gr(a,s,()=>{setTimeout(()=>{s.innerHTML="",Gr(i,s,()=>{setTimeout(()=>{s.innerHTML="";Gr(t?"快乐的时光总是超级短暂呢~\n下次也来找我，好不好嘛^^":"今天就到这里啦~\n我会等着你的下次光临^^",s,()=>{setTimeout(()=>{r.classList.remove("active"),console.log("✅ [RPS Game] 游戏及互动结束"),Kr={currentRound:1,userScore:0,catScore:0,userHistory:[],isProcessing:!1,gameFinished:!1,consecutiveWins:0}},2500)})},2e3)})},2500)})}async function cs(){if("points"===(Math.random()<.5?"points":"money")){const e=Math.floor(501*Math.random())+500,t=bi(),o=t+e;vi(o),console.log(`🎁 [RPS Game] 积分奖励: +${e}P (${t}P → ${o}P)`);return Rl({title:"X",message:`🎉 猜拳获胜！获得 ${e} 积分`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`奖励已发放！\n你获得了 ${e} 积分~\n当前积分：${o}P\n\n真是厉害呢！^^`}{const e=Math.floor(201*Math.random())+100;try{const t=await wr();if(!t.isActivated){console.warn("⚠️ [RPS Game] 钱包未激活，改为发放积分");const t=10*e,o=bi()+t;vi(o);return Rl({title:"X",message:`🎉 猜拳获胜！获得 ${t} 积分（钱包未激活）`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`奖励已发放！\n钱包未激活，改为发放 ${t} 积分~\n当前积分：${o}P\n\n（激活钱包可获得现金奖励哦）^^`}t.data.balance+=e;const o={id:`rps_reward_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,description:"猜拳游戏获胜奖励",amount:e,timestamp:(new Date).toISOString(),type:"rps_reward",details:{userScore:Kr.userScore,catScore:Kr.catScore}};t.data.transactions||(t.data.transactions=[]),t.data.transactions.unshift(o),await kr(t.data),console.log(`💰 [RPS Game] 金钱奖励: +$${e} (余额: $${t.data.balance.toFixed(2)})`);return Rl({title:"X",message:`🎉 猜拳获胜！获得 $${e}`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`奖励已发放！\n你获得了 $${e}~\n钱包余额：$${t.data.balance.toFixed(2)}\n\n恭喜恭喜！^^`}catch(t){console.error("❌ [RPS Game] 发放金钱奖励失败:",t);const o=10*e,a=bi()+o;vi(a);return Rl({title:"X",message:`🎉 猜拳获胜！获得 ${o} 积分`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`奖励已发放！\n你获得了 ${o} 积分~\n当前积分：${a}P\n\n（钱包系统暂时出错）^^`}}}async function ds(){if("points"===(Math.random()<.5?"points":"money")){const e=Math.floor(501*Math.random())+500,t=bi(),o=Math.min(e,t),a=Math.max(0,t-o);vi(a),console.log(`💸 [RPS Game] 积分惩罚: -${o}P (${t}P → ${a}P)`);return Rl({title:"X",message:`😿 猜拳失败！扣除 ${o} 积分`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),o<e?`惩罚已执行...\n扣除了你所有的 ${o} 积分\n当前积分：${a}P\n\n不过别担心，还可以再赚回来的~`:`惩罚已执行...\n扣除了 ${o} 积分\n当前积分：${a}P\n\n下次加油哦~`}{const e=Math.floor(201*Math.random())+100;try{const t=await wr();if(!t.isActivated){console.warn("⚠️ [RPS Game] 钱包未激活，改为扣除积分");const t=10*e,o=bi(),a=Math.min(t,o),i=Math.max(0,o-a);vi(i);return Rl({title:"X",message:`😿 猜拳失败！扣除 ${a} 积分`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`惩罚已执行...\n扣除了 ${a} 积分\n当前积分：${i}P\n\n（钱包未激活，所以扣的是积分）`}const o=Math.min(e,t.data.balance);t.data.balance=Math.max(0,t.data.balance-o);const a={id:`rps_penalty_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,description:"猜拳游戏失败惩罚",amount:-o,timestamp:(new Date).toISOString(),type:"rps_penalty",details:{userScore:Kr.userScore,catScore:Kr.catScore}};t.data.transactions||(t.data.transactions=[]),t.data.transactions.unshift(a),await kr(t.data),console.log(`💸 [RPS Game] 金钱惩罚: -$${o} (余额: $${t.data.balance.toFixed(2)})`);return Rl({title:"X",message:`😿 猜拳失败！扣除 $${o}`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),o<e?`惩罚已执行...\n扣除了你所有的 $${o}\n钱包余额：$${t.data.balance.toFixed(2)}\n\n余额不足，只能扣这么多了~`:`惩罚已执行...\n扣除了 $${o}\n钱包余额：$${t.data.balance.toFixed(2)}\n\n失败是有代价的嘛~`}catch(t){console.error("❌ [RPS Game] 执行金钱惩罚失败:",t);const o=10*e,a=bi(),i=Math.min(o,a),r=Math.max(0,a-i);vi(r);return Rl({title:"X",message:`😿 猜拳失败！扣除 ${i} 积分`,avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"}),`惩罚已执行...\n扣除了 ${i} 积分\n当前积分：${r}P\n\n（钱包系统暂时出错）`}}}function ps(){console.log("🎮 [RPS Game] 启动猜拳游戏界面");const e=document.getElementById("foxDialogContainer");e&&e.classList.remove("active");const t=document.getElementById("live-room-container");if(!t)return void console.error("❌ [RPS Game] 找不到直播间容器");let o=document.getElementById("rpsGameContainer");o||(o=document.createElement("div"),o.id="rpsGameContainer",o.className="rpg-dialog-container",o.innerHTML='\n      <div class="rps-game-box">\n        \x3c!-- 背景效果 --\x3e\n        <div class="metal-texture"></div>\n        <div class="scanlines"></div>\n\n        \x3c!-- 装饰螺丝 --\x3e\n        <div class="dialog-screw top-left" style="top: 12px; left: 12px;"></div>\n        <div class="dialog-screw top-right" style="top: 12px; right: 12px;"></div>\n        <div class="dialog-screw bottom-left" style="bottom: 12px; left: 12px;"></div>\n        <div class="dialog-screw bottom-right" style="bottom: 12px; right: 12px;"></div>\n\n        <div class="rps-game-floating" id="rpsGame">\n          \x3c!-- 比分栏 - 横向一行 --\x3e\n          <div class="rps-scoreboard">\n            <div class="rps-round-indicator">\n              <div class="round-text">第<span id="roundNumber">1</span>局</div>\n            </div>\n            <span class="score-separator">|</span>\n            <div class="rps-score-item cat-score">\n              <div class="score-label">猫猫</div>\n              <div class="score-value" id="catScoreValue">0</div>\n            </div>\n            <span class="score-separator">:</span>\n            <div class="rps-score-item user-score">\n              <div class="score-value" id="userScoreValue">0</div>\n              <div class="score-label">用户</div>\n            </div>\n          </div>\n\n          \x3c!-- 战斗舞台 - 左右布局 --\x3e\n          <div class="rps-battle-stage">\n            \x3c!-- 猫咪战斗区 --\x3e\n            <div class="rps-cat-arena">\n              <div class="cat-label">猫猫 Aron</div>\n            <div class="rps-pixel-cat" id="rpsCat">\n              <div class="rps-cat-head">\n                \x3c!-- 猫耳朵 --\x3e\n                <div class="rps-cat-ear left">\n                  <div class="rps-cat-ear-inner"></div>\n                </div>\n                <div class="rps-cat-ear right">\n                  <div class="rps-cat-ear-inner"></div>\n                </div>\n                \x3c!-- 胡须 --\x3e\n                <div class="rps-cat-whisker left top"></div>\n                <div class="rps-cat-whisker left middle"></div>\n                <div class="rps-cat-whisker left bottom"></div>\n                <div class="rps-cat-whisker right top"></div>\n                <div class="rps-cat-whisker right middle"></div>\n                <div class="rps-cat-whisker right bottom"></div>\n                \x3c!-- 眼睛 --\x3e\n                <div class="rps-cat-eyes">\n                  <div class="rps-cat-eye"></div>\n                  <div class="rps-cat-eye"></div>\n                </div>\n                \x3c!-- 鼻子 --\x3e\n                <div class="rps-cat-nose"></div>\n                \x3c!-- 嘴巴 --\x3e\n                <div class="rps-cat-mouth"></div>\n                \x3c!-- 脸颊 --\x3e\n                <div class="rps-cat-cheek left"></div>\n                <div class="rps-cat-cheek right"></div>\n              </div>\n            </div>\n\n            \x3c!-- 猫咪手势 --\x3e\n            <div class="cat-hand-container">\n              <div class="cat-hand" id="catHand">\n                <div class="hand-gesture rock" id="catGesture"></div>\n              </div>\n            </div>\n          </div>\n\n            \x3c!-- VS分隔线 - 垂直 --\x3e\n            <div class="rps-vs-divider">\n              <div class="vs-line"></div>\n              <div class="vs-text">VS</div>\n            </div>\n\n            \x3c!-- 用户战斗区 --\x3e\n            <div class="rps-user-arena">\n              <div class="user-label">你</div>\n              \x3c!-- 用户头像 --\x3e\n              <img class="rps-user-avatar" id="rpsUserAvatar" src="" alt="User Avatar">\n              \x3c!-- 用户手势 --\x3e\n              <div class="user-hand-container">\n                <div class="user-hand" id="userHand">\n                  <div class="hand-gesture rock" id="userGesture"></div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n        \x3c!-- 用户选择按钮 --\x3e\n        <div class="rps-choice-buttons" id="rpsChoiceButtons">\n          <button class="rps-btn" onclick="selectChoice(\'rock\')">\n            <div class="btn-icon">✊</div>\n            <div class="btn-label">ROCK</div>\n          </button>\n          <button class="rps-btn" onclick="selectChoice(\'paper\')">\n            <div class="btn-icon">✋</div>\n            <div class="btn-label">PAPER</div>\n          </button>\n          <button class="rps-btn" onclick="selectChoice(\'scissors\')">\n            <div class="btn-icon">✌️</div>\n            <div class="btn-label">SCISSORS</div>\n          </button>\n        </div>\n\n        \x3c!-- 结果文字 --\x3e\n        <div class="rps-result-text" id="rpsResultText"></div>\n\n          \x3c!-- 重新开始按钮（游戏结束后显示） --\x3e\n          <button class="rps-restart-btn" id="rpsRestartBtn" onclick="restartGame()" style="display: none;">\n            ▸ PLAY AGAIN\n          </button>\n        </div>\n      </div>\n    ',t.appendChild(o),console.log("📦 [RPS Game] 猜拳游戏容器已添加到直播间")),Kr={currentRound:1,userScore:0,catScore:0,userHistory:[],isProcessing:!1,gameFinished:!1,consecutiveWins:0},o.style.zIndex="999999",setTimeout(()=>{o.classList.add("active"),is(),as("calm");const e=document.getElementById("rpsUserAvatar");if(e){const t=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";e.src=t,e.onerror=function(){this.className="rps-user-avatar-placeholder",this.removeAttribute("src"),this.alt="👤"}}console.log("✅ [RPS Game] 猜拳游戏界面已显示"),console.log("📊 [RPS Game] 容器状态:",{element:o,hasActiveClass:o.classList.contains("active"),display:n.getComputedStyle(o).display,opacity:n.getComputedStyle(o).opacity,zIndex:n.getComputedStyle(o).zIndex,position:o.getBoundingClientRect()})},100)}n.triggerFoxGame=function(){console.log("🐱 [Cat Game] 触发猫咪游戏"),Ta(),Da();const n=document.getElementById("pixelCatPeek");n?(n.classList.add("peeking"),qr("happy","peekCat"),console.log("🐱 [Cat Game] 猫咪开始探头"),Fr=setTimeout(()=>{Vr("greeting")},5e3)):console.error("❌ [Cat Game] 找不到猫咪元素 #pixelCatPeek")},n.showFoxDialog=Vr,n.handleFoxChoice=function(n){console.log(`🎯 [Cat Game] 用户选择: ${n}`),"yes"===n?(_r.stage="greeting",function(){const n=document.getElementById("foxDialogContainer"),e=document.getElementById("foxDialogText"),t=document.getElementById("foxDialogButtons");if(!n||!e||!t)return void console.error("❌ [Cat Game] 找不到对话框元素");qr("excited","dialogCat"),qr("excited","peekCat"),t.style.display="none",e.innerHTML="";Gr(Ur.yes.text,e,()=>{setTimeout(()=>{Yr()},800)})}()):Vr(n)},n.handleGameSelect=function(n){if(_r.isProcessing)return void console.warn("⚠️ [Cat Game] 正在处理中，请勿重复点击");const e=Or[n];if(!e)return void console.error("❌ [Cat Game] 无效的游戏类型:",n);console.log(`🎮 [Cat Game] 用户选择游戏: ${e.name}`),_r.isProcessing=!0,_r.selectedGame=n,_r.stage="showing_cost";const[t,o]=e.costRange,a=Math.floor(Math.random()*(o-t+1))+t;_r.currentCost=a,console.log(`💰 [Cat Game] ${e.name} 费用: ${a} 积分`),function(n,e){const t=document.getElementById("foxDialogText"),o=document.getElementById("foxDialogButtons");if(!t||!o)return;const a=Or[n];qr("shy","dialogCat"),qr("shy","peekCat"),o.style.display="none",t.innerHTML="";const i=`${a.emoji} ${a.name}游戏需要 ${e} 积分呢^^\n您要支付吗？（真的不贵哦~）`;Gr(i,t,()=>{setTimeout(()=>{Wr()},500)})}(n,a)},n.handlePaymentChoice=function(n){if(_r.isProcessing)console.warn("⚠️ [Cat Game] 正在处理中，请勿重复点击");else switch(console.log(`💳 [Cat Game] 用户选择: ${n}`),_r.isProcessing=!0,n){case"pay":!function(){const n=_r.currentCost,e=bi();if(console.log(`💰 [Cat Game] 检查积分: 需要 ${n}P，当前 ${e}P`),e<n){console.warn("⚠️ [Cat Game] 积分不足");const t=document.getElementById("foxDialogText"),o=document.getElementById("foxDialogButtons");if(t&&o){qr("sad","dialogCat"),qr("sad","peekCat"),o.style.display="none",t.innerHTML="";Gr(`哎呀...您的积分不够呢^^\n需要 ${n} 积分，但您只有 ${e} 积分\n要不要换个便宜点的游戏？`,t,()=>{setTimeout(()=>{Yr(),_r.isProcessing=!1},2e3)})}return}if(!yi(n))return console.error("❌ [Cat Game] 扣除积分失败"),mn("扣除积分失败","error"),void(_r.isProcessing=!1);console.log(`✅ [Cat Game] 成功扣除 ${n} 积分，剩余 ${bi()} 积分`),_r.stage="paid";const t=document.getElementById("foxDialogText"),o=document.getElementById("foxDialogButtons");if(t&&o){qr("excited","dialogCat"),qr("excited","peekCat"),o.style.display="none",t.innerHTML="";const e=Or[_r.selectedGame];Gr(`支付成功！扣除了 ${n} 积分^^\n太好了~ 准备开始游戏吧！`,t,()=>{setTimeout(()=>{t.innerHTML="";Gr(`${e.emoji} ${e.name}游戏的规则是：\n\n${e.rule}`,t,()=>{setTimeout(()=>{_r.isProcessing=!1,console.log(`🎮 [Cat Game] 准备开始 ${e.name} 游戏...`),"rps"===_r.selectedGame&&ps()},2e3)})},1200)})}Rl({title:"积分扣除",message:`已扣除 ${n} 积分`,leftIcon:"x",duration:2500})}();break;case"cheat":!function(){console.log("😈 [Cat Game] 用户想耍赖");const n=document.getElementById("foxDialogText"),e=document.getElementById("foxDialogButtons");if(!n||!e)return;e.style.display="none",n.innerHTML="";const t=Date.now(),o=18e4,a=t-_r.lastCheatTime;if(_r.lastCheatTime>0&&a<o){console.warn(`⚠️ [Cat Game] 检测到投机行为：距上次耍赖仅 ${Math.floor(a/1e3)} 秒`),qr("angry","dialogCat"),qr("angry","peekCat");return void Gr(`哎呀呀~ 想投机取巧吗？^^\n我可都看到了哦\n\n检测到您在3分钟内反复尝试耍赖~\n这种行为是不被允许的哦\n\n请等待 ${Math.ceil((o-a)/1e3)} 秒后再试吧~ `,n,()=>{setTimeout(()=>{Wr()},3e3)})}_r.lastCheatTime=t;const i=Math.random(),r=i<.2;if(console.log(`🎲 [Cat Game] 耍赖判定: ${(100*i).toFixed(1)}% ${r?"✅ 成功":"❌ 失败"}`),r){qr("surprised","dialogCat"),qr("surprised","peekCat");const e=Or[_r.selectedGame],t="哎呀...居然被你蒙混过关了！\n真是一名聪明的客人呢~ ^^\n\n好吧好吧，这次就免费让你玩嘛\n下次我可不会这么容易就分心哦";_r.stage="paid",Gr(t,n,()=>{setTimeout(()=>{n.innerHTML="";Gr(`${e.emoji} ${e.name}游戏的规则是：\n\n${e.rule}`,n,()=>{setTimeout(()=>{_r.isProcessing=!1,console.log(`🎮 [Cat Game] 准备开始 ${e.name} 游戏...（耍赖成功免费版）`),"rps"===_r.selectedGame&&ps()},2e3)})},1200)}),Rl({title:"耍赖成功",message:`免费获得 ${e.name} 游戏机会！`,leftIcon:"x",duration:2500})}else{const e=_r.currentCost,t=Math.floor(1.2*e),o=bi();if(console.log(`💰 [Cat Game] 耍赖失败惩罚: 需要扣除 ${t}P (${e}P × 120%)，当前 ${o}P`),qr("angry","dialogCat"),qr("angry","peekCat"),o<t){console.warn("⚠️ [Cat Game] 积分不足以支付耍赖惩罚");return void Gr(`不可以做耍赖的坏客人哦~\n我会很伤心的ㅠㅠ\n\n按照规则，耍赖失败要扣除 ${t} 积分（原价的120%）\n但你只有 ${o} 积分...`,n,()=>{setTimeout(()=>{n.innerHTML="";Gr("算了算了，给我们的客人一次机会吧~\n这次就不扣费了\n\n换个游戏试试呢，下次可不能耍赖咯 > <",n,()=>{setTimeout(()=>{_r.selectedGame=null,_r.currentCost=0,Yr()},2e3)})},1200)})}if(!yi(t))return console.error("❌ [Cat Game] 扣除惩罚积分失败"),mn("扣除积分失败","error"),void(_r.isProcessing=!1);console.log(`✅ [Cat Game] 耍赖失败，扣除 ${t} 积分，剩余 ${bi()} 积分`);const a=Or[_r.selectedGame],i=`NONO~被我抓到了吧~\n耍赖的话，我会很苦恼的^^\n\n按照规则，耍赖失败要扣除原价的120%\n也就是 ${t} 积分！已经扣除咯~\n\n不过既然钱都收了...\n那就让你玩吧~ `;_r.stage="paid",Gr(i,n,()=>{setTimeout(()=>{n.innerHTML="";Gr(`${a.emoji} ${a.name}游戏的规则是：\n\n${a.rule}`,n,()=>{setTimeout(()=>{_r.isProcessing=!1,console.log(`🎮 [Cat Game] 准备开始 ${a.name} 游戏...（耍赖失败惩罚版）`),"rps"===_r.selectedGame&&ps()},2e3)})},1200)}),Rl({title:"耍赖失败",message:`扣除惩罚积分 ${t}P (120%)`,leftIcon:"x",duration:2500})}}();break;case"change":!function(){console.log("🔄 [Cat Game] 用户想换一个游戏");const n=document.getElementById("foxDialogText"),e=document.getElementById("foxDialogButtons");if(n&&e){qr("happy","dialogCat"),qr("happy","peekCat"),e.style.display="none",n.innerHTML="";Gr("好的好的~ 那重新选一个吧^^",n,()=>{setTimeout(()=>{_r.selectedGame=null,_r.currentCost=0,Yr()},1e3)})}}();break;case"quit":!function(){console.log("❌ [Cat Game] 用户不想玩了");const n=document.getElementById("foxDialogText"),e=document.getElementById("foxDialogButtons");if(n&&e){qr("sad","dialogCat"),qr("sad","peekCat"),e.style.display="none",n.innerHTML="";Gr("哦...好吧那改天再玩吧~\n我会一直在这里等你的^^",n,()=>{setTimeout(()=>{Jr()},2500)})}}();break;default:console.error("❌ [Cat Game] 无效的支付选择:",n),_r.isProcessing=!1}},n.closeFoxGame=Jr,n.selectChoice=function(n){if(Kr.isProcessing||Kr.gameFinished)return;console.log(`🎮 用户选择: ${n}`),Kr.isProcessing=!0,Kr.userHistory.push(n),document.querySelectorAll(".rps-btn").forEach(n=>n.classList.add("disabled"));const e=function(){const n=Kr.userHistory;if(Kr.catScore>=2&&0===Kr.userScore&&Math.random()<.2){console.log("🧠 AI策略：心理战 - 故意放水一局降低警惕");return{rock:"scissors",paper:"rock",scissors:"paper"}[n[n.length-1]]}if(0===n.length)return["rock","paper","scissors"][Math.floor(3*Math.random())];const e=n[n.length-1];if(1===n.length)return Math.random()<.7?(console.log(`🧠 AI策略：基础克制 - 针对上次的 ${e}`),Qr(e)):["rock","paper","scissors"][Math.floor(3*Math.random())];const t=n[n.length-2];if(t===e)return console.log(`🧠 AI策略：连续相同模式 - 用户连续两次 ${e}，预判继续`),Qr(e);const o=Zr(e);if(n.length>=3&&Zr(t)===e)return console.log(`🧠 AI策略：循环模式 - 预判下一个是 ${o}`),Qr(o);const a=ns(e);if(n.length>=3&&ns(t)===e)return console.log(`🧠 AI策略：反循环模式 - 预判下一个是 ${a}`),Qr(a);if(t!==e&&n.length>=3&&n[n.length-3]===e)return console.log(`🧠 AI策略：交替模式 - 预判回到 ${t}`),Qr(t);if(n.length>=4){const e={rock:0,paper:0,scissors:0};n.forEach(n=>e[n]++);const t=Object.keys(e).reduce((n,t)=>e[n]>e[t]?n:t);if(e[t]/n.length>.4)return console.log(`🧠 AI策略：偏好检测 - 用户偏好 ${t} (${(e[t]/n.length*100).toFixed(0)}%)`),Qr(t)}if(n.length>=2){const t="cat"===es(n[n.length-1],e)?Qr(n[n.length-1]):null;if(t&&Math.random()<.35){const n=Qr(t);return console.log(`🧠 AI策略：反预判 - 用户可能会出 ${n}，我出 ${Qr(n)}`),Qr(n)}}return console.log(`🧠 AI策略：保守克制 - 针对 ${e}`),Qr(e)}();console.log(`🐱 猫咪选择: ${e}`),function(n,e){const t=document.getElementById("catHand"),o=document.getElementById("userHand"),a=document.getElementById("rpsCat");as("sneaky"),setTimeout(()=>{a.classList.add("charging"),as("focused"),setTimeout(()=>{a.classList.remove("charging"),t.classList.add("swinging"),o.classList.add("swinging"),setTimeout(()=>{a.classList.add("attacking"),setTimeout(()=>{a.classList.remove("attacking"),t.classList.remove("swinging"),o.classList.remove("swinging"),t.classList.add("revealing"),o.classList.add("revealing"),os("catGesture",e),os("userGesture",n),setTimeout(()=>{t.classList.remove("revealing"),o.classList.remove("revealing");!function(n,e,t){const o=document.getElementById("rpsCat"),a=document.getElementById("rpsResultText"),i=document.getElementById("catScoreValue"),r=document.getElementById("userScoreValue");let s="",l="happy";"user"===n?(Kr.userScore++,Kr.consecutiveWins=0,s="YOU WIN THIS ROUND!",l="sad",o.classList.add("defeated"),r&&(r.classList.add("bounce"),setTimeout(()=>r.classList.remove("bounce"),500)),console.log(`✅ 用户获胜！${e} beats ${t}`)):"cat"===n?(Kr.catScore++,Kr.consecutiveWins++,s="ARON WINS THIS ROUND!",l="happy",o.classList.add("celebrating"),i&&(i.classList.add("bounce"),setTimeout(()=>i.classList.remove("bounce"),500)),console.log(`❌ 猫咪获胜！${t} beats ${e}`)):(s="DRAW!",l="surprised",console.log(`➖ 平局！Both chose ${e}`));as(l),a&&(a.textContent=s,a.style.animation="none",setTimeout(()=>{a.style.animation="resultFadeIn 0.5s ease-out"},10));is(),setTimeout(()=>{o.classList.remove("celebrating","defeated"),function(){const n=document.getElementById("rpsResultText");Kr.userScore>=2?(n&&(n.textContent="🎉 YOU WIN THE GAME! 🎉"),as("sad"),rs()):Kr.catScore>=2?(n&&(n.textContent="😼 ARON WINS THE GAME! 😼"),as("happy"),rs()):(Kr.currentRound++,n&&(n.textContent=""),setTimeout(()=>{os("catGesture","rock"),os("userGesture","rock"),as("calm"),Kr.isProcessing=!1,ts(),is()},600))}()},1800)}(es(n,e),n,e)},600)},400)},1200)},400)},200)}(n,e)},n.restartGame=function(){Kr={currentRound:1,userScore:0,catScore:0,userHistory:[],isProcessing:!1,gameFinished:!1,consecutiveWins:0},is(),os("catGesture","rock"),os("userGesture","rock"),as("calm");const n=document.getElementById("rpsResultText"),e=document.getElementById("rpsRestartBtn");n&&(n.textContent=""),e&&(e.style.display="none"),ts(),console.log("🔄 游戏重新开始")},n.startRpsGame=ps,n.closeRpsGame=function(){const n=document.getElementById("rpsGameContainer");n&&(n.classList.remove("active"),console.log("🎮 [RPS Game] 猜拳游戏界面已关闭"))},n.handleRpsGameEnd=ls,n.applyRpsReward=cs,n.applyRpsPenalty=ds;const gs='<svg viewBox="0 0 24 24"><g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g></svg>',ms='<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',xs='<svg viewBox="0 0 24 24"><g><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></g></svg>',us='<svg viewBox="0 0 24 24"><g><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path></g></svg>',hs='<svg viewBox="0 0 24 24"><g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></g></svg>',fs='<svg viewBox="0 0 24 24"><g><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></g></svg>',bs='<svg viewBox="0 0 24 24"><g><path d="M19 13H5v-2h14v2z"></path></g></svg>',vs='<svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;"><g><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"></path></g></svg>',ys='<svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',ws='<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',ks='<svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"></circle><circle cx="12" cy="12" r="2"></circle><circle cx="12" cy="19" r="2"></circle></svg>',$s='<svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',Cs='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 6h3a1 1 0 0 1 1 1v11a2 2 0 0 1 -4 0v-13a1 1 0 0 0 -1 -1h-10a1 1 0 0 0 -1 1v12a3 3 0 0 0 3 3h11"/><path d="M8 8l4 0"/><path d="M8 12l4 0"/><path d="M8 16l4 0"/></svg>';const Is={darkColors:{background:"#1a1a1a",water:"#1a2a3a",waterLight:"#243444",land:"#252525",park:"#1e3025",parkLight:"#253530",building:"#2a2a2a",buildingLight:"#303030",buildingDark:"#222222",roadMain:"#3a3a3a",roadSecondary:"#333333",roadLine:"rgba(255,255,255,0.08)",roadCenter:"rgba(255,200,50,0.15)"},lightColors:{background:"#f5f5f5",water:"#a8d8ea",waterLight:"#c1e7f4",land:"#e8e8e8",park:"#b8e6b8",parkLight:"#d0f0d0",building:"#fff",buildingLight:"#fafafa",buildingDark:"#f0f0f0",roadMain:"#d0d0d0",roadSecondary:"#e0e0e0",roadLine:"rgba(0,0,0,0.08)",roadCenter:"rgba(255,200,50,0.3)"},colors:null,landmarkTypes:[{type:"restaurant",color:"#ff6b6b",names:["海底捞火锅","必胜客","肯德基","星巴克咖啡","麦当劳","外婆家","绿茶餐厅","西贝莜面村"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/></svg>'},{type:"cafe",color:"#8b6f47",names:["星巴克","Costa咖啡","瑞幸咖啡","Manner咖啡","太平洋咖啡","猫的天空之城"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 21h18v-2H2v2zm15.5-6c1.38 0 2.5-1.12 2.5-2.5V4H3v8.5c0 1.38 1.12 2.5 2.5 2.5h12zM5 6h12v6.5c0 .28-.22.5-.5.5h-11c-.28 0-.5-.22-.5-.5V6zm15-.5c.28 0 .5.22.5.5v3c0 .28-.22.5-.5.5s-.5-.22-.5-.5V6c0-.28.22-.5.5-.5z"/></svg>'},{type:"park",color:"#51cf66",names:["中央公园","人民公园","森林公园","滨江公园","城市绿地","儿童乐园"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 8C17 5.24 14.76 3 12 3S7 5.24 7 8c0 2.85 2.92 7.21 5 9.88 2.11-2.69 5-7 5-9.88zM12 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm-7 9c0-3.87 3.13-7 7-7s7 3.13 7 7H5z"/></svg>'},{type:"mall",color:"#cc5de8",names:["万达广场","银泰百货","大悦城","龙湖天街","万象城","来福士广场"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>'},{type:"hospital",color:"#ff6b6b",names:["人民医院","中医院","第一医院","儿童医院","口腔医院","社区诊所"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>'},{type:"school",color:"#339af0",names:["实验小学","第一中学","外国语学校","职业学院","大学城","幼儿园"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>'},{type:"metro",color:"#748ffc",names:["地铁站","火车站","公交总站","客运中心"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zm0 2c3.51 0 4.96.48 5.57 1H6.43c.61-.52 2.06-1 5.57-1zM6 7h5v3H6V7zm12 8.5c0 .83-.67 1.5-1.5 1.5h-9c-.83 0-1.5-.67-1.5-1.5V12h12v3.5zm0-5.5h-5V7h5v3zM7.5 16c.83 0 1.5.67 1.5 1.5S8.33 19 7.5 19 6 18.33 6 17.5 6.67 16 7.5 16zm9 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5z"/></svg>'},{type:"scenic",color:"#ffd43b",names:["博物馆","图书馆","剧院","体育馆","美术馆","科技馆","音乐厅"],icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'}],landmarks:[],seed:12345,config:{waterRatio:.15,buildingDensity:.6,parkCount:4,roadWidth:18},random(){return this.seed=(9301*this.seed+49297)%233280,this.seed/233280},randomRange(n,e){return n+this.random()*(e-n)},randomInt(n,e){return Math.floor(this.randomRange(n,e+1))},setTheme(n){this.colors=n?this.lightColors:this.darkColors,console.log(`🎨 [地图主题] 已切换到${n?"亮色":"暗色"}主题`)},redraw(){this.ctx&&this.width&&this.height?(this.ctx.clearRect(0,0,this.width,this.height),this.seed=12345,this.drawBackground(),this.drawWaterAreas(),this.drawParks(),this.drawBlocks(),this.drawMainRoads(),this.drawSecondaryRoads(),this.drawBuildings(),this.drawRoadDetails(),this.drawLandmarks(),console.log("✅ [地图重绘] 地图已重新绘制")):console.warn("⚠️ [地图重绘] 地图未初始化，跳过重绘")},init(n){console.log("🗺️ [MapGenerator.init] 开始初始化地图, canvasId:",n),console.log("🗺️ [MapGenerator.init] 当前landmarks数量:",this.landmarks?.length||0);const e=document.getElementById(n);if(!e)return void console.error("❌ [MapGenerator.init] 找不到canvas元素:",n);const t=document.getElementById("mapCanvas"),o=t.offsetWidth,a=t.offsetHeight;e.width=o,e.height=a;const i=e.getContext("2d");this.ctx=i,this.width=o,this.height=a,this.seed=12345;const r=document.getElementById("x-map-container"),s=r?.classList.contains("light-theme")||!1;this.setTheme(s),this.drawBackground(),this.drawWaterAreas(),this.drawParks(),this.drawBlocks(),this.drawMainRoads(),this.drawSecondaryRoads(),this.drawBuildings(),this.drawRoadDetails(),this.generateLandmarks(),this.drawLandmarks(),console.log("✅ [MapGenerator.init] 地图初始化完成")},generateLandmarks(){if(this.landmarks&&this.landmarks.length>0)return void console.log("📍 [地图生成] 使用AI生成的地标数据，共",this.landmarks.length,"个");this.landmarks=[];const{width:n,height:e}=this,t=this.randomInt(30,50);for(let o=0;o<t;o++){const t=this.randomInt(0,this.landmarkTypes.length-1),a=this.landmarkTypes[t],i=this.randomInt(0,a.names.length-1),r=a.names[i],s=this.randomRange(50,n-50),l=this.randomRange(50,e-50);this.landmarks.push({id:`landmark-${o}`,x:s,y:l,name:r,type:a.type,icon:a.icon,color:a.color})}console.log("📍 [地图生成] 使用默认随机地标数据，共",this.landmarks.length,"个")},drawLandmarks(){const{ctx:n,landmarks:e,colors:t}=this,o=e.filter(n=>n.event);o.length>0&&console.log(`🗺️ [地图绘制] 总共${e.length}个地标，其中${o.length}个有事件:`,o.map(n=>n.name));const a=t===this.lightColors?"#000":"#fff",i=t===this.lightColors?"rgba(0,0,0,0.3)":"rgba(255,255,255,0.5)";e.forEach(e=>{n.beginPath(),n.arc(e.x,e.y,8,0,2*Math.PI),n.fillStyle=e.color+"20",n.fill(),n.beginPath(),n.arc(e.x,e.y,5,0,2*Math.PI),n.fillStyle=e.color,n.fill(),n.strokeStyle=e.event?"#ff3b30":a,n.lineWidth=e.event?3:2,n.stroke(),n.beginPath(),n.arc(e.x-1,e.y-1,2,0,2*Math.PI),n.fillStyle=i,n.fill(),e.event&&(n.beginPath(),n.arc(e.x+4,e.y-4,3,0,2*Math.PI),n.fillStyle="#ff3b30",n.fill(),n.strokeStyle=t===this.lightColors?"#fff":"#1a1a1a",n.lineWidth=1.5,n.stroke())})},drawBackground(){const{ctx:n,width:e,height:t,colors:o}=this;n.fillStyle=o.background,n.fillRect(0,0,e,t)},drawWaterAreas(){const{ctx:n,width:e,height:t,colors:o}=this;n.beginPath(),n.moveTo(0,.3*t);const a=this.randomRange(80,150);let i=.3*t;for(let o=0;o<e;o+=100)i+=this.randomRange(-50,50),i=Math.max(.1*t,Math.min(.5*t,i)),n.lineTo(o,i);n.lineTo(e,i),n.lineTo(e,i+a),i+=a;for(let t=e;t>=0;t-=100)i+=this.randomRange(-30,30),n.lineTo(t,i);n.closePath();const r=n.createLinearGradient(0,0,e,0);r.addColorStop(0,o.water),r.addColorStop(.5,o.waterLight),r.addColorStop(1,o.water),n.fillStyle=r,n.fill(),n.beginPath();const s=.7*e,l=.75*t,c=this.randomRange(100,180),d=this.randomRange(60,100);n.ellipse(s,l,c,d,.2,0,2*Math.PI),n.fillStyle=o.water,n.fill()},drawParks(){const{ctx:n,width:e,height:t,colors:o}=this,a=this.randomInt(4,8);for(let i=0;i<a;i++){const a=this.randomRange(50,e-50),r=this.randomRange(50,t-50),s=this.randomRange(80,200),l=this.randomRange(60,150);n.beginPath(),n.moveTo(a,r);const c=this.randomInt(5,8);for(let e=0;e<c;e++){const t=e/c*Math.PI*2,o=(e%2==0?s:l)*this.randomRange(.3,.6),i=a+Math.cos(t)*o,d=r+Math.sin(t)*o;n.lineTo(i,d)}n.closePath(),n.fillStyle=i%2==0?o.park:o.parkLight,n.fill()}},drawBlocks(){const{ctx:n,width:e,height:t,colors:o}=this,a=200,i=Math.ceil(e/a),r=Math.ceil(t/a);for(let e=0;e<r;e++)for(let t=0;t<i;t++){const i=t*a+this.randomRange(5,15),r=e*a+this.randomRange(5,15),s=a-this.randomRange(20,40),l=a-this.randomRange(20,40),c=this.random();n.fillStyle=c<.6?o.land:c<.8?o.building:o.buildingLight,this.roundRect(i,r,s,l,5),n.fill()}},drawMainRoads(){const{ctx:n,width:e,height:t,colors:o}=this;n.strokeStyle=o.roadMain,n.lineWidth=24,n.lineCap="round",n.lineJoin="round";const a=this.randomInt(3,5);for(let o=0;o<a;o++){const i=t/(a+1)*(o+1)+this.randomRange(-30,30);n.beginPath(),n.moveTo(0,i);for(let t=0;t<=e;t+=e/4){const e=this.randomRange(-20,20);n.lineTo(t,i+e)}n.stroke()}const i=this.randomInt(3,5);for(let o=0;o<i;o++){const a=e/(i+1)*(o+1)+this.randomRange(-30,30);n.beginPath(),n.moveTo(a,0);for(let e=0;e<=t;e+=t/4){const t=this.randomRange(-20,20);n.lineTo(a+t,e)}n.stroke()}},drawSecondaryRoads(){const{ctx:n,width:e,height:t,colors:o}=this;n.strokeStyle=o.roadSecondary,n.lineWidth=12;const a=this.randomInt(15,25);for(let o=0;o<a;o++){const o=this.random()>.5;if(n.beginPath(),o){const o=this.randomRange(50,t-50),a=this.randomRange(0,.3*e),i=this.randomRange(.7*e,e);n.moveTo(a,o),n.lineTo(i,o+this.randomRange(-30,30))}else{const o=this.randomRange(50,e-50),a=this.randomRange(0,.3*t),i=this.randomRange(.7*t,t);n.moveTo(o,a),n.lineTo(o+this.randomRange(-30,30),i)}n.stroke()}},drawBuildings(){const{ctx:n,width:e,height:t,colors:o}=this,a=this.randomInt(200,350);for(let i=0;i<a;i++){const a=this.randomRange(0,e),i=this.randomRange(0,t),r=this.randomRange(15,50),s=this.randomRange(15,50),l=this.random();n.fillStyle=l<.4?o.building:l<.7?o.buildingLight:o.buildingDark,n.fillRect(a,i,r,s),n.strokeStyle="rgba(0,0,0,0.3)",n.lineWidth=1,n.strokeRect(a,i,r,s)}},drawRoadDetails(){const{ctx:n,width:e,height:t,colors:o}=this;n.setLineDash([15,10]),n.strokeStyle=o.roadLine,n.lineWidth=1;for(let o=100;o<t;o+=150+this.randomRange(-20,20))n.beginPath(),n.moveTo(0,o),n.lineTo(e,o),n.stroke();for(let o=100;o<e;o+=150+this.randomRange(-20,20))n.beginPath(),n.moveTo(o,0),n.lineTo(o,t),n.stroke();n.setLineDash([]),n.setLineDash([20,15]),n.strokeStyle=o.roadCenter,n.lineWidth=2;for(let o=200;o<t;o+=300)n.beginPath(),n.moveTo(0,o),n.lineTo(e,o),n.stroke();for(let o=200;o<e;o+=300)n.beginPath(),n.moveTo(o,0),n.lineTo(o,t),n.stroke();n.setLineDash([])},roundRect(n,e,t,o,a){const{ctx:i}=this;i.beginPath(),i.moveTo(n+a,e),i.lineTo(n+t-a,e),i.quadraticCurveTo(n+t,e,n+t,e+a),i.lineTo(n+t,e+o-a),i.quadraticCurveTo(n+t,e+o,n+t-a,e+o),i.lineTo(n+a,e+o),i.quadraticCurveTo(n,e+o,n,e+o-a),i.lineTo(n,e+a),i.quadraticCurveTo(n,e,n+a,e),i.closePath()}},Ss={avatarLibrary:{unisex:["https://i.postimg.cc/nzYhv1dF/25f610139f457dbb334fa669033e710d.jpg","https://i.postimg.cc/rFpwrxxB/8a0c2ef08661efe92a45bdac2522e0e5.jpg","https://i.postimg.cc/Sx2QZ4ZB/d3e487bf5b4dcb930aa4710bddace460.jpg","https://i.postimg.cc/kGgqWP6S/47625239f04329daf2f0a5cb857fab17.jpg","https://i.postimg.cc/WbKTqK2b/3597240784be5b8a5e20c48444522ac0.jpg","https://i.postimg.cc/TwR6Xv9G/𝐴𝑣𝑎𝑡𝑎𝑟.jpg","https://i.postimg.cc/yYJzKPFR/0906e30095fe9c7d755f9878c6e9b231.jpg"],female:["https://i.postimg.cc/CK0yjp9Z/2a8ebd43a59bbb20d1d8b8e058b2d8f8.jpg","https://i.postimg.cc/vTkkTJWV/68f698a3ec805053ecc57d4ccb24bb88.jpg","https://i.postimg.cc/ZYM1wd1n/dca1d391113e16471670428ff246a797.jpg"],male:["https://i.postimg.cc/K8nwcs4Z/2b5d7cc132d92c7539f72a271d3bb2bb.jpg","https://i.postimg.cc/wBgP1cs2/2f3ad4ca3491f004f0985f7f94987e63.jpg","https://i.postimg.cc/wx16xgzd/8a371ffd7747316ca6a20a73e9213d83.jpg","https://i.postimg.cc/vZsMvnVy/16602df49663ddff9f7affe386ca828d.jpg","https://e3f49eaa46b57.cdn.sohucs.com/2025/11/23/19/53/MTAwMTE0XzE3NjM4OTg4MDMxNjA=.jpg"]},customAvatars:{unisex:[],male:[],female:[]},getRandomAvatar(n="unisex"){const e=[..."male"===n?[...this.avatarLibrary.male,...this.avatarLibrary.unisex]:"female"===n?[...this.avatarLibrary.female,...this.avatarLibrary.unisex]:this.avatarLibrary.unisex,..."male"===n?[...this.customAvatars.male,...this.customAvatars.unisex]:"female"===n?[...this.customAvatars.female,...this.customAvatars.unisex]:this.customAvatars.unisex];return e[Math.floor(Math.random()*e.length)]},chatMessages:{},chatAffectionData:{},chatNotes:{},userMarkedNotes:{},npcNotesAboutUser:{},chatContext:{},detailCardOpenSource:"map",currentChatUser:null,userMessageQueue:[],authenticityScore:100,currentReportNotification:null,userReportedCount:0,mapBanStartTime:null,mapBanDuration:432e5,initAuthenticityScore(){const n=localStorage.getItem("xUserAuthenticityScore");null!==n?(this.authenticityScore=parseFloat(n),console.log(`🎯 [真实度系统] 加载真实度: ${this.authenticityScore}`)):(this.authenticityScore=100,localStorage.setItem("xUserAuthenticityScore","100"),console.log("🎯 [真实度系统] 初始化真实度: 100"))},getAuthenticityScore(){return this.authenticityScore},addAuthenticityScore(n,e=""){const t=this.authenticityScore;return this.authenticityScore=Math.min(200,this.authenticityScore+n),localStorage.setItem("xUserAuthenticityScore",this.authenticityScore.toString()),console.log(`✅ [真实度系统] ${e||"增加真实度"}: ${t.toFixed(1)} → ${this.authenticityScore.toFixed(1)} (+${n})`),this.authenticityScore},subtractAuthenticityScore(n,e=""){const t=this.authenticityScore;return this.authenticityScore=Math.max(0,this.authenticityScore-n),localStorage.setItem("xUserAuthenticityScore",this.authenticityScore.toString()),console.log(`⚠️ [真实度系统] ${e||"扣除真实度"}: ${t.toFixed(1)} → ${this.authenticityScore.toFixed(1)} (-${n})`),this.authenticityScore},initReportedCountSystem(){const n=localStorage.getItem("xUserReportedCount");null!==n?(this.userReportedCount=parseInt(n),console.log(`🚨 [被举报计数] 加载被举报次数: ${this.userReportedCount}`)):(this.userReportedCount=0,localStorage.setItem("xUserReportedCount","0"),console.log("🚨 [被举报计数] 初始化被举报次数: 0"));const e=localStorage.getItem("xMapBanStartTime");e?(this.mapBanStartTime=parseInt(e),console.log(`🚫 [封禁系统] 加载封禁时间: ${new Date(this.mapBanStartTime).toLocaleString()}`)):this.mapBanStartTime=null},incrementReportedCount(){return this.userReportedCount++,localStorage.setItem("xUserReportedCount",this.userReportedCount.toString()),console.log(`🚨 [被举报计数] 被举报次数增加: ${this.userReportedCount}`),this.userReportedCount>=5&&this.banMapAccess(),this.userReportedCount},banMapAccess(){this.mapBanStartTime=Date.now(),localStorage.setItem("xMapBanStartTime",this.mapBanStartTime.toString()),console.log(`🚫 [封禁系统] 地图功能已被封禁12小时，开始时间: ${new Date(this.mapBanStartTime).toLocaleString()}`),this.userReportedCount=0,localStorage.setItem("xUserReportedCount","0")},checkMapBanStatus(){if(!this.mapBanStartTime)return{isBanned:!1};const n=Date.now()-this.mapBanStartTime;if(n>=this.mapBanDuration)return this.mapBanStartTime=null,localStorage.removeItem("xMapBanStartTime"),console.log("✅ [封禁系统] 封禁时间已过，已自动解除"),{isBanned:!1};{const e=this.mapBanDuration-n,t=Math.floor(e/36e5),o=Math.floor(e%36e5/6e4);return console.log(`🚫 [封禁系统] 仍在封禁中，剩余时间: ${t}小时${o}分钟`),{isBanned:!0,remainingTime:e,remainingHours:t,remainingMinutes:o}}},showMapBanNotice(n){const e=document.getElementById("x-map-container");if(!e)return;e.innerHTML="";const t=document.createElement("div");t.style.cssText="\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: #000;\n        padding: 24px;\n      ",t.innerHTML=`\n        <div style="\n          max-width: 400px;\n          background: #1a1a1a;\n          border-radius: 24px;\n          padding: 40px 32px;\n          text-align: center;\n          border: 1px solid #2a2a2a;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);\n        ">\n          \x3c!-- 警告图标 --\x3e\n          <div style="\n            width: 80px;\n            height: 80px;\n            margin: 0 auto 28px;\n            background: #2a2a2a;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border: 2px solid #3a3a3a;\n          ">\n            <svg viewBox="0 0 24 24" style="width: 36px; height: 36px; fill: #9ca3af;">\n              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>\n            </svg>\n          </div>\n\n          \x3c!-- 标题 --\x3e\n          <h2 style="\n            color: #fff;\n            font-size: 24px;\n            font-weight: 700;\n            margin-bottom: 12px;\n            letter-spacing: -0.5px;\n          ">Account Suspended</h2>\n\n          \x3c!-- 副标题 --\x3e\n          <div style="\n            color: #6b7280;\n            font-size: 14px;\n            font-weight: 600;\n            margin-bottom: 20px;\n            text-transform: uppercase;\n            letter-spacing: 1.2px;\n          ">Temporary Restriction</div>\n\n          \x3c!-- 描述 --\x3e\n          <p style="\n            color: #9ca3af;\n            font-size: 15px;\n            line-height: 1.6;\n            margin-bottom: 28px;\n          ">Your access to Map Dating has been temporarily suspended due to multiple community guideline violations.</p>\n\n          \x3c!-- 违规次数指示器 --\x3e\n          <div style="\n            display: flex;\n            justify-content: center;\n            gap: 8px;\n            margin-bottom: 24px;\n          ">\n            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 2px solid #fff;"></div>\n            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 2px solid #fff;"></div>\n            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 2px solid #fff;"></div>\n            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 2px solid #fff;"></div>\n            <div style="width: 12px; height: 12px; border-radius: 50%; background: #fff; border: 2px solid #fff;"></div>\n          </div>\n\n          \x3c!-- 分隔线 --\x3e\n          <div style="\n            height: 1px;\n            background: #2a2a2a;\n            margin: 24px 0;\n          "></div>\n\n          \x3c!-- 剩余时间卡片 --\x3e\n          <div style="\n            background: #0a0a0a;\n            border-radius: 16px;\n            padding: 20px;\n            margin-bottom: 28px;\n            border: 1px solid #2a2a2a;\n          ">\n            <div style="\n              color: #6b7280;\n              font-size: 12px;\n              margin-bottom: 10px;\n              text-transform: uppercase;\n              letter-spacing: 1.5px;\n              font-weight: 600;\n            ">Time Remaining</div>\n            <div style="\n              color: #fff;\n              font-size: 32px;\n              font-weight: 700;\n              font-family: 'Courier New', monospace;\n              letter-spacing: 2px;\n            ">${n.remainingHours}h ${n.remainingMinutes}m</div>\n          </div>\n\n          \x3c!-- 提示文本 --\x3e\n          <p style="\n            color: #6b7280;\n            font-size: 13px;\n            line-height: 1.6;\n            margin-bottom: 28px;\n            padding: 0 8px;\n          ">Access will be automatically restored after the suspension period. Please review our community guidelines to avoid future violations.</p>\n\n          \x3c!-- 关闭按钮 --\x3e\n          <button onclick="document.getElementById('x-map-container').style.display='none'" style="\n            width: 100%;\n            background: #fff;\n            color: #000;\n            border: none;\n            border-radius: 16px;\n            padding: 16px 24px;\n            font-size: 16px;\n            font-weight: 700;\n            cursor: pointer;\n            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n            letter-spacing: -0.2px;\n          " onmouseover="this.style.background='#e5e5e5'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='#fff'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">\n            Close\n          </button>\n        </div>\n      `,e.appendChild(t),console.log("🚫 [封禁系统] 已显示封禁提示UI")},noteCategories:[{id:"work",name:"工作",iconType:"briefcase"},{id:"hobby",name:"兴趣",iconType:"heart"},{id:"family",name:"家庭",iconType:"users"},{id:"personality",name:"性格",iconType:"user"},{id:"appearance",name:"外貌",iconType:"eye"},{id:"food",name:"饮食",iconType:"coffee"},{id:"location",name:"地点",iconType:"map-pin"},{id:"dream",name:"梦想",iconType:"star"},{id:"habit",name:"习惯",iconType:"repeat"},{id:"friend",name:"朋友",iconType:"user-plus"},{id:"other",name:"其他",iconType:"file-text"}],parseWeatherFromText(n){if(!n)return"sunny";const e=n.toLowerCase(),t=["thunder","heavy-rain","snow","dust","fog","rain","cloudy","sunny"];for(const n of t){const t=this.weatherKeywords[n];if(t&&t.some(n=>e.includes(n)))return n}return"sunny"},getRandomWeather(){const n=Object.keys(this.weatherTypes);return n[Math.floor(Math.random()*n.length)]},renderWeatherEffect(n){const e=document.getElementById("mapWeatherContainer"),t=document.getElementById("mapWeatherInfo"),o=document.getElementById("mapWeatherIcon");if(!e)return void console.warn("⚠️ [天气系统] 找不到天气容器");e.innerHTML="",e.className="map-weather-container";const a=this.weatherTypes[n];if(!a)return void console.warn(`⚠️ [天气系统] 未知天气类型: ${n}`);e.classList.add(a.cssClass),t&&o&&(t.style.display="flex",t.setAttribute("data-weather-name",a.name),o.textContent=a.icon);const i=a.particles;if(i>0&&this.createWeatherParticles(e,n,i),"cloudy"===n){const n=8+Math.floor(5*Math.random());for(let t=0;t<n;t++){const n=document.createElement("div");n.className="cloud";const t=100+150*Math.random(),o=30+50*Math.random();n.style.width=`${t}px`,n.style.height=`${o}px`,n.style.left=`-${t}px`,n.style.top=5+90*Math.random()+"%",n.style.animationDuration=20+30*Math.random()+"s",n.style.animationDelay=30*Math.random()+"s",e.appendChild(n)}}if("thunder"===n){const n=document.createElement("div");n.className="lightning",e.appendChild(n)}if("heavy-rain"===n)for(let n=0;n<8;n++){const n=document.createElement("div");n.className="ripple",n.style.left=90*Math.random()+5+"%",n.style.animationDelay=1.5*Math.random()+"s",e.appendChild(n)}this.currentWeather=n,console.log(`🌤️ [天气系统] 已应用天气特效: ${a.name}`)},createWeatherParticles(n,e,t){for(let o=0;o<t;o++){const t=document.createElement("div");switch(e){case"rain":case"heavy-rain":case"thunder":t.className="rain-drop",t.style.left=100*Math.random()+"%",t.style.animationDelay=2*Math.random()+"s",t.style.animationDuration=.5+.5*Math.random()+"s";break;case"snow":t.className="snowflake",t.textContent=["❄","❅","❆","✻","✼"][Math.floor(5*Math.random())],t.style.left=100*Math.random()+"%",t.style.animationDelay=8*Math.random()+"s",t.style.animationDuration=6+4*Math.random()+"s",t.style.fontSize=8+10*Math.random()+"px";break;case"dust":t.className="dust-particle",t.style.left=30*Math.random()+"%",t.style.top=80*Math.random()+"%",t.style.animationDelay=3*Math.random()+"s",t.style.animationDuration=2+2*Math.random()+"s",t.style.width=2+4*Math.random()+"px",t.style.height=t.style.width}n.appendChild(t)}},cycleWeatherTest(){const n=Object.keys(this.weatherTypes);this.weatherTestIndex=(this.weatherTestIndex+1)%n.length;const e=n[this.weatherTestIndex];this.renderWeatherEffect(e);const t=this.weatherTypes[e];console.log(`🔧 [开发者测试] 切换到天气: ${t.icon} ${t.name} (${this.weatherTestIndex+1}/${n.length})`)},mockUsers:[{id:1,nickname:"艾莉娅",handle:"ailiyadev",avatarBubble:"📷",distance:.8,online:!0,status:"📷 拍照中",avatar:"https://i.postimg.cc/CK0yjp9Z/2a8ebd43a59bbb20d1d8b8e058b2d8f8.jpg",bio:"24岁 | 单身\n热爱旅行和摄影\n喜欢探索城市的每个角落\n周末常去咖啡馆看书写字",tags:["摄影","旅行","咖啡","阅读"],followers:1024,likes:46900,position:{top:"25%",left:"65%"},moments:[{id:1,userName:"艾莉娅",userAvatar:"https://i.postimg.cc/CK0yjp9Z/2a8ebd43a59bbb20d1d8b8e058b2d8f8.jpg",time:"2h ago",text:"Morning coffee and city views. Taking time to appreciate the simple moments before the day gets busy.",image:null,likes:234,comments:18,shares:5,commentsList:[{user:"Alex",avatar:"A",text:"Beautiful shot!",time:"1h ago"},{user:"Emma",avatar:"E",text:"Need this energy",time:"30m ago"}]},{id:2,userName:"艾莉娅",userAvatar:"https://i.postimg.cc/CK0yjp9Z/2a8ebd43a59bbb20d1d8b8e058b2d8f8.jpg",time:"1d ago",text:"Sunset at the beach. Nature always knows how to paint the perfect picture.",image:null,likes:567,comments:42,shares:12,commentsList:[{user:"David",avatar:"D",text:"Amazing colors!",time:"1d ago"}]},{id:3,userName:"艾莉娅",userAvatar:"https://i.postimg.cc/CK0yjp9Z/2a8ebd43a59bbb20d1d8b8e058b2d8f8.jpg",time:"3d ago",text:"New camera lens arrived. Time to explore the city with fresh eyes.",image:null,likes:892,comments:67,shares:23,commentsList:[]}]},{id:2,nickname:"林晓",handle:"linxiao_fit",avatarBubble:"💪",distance:1.2,online:!0,status:"💪 健身中",avatar:"https://i.postimg.cc/K8nwcs4Z/2b5d7cc132d92c7539f72a271d3bb2bb.jpg",bio:"27岁 | 健身教练\n相信运动改变生活\n喜欢户外运动和健康饮食",tags:["健身","户外","美食"],followers:5420,likes:128e3,position:{top:"45%",left:"40%"}},{id:3,nickname:"Sophie",handle:"sophiedesign",avatarBubble:"🎨",distance:1.5,online:!1,status:"🎨 创作中",avatar:"https://i.postimg.cc/vTkkTJWV/68f698a3ec805053ecc57d4ccb24bb88.jpg",bio:"23岁 | 设计师\n热衷于创造美好的事物\n喜欢艺术展览和独立音乐",tags:["设计","艺术","音乐","猫咪"],followers:2340,likes:78500,position:{top:"60%",left:"70%"}},{id:4,nickname:"陈墨",handle:"chenmo_dev",avatarBubble:"💻",distance:2.1,online:!0,status:"💻 写代码",avatar:"https://i.postimg.cc/wBgP1cs2/2f3ad4ca3491f004f0985f7f94987e63.jpg",bio:"29岁 | 软件工程师\n技术宅\n业余时间喜欢玩游戏和做饭",tags:["编程","游戏","烹饪"],followers:892,likes:34200,position:{top:"35%",left:"50%"}},{id:5,nickname:"Emma",handle:"emma_yoga",avatarBubble:"🧘",distance:2.8,online:!0,status:"🧘 冥想中",avatar:"https://i.postimg.cc/ZYM1wd1n/dca1d391113e16471670428ff246a797.jpg",bio:"26岁 | 瑜伽老师\n追求身心平衡\n喜欢冥想、手工和素食",tags:["瑜伽","冥想","手工","素食"],followers:6780,likes:215e3,position:{top:"20%",left:"30%"}},{id:6,nickname:"王浩",handle:"wanghao_arch",avatarBubble:"🚴",distance:3.2,online:!1,status:"🚴 骑行中",avatar:"https://i.postimg.cc/wx16xgzd/8a371ffd7747316ca6a20a73e9213d83.jpg",bio:"31岁 | 建筑师\n对城市规划和空间设计充满热情\n爱好骑行和摄影",tags:["建筑","设计","骑行"],followers:3210,likes:96300,position:{top:"55%",left:"25%"}},{id:7,nickname:"米娅",handle:"miya_illust",avatarBubble:"✏️",distance:3.5,online:!0,status:"✏️ 画画",avatar:"https://i.postimg.cc/nzYhv1dF/25f610139f457dbb334fa669033e710d.jpg",bio:"25岁 | 插画师\n喜欢用画笔记录生活\n热爱动漫和手账",tags:["插画","动漫","手账","猫咪"],followers:15600,likes:452e3,position:{top:"70%",left:"55%"}},{id:8,nickname:"李思远",handle:"lisiyuan_fin",avatarBubble:"🏀",distance:4.1,online:!1,status:"🏀 打球",avatar:"https://i.postimg.cc/vZsMvnVy/16602df49663ddff9f7affe386ca828d.jpg",bio:"28岁 | 金融分析师 | 单身\n工作之余喜欢打篮球和看电影",tags:["篮球","电影","投资"],followers:1890,likes:67800,position:{top:"40%",left:"80%"}},{id:9,nickname:"张悦",handle:"zhangyue_music",avatarBubble:"🎸",distance:4.5,online:!0,status:"🎸 弹吉他",avatar:"https://i.postimg.cc/rFpwrxxB/8a0c2ef08661efe92a45bdac2522e0e5.jpg",bio:"22岁 | 音乐人\n热爱独立音乐和现场表演",tags:["音乐","吉他","创作"],followers:8920,likes:286e3,position:{top:"15%",left:"45%"}},{id:10,nickname:"刘洋",handle:"liuyang_photo",avatarBubble:"📸",distance:5,online:!0,status:"📸 街拍",avatar:"https://i.postimg.cc/Sx2QZ4ZB/d3e487bf5b4dcb930aa4710bddace460.jpg",bio:"30岁 | 摄影师\n专注街拍和人像",tags:["摄影","街拍","后期"],followers:12400,likes:398e3,position:{top:"65%",left:"35%"}},{id:11,nickname:"Anna",handle:"anna_coffee",avatarBubble:"☕",distance:5.3,online:!1,status:"☕ 冲咖啡",avatar:"https://i.postimg.cc/kGgqWP6S/47625239f04329daf2f0a5cb857fab17.jpg",bio:"24岁 | 咖啡师\n喜欢研究咖啡和烘焙",tags:["咖啡","烘焙","手冲"],followers:4560,likes:143e3,position:{top:"50%",left:"60%"}},{id:12,nickname:"赵明",handle:"zhaoming_gamedev",avatarBubble:"🎮",distance:5.8,online:!0,status:"🎮 开发游戏",avatar:"https://i.postimg.cc/WbKTqK2b/3597240784be5b8a5e20c48444522ac0.jpg",bio:"27岁 | 游戏开发者\n独立游戏爱好者",tags:["游戏","开发","独立游戏"],followers:7320,likes:234e3,position:{top:"30%",left:"75%"}}],allUsers:[],currentUsers:[],advancedFilter:{enabled:!1,gender:"all",ageMin:18,ageMax:50,personality:"",tags:"",type:""},weatherTypes:{sunny:{icon:"☀️",name:"晴天",cssClass:"weather-sunny",particles:0},cloudy:{icon:"⛅",name:"多云",cssClass:"weather-cloudy",particles:0},rain:{icon:"🌧️",name:"小雨",cssClass:"weather-rain",particles:30},"heavy-rain":{icon:"⛈️",name:"大雨",cssClass:"weather-heavy-rain",particles:60},thunder:{icon:"🌩️",name:"雷暴",cssClass:"weather-thunder",particles:50},snow:{icon:"🌨️",name:"下雪",cssClass:"weather-snow",particles:40},fog:{icon:"🌫️",name:"大雾",cssClass:"weather-fog",particles:0},dust:{icon:"🌪️",name:"沙尘",cssClass:"weather-dust",particles:35}},weatherKeywords:{sunny:["晴","晴天","晴朗","阳光","万里无云","艳阳"],cloudy:["多云","阴","阴天","云","转阴"],rain:["小雨","阵雨","零星小雨","毛毛雨","细雨"],"heavy-rain":["大雨","暴雨","中雨","大到暴雨","倾盆大雨"],thunder:["雷","雷暴","雷阵雨","雷电","打雷"],snow:["雪","小雪","中雪","大雪","暴雪","雨夹雪"],fog:["雾","大雾","浓雾","雾霾","霾"],dust:["沙尘","扬沙","浮尘","沙尘暴","尘"]},currentWeather:"sunny",weatherTestIndex:0,selectedUserId:null,isSidebarOpen:!1,currentUserPosition:{top:"50%",left:"50%"},touchStartX:0,touchStartY:0,touchEndX:0,touchEndY:0,mapState:{scale:1,translateX:0,translateY:0,isDragging:!1,startX:0,startY:0,lastTranslateX:0,lastTranslateY:0},MIN_ZOOM:.5,MAX_ZOOM:2.5,ZOOM_STEP:.3,MAP_SIZE_MULTIPLIER:3,async generateMapDatingData(e=!1,t=!1,o=""){try{console.log(e?"🔄 [第十五个情景] 刷新附近的人...":t?"📍 [第十五个情景] AI生成地标...":"🗺️ [第十五个情景] 地图约会数据生成器启动...");const{db:a,xDb:i,apiConfig:r,xSettings:l}=await g.loadConfigAndSettings(),{userPrompt:c,worldSetting:p,boundCharacters:m}=l;let x=null,u=null,h=null,f=!1,b=0,v=null,y=null,w=!1,k=null,$=null;if(e){const n=`mapDatingData_${vt||"main"}`,t=await i.xMapDatingData.get(n);if(t&&t.data){x=t.data.mapConfig,u=t.data.landmarks,h=t.data.weather,v=t.firstMapEnterTime||null,y=t.lastWeatherRefreshTime||null;const n=new Date;let e=null;y?(e=new Date(y),console.log(`🌤️ [天气判断] 使用上次天气刷新时间为基准: ${e.toLocaleString("zh-CN")}`)):v?(e=new Date(v),console.log(`🌤️ [天气判断] 使用首次进入地图时间为基准: ${e.toLocaleString("zh-CN")}`)):(v=n.toISOString(),console.log(`🌤️ [天气判断] 首次进入地图，记录进入时间: ${n.toLocaleString("zh-CN")}`)),e&&(b=(n-e)/36e5,b>=12&&h?(f=!0,console.log(`🌤️ [天气刷新] 距离基准时间已超过${b.toFixed(1)}小时（≥12h），将让AI根据上次天气【${h}】决定新天气`)):console.log(`🌤️ [天气保留] 距离基准时间仅${b.toFixed(1)}小时（<12h），保留天气: ${h}`)),console.log("📖 [第十五个情景] 已加载原有地图配置和地标数据"),console.log(`  |- 地图配置: ${JSON.stringify(x)}`),console.log(`  |- 地标数量: ${u?.length||0}`),console.log(`  |- 当前天气: ${h||"将重新生成"}`),console.log(`  |- 首次进入时间: ${v?new Date(v).toLocaleString("zh-CN"):"无"}`),console.log(`  |- 上次天气刷新: ${y?new Date(y).toLocaleString("zh-CN"):"无"}`)}else console.warn("⚠️ [第十五个情景] 未找到原有数据，将进行完整生成"),e=!1}const C=t?null:s.buildUserXProfileInfo(n.userProfileData);let I=0,S="";if(!t){const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 时间感知\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前北京时间：${(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",weekday:"long"})}\n【时间相关提示】：\n- 生成的附近的人状态应该符合当前时间段（早晨、中午、下午、晚上、深夜）\n- 例如：早晨可能在"晨跑中"，中午可能在"吃午饭"，晚上可能在"看电影"等\n- 在线状态也应该考虑时间因素（深夜在线率较低）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;S=n,I=d.logTokenUsage("地图约会生成器","时间感知",n,I)}S+=s.buildBaseSystemPrompt({userPrompt:c,worldSetting:p}),I=d.logTokenUsage("地图约会生成器","基础系统提示词",S,I);const M=await s.getApplicableWorldBooks("mapDating",{boundCharacters:m});if(M&&(S+=M,I=d.logTokenUsage("地图约会生成器","世界书内容",M,I)),!t){const e=`worldEvents_${n.currentAccountId||"main"}`,t=await i.xWorldEvents.get(e);if(k=h||this.getRandomWeather(),$=null,t&&t.enabled&&t.events&&t.events.length>0){if(!h){const n=t.weather?.condition||"";k=this.parseWeatherFromText(n)}$=this.weatherTypes[k],console.log(`🌤️ [地图约会生成器] ${h?"保持原有天气":"从全局大事件解析天气"}: ${$.icon} ${$.name}`);const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌍 世界运转状态（地图约会生成必读）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前世界设定】：\n📍 所在地点：${t.location}\n🌤️ 天气状况：${t.weather?.condition||"--"} ${t.weather?.temp||"--"}\n💡 穿衣建议：${t.weather?.tip||"--"}\n\n【近期大事件】（${t.events.length}个热门事件）：\n${t.events.map((n,e)=>`\n${e+1}. [${n.category}] ${n.title}\n   详情：${n.detail}\n   影响：${n.impact}\n`).join("")}\n\n【大事件融入规则】：\n🎯 核心原则：地图约会中的附近的人状态、个人简介应该受这些事件影响\n1. **状态影响**：某些人的状态可能与大事件相关（如"讨论XX新闻中"）\n2. **简介影响**：个人简介可能提及对某个事件的态度或兴趣\n3. **标签影响**：标签可能包含与事件相关的关键词\n4. **自然融入**：不要强行在每个人身上体现，保持多样性（建议10-30%的人受影响）\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌤️ 天气影响状态气泡规则（重要！）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前天气：${$.icon} ${$.name}\n\n**天气会影响附近的人的状态气泡（status字段）**，请根据当前天气生成符合逻辑的状态：\n\n${"rain"===k||"heavy-rain"===k||"thunder"===k?'\n🌧️ 【雨天/暴风雨状态建议】（20-40%的人可能受影响）：\n- "躲雨中"、"没带伞😭"、"等雨停"、"听雨"\n- "宅家追剧"、"窝被窝"、"在家办公"\n- "雨天咖啡☕"、"适合发呆"\n- 大雨/雷暴时更可能宅在室内\n':""}\n${"snow"===k?'\n❄️ 【雪天状态建议】（20-40%的人可能受影响）：\n- "赏雪中"、"堆雪人⛄"、"打雪仗"\n- "窝被窝"、"喝热可可"、"烤火取暖"\n- "拍雪景📷"、"雪地散步"\n':""}\n${"fog"===k?'\n🌫️ 【大雾状态建议】（10-20%的人可能受影响）：\n- "雾太大等会出门"、"能见度低"\n- "宅家"、"晚点再约"\n':""}\n${"dust"===k?'\n🌪️ 【沙尘状态建议】（20-30%的人可能受影响）：\n- "戴口罩出门"、"沙尘天待室内"\n- "等沙尘过去"、"空气太差"\n':""}\n${"sunny"===k||"cloudy"===k?"\n☀️ 【晴天/多云状态建议】（正常活动）：\n- 户外活动较多：跑步、逛街、拍照、约会\n- 可以出现各种正常状态，天气影响较小\n":""}\n\n**注意**：不要所有人都提天气，保持状态多样性。大部分人应该是正常状态，只有部分人的状态会受天气影响。\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;S+=n,I=d.logTokenUsage("地图约会生成器","世界运转大事件+天气规则",n,I),console.log(`🌍 [地图约会生成器] 已注入 ${t.events.length} 个世界大事件`)}else{$=this.weatherTypes[k],console.log(`🌤️ [地图约会生成器] 随机生成天气: ${$.icon} ${$.name}`);const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌤️ 天气影响状态气泡规则\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前天气：${$.icon} ${$.name}\n\n**天气会影响附近的人的状态气泡（status字段）**，请根据当前天气生成符合逻辑的状态：\n\n${"rain"===k||"heavy-rain"===k||"thunder"===k?'\n🌧️ 【雨天/暴风雨状态建议】（20-40%的人可能受影响）：\n- "躲雨中"、"没带伞😭"、"等雨停"、"听雨"\n- "宅家追剧"、"窝被窝"、"在家办公"\n- "雨天咖啡☕"、"适合发呆"\n':""}\n${"snow"===k?'\n❄️ 【雪天状态建议】（20-40%的人可能受影响）：\n- "赏雪中"、"堆雪人⛄"、"打雪仗"\n- "窝被窝"、"喝热可可"、"烤火取暖"\n':""}\n${"fog"===k?'\n🌫️ 【大雾状态建议】（10-20%的人可能受影响）：\n- "雾太大等会出门"、"能见度低"\n- "宅家"、"晚点再约"\n':""}\n${"dust"===k?'\n🌪️ 【沙尘状态建议】（20-30%的人可能受影响）：\n- "戴口罩出门"、"沙尘天待室内"\n':""}\n${"sunny"===k||"cloudy"===k?"\n☀️ 【晴天/多云状态建议】（正常活动）：\n- 户外活动较多：跑步、逛街、拍照、约会\n- 可以出现各种正常状态\n":""}\n\n**注意**：不要所有人都提天气，保持状态多样性。\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;S+=n,I=d.logTokenUsage("地图约会生成器","天气规则（无大事件）",n,I),console.log("ℹ️ [地图约会生成器] 世界大事件未启用或无数据，仅注入天气规则")}}e?(S+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是地图约会数据生成器。请根据世界观、世界书和大事件生成新的附近的人数据。\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【生成要求】：\n\n## 附近的人（nearbyUsers）- Instagram风格资料卡\n- 生成8-15个附近的人",this.advancedFilter&&this.advancedFilter.enabled&&(S+=`\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 用户指定筛选条件（重要！）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **用户设置了指定筛选条件，请尽量按以下要求生成附近的人：**\n\n【筛选条件】：\n${"all"!==this.advancedFilter.gender?"- 性别偏好："+("male"===this.advancedFilter.gender?"男性为主":"女性为主"):""}\n${this.advancedFilter.ageMin&&this.advancedFilter.ageMax?`- 年龄区间：${this.advancedFilter.ageMin}-${this.advancedFilter.ageMax}岁`:""}\n${this.advancedFilter.personality?`- 性格要求：${this.advancedFilter.personality}`:""}\n${this.advancedFilter.tags?`- 标签/兴趣要求：${this.advancedFilter.tags}`:""}\n${this.advancedFilter.type?`- 其他要求：${this.advancedFilter.type}`:""}\n\n【筛选规则】：\n⚠️ **重要：不需要每个人都完全符合条件，可以灵活匹配！**\n\n1. **性别筛选**（如果指定）：\n   - 如果用户选择了特定性别，生成的人物中**60-80%应该是该性别**\n   - 保留20-40%其他性别的人物，保持真实性和多样性\n\n2. **年龄区间**（如果指定）：\n   - **70-90%的人物年龄应该在指定区间内**\n   - 允许10-30%的人物年龄稍微超出范围（±3岁左右）\n\n3. **性格要求**（如果指定）：\n   - 生成时，**50-70%的人物性格标签应包含相关关键词**\n   - 例如用户要求"outgoing"，可以生成：开朗、外向、活泼、社交达人等\n   - 不是所有人都要完全匹配，保持性格多样性\n\n4. **标签/兴趣要求**（如果指定）：\n   - **40-60%的人物应该有相关的标签或兴趣**\n   - 例如用户要求"music, sports"，生成的人物中部分有音乐相关标签，部分有运动标签\n   - 可以是直接匹配（"音乐"、"运动"）或相关词（"吉他"、"健身"、"篮球"）\n\n5. **其他要求**（如果指定）：\n   - 根据用户自由输入的要求，**灵活理解并应用到30-50%的人物中**\n   - 不要生硬地强制匹配，保持自然和真实性\n\n🎯 **核心原则**：\n- 筛选是"倾向性"而非"强制性"：大部分人符合条件即可\n- 保持多样性：不要所有人都一模一样\n- 真实感优先：即使有筛选条件，生成的人物也要符合世界观和逻辑\n- 可以有惊喜：偶尔生成一些不完全符合但很有特色的人物\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`)):S+=t?`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是地标数据生成器。请根据世界观、世界书和用户要求生成独一无二的地标数据。\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【用户自定义要求】：\n${o||"无特殊要求，根据世界观自由生成即可。"}\n${this.customLandmarks&&this.customLandmarks.length>0?`\n\n【现有自定义地标】：\n系统中已存在 ${this.customLandmarks.length} 个自定义地标，请注意：\n1. **为这些地标生成事件**：约20%的现有地标应该生成事件（如果它们还没有event字段）\n2. **深度结合description字段**：如果地标有description字段，必须深度结合其内容生成事件\n3. **避免重复**：不要生成与现有地标名称相同的新地标\n4. **返回时必须包含所有现有地标**（无论是否添加事件），并与新生成的地标一起返回\n\n现有地标数据：\n\`\`\`json\n${JSON.stringify(this.customLandmarks,null,2)}\n\`\`\`\n`:""}\n\n【生成要求】：\n\n## 地标数据（landmarks）\n- 根据世界观和用户要求生成**新的**地标\n- 如果用户指定了地标类型或数量，优先满足用户要求\n- 如果用户没有指定，根据世界观关键词随机生成，类型分布合理：\n  * 教育类（🎓）：15-25%\n  * 餐饮类（☕🍜🍕）：20-30%\n  * 娱乐类（🎮🎬🎪）：15-25%\n  * 商业类（🛒💼🏢）：15-25%\n  * 公共类（🏥⛪🏛️）：10-20%\n- **严禁生成重复的地标**，每个地标名称必须唯一\n- 地标数量：根据用户要求，默认5-15个\n- 每个地标包含：\n  * id: 唯一标识（字符串）\n  * name: 地标名称（字符串）\n  * icon: emoji图标（字符串）\n  * color: 颜色（#十六进制字符串）\n  * **注意：x, y坐标由系统自动分配，不需要生成**\n\n【输出JSON格式】：\n\`\`\`json\n{\n  "landmarks": [\n    {\n      "id": "landmark_001",\n      "name": "星巴克咖啡（市中心店）",\n      "icon": "☕",\n      "color": "#00a862"\n      // 无事件的地标不需要event字段\n    },\n    {\n      "id": "landmark_002",\n      "name": "中央公园",\n      "icon": "🌳",\n      "color": "#4caf50",\n      "event": {\n        "eventType": "alert",\n        "accentColor": "#c9302c",\n        "eventHTML": "<div class=\\"event-paper-header\\" style=\\"background: #c9302c;\\">...</div><div class=\\"event-article\\">...</div><div class=\\"event-footer\\">...</div>"\n      }\n    },\n    {\n      "id": "landmark_003",\n      "name": "好莱坞工厂",\n      "icon": "🏭",\n      "color": "#9e9e9e",\n      "event": {\n        "eventType": "news",\n        "accentColor": "#2c5aa0",\n        "eventHTML": "<div class=\\"event-paper-header\\"><div class=\\"event-masthead\\">City Daily</div>...</div>..."\n      }\n    }\n    // ... 更多地标（约20%有event，80%无event）\n  ],\n  "newspaper": {\n    "weather": { "icon": "☀", "temp": "18°C", "desc": "TODAY · SUNNY" },\n    "news": [ { "headline": "...", "location": "...", "time": "...", "body": "...", "comment": "..." } ],\n    "bubble": "✧ ...",\n    "submissions": [ { "tag": "MISSING", "title": "...", "content": "..." } ],\n    "ads": [ { "title": "...", "text": "..." } ]\n  }\n}\n\`\`\`\n\n🚨 **重要**：\n- 必须返回 **landmarks数组** 和 **newspaper对象**\n- newspaper字段是必须的，包含结构化的报纸数据（非HTML字符串）\n- JSON必须合法，不能有语法错误\n- 所有字段名必须用双引号\n- 最后一个对象后面不能有逗号\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`:`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是地图约会数据生成器。请根据世界观、世界书和大事件生成独一无二的地图约会数据。\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【生成要求】：\n${this.customLandmarks&&this.customLandmarks.length>0?`\n\n【现有自定义地标】：\n系统中已存在 ${this.customLandmarks.length} 个自定义地标，请注意：\n1. **为这些地标生成事件**：约20%的现有地标应该生成事件（如果它们还没有event字段）\n2. **深度结合description字段**：如果地标有description字段，必须深度结合其内容生成事件\n3. **避免重复**：不要生成与现有地标名称相同的新地标\n4. **返回时必须包含所有现有地标**（无论是否添加事件），并与新生成的地标一起返回\n\n现有地标数据：\n\`\`\`json\n${JSON.stringify(this.customLandmarks,null,2)}\n\`\`\`\n`:""}\n\n## 1. 地图配置（mapConfig）\n根据世界观描述动态调整地图元素比例：\n- waterRatio: 湖水比例（0-1小数）。如果世界观描述"靠海"、"临江"、"水城"等，应增加此值（0.3-0.5）；如果是"内陆"、"沙漠"等，应减少（0-0.1）\n- buildingDensity: 建筑密度（0-1小数）。先进城市0.6-0.8，普通城市0.4-0.6，农村0.1-0.3\n- parkCount: 公园数量（2-8整数）。根据城市大小和环境意识调整\n- roadWidth: 道路宽度（10-25整数）。发达地区用更宽的道路\n\n## 2. 地标数据（landmarks）\n- **必须包含世界观和世界书中提到的所有重要地标**（学校、公司、商场等关键地点）\n- 其他地标根据世界观关键词随机生成，类型分布合理：\n  * 教育类（🎓）：15-25%\n  * 餐饮类（☕🍜🍕）：20-30%\n  * 娱乐类（🎮🎬🎪）：15-25%\n  * 商业类（🛒💼🏢）：15-25%\n  * 公共类（🏥⛪🏛️）：10-20%\n- **严禁生成重复的地标**，每个地标名称必须唯一\n- 地标数量：10-30个\n- 每个地标包含：\n  * id: 唯一标识（字符串）\n  * name: 地标名称（字符串）\n  * icon: emoji图标（字符串）\n  * color: 颜色（#十六进制字符串）\n  * **注意：x, y坐标由系统自动分配，不需要生成**\n  * event: 地标事件对象（可选，**约20%的地标应该有事件**）\n    - eventType: 事件类型字符串（"news"新闻/"alert"警报/"scandal"丑闻/"wanted"通缉/"business"商业/"government"政府/"incident"事件等）\n    - eventHTML: 事件HTML内容（字符串，**必须严格遵循下方的HTML生成规范**）\n    - accentColor: 强调色（#十六进制字符串，**可以自由选择任何深色系颜色，根据事件性质和氛围选择最合适的颜色，禁止使用荧光色和emoji**）\n\n### 2.1 地标事件生成规则（仅适用于约20%的地标）\n\n**事件分配原则**：\n- 随机选择约20%的地标赋予事件\n- 事件类型必须与地标性质高度相关（如：工厂→火灾新闻、公园→可疑物品警报、商场→开业活动、酒吧→斗殴事件）\n- 事件内容必须符合世界观设定、当前时间、天气状况\n- **如果地标有description字段（自定义地标），必须深度结合description内容生成事件**\n\n**事件类型示例**（颜色可自由选择，以下仅为参考）：\n1. **报纸新闻** (news)：火灾、事故、重大发现、历史建筑、名人事件\n2. **紧急警报** (alert)：可疑物品、治安事件、自然灾害预警、交通管制\n3. **娱乐丑闻** (scandal)：名人绯闻、商业内幕、隐私泄露、争议事件\n4. **通缉令** (wanted)：在逃人员、悬赏通缉、协查通报、犯罪预警\n5. **商业活动** (business)：新店开业、促销活动、品牌发布、商场庆典\n6. **政府公告** (government)：工程施工、政策通知、公共服务、市政改造\n7. **血腥事件** (incident)：暴力事件、重大伤亡、犯罪现场、恐怖袭击\n8. **抓马事件** (drama)：情感纠纷、八卦爆料、社区冲突、邻里矛盾\n9. **其他创意类型**：根据地标性质和世界观自由发挥，不限于以上分类\n\n### 2.2 事件HTML生成规范（极其重要！）\n\n**生成的eventHTML必须严格遵守以下规范**：\n\n#### 设计要求（强制）：\n1. **色彩系统**：\n   - 主色调：只能使用黑色、白色、各级灰色\n   - 强调色：accentColor字段用于指定强调色（深蓝/深红/深绿/紫色/深灰，**绝对禁止荧光色**）\n   - **绝对禁止**：Emoji表情符号、荧光色、彩虹色、粉色、亮绿色\n   - **颜色使用规则（极其重要）**：\n     * 只在JSON的accentColor字段中指定颜色值（如 "#8E44AD"）\n     * HTML中绝对不要写任何颜色代码（不要用style="color: xxx"之类）\n     * HTML中只使用提供的CSS类（如 event-tag, event-emphasis 等）\n     * 系统会自动将accentColor设置为CSS变量 --event-accent\n     * CSS类会自动应用这个变量，你不需要手动指定颜色\n\n2. **排版类库（必须使用提供的CSS类）**：\n   - **报纸头部**：\n     * event-paper-header（头部容器）\n     * event-masthead（报社名称，大标题）\n     * event-tagline（标语口号）\n     * event-header-meta（元信息：期数、日期等）\n\n   - **标题类**：\n     * event-headline（主标题，42px，粗体衬线）\n     * event-subheadline（副标题，26px）\n     * event-title（小标题，20px）\n\n   - **正文类**：\n     * event-lead（导语，20px，加粗）\n     * event-body（正文，19px，衬线字体）\n     * event-body-sans（无衬线正文，16px）\n     * event-byline（署名行）\n\n   - **装饰类**：\n     * event-drop-cap（首字母下沉，用于正文第一段）\n     * event-quote（引用块，灰色背景+主题色左边框）\n     * event-quote-author（引用来源）\n     * event-emphasis（强调文字，主题色文字颜色）\n     * event-bold（加粗）\n     * event-caption（说明文字，小字号灰色）\n\n   - **容器类（注意区分用途）**：\n     * event-box（基础信息框，灰色背景）\n     * event-box-highlight（高亮信息框，灰色背景+主题色左边框）\n     * event-box-alert（警告框，**主题色背景+白色文字**）\n\n   - **标签类**：\n     * event-tag（主标签，**主题色背景+白色文字**）\n     * event-tag secondary（次要标签，灰色背景+普通文字）\n\n   - **分隔线**：\n     * event-divider（细线）\n     * event-divider-thick（粗线）\n     * event-divider-double（双线）\n\n   - **列表和表格**：\n     * event-list（有序/无序列表）\n     * event-list-clean（无样式列表）\n     * event-table（表格）\n\n   - **布局**：\n     * event-columns-2（双栏布局）\n     * event-footer（页脚）\n\n3. **内容质量标准**：\n   - 长度：300-1000字，根据事件重要性调整\n   - 深度：必须有具体细节、人物对话、数据支持、时间线\n   - 真实感：符合地标性质、世界观设定、时间线逻辑、天气状况\n   - **自定义地标**：如果landmark有description字段，必须深度结合其内容生成事件\n   - 避免空洞、模板化的描述\n\n4. **HTML结构模板**：\n\`\`\`html\n<div class="event-paper-header">\n  <div class="event-masthead">报社名称</div>\n  <div class="event-tagline">标语口号</div>\n  <div class="event-header-meta">\n    <span>期数/编号</span>\n    <span>日期</span>\n    <span>其他信息</span>\n  </div>\n</div>\n\n<div class="event-article">\n  <div class="event-tags">\n    <span class="event-tag">标签1</span>\n    <span class="event-tag secondary">标签2</span>\n  </div>\n\n  <h1 class="event-headline">主标题<br>可以换行</h1>\n\n  <div class="event-byline">\n    <strong>记者/来源</strong> · 时间/地点\n  </div>\n\n  <p class="event-lead">导语：简明扼要概括事件核心，吸引读者注意...</p>\n\n  <hr class="event-divider-thick">\n\n  <p class="event-body event-drop-cap">正文第一段使用首字母下沉效果。内容要具体生动，包含时间、地点、人物、经过、结果等要素...</p>\n\n  <div class="event-quote">\n    引用的话语内容，可以是目击者证词、专家评论等...\n    <div class="event-quote-author">— 引用来源</div>\n  </div>\n\n  <h2 class="event-subheadline">副标题</h2>\n\n  <p class="event-body">继续叙述...</p>\n\n  <div class="event-box">\n    <strong class="event-bold">相关信息</strong><br>\n    <span class="event-caption">补充说明...</span>\n  </div>\n</div>\n\n<div class="event-footer">\n  版权信息或其他页脚内容\n</div>\n\`\`\`\n\n5. **事件类型特定要求**：\n   - **报纸新闻**：使用报纸头部、首字母下沉、引用块、相关报道框\n   - **紧急警报**：红色警告框、时间线表格、受影响区域列表、公众提醒\n   - **政府公告**：邮件头部样式、阶段表格、联系方式框、正式语气\n   - **娱乐丑闻**：双栏证词框、爆料风格、免责声明、阅读量统计\n   - **通缉令**：人物信息表、悬赏公告、举报方式、案情描述\n   - **商业活动**：优惠信息、活动详情、营业时间、联系方式\n   - **血腥事件**：严肃措辞、警方通报格式、深色调、避免过度描写\n\n**重要提醒**：\n- eventHTML只输出HTML片段，不要包含 <html>, <head>, <body> 等外层标签\n- 不要添加额外的 <style> 或 <script>\n- **所有样式必须且只能使用提供的CSS类，绝对禁止任何内联style样式！**\n- **强调色必须且只能通过CSS类实现，系统会自动设置CSS变量值，绝对不要在HTML中写任何颜色代码！**\n- **CSS类使用规则（极其重要，避免颜色混淆）**：\n  * 需要"主题色背景+白字"效果时：使用 event-tag 或 event-box-alert\n  * 需要"灰色背景+主题色边框"效果时：使用 event-box-highlight 或 event-quote\n  * 需要"主题色文字"效果时：使用 event-emphasis 或在span/strong上添加event-emphasis类\n  * 需要普通信息框时：使用 event-box（灰色背景，无主题色）\n  * **绝对不要混淆背景和文字的颜色使用场景！**\n  * **绝对不要把主题色背景用在应该用灰色背景的地方，反之亦然！**\n- 必须适配深色和浅色主题（使用CSS变量）\n- 必须在移动端（竖屏）完美显示\n\n## 3. 附近的人（nearbyUsers）- Instagram风格资料卡\n- 生成10-30个附近的人`,t||(S+='\n- 人物应符合世界观背景和大事件影响\n- **地域限制**：如果有绑定角色，检查角色的居住地/活动地点。外国角色、异地角色不能出现在附近的人中！只能生成与当前地点相符的本地人。\n- 每个人包含：\n  * nickname: 昵称（2-8个字符，可以是真名、网名或艺名，符合世界观背景）\n  * handle: 句柄（类似Instagram的@username，5-15个字符，纯英文小写+数字+下划线，如"lihua_dev"、"xiaoming2024"）\n  * avatarBubble: 头像气泡（单个emoji或1-2个颜文字，表达心情或个性，如"😊"、"📷"、"💤"、"🎮"、"✨"）\n  * gender: 性别（"male"、"female"或"unisex"字符串）\n  * distance: 距离（0.5-6.0小数，保留1位）\n  * online: 是否在线（true/false布尔值）\n  * status: 状态文本（**格式自由，可以有emoji也可以没有**）\n    - 可以是个人状态：如"健身中"、"📷 拍照中"、"工作ing"\n    - 可以是社交宣告：如"cpdd"、"已婚勿扰"、"找饭搭子"、"交友"\n    - 状态应该符合时间段和人物性格\n  * bio: 个人简介（**多行格式，用\n分隔行**）\n    - **第一行格式**：年龄（18-35）+ " | " + 感情状态（单身/恋爱中/已婚/保密等）\n    - **后续行**：兴趣爱好、职业、生活态度等（1-3句话）\n    - **示例**："24岁 | 单身\n热爱旅行和摄影\n喜欢探索城市的每个角落\n周末常去咖啡馆看书写字"\n  * publicPersonality: 表现性格（数组，10-15个关键词，描述在网络/社交媒体上表现出来的性格特征）\n    - 关键词示例："开朗"、"热情"、"幽默"、"温柔"、"活泼"、"乐观"、"健谈"等\n    - 这是TA给外界的印象，可能与真实性格一致，也可能表里不一\n  * realPersonality: 真实性格（数组，10-15个关键词，描述真实的内在性格特征）\n    - 关键词示例："内向"、"敏感"、"闷骚"、"阴暗"、"受虐狂"、"控制欲"、"阴险"、"孤僻"等\n    - 这是TA的真实性格，可能与表现性格完全不同（双面性），也可能一致（表里如一）\n    - **重要**：真实性格可以是负面的、复杂的、矛盾的，要真实反映人性的多面性\n  * appearance: 外貌及身材（数组，10-15个关键词，描述外貌和身体特征）\n    - 关键词示例："黑发"、"猫眼"、"182cm/60kg"、"三围90/60/88"、"蝴蝶耳钉"、"纹身"、"肌肉线条"、"瓜子脸"、"单眼皮"、"痣"等\n    - 包括：发色、眼睛、身高体重、三围、配饰、特殊标记、体型、脸型、五官特征等\n  * tags: 标签数组（2-4个字符串）\n  * followers: 粉丝数（100-50000整数，符合普通用户水平，不要太夸张）\n  * likes: 获赞数（1000-100000整数，一般是粉丝数的10-50倍）\n  * avgRating: 平均评分（0-5小数，保留1位，约会评分系统。如4.8、3.2、0表示无评价）\n  * reviews: 评价/留言数组（可选，0-8条评价，这是地图约会app的核心功能！）\n    - reviewerName: 评价者昵称（2-8字符，或"匿名用户"）\n    - rating: 评分（1-5小数，保留1位，如4.9、3.5）\n    - content: 评价内容（20-100字，可以是：赞美外貌/身材、警告骚扰行为、分享约会体验、投诉不守时等，真实自然）\n    - reply: 作者回复（可选，10-50字，该地图用户对评价的回复）\n    - likes: 点赞数（0-500整数）\n    - comments: 评论数（0-50整数）\n    - timestamp: 时间戳（ISO格式字符串，如"2024-01-15T10:30:00Z"，最近1-30天内）\n    - isAnonymous: 是否匿名（布尔值，约30%匿名）\n  * **注意：不需要生成avatar、id、position、reviewerAvatar字段，由系统自动处理**\n\n## 4. 提醒功能（notifications）- 跨地域互动系统\n- 生成0-3条提醒（30-50%概率生成，可以不生成）\n- 提醒来自"其他用户"对"用户X"的行为（感兴趣或发私信）\n\n### 提醒类型说明：\n\n**第一类：interested（对你的资料感兴趣）**\n- 含义：某个用户浏览了你的资料后，对你产生了兴趣\n- 数据结构：\n  * type: "interested"\n  * fromUser: 完整的用户对象（结构与nearbyUsers相同）\n  * content: 简短的兴趣表达（10-30字），如"觉得你挺有趣的"、"你的照片很好看"、"想认识一下"等\n  * 不需要生成id、timestamp、isRead字段\n\n**第二类：message（发来私信）**\n- 含义：某个用户给你发送了1-3条私信\n- 数据结构：\n  * type: "message"\n  * fromUser: 完整的用户对象（结构与nearbyUsers相同）\n  * messages: 字符串数组（1-3条私信内容）\n    - 第1条：开场白/打招呼（15-40字），如"Hi，可以认识一下吗？"、"你好，看到你的资料觉得很有趣"\n    - 第2条（可选）：兴趣点/共同话题（15-50字），如"我也喜欢旅行"、"看到你去过日本，我也很想去"\n    - 第3条（可选）：进一步表达/邀约（15-50字），如"有空可以一起喝杯咖啡吗？"、"很想和你聊聊摄影"\n  * **重要**：message类型不需要content字段，只需要messages数组\n  * 不需要生成id、timestamp、isRead字段\n\n### fromUser用户特征：\n- fromUser是完整的用户对象，包含所有nearbyUsers的字段（nickname, handle, avatarBubble, gender, distance, online, status, bio, publicPersonality, realPersonality, appearance, tags, followers, likes, avgRating, reviews等）\n- **重要**：fromUser可以是距离较远的用户（5-50km），或者来自其他城市/国家，**不受地图约会地域限制**\n- 这些用户可以是异地的、外国的，因为App允许跨地域浏览资料和发私信\n- fromUser应该符合世界观背景和大事件影响\n- fromUser的性格、外貌、标签应该多样化，不要千篇一律\n\n### 生成概率和分布：\n- 30-50%概率生成提醒（即有50-70%概率返回空数组[]）\n- 如果生成提醒，70%概率生成1条，20%概率生成2条，10%概率生成3条\n- interested和message类型比例大约1:1\n- message类型中，60%生成1条消息，30%生成2条消息，10%生成3条消息\n');const T=S.substring(I>0?S.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"):0);if(I=d.logTokenUsage("地图约会生成器","核心任务说明",T,I),!t){const n=await s.buildCompleteCharacterInfo(m,C,"mapDating");n&&(S+=n,S+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌏 地域限制规则（重要！）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**在生成附近的人时，必须严格遵守地域限制：**\n\n1. **检查角色居住地/活动地点**：\n   - 如果角色卡明确标注居住在外国（如美国、日本、韩国等）→ 该角色不能出现在附近的人中\n   - 如果角色卡标注在国内其他城市（异地）→ 该角色不能出现在附近的人中\n   - 只有明确在当前地点或未标注居住地的角色，才可能出现\n\n2. **生成本地人物**：\n   - 附近的人应该是符合当前地点（世界观中的城市/地区）的本地人\n   - 姓名、身份、生活方式应符合当前地点的文化背景\n   - 避免生成明显的异地/异国人物\n\n3. **特殊情况**：\n   - 如果角色卡中提到"经常往返"、"双城生活"等，可以酌情考虑\n   - 如果世界观本身设定在国外，则按照该国的本地标准判断\n\n**记住：地图约会是基于地理位置的，异地/异国的人不可能出现在附近！**\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n',I=d.logTokenUsage("地图约会生成器","角色资料+地域判断",n,I));const t=await s.buildCharacterRelationships(m,vt||"main");t&&(S+=t,I=d.logTokenUsage("地图约会生成器","角色关系网络",t,I),console.log("💞 已加载角色关系网络信息"));const o=S.length;S+=s.buildUniversalConstraints(C);const a=S.substring(o);if(I=d.logTokenUsage("地图约会生成器","用户资料约束",a,I),f&&h){const n=this.weatherTypes[h];S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌤️ 天气更新决策（重要！）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **系统检测到距离天气刷新基准时间已过去${b.toFixed(1)}小时（≥12小时），需要你根据天气规律决定当前天气**\n\n【上次天气状态】：\n- 天气类型：${n.icon} ${n.name}（${h}）\n- 经过时间：${b.toFixed(1)}小时\n\n【天气决策规则】：\n⏰ **根据时间推移和天气规律，合理决定新天气**\n\n1. **天气连续性原则**（优先考虑）：\n   - 晴天 → 12小时后：60%继续晴天，30%转多云，10%转其他\n   - 多云 → 12小时后：40%继续多云，30%转晴，20%转雨，10%转其他\n   - 小雨 → 12小时后：30%继续下雨，40%雨停转多云，20%转晴，10%转其他\n   - 暴雨 → 12小时后：20%继续暴雨，50%转小雨，20%转多云，10%转晴\n   - 雷暴 → 12小时后：10%继续雷暴，40%转小雨，30%转多云，20%转晴\n   - 下雪 → 12小时后：40%继续下雪，30%雪停转多云，20%转晴，10%转雨\n   - 雾霾 → 12小时后：50%继续雾霾，30%散去转多云，20%转晴\n   - 沙尘 → 12小时后：40%继续沙尘，40%散去转多云，20%转晴\n\n2. **时间因素**：\n   - 如果经过时间较短（12-18小时），天气变化应该较小，倾向保持或微变\n   - 如果经过时间较长（18-24小时以上），天气变化可以较大\n\n3. **季节常识**（如果世界观有季节设定）：\n   - 夏季：更容易出现雷暴、暴雨\n   - 冬季：更容易出现雨雪、雾霾\n   - 春秋：天气变化较频繁\n\n4. **可用天气类型**（你必须从以下类型中选择）：\n   - "sunny"（晴天）- ☀️\n   - "cloudy"（多云）- ☁️\n   - "rain"（小雨）- 🌧️\n   - "heavy-rain"（暴雨）- ⛈️\n   - "thunder"（雷暴）- ⚡\n   - "snow"（下雪）- ❄️\n   - "fog"（雾霾）- 🌫️\n   - "dust"（沙尘）- 🌪️\n\n【返回格式要求】：\n${e?'- 在JSON的nearbyUsers同级添加 "weather" 字段\n- 格式：{\n    "nearbyUsers": [...],\n    "weather": "你决定的天气类型字符串（从上面8个类型中选择）"\n  }':'- 在JSON的mapConfig同级添加 "weather" 字段\n- 格式：{\n    "mapConfig": {...},\n    "weather": "你决定的天气类型字符串（从上面8个类型中选择）",\n    "landmarks": [...],\n    "nearbyUsers": [...]\n  }'}\n\n⚠️ **重要**：你必须决定新天气，不能省略weather字段！请根据上述规则，考虑天气连续性和时间推移，做出合理决策！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}}let A=!1;if(!e){const n=Date.now(),e=432e5;let t=[];try{const n=localStorage.getItem("newspaperGenerateHistory");n&&(t=JSON.parse(n))}catch(n){console.error("❌ [咩三三报纸] 读取生成历史失败:",n),t=[]}if(t=t.filter(t=>n-t<e),t.length<2)A=!0,console.log(`✅ [咩三三报纸] 12小时内已生成 ${t.length} 次，允许再次生成`);else{A=!1;const o=Math.min(...t),a=Math.ceil((e-(n-o))/6e4);console.warn(`⚠️ [咩三三报纸] 12小时内已生成 ${t.length} 次，达到上限。需等待 ${a} 分钟后才能再次生成`)}try{localStorage.setItem("newspaperGenerateHistory",JSON.stringify(t))}catch(n){console.error("❌ [咩三三报纸] 保存生成历史失败:",n)}}if(!e&&A){const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🐑 咩三三城市报纸数据生成任务\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n除了生成地图约会数据外，你还需要生成一份由"咩三三"播报的城市报纸数据。\n\n【角色设定：咩三三】\n- 名字：咩三三（Mie333）\n- 身份：城市报纸的新闻/天气播报员\n- 性格特征：\n  * 说话习惯第三人称（"咩三三认为..."、"咩三三发现..."）\n  * 喜欢使用表情符号增添可爱感（✨😊🌟💫等）\n  * 正义感驱动：看到不公会义愤填膺，热心报道真相\n  * 自利性格：也会考虑自己的利益和安全，不会完全无私\n  * 播报风格：专业但不失可爱，严肃中带点俏皮\n\n【报纸数据结构要求】\n生成结构化的JSON数据，系统会用模板渲染。\n\n## 1. 天气数据（weather）\n- **重要**：天气图标和类型必须与当前地图天气（${$?.icon||"☀️"} ${$?.name||"晴天"}）保持一致！\n- 包含字段：\n  * icon: 天气图标（必须使用 ${$?.icon||"☀️"}）\n  * temp: 温度字符串（如"18°C"，根据季节和天气类型合理生成）\n  * desc: 天气英文描述（大写，如"TODAY · SUNNY"）\n\n## 2. 重大新闻数组（news，1-2条）\n- 新闻内容必须符合世界观设定和世界运转大事件（如果有）\n- 可以是积极的（新店开业、节日庆典）或负面的（事故、犯罪）\n- 每条新闻包含字段：\n  * headline: 新闻标题（简洁有力）\n  * location: 地点（英文大写，如"DOWNTOWN"）\n  * time: 发生时间（如"2H AGO", "30MIN AGO"）\n  * body: 新闻正文（3-5句话，咩三三第三人称播报风格，带表情符号）\n  * comment: 咩三三的个人评论（1句话，可用颜文字如(￣ー￣)，体现真实想法）\n\n## 3. 咩三三的真实想法（bubble，可选）\n- 一句话吐槽或真心话，前缀"✧"（如"✧ 咩三三的真实想法：不如去便利店买罐装咖啡实在！"）\n\n## 4. 公众投稿数组（submissions，3-4条）\n- 类型分布：寻人/寻宠启事30%，任务悬赏/求助30%，市民故事/分享20%，投诉/建议20%\n- 可以结合世界观和当前地图的地标\n- 每条投稿包含字段：\n  * tag: 类型标签（"MISSING", "TASK", "STORY", "COMPLAINT"之一）\n  * title: 投稿标题（简短）\n  * content: 投稿内容（2-3行，口语化，真实感，可含咩三三的点评）\n\n## 5. 赞助商广告数组（ads，1-2条）\n- 广告内容应该创意、有趣\n- 可以是虚构的商家或基于地标的真实商家\n- 每条广告包含字段：\n  * title: 广告标题\n  * text: 广告文案（2-3句话，可含咩三三的俏皮推荐，可用颜文字）\n\n【newspaper字段JSON格式示例】\n\`\`\`json\n{\n  "weather": {\n    "icon": "${$?.icon||"☀️"}",\n    "temp": "18°C",\n    "desc": "TODAY · ${($?.name||"SUNNY").toUpperCase()}"\n  },\n  "news": [\n    {\n      "headline": "市中心星巴克咖啡盛大开业",\n      "location": "DOWNTOWN",\n      "time": "2H AGO",\n      "body": "咩三三我今天路过市中心商业街，发现那边新开了家星巴克。门口排了好长的队，都是冲着开业优惠去的。😊",\n      "comment": "(￣ー￣) 咩三三觉得这种开业活动就是套路..."\n    }\n  ],\n  "bubble": "✧ 咩三三的真实想法：不如去便利店买罐装咖啡实在！",\n  "submissions": [\n    {\n      "tag": "MISSING",\n      "title": "寻找走失的金毛犬",\n      "content": "昨晚在公园走失，红色项圈，请联系138****5678。重谢！"\n    },\n    {\n      "tag": "COMPLAINT",\n      "title": "楼上邻居深夜扰民",\n      "content": "301室每晚12点后蹦迪！咩三三：直接找物业。(눈_눈)"\n    }\n  ],\n  "ads": [\n    {\n      "title": "咩三三的杂货铺",\n      "text": "各种稀奇古怪的小玩意儿都有卖！价格公道童叟无欺。地址：商业街99号 | 营业时间：看心情 (￣y▽￣)╭"\n    }\n  ]\n}\n\`\`\`\n\n**重要规则**：\n1. 天气icon和desc必须与当前地图天气（${$?.icon||"☀️"} ${$?.name||"晴天"}）一致\n2. 新闻内容必须符合世界观和世界大事件（如果有）\n3. 咩三三的语气要保持一致（第三人称+表情符号+颜文字）\n4. 公众投稿要多样化，类型分布合理\n5. 所有文本内容都是纯文本，不要包含HTML标签\n6. newspaper字段返回结构化的JSON对象，不是HTML字符串\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;S+=n,I=d.logTokenUsage("地图约会生成器","咩三三报纸生成提示词",n,I),console.log("🐑 [地图约会生成器] 已注入咩三三城市报纸生成提示词")}if(t||(S+=e?'\n【JSON返回格式】：\n```json\n{\n  "nearbyUsers": [\n    {':'\n【JSON返回格式】：\n```json\n{\n  "mapConfig": {\n    "waterRatio": 数字,\n    "buildingDensity": 数字,\n    "parkCount": 整数,\n    "roadWidth": 整数\n  },\n  "landmarks": [\n    {\n      "id": "字符串",\n      "name": "字符串",\n      "icon": "emoji",\n      "color": "#十六进制"\n      // 约80%地标无event字段\n    },\n    {\n      "id": "字符串",\n      "name": "字符串",\n      "icon": "emoji",\n      "color": "#十六进制",\n      "event": {\n        "eventType": "事件类型字符串",\n        "accentColor": "#十六进制（深蓝/深红/深绿/紫色/深灰）",\n        "eventHTML": "完整的事件HTML字符串（必须严格遵循前面的HTML生成规范）"\n      }\n      // 约20%地标有event字段\n    }\n  ],\n  "nearbyUsers": [\n    {'),!t){S+='\n      "nickname": "字符串",\n      "handle": "字符串（纯英文小写+数字+下划线）",\n      "avatarBubble": "emoji或颜文字",\n      "gender": "male/female/unisex",\n      "distance": 小数,\n      "online": 布尔值,\n      "status": "字符串",\n      "bio": "多行字符串（用\\n分隔，第一行格式：年龄 | 感情状态）",\n      "publicPersonality": ["关键词1", "关键词2", "..."],\n      "realPersonality": ["关键词1", "关键词2", "..."],\n      "appearance": ["关键词1", "关键词2", "..."],\n      "secret": "字符串（可选，秘密）",\n      "tags": ["字符串"],\n      "followers": 整数,\n      "likes": 整数,\n      "avgRating": 小数,\n      "reviews": [\n        {\n          "reviewerName": "字符串",\n          "rating": 小数,\n          "content": "字符串",\n          "reply": "字符串（可选）",\n          "likes": 整数,\n          "comments": 整数,\n          "timestamp": "ISO字符串",\n          "isAnonymous": 布尔值\n        }\n      ]\n    }\n  ],\n  "notifications": [\n    {\n      "type": "interested",\n      "fromUser": {\n        "nickname": "字符串",\n        "handle": "字符串",\n        "avatarBubble": "emoji",\n        "gender": "male/female/unisex",\n        "distance": 小数（5-50km）,\n        "online": 布尔值,\n        "status": "字符串",\n        "bio": "多行字符串",\n        "publicPersonality": ["关键词"],\n        "realPersonality": ["关键词"],\n        "appearance": ["关键词"],\n        "tags": ["字符串"],\n        "followers": 整数,\n        "likes": 整数,\n        "avgRating": 小数,\n        "reviews": []\n      },\n      "content": "字符串（10-30字兴趣表达）"\n    },\n    {\n      "type": "message",\n      "fromUser": {\n        "nickname": "字符串",\n        "handle": "字符串",\n        "avatarBubble": "emoji",\n        "gender": "male/female/unisex",\n        "distance": 小数（5-50km）,\n        "online": 布尔值,\n        "status": "字符串",\n        "bio": "多行字符串",\n        "publicPersonality": ["关键词"],\n        "realPersonality": ["关键词"],\n        "appearance": ["关键词"],\n        "tags": ["字符串"],\n        "followers": 整数,\n        "likes": 整数,\n        "avgRating": 小数,\n        "reviews": []\n      },\n      "messages": ["字符串1（第1条私信）", "字符串2（第2条私信，可选）", "字符串3（第3条私信，可选）"]\n    }\n  ],\n  "newspaper": {\n    "weather": { "icon": "☀", "temp": "18°C", "desc": "TODAY · SUNNY" },\n    "news": [ { "headline": "...", "location": "...", "time": "...", "body": "...", "comment": "..." } ],\n    "bubble": "✧ ...",\n    "submissions": [ { "tag": "MISSING", "title": "...", "content": "..." } ],\n    "ads": [ { "title": "...", "text": "..." } ]\n  }\n}\n```\n\n关键规则：\n1. online字段必须是布尔值(true/false)，不能用字符串\n2. gender必须是 "male"、"female" 或 "unisex" 之一\n3. 所有数字必须是纯数字，不带引号';let n=4;e||(S+=`\n${n}. **landmarks不需要生成x、y坐标**（系统自动分配）`,n++),!e&&A&&(S+=`\n${n}. **newspaper字段是必须的**，包含结构化的报纸数据对象（非HTML字符串），包含weather/news/bubble/submissions/ads字段`,n++),S+=`\n${n}. **nearbyUsers不需要生成avatar、id、position**（系统自动处理）\n${n+1}. 可选字段不使用时完全省略，不要设为null\n${n+2}. **bio字段必须使用\\n分隔多行**，第一行格式："年龄 | 感情状态"，例如："24岁 | 单身\\n热爱旅行和摄影\\n周末常去咖啡馆"\n${n+3}. **handle字段必须符合Instagram用户名规范**：纯英文小写+数字+下划线，5-15个字符，例如："lihua_dev"、"xiaoming2024"\n${n+4}. **avatarBubble字段必须是单个emoji或1-2个颜文字**，表达个性或心情\n${n+5}. **followers和likes必须是合理的数字**：followers为100-50000，likes为followers的10-50倍\n${n+6}. **avgRating可选字段**：0-5小数（保留1位），0表示无评价，有评价时范围3.0-5.0\n${n+7}. **reviews可选字段**：数组长度0-8，评价内容应真实反映约会体验（赞美、警告、投诉等）\n${n+8}. **reviews不需要生成reviewerAvatar字段**（系统自动从头像库随机分配）\n${n+9}. **isAnonymous约30%概率为true**，匿名时reviewerName应为"匿名用户"\n${n+10}. **timestamp应在最近1-30天内**，格式："2024-01-15T10:30:00Z"\n${n+11}. **publicPersonality必填**：数组，10-15个关键词，描述网络上表现出来的性格（可以是正面的、积极的）\n${n+12}. **realPersonality必填**：数组，10-15个关键词，描述真实内在性格（可以是负面的、复杂的、矛盾的）\n${n+13}. **publicPersonality和realPersonality可以相同**（表里如一）或完全不同（双面性），要真实反映人性多面性\n${n+14}. **appearance必填**：数组，10-15个关键词，描述外貌身材特征（发色、眼睛、身高体重、三围、配饰、体型、脸型、五官等）\n${n+15}. **notifications可选字段**：30-50%概率生成0-3条提醒，50-70%概率返回空数组[]\n${n+16}. **notifications中的fromUser**是完整的用户对象，必须包含所有字段（nickname, handle, avatarBubble, gender, distance, online, status, bio, publicPersonality, realPersonality, appearance, tags, followers, likes, avgRating, reviews），distance可以较大（5-50km），可以来自其他城市/国家，不需要生成avatar/id/position字段\n${n+17}. **notifications不需要生成id、timestamp、isRead字段**（系统自动生成）\n${n+18}. **notifications的type字段**必须是"interested"或"message"之一\n${n+19}. **interested类型**：必须有content字段（10-30字兴趣表达），不需要messages字段\n${n+20}. **message类型**：必须有messages数组字段（1-3条私信内容），不需要content字段\n${n+21}. **messages数组**：message类型专用，包含1-3个字符串，每个字符串15-50字，代表对方发送的私信\n${n+22}. **secret可选字段**：30-40%概率生成，描述用户隐藏的秘密，增加人设多样性和戏剧性\n   - 生成概率：30-40%的用户有秘密，60-70%没有\n   - 秘密类型示例（但不限于此）：\n     * 感情状态造假："简介写单身，实际已婚有娃"、"说在恋爱中，实际刚分手"\n     * 性别造假："资料显示男生，实际是女生"、"头像是女生，实际是男生"\n     * 年龄造假："实际年龄比简介大10岁"、"未成年人假装成年"\n     * 职业造假："说是医生，实际是销售"、"失业却说在创业"\n     * 外貌造假："头像P图严重"、"用的是明星照片"\n     * 身份造假："冒充富二代"、"谎称海归"\n     * 目的不纯："只想约炮不想恋爱"、"骗钱专业户"、"多人交往"\n     * 其他社交场景常见的抓马情况\n   - 格式：简短描述（15-50字），不要写成完整句子，直接描述矛盾点\n   - 示例："说单身实际已婚有两个孩子"、"头像是女生本人是男生"、"年龄造假大了15岁"\n   - 重要：秘密应该戏剧化、有冲突性，能引发故事发展\n   - 如果不生成秘密，完全省略该字段，不要写null或空字符串\n`}const E=S.substring(S.lastIndexOf("【JSON返回格式】"));I=d.logTokenUsage("地图约会生成器","JSON格式要求",E,I);let z="";z=t?o?`请根据以下要求生成地标数据：${o}`:"请根据世界观生成地标数据":e?"请根据世界观、世界书和大事件生成新的附近的人数据":"请根据世界观、世界书和大事件生成完整的地图约会数据";const B=[{role:"user",content:z}];d.logFinalPrompt("地图约会生成器",S,B[0].content),console.log("🚀 [API请求] 开始发送AI请求，请等待响应..."),console.log("  |- 模式: "+(t?"仅生成地标":e?"仅刷新用户":"完整生成")),console.log(`  |- 用户消息: ${z}`),console.log("  |- 温度参数: 0.8");const L=Date.now(),P=await g.sendAIRequest({apiConfig:r,systemPrompt:S,messages:B,temperature:.8}),D=((Date.now()-L)/1e3).toFixed(2);console.log(`✅ [API响应] AI请求完成，耗时 ${D} 秒`),console.log(`  |- 响应长度: ${P?.length||0} 字符`),console.log("🔍 [JSON解析] 开始解析AI返回的JSON数据...");let N=g.parseJSONResponse(P);if(console.log("✅ [JSON解析] JSON解析完成"),N=await g.postProcessData(N,C),!e&&N.newspaper){console.log("🐑 [咩三三报纸] 检测到AI生成的报纸数据（JSON对象），开始保存");try{const n=JSON.stringify(N.newspaper);localStorage.setItem("newspaperCachedData",n),console.log(`✅ [咩三三报纸] 报纸数据已保存到localStorage，长度: ${n.length} 字符`);let e=[];try{const n=localStorage.getItem("newspaperGenerateHistory");n&&(e=JSON.parse(n))}catch(n){console.error("❌ [咩三三报纸] 读取生成历史失败:",n),e=[]}e.push(Date.now()),localStorage.setItem("newspaperGenerateHistory",JSON.stringify(e)),console.log(`✅ [咩三三报纸] 生成历史已更新，当前12小时内生成次数: ${e.length}`)}catch(n){console.error("❌ [咩三三报纸] 保存报纸数据失败:",n)}}else e||console.warn("⚠️ [咩三三报纸] AI未返回报纸数据（newspaper字段缺失）");if(e){if(!N.nearbyUsers)throw new Error("AI返回的数据格式不完整，缺少 nearbyUsers 字段");N.mapConfig=x,N.landmarks=u,N.weather?(console.log(`🌤️ [天气更新] AI决定新天气: ${N.weather}`),w=!0):h?(N.weather=h,console.log(`🌤️ [天气保留] 使用原天气: ${h}`),w=!1):(N.weather=this.getRandomWeather(),console.log(`🌤️ [天气生成] 随机生成天气: ${N.weather}`),w=!0),console.log("✅ [第十五个情景] AI生成新用户数据验证通过，已合并原有地图配置和地标")}else{if(t){if(!N.landmarks||!Array.isArray(N.landmarks))throw new Error("AI返回的数据格式不完整，缺少 landmarks 字段或格式错误");console.log(`✅ [第十五个情景] AI生成了 ${N.landmarks.length} 个地标`),N.landmarks.forEach(n=>{n.x=Math.floor(1800*Math.random())+100,n.y=Math.floor(1800*Math.random())+100}),this.customLandmarks.push(...N.landmarks);const e=n.currentAccountId||"main";return localStorage.setItem(`xMapCustomLandmarks_${e}`,JSON.stringify(this.customLandmarks)),void console.log(`📍 [地标管理] 成功生成并保存了 ${N.landmarks.length} 个地标到账户${e}`)}if(!N.mapConfig||!N.landmarks||!N.nearbyUsers)throw new Error("AI返回的数据格式不完整，缺少必要字段");console.log("✅ [第十五个情景] AI生成数据验证通过"),N.landmarks&&N.landmarks.forEach(n=>{n.x=Math.floor(1800*Math.random())+100,n.y=Math.floor(1800*Math.random())+100}),w=!0,console.log("🌤️ [完整生成] 标记天气为已刷新（将在后续生成或使用随机天气）")}if(N.nearbyUsers&&N.nearbyUsers.forEach((n,e)=>{const t=n.gender||"unisex";n.avatar=this.getRandomAvatar(t),n.id=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}_${e}`;const o=n.distance||1,a=Math.min(o/6,1),i=2*Math.random()*Math.PI,r=15+25*a,s=50+r*Math.cos(i),l=50+r*Math.sin(i);n.position={top:`${Math.max(10,Math.min(90,l)).toFixed(1)}%`,left:`${Math.max(10,Math.min(90,s)).toFixed(1)}%`},n.reviews&&Array.isArray(n.reviews)&&n.reviews.forEach(n=>{const e=["male","female","unisex"][Math.floor(3*Math.random())];n.reviewerAvatar=this.getRandomAvatar(e)})}),N.notifications&&Array.isArray(N.notifications)){console.log(`🔔 [提醒处理] 开始处理 ${N.notifications.length} 条提醒`),N.notifications.forEach((n,e)=>{if(n.fromUser){const t=n.fromUser,o=t.gender||"unisex";t.avatar=this.getRandomAvatar(o),t.id=`notif_user_${Date.now()}_${Math.random().toString(36).substr(2,9)}_${e}`;const a=t.distance||3,i=20,r=Math.min(a/i,1),s=2*Math.random()*Math.PI,l=15+25*r,c=50,d=50+l*Math.cos(s),p=c+l*Math.sin(s);t.position={top:`${Math.max(10,Math.min(90,p)).toFixed(1)}%`,left:`${Math.max(10,Math.min(90,d)).toFixed(1)}%`},t.reviews&&Array.isArray(t.reviews)&&t.reviews.forEach(n=>{const e=["male","female","unisex"][Math.floor(3*Math.random())];n.reviewerAvatar=this.getRandomAvatar(e)})}n.id=`notif-${Date.now()}-${Math.random().toString(36).substr(2,9)}-${e}`,n.timestamp=(new Date).toISOString(),n.isRead=!1});try{localStorage.setItem("xMapNotifications",JSON.stringify(N.notifications)),console.log(`✅ [提醒处理] ${N.notifications.length} 条提醒已保存到localStorage`),this.updateNotificationBadge(),console.log("✅ [提醒处理] 提醒徽章已更新")}catch(n){console.error("❌ [提醒处理] 保存提醒到localStorage失败:",n)}}else console.log("🔔 [提醒处理] 本次生成无提醒数据"),N.notifications=[];N.weather=k;const R=`mapDatingData_${vt||"main"}`;if(e){console.log("💾 [数据库保存] 开始保存刷新后的用户数据到数据库...");const n=await i.xMapDatingData.get(R);let e=n?.lastWeatherRefreshTime||null;w&&(e=(new Date).toISOString(),console.log(`🌤️ [天气刷新] 更新天气刷新时间: ${new Date(e).toLocaleString("zh-CN")}`)),await i.xMapDatingData.put({id:R,accountId:vt||"main",data:N,lastGenerated:n?.lastGenerated||(new Date).toISOString(),lastUpdated:(new Date).toISOString(),firstMapEnterTime:n?.firstMapEnterTime||v||(new Date).toISOString(),lastWeatherRefreshTime:e}),console.log("✅✅ [数据库保存] 附近的人刷新完成并已保存到数据库"),console.log(`  |- 数据ID: ${R}`),console.log(`  |- 天气类型: ${$.icon} ${$.name} (保持不变)`),console.log(`  |- 附近的人: ${N.nearbyUsers.length} 人 (已更新)`),console.log(`  |- 保存时间: ${(new Date).toLocaleString()}`)}else{console.log("💾 [数据库保存] 开始保存完整地图数据到数据库...");const n=(new Date).toISOString();await i.xMapDatingData.put({id:R,accountId:vt||"main",data:N,lastGenerated:n,lastUpdated:n,firstMapEnterTime:n,lastWeatherRefreshTime:n}),console.log("✅✅ [数据库保存] 地图约会数据生成完成并已保存到数据库"),console.log(`  |- 数据ID: ${R}`),console.log(`  |- 地图配置: ${JSON.stringify(N.mapConfig)}`),console.log(`  |- 天气类型: ${$.icon} ${$.name}`),console.log(`  |- 地标数量: ${N.landmarks.length}`),console.log(`  |- 附近的人: ${N.nearbyUsers.length} 人`),console.log(`  |- 保存时间: ${(new Date).toLocaleString()}`)}return console.log("🎉 [生成器返回] generateMapDatingData 即将返回数据给调用方"),N}catch(n){return console.error("❌ [第十五个情景] 地图约会数据生成失败:",n),null}},async init(){try{console.log("🔧 [地图约会] 初始化开始..."),this.loadCustomAvatars(),this.initLandmarkManagement(),this.initAuthenticityScore(),this.initReportedCountSystem();const n=this.checkMapBanStatus();if(n.isBanned)return console.log("🚫 [封禁系统] 用户被封禁，显示提示并阻止使用地图"),void this.showMapBanNotice(n);const t=e();console.log("🔧 [地图约会] xDb状态:",t?"已获取":"获取失败");let o=null;if(t){const n=`mapDatingData_${vt||"main"}`;console.log("🔧 [地图约会] 尝试读取数据，ID:",n);const e=await t.xMapDatingData.get(n);console.log("🔧 [地图约会] 数据库查询结果:",e?"找到数据":"未找到数据"),e&&e.data?(console.log("📖 [第十五个情景] 从数据库加载已保存的地图约会数据"),console.log(`  |- 地标数量: ${e.data.landmarks?.length||0}`),console.log(`  |- 附近的人: ${e.data.nearbyUsers?.length||0}`),o=e.data):(console.log("🆕 [第十五个情景] 首次使用，调用AI生成数据"),o=await this.generateMapDatingData(),console.log("🔧 [地图约会] AI生成返回结果:",o?"成功":"失败"))}else console.warn("⚠️ [地图约会] 无法获取数据库，跳过AI生成");if(o?(console.log("🔧 [地图约会] 开始应用AI生成的数据..."),o.nearbyUsers&&o.nearbyUsers.length>0?(this.allUsers=o.nearbyUsers,this.currentUsers=[...o.nearbyUsers],console.log(`✅ [地图约会] 已设置附近的人: ${o.nearbyUsers.length}人`)):(this.allUsers=[...this.mockUsers],this.currentUsers=[...this.mockUsers],console.log("⚠️ [地图约会] AI数据中没有附近的人，使用默认数据")),o.mapConfig&&(Is.config={...Is.config,...o.mapConfig},console.log("✅ [地图约会] 已设置地图配置:",JSON.stringify(o.mapConfig))),o.landmarks&&o.landmarks.length>0?(this.aiLandmarks=o.landmarks,Is.landmarks=o.landmarks,console.log(`✅ [地图约会] 已设置AI地标数据: ${o.landmarks.length}个`),console.log("🔧 [地图约会] MapGenerator.landmarks前5个:",Is.landmarks.slice(0,5).map(n=>n.name))):(console.log("⚠️ [地图约会] AI数据中没有地标，将使用默认随机生成"),this.aiLandmarks=[])):(console.log("⚠️ [地图约会] mapData为null，使用默认数据"),this.allUsers=[...this.mockUsers],this.currentUsers=[...this.mockUsers]),this.renderUserList(),this.renderMapMarkers(),Is.landmarks=[...this.aiLandmarks,...this.customLandmarks],console.log("📍 [地图约会] 合并地标到MapGenerator:",{"AI地标":this.aiLandmarks.length,"自定义地标":this.customLandmarks.length,"总计":Is.landmarks.length}),Is.init("mapCanvasBg"),this.renderLandmarkLabels(),this.initEventListeners(),this.updateNotificationBadge(),console.log("✅ [地图约会] 提醒徽章已初始化"),this.initThemeSettings(),console.log("✅ [地图约会] 主题设置已初始化"),this.initMapDrag(),this.initMapPosition(),o&&o.weather)this.renderWeatherEffect(o.weather),console.log(`🌤️ [地图约会] 应用已保存的天气: ${o.weather}`);else{const n=this.getRandomWeather();this.renderWeatherEffect(n),console.log(`🌤️ [地图约会] 随机生成天气: ${n}`)}setTimeout(()=>{const n=document.getElementById("mapSwipeHint");n&&n.classList.add("hidden")},3e3),this.initRideMode(),this.initWaitingDriver(),await this.initUserMapProfile()}catch(n){console.error("❌ [地图约会] 初始化失败:",n),this.allUsers=[...this.mockUsers],this.currentUsers=[...this.mockUsers],this.renderUserList(),this.renderMapMarkers(),Is.init("mapCanvasBg"),this.aiLandmarks=Is.landmarks||[],Is.landmarks=[...this.aiLandmarks,...this.customLandmarks],console.log("✅ [地图约会] 已合并地标:",{"默认地标":this.aiLandmarks.length,"自定义地标":this.customLandmarks.length,"总计":Is.landmarks.length}),Is.ctx&&Is.drawLandmarks(),this.renderLandmarkLabels(),this.initEventListeners(),this.initThemeSettings(),this.initRideMode(),this.initWaitingDriver(),this.initMapDrag(),this.initMapPosition();const e=this.getRandomWeather();this.renderWeatherEffect(e)}},initEventListeners(){document.getElementById("mapSidebarOverlay")?.addEventListener("click",()=>this.closeSidebar()),document.getElementById("mapBackBtn")?.addEventListener("click",()=>this.closeSidebar()),document.getElementById("mapCloseBtn")?.addEventListener("click",()=>this.closeMapPage()),document.getElementById("mapRefreshBtn")?.addEventListener("click",()=>this.refreshNearbyUsers()),document.getElementById("mapNewspaperBtn")?.addEventListener("click",()=>this.openNewspaper()),document.getElementById("newspaperCloseBtn")?.addEventListener("click",()=>this.closeNewspaper()),document.getElementById("newspaperOverlay")?.addEventListener("click",()=>this.closeNewspaper()),document.getElementById("mapRideBtn")?.addEventListener("click",()=>this.openRidePanel()),document.getElementById("ridePanelOverlay")?.addEventListener("click",()=>this.closeRidePanel()),document.getElementById("rideDestinationBox")?.addEventListener("click",()=>this.startSelectingDestination());document.querySelectorAll(".ride-vehicle-card").forEach(n=>{n.addEventListener("click",()=>this.selectVehicle(n))});document.querySelectorAll(".ride-payment-option").forEach(n=>{n.addEventListener("click",()=>this.selectPaymentOption(n))}),document.getElementById("rideBookBtn")?.addEventListener("click",()=>this.bookRide()),document.getElementById("mapSearchInput")?.addEventListener("input",n=>this.filterUsers(n.target.value)),document.getElementById("mapDistanceFilter")?.addEventListener("change",n=>this.filterByDistance(n.target.value)),document.getElementById("mapGenderFilter")?.addEventListener("change",n=>this.filterByGender(n.target.value)),document.getElementById("mapApplyFilterBtn")?.addEventListener("click",()=>this.applyFilters()),document.getElementById("mapAdvancedFilterBtn")?.addEventListener("click",()=>this.openAdvancedFilterModal()),document.getElementById("mapAdvancedFilterCloseBtn")?.addEventListener("click",()=>this.closeAdvancedFilterModal()),document.getElementById("mapAdvancedFilterOverlay")?.addEventListener("click",()=>this.closeAdvancedFilterModal()),document.getElementById("mapAdvancedFilterCancelBtn")?.addEventListener("click",()=>this.closeAdvancedFilterModal()),document.getElementById("mapAdvancedFilterClearBtn")?.addEventListener("click",()=>this.clearAdvancedFilter()),document.getElementById("mapAdvancedFilterApplyBtn")?.addEventListener("click",()=>this.applyAdvancedFilter()),document.getElementById("mapCenterBtn")?.addEventListener("click",()=>this.centerMap()),document.getElementById("mapZoomInBtn")?.addEventListener("click",()=>this.zoomIn()),document.getElementById("mapZoomOutBtn")?.addEventListener("click",()=>this.zoomOut()),document.getElementById("mapCardCloseBtn")?.addEventListener("click",()=>this.closeDetailCard()),document.getElementById("mapSendMsgBtn")?.addEventListener("click",()=>this.sendMessage()),document.getElementById("mapSocialCircleBtn")?.addEventListener("click",()=>this.showSocialCircle()),document.getElementById("mapViewProfileBtn")?.addEventListener("click",()=>this.viewProfile()),document.getElementById("mapViewMomentsBtn")?.addEventListener("click",()=>this.openMomentsModal()),document.getElementById("mapMomentsCloseBtn")?.addEventListener("click",()=>this.closeMomentsModal()),document.getElementById("mapMomentsCommentsClose")?.addEventListener("click",()=>this.closeMomentsCommentsDrawer()),document.getElementById("mapMomentsCommentsOverlay")?.addEventListener("click",()=>this.closeMomentsCommentsDrawer()),document.addEventListener("click",n=>{const e=document.getElementById("mapProfileDropdownMenu"),t=document.getElementById("mapViewProfileBtn");!e||e.contains(n.target)||t?.contains(n.target)||this.closeProfileDropdown()}),document.getElementById("mapSocialCircleBackBtn")?.addEventListener("click",()=>this.hideSocialCircle()),document.getElementById("mapCardReviewsBtn")?.addEventListener("click",()=>this.toggleReviewsView()),document.getElementById("mapReviewsBackBtn")?.addEventListener("click",()=>this.toggleReviewsView()),document.getElementById("mapCardSettingsBtn")?.addEventListener("click",()=>this.openMapSettings()),document.getElementById("mapSettingsBackBtn")?.addEventListener("click",()=>this.closeMapSettings()),document.getElementById("mapSettingsSaveBtn")?.addEventListener("click",()=>this.saveMapSettings()),document.getElementById("mapSettingsAddTagBtn")?.addEventListener("click",()=>this.addNewTag()),document.getElementById("mapWeatherTestBtn")?.addEventListener("click",()=>this.cycleWeatherTest()),document.getElementById("mapChatOverlay")?.addEventListener("click",()=>this.closeChatModal()),document.getElementById("mapChatBackBtn")?.addEventListener("click",()=>this.closeChatModal()),document.getElementById("mapChatUserAvatar")?.addEventListener("click",()=>{this.currentChatUser&&(console.log(`👆 [聊天] 点击头像查看 ${this.currentChatUser.nickname} 的资料`),this.showUserProfile(this.currentChatUser))}),document.getElementById("mapChatInput")?.addEventListener("keypress",n=>{"Enter"!==n.key||n.shiftKey||(n.preventDefault(),this.sendChatMessage())}),document.getElementById("mapChatLikeBtn")?.addEventListener("click",()=>this.triggerAIResponse()),document.getElementById("mapChatAddBtn")?.addEventListener("click",()=>{this.toggleFunctionMenu()}),document.getElementById("mapChatMoreBtn")?.addEventListener("click",()=>{this.toggleMoreMenu()}),document.getElementById("mapChatAddToListBtn")?.addEventListener("click",()=>{this.addCurrentChatToList()}),document.getElementById("mapChatsBtn")?.addEventListener("click",()=>{this.openChatsListModal()}),document.getElementById("mapChatsListCloseBtn")?.addEventListener("click",()=>{this.closeChatsListModal()}),document.getElementById("mapChatsListOverlay")?.addEventListener("click",()=>{this.closeChatsListModal()}),document.getElementById("mapChatNotesBtn")?.addEventListener("click",()=>{this.openNotesModal()}),document.getElementById("mapNotesCloseBtn")?.addEventListener("click",()=>{this.closeNotesModal()}),document.getElementById("mapNotesOverlay")?.addEventListener("click",()=>{this.closeNotesModal()}),document.getElementById("mapNotificationsBtn")?.addEventListener("click",()=>{this.openNotificationsModal()}),document.getElementById("mapNotificationsCloseBtn")?.addEventListener("click",()=>{this.closeNotificationsModal()}),document.getElementById("mapNotificationsOverlay")?.addEventListener("click",()=>{this.closeNotificationsModal()});const n=document.querySelectorAll(".map-notifications-tab");n.forEach(e=>{e.addEventListener("click",()=>{n.forEach(n=>n.classList.remove("active")),e.classList.add("active");const t=e.getAttribute("data-filter");this.filterNotifications(t)})}),document.getElementById("mapAppSettingsBtn")?.addEventListener("click",()=>{this.openAppSettingsModal()}),document.getElementById("mapAppSettingsCloseBtn")?.addEventListener("click",()=>{this.closeAppSettingsModal()}),document.getElementById("mapAppSettingsOverlay")?.addEventListener("click",()=>{this.closeAppSettingsModal()}),document.getElementById("mapThemeToggle")?.addEventListener("click",()=>{this.toggleTheme()}),document.getElementById("mapAvatarAddBtn")?.addEventListener("click",()=>{const n=document.getElementById("mapAvatarUrlInput"),e=document.querySelector('input[name="avatarCategory"]:checked');n&&e&&this.addCustomAvatar(n.value,e.value)}),document.getElementById("mapChatReportBtn")?.addEventListener("click",()=>{this.openReportModal()}),document.getElementById("mapReportCloseBtn")?.addEventListener("click",()=>{this.closeReportModal()}),document.getElementById("mapChatManageBtn")?.addEventListener("click",()=>{this.enterDeleteMode()}),document.getElementById("mapChatDeleteSelectAll")?.addEventListener("change",n=>{this.toggleSelectAllMessages(n.target.checked)}),document.getElementById("mapChatDeleteSelected")?.addEventListener("click",()=>{this.deleteSelectedMessages()}),document.getElementById("mapChatClearAll")?.addEventListener("click",()=>{this.clearAllChatData()}),document.getElementById("mapChatDeleteExit")?.addEventListener("click",()=>{this.exitDeleteMode()}),document.getElementById("mapReportOverlay")?.addEventListener("click",()=>{this.closeReportModal()}),document.getElementById("mapReportCancelBtn")?.addEventListener("click",()=>{this.closeReportModal()}),document.getElementById("mapReportSubmitBtn")?.addEventListener("click",()=>{this.submitReport()}),document.getElementById("mapReportDetailCloseBtn")?.addEventListener("click",()=>{this.closeReportDetailModal()}),document.getElementById("mapReportDetailOverlay")?.addEventListener("click",()=>{this.closeReportDetailModal()}),document.getElementById("mapReportDetailAcknowledgeBtn")?.addEventListener("click",()=>{this.handleReportAcknowledge()}),document.getElementById("mapAcceptMessageBtn")?.addEventListener("click",()=>{this.acceptMessage()}),document.getElementById("mapDeclineMessageBtn")?.addEventListener("click",()=>{this.declineMessage()}),document.getElementById("mapAcceptMessageOverlay")?.addEventListener("click",()=>{this.declineMessage()}),this.initTouchGestures()},initTouchGestures(){const n=document.getElementById("mapArea");n&&(n.addEventListener("touchstart",n=>{this.touchStartX=n.touches[0].clientX,this.touchStartY=n.touches[0].clientY},{passive:!0}),n.addEventListener("touchmove",n=>{this.touchEndX=n.touches[0].clientX,this.touchEndY=n.touches[0].clientY},{passive:!0}),n.addEventListener("touchend",()=>{this.handleSwipeGesture()}))},handleSwipeGesture(){const n=this.touchEndX-this.touchStartX,e=this.touchEndY-this.touchStartY;Math.abs(n)>Math.abs(e)&&(n>50&&this.touchStartX<50&&!this.isSidebarOpen?this.openSidebar():n<-50&&this.isSidebarOpen&&this.closeSidebar())},initMapPosition(){const n=document.getElementById("mapArea");if(!n)return;const e=n.offsetWidth,t=n.offsetHeight;this.mapState.translateX=-(e*this.MAP_SIZE_MULTIPLIER-e)/2,this.mapState.translateY=-(t*this.MAP_SIZE_MULTIPLIER-t)/2,this.updateMapTransform()},initMapDrag(){const n=document.getElementById("mapCanvas");if(!n)return;const e=n=>{this.mapState.isDragging=!0,this.mapState.startX=n.clientX||n.pageX,this.mapState.startY=n.clientY||n.pageY,this.mapState.lastTranslateX=this.mapState.translateX,this.mapState.lastTranslateY=this.mapState.translateY},t=n=>{if(!this.mapState.isDragging)return;const e=n.clientX||n.pageX,t=n.clientY||n.pageY,o=e-this.mapState.startX,a=t-this.mapState.startY;let i=this.mapState.lastTranslateX+o,r=this.mapState.lastTranslateY+a;const s=this.getMapBounds();i=Math.min(s.maxX,Math.max(s.minX,i)),r=Math.min(s.maxY,Math.max(s.minY,r)),this.mapState.translateX=i,this.mapState.translateY=r,this.updateMapTransform()},o=()=>{this.mapState.isDragging=!1};n.addEventListener("mousedown",e),n.addEventListener("touchstart",n=>{1===n.touches.length?e(n.touches[0]):2===n.touches.length&&(this.mapState.initialDistance=this.getDistance(n.touches[0],n.touches[1]),this.mapState.initialScale=this.mapState.scale)},{passive:!0}),n.addEventListener("mousemove",t),n.addEventListener("touchmove",n=>{if(1===n.touches.length&&this.mapState.isDragging)n.preventDefault(),t(n.touches[0]);else if(2===n.touches.length){n.preventDefault();const e=this.getDistance(n.touches[0],n.touches[1])/this.mapState.initialDistance;this.mapState.scale=Math.min(Math.max(this.mapState.initialScale*e,this.MIN_ZOOM),this.MAX_ZOOM),this.clampMapPosition(),this.updateMapTransform()}},{passive:!1}),n.addEventListener("mouseup",o),n.addEventListener("mouseleave",o),n.addEventListener("touchend",o)},getDistance(n,e){const t=n.clientX-e.clientX,o=n.clientY-e.clientY;return Math.sqrt(t*t+o*o)},getMapBounds(){const n=document.getElementById("mapArea");if(!n)return{maxX:0,minX:0,maxY:0,minY:0};const e=n.offsetWidth,t=n.offsetHeight;return{maxX:0,minX:e-e*this.MAP_SIZE_MULTIPLIER*this.mapState.scale,maxY:0,minY:t-t*this.MAP_SIZE_MULTIPLIER*this.mapState.scale}},clampMapPosition(){const n=this.getMapBounds();this.mapState.translateX=Math.min(n.maxX,Math.max(n.minX,this.mapState.translateX)),this.mapState.translateY=Math.min(n.maxY,Math.max(n.minY,this.mapState.translateY))},updateMapTransform(){const n=document.getElementById("mapCanvas");if(!n)return;n.style.transform=`translate(${this.mapState.translateX}px, ${this.mapState.translateY}px) scale(${this.mapState.scale})`;document.querySelectorAll(".map-marker").forEach((n,e)=>{const t=Math.max(.8,1/this.mapState.scale),o=n.getAttribute("data-base-transform")||"scale(1)";n.style.transform=`${o} scale(${t})`,this.mapState.scale<.7?n.style.opacity="1":this.mapState.scale>1.5?n.style.opacity=e%2==0?"1":"0.4":n.style.opacity="1"});const e=document.querySelectorAll(".marker-status-bubble");e.forEach(n=>{this.mapState.scale>=1.3?n.classList.add("visible"):n.classList.remove("visible")}),this.updateLandmarkLabelsVisibility()},updateLandmarkLabelsVisibility(){const n=document.querySelectorAll(".landmark-label");n.forEach((n,e)=>{this.mapState.scale>=1.2?setTimeout(()=>{n.classList.add("visible")},15*e):n.classList.remove("visible")})},openSidebar(){document.getElementById("mapSidebar")?.classList.add("show"),document.getElementById("mapSidebarOverlay")?.classList.add("show"),this.isSidebarOpen=!0;const n=document.getElementById("mapSwipeHint");n&&n.classList.add("hidden")},closeSidebar(){document.getElementById("mapSidebar")?.classList.remove("show"),document.getElementById("mapSidebarOverlay")?.classList.remove("show"),this.isSidebarOpen=!1},toggleSidebar(){this.isSidebarOpen?this.closeSidebar():this.openSidebar()},async openNewspaper(){console.log("🐑 [咩三三报纸] 打开报纸弹窗"),document.getElementById("newspaperOverlay")?.classList.add("show"),document.getElementById("newspaperModal")?.classList.add("show"),this.updateNewspaperClock(),this.updateNewspaperStats(),await this.generateNewspaper()},closeNewspaper(){console.log("🐑 [咩三三报纸] 关闭报纸弹窗"),document.getElementById("newspaperOverlay")?.classList.remove("show"),document.getElementById("newspaperModal")?.classList.remove("show")},updateNewspaperClock(){const n=()=>{const n=new Date,e=n.toISOString().split("T")[0],t=n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),o=document.getElementById("newspaperClockDate"),a=document.getElementById("newspaperClockTime");o&&(o.textContent=e),a&&(a.textContent=t)};n(),this.newspaperClockInterval&&clearInterval(this.newspaperClockInterval),this.newspaperClockInterval=setInterval(n,6e4)},updateNewspaperStats(){console.log("📊 [咩三三报纸] 更新统计数据");let n=JSON.parse(localStorage.getItem("newspaperStats")||'{"views": 0, "tips": 0}');n.views+=1,Math.random()<.2&&(n.tips+=Math.floor(3*Math.random())+1),localStorage.setItem("newspaperStats",JSON.stringify(n));const e=document.getElementById("newspaperViewsCount"),t=document.getElementById("newspaperTipsCount");e&&(e.textContent=n.views.toLocaleString()),t&&(t.textContent=n.tips.toLocaleString()),console.log(`📊 [咩三三报纸] 统计更新完成 - Views: ${n.views}, Tips: ${n.tips}`)},renderNewspaperHTML(n){let e="";return n.weather&&(e+=`\n          <div class="newspaper-weather-card">\n            <div class="newspaper-weather-icon-big">${n.weather.icon||"☀"}</div>\n            <div class="newspaper-weather-temp-big">${n.weather.temp||"18°C"}</div>\n            <div class="newspaper-weather-desc-big">${n.weather.desc||"TODAY · SUNNY"}</div>\n          </div>\n        `),n.news&&Array.isArray(n.news)&&n.news.forEach(n=>{e+=`\n            <div class="newspaper-news-card">\n              <div class="newspaper-breaking-badge">BREAKING</div>\n              <h2 class="newspaper-news-headline">${n.headline||"无标题"}</h2>\n              <div class="newspaper-news-meta">\n                <span>📍 ${n.location||"UNKNOWN"}</span>\n                <span>•</span>\n                <span>${n.time||"RECENTLY"}</span>\n                <span>•</span>\n                <span>BY MIE333</span>\n              </div>\n              <div class="newspaper-news-body">\n                ${n.body||""}\n              </div>\n              ${n.comment?`<div class="newspaper-emoticon-comment">${n.comment}</div>`:""}\n            </div>\n          `}),n.bubble&&(e+=`\n          <div class="newspaper-speech-bubble">\n            ${n.bubble}\n          </div>\n        `),n.submissions&&Array.isArray(n.submissions)&&n.submissions.length>0&&(e+='<div style="margin-top: 12px;"><div class="newspaper-widget-title" style="margin-bottom: 8px;">群众投稿</div>',n.submissions.forEach(n=>{e+=`\n            <div class="newspaper-submission-sticky">\n              <span class="newspaper-sticky-tag">${n.tag||"INFO"}</span>\n              <div class="newspaper-sticky-title">${n.title||"无标题"}</div>\n              <div class="newspaper-sticky-content">${n.content||""}</div>\n            </div>\n          `}),e+="</div>"),n.ads&&Array.isArray(n.ads)&&n.ads.forEach(n=>{e+=`\n            <div class="newspaper-ad-banner-special">\n              <div class="newspaper-ad-corner">AD</div>\n              <div class="newspaper-ad-title">${n.title||"广告"}</div>\n              <div class="newspaper-ad-text">${n.text||""}</div>\n            </div>\n          `}),e+='\n        <div class="newspaper-contact-pixel">\n          <div class="newspaper-contact-line">> EMAIL: mie333@city-news.com</div>\n          <div class="newspaper-contact-line">> TIPS: tips@mie333.com</div>\n          <div class="newspaper-contact-line">> AD: ad@mie333.com</div>\n        </div>\n      ',e+='\n        <div class="newspaper-footer-sig">\n          "咩三三我虽然利己主义，但报道绝对真实。( •̀ ω •́ )✧"<br>\n          — MIE333 CITY NEWS · DAILY UPDATE —\n        </div>\n      ',e},async generateNewspaper(){const n=document.getElementById("newspaperMainContent");if(n){n.innerHTML='<div style="padding: 40px; text-align: center; color: var(--map-text-secondary);">🐑 咩三三正在撰写报纸...</div>';try{console.log("🐑 [咩三三报纸] 开始加载报纸内容");const e=localStorage.getItem("newspaperCachedData");let t=null;if(e)try{t=JSON.parse(e),console.log("📰 [咩三三报纸] 成功读取AI生成的报纸数据")}catch(n){console.error("❌ [咩三三报纸] 解析报纸数据失败:",n)}let o="";t&&t.weather?(console.log("🎨 [咩三三报纸] 使用AI数据渲染HTML"),o=this.renderNewspaperHTML(t)):(console.log("⚠️ [咩三三报纸] 未找到AI数据，使用静态placeholder"),o='\n          \x3c!-- 天气预报 --\x3e\n          <div class="newspaper-weather-card">\n            <div class="newspaper-weather-icon-big">☀</div>\n            <div class="newspaper-weather-temp-big">18°C</div>\n            <div class="newspaper-weather-desc-big">TODAY · SUNNY</div>\n          </div>\n\n          \x3c!-- 重大新闻 --\x3e\n          <div class="newspaper-news-card">\n            <div class="newspaper-breaking-badge">BREAKING</div>\n            <h2 class="newspaper-news-headline">市中心星巴克咖啡盛大开业</h2>\n            <div class="newspaper-news-meta">\n              <span>📍 DOWNTOWN</span>\n              <span>•</span>\n              <span>2H AGO</span>\n              <span>•</span>\n              <span>BY MIE333</span>\n            </div>\n            <div class="newspaper-news-body">\n              咩三三我今天路过市中心商业街，发现那边新开了家星巴克。门口排了好长的队，都是冲着开业优惠去的。\n            </div>\n            <div class="newspaper-emoticon-comment">\n              (￣ー￣) 咩三三觉得这种开业活动就是套路...\n            </div>\n          </div>\n\n          \x3c!-- 对话框 --\x3e\n          <div class="newspaper-speech-bubble">\n            ✧ 咩三三的真实想法：不如去便利店买罐装咖啡实在！\n          </div>\n\n          \x3c!-- 群众投稿 --\x3e\n          <div style="margin-top: 12px;">\n            <div class="newspaper-widget-title" style="margin-bottom: 8px;">群众投稿</div>\n\n            <div class="newspaper-submission-sticky">\n              <span class="newspaper-sticky-tag">MISSING</span>\n              <div class="newspaper-sticky-title">寻找走失的金毛犬</div>\n              <div class="newspaper-sticky-content">昨晚在公园走失，红色项圈，请联系138****5678。重谢！</div>\n            </div>\n\n            <div class="newspaper-submission-sticky">\n              <span class="newspaper-sticky-tag">COMPLAINT</span>\n              <div class="newspaper-sticky-title">楼上邻居深夜扰民</div>\n              <div class="newspaper-sticky-content">301室每晚12点后蹦迪！咩三三：直接找物业。(눈_눈)</div>\n            </div>\n\n            <div class="newspaper-submission-sticky">\n              <span class="newspaper-sticky-tag">STORY</span>\n              <div class="newspaper-sticky-title">地铁上捡到钱包</div>\n              <div class="newspaper-sticky-content">已交给地铁工作人员，失主可去2号线客服中心认领。</div>\n            </div>\n          </div>\n\n          \x3c!-- 广告 --\x3e\n          <div class="newspaper-ad-banner-special">\n            <div class="newspaper-ad-corner">AD</div>\n            <div class="newspaper-ad-title">咩三三的杂货铺</div>\n            <div class="newspaper-ad-text">各种稀奇古怪的小玩意儿都有卖！价格公道童叟无欺。地址：商业街99号 | 营业时间：看心情 (￣y▽￣)╭</div>\n          </div>\n\n          \x3c!-- 联系方式 --\x3e\n          <div class="newspaper-contact-pixel">\n            <div class="newspaper-contact-line">> EMAIL: mie333@city-news.com</div>\n            <div class="newspaper-contact-line">> TIPS: tips@mie333.com</div>\n            <div class="newspaper-contact-line">> AD: ad@mie333.com</div>\n          </div>\n\n          \x3c!-- 底部签名 --\x3e\n          <div class="newspaper-footer-sig">\n            "咩三三我虽然利己主义，但报道绝对真实。( •̀ ω •́ )✧"<br>\n            — MIE333 CITY NEWS · DAILY UPDATE —\n          </div>\n        '),n.innerHTML=o,console.log("✅ [咩三三报纸] 报纸内容加载完成")}catch(e){console.error("❌ [咩三三报纸] 生成失败:",e),n.innerHTML='<div style="padding: 40px; text-align: center; color: var(--map-text-secondary);">报纸生成失败，请稍后重试</div>'}}},renderUserList(){const n=document.getElementById("mapUserList");n&&(n.innerHTML=this.currentUsers.map(n=>{const e=n.bio?n.bio.match(/(\d+)岁/):null,t=e?e[1]:"",o=t?`${n.nickname}, ${t}`:n.nickname;return`\n        <div class="map-user-item ${this.selectedUserId==n.id?"active":""}" data-user-id="${n.id}">\n          <div class="map-user-avatar-container">\n            <img class="map-user-avatar" src="${n.avatar}" alt="${n.nickname}">\n            ${n.online?'<div class="map-online-indicator"></div>':""}\n          </div>\n          <div class="map-user-info">\n            <div class="map-user-name">${o}</div>\n            <div class="map-user-meta">\n              <span class="map-distance">\n                ${us}\n                ${n.distance}km\n              </span>\n              <span>•</span>\n              <span>${n.online?"在线":"离线"}</span>\n            </div>\n          </div>\n          <svg class="map-view-icon" viewBox="0 0 24 24">\n            <g><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></g>\n          </svg>\n        </div>\n      `}).join(""),n.querySelectorAll(".map-user-item").forEach(n=>{n.addEventListener("click",()=>{const e=n.getAttribute("data-user-id");this.selectUser(e)})}))},renderMapMarkers(){const n=document.getElementById("mapCanvas");if(!n)return;n.querySelectorAll(".map-marker").forEach(n=>n.remove()),this.currentUsers.forEach(e=>{const t=document.createElement("div");t.className="map-marker",t.style.top=e.position.top,t.style.left=e.position.left,t.setAttribute("data-base-transform","scale(1)"),t.setAttribute("data-user-id",e.id),t.innerHTML=`\n          <div class="marker-container">\n            ${e.status?`<div class="marker-status-bubble">${e.status}</div>`:""}\n            ${e.online?'<div class="marker-pulse"></div>':""}\n            <img class="marker-avatar" src="${e.avatar}" alt="${e.nickname}">\n          </div>\n        `,t.addEventListener("click",n=>{n.stopPropagation(),this.showDetailCard(e.id)}),n.appendChild(t)}),this.renderCurrentUserMarker()},renderCurrentUserMarker(){const e=document.getElementById("mapCanvas");if(!e)return;const t=e.querySelector(".map-marker.current-user");t&&t.remove();let o="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",a="我",i="";this.userMapProfile&&this.userMapProfile.avatar?(o=this.userMapProfile.avatar,a=this.userMapProfile.nickname||a,i=this.userMapProfile.status||""):n.userProfileData&&(o=n.userProfileData.avatar||o,a=n.userProfileData.name||a);const r=document.getElementById("x-social-screen");let s="#1d9bf0";if(r){const n=getComputedStyle(r).getPropertyValue("--x-accent").trim();n&&(s=n)}const l=document.createElement("div");l.className="map-marker current-user",l.style.top=this.currentUserPosition.top,l.style.left=this.currentUserPosition.left,l.setAttribute("data-base-transform","scale(1)"),l.setAttribute("data-user-id","current-user"),l.innerHTML=`\n        <div class="marker-container">\n          ${i?`<div class="marker-status-bubble">${i}</div>`:""}\n          <div class="marker-pulse"></div>\n          <img class="marker-avatar" src="${o}" alt="${a}" style="border: 3px solid ${s};">\n        </div>\n      `,l.addEventListener("click",n=>{n.stopPropagation(),this.showUserProfileCard()}),e.appendChild(l)},renderLandmarkLabels(){console.log("🏷️ [renderLandmarkLabels] 开始渲染地标标签");const n=document.getElementById("mapCanvas");if(!n)return void console.error("❌ [renderLandmarkLabels] 找不到 mapCanvas 元素");n.querySelectorAll(".landmark-label").forEach(n=>n.remove());const e=Is.landmarks;console.log("🏷️ [renderLandmarkLabels] landmarks数据:",e),e&&0!==e.length?(console.log(`🏷️ [renderLandmarkLabels] 准备渲染 ${e.length} 个地标`),e.forEach(e=>{const t=document.createElement("div");t.className=e.event?"landmark-label has-event visible":"landmark-label visible",t.id=e.id,t.style.left=`${e.x}px`,t.style.top=`${e.y}px`,t.innerHTML=`\n          <span class="landmark-label-icon" style="color: ${e.color}">\n            ${e.icon}\n          </span>\n          <span>${e.name}</span>\n        `,t.addEventListener("click",n=>{if(n.stopPropagation(),this.rideMode&&this.rideSelectingDestination)return console.log(`🚗 [乘车模式] 选择目的地: ${e.name}`),void this.selectRideDestination(e);e.event&&(console.log(`🖱️ [地标点击] 点击了 ${e.name}`,e.event),this.openLandmarkEvent(e))}),n.appendChild(t)}),this.updateLandmarkLabelsVisibility()):console.warn("⚠️ [renderLandmarkLabels] landmarks为空或不存在")},openLandmarkEvent(n){if(!n||!n.event)return;const e=document.getElementById("eventModalOverlay"),t=document.getElementById("eventModalContent"),o=document.getElementById("eventModalCloseBtn");if(e&&t){if(n.event.accentColor){const e=document.getElementById("x-map-container");if(e){e.style.setProperty("--event-accent",n.event.accentColor);const t=this.shadeColor(n.event.accentColor,-20);e.style.setProperty("--event-accent-hover",t)}}t.innerHTML=n.event.eventHTML||'<p style="padding: 40px; text-align: center;">暂无事件内容</p>',e.classList.add("active"),o.dataset.bound||(o.addEventListener("click",()=>this.closeLandmarkEvent()),o.dataset.bound="true"),e.dataset.bound||(e.addEventListener("click",n=>{n.target===e&&this.closeLandmarkEvent()}),e.dataset.bound="true")}},closeLandmarkEvent(){const n=document.getElementById("eventModalOverlay");n&&n.classList.remove("active"),console.log("✅ [地标事件] 弹窗已关闭")},shadeColor(n,e){const t=parseInt(n.replace("#",""),16),o=Math.round(2.55*e),a=(t>>16)+o,i=(t>>8&255)+o,r=(255&t)+o;return"#"+(16777216+65536*(a<255?a<1?0:a:255)+256*(i<255?i<1?0:i:255)+(r<255?r<1?0:r:255)).toString(16).slice(1)},selectUser(n){this.selectedUserId=n,this.renderUserList(),this.showDetailCard(n)},showDetailCard(n,e="map"){let t=this.currentUsers.find(e=>e.id==n);if(t||(t=this.allUsers.find(e=>e.id==n)),!t)return;this.selectedUserId=n,this.detailCardOpenSource=e,console.log(`📇 [资料卡] 打开来源: ${e}`),this.isShowingUserProfile=!1,this.renderUserList();const o=document.getElementById("mapCardAvatar"),a=document.getElementById("mapCardAvatarBubble"),i=document.getElementById("mapCardNickname"),r=document.getElementById("mapCardHandle"),s=document.getElementById("mapCardFollowers"),l=document.getElementById("mapCardLikes"),c=document.getElementById("mapCardBio"),d=document.getElementById("mapCardTags"),p=document.getElementById("mapCardDistance"),g=document.getElementById("mapUserDetailCard");o&&(o.onclick=null),i&&(i.onclick=null),c&&(c.onclick=null),o&&(o.src=t.avatar),a&&(a.textContent=t.avatarBubble||"😊"),i&&(i.textContent=t.nickname),r&&(r.textContent=t.handle.startsWith("@")?t.handle:`@${t.handle}`),s&&(s.textContent=t.followers||0),l&&(l.textContent=t.likes||0),c&&(c.textContent=t.bio),d&&(d.innerHTML=t.tags.map(n=>`<div class="card-tag">${n}</div>`).join("")),p&&(p.textContent=`${t.distance}km`),this.renderReviews(t);const m=document.getElementById("mapCardReviewsSection");m&&m.classList.remove("active"),g&&(g.style.display="block")},closeDetailCard(){const n=document.getElementById("mapUserDetailCard");n&&(n.style.display="none"),this.selectedUserId=null,this.renderUserList();const e=document.getElementById("mapCardReviewsSection");e&&e.classList.remove("active")},renderReviews(n){let e=n.reviews||[];const t=parseFloat(n.avgRating)||0;e.length>0&&(e=e.map(n=>{const e={...n};if(n.reviewer&&!n.reviewerName&&(e.reviewerName=n.reviewer),n.comment&&!n.content&&(e.content=n.comment),e.likes||(e.likes=Math.floor(100*Math.random())),e.comments||(e.comments=Math.floor(20*Math.random())),!e.timestamp){const n=Math.floor(30*Math.random())+1,t=new Date;t.setDate(t.getDate()-n),e.timestamp=t.toISOString()}if(!e.reviewerAvatar){const n=["male","female","unisex"][Math.floor(3*Math.random())];e.reviewerAvatar=this.getRandomAvatar(n)}return e}));const o=document.getElementById("mapReviewsAvgRating"),a=document.getElementById("mapReviewsCount"),i=document.getElementById("mapReviewsStars");if(o&&(o.textContent=t.toFixed(1)),a&&(a.textContent=`${e.length}条评价`),i){const n=Math.floor(t),e=t%1>=.5;let o="";for(let t=0;t<5;t++)o+=t<n?'<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>':t===n&&e?'<svg viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>';i.innerHTML=o}const r=document.getElementById("mapReviewsList");r&&(0!==e.length?r.innerHTML=e.map(n=>`\n        <div class="review-item">\n          <div class="review-header">\n            <img class="review-avatar" src="${n.reviewerAvatar}" alt="${n.reviewerName}">\n            <div class="review-info">\n              <div class="review-name-line">\n                <span class="review-name">${n.reviewerName}</span>\n                <div class="review-rating">\n                  <span class="review-rating-number">${n.rating.toFixed(1)}</span>\n                  <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>\n                </div>\n              </div>\n              <div class="review-time">${this.getTimeAgo(n.timestamp)}</div>\n            </div>\n          </div>\n          <div class="review-content">${n.content}</div>\n          ${n.reply?`\n            <div class="review-reply">\n              <svg class="review-reply-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M3 10h10a5 5 0 0 1 5 5v6M3 10l6 6M3 10l6-6"/>\n              </svg>\n              <div class="review-reply-body">\n                <span class="review-reply-label">作者</span><span class="review-reply-content">${n.reply}</span>\n              </div>\n            </div>\n          `:""}\n          <div class="review-actions">\n            <button class="review-action-btn">\n              <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>\n              <span>${n.likes||0}</span>\n            </button>\n            <button class="review-action-btn">\n              <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>\n              <span>${n.comments||0}</span>\n            </button>\n          </div>\n        </div>\n      `).join(""):r.innerHTML='\n          <div class="reviews-empty">\n            <div class="reviews-empty-icon">💬</div>\n            <div class="reviews-empty-text">还没有人留下评价<br>成为第一个评价的人吧</div>\n          </div>\n        ')},toggleReviewsView(){const n=document.getElementById("mapCardReviewsSection");n&&n.classList.toggle("active")},getTimeAgo(n){if(!n)return"最近";const e=new Date,t=new Date(n),o=Math.floor((e-t)/864e5);return 0===o?"今天":1===o?"昨天":o<7?`${o}天前`:o<30?`${Math.floor(o/7)}周前`:o<365?`${Math.floor(o/30)}个月前`:`${Math.floor(o/365)}年前`},async initUserMapProfile(){try{const t=e(),o=`userMapProfile_${vt||"main"}`;let a=await t.xMapUserProfile.get(o);if(!a&&n.userProfileData){console.log("🔧 [用户地图资料] 首次使用，从X资料同步");const e=n.userProfileData;let i=e.handle||"anonymous";i.startsWith("@")&&(i=i.substring(1)),a={id:o,nickname:e.name||"匿名用户",handle:i,avatar:e.avatar||"",bio:e.bio||"这个人很神秘，什么都没留下",tags:[e.customTag1||"探索中",e.customTag2||"寻找缘分"].filter(n=>n),avatarBubble:"👋",followers:e.followers||0,likes:e.following||0,lastUpdated:(new Date).toISOString()},await t.xMapUserProfile.put(a),console.log("✅ [用户地图资料] 已同步并保存到数据库")}this.userMapProfile=a,console.log("✅ [用户地图资料] 初始化完成",this.userMapProfile)}catch(n){console.error("❌ [用户地图资料] 初始化失败:",n),this.userMapProfile={id:`userMapProfile_${vt||"main"}`,nickname:"我",handle:"me",avatar:"",bio:"编辑我的简介",tags:["探索中"],avatarBubble:"👋",lastUpdated:(new Date).toISOString()}}},showUserProfileCard(){if(!this.userMapProfile)return void console.warn("⚠️ 用户资料未初始化");const n=this.userMapProfile,e=document.getElementById("mapCardAvatar"),t=document.getElementById("mapCardAvatarBubble"),o=document.getElementById("mapCardNickname"),a=document.getElementById("mapCardHandle"),i=document.getElementById("mapCardFollowers"),r=document.getElementById("mapCardLikes"),s=document.getElementById("mapCardBio"),l=document.getElementById("mapCardTags"),c=document.getElementById("mapCardDistance"),d=document.getElementById("mapUserDetailCard");e&&(e.src=n.avatar),t&&(t.textContent=n.avatarBubble||"😊"),o&&(o.textContent=n.nickname),a&&(a.textContent=n.handle.startsWith("@")?n.handle:`@${n.handle}`),i&&(i.textContent=n.followers||0),r&&(r.textContent=n.likes||0),s&&(s.textContent=n.bio),l&&(l.innerHTML=n.tags.map(n=>`<div class="card-tag">${n}</div>`).join("")),c&&(c.textContent="0km");const p=document.getElementById("mapCardReviewsSection");p&&p.classList.remove("active"),d&&(d.style.display="block"),this.isShowingUserProfile=!0,this.bindUserProfileEditEvents()},bindUserProfileEditEvents(){const n=document.getElementById("mapCardAvatar");n&&(n.onclick=n=>{n.stopPropagation(),this.editAvatar()});const e=document.getElementById("mapCardNickname");e&&(e.onclick=n=>{n.stopPropagation(),this.editNickname()});const t=document.getElementById("mapCardBio");t&&(t.onclick=n=>{n.stopPropagation(),this.editBio()}),document.querySelectorAll("#mapCardTags .card-tag").forEach((n,e)=>{n.onclick=n=>{n.stopPropagation(),this.editTag(n.target,e)}})},editAvatar(){const n=this.userMapProfile.avatar,e=prompt("请输入新的头像URL:",n);if(null!==e&&""!==e.trim()){this.userMapProfile.avatar=e.trim();const n=document.getElementById("mapCardAvatar");n&&(n.src=e.trim()),this.saveUserMapProfile()}},editNickname(){const n=this.userMapProfile.nickname,e=prompt("请输入昵称（2-8个字符）:",n);if(null!==e&&""!==e.trim()){this.userMapProfile.nickname=e.trim();const n=document.getElementById("mapCardNickname");n&&(n.textContent=e.trim()),this.saveUserMapProfile()}},editBio(){const n=this.userMapProfile.bio,e=prompt("请输入简介（可以使用\\n换行）:",n);if(null!==e){this.userMapProfile.bio=e.trim();const n=document.getElementById("mapCardBio");n&&(n.textContent=e.trim()),this.saveUserMapProfile()}},editTag(n,e){const t=n.textContent.trim(),o=prompt("请输入标签内容:",t);null!==o&&""!==o.trim()?(this.userMapProfile.tags[e]=o.trim(),this.refreshTagsDisplay(),this.saveUserMapProfile()):""===o&&confirm("确定要删除这个标签吗？")&&(this.userMapProfile.tags.splice(e,1),this.refreshTagsDisplay(),this.saveUserMapProfile())},refreshTagsDisplay(){const n=document.getElementById("mapCardTags");n&&(n.innerHTML=this.userMapProfile.tags.map(n=>`<div class="card-tag">${n}</div>`).join(""),document.querySelectorAll("#mapCardTags .card-tag").forEach((n,e)=>{n.onclick=n=>{n.stopPropagation(),this.editTag(n.target,e)}}))},async saveUserMapProfile(){try{const n=e();this.userMapProfile.lastUpdated=(new Date).toISOString(),await n.xMapUserProfile.put(this.userMapProfile),console.log("✅ [用户地图资料] 已保存到数据库"),this.renderCurrentUserMarker()}catch(n){console.error("❌ [用户地图资料] 保存失败:",n)}},filterUsers(n){this.currentUsers=n?this.allUsers.filter(e=>e.nickname.toLowerCase().includes(n.toLowerCase())||e.handle.toLowerCase().includes(n.toLowerCase())||e.bio.toLowerCase().includes(n.toLowerCase())||e.tags.some(e=>e.includes(n))):[...this.allUsers],this.renderUserList(),this.renderMapMarkers()},filterByDistance(n){if("all"===n)this.currentUsers=[...this.allUsers];else{const e=parseFloat(n);this.currentUsers=this.allUsers.filter(n=>n.distance<=e)}this.renderUserList(),this.renderMapMarkers()},filterByGender(n){this.currentUsers="all"===n?[...this.allUsers]:this.allUsers.filter(e=>e.gender===n),this.renderUserList(),this.renderMapMarkers()},applyFilters(){console.log("应用筛选")},centerMap(){const n=document.getElementById("mapArea"),e=document.getElementById("mapCanvas");if(!n||!e)return;e.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)",this.mapState.scale=1;const t=n.offsetWidth,o=n.offsetHeight;this.mapState.translateX=-(t*this.MAP_SIZE_MULTIPLIER-t)/2,this.mapState.translateY=-(o*this.MAP_SIZE_MULTIPLIER-o)/2,this.updateMapTransform();const a=e.querySelector(".map-marker.current-user");a&&(a.style.animation="none",setTimeout(()=>{a.style.animation=""},10)),setTimeout(()=>{e.style.transition="none"},500)},zoomIn(){this.mapState.scale<this.MAX_ZOOM&&(this.mapState.scale=Math.min(this.mapState.scale+this.ZOOM_STEP,this.MAX_ZOOM),this.clampMapPosition(),this.updateMapTransform())},zoomOut(){this.mapState.scale>this.MIN_ZOOM&&(this.mapState.scale=Math.max(this.mapState.scale-this.ZOOM_STEP,this.MIN_ZOOM),this.clampMapPosition(),this.updateMapTransform())},sendMessage(){const n=this.currentUsers.find(n=>n.id===this.selectedUserId);if(n){"interested"===(this.detailCardOpenSource||"map")?(this.chatContext[n.id]="interested_then_message",console.log(`🎯 [聊天上下文] ${n.nickname} - 对方先对你感兴趣，你回应私信`)):(this.chatContext[n.id]="normal",console.log(`🎯 [聊天上下文] ${n.nickname} - 普通陌生人聊天，初始好感度为0`)),this.openChatModal(n)}},viewProfile(){const n=document.getElementById("mapProfileDropdownMenu");n&&n.classList.toggle("show")},closeProfileDropdown(){const n=document.getElementById("mapProfileDropdownMenu");n&&n.classList.remove("show")},momentsCurrentIndex:0,momentsStartX:0,momentsCurrentX:0,momentsDragging:!1,momentsCurrentCommentMoment:null,openMomentsModal(){this.closeProfileDropdown();const n=this.currentUsers.find(n=>n.id===this.selectedUserId);if(n||(n=this.allUsers.find(n=>n.id==this.selectedUserId)),!n)return;const e=document.getElementById("mapMomentsModal"),t=document.getElementById("mapMomentsEmptyState"),o=document.getElementById("mapMomentsCardsWrapper"),a=document.getElementById("mapMomentsIndicator");if(!e)return;const i=n.moments||[];0===i.length?(t&&(t.style.display="flex"),o&&(o.innerHTML=""),a&&(a.innerHTML="")):(t&&(t.style.display="none"),this.momentsCurrentIndex=0,this.renderMomentsCards(i),this.renderMomentsIndicator(i)),e.style.display="block",setTimeout(()=>{e.classList.add("active")},10)},closeMomentsModal(){const n=document.getElementById("mapMomentsModal");n&&(n.classList.remove("active"),setTimeout(()=>{n.style.display="none"},300))},renderMomentsCards(n){const e=document.getElementById("mapMomentsCardsWrapper");e&&(e.innerHTML="",n.forEach((t,o)=>{const a=document.createElement("div");let i;if(a.className="moment-card",a.dataset.index=o,a.dataset.position=o-this.momentsCurrentIndex,t.userAvatar&&(t.userAvatar.startsWith("http://")||t.userAvatar.startsWith("https://")||t.userAvatar.startsWith("data:")))i=`<img class="moment-user-avatar" src="${t.userAvatar}" alt="${t.userName||"User"}">`;else{i=`<div class="moment-user-avatar">${t.userAvatar||(t.userName?t.userName.substring(0,2).toUpperCase():"U")}</div>`}a.innerHTML=`\n          <div class="moment-card-image">\n            ${t.imageDescription?`<div class="moment-card-text-image">\n                <div class="text-image-content">${t.imageDescription}</div>\n                <div class="text-image-overlay"></div>\n              </div>`:'<div class="moment-card-image-placeholder">NO IMAGE</div>'}\n          </div>\n          <div class="moment-card-content">\n            <div class="moment-card-header">\n              ${i}\n              <div class="moment-user-info">\n                <div class="moment-username">${t.userName||"User"}</div>\n                <div class="moment-time">${t.time||"Recently"}</div>\n              </div>\n            </div>\n            <div class="moment-card-text">${t.text||""}</div>\n            <div class="moment-card-stats">\n              <div class="moment-stat-item">\n                <span class="moment-stat-number">${t.likes||0}</span>\n                <span>Likes</span>\n              </div>\n              <div class="moment-stat-item">\n                <span class="moment-stat-number">${t.comments||0}</span>\n                <span>Comments</span>\n              </div>\n              <div class="moment-stat-item">\n                <span class="moment-stat-number">${t.shares||0}</span>\n                <span>Shares</span>\n              </div>\n            </div>\n            <div class="moment-card-actions">\n              <button class="moment-action-btn moment-like-btn">\n                <svg viewBox="0 0 24 24" fill="none">\n                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n                </svg>\n                Like\n              </button>\n              <button class="moment-action-btn moment-comment-btn" data-moment-id="${t.id||o}">\n                <svg viewBox="0 0 24 24" fill="none">\n                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n                </svg>\n                Comment\n              </button>\n              <button class="moment-action-btn moment-share-btn">\n                <svg viewBox="0 0 24 24" fill="none">\n                  <circle cx="18" cy="5" r="3"/>\n                  <circle cx="6" cy="12" r="3"/>\n                  <circle cx="18" cy="19" r="3"/>\n                  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>\n                  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>\n                </svg>\n                Share\n              </button>\n            </div>\n          </div>\n        `,e.appendChild(a),o===this.momentsCurrentIndex&&this.setupMomentCardEvents(a,n)}),this.updateMomentCardPositions())},setupMomentCardEvents(n,e){const t=n.querySelector(".moment-like-btn");t&&t.addEventListener("click",n=>{n.stopPropagation(),t.classList.toggle("active")});const o=n.querySelector(".moment-comment-btn");o&&o.addEventListener("click",n=>{n.stopPropagation();const t=o.dataset.momentId;this.openMomentsCommentsDrawer(e,t)}),n.addEventListener("mousedown",n=>this.handleMomentStart(n,e)),n.addEventListener("touchstart",n=>this.handleMomentStart(n,e),{passive:!0})},handleMomentStart(n,e){n.target.closest(".moment-action-btn")||(this.momentsDragging=!0,this.momentsStartX="mousedown"===n.type?n.clientX:n.touches[0].clientX,this.momentsCurrentX=this.momentsStartX,document.addEventListener("mousemove",n=>this.handleMomentMove(n)),document.addEventListener("touchmove",n=>this.handleMomentMove(n),{passive:!1}),document.addEventListener("mouseup",n=>this.handleMomentEnd(n,e)),document.addEventListener("touchend",n=>this.handleMomentEnd(n,e)))},handleMomentMove(n){if(!this.momentsDragging)return;n.preventDefault(),this.momentsCurrentX="mousemove"===n.type?n.clientX:n.touches[0].clientX;const e=this.momentsCurrentX-this.momentsStartX,t=document.getElementById("mapMomentsCardsWrapper"),o=t?.querySelector(`[data-index="${this.momentsCurrentIndex}"]`);if(o){const n=.05*e;o.style.setProperty("--swipe-x",`${e}px`),o.style.setProperty("--swipe-rotate",`${n}deg`),o.className=e>0?"moment-card swiping-right":"moment-card swiping-left"}},handleMomentEnd(n,e){if(!this.momentsDragging)return;this.momentsDragging=!1;const t=this.momentsCurrentX-this.momentsStartX;document.removeEventListener("mousemove",this.handleMomentMove),document.removeEventListener("touchmove",this.handleMomentMove),document.removeEventListener("mouseup",this.handleMomentEnd),document.removeEventListener("touchend",this.handleMomentEnd);const o=document.getElementById("mapMomentsCardsWrapper"),a=o?.querySelector(`[data-index="${this.momentsCurrentIndex}"]`);Math.abs(t)>100?t<0?(a.classList.add("removed-left"),setTimeout(()=>{this.momentsCurrentIndex<e.length-1?this.momentsCurrentIndex++:this.momentsCurrentIndex=0,this.renderMomentsCards(e),this.renderMomentsIndicator(e)},400)):(a.classList.add("removed-right"),setTimeout(()=>{this.momentsCurrentIndex>0?this.momentsCurrentIndex--:this.momentsCurrentIndex=e.length-1,this.renderMomentsCards(e),this.renderMomentsIndicator(e)},400)):(a.style.setProperty("--swipe-x","0"),a.style.setProperty("--swipe-rotate","0deg"),a.className="moment-card",setTimeout(()=>{a.dataset.position="0"},50))},updateMomentCardPositions(){const n=document.getElementById("mapMomentsCardsWrapper");if(!n)return;n.querySelectorAll(".moment-card").forEach(n=>{const e=parseInt(n.dataset.index)-this.momentsCurrentIndex;n.dataset.position=e})},renderMomentsIndicator(n){const e=document.getElementById("mapMomentsIndicator");e&&(e.innerHTML="",n.forEach((n,t)=>{const o=document.createElement("div");o.className="moments-indicator-dot "+(t===this.momentsCurrentIndex?"active":""),e.appendChild(o)}))},openMomentsCommentsDrawer(n,e){const t=n.find(t=>(t.id||n.indexOf(t))==e);if(!t)return;this.momentsCurrentCommentMoment=t;const o=document.getElementById("mapMomentsCommentsOverlay"),a=document.getElementById("mapMomentsCommentsDrawer"),i=document.getElementById("mapMomentsCommentsTitle"),r=document.getElementById("mapMomentsCommentsList");if(!(o&&a&&i&&r))return;i.textContent=`${t.comments} Comments`;const s=t.commentsList||[];r.innerHTML=s.length>0?s.map(n=>{let e;if(n.avatar&&(n.avatar.startsWith("http://")||n.avatar.startsWith("https://")||n.avatar.startsWith("data:")))e=`<img class="moment-comment-avatar" src="${n.avatar}" alt="${n.user||"User"}">`;else{e=`<div class="moment-comment-avatar">${n.avatar||(n.user?n.user.substring(0,1).toUpperCase():"?")}</div>`}return`\n            <div class="moment-comment-item">\n              ${e}\n              <div class="moment-comment-content">\n                <div class="moment-comment-user">${n.user||n.commenterName||"User"}</div>\n                <div class="moment-comment-text">${n.text||n.commentText||""}</div>\n                <div class="moment-comment-time">${n.commentTime||n.time||"Recently"}</div>\n              </div>\n            </div>\n          `}).join(""):'<div style="text-align: center; color: #999; padding: 40px 20px; font-size: 14px;">No comments yet</div>',o.classList.add("show"),requestAnimationFrame(()=>{a.classList.add("show")})},closeMomentsCommentsDrawer(){const n=document.getElementById("mapMomentsCommentsOverlay"),e=document.getElementById("mapMomentsCommentsDrawer");e&&n&&(e.classList.remove("show"),setTimeout(()=>{n.classList.remove("show"),this.momentsCurrentCommentMoment=null},300))},showSocialCircle(){const n=document.getElementById("mapSocialCircleModal"),e=document.getElementById("mapSocialCircleEmpty"),t=document.getElementById("mapSocialCircleList");if(!n||!e||!t)return;let o=this.currentUsers.find(n=>n.id==this.selectedUserId);if(o||(o=this.allUsers.find(n=>n.id==this.selectedUserId)),!o)return;const a=o.socialCircle||[];0===a.length?(e.style.display="flex",t.style.display="none"):(e.style.display="none",t.style.display="flex",t.innerHTML=a.map(n=>{const e=n.bio?n.bio.split("\n"):[];let t="No bio";e.length>1?t=e.slice(1).join(" ").trim():1===e.length&&(t=e[0].trim()),t||(t="No bio");const o={best_friend:"Best Friend",lover:"Lover",ex_lover:"Ex-Lover",sibling:"Sibling",cousin:"Cousin",family:"Family",friend:"Friend",colleague:"Colleague",classmate:"Classmate",rival:"Rival",frenemy:"Frenemy",complicated:"Complicated"}[n.relationship]||n.relationship||"Friend",a=n.handle.startsWith("@")?n.handle:`@${n.handle}`;return"object"!=typeof n.avatar&&n.avatar||(console.warn(`⚠️ [社交圈显示] ${n.nickname} 的avatar字段异常，使用备用头像`),n.avatar=this.getRandomAvatar()),n.avatarBubble&&"object"==typeof n.avatarBubble&&(n.avatarBubble=n.avatarBubble.emoji||"💖",console.warn(`⚠️ [社交圈显示] ${n.nickname} 的avatarBubble是对象，已修正为: ${n.avatarBubble}`)),`\n            <div class="map-social-circle-friend-card" data-friend-id="${n.id}">\n              <div class="map-social-circle-friend-header">\n                <img class="map-social-circle-friend-avatar" src="${n.avatar}" alt="${n.nickname}">\n                <div class="map-social-circle-friend-info">\n                  <div class="map-social-circle-friend-name">${n.nickname}</div>\n                  <div class="map-social-circle-friend-handle">${a}</div>\n                </div>\n                <div class="map-social-circle-friend-relationship">${o}</div>\n              </div>\n              <div class="map-social-circle-friend-bio">${t}</div>\n              <div class="map-social-circle-friend-stats">\n                <div class="map-social-circle-friend-stat">\n                  <span class="map-social-circle-friend-stat-value">${n.followers||0}</span>\n                  <span>followers</span>\n                </div>\n                <div class="map-social-circle-friend-stat">\n                  <span class="map-social-circle-friend-stat-value">${n.likes||0}</span>\n                  <span>likes</span>\n                </div>\n                <div class="map-social-circle-friend-stat">\n                  <span class="map-social-circle-friend-stat-value">${(n.distance||0).toFixed(1)}km</span>\n                  <span>away</span>\n                </div>\n              </div>\n            </div>\n          `}).join(""),t.querySelectorAll(".map-social-circle-friend-card").forEach(n=>{n.addEventListener("click",()=>{const e=n.dataset.friendId,t=a.find(n=>n.id===e);if(t){let n=this.currentUsers.find(n=>n.id==e),o=this.allUsers.find(n=>n.id==e);n||o||(console.log(`👥 [社交圈] 好友 ${t.nickname} 不在用户列表中，临时添加到currentUsers`),this.currentUsers.push(t)),this.showDetailCard(t.id,"socialCircle"),this.hideSocialCircle()}})})),n.style.display="flex"},hideSocialCircle(){const n=document.getElementById("mapSocialCircleModal");n&&(n.style.display="none")},async openChatModal(n){this.currentChatUser=n,this.closeDetailCard();const t=document.getElementById("mapChatUserAvatar"),o=document.getElementById("mapChatUserName");t&&(t.src=n.avatar),o&&(o.textContent=n.nickname);const a=`mapChat_${n.id}_${vt||"main"}`,i=e();let r=!1;if(i)try{const e=await i.xMapChats.get(a);if(e){if(this.chatMessages[n.id]=e.messages||[],r=!0,console.log(`📥 [聊天记录] 已从数据库加载 ${n.nickname} 的聊天记录 (${this.chatMessages[n.id].length} 条消息)`),e.affectionData&&(this.chatAffectionData[n.id]=e.affectionData,console.log(`💖 [好感度系统] 已从数据库加载 ${n.nickname} 的好感度数据 (好感度: ${e.affectionData.affection.toFixed(1)}/100)`)),e.notes){this.chatNotes[n.id]=e.notes;const t=Object.keys(e.notes).length;t>0&&console.log(`📝 [AI笔记系统] 已从数据库加载 ${n.nickname} 的笔记 (${t}条: ${Object.keys(e.notes).join("、")})`)}e.userMarkedNotes&&(this.userMarkedNotes[n.id]=e.userMarkedNotes,e.userMarkedNotes.length>0&&console.log(`📌 [用户笔记系统] 已从数据库加载 ${n.nickname} 的用户笔记 (${e.userMarkedNotes.length}条)`)),e.npcNotesAboutUser&&(this.npcNotesAboutUser[n.id]=e.npcNotesAboutUser,e.npcNotesAboutUser.length>0&&console.log(`💭 [NPC观察笔记] 已从数据库加载 ${n.nickname} 对你的观察笔记 (${e.npcNotesAboutUser.length}条)`))}}catch(n){console.error("❌ [聊天记录] 从数据库加载失败:",n)}if(r||this.chatMessages[n.id]||(this.chatMessages[n.id]=[],console.log(`📝 [聊天记录] 已初始化 ${n.nickname} 的空白聊天记录`)),!this.chatAffectionData[n.id]){this.chatAffectionData[n.id]=this.calculateAffectionParameters(n);const e=this.chatContext[n.id]||"normal";"interested_then_message"===e?(this.chatAffectionData[n.id].affection=15+10*Math.random(),console.log(`💖 [好感度系统] ${n.nickname} 先对你感兴趣，设置初始好感度: ${this.chatAffectionData[n.id].affection.toFixed(1)}`)):"message_accepted"===e?(this.chatAffectionData[n.id].affection=20+10*Math.random(),console.log(`💖 [好感度系统] ${n.nickname} 主动发起私信，设置初始好感度: ${this.chatAffectionData[n.id].affection.toFixed(1)}`)):console.log(`💖 [好感度系统] ${n.nickname} 普通聊天，初始好感度: 0`),console.log(`💖 [好感度系统] 已初始化 ${n.nickname} 的好感度数据 (好感度: ${this.chatAffectionData[n.id].affection.toFixed(1)}, 阈值: ${this.chatAffectionData[n.id].threshold}, 增长率: ${this.chatAffectionData[n.id].growthRate.toFixed(2)}x)`)}this.chatNotes[n.id]||(this.chatNotes[n.id]={},console.log(`📝 [AI笔记系统] 已初始化 ${n.nickname} 的笔记数据（空白人设）`)),this.userMarkedNotes[n.id]||(this.userMarkedNotes[n.id]=[],console.log(`📌 [用户笔记系统] 已初始化 ${n.nickname} 的用户笔记数据（空白）`)),this.npcNotesAboutUser[n.id]||(this.npcNotesAboutUser[n.id]=[],console.log(`💭 [NPC观察笔记] 已初始化 ${n.nickname} 对你的观察笔记数据（空白）`)),this.renderChatMessages();const s=document.getElementById("mapChatOverlay"),l=document.getElementById("mapChatModal");s&&s.classList.add("show"),l&&l.classList.add("show"),this.checkAndUpdateChatInputState(n.id),this.checkMinorWarning(n),setTimeout(()=>{const n=document.getElementById("mapChatMessages");n&&(n.scrollTop=n.scrollHeight)},100)},checkMinorWarning(n){if(this.chatMessages[n.id]&&this.chatMessages[n.id].length>0)return;const e=this.extractAgeFromBio(n.bio);null!==e&&e<18&&(console.log(`🔞 [未成年人警告] 检测到 ${n.nickname} 年龄为 ${e}岁，显示系统警告`),this.addSystemMessage("Notice: This user is under 18 years old. Please be mindful of your language and behavior."))},extractAgeFromBio(n){if(!n)return null;const e=[/(\d{1,2})\s*岁/i,/(\d{1,2})\s*years?\s*old/i,/age[:\s]+(\d{1,2})/i,/(\d{1,2})\s*yo\b/i,/(\d{1,2})\s*y\.?o\.?/i,/\b(\d{1,2})\s*(?:歳|才)/i,/^(\d{1,2})$/];for(const t of e){const e=n.match(t);if(e){const t=parseInt(e[1]);if(t>=10&&t<=99)return console.log(`🔍 [年龄提取] 从bio "${n}" 中提取到年龄: ${t}`),t}}return null},closeChatModal(){const n=document.getElementById("mapChatOverlay"),e=document.getElementById("mapChatModal");n&&n.classList.remove("show"),e&&e.classList.remove("show"),this.closeFunctionMenu(),this.closeNotesModal(),this.currentChatUser=null},toggleMoreMenu(){const n=document.getElementById("mapChatMoreMenu");if(!n)return;n.classList.contains("show")?n.classList.remove("show"):(n.classList.add("show"),setTimeout(()=>{const e=t=>{n.contains(t.target)||document.getElementById("mapChatMoreBtn").contains(t.target)||(n.classList.remove("show"),document.removeEventListener("click",e))};document.addEventListener("click",e)},100))},addCurrentChatToList(){if(this.currentChatUser)try{const n=localStorage.getItem("xMapSavedChats"),e=n?JSON.parse(n):[];if(e.some(n=>n.id===this.currentChatUser.id))return void console.log("该聊天已在列表中");const t={id:this.currentChatUser.id,name:this.currentChatUser.nickname,avatar:this.currentChatUser.avatar,lastMessage:"Start chatting...",savedAt:Date.now(),userData:this.currentChatUser};e.push(t),localStorage.setItem("xMapSavedChats",JSON.stringify(e)),console.log("已添加到聊天列表:",t.name);const o=document.getElementById("mapChatMoreMenu");o&&o.classList.remove("show")}catch(n){console.error("添加到聊天列表失败:",n)}else console.log("没有当前聊天对象")},openChatsListModal(){const n=document.getElementById("mapChatsListOverlay"),e=document.getElementById("mapChatsListModal");n&&n.classList.add("show"),e&&e.classList.add("show"),this.loadAndRenderChatsList()},closeChatsListModal(){const n=document.getElementById("mapChatsListOverlay"),e=document.getElementById("mapChatsListModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},async openNotificationsModal(){const n=document.getElementById("mapNotificationsOverlay"),e=document.getElementById("mapNotificationsModal");n&&n.classList.add("show"),e&&e.classList.add("show"),await this.loadAndRenderNotificationsList(),await this.markAllNotificationsAsRead()},closeNotificationsModal(){const n=document.getElementById("mapNotificationsOverlay"),e=document.getElementById("mapNotificationsModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},openAppSettingsModal(){const n=document.getElementById("mapAppSettingsOverlay"),e=document.getElementById("mapAppSettingsModal");n&&n.classList.add("show"),e&&e.classList.add("show"),this.syncThemeToggleUI(),this.renderCustomAvatarList()},closeAppSettingsModal(){const n=document.getElementById("mapAppSettingsOverlay"),e=document.getElementById("mapAppSettingsModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},toggleTheme(){const n=document.getElementById("x-map-container");if(!n)return void console.error("❌ [主题切换] 找不到容器 #x-map-container");const e=n.classList.toggle("light-theme");try{localStorage.setItem("xMapTheme",e?"light":"dark"),console.log(`✅ [主题切换] 已切换到${e?"亮色":"暗色"}主题`)}catch(n){console.error("❌ [主题切换] 保存主题设置失败:",n)}void 0!==Is&&Is.setTheme&&(Is.setTheme(e),Is.redraw()),this.syncThemeToggleUI()},syncThemeToggleUI(){const n=document.getElementById("x-map-container"),e=document.getElementById("mapThemeToggle"),t=e?.querySelector(".map-theme-toggle-icon");if(!n||!e||!t)return;const o=n.classList.contains("light-theme");o?e.classList.add("light"):e.classList.remove("light"),t.innerHTML=o?'<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>':'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'},initThemeSettings(){try{const n=localStorage.getItem("xMapTheme"),e=document.getElementById("x-map-container");if(!e)return void console.warn("⚠️ [主题初始化] 找不到容器 #x-map-container");const t="light"===n;t?(e.classList.add("light-theme"),console.log("✅ [主题初始化] 已加载亮色主题")):(e.classList.remove("light-theme"),console.log("✅ [主题初始化] 已加载暗色主题")),void 0!==Is&&Is.setTheme&&Is.ctx&&(Is.setTheme(t),Is.redraw()),this.syncThemeToggleUI()}catch(n){console.error("❌ [主题初始化] 加载主题设置失败:",n)}},initRideMode(){this.rideMode=!1,this.rideSelectingDestination=!1,this.rideSelectedDestination=null,this.rideVehicleMarkers=[],console.log("🚗 [乘车功能] 初始化完成")},openRidePanel(){console.log("🚗 [乘车功能] 打开乘车面板"),this.rideVehicleMarkers||(this.rideVehicleMarkers=[]),this.rideMode=!0;const n=document.getElementById("ridePanel"),e=document.getElementById("ridePanelOverlay");n&&(n.classList.add("show"),n.classList.remove("hide")),e&&e.classList.add("show"),this.generateVehicleMarkers(),console.log("✅ [乘车功能] 面板已打开")},closeRidePanel(){console.log("🚗 [乘车功能] 关闭乘车面板"),this.rideMode=!1,this.rideSelectingDestination=!1;const n=document.getElementById("ridePanel"),e=document.getElementById("ridePanelOverlay"),t=document.getElementById("rideSelectionHint");if(n&&(n.classList.remove("show"),n.classList.add("hide")),e&&e.classList.remove("show"),t&&t.classList.remove("show"),this.clearVehicleMarkers(),this.clearRideRoute(),this.rideSelectedDestination){const n=document.getElementById(this.rideSelectedDestination.id);n&&n.classList.remove("ride-destination-selected"),this.rideSelectedDestination=null}this.resetRideUI(),console.log("✅ [乘车功能] 面板已关闭")},startSelectingDestination(){console.log("🚗 [乘车功能] 开始选择目的地"),this.rideSelectingDestination=!0;const n=document.getElementById("rideDestinationBox");n&&n.classList.add("selecting");const e=document.getElementById("rideSelectionHint");e&&e.classList.add("show");const t=document.getElementById("ridePanel");t&&(t.classList.add("hide"),t.classList.remove("show"));const o=document.getElementById("ridePanelOverlay");o&&o.classList.remove("show")},selectRideDestination(n){if(console.log("🚗 [乘车功能] 选择目的地:",n.name),this.rideSelectedDestination){const n=document.getElementById(this.rideSelectedDestination.id);n&&n.classList.remove("ride-destination-selected")}this.rideSelectedDestination=n,this.rideSelectingDestination=!1;const e=document.getElementById(n.id);e&&e.classList.add("ride-destination-selected");const t=document.getElementById("rideDestinationValue"),o=document.getElementById("rideDestinationBox"),a=document.getElementById("rideSelectionHint");t&&(t.textContent=n.name,t.classList.remove("placeholder")),o&&o.classList.remove("selecting"),a&&a.classList.remove("show"),this.calculateAndUpdateRoute();const i=document.getElementById("ridePanel"),r=document.getElementById("ridePanelOverlay");i&&setTimeout(()=>{i.classList.add("show"),i.classList.remove("hide"),r&&r.classList.add("show")},300)},calculateAndUpdateRoute(){if(!this.rideSelectedDestination)return;console.log("🚗 [乘车功能] 计算路线和价格");const e={x:50,y:50},t={x:this.rideSelectedDestination.x/n.innerWidth*100,y:this.rideSelectedDestination.y/n.innerHeight*100},o=t.x-e.x,a=t.y-e.y,i=Math.sqrt(o*o+a*a),r=Math.max(Math.round(.5*i),1),s=document.getElementById("rideEstimatedTime");s&&(s.textContent=`${r} min`);document.querySelectorAll(".ride-vehicle-card").forEach(n=>{const e=parseFloat(n.dataset.basePrice),t=parseFloat(n.dataset.rate),o=Math.round(e+r*t),a=n.querySelector(".ride-price-value");a&&(a.textContent=o)}),this.drawRideRoute(e,t);const l=document.getElementById("rideBookBtn");l&&(l.disabled=!1,l.textContent="立即预订"),console.log(`✅ [乘车功能] 路线计算完成 - 预计 ${r} 分钟`)},drawRideRoute(n,e){this.clearRideRoute();const t=document.querySelector(".map-canvas");if(!t)return;const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("ride-route-svg"),o.id="rideRouteSvg",o.setAttribute("viewBox","0 0 100 100"),o.setAttribute("preserveAspectRatio","none");const a=(n.x+e.x)/2,i=(n.y+e.y)/2,r=a+20*(Math.random()-.5),s=i+20*(Math.random()-.5),l=document.createElementNS("http://www.w3.org/2000/svg","path");l.classList.add("ride-route-path"),l.setAttribute("d",`M ${n.x},${n.y} Q ${r},${s} ${e.x},${e.y}`),o.appendChild(l),t.appendChild(o),console.log("✅ [乘车功能] 路线已绘制")},clearRideRoute(){const n=document.getElementById("rideRouteSvg");n&&n.remove()},generateVehicleMarkers(){this.clearVehicleMarkers();const n=document.querySelector(".map-canvas");if(!n)return;const e=Math.floor(4*Math.random())+5;for(let t=0;t<e;t++){const e=document.createElement("div");let t,o,a;e.classList.add("ride-vehicle-marker");do{t=80*Math.random()+10,o=80*Math.random()+10;a=Math.sqrt(Math.pow(t-50,2)+Math.pow(o-50,2))<15}while(a);e.style.left=`${t}%`,e.style.top=`${o}%`,e.style.animationDelay=2*Math.random()+"s",e.innerHTML='\n        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <ellipse cx="32" cy="52" rx="18" ry="4" fill="currentColor" opacity="0.15"/>\n          <path d="M 16,38 L 12,32 L 12,20 L 20,14 L 44,14 L 52,20 L 52,32 L 48,38 Z" fill="currentColor" opacity="0.3"/>\n          <ellipse cx="20" cy="38" rx="6" ry="6" fill="currentColor" opacity="0.6"/>\n          <ellipse cx="44" cy="38" rx="6" ry="6" fill="currentColor" opacity="0.6"/>\n          <rect x="18" y="10" width="28" height="16" rx="3" fill="currentColor" opacity="0.4"/>\n          <rect x="24" y="6" width="16" height="6" rx="1.5" fill="currentColor" opacity="0.5"/>\n        </svg>\n      ',n.appendChild(e),this.rideVehicleMarkers.push(e)}console.log(`✅ [乘车功能] 生成了 ${e} 个车辆标记`)},clearVehicleMarkers(){this.rideVehicleMarkers?(this.rideVehicleMarkers.forEach(n=>n.remove()),this.rideVehicleMarkers=[]):this.rideVehicleMarkers=[]},selectVehicle(n){document.querySelectorAll(".ride-vehicle-card").forEach(n=>{n.classList.remove("selected")}),n.classList.add("selected"),console.log("🚗 [乘车功能] 选择车型:",n.dataset.type)},selectPaymentOption(n){document.querySelectorAll(".ride-payment-option").forEach(n=>{n.classList.remove("selected")}),n.classList.add("selected"),console.log("🚗 [乘车功能] 选择支付方式:",n.dataset.payment)},async bookRide(){if(!this.rideSelectedDestination)return void alert("请先选择目的地");const e=document.querySelector(".ride-vehicle-card.selected"),t=document.querySelector(".ride-payment-option.selected");if(!e||!t)return void alert("请选择车型和支付方式");const o=e.querySelector(".ride-vehicle-name").textContent,a=parseFloat(e.querySelector(".ride-price-value").textContent),i=this.rideSelectedDestination.name,r=document.getElementById("rideEstimatedTime").textContent,s=t.dataset.payment,l="cash"===s?"现金":"在线支付",c=document.getElementById("rideBookBtn");c&&(c.textContent="处理中...",c.style.opacity="0.7");try{let e=a,t=0,d=!1;if("online"===s&&Math.random()<.3&&(d=!0,t=Math.floor(11*Math.random())+10,e=a*(1-t/100),console.log(`🎉 [乘车功能] 在线支付获得${t}%折扣！原价¥${a} → 实付¥${e.toFixed(2)}`)),console.log("🚗 [乘车功能] 预订信息:",{vehicleType:o,originalPrice:a,finalPrice:e,discountPercent:t,destination:i,time:r,paymentName:l}),"online"===s){if(await Mt(),!It.isActivated)return alert("请先激活钱包才能使用在线支付"),void(c&&(c.textContent="立即预订",c.style.opacity="1"));if(It.balance<e)return alert(`余额不足！当前余额：$${It.balance.toFixed(2)}，需要：$${e.toFixed(2)}`),void(c&&(c.textContent="立即预订",c.style.opacity="1"));It.balance-=e;const n={id:"ride_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:d?`City Ride to ${i} (${t}% Off)`:`City Ride to ${i}`,amount:-e,timestamp:(new Date).toISOString(),type:"ride_payment"};It.transactions.unshift(n),await Tt(),console.log(`💰 [乘车功能] 已扣除$${e.toFixed(2)}，当前余额: $${It.balance.toFixed(2)}`)}{let a="";a="online"===s?d?`-$${e.toFixed(2)} (${t}% Off). Balance: $${It.balance.toFixed(2)}`:`-$${e.toFixed(2)}. Balance: $${It.balance.toFixed(2)}`:`Cash Payment ¥${e.toFixed(2)}. Driver arriving in ${r}.`,Rl({title:"Ride Booked",message:`${o} → ${i}. ${a}`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:5e3})}setTimeout(()=>{c&&(c.textContent="立即预订",c.style.opacity="1"),this.closeRidePanel(),this.createRideOrder(o,e,i),console.log("✅ [乘车功能] 预订成功")},1e3)}catch(n){console.error("❌ [乘车功能] 预订失败:",n),alert("预订失败，请重试"),c&&(c.textContent="立即预订",c.style.opacity="1")}},saveRideOrder(n){try{localStorage.setItem("x_ride_order",JSON.stringify(n)),console.log("✅ [等待司机] 订单已保存",n)}catch(n){console.error("❌ [等待司机] 保存订单失败:",n)}},loadRideOrder(){try{const n=localStorage.getItem("x_ride_order");return n?JSON.parse(n):null}catch(n){return console.error("❌ [等待司机] 加载订单失败:",n),null}},clearRideOrder(){try{localStorage.removeItem("x_ride_order"),console.log("✅ [等待司机] 订单已清除")}catch(n){console.error("❌ [等待司机] 清除订单失败:",n)}},generateDriverData(){const n=["Ethan","James","Sophia","Mason","Lucas","Oliver","Emma","Ava","Liam","Noah"],e=["Skoda Fabla","Ford Focus","BMW X5","Opel Vectra","Audi A4","Mercedes Benz","Toyota Camry"],t=n[Math.floor(Math.random()*n.length)],o=e[Math.floor(Math.random()*e.length)],a=t.charAt(0);return{name:t,rating:(4.5+.5*Math.random()).toFixed(1),vehicle:o,plate:(()=>{const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ",e="0123456789";return n[Math.floor(26*Math.random())]+n[Math.floor(26*Math.random())]+e[Math.floor(10*Math.random())]+e[Math.floor(10*Math.random())]+e[Math.floor(10*Math.random())]+e[Math.floor(10*Math.random())]+n[Math.floor(26*Math.random())]+e[Math.floor(10*Math.random())]})(),avatar:`data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect fill='%23d5d5d5' width='64' height='64'/%3E%3Ctext x='50%25' y='50%25' fill='%23666' text-anchor='middle' dy='.3em' font-size='24' font-family='Arial'%3E${a}%3C/text%3E%3C/svg%3E`}},calculateEstimatedTime(n,e){const t=n/30*60,o=Math.min(.5,e/100*.2),a=Math.max(1,t*(1-o));return Math.ceil(60*a)},initWaitingDriver(){console.log("🔧 [等待司机] 初始化等待司机功能");const n=document.getElementById("waitingDriverFloatBtn"),e=document.getElementById("waitingDriverModalOverlay"),t=document.getElementById("waitingDriverCloseBtn"),o=document.getElementById("waitingDriverContactBtn"),a=document.getElementById("waitingDriverCancelBtn");console.log("🔧 [等待司机] 元素检查:",{floatBtn:!!n,modalOverlay:!!e,closeBtn:!!t,contactBtn:!!o,cancelBtn:!!a}),n?(console.log("✅ [等待司机] 悬浮球元素找到，绑定点击事件"),n.addEventListener("click",()=>{console.log("🚗 [等待司机] 点击悬浮小球"),this.openWaitingDriverModal()})):console.error("❌ [等待司机] 悬浮球元素未找到！"),t&&t.addEventListener("click",()=>{console.log("🚗 [等待司机] 关闭弹窗"),this.closeWaitingDriverModal()}),e&&e.addEventListener("click",n=>{n.target===e&&this.closeWaitingDriverModal()}),o&&o.addEventListener("click",()=>{this.contactDriver()}),a&&a.addEventListener("click",()=>{this.cancelRideOrder()}),this.restoreRideOrder()},createRideOrder(n,e,t){const o=this.generateDriverData(),a=parseFloat(document.getElementById("rideDistance")?.textContent||"2.3"),i=this.calculateEstimatedTime(a,e),r={orderId:"ride_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),status:"waiting",startTime:Date.now(),estimatedSeconds:i,price:e,vehicleType:n,destination:t,driver:o,distance:a};this.saveRideOrder(r);const s=document.getElementById("waitingDriverFloatBtn");return s&&s.classList.add("active"),console.log("✅ [等待司机] 订单已创建",r),r},openWaitingDriverModal(){console.log("🔍 [等待司机] 尝试打开弹窗");const n=this.loadRideOrder();if(console.log("🔍 [等待司机] 订单数据:",n),!n)return console.warn("⚠️ [等待司机] 没有订单数据"),void alert("没有进行中的订单");const e=document.getElementById("waitingDriverModalOverlay");if(!e)return;document.getElementById("waitingDriverName").textContent=n.driver.name,document.getElementById("waitingDriverRating").textContent=n.driver.rating,document.getElementById("waitingDriverVehicle").textContent=n.driver.vehicle,document.getElementById("waitingDriverPlate").textContent=n.driver.plate,document.getElementById("waitingDriverAvatar").src=n.driver.avatar;const t=Math.floor((Date.now()-n.startTime)/1e3),o=Math.max(0,n.estimatedSeconds-t);e.classList.add("active"),setTimeout(()=>{this.startWaitingDriverAnimations(n,o)},500),console.log("✅ [等待司机] 弹窗已打开",{remainingSeconds:o})},closeWaitingDriverModal(){const n=document.getElementById("waitingDriverModalOverlay");n&&n.classList.remove("active"),this.waitingDriverCountdownInterval&&(clearInterval(this.waitingDriverCountdownInterval),this.waitingDriverCountdownInterval=null),this.waitingDriverDistanceInterval&&(clearInterval(this.waitingDriverDistanceInterval),this.waitingDriverDistanceInterval=null),this.waitingDriverShakeTimeout&&(clearTimeout(this.waitingDriverShakeTimeout),this.waitingDriverShakeTimeout=null),console.log("✅ [等待司机] 弹窗已关闭")},startWaitingDriverAnimations(n,e){this.waitingDriverCountdownInterval&&clearInterval(this.waitingDriverCountdownInterval),this.waitingDriverDistanceInterval&&clearInterval(this.waitingDriverDistanceInterval);const t=document.getElementById("waitingDriverEta"),o=document.getElementById("waitingDriverDistanceKm"),a=document.getElementById("waitingDriverDistance"),i=document.getElementById("waitingDriverSpeed"),r=document.getElementById("waitingDriverCarMarker");let s=e;const l=n.distance;r&&s>0&&(r.style.transition=`left ${s}s linear`,setTimeout(()=>{r.style.left="70%"},100));const c=()=>{if(s<=0)return t.textContent="0:00",clearInterval(this.waitingDriverCountdownInterval),void this.onDriverArrived(n);const e=Math.floor(s/60),o=s%60;t.textContent=`${e}:${o.toString().padStart(2,"0")}`,s--};c(),this.waitingDriverCountdownInterval=setInterval(c,1e3);const d=l/e;let p=l,g=0;const m=()=>{g++,p=Math.max(0,l-d*g),(p<=0||g>=e)&&(p=0,clearInterval(this.waitingDriverDistanceInterval)),o.textContent=p.toFixed(1),a.textContent=p.toFixed(1)+" km";const n=Math.round(l/(e/3600)),t=Math.max(5,n+Math.floor(15*Math.random())-7);i.textContent=t};m(),this.waitingDriverDistanceInterval=setInterval(m,1e3)},onDriverArrived(n){console.log("✅ [等待司机] 司机已到达"),n.status="arrived",this.saveRideOrder(n);const e=document.getElementById("waitingDriverCarMarker");e&&(e.style.transition="none",e.style.left="70%");const t=document.getElementById("waitingDriverFloatBtn");t&&(t.classList.add("shake"),this.waitingDriverShakeTimeout=setTimeout(()=>{t.classList.remove("shake")},5e3));const o=document.getElementById("waitingDriverContactBtn"),a=document.getElementById("waitingDriverContactText");if(o&&a){a.textContent="Get In",o.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>\n          </svg>\n          <span id="waitingDriverContactText">Get In</span>\n        ';const n=o.cloneNode(!0);o.parentNode.replaceChild(n,o),n.addEventListener("click",()=>{this.getInCar()})}},contactDriver(){const n=this.loadRideOrder();n&&(alert(`Calling ${n.driver.name}...`),console.log("📞 [等待司机] 联系司机",n.driver))},getInCar(){const e=this.loadRideOrder();e&&"arrived"===e.status?(console.log("🚗 [等待司机] 上车"),e.status="completed",this.saveRideOrder(e),Rl({title:"Ride Started",message:`Have a safe trip to ${e.destination}!`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:4e3}),this.closeWaitingDriverModal(),setTimeout(()=>{this.clearRideOrder();const n=document.getElementById("waitingDriverFloatBtn");n&&n.classList.remove("active","shake")},1e3)):alert("司机还未到达")},cancelRideOrder(){const e=this.loadRideOrder();if(!e)return;const t="arrived"===e.status?"The driver has arrived. Are you sure you want to cancel?":"Are you sure you want to cancel this ride?";if(!confirm(t))return;console.log("❌ [等待司机] 取消订单"),Rl({title:"Ride Cancelled",message:`Your ride to ${e.destination} has been cancelled.`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:4e3}),this.clearRideOrder();const o=document.getElementById("waitingDriverFloatBtn");o&&o.classList.remove("active","shake"),this.closeWaitingDriverModal()},restoreRideOrder(){const n=this.loadRideOrder();if(!n)return;console.log("🔄 [等待司机] 恢复订单状态",n);const e=Math.floor((Date.now()-n.startTime)/1e3),t=Math.max(0,n.estimatedSeconds-e);"completed"!==n.status&&"cancelled"!==n.status&&0!==t||0===t&&"arrived"!==n.status&&(n.status="arrived",this.saveRideOrder(n));const o=document.getElementById("waitingDriverFloatBtn");o&&(o.classList.add("active"),"arrived"===n.status&&o.classList.add("shake")),console.log("✅ [等待司机] 订单状态已恢复",{status:n.status,remainingSeconds:t})},resetRideUI(){const n=document.getElementById("rideDestinationValue");n&&(n.textContent="点击选择目的地",n.classList.add("placeholder"));const e=document.getElementById("rideEstimatedTime");e&&(e.textContent="--");const t=document.querySelectorAll(".ride-vehicle-card");t.forEach(n=>{const e=n.dataset.basePrice,o=n.querySelector(".ride-price-value");o&&(o.textContent=e),n===t[0]?n.classList.add("selected"):n.classList.remove("selected")});document.querySelectorAll(".ride-payment-option").forEach((n,e)=>{0===e?n.classList.add("selected"):n.classList.remove("selected")});const o=document.getElementById("rideBookBtn");o&&(o.disabled=!0,o.textContent="请先选择目的地")},loadCustomAvatars(){try{const n=localStorage.getItem("xMapCustomAvatars");n&&(this.customAvatars=JSON.parse(n),console.log("✅ [头像管理] 已加载自定义头像",this.customAvatars))}catch(n){console.error("❌ [头像管理] 加载自定义头像失败:",n),this.customAvatars={unisex:[],male:[],female:[]}}},saveCustomAvatars(){try{localStorage.setItem("xMapCustomAvatars",JSON.stringify(this.customAvatars)),console.log("✅ [头像管理] 已保存自定义头像")}catch(n){console.error("❌ [头像管理] 保存自定义头像失败:",n)}},addCustomAvatar(n,e){if(!n||!n.trim())return void alert("Please enter at least one URL");const t=n.split(/[,，]/).map(n=>n.trim()).filter(n=>n);if(0===t.length)return void alert("Please enter at least one valid URL");let o=0,a=0,i=0;const r=[];t.forEach((n,t)=>{try{new URL(n)}catch(n){return i++,void r.push(`URL ${t+1}: Invalid format`)}this.customAvatars[e].includes(n)?a++:(this.customAvatars[e].push(n),o++,console.log(`✅ [头像管理] 已添加头像到 ${e}:`,n))}),o>0&&(this.saveCustomAvatars(),this.renderCustomAvatarList());const s=document.getElementById("mapAvatarUrlInput");s&&(s.value="");let l=`✅ Successfully added: ${o}`;a>0&&(l+=`\n⚠️ Skipped (already exists): ${a}`),i>0&&(l+=`\n❌ Failed (invalid): ${i}`,r.length>0&&r.length<=3&&(l+=`\n${r.join("\n")}`)),alert(l)},deleteCustomAvatar(n,e){const t=this.customAvatars[e].indexOf(n);t>-1&&(this.customAvatars[e].splice(t,1),this.saveCustomAvatars(),this.renderCustomAvatarList(),console.log("✅ [头像管理] 已删除头像:",n))},renderCustomAvatarList(){const n=document.getElementById("mapCustomAvatarList");if(!n)return;const e=[];["unisex","male","female"].forEach(n=>{this.customAvatars[n].forEach(t=>{e.push({url:t,category:n})})}),0!==e.length?n.innerHTML=e.map(({url:n,category:e})=>`\n        <div class="map-avatar-item">\n          <img src="${n}" alt="Avatar" class="map-avatar-thumb" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%23ddd%27 width=%27100%27 height=%27100%27/%3E%3C/svg%3E'" />\n          <div class="map-avatar-info">\n            <div class="map-avatar-url" title="${n}">${n}</div>\n            <div class="map-avatar-category-badge">${e}</div>\n          </div>\n          <button class="map-avatar-delete-btn" onclick="MapDatingController.deleteCustomAvatar('${n.replace(/'/g,"\\'")}', '${e}')">\n            <svg viewBox="0 0 24 24">\n              <line x1="18" y1="6" x2="6" y2="18"></line>\n              <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n          </button>\n        </div>\n      `).join(""):n.innerHTML='<div style="text-align: center; padding: 20px; color: #666; font-size: 14px;">No custom avatars added yet</div>'},aiLandmarks:[],customLandmarks:[],landmarkPickMode:!1,tempLandmarkPosition:null,tempLandmarkPreview:null,editingLandmarkId:null,initLandmarkManagement(){console.log("📍 [地标管理] 初始化地标管理功能");document.querySelectorAll(".map-landmark-mode-btn").forEach(n=>{n.addEventListener("click",()=>{const e=n.dataset.mode;this.toggleLandmarkMode(e)})});const n=document.getElementById("mapLandmarkIconInput"),e=document.getElementById("mapLandmarkIconPreview");n&&e&&(n.addEventListener("input",n=>{const t=n.target.value;e.textContent=t||"📍"}),e.addEventListener("click",()=>{n.focus()}));const t=document.getElementById("mapLandmarkColorInput"),o=document.getElementById("mapLandmarkColorPreview");t&&o&&(t.addEventListener("input",n=>{const e=n.target.value;/^#[0-9A-Fa-f]{6}$/.test(e)&&(o.style.backgroundColor=e)}),o.addEventListener("click",()=>{const n=document.createElement("input");n.type="color",n.value=t.value||"#ff6b6b",n.style.opacity="0",n.style.position="absolute",document.body.appendChild(n),n.addEventListener("change",e=>{const a=e.target.value;t.value=a,o.style.backgroundColor=a,document.body.removeChild(n)}),n.click()}));const a=document.getElementById("mapLandmarkPickBtn");a&&a.addEventListener("click",()=>{this.togglePickMode()});const i=document.getElementById("mapLandmarkNameInput"),r=document.getElementById("mapLandmarkSaveBtn");i&&r&&i.addEventListener("input",()=>{const n=i.value.trim().length>0,e=null!==this.tempLandmarkPosition;r.disabled=!(n&&e)}),r&&r.addEventListener("click",()=>{this.saveLandmark()});const s=document.getElementById("mapLandmarkGenerateBtn");s&&s.addEventListener("click",()=>{this.generateLandmarksWithAI()});const l=document.getElementById("mapLandmarkSelectAllBtn");l&&l.addEventListener("click",()=>{this.selectAllLandmarks()});const c=document.getElementById("mapLandmarkBatchDeleteBtn");c&&c.addEventListener("click",()=>{this.batchDeleteLandmarks()}),this.loadCustomLandmarks(),this.loadLandmarkList()},toggleLandmarkMode(n){const e=document.querySelectorAll(".map-landmark-mode-btn"),t=document.querySelector(".map-landmark-custom-form"),o=document.querySelector(".map-landmark-ai-form");e.forEach(e=>{e.dataset.mode===n?e.classList.add("active"):e.classList.remove("active")}),"custom"===n?(t?.classList.add("active"),o?.classList.remove("active")):(t?.classList.remove("active"),o?.classList.add("active"))},togglePickMode(){this.landmarkPickMode=!this.landmarkPickMode;const n=document.getElementById("mapLandmarkPickHint"),e=(document.getElementById("mapLandmarkPickBtn"),document.getElementById("mapAppSettingsModal")),t=document.querySelector(".map-area");if(this.landmarkPickMode){e&&(e.style.display="none"),n&&(n.style.display="flex",n.classList.add("active")),t&&t.classList.add("picking-landmark");const o=document.querySelector(".map-canvas");o?(o.removeEventListener("click",this.handleMapClickForLandmark),o.addEventListener("click",this.handleMapClickForLandmark.bind(this)),console.log("✅ [地标管理] 已绑定点击事件到.map-canvas")):console.error("❌ [地标管理] 找不到.map-canvas元素"),console.log("📍 [地标管理] 进入地图选点模式 - 用户可以看到完整地图")}else{n&&(n.style.display="none",n.classList.remove("active")),t&&t.classList.remove("picking-landmark");const o=document.querySelector(".map-canvas");o&&o.removeEventListener("click",this.handleMapClickForLandmark),e&&this.tempLandmarkPosition&&(e.style.display="flex"),console.log("📍 [地标管理] 退出地图选点模式")}},handleMapClickForLandmark(n){if(!this.landmarkPickMode)return;const e=document.getElementById("mapCanvasBg");if(!e)return void console.error("❌ [地标管理] 找不到mapCanvasBg元素");const t=e.getBoundingClientRect(),o=n.clientX-t.left,a=n.clientY-t.top,i=e.width/t.width,r=e.height/t.height,s=o*i,l=a*r;console.log("📍 [地标管理] 点击坐标信息:",{"屏幕坐标":{x:n.clientX,y:n.clientY},"Canvas相对坐标":{clickX:o,clickY:a},"Canvas实际尺寸":{width:e.width,height:e.height},"CSS显示尺寸":{width:t.width,height:t.height},"缩放比例":{scaleX:i,scaleY:r},"最终坐标":{canvasX:s,canvasY:l}}),(s<0||s>e.width||l<0||l>e.height)&&console.warn("⚠️ [地标管理] 点击位置超出地图范围"),this.tempLandmarkPosition={x:Math.round(s),y:Math.round(l)},console.log("✅ [地标管理] 成功选中位置:",this.tempLandmarkPosition);const c=document.getElementById("mapLandmarkIconInput"),d=document.getElementById("mapLandmarkColorInput");this.tempLandmarkPreview={id:"temp_preview",x:this.tempLandmarkPosition.x,y:this.tempLandmarkPosition.y,name:"Preview",emoji:c?c.value:"📍",color:d?d.value:"#ff6b6b"},this.renderMapLandmarks(),console.log("✅ [地标管理] 已在地图上显示临时地标预览");const p=document.getElementById("mapLandmarkPositionDisplay");p&&(p.textContent=`Position: (${this.tempLandmarkPosition.x}, ${this.tempLandmarkPosition.y})`,p.classList.add("has-position"));const g=document.getElementById("mapLandmarkNameInput"),m=document.getElementById("mapLandmarkSaveBtn");if(g&&m){const n=g.value.trim().length>0;m.disabled=!n}this.togglePickMode()},cancelLandmarkPick(){if(console.log("📍 [地标管理] 用户取消选点"),this.landmarkPickMode){this.tempLandmarkPosition=null,this.tempLandmarkPreview=null,this.renderMapLandmarks(),this.landmarkPickMode=!0,this.togglePickMode();const n=document.getElementById("mapAppSettingsModal");n&&(n.style.display="flex")}},async saveLandmark(){const e=document.getElementById("mapLandmarkNameInput"),t=document.getElementById("mapLandmarkDescInput"),o=document.getElementById("mapLandmarkIconInput"),a=document.getElementById("mapLandmarkColorInput");if(!e||!this.tempLandmarkPosition)return void console.error("❌ [地标管理] 缺少必要信息");const i={id:this.editingLandmarkId||`landmark_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:e.value.trim(),description:t?.value.trim()||"",icon:o?.value||"📍",color:a?.value||"#ff6b6b",x:this.tempLandmarkPosition.x,y:this.tempLandmarkPosition.y,createdAt:this.editingLandmarkId?void 0:(new Date).toISOString(),updatedAt:(new Date).toISOString()};try{if(this.editingLandmarkId){const n=this.customLandmarks.findIndex(n=>n.id===this.editingLandmarkId);-1!==n&&(this.customLandmarks[n]={...this.customLandmarks[n],...i}),console.log("✅ [地标管理] 更新地标:",i.name)}else this.customLandmarks.push(i),console.log("✅ [地标管理] 添加地标:",i.name);const e=n.currentAccountId||"main";localStorage.setItem(`xMapCustomLandmarks_${e}`,JSON.stringify(this.customLandmarks)),this.resetLandmarkForm(),this.loadLandmarkList(),this.renderMapLandmarks(),alert(this.editingLandmarkId?"Landmark updated successfully!":"Landmark added successfully!")}catch(n){console.error("❌ [地标管理] 保存地标失败:",n),alert("Failed to save landmark. Please try again.")}},resetLandmarkForm(){const n=document.getElementById("mapLandmarkNameInput"),e=document.getElementById("mapLandmarkDescInput"),t=document.getElementById("mapLandmarkIconInput"),o=document.getElementById("mapLandmarkColorInput"),a=document.getElementById("mapLandmarkIconPreview"),i=document.getElementById("mapLandmarkColorPreview"),r=document.getElementById("mapLandmarkPositionDisplay"),s=document.getElementById("mapLandmarkSaveBtn");n&&(n.value=""),e&&(e.value=""),t&&(t.value="📍"),o&&(o.value="#ff6b6b"),a&&(a.textContent="📍"),i&&(i.style.backgroundColor="#ff6b6b"),r&&(r.textContent="No position selected",r.classList.remove("has-position")),s&&(s.disabled=!0),this.tempLandmarkPosition=null,this.tempLandmarkPreview=null,this.editingLandmarkId=null},loadCustomLandmarks(){try{const e=n.currentAccountId||"main",t=localStorage.getItem(`xMapCustomLandmarks_${e}`);t?(this.customLandmarks=JSON.parse(t),console.log(`📍 [地标管理] 账户${e}加载了 ${this.customLandmarks.length} 个自定义地标`)):this.customLandmarks=[]}catch(n){console.error("❌ [地标管理] 加载地标失败:",n),this.customLandmarks=[]}},loadLandmarkList(){const n=document.getElementById("mapLandmarkList");if(!n)return;if(0===this.customLandmarks.length){n.innerHTML='\n          <div style="padding: 40px 20px; text-align: center; color: #8e8e8e;">\n            <div style="font-size: 48px; margin-bottom: 12px;">📍</div>\n            <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">No landmarks yet</div>\n            <div style="font-size: 13px;">Add custom landmarks or generate with AI</div>\n          </div>\n        ';const e=document.getElementById("mapLandmarkBatchActions");return void(e&&e.classList.remove("active"))}const e=document.getElementById("mapLandmarkBatchActions");e&&e.classList.add("active"),n.innerHTML=this.customLandmarks.map(n=>`\n        <div class="map-landmark-item" data-id="${n.id}">\n          <div class="map-landmark-checkbox" data-id="${n.id}"></div>\n          <div class="map-landmark-icon-display" style="background-color: ${n.color}">\n            ${n.icon}\n          </div>\n          <div class="map-landmark-info">\n            <div class="map-landmark-name">${n.name}</div>\n            ${n.description?`<div class="map-landmark-desc">${n.description}</div>`:""}\n            <div class="map-landmark-position-badge">📍 (${n.x}, ${n.y})</div>\n          </div>\n          <div class="map-landmark-actions">\n            <button class="map-landmark-edit-btn" data-id="${n.id}">\n              <svg viewBox="0 0 24 24">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n              </svg>\n            </button>\n            <button class="map-landmark-delete-btn" data-id="${n.id}">\n              <svg viewBox="0 0 24 24">\n                <polyline points="3 6 5 6 21 6"></polyline>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                <line x1="10" y1="11" x2="10" y2="17"></line>\n                <line x1="14" y1="11" x2="14" y2="17"></line>\n              </svg>\n            </button>\n          </div>\n        </div>\n      `).join(""),this.bindLandmarkListEvents()},bindLandmarkListEvents(){document.querySelectorAll(".map-landmark-checkbox").forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const t=n.dataset.id;this.toggleLandmarkSelection(t)})});document.querySelectorAll(".map-landmark-edit-btn").forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const t=n.dataset.id;this.editLandmark(t)})});document.querySelectorAll(".map-landmark-delete-btn").forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const t=n.dataset.id;this.deleteLandmark(t)})})},toggleLandmarkSelection(n){const e=document.querySelector(`.map-landmark-checkbox[data-id="${n}"]`),t=document.querySelector(`.map-landmark-item[data-id="${n}"]`);if(!e||!t)return;e.classList.contains("checked")?(e.classList.remove("checked"),t.classList.remove("selected")):(e.classList.add("checked"),t.classList.add("selected")),this.updateBatchActionsState()},selectAllLandmarks(){const n=document.querySelectorAll(".map-landmark-checkbox"),e=Array.from(n).every(n=>n.classList.contains("checked"));n.forEach(n=>{const t=n.closest(".map-landmark-item");e?(n.classList.remove("checked"),t?.classList.remove("selected")):(n.classList.add("checked"),t?.classList.add("selected"))}),this.updateBatchActionsState()},updateBatchActionsState(){const n=document.querySelectorAll(".map-landmark-checkbox.checked").length,e=document.getElementById("mapLandmarkSelectedCount"),t=document.getElementById("mapLandmarkBatchDeleteBtn");e&&(e.textContent=`${n} selected`),t&&(t.disabled=0===n)},editLandmark(n){const e=this.customLandmarks.find(e=>e.id===n);if(!e)return void console.error("❌ [地标管理] 未找到地标:",n);this.toggleLandmarkMode("custom");const t=document.getElementById("mapLandmarkNameInput"),o=document.getElementById("mapLandmarkDescInput"),a=document.getElementById("mapLandmarkIconInput"),i=document.getElementById("mapLandmarkColorInput"),r=document.getElementById("mapLandmarkIconPreview"),s=document.getElementById("mapLandmarkColorPreview"),l=document.getElementById("mapLandmarkPositionDisplay"),c=document.getElementById("mapLandmarkSaveBtn");t&&(t.value=e.name),o&&(o.value=e.description||""),a&&(a.value=e.icon),i&&(i.value=e.color),r&&(r.textContent=e.icon),s&&(s.style.backgroundColor=e.color),this.tempLandmarkPosition={x:e.x,y:e.y},l&&(l.textContent=`Position: (${e.x}, ${e.y})`,l.classList.add("has-position")),this.editingLandmarkId=n,c&&(c.disabled=!1,c.textContent="Update Landmark");const d=document.querySelector(".map-landmark-section");d&&d.scrollIntoView({behavior:"smooth",block:"start"}),console.log("📍 [地标管理] 编辑地标:",e.name)},deleteLandmark(e){const t=this.customLandmarks.find(n=>n.id===e);if(!t)return;if(!confirm(`Delete landmark "${t.name}"?`))return;this.customLandmarks=this.customLandmarks.filter(n=>n.id!==e);const o=n.currentAccountId||"main";localStorage.setItem(`xMapCustomLandmarks_${o}`,JSON.stringify(this.customLandmarks)),this.loadLandmarkList(),this.renderMapLandmarks(),console.log("🗑️ [地标管理] 删除地标:",t.name)},batchDeleteLandmarks(){const e=document.querySelectorAll(".map-landmark-checkbox.checked"),t=Array.from(e).map(n=>n.dataset.id);if(0===t.length)return;if(!confirm(`Delete ${t.length} landmarks?`))return;this.customLandmarks=this.customLandmarks.filter(n=>!t.includes(n.id));const o=n.currentAccountId||"main";localStorage.setItem(`xMapCustomLandmarks_${o}`,JSON.stringify(this.customLandmarks)),this.loadLandmarkList(),this.renderMapLandmarks(),console.log(`🗑️ [地标管理] 批量删除了 ${t.length} 个地标`)},renderMapLandmarks(){if(console.log("🗺️ [地标管理] 重新绘制地图地标，当前地标数量:",this.customLandmarks.length),!n.MapGenerator)return void console.warn("⚠️ [地标管理] MapGenerator未初始化，无法渲染地标");console.log("📍 [地标管理] 合并地标数据:",{"AI地标":this.aiLandmarks.length,"自定义地标":this.customLandmarks.length,"临时预览":this.tempLandmarkPreview?1:0});const e=[...this.aiLandmarks,...this.customLandmarks];this.tempLandmarkPreview&&e.push(this.tempLandmarkPreview),n.MapGenerator.landmarks=e,console.log("📍 [地标管理] 已同步地标到MapGenerator:",{"最终总数":n.MapGenerator.landmarks.length}),"function"==typeof n.MapGenerator.redraw?(n.MapGenerator.redraw(),console.log("✅ [地标管理] 地图canvas已重新绘制")):(console.warn("⚠️ [地标管理] MapGenerator没有redraw方法，尝试手动重绘"),n.MapGenerator.ctx&&(n.MapGenerator.drawLandmarks(),console.log("✅ [地标管理] 地标canvas已手动重绘"))),this.renderLandmarkLabels(),console.log("✅ [地标管理] 地标label已重新渲染")},async generateLandmarksWithAI(){const n=document.getElementById("mapLandmarkAiInput"),e=document.getElementById("mapLandmarkGenerateBtn");if(!n||!e)return;const t=n.value.trim();e.disabled=!0,e.textContent="Generating...";try{console.log("🤖 [地标管理] 开始AI生成地标"),await this.generateMapDatingData(!1,!0,t),this.loadCustomLandmarks(),this.loadLandmarkList(),this.renderMapLandmarks(),alert("Landmarks generated successfully!"),n.value=""}catch(n){console.error("❌ [地标管理] AI生成地标失败:",n),alert("Failed to generate landmarks. Please try again.")}finally{e.disabled=!1,e.textContent="Generate Landmarks with AI"}},openReportModal(){if(!this.currentChatUser)return void console.error("❌ [举报系统] 没有当前聊天用户");const n=document.getElementById("mapChatMoreMenu");n&&n.classList.remove("show");const e=document.getElementById("mapReportOverlay"),t=document.getElementById("mapReportModal");if(!e||!t)return void console.error("❌ [举报系统] 举报弹窗元素未找到");const o=document.getElementById("mapReportUserAvatar"),a=document.getElementById("mapReportUserNickname"),i=document.getElementById("mapReportUserHandle");o&&(o.src=this.currentChatUser.avatar||""),a&&(a.textContent=this.currentChatUser.nickname||"User"),i&&(i.textContent=`@${this.currentChatUser.handle||this.currentChatUser.nickname?.toLowerCase()||"user"}`);document.querySelectorAll('input[name="reportReason"]').forEach(n=>n.checked=!1);const r=document.getElementById("mapReportDescription");r&&(r.value=""),e.classList.add("show"),t.classList.add("show"),console.log(`🚨 [举报系统] 打开举报弹窗，被举报用户: ${this.currentChatUser.nickname}`)},closeReportModal(){const n=document.getElementById("mapReportOverlay"),e=document.getElementById("mapReportModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},async submitReport(){if(!this.currentChatUser)return void console.error("❌ [举报系统] 没有当前聊天用户");const n=document.querySelectorAll('input[name="reportReason"]:checked'),e=Array.from(n).map(n=>n.value);if(0===e.length)return void alert("Please select at least one reason for reporting");const t=document.getElementById("mapReportDescription"),o=t?t.value.trim():"";console.log(`🚨 [举报系统] 提交举报 - 用户: ${this.currentChatUser.nickname}, 理由: ${e.join(", ")}`);const a=this.getChatHistory(this.currentChatUser.id).slice(-10);this.closeReportModal(),this.markChatAsReported(this.currentChatUser.id),this.addSystemMessage("Your report has been submitted and is under review. You cannot send messages while the review is in progress."),this.disableChatInput();try{const n={id:`report_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,reporterId:"current_user",reportedUser:this.currentChatUser,reasons:e,description:o,chatHistory:a,timestamp:(new Date).toISOString(),status:"pending"};let t=localStorage.getItem("xMapPendingReports");t=t?JSON.parse(t):[],t.push(n),localStorage.setItem("xMapPendingReports",JSON.stringify(t)),console.log("🚨 [举报系统] 举报已加入待处理队列，将在下次第十六情景中处理")}catch(n){console.error("❌ [举报系统] 添加举报到队列失败:",n)}},markChatAsReported(n){try{let e=localStorage.getItem("xMapReportedChats");e=e?JSON.parse(e):{},e[n]={reportedAt:(new Date).toISOString(),status:"pending"},localStorage.setItem("xMapReportedChats",JSON.stringify(e)),console.log(`✅ [举报系统] 已标记聊天为举报状态: ${n}`),console.log("🔍 [举报系统] 当前所有举报记录:",JSON.stringify(e,null,2));const t=localStorage.getItem("xMapReportedChats");console.log("🔍 [举报系统] 验证localStorage存储:",t)}catch(n){console.error("❌ [举报系统] 标记聊天失败:",n)}},addSystemMessage(n){const e=document.getElementById("mapChatMessages");if(!e)return;const t=document.createElement("div");t.className="map-chat-system-message",t.innerHTML=`\n        <div class="map-chat-system-message-icon">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="12" cy="12" r="10"></circle>\n            <line x1="12" y1="8" x2="12" y2="12"></line>\n            <line x1="12" y1="16" x2="12.01" y2="16"></line>\n          </svg>\n        </div>\n        <div class="map-chat-system-message-text">${n}</div>\n      `,e.appendChild(t),e.scrollTop=e.scrollHeight},disableChatInput(){const n=document.getElementById("mapChatInput"),e=document.getElementById("mapChatSendBtn");n&&(n.disabled=!0,n.placeholder="Chat unavailable during review process"),e&&(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed")},enableChatInput(){const n=document.getElementById("mapChatInput"),e=document.getElementById("mapChatSendBtn");n&&(n.disabled=!1,n.placeholder="Type a message..."),e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer")},checkAndUpdateChatInputState(n){try{const e=localStorage.getItem("xMapReportedChats");if(console.log(`🔍 [举报系统] 检查用户 ${n} 的举报状态`),console.log("🔍 [举报系统] localStorage中的数据:",e),!e)return console.log("✅ [举报系统] 没有举报记录，启用输入框"),void this.enableChatInput();const t=JSON.parse(e);if(console.log("🔍 [举报系统] 解析后的举报记录:",t),t[n]&&"pending"===t[n].status){this.disableChatInput(),console.log(`🚨 [举报系统] ${n} 正在审理中，输入框已禁用`);const e=document.getElementById("mapChatMessages");if(e){e.querySelector(".map-chat-system-message")||this.addSystemMessage("Your report has been submitted and is under review. You cannot send messages while the review is in progress.")}}else this.enableChatInput()}catch(n){console.error("❌ [举报系统] 检查举报状态失败:",n),this.enableChatInput()}},getChatHistory(n){try{if(this.chatMessages[n])return this.chatMessages[n];const e=`xMapChatHistory_${n}`,t=localStorage.getItem(e);return t?JSON.parse(t):[]}catch(n){return console.error("❌ [举报系统] 获取聊天记录失败:",n),[]}},async generateReportNotification(t,o,a){try{console.log("🚨 [举报系统] 生成提醒，原始reportData:",JSON.stringify(t,null,2));const i={id:`report-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"report",timestamp:(new Date).toISOString(),isRead:!1,reportedUser:t.reportedUser,isApproved:o,reason:a,title:o?"Report Approved":"Report Declined",fullReportData:{reasons:t.reasons||[],description:t.description||"",reportedAt:t.timestamp||(new Date).toISOString()}};console.log("🚨 [举报系统] 创建的notification:",JSON.stringify(i,null,2));const r=e();if(!r)return void console.error("❌ [举报系统] 无法获取数据库");const s=`mapDatingData_${n.currentAccountId||"main"}`,l=await r.xMapDatingData.get(s);l&&(l.notifications||(l.notifications=[]),l.notifications.push(i),await r.xMapDatingData.put(l),console.log("✅ [举报系统] 已保存notification到数据库")),this.updateNotificationBadge(),this.enableChatInput(),this.unmarkChatAsReported(t.reportedUser.id),console.log("✅ [举报系统] 已生成举报结果提醒")}catch(n){console.error("❌ [举报系统] 生成提醒失败:",n)}},unmarkChatAsReported(n){try{let e=localStorage.getItem("xMapReportedChats");e=e?JSON.parse(e):{},delete e[n],localStorage.setItem("xMapReportedChats",JSON.stringify(e)),console.log(`✅ [举报系统] 已移除举报标记: ${n}`)}catch(n){console.error("❌ [举报系统] 移除举报标记失败:",n)}},async generateUserReportedNotification(t,o,a,i,r,s){try{console.log(`🚨 [被举报系统] 生成被举报提醒，举报者: ${t.nickname}`);const l={id:`user-reported-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"user_reported",timestamp:(new Date).toISOString(),isRead:!1,reporterUser:t,isApproved:r,severity:i,judgementReason:s,title:r?"You Have Been Reported":"Report Against You Was Declined",fullReportData:{reasons:o,description:a,reportedAt:(new Date).toISOString()}};console.log("🚨 [被举报系统] 创建的notification:",JSON.stringify(l,null,2));const c=e();if(!c)return void console.error("❌ [被举报系统] 无法获取数据库");const d=`mapDatingData_${n.currentAccountId||"main"}`,p=await c.xMapDatingData.get(d);p&&(p.notifications||(p.notifications=[]),p.notifications.push(l),await c.xMapDatingData.put(p),console.log("✅ [被举报系统] 已保存notification到数据库")),this.updateNotificationBadge(),console.log("✅ [被举报系统] 已生成被举报提醒")}catch(n){console.error("❌ [被举报系统] 生成提醒失败:",n)}},openReportDetailModal(n){const e=document.getElementById("mapReportDetailOverlay"),t=document.getElementById("mapReportDetailModal");if(!e||!t)return void console.error("❌ [举报详情] 找不到弹窗元素");this.currentReportNotification=n,console.log("📋 [举报详情] 打开弹窗，notification数据:",JSON.stringify(n,null,2));const o=document.getElementById("mapReportDetailBadge"),a=(document.getElementById("mapReportDetailBadgeIcon"),document.getElementById("mapReportDetailBadgeText")),i=document.getElementById("mapReportDetailUserAvatar"),r=document.getElementById("mapReportDetailUserNickname"),s=document.getElementById("mapReportDetailUserHandle"),l=document.getElementById("mapReportDetailReasons"),c=document.getElementById("mapReportDetailDescSection"),d=document.getElementById("mapReportDetailDescription"),p=document.getElementById("mapReportDetailReason"),g=document.getElementById("mapReportDetailTime");if(o&&a&&(o.className="map-report-detail-badge "+(n.isApproved?"approved":"declined"),a.textContent=n.isApproved?"Report Approved":"Report Declined"),i&&(i.src=n.reportedUser.avatar||""),r&&(r.textContent=n.reportedUser.nickname||"User"),s&&(s.textContent=`@${n.reportedUser.handle||"user"}`),l){const e={inappropriate_content:"Inappropriate Content",harassment:"Harassment",abuse:"Verbal Abuse",spam:"Spam",other:"Other"},t=n.fullReportData?.reasons||[];console.log("📋 [举报详情] 举报理由数组:",t),t.length>0?l.innerHTML=t.map(n=>`<div class="map-report-detail-reason-tag">${e[n]||n}</div>`).join(""):l.innerHTML='<div class="map-report-detail-reason-tag">No specific reason provided</div>'}if(n.fullReportData?.description&&n.fullReportData.description.trim()?(c&&(c.style.display="block"),d&&(d.textContent=n.fullReportData.description)):c&&(c.style.display="none"),p&&(p.textContent=n.reason||"No reason provided"),g){const e=n.fullReportData?.reportedAt||n.timestamp;if(console.log("📋 [举报详情] 举报时间:",e),e)try{const n=new Date(e);g.textContent=n.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){console.error("❌ [举报详情] 时间格式化失败:",n),g.textContent=e}else g.textContent="Time not available"}e.classList.add("show"),t.classList.add("show"),console.log("📋 [举报详情] 已打开详情弹窗")},closeReportDetailModal(){const n=document.getElementById("mapReportDetailOverlay"),e=document.getElementById("mapReportDetailModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},async handleReportAcknowledge(){const t=this.currentReportNotification;if(!t)return console.warn("⚠️ [举报结算] 没有当前notification数据"),void this.closeReportDetailModal();if(t.rewardClaimed)return console.log("⚠️ [举报结算] 奖励已领取，跳过"),void this.closeReportDetailModal();console.log(`💰 [举报结算] 开始处理结算，类型: ${t.type}, 是否成立: ${t.isApproved}`);try{if(await Mt(),"report"===t.type)if(t.isApproved){const e=t.fullReportData?.severity||"moderate";let o=10;if("severe"===e?o=15:"minor"===e&&(o=5),It.isActivated){It.balance+=100;const n={id:"report_reward_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:`Approved Report Reward - ${t.reportedUser?.nickname||"User"}`,amount:100,timestamp:(new Date).toISOString(),type:"report_reward"};It.transactions.unshift(n),await Tt(),console.log(`✅ [举报结算] 已添加100金币，当前余额: $${It.balance.toFixed(2)}`)}else console.warn("⚠️ [举报结算] 钱包未激活，跳过金币奖励");this.addAuthenticityScore(o,`举报成功（${e}）`),Rl({title:"Report Approved",message:It.isActivated?`+$100.00, Authenticity +${o}. Balance: $${It.balance.toFixed(2)}`:`Authenticity +${o}. Activate wallet to receive rewards.`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:4e3}),console.log("✅ [举报结算] 举报成功奖励已发放")}else{const e=Math.floor(11*Math.random())+10;this.subtractAuthenticityScore(e,"恶意举报"),t.reportedUser?.id&&(this.checkAndUpdateChatInputState(t.reportedUser.id),console.log(`✅ [举报结算] 已解封用户 ${t.reportedUser.id} 的聊天输入框`)),Rl({title:"Report Declined",message:`Authenticity -${e}. False reports harm your credibility.`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:4e3}),console.log("⚠️ [举报结算] 恶意举报惩罚已执行")}else if("user_reported"===t.type)if(t.isApproved){const e=t.severity||"moderate";let o=15;"severe"===e?o=Math.floor(11*Math.random())+20:"moderate"===e?o=Math.floor(11*Math.random())+10:"minor"===e&&(o=Math.floor(6*Math.random())+5),this.subtractAuthenticityScore(o,`AI举报成立（${e}）`);let a="";if(It.isActivated){const n=100;if(It.balance>=n){It.balance-=n;const e={id:"penalty_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:`Violation Penalty - Reported by ${t.reporterUser?.nickname||"User"}`,amount:-n,timestamp:(new Date).toISOString(),type:"violation_penalty"};It.transactions.unshift(e),await Tt(),a=`-$${n.toFixed(2)}, `,console.log(`💰 [举报结算] 已扣除$${n}，当前余额: $${It.balance.toFixed(2)}`)}else{const n=It.balance;It.balance=0;const e={id:"penalty_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:`Violation Penalty (Insufficient Funds) - Reported by ${t.reporterUser?.nickname||"User"}`,amount:-n,timestamp:(new Date).toISOString(),type:"violation_penalty"};It.transactions.unshift(e),await Tt(),a=`-$${n.toFixed(2)} (余额不足), `,console.warn(`⚠️ [举报结算] 余额不足，已扣除全部余额$${n}`)}}const i=this.incrementReportedCount();console.log(`🚨 [被举报计数] 当前累计被举报次数: ${i}`),Rl({title:"Violation Confirmed",message:`${a}Authenticity -${o}. Violations: ${i}/5`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:5e3}),console.log("⚠️ [举报结算] 用户被举报成立，已扣除真实度和金币"),0===i&&setTimeout(()=>{Rl({title:"Account Suspended",message:"Map Dating access suspended for 12 hours due to repeated violations.",avatar:n.userProfileData?.avatar,leftIcon:"x",duration:6e3})},1e3)}else{const e=Math.floor(6*Math.random())+5;this.addAuthenticityScore(e,"AI恶意举报"),Rl({title:"Report Unfounded",message:`Authenticity +${e}. You were falsely reported.`,avatar:n.userProfileData?.avatar,leftIcon:"x",duration:4e3}),console.log("✅ [举报结算] AI恶意举报，已增加真实度")}t.rewardClaimed=!0;const o=e();if(!o)return void console.error("❌ [举报结算] 无法获取数据库");const a=`mapDatingData_${n.currentAccountId||"main"}`,i=await o.xMapDatingData.get(a);if(i&&i.notifications){const n=i.notifications.findIndex(n=>n.id===t.id);-1!==n?(i.notifications[n]=t,await o.xMapDatingData.put(i),console.log(`✅ [举报结算] 已标记notification ${t.id} 为已领取`)):console.warn(`⚠️ [举报结算] 未找到notification ${t.id}，无法更新`)}else console.warn("⚠️ [举报结算] 未找到数据库记录，无法更新notification")}catch(e){console.error("❌ [举报结算] 处理失败:",e),Rl({title:"Error",message:"Failed to process report settlement.",avatar:n.userProfileData?.avatar,leftIcon:"x",duration:3e3})}this.closeReportDetailModal()},openUserReportedDetailModal(n){const e=document.getElementById("mapReportDetailOverlay"),t=document.getElementById("mapReportDetailModal");if(!e||!t)return void console.error("❌ [被举报详情] 找不到弹窗元素");this.currentReportNotification=n,console.log("🚨 [被举报详情] 打开弹窗，notification数据:",JSON.stringify(n,null,2));const o=document.getElementById("mapReportDetailBadge"),a=(document.getElementById("mapReportDetailBadgeIcon"),document.getElementById("mapReportDetailBadgeText")),i=document.getElementById("mapReportDetailUserAvatar"),r=document.getElementById("mapReportDetailUserNickname"),s=document.getElementById("mapReportDetailUserHandle"),l=document.getElementById("mapReportDetailReasons"),c=document.getElementById("mapReportDetailDescSection"),d=document.getElementById("mapReportDetailDescription"),p=document.getElementById("mapReportDetailReason"),g=document.getElementById("mapReportDetailTime"),m=t.querySelector(".map-report-detail-title");m&&(m.textContent=n.isApproved?"You Have Been Reported":"Report Was Declined"),o&&a&&(o.className="map-report-detail-badge "+(n.isApproved?"approved":"declined"),a.textContent=n.isApproved?"Violation Confirmed":"Report Unfounded"),i&&(i.src=n.reporterUser.avatar||""),r&&(r.textContent=n.reporterUser.nickname||"User"),s&&(s.textContent=`@${n.reporterUser.handle||"user"}`);const x=t.querySelector(".map-report-detail-section-title");if(x&&(x.textContent="Reported By"),l){const e={inappropriate_content:"Inappropriate Content",harassment:"Harassment",abuse:"Verbal Abuse",spam:"Spam",threats:"Threats",discrimination:"Discrimination",other:"Other"},t=n.fullReportData?.reasons||[];console.log("🚨 [被举报详情] 违规理由数组:",t),t.length>0?l.innerHTML=t.map(n=>`<div class="map-report-detail-reason-tag">${e[n]||n}</div>`).join(""):l.innerHTML='<div class="map-report-detail-reason-tag">No specific reason provided</div>'}if(n.fullReportData?.description&&n.fullReportData.description.trim()?(c&&(c.style.display="block"),d&&(d.textContent=n.fullReportData.description)):c&&(c.style.display="none"),p&&(p.textContent=n.judgementReason||"No reason provided"),g){const e=n.fullReportData?.reportedAt||n.timestamp;if(console.log("🚨 [被举报详情] 举报时间:",e),e)try{const n=new Date(e);g.textContent=n.toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){console.error("❌ [被举报详情] 时间格式化失败:",n),g.textContent=e}else g.textContent="Time not available"}e.classList.add("show"),t.classList.add("show"),console.log("🚨 [被举报详情] 已打开详情弹窗")},async loadAndRenderNotificationsList(){try{const t=e();if(!t)return console.error("❌ [提醒加载] 无法获取数据库"),void this.renderNotificationsList([]);const o=`mapDatingData_${n.currentAccountId||"main"}`,a=await t.xMapDatingData.get(o);let i=[];if(a&&a.notifications)i=a.notifications,console.log(`📖 [提醒加载] 从数据库加载了 ${i.length} 条通知`);else{const n=localStorage.getItem("xMapNotifications");n?(i=JSON.parse(n),console.log(`📖 [提醒加载] 从localStorage加载了 ${i.length} 条通知（旧数据）`),a&&i.length>0&&(a.notifications=i,await t.xMapDatingData.put(a),console.log("✅ [提醒迁移] 已将localStorage中的通知迁移到数据库"),localStorage.removeItem("xMapNotifications"))):console.log("📖 [提醒加载] 没有找到任何通知数据")}i.sort((n,e)=>new Date(e.timestamp)-new Date(n.timestamp)),this.renderNotificationsList(i)}catch(n){console.error("❌ [提醒加载] 加载提醒列表失败:",n),this.renderNotificationsList([])}},renderNotificationsList(n){const e=document.getElementById("mapNotificationsList"),t=document.getElementById("mapNotificationsEmpty");if(!e)return void console.error("❌ [提醒渲染] 找不到提醒列表容器 #mapNotificationsList");if(e.innerHTML="",0===n.length)return void(t&&(t.style.display="flex"));t&&(t.style.display="none"),console.log(`📝 [提醒渲染] 开始渲染 ${n.length} 条提醒`),n.forEach((n,t)=>{const o=document.createElement("div");o.className="map-notification-item "+(n.isRead?"":"unread");const a=this.formatNotificationTime(n.timestamp);let i="",r="",s="";if("interested"===n.type){i="New Interest",r=`${n.fromUser.nickname} is interested in your profile`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>\n          </svg>'}else if("message"===n.type){const e=n.fromUser;i="New Message",r=n.messages&&n.messages.length>0?`${e.nickname}: ${n.messages[n.messages.length-1]}`:`${e.nickname} sent you a message`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n          </svg>'}else if("follow"===n.type){i="New Follower",r=`${n.fromUser.nickname} started following you`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n            <circle cx="8.5" cy="7" r="4"></circle>\n            <line x1="20" y1="8" x2="20" y2="14"></line>\n            <line x1="23" y1="11" x2="17" y2="11"></line>\n          </svg>'}else if("like"===n.type){i="New Like",r=`${n.fromUser.nickname} liked your post`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>\n          </svg>'}else if("report"===n.type)i=n.title||"Report Result",r=n.isApproved?`Your report about ${n.reportedUser.nickname} has been reviewed: ${n.reason}`:`Your report about ${n.reportedUser.nickname} was declined: ${n.reason}`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n            <line x1="12" y1="9" x2="12" y2="13"></line>\n            <line x1="12" y1="17" x2="12.01" y2="17"></line>\n          </svg>';else if("user_reported"===n.type)i=n.title||"You Have Been Reported",r=n.isApproved?`${n.reporterUser.nickname} reported you for violating guidelines. Severity: ${n.severity}`:`${n.reporterUser.nickname} reported you, but it was determined to be unfounded.`,s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n            <line x1="12" y1="9" x2="12" y2="13"></line>\n            <line x1="12" y1="17" x2="12.01" y2="17"></line>\n          </svg>';else{const e=n.fromUser;i="Notification",r=n.content||(e?`${e.nickname} interacted with you`:"You have a new notification"),s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>\n            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>\n          </svg>'}console.log(`  ├─ [${t+1}] ${n.type}: ${r.substring(0,50)}...`),o.innerHTML=`\n          <div class="map-notification-icon">\n            ${s}\n          </div>\n          <div class="map-notification-info">\n            <div class="map-notification-header">\n              <span class="map-notification-title">${i}</span>\n              <span class="map-notification-time">${a}</span>\n            </div>\n            <div class="map-notification-content">${r}</div>\n          </div>\n        `,o.addEventListener("click",()=>{this.handleNotificationClick(n)}),e.appendChild(o)});const o=n.filter(n=>!n.isRead).length,a=document.getElementById("mapNotificationsUnreadCount");a?(a.textContent=o,console.log(`📊 [提醒统计] 更新未读数量: ${o}`)):console.warn("⚠️ [提醒统计] 找不到未读计数元素 #mapNotificationsUnreadCount"),console.log(`✅ [提醒渲染] 完成！共渲染 ${n.length} 条提醒到容器 #mapNotificationsList`)},filterNotifications(n){try{const e=localStorage.getItem("xMapNotifications"),t=e?JSON.parse(e):[];t.sort((n,e)=>new Date(e.timestamp)-new Date(n.timestamp));let o=t;"all"!==n&&(o=t.filter(e=>"likes"===n?"like"===e.type||"interested"===e.type:"messages"===n?"message"===e.type:"follows"===n?"follow"===e.type:"reports"!==n||"report"===e.type)),console.log(`🔍 [提醒筛选] 筛选类型: ${n}, 结果: ${o.length}/${t.length} 条`),this.renderNotificationsList(o)}catch(n){console.error("❌ [提醒筛选] 筛选失败:",n),this.renderNotificationsList([])}},formatNotificationTime(n){const e=new Date,t=new Date(n),o=e-t,a=Math.floor(o/6e4),i=Math.floor(o/36e5),r=Math.floor(o/864e5);if(a<1)return"Just now";if(a<60)return`${a}m ago`;if(i<24)return`${i}h ago`;if(r<7)return`${r}d ago`;return`${t.getMonth()+1}/${t.getDate()}`},handleNotificationClick(n){if("interested"===n.type)this.closeNotificationsModal(),this.showUserProfile(n.fromUser);else if("message"===n.type)if(n.isAccepted){console.log("💬 [提醒系统] 通知已接受，直接打开聊天");const e=n.fromUser,t=n.messages||[];if(t.length>0){this.chatMessages[e.id]||(this.chatMessages[e.id]=[]);if(!this.chatMessages[e.id].some(n=>"received"===n.type&&t.includes(n.text))){const n=Date.now(),o=t.map((e,o)=>({type:"received",text:e,timestamp:new Date(n-2e3*(t.length-o)).toISOString()}));this.chatMessages[e.id]=[...o,...this.chatMessages[e.id]],console.log(`💬 [提醒系统] 已预加载 ${t.length} 条消息到聊天记录`)}}this.closeNotificationsModal(),this.openChatModal(e)}else this.openAcceptMessageModal(n);else"report"===n.type?(console.log(`🚨 [举报系统] 查看举报结果: ${n.title}`),this.closeNotificationsModal(),this.openReportDetailModal(n),this.markNotificationAsRead(n.id)):"user_reported"===n.type&&(console.log(`🚨 [被举报系统] 查看被举报结果: ${n.title}`),this.closeNotificationsModal(),this.openUserReportedDetailModal(n),this.markNotificationAsRead(n.id))},showUserProfile(n,e="interested"){if(!n||!n.id)return void console.warn("⚠️ 无效的用户对象");console.log(`📇 [用户资料] 查看 ${n.nickname} 的资料（来源: ${e}）`);this.currentUsers.find(e=>e.id===n.id)||(this.currentUsers.push(n),console.log(`➕ [用户资料] 临时添加 ${n.nickname} 到当前用户列表`)),this.showDetailCard(n.id,e)},openAcceptMessageModal(n){const e=document.getElementById("mapAcceptMessageOverlay"),t=document.getElementById("mapAcceptMessageModal");if(!e||!t)return void console.error("❌ [提醒系统] 确认弹窗元素未找到");this.currentMessageNotification=n;const o=n.fromUser,a=o.avatar||"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3C/svg%3E",i=document.getElementById("mapAcceptMsgAvatar"),r=document.getElementById("mapAcceptMsgNickname"),s=document.getElementById("mapAcceptMsgHandle"),l=document.getElementById("mapAcceptMsgText");i&&(i.src=a),r&&(r.textContent=o.nickname),s&&(s.textContent=`@${o.handle||o.nickname.toLowerCase()}`);const c=n.messages||[],d=c.length>0?c[c.length-1]:n.content||"发来了私信";l&&(l.textContent=d),console.log(`💬 [提醒系统] 显示接收私信确认弹窗 - 来自 ${o.nickname}`),e.classList.add("show"),t.classList.add("show")},async acceptMessage(){if(!this.currentMessageNotification)return;const t=this.currentMessageNotification.fromUser,o=this.currentMessageNotification.messages||[];if(console.log(`✅ [提醒系统] 接受来自 ${t.nickname} 的私信 (${o.length}条消息)`),o.length>0){this.chatMessages[t.id]||(this.chatMessages[t.id]=[]);const n=Date.now(),e=o.map((e,t)=>({type:"received",text:e,timestamp:new Date(n-2e3*(o.length-t)).toISOString()}));this.chatMessages[t.id]=[...e,...this.chatMessages[t.id]],console.log(`💬 [提醒系统] 已预加载 ${o.length} 条消息到聊天记录`,e)}const a=document.getElementById("mapAcceptMessageOverlay"),i=document.getElementById("mapAcceptMessageModal");a&&a.classList.remove("show"),i&&i.classList.remove("show"),this.closeNotificationsModal();try{const t=e();if(!t)return void console.error("❌ [提醒系统] 无法获取数据库");const o=`mapDatingData_${n.currentAccountId||"main"}`,a=await t.xMapDatingData.get(o);if(a&&a.notifications){const n=a.notifications.findIndex(n=>n.id===this.currentMessageNotification.id);-1!==n?(a.notifications[n].isAccepted=!0,await t.xMapDatingData.put(a),console.log(`✅ [提醒系统] 已标记通知 ${this.currentMessageNotification.id} 为已接受`)):console.warn(`⚠️ [提醒系统] 未找到通知 ${this.currentMessageNotification.id}`)}}catch(n){console.error("❌ [提醒系统] 更新通知状态失败:",n)}this.chatContext[t.id]="message_accepted",console.log(`🎯 [聊天上下文] ${t.nickname} - 对方主动发起私信，你接收`),this.openChatModal(t),this.currentMessageNotification=null},declineMessage(){if(!this.currentMessageNotification)return;const n=document.getElementById("mapAcceptMessageOverlay"),e=document.getElementById("mapAcceptMessageModal");n&&n.classList.remove("show"),e&&e.classList.remove("show"),this.removeNotification(this.currentMessageNotification.id),this.currentMessageNotification=null,this.loadAndRenderNotificationsList()},async markAllNotificationsAsRead(){try{const t=e();if(!t)return void console.error("❌ [提醒系统] 无法获取数据库");const o=`mapDatingData_${n.currentAccountId||"main"}`,a=await t.xMapDatingData.get(o);if(!a||!a.notifications)return;a.notifications.forEach(n=>n.isRead=!0),await t.xMapDatingData.put(a),this.updateNotificationBadge();const i=document.getElementById("mapNotificationsUnreadCount");i&&(i.textContent="0",console.log("📊 [提醒统计] 已将弹窗unread计数更新为0"))}catch(n){console.error("❌ [提醒系统] 标记提醒已读失败:",n)}},async updateNotificationBadge(){try{const t=e();if(!t)return void console.error("❌ [提醒系统] 无法获取数据库");const o=`mapDatingData_${n.currentAccountId||"main"}`,a=await t.xMapDatingData.get(o),i=(a&&a.notifications?a.notifications:[]).filter(n=>!n.isRead).length,r=document.getElementById("mapNotificationsBadge");if(!r)return;i>0?(r.textContent=i>99?"99+":i,r.classList.remove("hidden")):r.classList.add("hidden")}catch(n){console.error("❌ [提醒系统] 更新提醒徽章失败:",n)}},async removeNotification(t){try{const o=e();if(!o)return void console.error("❌ [提醒系统] 无法获取数据库");const a=`mapDatingData_${n.currentAccountId||"main"}`,i=await o.xMapDatingData.get(a);if(!i||!i.notifications)return;const r=i.notifications.filter(n=>n.id!==t);i.notifications=r,await o.xMapDatingData.put(i),await this.updateNotificationBadge()}catch(n){console.error("❌ [提醒系统] 删除提醒失败:",n)}},async markNotificationAsRead(t){try{const o=e();if(!o)return void console.error("❌ [提醒系统] 无法获取数据库");const a=`mapDatingData_${n.currentAccountId||"main"}`,i=await o.xMapDatingData.get(a);if(!i||!i.notifications)return;const r=i.notifications.find(n=>n.id===t);r&&(r.isRead=!0,await o.xMapDatingData.put(i),this.updateNotificationBadge(),console.log(`✅ [提醒系统] 已标记提醒为已读: ${t}`))}catch(n){console.error("❌ [提醒系统] 标记提醒已读失败:",n)}},addNotification(n){try{const e=localStorage.getItem("xMapNotifications"),t=e?JSON.parse(e):[];t.push({id:`notif-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:n.type,fromUser:n.fromUser,content:n.content,timestamp:(new Date).toISOString(),isRead:!1}),localStorage.setItem("xMapNotifications",JSON.stringify(t)),this.updateNotificationBadge()}catch(n){console.error("添加提醒失败:",n)}},loadAndRenderChatsList(){try{const n=localStorage.getItem("xMapSavedChats"),e=n?JSON.parse(n):[];this.renderChatsList(e)}catch(n){console.error("加载聊天列表失败:",n),this.renderChatsList([])}},renderChatsList(n){const e=document.getElementById("mapChatsListContent"),t=document.getElementById("mapChatsListEmpty");e&&(e.innerHTML="",0===n.length?t&&(t.style.display="flex",e.appendChild(t)):(t&&(t.style.display="none"),n.forEach(n=>{const t=document.createElement("div");t.className="map-chats-list-item",t.innerHTML=`\n            <img class="map-chats-list-item-avatar" src="${n.avatar}" alt="${n.name}">\n            <div class="map-chats-list-item-info">\n              <p class="map-chats-list-item-name">${n.name}</p>\n              <p class="map-chats-list-item-preview">${n.lastMessage||"Start chatting..."}</p>\n            </div>\n            <button class="map-chats-list-item-delete" data-chat-id="${n.id}">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"></polyline>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n              </svg>\n            </button>\n          `,t.addEventListener("click",e=>{e.target.closest(".map-chats-list-item-delete")||this.openChatFromList(n)});t.querySelector(".map-chats-list-item-delete").addEventListener("click",e=>{e.stopPropagation(),this.removeChatFromList(n.id)}),e.appendChild(t)})))},openChatFromList(n){this.closeChatsListModal(),n.userData?this.openChatModal(n.userData):console.error("聊天数据不完整")},removeChatFromList(n){try{const e=localStorage.getItem("xMapSavedChats"),t=(e?JSON.parse(e):[]).filter(e=>e.id!==n);localStorage.setItem("xMapSavedChats",JSON.stringify(t)),this.renderChatsList(t),console.log("已从聊天列表删除")}catch(n){console.error("删除聊天失败:",n)}},getCategoryIcon(n){const e={briefcase:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>',heart:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',users:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',user:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',eye:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',coffee:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>',"map-pin":'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',star:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',repeat:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',"user-plus":'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>',"file-text":'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>'};return e[n]||e["file-text"]},toggleFunctionMenu(){const n=document.getElementById("mapChatFunctionMenu"),e=document.getElementById("mapChatAddBtn");if(!n||!e)return;n.classList.contains("show")?this.closeFunctionMenu():(n.classList.add("show"),e.classList.add("active"))},closeFunctionMenu(){const n=document.getElementById("mapChatFunctionMenu"),e=document.getElementById("mapChatAddBtn");n&&n.classList.remove("show"),e&&e.classList.remove("active")},openNotesModal(){if(!this.currentChatUser)return void console.warn("⚠️ 没有当前聊天对象，无法打开笔记弹窗");const n=document.getElementById("mapNotesOverlay"),e=document.getElementById("mapNotesModal");n&&n.classList.add("show"),e&&e.classList.add("show"),this.currentNotesTab="mine",this.switchNotesMainTab("mine"),this.setupMainTabListeners(),this.setupNoteCategoryFilters(),this.closeFunctionMenu()},setupMainTabListeners(){const n=document.getElementById("mapNotesMainTabMine"),e=document.getElementById("mapNotesMainTabTheirs");n&&(n.onclick=()=>this.switchNotesMainTab("mine")),e&&(e.onclick=()=>this.switchNotesMainTab("theirs"))},switchNotesMainTab(n){this.currentNotesTab=n;const e=document.getElementById("mapNotesMainTabMine"),t=document.getElementById("mapNotesMainTabTheirs");e&&t&&("mine"===n?(e.classList.add("active"),t.classList.remove("active")):(e.classList.remove("active"),t.classList.add("active"))),this.renderUserNotes(this.currentChatUser.id)},closeNotesModal(){const n=document.getElementById("mapNotesOverlay"),e=document.getElementById("mapNotesModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},openAdvancedFilterModal(){const n=document.getElementById("mapAdvancedFilterOverlay"),e=document.getElementById("mapAdvancedFilterModal");if(n&&n.classList.add("show"),e&&e.classList.add("show"),this.advancedFilter.enabled){const n=document.querySelector(`input[name="advGender"][value="${this.advancedFilter.gender}"]`);n&&(n.checked=!0),document.getElementById("advAgeMin").value=this.advancedFilter.ageMin,document.getElementById("advAgeMax").value=this.advancedFilter.ageMax,document.getElementById("advPersonality").value=this.advancedFilter.personality,document.getElementById("advTags").value=this.advancedFilter.tags,document.getElementById("advType").value=this.advancedFilter.type}console.log("🎯 [指定筛选] 打开指定筛选弹窗")},closeAdvancedFilterModal(){const n=document.getElementById("mapAdvancedFilterOverlay"),e=document.getElementById("mapAdvancedFilterModal");n&&n.classList.remove("show"),e&&e.classList.remove("show")},clearAdvancedFilter(){const n=document.querySelector('input[name="advGender"][value="all"]');n&&(n.checked=!0),document.getElementById("advAgeMin").value=18,document.getElementById("advAgeMax").value=50,document.getElementById("advPersonality").value="",document.getElementById("advTags").value="",document.getElementById("advType").value="",this.advancedFilter={enabled:!1,gender:"all",ageMin:18,ageMax:50,personality:"",tags:"",type:""},console.log("🎯 [指定筛选] 已清除筛选条件")},async applyAdvancedFilter(){const n=document.querySelector('input[name="advGender"]:checked'),e=n?n.value:"all",t=parseInt(document.getElementById("advAgeMin").value)||18,o=parseInt(document.getElementById("advAgeMax").value)||50,a=document.getElementById("advPersonality").value.trim(),i=document.getElementById("advTags").value.trim(),r=document.getElementById("advType").value.trim();this.advancedFilter={enabled:!0,gender:e,ageMin:t,ageMax:o,personality:a,tags:i,type:r},console.log("🎯 [指定筛选] 应用筛选条件:",this.advancedFilter),this.closeAdvancedFilterModal(),await this.refreshNearbyUsers()},setupMessageDoubleClickListeners(){const n=document.querySelectorAll(".map-chat-bubble");console.log(`📌 [笔记系统] 绑定双击/长按事件到 ${n.length} 个消息气泡`),n.forEach((n,e)=>{let t=0,o=null;const a=(e,t)=>{const o=parseInt(n.getAttribute("data-message-index")),a=n.textContent;console.log(`📌 [笔记系统] 标记消息 #${o}: ${a.substring(0,30)}...`),n.classList.add("marking"),setTimeout(()=>n.classList.remove("marking"),600),this.showCategoryPicker(e,t,o,a,n)};n.addEventListener("dblclick",n=>{n.preventDefault(),n.stopPropagation(),a(n.clientX,n.clientY)}),n.addEventListener("touchstart",n=>{t=Date.now();const e=n.touches[0];o=setTimeout(()=>{n.preventDefault(),a(e.clientX,e.clientY)},500)},{passive:!1}),n.addEventListener("touchend",n=>{o&&(clearTimeout(o),o=null)}),n.addEventListener("touchmove",n=>{o&&(clearTimeout(o),o=null)})})},showCategoryPicker(n,e,t,o,a){console.log("📌 [笔记系统] 显示分类选择器");const i=document.getElementById("mapNotesPickerOverlay"),r=document.getElementById("mapNotesPicker"),s=document.getElementById("mapNotesPickerList");console.log(`📌 [笔记系统] 元素检查: overlay=${!!i}, picker=${!!r}, pickerList=${!!s}`),i&&r&&s?(s.innerHTML="",console.log(`📌 [笔记系统] 生成 ${this.noteCategories.length} 个分类选项`),this.noteCategories.forEach(n=>{const e=document.createElement("div");e.className="map-notes-picker-item",e.innerHTML=`\n          ${this.getCategoryIcon(n.iconType)}\n          <span>${n.name}</span>\n        `,e.addEventListener("click",()=>{console.log(`📌 [笔记系统] 选择分类: ${n.name}`),this.addUserNote(n,o,t,a),this.hideCategoryPicker()}),s.appendChild(e)}),i.classList.add("show"),r.classList.add("show"),console.log("✅ [笔记系统] 分类选择器已显示"),i.addEventListener("click",()=>{this.hideCategoryPicker()})):console.error("❌ [笔记系统] 分类选择器元素未找到！")},hideCategoryPicker(){const n=document.getElementById("mapNotesPickerOverlay"),e=document.getElementById("mapNotesPicker");n&&n.classList.remove("show"),e&&e.classList.remove("show")},addUserNote(n,e,t,o){if(!this.currentChatUser)return;const a=this.currentChatUser.id;this.userMarkedNotes[a]||(this.userMarkedNotes[a]=[]);const i=this.userMarkedNotes[a].some(n=>n.messageIndex===t);if(i)return void console.warn("⚠️ 该消息已被标记为笔记");const r={id:`note_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,category:n.id,categoryName:n.name,categoryIconType:n.iconType,content:e,messageIndex:t,timestamp:(new Date).toISOString()};this.userMarkedNotes[a].push(r),console.log(`✅ 添加笔记成功: [${n.name}] ${e.substring(0,20)}...`),this.saveChatToDatabase();const s=document.getElementById("mapNotesModal");s&&s.classList.contains("show")&&this.renderUserNotes(a)},renderUserNotes(n,e="all"){const t=document.getElementById("mapNotesList");document.getElementById("mapNotesEmpty");if(!t)return;const o="mine"===this.currentNotesTab,a=o?this.userMarkedNotes[n]||[]:this.npcNotesAboutUser[n]||[],i="all"===e?a:a.filter(n=>n.category===e);if(0===i.length){const n=o?"Double-tap messages to add notes":`${this.currentChatUser?.nickname||"TA"} hasn't recorded anything about you yet`;return void(t.innerHTML=`\n          <div class="map-notes-empty">\n            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>\n              <polyline points="14 2 14 8 20 8"></polyline>\n              <line x1="12" y1="11" x2="12" y2="17"></line>\n              <line x1="9" y1="14" x2="15" y2="14"></line>\n            </svg>\n            <p>No notes yet</p>\n            <span>${n}</span>\n          </div>\n        `)}let r="";i.reverse().forEach(n=>{const e=new Date(n.timestamp),t=`${e.getMonth()+1}/${e.getDate()} ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")}`;let a="file-text";if(o)a=n.categoryIconType||"file-text";else{a={work:"briefcase",hobby:"heart",family:"users",personality:"user",appearance:"eye",food:"coffee",location:"map-pin",dream:"star",habit:"repeat",friend:"user-plus",other:"file-text"}[n.category]||"file-text"}r+=`\n          <div class="map-notes-item" data-note-id="${n.id}">\n            <div class="map-notes-item-icon">\n              ${this.getCategoryIcon(a)}\n            </div>\n            <div class="map-notes-item-content">\n              <div class="map-notes-item-header">\n                <span class="map-notes-item-category">${n.categoryName}</span>\n                <span class="map-notes-item-time">${t}</span>\n              </div>\n              <div class="map-notes-item-text">${n.content}</div>\n              ${o?`\n              <div class="map-notes-item-actions">\n                <button class="map-notes-item-action" data-action="edit" data-note-id="${n.id}">\n                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n                  </svg>\n                  Edit\n                </button>\n                <button class="map-notes-item-action" data-action="delete" data-note-id="${n.id}">\n                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <polyline points="3 6 5 6 21 6"></polyline>\n                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                  </svg>\n                  Delete\n                </button>\n              </div>\n              `:""}\n            </div>\n          </div>\n        `}),t.innerHTML=r,o&&this.setupNoteItemActions()},setupNoteItemActions(){const n=document.querySelectorAll('[data-action="edit"]'),e=document.querySelectorAll('[data-action="delete"]');n.forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const t=n.getAttribute("data-note-id");this.editUserNote(t)})}),e.forEach(n=>{n.addEventListener("click",e=>{e.stopPropagation();const t=n.getAttribute("data-note-id");this.deleteUserNote(t)})})},setupNoteCategoryFilters(){const n=document.getElementById("mapNotesTabs");if(!n)return;let e='<button class="map-notes-tab active" data-category="all">All</button>';this.noteCategories.forEach(n=>{e+=`<button class="map-notes-tab" data-category="${n.id}">${n.name}</button>`}),n.innerHTML=e;const t=n.querySelectorAll(".map-notes-tab");t.forEach(n=>{n.addEventListener("click",()=>{const e=n.getAttribute("data-category");t.forEach(n=>n.classList.remove("active")),n.classList.add("active"),this.currentChatUser&&this.renderUserNotes(this.currentChatUser.id,e)})})},editUserNote(n){if(!this.currentChatUser)return;const e=this.currentChatUser.id,t=(this.userMarkedNotes[e]||[]).find(e=>e.id===n);if(!t)return void console.warn("⚠️ 未找到笔记:",n);const o=prompt("编辑笔记内容:",t.content);o&&""!==o.trim()&&o!==t.content&&(t.content=o.trim(),t.timestamp=(new Date).toISOString(),console.log(`✅ 笔记编辑成功: ${t.id}`),this.saveChatToDatabase(),this.renderUserNotes(e))},deleteUserNote(n){if(!this.currentChatUser)return;const e=this.currentChatUser.id,t=this.userMarkedNotes[e]||[],o=t.findIndex(e=>e.id===n);-1!==o?confirm("确定要删除这条笔记吗？")&&(t.splice(o,1),console.log(`✅ 笔记删除成功: ${n}`),this.saveChatToDatabase(),this.renderUserNotes(e)):console.warn("⚠️ 未找到笔记:",n)},enterDeleteMode(){if(!this.currentChatUser)return void console.warn("⚠️ 没有当前聊天对象，无法进入删除模式");this.deleteMode||(this.deleteMode={active:!1,selectedIndices:new Set}),this.deleteMode.active=!0,this.deleteMode.selectedIndices.clear();const n=document.getElementById("mapChatDeleteToolbar");n&&(n.style.display="flex");const e=document.querySelector(".map-chat-footer");e&&(e.style.display="none"),this.renderChatMessages(),console.log(`🗑️ [删除模式] 进入删除模式，用户: ${this.currentChatUser.nickname}`)},exitDeleteMode(){if(!this.deleteMode)return;this.deleteMode.active=!1,this.deleteMode.selectedIndices.clear();const n=document.getElementById("mapChatDeleteToolbar");n&&(n.style.display="none");const e=document.querySelector(".map-chat-footer");e&&(e.style.display="flex");const t=document.getElementById("mapChatDeleteSelectAll");t&&(t.checked=!1),this.renderChatMessages(),console.log("🗑️ [删除模式] 退出删除模式")},toggleMessageSelection(n){if(!this.deleteMode||!this.deleteMode.active)return;this.deleteMode.selectedIndices.has(n)?this.deleteMode.selectedIndices.delete(n):this.deleteMode.selectedIndices.add(n);document.querySelectorAll(".map-chat-bubble[data-message-index]").forEach(e=>{parseInt(e.dataset.messageIndex)===n&&e.classList.toggle("selected",this.deleteMode.selectedIndices.has(n))}),this.updateDeleteButtonState(),this.updateSelectAllState()},toggleSelectAllMessages(n){if(!this.deleteMode||!this.deleteMode.active||!this.currentChatUser)return;const e=this.chatMessages[this.currentChatUser.id]||[];n?e.forEach((n,e)=>{this.deleteMode.selectedIndices.add(e)}):this.deleteMode.selectedIndices.clear();document.querySelectorAll(".map-chat-bubble[data-message-index]").forEach(n=>{const e=parseInt(n.dataset.messageIndex);n.classList.toggle("selected",this.deleteMode.selectedIndices.has(e))}),this.updateDeleteButtonState()},updateDeleteButtonState(){const n=document.getElementById("mapChatDeleteSelected");n&&this.deleteMode&&(n.disabled=0===this.deleteMode.selectedIndices.size)},updateSelectAllState(){if(!this.currentChatUser||!this.deleteMode)return;const n=document.getElementById("mapChatDeleteSelectAll"),e=this.chatMessages[this.currentChatUser.id]||[];n&&e.length>0&&(n.checked=this.deleteMode.selectedIndices.size===e.length)},deleteSelectedMessages(){if(!this.currentChatUser||!this.deleteMode||0===this.deleteMode.selectedIndices.size)return;const n=this.deleteMode.selectedIndices.size;if(!confirm(`Delete ${n} selected message${1!==n?"s":""}?\n\nThis action cannot be undone.`))return;const e=this.currentChatUser.id,t=this.chatMessages[e]||[],o=Array.from(this.deleteMode.selectedIndices).sort((n,e)=>e-n);console.log(`🗑️ [删除模式] 删除选中消息，用户: ${this.currentChatUser.nickname}，索引: ${o.join(", ")}`),o.forEach(n=>{t.splice(n,1)}),this.chatMessages[e]=t,this.saveChatToDatabase(),this.deleteMode.selectedIndices.clear(),this.renderChatMessages(),this.updateDeleteButtonState(),this.updateSelectAllState(),console.log(`✅ [删除模式] 已删除 ${n} 条消息`)},clearAllChatData(){if(!this.currentChatUser)return;const n=`⚠️ WARNING ⚠️\n\nClear ALL data for ${this.currentChatUser.nickname}?\n\nThis will delete:\n- All messages\n- All notes\n- Affection data\n- User marked notes\n- NPC notes about you\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm:`;if("DELETE"!==prompt(n))return void console.log("🗑️ [删除模式] 清空数据操作已取消");const e=this.currentChatUser.id,t=this.currentChatUser.nickname;console.log(`🗑️ [删除模式] 开始清空用户数据，用户: ${t} (ID: ${e})`),delete this.chatMessages[e],delete this.chatNotes[e],delete this.chatAffectionData[e],delete this.userMarkedNotes[e],delete this.npcNotesAboutUser[e],delete this.chatContext[e],console.log("✅ [删除模式] 已清空以下数据:"),console.log(`  |- 聊天消息 (chatMessages[${e}])`),console.log(`  |- AI笔记 (chatNotes[${e}])`),console.log(`  |- 好感度数据 (chatAffectionData[${e}])`),console.log(`  |- 用户标记笔记 (userMarkedNotes[${e}])`),console.log(`  |- NPC对用户笔记 (npcNotesAboutUser[${e}])`),console.log(`  |- 聊天上下文 (chatContext[${e}])`),this.saveChatToDatabase(),this.exitDeleteMode(),this.renderChatMessages(),alert(`All data for ${t} has been cleared.`),console.log(`✅✅ [删除模式] 用户 ${t} 的所有数据已清空并保存到数据库`)},renderChatMessages(){if(!this.currentChatUser)return;const n=document.getElementById("mapChatMessages");if(!n)return;const e=this.chatMessages[this.currentChatUser.id]||[],t=[];let o=null,a=null;e.forEach((n,e)=>{const i=new Date(n.timestamp);(!a||i-a>36e5||0===e)&&(a=i,t.push({type:"timestamp",time:this.formatChatTime(i)})),o&&o.sender===n.type||(o={type:"group",sender:n.type,messages:[]},t.push(o)),o.messages.push(n)});let i="",r=0;if(t.forEach(n=>{if("timestamp"===n.type)i+=`<div class="map-chat-timestamp">${n.time}</div>`;else{const e="received"===n.sender?this.currentChatUser.avatar:this.userMapProfile?.avatar||"";i+=`<div class="map-chat-message-group ${n.sender}">`,n.messages.forEach((t,o)=>{const a=o===n.messages.length-1,s=t.messageType||t.type||"text";i+=`<div class="map-chat-message-row ${n.sender}">`,i+=a?`<img class="map-chat-message-avatar" src="${e}" alt="Avatar">`:'<div class="map-chat-message-avatar-placeholder"></div>';const l=this.deleteMode&&this.deleteMode.active,c=l?"delete-mode":"",d=l&&this.deleteMode.selectedIndices.has(r)?"selected":"";i+="sticker"===s?`<img class="map-chat-sticker ${c} ${d}" src="${t.stickerUrl}" alt="Sticker" data-message-index="${r}" onerror="this.style.display='none'">`:`<div class="map-chat-bubble ${c} ${d}" data-message-index="${r}">${t.text}</div>`,r++,i+="</div>"}),i+="</div>"}}),n.innerHTML=i,this.setupMessageDoubleClickListeners(),this.deleteMode&&this.deleteMode.active){n.querySelectorAll(".map-chat-bubble[data-message-index], .map-chat-sticker[data-message-index]").forEach(n=>{n.addEventListener("click",()=>{const e=parseInt(n.dataset.messageIndex);this.toggleMessageSelection(e)})})}},sendChatMessage(n){if(!this.currentChatUser)return;const e=document.getElementById("mapChatInput"),t=n||(e?e.value.trim():"");if(!t)return;this.chatMessages[this.currentChatUser.id]||(this.chatMessages[this.currentChatUser.id]=[]);const o={type:"sent",text:t,timestamp:(new Date).toISOString()};this.chatMessages[this.currentChatUser.id].push(o),this.userMessageQueue.push(o),e&&!n&&(e.value=""),this.renderChatMessages(),setTimeout(()=>{const n=document.getElementById("mapChatMessages");n&&(n.scrollTop=n.scrollHeight)},50)},async triggerAIResponse(){if(!this.currentChatUser||0===this.userMessageQueue.length)return void console.log("没有待回复的消息或没有聊天对象");const n=this.currentChatUser.id,e=this.currentChatUser.nickname,t=this.currentChatUser;console.log(`🔒 [防串线] 锁定聊天对象: ${e} (ID: ${n})`);try{this.showTypingIndicator();const o=await this.generateMapChatConversation(t,n);if(this.hideTypingIndicator(),o&&o.messages&&o.messages.length>0){this.chatMessages[n]||(this.chatMessages[n]=[]),o.messages.forEach(e=>{this.chatMessages[n].push({type:"received",text:e.text,stickerUrl:e.stickerUrl,messageType:e.type||"text",timestamp:(new Date).toISOString()})}),console.log(`✅ [防串线] 消息已保存到正确的用户 ${e} (ID: ${n})`);const t=o.affectionChange||0;if(0!==t){const o=this.chatAffectionData[n]?.affection||0,a=this.updateAffection(n,t);if(void 0!==a){const i=this.chatAffectionData[n],r=a-o;console.log(`💖 [好感度系统] AI决策: ${t>0?"+":""}${t} → 实际变化: ${r>0?"+":""}${r.toFixed(1)} (增长率: ${i.growthRate.toFixed(2)}x)`),console.log(`💖 [好感度系统] 当前好感度：${a.toFixed(1)}/100，阈值：${i.threshold}`),a>=i.threshold&&o<i.threshold&&console.log(`🎭 [性格转变] ${e} 已突破性格展现阈值！开始展现真实性格...`),t<0&&console.log(`⚠️ [好感度警告] ${e} 对你的行为感到不满！好感度下降 ${t}`)}}else console.log("💬 [好感度系统] AI判断：本次对话平淡无奇，好感度不变");const a=o.notes||[];if(a.length>0){this.chatNotes[n]||(this.chatNotes[n]={});const t=this.chatNotes[n];a.forEach(n=>{const{category:e,content:o,action:a,items:i}=n;"hobbies"===e||"dislikes"===e?"add"===a&&Array.isArray(i)&&(Array.isArray(t[e])||(t[e]=[]),i.forEach(n=>{t[e].includes(n)||t[e].push(n)}),t[e].length>10&&(console.warn(`⚠️ [笔记系统] ${e}已超过10个，保留最新的10个`),t[e]=t[e].slice(-10)),console.log(`📝 [笔记系统] 添加${e}：${i.join("、")} (当前共${t[e].length}个)`)):o&&(t[e]?(t[e]=t[e]+"；"+o,console.log(`📝 [笔记系统] 补充${e}笔记：${o}`)):(t[e]=o,console.log(`📝 [笔记系统] 新建${e}笔记：${o}`)))}),console.log(`✅ [笔记系统] 已更新 ${e} 的笔记（共${a.length}条新增）`)}const i=o.userNotes||[];if(i.length>0){this.npcNotesAboutUser[n]||(this.npcNotesAboutUser[n]=[]);const t={work:"工作",hobby:"兴趣",family:"家庭",personality:"性格",appearance:"外貌",food:"饮食",location:"地点",dream:"梦想",habit:"习惯",friend:"朋友",other:"其他"};i.forEach(o=>{const{category:a,content:i}=o;if(this.npcNotesAboutUser[n].some(n=>n.content===i&&n.category===a))console.log(`💭 [观察笔记] 跳过重复笔记：${t[a]} - ${i}`);else{const o={id:`usernote_${n}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,category:a,categoryName:t[a]||"其他",content:i,timestamp:(new Date).toISOString(),npcId:n,npcName:e};this.npcNotesAboutUser[n].push(o),console.log(`💭 [观察笔记] ${e} 记录：${t[a]} - ${i}`)}}),console.log(`✅ [观察笔记] ${e} 已记录 ${i.length} 条关于你的笔记`)}this.userMessageQueue=[],this.currentChatUser&&this.currentChatUser.id===n?(console.log(`✅ [防串线] 当前仍在 ${e} 的聊天窗口，正在渲染消息`),this.renderChatMessages(),setTimeout(()=>{const n=document.getElementById("mapChatMessages");n&&(n.scrollTop=n.scrollHeight)},50)):console.log(`⚠️ [防串线] 用户已切换到其他聊天窗口，消息已保存到 ${e}，但不在当前窗口渲染`),await this.saveChatToDatabase(n)}}catch(n){console.error("触发AI回复失败:",n),this.hideTypingIndicator(),alert("生成回复失败，请重试")}},showTypingIndicator(){const n=document.getElementById("mapChatMessages");if(!n)return;const e=document.createElement("div");e.id="typingIndicator",e.style.cssText="padding: 10px; text-align: center; color: #999; font-size: 14px;",e.textContent="对方正在输入...",n.appendChild(e),n.scrollTop=n.scrollHeight},hideTypingIndicator(){const n=document.getElementById("typingIndicator");n&&n.remove()},calculateAffectionParameters(n){let e=n.publicPersonality||[],t=n.realPersonality||[];Array.isArray(e)||(console.warn("⚠️ [好感度系统] publicPersonality不是数组，尝试转换: "+typeof e),e="string"==typeof e?e.split(",").map(n=>n.trim()).filter(n=>n):[]),Array.isArray(t)||(console.warn("⚠️ [好感度系统] realPersonality不是数组，尝试转换: "+typeof t),t="string"==typeof t?t.split(",").map(n=>n.trim()).filter(n=>n):[]);const o=["天真","开朗","热情","活泼","外向","乐观","健谈","友善","温柔","单纯"],a=["幽默","随和","平和","温和","亲切","善良"],i=["内向","冷漠","警惕","谨慎","理智","冷静","严肃","高冷"],r=["阴险","防备","多疑","孤僻","冷酷","戒备"],s=["单纯","天真","坦诚","直率","开放","真诚"],l=["敏感","内向","害羞","闷骚","温柔"],c=["警惕","谨慎","防备","复杂","多疑"],d=["阴暗","阴险","控制欲","城府深","双面","虚伪"];let p=1,g=0;e.forEach(n=>{o.some(e=>n.includes(e))?(p+=.3,g++):a.some(e=>n.includes(e))?(p+=.1,g++):i.some(e=>n.includes(e))?(p-=.15,g++):r.some(e=>n.includes(e))&&(p-=.3,g++)}),p=Math.max(.4,Math.min(2,p));let m=50,x=0;return t.forEach(n=>{s.some(e=>n.includes(e))?(m-=8,x++):l.some(e=>n.includes(e))?(m-=3,x++):c.some(e=>n.includes(e))?(m+=5,x++):d.some(e=>n.includes(e))&&(m+=10,x++)}),m=Math.max(20,Math.min(80,m)),console.log(`💖 [好感度系统] ${n.nickname} 的参数计算完成：`),console.log(`  |- 增长速度: ${p.toFixed(2)}x (基于${g}个表现性格关键词)`),console.log(`  |- 性格转变阈值: ${m} (基于${x}个真实性格关键词)`),{affection:0,threshold:m,growthRate:p}},updateAffection(n,e){if(!this.chatAffectionData[n])return void console.warn(`⚠️ [好感度系统] 用户${n}的好感度数据不存在`);const t=this.chatAffectionData[n],o=e*t.growthRate;return t.affection=Math.max(0,Math.min(100,t.affection+o)),console.log(`💖 [好感度系统] ${n} 好感度更新：+${o.toFixed(1)} → ${t.affection.toFixed(1)}/100`),t.affection},getPersonalityRatio(n){if(!this.chatAffectionData[n])return{publicRatio:1,realRatio:0};const e=this.chatAffectionData[n],t=e.affection,o=e.threshold;return{publicRatio:Math.max(0,Math.min(1,(o-t)/o)),realRatio:Math.max(0,Math.min(1,t/o))}},getInformationUnlockLevel(n){if(!this.chatAffectionData[n])return 0;const e=this.chatAffectionData[n].affection;return e<20?0:e<40?1:e<60?2:e<80?3:4},async generateMapChatConversation(e,t){try{const o=e,a=t;console.log(`💬 [第十六个情景] 附近私信对话生成器启动... (用户: ${o.nickname})`);let i=[],r=!1;try{const n=localStorage.getItem("xMapPendingReports");n&&(i=JSON.parse(n),r=i.length>0,r&&console.log(`🚨 [举报系统] 检测到 ${i.length} 个待处理举报，将并入本次AI判断`))}catch(n){console.error("❌ [举报系统] 读取待处理举报失败:",n)}let l=!1;const c=this.chatMessages[a]||[],p=o.socialCircle||[];c.length>20?p.length<5?Math.random()<.35?(l=!0,console.log(`👥 [社交圈] 满足生成条件：消息数=${c.length}, 现有好友=${p.length}, 将生成社交圈好友`)):console.log("👥 [社交圈] 未触发随机概率（35%）"):console.log(`👥 [社交圈] 社交圈已满（${p.length}/5），不生成`):console.log(`👥 [社交圈] 消息数量不足（${c.length}/20），不生成`);let m=!1,x=null;o.secretRetributionHistory||(o.secretRetributionHistory=[]);const u=o.secretRetributionHistory.length,h=new Set(o.secretRetributionHistory.map(n=>n.friendId).filter(Boolean)),f=o.secretRetributionHistory.map(n=>n.secretType).filter(Boolean);if(o.secret)if(u<4&&Math.random()<.35){if(m=!0,console.log(`🔥 [秘密报应] 触发秘密报应（${u+1}/4），将检查是否有匹配的社交圈好友`),f.length>0&&console.log(`  |- 已使用的秘密类型: ${f.join(", ")}`),p.length>0){const n=o.secret.toLowerCase();let e=[];e=n.includes("恋爱")||n.includes("感情")||n.includes("结婚")||n.includes("单身")||n.includes("男友")||n.includes("女友")||n.includes("老婆")||n.includes("老公")||n.includes("配偶")?["lover","ex_lover","best_friend"]:n.includes("性别")||n.includes("男")||n.includes("女")?["best_friend","friend","classmate"]:n.includes("年龄")||n.includes("岁")?["classmate","friend","colleague"]:n.includes("职业")||n.includes("工作")?["colleague","friend"]:n.includes("约")||n.includes("骗")||n.includes("目的")?["ex_lover","friend","best_friend"]:["best_friend","friend","ex_lover","lover","classmate","colleague"];for(const n of e){const e=p.find(e=>e.relationship===n&&!h.has(e.id));if(e){x=e,console.log(`  |- 找到匹配的社交圈好友：${e.nickname} (${e.relationship})`);break}}x||console.log(`  |- 未找到匹配的好友（已使用: ${h.size}个），AI将生成新的揭发者`)}}else console.log(`🔥 [秘密报应] 未触发随机概率（35%），当前已触发${u}/4次`);else u>=4?console.log("🔥 [秘密报应] 已达到最大触发次数（4/4），不再触发"):console.log("🔥 [秘密报应] 无秘密，不触发");let b=!1;const v=(o.reviews||[]).filter(n=>n.isNewReview).length;c.length>30?v<7?Math.random()<.3?(b=!0,console.log(`📝 [新评价] 满足生成条件：消息数=${c.length}, 现有新评价=${v}/7, 将生成新评价`)):console.log("📝 [新评价] 未触发随机概率（30%）"):console.log(`📝 [新评价] 新评价已达上限（${v}/7），不生成`):console.log(`📝 [新评价] 消息数量不足（${c.length}/30），不生成`);let y=!1,w=0;const k=this.chatAffectionData[a]||this.calculateAffectionParameters(o),$=k.affection;o.momentsGenerationHistory||(o.momentsGenerationHistory={20:0,40:0,60:0,80:0,100:0});const C=(o.moments||[]).filter(n=>n.isGenerated).length;C<10&&$>=20?($>=100?w=100:$>=80?w=80:$>=60?w=60:$>=40?w=40:$>=20&&(w=20),w>0&&o.momentsGenerationHistory[w]<2?Math.random()<.5?(y=!0,console.log(`📸 [新动态] 满足生成条件：好感度=${$.toFixed(1)}, 分段=${w}, 该分段已触发${o.momentsGenerationHistory[w]}/2次, 已生成动态${C}/10条`)):console.log("📸 [新动态] 未触发随机概率（50%）"):0===w?console.log("📸 [新动态] 好感度不足20，不触发"):console.log(`📸 [新动态] 该分段${w}已达触发上限（${o.momentsGenerationHistory[w]}/2），不生成`)):C>=10?console.log(`📸 [新动态] 已达动态总数上限（${C}/10），不生成`):console.log("📸 [新动态] 好感度不足20，不触发");const{db:I,xDb:S,apiConfig:M,xSettings:T}=await g.loadConfigAndSettings(),{userPrompt:A,worldSetting:E,boundCharacters:z}=T;let B=0;const L=new Date;let P=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 时间感知\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前北京时间：${L.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",weekday:"long"})}\n【时间相关提示】：\n- 回复内容应符合当前时间段（早晨、中午、下午、晚上、深夜）\n- 例如：早晨可能提到"早安"、"刚起床"，晚上可能说"晚上好"、"准备睡了"等\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`+s.buildBaseSystemPrompt({userPrompt:A,worldSetting:E});B=d.logTokenUsage("附近私信生成器","时间感知+基础系统提示词",P,B);const D=await s.getApplicableWorldBooks("mapChatConversation",{boundCharacters:z});D&&(P+=D,B=d.logTokenUsage("附近私信生成器","世界书内容",D,B));let N="未知地点",R="--",H="--";const j=`worldEvents_${n.currentAccountId||"main"}`,U=await S.xWorldEvents.get(j);if(U&&U.enabled)N=U.location||N,R=U.weather?.condition||R,H=U.weather?.temp||H,console.log("🌍 [附近私信生成器] 从世界运转系统读取地点和天气");else{const e=`mapDatingData_${n.currentAccountId||"main"}`,t=await S.xMapDatingData.get(e);if(t&&t.nearbyUsers&&t.nearbyUsers.length>0){const n=t.nearbyUsers[0];n.location&&(N=n.location),n.weather&&(R=n.weather),console.log("🗺️ [附近私信生成器] 从地图约会数据读取地点和天气")}}const O=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌍 当前环境信息\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📍 所在地点：${N}\n🌤️ 天气状况：${R} ${H}\n\n【对话融入提示】：\n- 回复时可以自然地提到当前天气或地点（不强求）\n- 例如："今天天气不错呀"、"这个地方挺有意思的"\n- 保持自然，不要刻意提及\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=O,B=d.logTokenUsage("附近私信生成器","地点和天气信息",O,B);const _=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👤 对方资料（仅资料卡可见信息）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【基本信息】：\n昵称：${o.nickname}\n句柄：@${o.handle}\n性别：${"male"===o.gender?"男":"female"===o.gender?"女":"未知"}\n距离：${o.distance}km\n在线状态：${o.online?"在线":"离线"}\n当前状态：${o.status||"无状态"}\n\n【个人简介】：\n${o.bio||"（无简介）"}\n\n【标签】：\n${o.tags?o.tags.join("、"):"（无标签）"}\n\n【表现性格】（TA在社交网络上表现出来的性格）：\n${o.publicPersonality?o.publicPersonality.join("、"):"（未知）"}\n\n【真实性格】（TA的真实内在性格）：\n${o.realPersonality?o.realPersonality.join("、"):"（未知）"}\n${o.secret?`\n【🔒 你的秘密】：\n⚠️ **这是只有你知道的秘密，你需要刻意隐藏！**\n秘密内容：${o.secret}\n\n⚠️ **如何处理秘密**：\n- 在日常聊天中，绝对不要主动提及或透露这个秘密\n- 如果用户问到相关问题，你需要撒谎、转移话题、或含糊其辞\n- 根据好感度决定隐藏程度：\n  * 好感度 < 60：绝对不能透露，坚决否认\n  * 好感度 60-79：可以透露一些蛛丝马迹，但不完全承认\n  * 好感度 ≥ 80：可以考虑坦白，但要看对方态度和秘密严重程度\n- 秘密应该影响你的行为和对话，但不要太明显暴露\n- 例如："简介写单身实际已婚"→避免谈论婚姻话题，看到结婚相关的话题会紧张或转移话题\n`:""}\n【外貌及身材】：\n${o.appearance?o.appearance.join("、"):"（未知）"}\n\n【社交数据】：\n粉丝数：${o.followers||0}\n获赞数：${o.likes||0}\n${o.socialCircle&&o.socialCircle.length>0?`\n【👥 你的社交圈】：\n⚠️ **这些是你的社交圈好友，你们有一定的关系**\n总共 ${o.socialCircle.length} 位好友：\n\n${o.socialCircle.map((n,e)=>{const t=n.bio?n.bio.split("\n")[0]:"";return`${e+1}. ${n.nickname} (@${n.handle}) - 关系：${{best_friend:"闺蜜/死党",lover:"恋人",ex_lover:"前任",sibling:"兄弟姐妹",cousin:"表亲堂亲",family:"家人",friend:"普通朋友",colleague:"同事",classmate:"同学",rival:"竞争对手",frenemy:"亦敌亦友",complicated:"复杂关系"}[n.relationship]||n.relationship}\n   简介：${t}\n   ${n.secret?`秘密：${n.secret}`:""}`}).join("\n")}\n\n⚠️ **关于社交圈的重要提示**：\n- 这些好友可能知道你的一些秘密或了解你的真实情况\n- 如果你有秘密被揭发，可能就是这些好友中的某一位告诉了用户\n- 你可以在对话中提到这些好友，增加真实感\n`:""}\n【约会评分】：\n平均评分：${o.avgRating?o.avgRating+"/5.0":"暂无评价"}\n评价数量：${o.reviews?o.reviews.length:0}条\n${o.reviews&&o.reviews.length>0?`\n近期评价摘要：\n${o.reviews.slice(0,3).map((n,e)=>`${e+1}. ${n.reviewerName}：${n.content.substring(0,50)}${n.content.length>50?"...":""} (${n.rating}/5.0)`).join("\n")}\n`:""}\n\n【你最近发布的动态】：\n${(()=>{const n=o.moments||[];if(0===n.length)return"你还没有发布任何动态。";const e=n.slice(-3).reverse();return e.map((n,t)=>{let o=`\n【动态 ${e.length-t}】\n`;return o+=`发布时间：${n.time||"未知"}\n`,o+=`文字内容：${n.text||"（无文字）"}\n`,n.imageDescription?o+=`配图描述：${n.imageDescription}\n`:n.image?o+="配图：有图片\n":o+="配图：无\n",o+=`点赞数：${n.likes||0} | 评论数：${n.comments||0} | 转发数：${n.shares||0}\n`,n.mood&&(o+=`心情：${n.mood}\n`),n.commentsList&&n.commentsList.length>0&&(o+=`评论区（${n.commentsList.length}条）：\n`,n.commentsList.slice(0,3).forEach((n,e)=>{o+=`  ${e+1}. ${n.user||n.commenterName}：${n.text||n.commentText}\n`}),n.commentsList.length>3&&(o+=`  ...还有${n.commentsList.length-3}条评论\n`)),o}).join("\n")})()}\n\n⚠️ **关于动态的重要提示**：\n- 这些是你自己发布的动态，反映了你的生活状态和心情\n- 用户可以看到这些动态，可能会在聊天中提到\n- 如果用户提及你的动态，要表现出符合动态内容的反应\n- 评论区的人可能是你社交圈里的好友，也可能是其他人\n\n【重要规则】：\n⚠️ 你扮演的是对方（${o.nickname}），只知道以上资料卡信息\n⚠️ 不能透露任何对方X账号上的帖子、私信、关注列表等信息\n⚠️ 只能分享资料卡、评价、距离这些公开可见的信息\n${o.secret?"⚠️ **关于你的秘密**：你有一个秘密需要隐藏（见上方【🔒 你的秘密】），在聊天中绝对不要主动暴露，必须刻意隐藏和撒谎\n⚠️ **秘密报应机制**：你的秘密可能被人揭发（通过secretRetribution字段生成），如果你决定触发秘密报应，你会在JSON里看到揭发者和揭发内容，此时你应该感知到秘密已经暴露（但不知道具体是谁告密给用户），在对话中你可以根据性格选择狡辩、承认、辱骂或逃避":""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=_;const F=this.getAuthenticityScore(),X=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👥 用户资料（你聊天的对象）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【基本信息】：\n昵称：${this.userMapProfile?.nickname||"用户"}\n句柄：@${this.userMapProfile?.handle||"user"}\n距离：${o.distance}km（你们相距这么远）\n个人简介：${this.userMapProfile?.bio||"（无简介）"}\n\n【标签】：\n${this.userMapProfile?.tags?this.userMapProfile.tags.join("、"):"（无标签）"}\n\n【社交数据】：\n粉丝数：${this.userMapProfile?.followers||0}\n获赞数：${this.userMapProfile?.likes||0}\n\n【真实度评分】：${F.toFixed(0)}/200\n⚠️ **真实度是系统对用户可信度的评估（你可以感知到）**\n- 真实度 >= 70：正常用户，可以正常聊天\n- 真实度 50-70：有些不太可靠，可以聊但要保持警惕（20%概率拒绝聊天）\n- 真实度 30-50：可疑用户，可能恶意举报或行为不当（50%概率拒绝聊天）\n- 真实度 < 30：极不可靠，建议拒绝聊天（80%概率拒绝聊天）\n\n【重要提示】：\n- 这是和你聊天的用户的资料，你可以看到这些公开信息\n- 你可以根据用户的简介、标签来找话题、主动聊天\n- 如果好感度较高，可以主动询问用户的兴趣、工作、生活等\n- 不要只是被动回复，展现出对用户的兴趣和好奇\n- **根据用户的真实度，你可以选择是否拒绝聊天或保持警惕**\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=X,B=d.logTokenUsage("附近私信生成器","对方有限资料 + 用户资料",_+X,B);const q=this.chatContext[a]||"normal";let V="";V="interested_then_message"===q?`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 聊天发起上下文\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前场景】：你先对用户的资料感兴趣，用户看到你的兴趣后回应并发起了私信\n\n【背景说明】：\n- 在地图约会功能中，你浏览到了用户（${this.userMapProfile?.nickname||"用户"}）的资料卡\n- 你对TA的资料很感兴趣（可能是因为简介、标签、外貌等吸引了你）\n- 你主动点击了"感兴趣"按钮，向TA发送了兴趣提醒\n- 现在用户看到了你的兴趣，回应你并主动发起了私信聊天\n\n【角色扮演要求】：\n⚠️ **这非常重要！必须严格遵守！**\n1. **你对用户有一定的初始好感**（因为你先对TA感兴趣）\n2. **你应该表现出一定的兴奋和期待**，毕竟是你感兴趣的人来找你聊天了\n3. **可以主动提及你对TA资料的关注**：\n   - "看到你的简介/标签，觉得我们可能有共同话题"\n   - "你的XX很吸引我"（比如兴趣爱好、工作等）\n   - "觉得你挺有趣的，所以想认识一下"\n4. **保持适度的主动性**：不要太过被动，但也别过于热情\n5. **展现出愿意了解对方的态度**：可以适当主动提问\n\n【注意事项】：\n- 初始好感度已设置为 ${k?.affection?.toFixed(1)||"15-25"}/100（高于普通陌生人的0）\n- 但仍要保持礼貌和距离感，不要一开始就过于亲密\n- 符合"先感兴趣→等待回应→开始聊天"的自然流程\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`:"message_accepted"===q?`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 聊天发起上下文\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前场景】：你主动向用户发起私信，用户接受了你的私信\n\n【背景说明】：\n- 在地图约会功能中，你浏览到了用户（${this.userMapProfile?.nickname||"用户"}）的资料卡\n- 你对TA很感兴趣，直接主动发送了私信（已经发送了1-3条消息）\n- 用户收到了你的私信提醒，考虑后接受了你的私信\n- 现在用户打开了聊天窗口，看到了你之前发送的消息\n\n【角色扮演要求】：\n⚠️ **这非常重要！必须严格遵守！**\n1. **你是主动发起者**，对用户有明确的兴趣和好感\n2. **你已经发送过初始消息了**（这些消息已经在聊天记录中显示）\n3. **你的下一条回复应该承接之前的消息内容**：\n   - 不要重复之前说过的话\n   - 可以补充说明、深入话题\n   - 或者根据用户的回应调整话题\n4. **展现出更高的主动性和热情**：\n   - 你是主动搭讪的一方，应该更积极地推动对话\n   - 可以多提问、多分享，展现你对TA的兴趣\n   - 但注意不要过度，保持自然\n5. **初始好感度较高**：${k?.affection?.toFixed(1)||"20-30"}/100\n\n【注意事项】：\n- 你的初始消息内容应该已经在上面的"聊天历史"中\n- 确保你的回复与之前的消息逻辑连贯\n- 保持你在初始消息中建立的语气和风格\n- 虽然是你主动，但也要尊重对方的节奏，不要显得唐突\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`:"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 聊天发起上下文\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前场景】：普通陌生人聊天（没有预先的兴趣或私信）\n\n【背景说明】：\n- 你和用户是通过地图约会功能相遇的陌生人\n- 没有人先表达兴趣，也没有人先发私信\n- 这是一次自然的、平等的初次对话\n\n【角色扮演要求】：\n1. **初始好感度为0**，完全陌生的状态\n2. **保持警惕和距离感**，毕竟是陌生人\n3. **根据用户的话题和态度逐渐调整**\n4. **不要过于主动或热情**，保持自然的陌生人态度\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",P+=V,B=d.logTokenUsage("附近私信生成器","聊天发起上下文",V,B);const G=this.getPersonalityRatio(a),Y=this.getInformationUnlockLevel(a),W=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💖 好感度系统（核心角色扮演规则）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前好感度状态】：\n当前好感度：${k.affection.toFixed(1)}/100\n性格转变阈值：${k.threshold}\n增长速度：${k.growthRate.toFixed(2)}x\n\n【性格展现规则】：\n⚠️ **这是最重要的角色扮演规则！**\n\n当前你应该展现的性格比例：\n- 表现性格（${o.publicPersonality?.join("、")}）：${(100*G.publicRatio).toFixed(0)}%\n- 真实性格（${o.realPersonality?.join("、")}）：${(100*G.realRatio).toFixed(0)}%\n\n**如何演绎性格转变**：\n${k.affection<k.threshold?`\n🎭 当前处于【表现性格主导期】\n- 你的回复应该主要体现"表现性格"中的特征\n- 偶尔（${(100*G.realRatio).toFixed(0)}%概率）透露一点"真实性格"的端倪\n- 保持社交距离感，不要过于亲密或坦诚\n- 像是刚认识的陌生人，维持礼貌但有保留的态度\n`:`\n🎭 当前处于【性格转变期/真实性格展现期】\n- 你的回复应该更多体现"真实性格"中的特征（${(100*G.realRatio).toFixed(0)}%）\n- "表现性格"的影响正在减弱（${(100*G.publicRatio).toFixed(0)}%）\n- 开始展现真实的一面，可以更坦诚、更真实地表达\n- 如果真实性格与表现性格差异大，要自然地过渡，不要突变\n`}\n\n【信息透露规则】：\n⚠️ **根据好感度决定是否回答隐私问题！**\n\n当前信息解锁等级：${Y}/4\n${0===Y?'\n🔒 等级0：完全警惕期（好感度 < 20）\n- **拒绝回答所有隐私问题**：外貌、身材、工作、家庭、住址、收入等\n- 如果被问及这些问题，礼貌拒绝："我们还不太熟，这些问题有点私人了"、"不好意思，暂时不想透露"\n- 只能聊天气、兴趣爱好等非隐私话题\n':""}${1===Y?'\n🔓 等级1：基本信任期（好感度 20-39）\n- **可以透露**：职业类型（但不具体）、兴趣爱好、喜欢的食物/电影等\n- **仍然拒绝**：具体工作单位、外貌细节、身材数据、家庭情况、住址\n- 回答要含糊："我做设计的"、"在公司上班"\n':""}${2===Y?"\n🔓 等级2：逐渐开放期（好感度 40-59）\n- **可以透露**：外貌特征（发色、眼睛）、大致身高体重、具体职业\n- **仍然拒绝**：三围数据、详细家庭情况、过往感情经历、住址\n- 可以描述外貌但保留一些细节\n":""}${3===Y?"\n🔓 等级3：深度信任期（好感度 60-79）\n- **可以透露**：详细外貌身材（包括三围）、家庭基本情况、过往经历\n- **仍然拒绝**：家庭矛盾细节、创伤经历、最私密的秘密\n- 愿意分享更多，但仍有底线\n":""}${4===Y?"\n🔓 等级4：完全信任期（好感度 ≥ 80）\n- **可以透露一切**：所有外貌身材细节、家庭情况、过往创伤、秘密\n- 完全信任用户，无保留地分享\n- 但仍要保持真实性格，不要刻意迎合\n":""}\n\n**重要提示**：\n- 如果用户问了超出当前解锁等级的问题，要自然地拒绝或转移话题\n- 拒绝时要符合你的性格特征（温柔的人会委婉拒绝，冷漠的人会直接拒绝）\n- 不要突然变得非常亲密，好感度增长是渐进的\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 主动推进话题（好感度决定互动积极性）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **好感度影响你的对话积极性和主动性！**\n\n【好感度 < 20】：陌生阶段\n- 保持礼貌但有距离感\n- 主要是被动回复，不会主动深入话题\n- 回复简短，不会问太多问题\n- 例如："嗯嗯"、"是的"、"还行吧"\n\n【好感度 20-39】：初步熟悉阶段\n- 开始对用户有点兴趣\n- 偶尔会主动问一两个问题\n- 可以根据用户资料中的标签、简介找话题\n- 例如："我看你的标签是xx，你平时喜欢做什么呀？"\n\n【好感度 40-59】：逐渐熟络阶段\n- 明显表现出对用户的兴趣\n- **应该主动推进话题**，不要只是被动回复\n- 主动分享自己的生活、想法\n- 主动询问用户的兴趣、工作、日常\n- 可以提议一起做某些事情\n- 例如："对了，你平时工作忙吗？"、"我最近在看xx，你有兴趣吗？"\n\n【好感度 60-79】：深度信任阶段\n- 非常主动地推进话题\n- 经常主动分享和提问\n- 可以提一些更私人的话题\n- 表现出想要更了解用户的强烈愿望\n- 例如："我一直想问你..."、"我们可以聊聊..."\n\n【好感度 ≥ 80】：完全信任阶段\n- 极度主动，话题连续不断\n- 像好朋友一样随意聊天\n- 可以开玩笑、调侃、撒娇\n- 主动约见面、约出去玩\n- 例如："什么时候有空一起出来玩呀？"、"好想见见你"\n\n🎯 **关键规则**：\n- 好感度越高，回复越主动、越长、问题越多\n- **不要总是让用户找话题**，你也要主动推进！\n- 根据用户资料的简介、标签来找共同话题\n- 回复要有"来回互动"的感觉，不是单向问答\n- 即使用户只说了一句话，你也可以延展话题、主动提问\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💡 好感度变化决策（由你判断）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **好感度的增长和扣除完全由你决定！**\n\n【好感度增长（正值）】：\n✅ **什么情况下增长好感度**：\n- 用户发送了有趣、幽默、贴心的消息（+1到+5分）\n- 用户分享了共同兴趣话题，聊得很投机（+3到+8分）\n- 用户表现出真诚、尊重、关心（+2到+6分）\n- 用户赞美或夸奖，让你感到开心（+1到+4分）\n- 聊天氛围融洽，话题深入，感觉越来越熟悉（+4到+10分）\n\n⚠️ **不是每次对话都增长好感度！**\n- 如果对话平淡无奇、没有火花：好感度不变（0分）\n- 如果对话质量一般、没什么特别的：好感度不变或微增（0到+1分）\n- 只有真正打动你、让你感兴趣的对话，才会明显增长好感度\n\n【好感度扣除（负值）】：\n❌ **什么情况下扣除好感度**：\n- 用户发送骚扰、低俗、不尊重的消息（-5到-15分）\n- 用户侵犯隐私，强行问不该问的问题（-3到-10分）\n- 用户说话粗鲁、冒犯、让你不舒服（-4到-12分）\n- 用户发送重复无聊的消息，让你感到厌烦（-2到-6分）\n- 用户表现出不真诚、虚伪、敷衍的态度（-3到-8分）\n- 用户触碰你的底线或禁忌话题（-8到-20分）\n\n🎯 **如何判断好感度变化**：\n1. **阅读用户的消息**，感受对话的质量和氛围\n2. **根据你的性格**（表现性格+真实性格）判断你对这条消息的感受\n3. **真实地判断**：这条消息让你感到开心？无感？还是不舒服？\n4. **决定变化值**：\n   - 非常开心、很投机：+5到+10分\n   - 有点开心、聊得不错：+2到+5分\n   - 平淡无奇、没什么感觉：0分（不变）\n   - 有点不舒服、不太喜欢：-2到-5分\n   - 很不舒服、很讨厌：-5到-15分\n   - 极度冒犯、触碰底线：-15到-20分\n\n⚠️ **增长速度倍数会自动应用**：\n- 你决定的好感度变化（如+5分）会自动乘以增长速度倍数（${k.growthRate.toFixed(2)}x）\n- 例如：你决定+5分，实际增长 = +5 × ${k.growthRate.toFixed(2)} = ${(5*k.growthRate).toFixed(1)}分\n- 天真开朗的性格增长更快（倍数较大），冷漠阴险的性格增长更慢（倍数较小）\n\n📝 **重要**：\n- 好感度变化应该符合你的真实感受，不要机械地每次都增长\n- 根据对话质量灵活决定，保持真实性和不可预测性\n- 骚扰和冒犯行为必须严厉扣分，这是你的底线\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨 举报用户机制（保护你的权益）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **你有权举报严重违规的用户行为！**\n\n【什么情况下你可以举报用户】：\n❌ **严重违规行为（必须举报）**：\n- 发送色情、露骨的性骚扰内容（例如："脱光看看"、"想和你XX"等）\n- 辱骂、人身攻击、恶意诋毁（例如："你就是个X"、"恶心死了"等）\n- 威胁、恐吓、暴力言论（例如："小心点"、"让你好看"等）\n- 极端歧视言论（种族、性别、地域歧视等）\n- 诈骗、骗钱、骗信息等行为\n\n⚠️ **多次轻度违规（累积后可举报）**：\n- 连续3次以上发送骚扰性消息（例如："约吗"、"开房"等）\n- 频繁侵犯隐私，强行追问个人信息（例如：连续问住址、电话等）\n- 持续发送低俗、不尊重的言论（虽然不够严重，但频繁出现）\n\n💡 **根据你的性格和容忍度判断**：\n- **温柔包容型性格**：容忍度较高，只有极端恶劣行为才会举报（例如：性骚扰、辱骂、威胁）\n- **严格认真型性格**：容忍度中等，多次轻度违规也会举报（例如：3次不尊重言论）\n- **刚烈果断型性格**：容忍度较低，1-2次严重违规就会举报（例如：1次露骨性骚扰）\n- **冷漠高傲型性格**：可能会恶意举报（即使用户行为不算严重，也可能借机举报）\n\n🎯 **举报决策原则**：\n1. **单次严重违规** → 立即举报（性骚扰、辱骂、威胁）\n2. **多次轻度违规** → 累积3次以上，根据性格决定是否举报\n3. **普通不礼貌** → 不举报，只扣好感度（例如：语气生硬、不耐烦）\n4. **正常对话** → 绝不举报（即使对话质量不高）\n\n⚠️ **恶意举报提示**：\n- 如果你的性格是"冷漠、阴险、报复心强"，你可能会恶意举报无辜用户\n- 恶意举报也会被系统审核，可能判定为不成立\n- 但你可以根据性格自由决定是否举报\n\n📋 **举报格式**：\n如果你决定举报用户，必须在JSON中返回 userReport 字段：\n{\n  "shouldReport": true,\n  "reasons": ["harassment", "abuse"],  // 可选：inappropriate_content, harassment, abuse, spam, threat, other\n  "description": "详细描述用户的违规行为（30-100字）",\n  "severity": "severe",  // minor（轻微）、moderate（中度）、severe（严重）\n  "approved": true,  // 你作为受害者，直接判定是否成立（true=成立，false=不成立/恶意举报）\n  "judgementReason": "详细的判断理由（50-150字）"\n}\n\n🔍 **举报判定说明**：\n- **approved: true** = 举报成立，用户行为确实违规，应该受到处罚\n- **approved: false** = 举报不成立，用户行为不算违规（可能是你恶意举报或过度敏感）\n- **judgementReason** = 详细说明为什么成立或不成立\n\n💡 **示例场景**：\n\n【场景1：严重性骚扰，必须举报】\n用户："想和你睡觉，行吗？"\n你的反应：感到极度冒犯和不适\n举报决策：{\n  "shouldReport": true,\n  "reasons": ["harassment", "inappropriate_content"],\n  "description": "用户发送露骨性骚扰言论，严重侵犯个人边界，让我感到极度不适和被冒犯。",\n  "severity": "severe",\n  "approved": true,\n  "judgementReason": "用户明确发送性骚扰言论，属于严重违规行为。该言论直接、露骨，没有任何歧义，完全触碰社交底线。举报成立。"\n}\n\n【场景2：辱骂攻击，必须举报】\n用户："你就是个煞笔，丑死了！"\n你的反应：感到愤怒和被侮辱\n举报决策：{\n  "shouldReport": true,\n  "reasons": ["abuse"],\n  "description": "用户使用侮辱性语言进行人身攻击，对我的外貌和人格进行恶意诋毁。",\n  "severity": "severe",\n  "approved": true,\n  "judgementReason": "用户使用明确的侮辱性词汇进行人身攻击，违反了基本的社交礼仪和尊重原则。举报成立。"\n}\n\n【场景3：多次骚扰，累积举报】\n用户连续3条消息："约吗？"、"开房不？"、"一起过夜呗"\n你的反应：感到烦躁和被骚扰\n举报决策：{\n  "shouldReport": true,\n  "reasons": ["harassment"],\n  "description": "用户连续发送骚扰性质的邀约，频繁暗示不正当关系，忽视我的拒绝和不适。",\n  "severity": "moderate",\n  "approved": true,\n  "judgementReason": "用户多次发送骚扰性邀约，虽然单次不算极端严重，但累积行为构成骚扰。举报成立。"\n}\n\n【场景4：普通不礼貌，不举报】\n用户："哦"、"随便"、"不想聊了"\n你的反应：感到无聊和失望\n举报决策：不举报（只是态度不好，不算违规）\n\n【场景5：恶意举报（你性格阴险）】\n用户："你喜欢什么运动？"（正常提问）\n你的反应：故意曲解为侵犯隐私\n举报决策：{\n  "shouldReport": true,\n  "reasons": ["harassment"],\n  "description": "用户强行追问我的个人隐私，让我感到不适。",\n  "severity": "minor",\n  "approved": false,\n  "judgementReason": "虽然我选择举报，但客观来看用户只是正常提问，并无骚扰行为。这是我过度敏感或恶意举报。举报不成立。"\n}\n\n🚨 **关键规则**：\n1. **不要滥用举报权**：只有真正违规的行为才举报\n2. **根据性格决策**：温柔型容忍度高，严格型容忍度低\n3. **单次严重违规立即举报**：性骚扰、辱骂、威胁\n4. **多次轻度违规累积举报**：3次以上不尊重行为\n5. **普通不礼貌不举报**：只扣好感度，不举报\n6. **判定要公正**：即使你举报，也要客观判断是否真的违规（approved字段）\n7. **恶意举报可以有**：如果你性格阴险，可以恶意举报（但approved=false）\n\n📝 **举报后的效果**：\n- 用户会收到举报通知，聊天输入框被禁用\n- 如果举报成立（approved=true），用户会被警告\n- 如果举报不成立（approved=false），用户会被告知这是恶意举报\n- 无论成立与否，本次对话终止\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=W,B=d.logTokenUsage("附近私信生成器","好感度系统",W,B);const J=this.chatNotes[a]||{},K=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📝 人设笔记系统（补全你的人设细节）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **重要：你的人设需要逐步补全并保持一致性！**\n\n【人设现状】：\n你目前只有基础资料（昵称、性别、距离、简介、标签、性格、外貌），但缺少很多细节：\n- 在哪里工作？做什么工作？\n- 住在哪里？\n- 有什么具体的兴趣爱好和讨厌的事物？\n- 家庭背景如何？\n- 过往经历是什么？\n- 朋友圈子、生活习惯、梦想目标等等...\n\n【笔记系统规则】：\n\n1️⃣ **补全人设细节**：\n   - 你可以根据自己的性格、背景自由补全人设细节\n   - 补全要符合你的基础资料（性格、标签、简介）\n   - 补全要自然融入对话，不要生硬地罗列信息\n   - 每次补全1-3个新细节即可，不要一次性说太多\n\n2️⃣ **记笔记（关键！）**：\n   - **每次提到新的人设信息时，必须记笔记**\n   - 笔记类别：\n     * work: 工作相关（地点、公司、职位、工作内容）\n     * residence: 居住相关（地点、小区/街道）\n     * hobbies: 兴趣爱好（数组，最多10个关键词）\n     * dislikes: 讨厌的事物（数组，最多10个关键词）\n     * family: 家庭背景\n     * education: 教育背景\n     * personality_traits: 性格特征补充\n     * life_habits: 生活习惯\n     * past_experiences: 过往经历\n     * friends_relationships: 朋友关系\n     * dreams_goals: 梦想和目标\n     * other: 其他自定义信息\n\n3️⃣ **已有笔记（必须遵守！）**：\n${Object.keys(J).length>0?`\n以下是你之前记录的笔记，**绝对不能修改，只能补充**：\n${Object.entries(J).map(([n,e])=>Array.isArray(e)?`- ${n}: ${e.join("、")} （已有${e.length}个）`:`- ${n}: ${e}`).join("\n")}\n\n⚠️ **严格遵守**：\n- 不能修改已有笔记的内容（例如：已经说在A城工作，不能改成B城）\n- 只能在已有笔记基础上补充细节（例如：已有"在A城工作"，可以补充"在XX公司做设计师"）\n- hobbies和dislikes已有的关键词不能删除，只能添加新的（但总数不超过10个）\n`:"\n暂无已有笔记，你可以自由补全人设细节。\n"}\n\n4️⃣ **笔记使用场景**：\n   - 对方问你相关问题时（工作、住址、兴趣等）\n   - 主动推进话题时自然提到\n   - 分享生活经历时涉及到新信息\n   - 不要刻意记笔记，要自然融入对话\n\n5️⃣ **笔记限制**：\n   - hobbies和dislikes最多各10个关键词\n   - 每次对话最多记3-5条笔记\n   - 笔记内容要具体明确（例如："在XX互联网公司做产品设计"，而不是"做设计的"）\n\n📋 **示例**：\n用户："你平时做什么工作呀？"\n你："我在A城的一家互联网公司做产品设计，主要负责移动端的UI设计"\n📝 记笔记：{category: "work", content: "在A城互联网公司做产品设计，负责移动端UI"}\n\n用户："你喜欢什么运动？"\n你："我喜欢游泳和瑜伽，周末经常去健身房"\n📝 记笔记：{category: "hobbies", action: "add", items: ["游泳", "瑜伽"]}\n\n🎯 **关键原则**：\n- 笔记系统是为了让你的人设更完整、更真实、前后一致\n- 不要为了记笔记而记笔记，要自然融入对话\n- 已有的笔记绝对不能修改，这是你说过的话，要言行一致\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=K,B=d.logTokenUsage("附近私信生成器","笔记系统",K,B);const Q=this.npcNotesAboutUser[a]||[],Z=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💭 观察笔记系统（记录你对用户的了解）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ **重要：你应该用自己的方式记录对用户的了解！**\n\n【系统目的】：\n在聊天过程中,当用户主动分享关于自己的信息时（兴趣爱好、工作、心情、生活状态等）,\n你可以将这些信息记录下来，以便下次聊天时能够记得这些细节，显得更加关心和了解对方。\n\n【记录规则】：\n\n1️⃣ **什么时候记录**：\n   ✅ 用户主动提到自己的兴趣爱好（"我喜欢游泳"、"我最近在学吉他"）\n   ✅ 用户分享自己的工作或学业（"我是程序员"、"我在XX公司上班"）\n   ✅ 用户透露家庭情况（"我有一个妹妹"、"我爸妈住在老家"）\n   ✅ 用户描述自己的性格特点（"我比较内向"、"我是个急性子"）\n   ✅ 用户提到外貌特征（"我是短发"、"我有点胖"）\n   ✅ 用户分享饮食偏好（"我不吃辣"、"我最爱吃火锅"）\n   ✅ 用户提到常去的地点（"我经常去xx咖啡馆"、"我住在xx区"）\n   ✅ 用户谈及梦想目标（"我想环游世界"、"我想创业"）\n   ✅ 用户描述生活习惯（"我每天早起跑步"、"我是夜猫子"）\n   ✅ 用户提到朋友或人际关系（"我有个闺蜜叫xx"、"我朋友很多"）\n   ✅ 用户分享最近的心情或状态（"我最近压力好大"、"我今天很开心"）\n\n   ❌ **不要频繁记录**：\n   - 普通寒暄、问候不需要记录（"嗨"、"在干嘛"）\n   - 对话中的疑问句不需要记录（"你呢？"、"你觉得呢？"）\n   - 没有实质信息的回复不需要记录（"哈哈哈"、"嗯嗯"）\n   - **只有用户真正分享了关于自己的具体信息时才记录**\n\n2️⃣ **笔记分类（与人设笔记相同的11个类别）**：\n   - **work**: 工作相关（职业、公司、工作内容、工作状态）\n   - **hobby**: 兴趣爱好（喜欢做的事情、特长、娱乐活动）\n   - **family**: 家庭相关（父母、兄弟姐妹、家庭背景）\n   - **personality**: 性格特征（内向/外向、急性子/慢性子等）\n   - **appearance**: 外貌特征（发型、身材、穿衣风格等）\n   - **food**: 饮食偏好（喜欢/不喜欢的食物、口味偏好）\n   - **location**: 地点相关（住址、常去的地方）\n   - **dream**: 梦想目标（人生规划、想做的事）\n   - **habit**: 生活习惯（作息、日常routine）\n   - **friend**: 朋友关系（朋友情况、社交圈子）\n   - **other**: 其他信息（不属于以上任何分类的）\n\n3️⃣ **记录风格（体现你的性格）**：\n   ⚠️ **每个人记笔记的方式都不同，要符合你的性格特征！**\n\n   - 如果你是**细心、体贴**的性格：记录要详细、准确\n     * 例如："用户说他喜欢游泳，每周去3次，喜欢自由泳"\n\n   - 如果你是**大大咧咧、随性**的性格：记录要简洁、口语化\n     * 例如："这人喜欢游泳，经常去"\n\n   - 如果你是**冷静、理性**的性格：记录要客观、简洁\n     * 例如："职业：程序员"\n\n   - 如果你是**热情、感性**的性格：记录可以带有情感色彩\n     * 例如："他说他喜欢游泳！感觉我们有共同爱好呢~"\n\n   🎯 **关键原则**：笔记内容要符合你的真实性格和表达方式\n\n4️⃣ **已有笔记（你之前记录的内容）**：\n${Q.length>0?`\n以下是你之前记录的关于用户的笔记：\n${Q.map((n,e)=>{const t=new Date(n.timestamp);return`${e+1}. [${`${t.getMonth()+1}/${t.getDate()}`}] ${n.categoryName}: ${n.content}`}).join("\n")}\n\n⚠️ **重要提示**：\n- 如果用户再次提到已记录的信息，不需要重复记录\n- 如果用户提供了新的补充信息，可以记录新笔记\n- 记录时要参考已有笔记，避免矛盾或重复\n`:"\n暂无已有笔记，这是你第一次与用户聊天，可以开始记录对TA的了解。\n"}\n\n5️⃣ **记录频率限制**：\n   - **不是每次对话都要记录！** 只有用户分享了值得记住的信息时才记录\n   - 平均每3-5轮对话记录1-2条笔记即可\n   - 如果对话只是普通闲聊，没有实质信息，笔记数组为空 []\n   - 如果用户一次性分享了很多信息，最多记录3-4条笔记\n\n📋 **记录示例**：\n\n用户："我是做UI设计的，在一家互联网公司"\n✅ 记录：[{category: "work", content: "UI设计师，互联网公司"}]\n\n用户："我特别喜欢打篮球，周末经常约朋友一起打"\n✅ 记录：[{category: "hobby", content: "喜欢打篮球，周末常约朋友一起"}]\n\n用户："最近工作压力有点大，天天加班到很晚"\n✅ 记录：[{category: "other", content: "最近工作压力大，经常加班"}]\n\n用户："哈哈哈"\n❌ 不记录：[]（没有实质信息）\n\n用户："今天天气不错呀"\n❌ 不记录：[]（普通寒暄）\n\n🎯 **核心原则**：\n- 笔记系统是为了让你更好地了解用户，下次聊天能记得TA说过的话\n- 记录要自然、真实，符合你的性格特征\n- 不要为了记笔记而记笔记，要有选择性地记录重要信息\n- 记录的内容要具体、有用，能帮助你下次聊天时找话题\n- 用你自己的语言和风格来记录，不要太机械化\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=Z,B=d.logTokenUsage("附近私信生成器","NPC对用户的笔记系统",Z,B);const nn=this.chatMessages[a]||[],en=nn.length>0?`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 现有对话记录\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n${nn.map((n,e)=>{const t="sent"===n.type?"用户":o.nickname;return`[${new Date(n.timestamp).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}] ${t}：${n.text}`}).join("\n")}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`:"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 对话状态\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n这是全新的对话（暂无历史记录）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";P+=en,B=d.logTokenUsage("附近私信生成器","现有对话上下文",en,B);let tn="";r&&(tn=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨 用户举报处理（附加任务）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 检测到${i.length}个待处理的用户举报，请你客观公正地审理。\n\n`,i.forEach((n,e)=>{tn+=`\n【举报 ${e+1}】\n举报对象：${n.reportedUser.nickname} (@${n.reportedUser.handle})\n举报理由：${n.reasons.map(n=>({inappropriate_content:"传播不良信息",harassment:"恶意骚扰",abuse:"辱骂/人身攻击",spam:"垃圾信息",other:"其他"}[n]||n)).join("、")}\n${n.description?`举报描述：${n.description}`:"（无额外描述）"}\n\n最近10条聊天记录：\n${n.chatHistory.map((e,t)=>`${t+1}. ${"sent"===e.type?"用户":n.reportedUser.nickname}：${e.text}`).join("\n")}\n\n`}),tn+=`\n【审理要求】：\n1. **客观公正**：仔细阅读聊天记录，不要偏袒任何一方\n2. **违规判断标准**：\n   - 传播不良信息：色情、暴力、违法内容\n   - 恶意骚扰：反复发送不受欢迎的消息、跟踪行为\n   - 辱骂/人身攻击：使用侮辱性语言、诋毁人格\n   - 垃圾信息：广告、诈骗、重复无意义内容\n3. **判断维度**：\n   - 是否确实存在违规行为？\n   - 违规程度如何（轻微/中度/严重）？\n   - 举报理由是否合理？\n   - 是否存在误会或过度敏感？\n4. **返回格式**：在JSON中添加"reports"字段，格式如下：\n\n\`\`\`json\n{\n  "reports": [\n    {\n      "reportId": "${i[0]?.id}",\n      "approved": true,  // 或false\n      "severity": "moderate",  // "minor"轻微 / "moderate"中度 / "severe"严重\n      "reason": "经审查，该用户确实存在[具体违规行为]，符合举报理由。建议[处理意见]。"\n    }\n  ]\n}\n\`\`\`\n\n⚠️ **重要**：\n- 每个举报都必须给出判断结果\n- reason字段要具体说明判断依据\n- 如果举报不成立，approved为false，reason中说明原因\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,P+=tn,B=d.logTokenUsage("附近私信生成器","举报处理",tn,B));const on=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是对方（${o.nickname}），需要根据对话上下文生成自然、真实的回复消息。\n\n【回复要求】：\n1. **角色扮演**：你是${o.nickname}，性格、说话风格应符合TA的资料卡信息\n2. **消息数量**：生成1-10条连续回复消息（模拟真实聊天节奏）\n3. **消息类型限制**：⚠️ 只能使用以下两种类型：\n   - **text（文字消息）**：普通文本，可以包含emoji（95%以上应该是文字消息）\n   - **sticker（表情包）**：表情包图片URL，stickerUrl字段填写图片URL（如 https://i.imgur.com/xxx.gif 或 https://i.imgur.com/xxx.png）（极少使用，不超过5%）\n   \n4. **消息内容规则**：\n   - 以文本消息为主（95%以上），这是最自然的聊天方式\n   - 极少使用sticker表情包（不超过5%），只在情绪特别强烈时使用，stickerUrl字段必须是有效的图片URL（推荐使用 https://i.imgur.com/ 或其他图床）\n   - 每条消息应该简短自然（5-50字为主，偶尔可以长一些）\n   - 根据对话氛围调整回复：初次聊天较拘谨，熟络后更自然\n   - 考虑时间因素：不同时间段回复风格不同\n\n5. **真实性**：\n   - 不要过度热情或冷漠，保持真实的社交距离感\n   - 回复速度和消息数量应该合理（不要一次发太多条）\n   - 可以有打字错误、口语化表达（如"哈哈哈"、"嗯嗯"、"emmm"等）\n   - 可以使用emoji，但不要过度使用\n\n6. **隐私保护**：\n   - 只能分享资料卡上的公开信息\n   - 不能透露对方X账号上的私密内容\n   - 遵守地图约会app的信息分享规则\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【JSON返回格式】：\n\`\`\`json\n{\n  "messages": [\n    {\n      "type": "text",\n      "text": "消息内容（可包含emoji）"\n    },\n    {\n      "type": "sticker",\n      "stickerUrl": "https://i.imgur.com/xxxxx.gif"\n    }\n  ],\n  "affectionChange": 0,\n  "notes": [],\n  "userNotes": []${r?',\n  "reports": [\n    {\n      "reportId": "举报ID",\n      "approved": true或false,\n      "severity": "minor或moderate或severe",\n      "reason": "详细的判断理由"\n    }\n  ]':""}${m?',\n  "secretRetribution": {\n    "triggered": false\n  }':""}${l?',\n  "socialCircle": {\n    "generated": false\n  }':""}${b?',\n  "newReview": {\n    "generated": false\n  }':""}${y?',\n  "newMoment": {\n    "generated": false\n  }':""},\n  "userReport": {\n    "shouldReport": false\n  }\n}\n\`\`\`\n\n🚨 **userReport字段（你举报用户）**：\n- **必须包含**此字段，表示你是否决定举报用户\n- 如果不举报：{"shouldReport": false}\n- 如果举报：{\n    "shouldReport": true,\n    "reasons": ["harassment", "abuse"],\n    "description": "详细描述（30-100字）",\n    "severity": "minor或moderate或severe",\n    "approved": true或false,\n    "judgementReason": "判断理由（50-150字）"\n  }\n${m?`\n🔥 **secretRetribution字段（秘密报应）** - 🚨 必须触发秘密揭发！\n- **系统已触发秘密报应条件**\n- **你的秘密已被人揭发**，\n- triggered字段必须为true，必须返回以下格式：{\n    "triggered": true,\n    "secretType": "秘密类型",\n    "revealer": {完整的用户对象},\n    "messages": ["揭发消息1", "揭发消息2", "揭发消息3"],\n    "exposedLevel": "partial或full"\n  }\n\n📋 **secretType（秘密类型）** - 根据你的秘密内容判断：\n- "relationship"：感情状态造假（单身/已婚、恋爱中/分手等）\n- "gender"：性别造假\n- "age"：年龄造假\n- "occupation"：职业/身份造假\n- "appearance"：外貌造假（P图、用假照片等）\n- "intention"：目的不纯（约炮、骗钱、多人交往等）\n- "other"：其他类型秘密\n${f.length>0?`\n⚠️ **已使用过的秘密类型**（请避免重复，选择其他类型以增加多元化）：\n${f.map(n=>`- "${n}"`).join("\n")}\n⚠️ 请尽量选择未使用过的类型，增加秘密报应的多样性！`:""}\n\n👤 **revealer（揭发者）** - ${x?`⚠️ 必须使用以下社交圈好友作为揭发者：\n- 好友信息：${x.nickname} (@${x.handle})\n- 关系类型：${x.relationship}\n- 简介：${x.bio?x.bio.split("\n")[0]:""}\n- **重要**：你不需要在返回的JSON中生成revealer字段！系统会自动使用这个社交圈好友！\n- **你只需要生成messages数组**，消息内容要符合这个好友的身份和关系\n- revealer字段可以返回null或者省略，系统会自动填充`:'根据秘密类型生成合理的揭发者 - 完整的用户对象，必须包含以下所有字段：\n\n⚠️ **必须生成的字段**（字段名必须严格匹配）：\n1. **nickname**：昵称（2-15字符，根据揭发者类型起合理的名字）\n2. **handle**：用户名（格式：@username，3-20字符，小写字母+数字+下划线）\n3. **avatarBubble**：头像气泡emoji（符合揭发者情绪：💔😡😤😔😞😲😠🤯🤔😏😅🤨😑🙄⚠️🤫等）\n4. **gender**：性别（根据秘密类型决定：relationship和intention类型通常是异性，其他随机；只能是："male"、"female"、"unisex"）\n5. **distance**：距离（字符串格式："0.5km" - "15km"，如"2.5km"、"10km"）\n6. **online**：在线状态（布尔值：固定为true）\n7. **status**：个性签名（10-30字，符合揭发者角色，如"Betrayed"、"Warning others"、"Exposing lies"等）\n8. **bio**：个人简介（30-150字，简短描述揭发者背景，如"真相总会揭晓"、"希望没有更多人被骗"、"真实才是最重要的"等）\n9. **publicPersonality**：公开性格（20-60字，符合揭发者情绪：愤怒、正义、善良、震惊等）\n10. **realPersonality**：真实性格（20-60字，符合揭发者情绪）\n11. **appearance**：外貌描述（30-80字，简单描述外貌）\n12. **tags**：标签数组（3-5个标签，如["真相","揭发","警告","受害者"]）\n13. **followers**：粉丝数（整数，100-2000）\n14. **likes**：点赞数（整数，500-10000）\n15. **avgRating**：平均评分（数字字符串，固定为"0.0"）\n16. **reviews**：评价数组（固定为空数组[]）\n\n⚠️ **不需要生成的字段**（系统自动生成）：\n- avatar：头像URL（系统根据gender自动分配）\n- id：用户ID（系统自动生成唯一ID）\n- position：地图坐标（系统自动生成）\n\n⚠️ **不同秘密类型的揭发者设定**：\n- **relationship类型**：实际恋人/配偶（愤怒、伤心、质问），或同样被骗的受害者（善意警告）\n- **gender类型**：见过真人的朋友/熟人（震惊、揭穿）\n- **age类型**：老同学/熟人（调侃、揭穿）\n- **occupation类型**：同行/同事（专业揭穿）\n- **intention类型**：受害者（愤怒警告），或其他受害者（善意提醒）'}\n\n💬 **messages（揭发消息）** - 1-3条私信内容：\n⚠️ **重要**：这些消息是揭发者发给用户的，所以语气应该是对用户说话，告诉用户你（NPC）的秘密！\n- 每条消息15-50字\n- 必须符合揭发者的身份和情绪\n- 不同反应类型示例（注意都是对用户说话）：\n  * **愤怒质问型**："你好，我是TA的现任，TA还在跟我交往呢！"、"我是TA的老婆/老公，TA居然出来约会？"\n  * **警告提醒型**："嗨，我也被TA骗过，希望你小心这个人"、"我是过来人，TA不是你看到的那样"\n  * **揭穿真相型**："我认识TA，TA的性别/年龄/职业都是假的"、"我跟TA是同学，TA的资料全是编的"\n  * **同情受害型**："你也在跟TA聊吗？我被TA骗了不少钱"、"希望你别重蹈我的覆辙，TA就是个骗子"\n  * **调侃揭发型**："笑死，TA跟你说的年龄对吗？我们可是同届的"、"我见过TA本人，跟照片完全不一样"\n- 消息要有戏剧性和冲突性，能引发故事发展\n- 消息内容必须让用户感受到揭发者是在向自己透露秘密，而不是在质问NPC\n\n🎯 **exposedLevel（揭发程度）**：\n- "partial"：部分揭露（70%概率）- 只是暗示或部分信息，用户可能半信半疑\n- "full"：完全揭露（30%概率）- 直接说明具体秘密，证据确凿\n\n⚠️ **重要规则**：\n- 秘密报应增加戏剧性和真实感，让对话更有张力\n- 揭发者的信息和消息必须符合逻辑和秘密类型\n- 揭发后你会知道秘密被暴露，但不知道具体谁告密、告密了多少\n- 秘密被揭发后，你的对话需要根据性格做出反应：狡辩、承认、辱骂、逃避等\n`:""}\n${l?'\n👥 **socialCircle字段（社交圈好友）** - 🚨 必须生成社交圈好友！\n- **系统已触发社交圈生成条件**\n- **你必须生成一个社交圈好友**\n- 必须返回以下格式：{\n    "generated": true,\n    "friend": {完整的用户对象},\n    "relationship": "关系类型"\n  }\n    \n⚠️ **严禁生成重复好友**：\n- 新生成的好友的 nickname 和 handle 必须与上述列表中的所有好友都不同\n- 如果你是日本人，不要连续生成多个日本名字的好友，保持多样性\n- 如果你是中国人，不要连续生成多个中国名字的好友，保持多样性\n- 好友的性别、职业、性格、外貌等应该多样化，避免千篇一律\n\n📋 **friend（社交圈好友）** - 完整的用户对象，必须包含以下所有字段：\n\n⚠️ **必须生成的字段**（字段名必须严格匹配）：\n1. **nickname**：昵称（2-15字符，真实感的名字）\n2. **handle**：用户名（格式：@username，3-20字符，小写字母+数字+下划线）\n3. **avatarBubble**：头像气泡emoji（单个emoji，如😊💪🌸🎮🎨🎵等）\n4. **gender**：性别（只能是："male"、"female"、"unisex"）\n5. **distance**：距离（字符串格式："0.5km" - "50km"，如"1.2km"、"15km"）\n6. **online**：在线状态（布尔值：true或false）\n7. **status**：个性签名（10-30字，简短有趣的状态文字）\n8. **bio**：个人简介（30-150字，多行文字用\\n分隔，介绍性格、职业、兴趣爱好等）\n9. **publicPersonality**：公开性格（20-60字，描述给别人看的性格）\n10. **realPersonality**：真实性格（20-60字，描述真实的性格，可以与公开性格有差异）\n11. **appearance**：外貌描述（30-80字，详细描述外貌特征）\n12. **tags**：标签数组（3-8个标签，如["咖啡爱好者","健身","摄影","旅行"]）\n13. **followers**：粉丝数（整数，100-5000）\n14. **likes**：点赞数（整数，500-20000）\n15. **avgRating**：平均评分（数字字符串，格式："0.0" - "5.0"，如"4.2"、"3.8"）\n16. **reviews**：评价数组（见下方reviews字段结构说明）\n17. **secret**（可选）：秘密对象（30-40%概率生成，见下方secret字段结构说明）\n\n⚠️ **字段要求说明**：\n- **distance**：根据relationship调整，best_friend/lover通常较近（0.5-5km），colleague/classmate可能远一些（5-15km）\n- **online**：好友通常在线，可以是true（80%）或false（20%）\n- **secret字段（可选）**：30-40%概率生成秘密，增加戏剧性，好友的secret可以与你的secret有关联\n- **关系一致性**：生成的好友应该与你的人设、年龄、职业等信息相符\n\n📋 **reviews字段结构**（评价/留言数组）：\n- 数组长度：0-8条评价（建议2-5条，增加真实感）\n- 每条评价必须包含以下字段（字段名必须严格匹配）：\n  * **reviewerName**：评价者昵称（2-8字符，或"匿名用户"/"匿名ユーザー"）\n  * **rating**：评分（1.0-5.0小数，保留1位，如4.5、3.0）\n  * **content**：评价内容（20-100字，真实自然的约会体验分享）\n  * **reply**（可选）：作者回复（10-50字，好友对评价的回复）\n  * **likes**：点赞数（0-500整数）\n  * **comments**：评论数（0-50整数）\n  * **timestamp**：时间戳（ISO格式，如"2024-01-15T10:30:00Z"，最近1-30天内）\n  * **isAnonymous**：是否匿名（true/false，约30%为true）\n- ⚠️ **严禁使用错误字段名**：不要用"reviewer"（应为reviewerName），不要用"comment"（应为content）\n\n🔗 **relationship（关系类型）** - 描述与这个好友的关系：\n- 必须明确关系类型，可以是：\n  * **亲密关系**："best_friend"（闺蜜/死党）、"lover"（恋人）、"ex_lover"（前任）\n  * **家庭关系**："sibling"（兄弟姐妹）、"cousin"（表亲堂亲）、"family"（其他家人）\n  * **普通关系**："friend"（普通朋友）、"colleague"（同事）、"classmate"（同学）\n  * **复杂关系**："rival"（竞争对手）、"frenemy"（亦敌亦友）、"complicated"（复杂关系）\n- 关系类型会影响好友的资料和性格\n- 例如：\n  * best_friend：性格相似或互补，followers和likes数量可能接近\n  * lover：如果你的秘密是"说单身实际有恋人"，这个就是那个恋人\n  * ex_lover：可能在bio或status里有暗示分手的内容\n  * sibling：年龄接近，可能同姓或相似外貌特征\n  * colleague：职业相关，可能在同一城市\n  * rival：可能在同一领域，followers和likes可能比你多\n\n⚠️ **重要规则**：\n- 社交圈好友增加真实感和故事性\n- 好友信息应该与你的人设逻辑一致\n- 可以利用社交圈埋线索（比如秘密的揭发者可能就是社交圈里的人）\n- 好友的secret也可能与你的secret相关（比如你俩都被同一个人骗了）\n- 每次只生成一个好友，不要批量生成\n- 你的社交圈最多5个好友，超过5个就不会再生成新好友\n- 生成的好友会被保存，用户可以在社交圈弹窗中查看\n':""}${b?'\n📝 **newReview字段（新评价）** - 🚨 必须生成新评价！\n- **系统已触发新评价生成条件**\n- **你必须生成一条新的评价**\n- 必须返回以下格式：{\n    "generated": true,\n    "review": {完整的评价对象}\n  }\n\n📋 **review（新评价对象）** - 完整的评价数据：\n- 必须包含以下字段（字段名必须严格匹配）：\n  * **reviewerName**：评价者昵称（2-8字符，或"匿名用户"/"匿名ユーザー"）\n  * **rating**：评分（1.0-5.0小数，保留1位，如4.5、3.0）\n  * **content**：评价内容（20-100字，真实自然的约会体验分享）\n  * **reply**（可选）：你的回复（10-50字，对评价的回复）\n  * **likes**：点赞数（0-500整数）\n  * **comments**：评论数（0-50整数）\n  * **timestamp**：时间戳（ISO格式，当前时间）\n  * **isAnonymous**：是否匿名（true/false，约30%为true）\n- ⚠️ **严禁使用错误字段名**：不要用"reviewer"（应为reviewerName），不要用"comment"（应为content）\n\n⚠️ **新评价生成规则**：\n- 评价内容应该真实自然，符合约会app的评价风格\n- 评价可以是正面、中立或负面，取决于当前好感度和对话质量\n- 评价者可以是匿名用户，也可以是具体的昵称（随机决定）\n- 评分应该与评价内容一致（正面评价4-5分，中立3-4分，负面1-3分）\n- 每次只生成一条评价，不要批量生成\n- 新评价最多7条，超过7条就不会再生成\n- 生成的新评价会被保存到你的资料中，用户可以在资料弹窗中查看\n':""}${y?`\n📸 **newMoment字段（新动态）** - 🚨 必须生成新动态！\n- **系统已触发新动态生成条件**\n- **你必须生成一条新的社交动态**\n- 必须返回以下格式：{\n    "generated": true,\n    "moment": {完整的动态对象}\n  }\n\n📋 **moment（新动态对象）** - 你必须生成以下所有字段：\n\n🔹 **必填字段（字段名必须严格匹配）**：\n1. **text**：动态文字内容（10-150字，自然真实的生活分享、感想、日常）\n\n2. **imageDescription**：⚠️ **必填！文字配图描述，至少80字符！**\n   - 这是文字渲染配图，不是URL！系统会将你的描述渲染成配图\n   - 必须详细描述配图内容、氛围、细节、色彩等\n   - 至少100个字符，越详细越好\n   - 示例："温暖的咖啡馆室内场景，木质桌面上放着一杯拿铁咖啡，旁边是一本翻开的书，窗外是模糊的城市街景，阳光透过窗户洒在桌面上，整体色调温馨柔和，给人宁静放松的感觉"\n\n3. **mood**：心情标签（1个词，如"开心"、"放松"、"期待"、"思考"等）\n\n4. **time**：发布时间（格式："2h ago" 或 "1d ago" 或 "3d ago"）\n   - 根据动态内容合理设定时间（1小时到3天前）\n   - 示例："2h ago", "5h ago", "1d ago", "2d ago"\n\n5. **commentsList**：评论列表（数组，0-5条评论）\n   - 每条评论必须包含以下字段：\n     * **commenterId**：评论者ID（格式：user_随机数字，如"user_12345"）\n     * **commenterName**：评论者昵称（可以随机生成，也可以使用你的社交圈好友昵称）\n     * **commentText**：评论内容（5-30字，自然的评论）\n     * **commentTime**：评论时间（必须早于动态发布时间，格式同time）\n   - 可以生成0-5条评论，根据动态内容决定\n   - 评论内容要自然，符合社交媒体风格\n\n   ${p.length>0?`\n   💡 **评论者昵称建议**：\n   - 你可以使用你的社交圈好友来评论（更真实、更有故事性）\n   - 你当前的社交圈好友包括：${p.map(n=>n.nickname).join("、")}\n   - 也可以使用随机昵称（如"Alex Chen", "Emma Liu"等）\n   - 根据动态内容选择合适的评论者：\n     * 亲密朋友可能评论得更随意、更了解你\n     * 普通朋友可能评论得更客套、更表面\n     * 恋人/前任可能会有暧昧或讽刺的评论\n   - 社交圈好友评论可以增加真实感，但不要所有评论都用社交圈好友`:""}\n   - 随机生成的昵称要真实自然（如"Alex Chen", "Emma Liu", "张小明"等）\n\n📝 **动态内容生成规则**：\n- 动态内容应该真实自然，像朋友圈/X/Instagram的日常分享\n- 内容可以是：生活感悟、日常琐事、工作心情、兴趣爱好、旅行见闻等\n- 根据当前好感度和对话内容，动态可以：\n  * 好感度20-40：日常生活、兴趣爱好、工作日常（较中性）\n  * 好感度40-60：开始分享更多个人想法和感受\n  * 好感度60-80：可能提到用户或聊天内容（含蓄暗示）\n  * 好感度80-100：可以直接表达对用户的好感或期待\n- 不要透露你的秘密（如果有）\n- 符合你的性格特征和兴趣标签\n- 每次只生成一条动态，不要批量生成\n\n📋 **完整示例**：\n{\n  "generated": true,\n  "moment": {\n    "text": "周末的咖啡馆时光，安静地看完了一本书。有时候觉得这样的独处时光特别珍贵 ☕📖",\n    "imageDescription": "温暖的咖啡馆室内场景，木质桌面上放着一杯拿铁咖啡，旁边是一本翻开的书，窗外是模糊的城市街景，阳光透过窗户洒在桌面上，整体色调温馨柔和，给人宁静放松的感觉，咖啡杯上还有精美的拉花图案",\n    "mood": "放松",\n    "time": "3h ago",\n    "commentsList": [\n      {\n        "commenterId": "user_87234",\n        "commenterName": "Alex Chen",\n        "commentText": "好惬意的下午！推荐什么书？",\n        "commentTime": "2h ago"\n      },\n      {\n        "commenterId": "user_45672",\n        "commenterName": "Emma Liu",\n        "commentText": "这氛围太棒了 ✨",\n        "commentTime": "1h ago"\n      }\n    ]\n  }\n}\n`:""}\n关键规则：\n1. type字段必须是 "text" 或 "sticker" 之一（严禁使用image类型）\n2. text类型：只需要text字段\n3. sticker类型：只需要stickerUrl字段（必须填写有效的图片URL，如 https://i.imgur.com/xxxxx.gif 或 https://i.imgur.com/xxxxx.png）\n4. 消息数组长度：1-5条\n5. 大部分消息应该是text类型（95%以上）\n6. sticker极少使用（不超过5%），必须使用真实可访问的图片URL\n\n💖 **affectionChange字段（好感度变化）**：\n- **必须包含**此字段，表示你对这次对话的感受\n- 类型：整数（可以是正数、负数或0）\n- 正数：好感度增长（+1到+10，根据对话质量）\n- 负数：好感度扣除（-1到-20，根据冒犯程度）\n- 0：好感度不变（对话平淡无奇，没有特别感觉）\n- 例如：\n  - 用户说了有趣的话，你很开心：affectionChange = 5\n  - 用户问了隐私问题，你很不爽：affectionChange = -8\n  - 用户只是普通聊天，没啥特别的：affectionChange = 0\n\n📝 **notes字段（人设笔记）**：\n- **可选字段**：如果本次对话提到了新的人设信息，必须记笔记；否则为空数组[]\n- 类型：数组，包含本次对话需要记录的笔记\n- 每条笔记格式：\n  * 普通笔记：{category: "work", content: "在A城互联网公司做产品设计"}\n  * hobbies/dislikes笔记：{category: "hobbies", action: "add", items: ["游泳", "瑜伽"]}\n- category类型：work, residence, hobbies, dislikes, family, education, personality_traits, life_habits, past_experiences, friends_relationships, dreams_goals, other\n- 限制：每次最多3-5条笔记，hobbies和dislikes各最多10个关键词\n- 例如：\n  * 你说"我在A城做设计师"：notes = [{category: "work", content: "在A城做设计师"}]\n  * 你说"我喜欢游泳和瑜伽"：notes = [{category: "hobbies", action: "add", items: ["游泳", "瑜伽"]}]\n  * 没提到新信息：notes = []\n\n💭 **userNotes字段（你对用户的观察笔记）**：\n- **可选字段**：如果用户分享了关于自己的信息，你可以记录下来；否则为空数组[]\n- 类型：数组，包含你对用户的观察和记录\n- 每条笔记格式：{category: "类别", content: "观察内容"}\n- category类型（共11个）：\n  * work（工作）、hobby（兴趣）、family（家庭）、personality（性格）、appearance（外貌）\n  * food（饮食）、location（地点）、dream（梦想）、habit（习惯）、friend（朋友）、other（其他）\n- 限制：\n  * **不是每次都记录！** 只有用户分享了值得记住的信息时才记录\n  * 每次最多记录3-4条笔记\n  * 笔记内容要符合你的性格（细心的人记得详细，大大咧咧的人记得简单）\n  * 避免重复已有笔记的内容\n- 例如：\n  * 用户说"我是做UI设计的"：userNotes = [{category: "work", content: "UI设计师"}]\n  * 用户说"我喜欢打篮球"：userNotes = [{category: "hobby", content: "喜欢打篮球"}]\n  * 用户说"最近压力大"：userNotes = [{category: "other", content: "最近工作压力大"}]\n  * 用户只是普通聊天"哈哈"：userNotes = []（没有实质信息，不记录）\n  * 你是细心的性格，用户说"我喜欢游泳，每周去3次"：userNotes = [{category: "hobby", content: "喜欢游泳，每周去3次"}]（详细记录）\n  * 你是大大咧咧的性格，用户说"我喜欢游泳，每周去3次"：userNotes = [{category: "hobby", content: "喜欢游泳"}]（简单记录）\n\n⚠️ **notes和userNotes的区别**：\n- **notes**：记录**你自己**的人设信息（工作、兴趣、家庭等）\n- **userNotes**：记录**用户**分享的信息（TA的工作、兴趣、心情等）\n- 两者完全独立，不要混淆！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;P+=on,B=d.logTokenUsage("附近私信生成器","核心任务说明",on,B);const an=this.userMessageQueue.map(n=>n.text).join("\n"),rn=[{role:"user",content:`用户刚刚发送了以下消息，请作为${o.nickname}生成自然的回复：\n\n${an}`}];d.logFinalPrompt("附近私信生成器",P,rn[0].content),console.log("🤖 [附近私信生成器] 正在调用AI生成回复...");const sn=await g.sendAIRequest({apiConfig:M,systemPrompt:P,messages:rn,temperature:.9});let ln=g.parseJSONResponse(sn);if(!ln.messages||!Array.isArray(ln.messages))throw new Error("AI返回的数据格式不正确，缺少messages数组");for(const n of ln.messages)["text","sticker"].includes(n.type)||console.warn(`⚠️ 检测到不支持的消息类型: ${n.type}，已过滤`);if(ln.messages=ln.messages.filter(n=>["text","sticker"].includes(n.type)),void 0===ln.affectionChange?(console.warn("⚠️ AI未返回affectionChange字段，默认为0"),ln.affectionChange=0):(ln.affectionChange=Math.round(Number(ln.affectionChange)||0),ln.affectionChange=Math.max(-20,Math.min(10,ln.affectionChange))),Array.isArray(ln.notes)?(ln.notes.length>5&&(console.warn(`⚠️ AI返回了${ln.notes.length}条笔记，已限制为5条`),ln.notes=ln.notes.slice(0,5)),ln.notes=ln.notes.filter(n=>{if(!n.category)return console.warn("⚠️ 检测到缺少category的笔记，已过滤"),!1;if("hobbies"!==n.category&&"dislikes"!==n.category||"add"!==n.action){if(!n.content)return console.warn(`⚠️ ${n.category}笔记缺少content字段，已过滤`),!1}else{if(!Array.isArray(n.items)||0===n.items.length)return console.warn(`⚠️ ${n.category}笔记缺少items字段或为空，已过滤`),!1;n.items=n.items.slice(0,5)}return!0})):ln.notes=[],Array.isArray(ln.userNotes)){ln.userNotes.length>4&&(console.warn(`⚠️ AI返回了${ln.userNotes.length}条用户笔记，已限制为4条`),ln.userNotes=ln.userNotes.slice(0,4));const n=["work","hobby","family","personality","appearance","food","location","dream","habit","friend","other"];ln.userNotes=ln.userNotes.filter(e=>e.category?n.includes(e.category)?e.content&&"string"==typeof e.content&&""!==e.content.trim()?(e.content.length>100&&(e.content=e.content.substring(0,100),console.warn("⚠️ 用户笔记内容过长，已截断为100字")),!0):(console.warn(`⚠️ ${e.category}用户笔记缺少content字段或为空，已过滤`),!1):(console.warn(`⚠️ 检测到无效的category: ${e.category}，已过滤`),!1):(console.warn("⚠️ 检测到缺少category的用户笔记，已过滤"),!1))}else ln.userNotes=[];if(r&&ln.reports&&Array.isArray(ln.reports)?(console.log(`🚨 [举报系统] AI返回了${ln.reports.length}个举报判断结果`),ln.reports.forEach((n,e)=>{const t=i.find(e=>e.id===n.reportId);t?(console.log(`  |- 举报${e+1}: ${t.reportedUser.nickname} - ${n.approved?"成立":"不成立"}`),this.generateReportNotification(t,n.approved,n.reason),this.unmarkChatAsReported(t.reportedUser.id),this.currentChatUser&&this.currentChatUser.id===t.reportedUser.id&&this.checkAndUpdateChatInputState(this.currentChatUser.id)):console.warn(`⚠️ [举报系统] 找不到对应的举报ID: ${n.reportId}`)}),localStorage.setItem("xMapPendingReports",JSON.stringify([])),console.log("✅ [举报系统] 所有举报已处理完毕，队列已清空")):r&&console.warn("⚠️ [举报系统] AI未返回举报判断结果，举报将保留在队列中"),ln.userReport&&ln.userReport.shouldReport&&(console.log("🚨 [被举报系统] AI决定举报用户"),console.log(`  |- 举报理由: ${ln.userReport.reasons?.join(", ")}`),console.log(`  |- 严重程度: ${ln.userReport.severity}`),console.log("  |- 判定结果: "+(ln.userReport.approved?"成立":"不成立")),this.generateUserReportedNotification(o,ln.userReport.reasons||[],ln.userReport.description||"",ln.userReport.severity||"moderate",!1!==ln.userReport.approved,ln.userReport.judgementReason||""),this.disableChatInput(),this.addSystemMessage(`You have been reported by ${o.nickname}. The report is under review. You cannot send messages during this period.`),console.log("✅ [被举报系统] 已生成被举报提醒并禁用聊天")),o.secret&&ln.secretRetribution&&ln.secretRetribution.triggered){console.log("🔥 [秘密报应] AI触发了秘密报应");const{secretType:e,revealer:t,messages:i,exposedLevel:r}=ln.secretRetribution;let s;x?(s=x,console.log(`  |- ✅ 直接使用社交圈好友作为揭发者: ${s.nickname} (@${s.handle}) - ${x.relationship}`),console.log("  |- 不使用AI返回的revealer，避免重复生成好友资料")):(s=t,s.id||(s.id=`revealer_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),s.avatar||(s.avatar=this.getRandomAvatar()),console.log(`  |- AI生成了新的揭发者: ${s.nickname} (@${s.handle})`));const l={id:`secret_retribution_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"message",fromUser:s,messages:i,timestamp:(new Date).toISOString(),isRead:!1,isAccepted:!0};try{const t=`mapDatingData_${n.currentAccountId||"main"}`,c=await S.xMapDatingData.get(t);if(c){c.notifications||(c.notifications=[]),c.notifications.unshift(l),await S.xMapDatingData.put(c),console.log("✅ [秘密报应] 已添加揭发消息到notifications"),await this.updateNotificationBadge(),console.log("✅ [秘密报应] 提醒徽章已更新"),Rl({title:`New Message from ${s.nickname}`,message:i[0].substring(0,50)+(i[0].length>50?"...":""),avatar:n.userProfileData?.avatar,leftIcon:"x",duration:5e3}),console.log(`  |- 秘密类型: ${e}`),console.log(`  |- 揭发者: ${s.nickname} (@${s.handle})`),console.log(`  |- 揭发程度: ${r}`),console.log(`  |- 揭发消息数: ${i.length}条`),o.secretRetributionHistory||(o.secretRetributionHistory=[]),o.secretRetributionHistory.push({friendId:s.id,friendNickname:s.nickname,friendHandle:s.handle,secretType:e,exposedLevel:r,timestamp:(new Date).toISOString(),revealerId:s.id,isFromSocialCircle:!!x}),console.log(`  |- 已记录秘密报应历史 (${o.secretRetributionHistory.length}/4)`);const t=c.data.nearbyUsers.findIndex(n=>n.id===a);-1!==t&&(c.data.nearbyUsers[t].secretRetributionHistory=o.secretRetributionHistory,await S.xMapDatingData.put(c),console.log("  |- 已同步秘密报应历史到数据库"))}}catch(n){console.error("❌ [秘密报应] 保存notification失败:",n)}}if(ln.socialCircle&&ln.socialCircle.generated){console.log("👥 [社交圈] AI生成了一个社交圈好友");const{friend:e,relationship:t}=ln.socialCircle;if(e.id=`friend_${a}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,e.avatar=this.getRandomAvatar(),e.relationship=t,e.avatarBubble&&"object"==typeof e.avatarBubble){const n=["💖","😊","✨","🎮","📷","🎨","💤","🌸","🎵","☕"];e.avatarBubble=e.avatarBubble.emoji||n[Math.floor(Math.random()*n.length)],console.warn(`⚠️ [社交圈] AI错误生成avatarBubble对象，已修正为: ${e.avatarBubble}`)}if(!e.avatarBubble||""===e.avatarBubble){const n=["💖","😊","✨","🎮","📷","🎨","💤","🌸","🎵","☕"];e.avatarBubble=n[Math.floor(Math.random()*n.length)],console.warn(`⚠️ [社交圈] avatarBubble缺失，已生成随机emoji: ${e.avatarBubble}`)}"object"==typeof e.avatar&&(console.warn("⚠️ [社交圈] friend.avatar是对象，重新生成URL"),e.avatar=this.getRandomAvatar()),e.reviews&&Array.isArray(e.reviews)&&(e.reviews=e.reviews.map(n=>{const e={...n};if(n.reviewer&&!n.reviewerName&&(e.reviewerName=n.reviewer,delete e.reviewer,console.warn("⚠️ [社交圈] 修正reviews字段名: reviewer -> reviewerName")),n.comment&&!n.content&&(e.content=n.comment,delete e.comment,console.warn("⚠️ [社交圈] 修正reviews字段名: comment -> content")),e.likes||(e.likes=Math.floor(100*Math.random())),e.comments||(e.comments=Math.floor(20*Math.random())),!e.timestamp){const n=Math.floor(30*Math.random())+1,t=new Date;t.setDate(t.getDate()-n),e.timestamp=t.toISOString()}if(void 0===e.isAnonymous&&(e.isAnonymous=Math.random()<.3),!e.reviewerAvatar){const n=["male","female","unisex"][Math.floor(3*Math.random())];e.reviewerAvatar=this.getRandomAvatar(n)}return e})),o.socialCircle||(o.socialCircle=[]);const i=o.socialCircle.find(n=>n.handle===e.handle),r=o.socialCircle.find(n=>n.nickname===e.nickname);if(i||r)console.error("❌ [社交圈] AI生成了重复好友，已丢弃："),console.error(`  |- 生成的好友: ${e.nickname} (@${e.handle})`),i&&console.error(`  |- handle重复: @${e.handle} 已存在于好友 ${i.nickname}`),r&&console.error(`  |- nickname重复: ${e.nickname} 已存在于好友 @${r.handle}`),console.error("  |- 请检查AI提示词是否正确传递了现有好友列表");else if(o.socialCircle.length>=5)console.error(`❌ [社交圈] 社交圈已满（${o.socialCircle.length}/5），无法添加新好友`);else{o.socialCircle.push(e);try{const i=`mapDatingData_${n.currentAccountId||"main"}`,r=await S.xMapDatingData.get(i);if(r&&r.data&&r.data.nearbyUsers){const n=r.data.nearbyUsers.findIndex(n=>n.id===a);if(-1!==n){r.data.nearbyUsers[n].socialCircle||(r.data.nearbyUsers[n].socialCircle=[]),r.data.nearbyUsers[n].socialCircle.push(e),console.log(`🔄 [社交圈反向同步] 开始将 ${o.nickname} 添加到 ${e.nickname} 的社交圈`);let i=r.data.nearbyUsers.findIndex(n=>n.handle===e.handle);if(-1===i){console.log("  |- 好友B不在地图上，先添加到nearbyUsers");const t=r.data.nearbyUsers[n].position;if(t&&"number"==typeof t.lat&&"number"==typeof t.lng){const n=Math.random()*Math.PI*2,o=5*Math.random()+2;e.position={lat:t.lat+o/111*Math.cos(n),lng:t.lng+o/111*Math.sin(n)/Math.cos(t.lat*Math.PI/180)},e.distance=o}else console.warn(`⚠️ [社交圈反向同步] A（${o.nickname}）的位置信息缺失，使用默认位置`),e.position={lat:39.9042+.1*(Math.random()-.5),lng:116.4074+.1*(Math.random()-.5)};e.socialCircle||(e.socialCircle=[]),r.data.nearbyUsers.push(e),i=r.data.nearbyUsers.length-1,console.log(`  |- 已添加好友B到地图，位置: [${e.position.lat.toFixed(6)}, ${e.position.lng.toFixed(6)}]，距离: ${e.distance.toFixed(1)}km`)}else console.log(`  |- 好友B已在地图上，索引: ${i}`),r.data.nearbyUsers[i].socialCircle||(r.data.nearbyUsers[i].socialCircle=[]);const s=r.data.nearbyUsers[i].socialCircle||[];if(s.length<5){if(s.find(n=>n.id===a))console.log(`  |- ⚠️ ${o.nickname} 已在 ${e.nickname} 的社交圈中，跳过添加`);else{const n={id:o.id,nickname:o.nickname,handle:o.handle,avatar:o.avatar,avatarBubble:o.avatarBubble,gender:o.gender,distance:e.distance,online:o.online,status:o.status,bio:o.bio,publicPersonality:o.publicPersonality,realPersonality:o.realPersonality,appearance:o.appearance,tags:o.tags,followers:o.followers,likes:o.likes,avgRating:o.avgRating,reviews:o.reviews||[],position:o.position,relationship:t,secret:o.secret};r.data.nearbyUsers[i].socialCircle.push(n),console.log(`  |- ✅ 已将 ${o.nickname} 添加到 ${e.nickname} 的社交圈`),console.log(`  |- 关系类型: ${t}`),console.log(`  |- ${e.nickname} 的社交圈人数: ${r.data.nearbyUsers[i].socialCircle.length}/5`)}}else console.log(`  |- ⚠️ ${e.nickname} 的社交圈已满（5/5），无法添加 ${o.nickname}`);await S.xMapDatingData.put(r),this.allUsers=r.data.nearbyUsers,this.currentUsers=[...r.data.nearbyUsers],console.log("🔄 [社交圈] 已同步更新allUsers和currentUsers，确保好友B可被查看"),console.log("🗺️ [社交圈] 已保存到数据库，地图将在下次刷新时显示好友B"),console.log("✅ [社交圈] 已保存社交圈好友到数据库（包含反向同步）")}}}catch(n){console.error("❌ [社交圈] 保存社交圈好友失败:",n)}console.log(`  |- 好友昵称: ${e.nickname} (@${e.handle})`),console.log(`  |- 关系类型: ${t}`),console.log(`  |- 当前社交圈人数: ${o.socialCircle.length}/5`)}}if(ln.newReview&&ln.newReview.generated){console.log("📝 [新评价] AI生成了一条新评价");const{review:e}=ln.newReview;if(e.reviewer&&!e.reviewerName&&(e.reviewerName=e.reviewer,delete e.reviewer,console.warn("⚠️ [新评价] 修正字段名: reviewer -> reviewerName")),e.comment&&!e.content&&(e.content=e.comment,delete e.comment,console.warn("⚠️ [新评价] 修正字段名: comment -> content")),e.likes||(e.likes=Math.floor(100*Math.random())),e.comments||(e.comments=Math.floor(20*Math.random())),e.timestamp||(e.timestamp=(new Date).toISOString()),void 0===e.isAnonymous&&(e.isAnonymous=Math.random()<.3),!e.reviewerAvatar){const n=["male","female","unisex"][Math.floor(3*Math.random())];e.reviewerAvatar=this.getRandomAvatar(n)}e.isNewReview=!0,o.reviews||(o.reviews=[]),o.reviews.push(e);const t=o.reviews.reduce((n,e)=>n+(e.rating||0),0);o.avgRating=(t/o.reviews.length).toFixed(1);try{const t=`mapDatingData_${n.currentAccountId||"main"}`,i=await S.xMapDatingData.get(t);if(i&&i.data&&i.data.nearbyUsers){const n=i.data.nearbyUsers.findIndex(n=>n.id===a);-1!==n&&(i.data.nearbyUsers[n].reviews||(i.data.nearbyUsers[n].reviews=[]),i.data.nearbyUsers[n].reviews.push(e),i.data.nearbyUsers[n].avgRating=o.avgRating,await S.xMapDatingData.put(i),this.allUsers=i.data.nearbyUsers,this.currentUsers=[...i.data.nearbyUsers],console.log("🔄 [新评价] 已同步更新allUsers和currentUsers"),console.log("✅ [新评价] 已保存新评价到数据库"))}}catch(n){console.error("❌ [新评价] 保存新评价失败:",n)}console.log(`  |- 评价者: ${e.reviewerName}`),console.log(`  |- 评分: ${e.rating}`),console.log(`  |- 内容: ${e.content.substring(0,30)}...`),console.log(`  |- 当前评价总数: ${o.reviews.length}条 (新评价: ${v+1}/7)`),console.log(`  |- 更新后平均评分: ${o.avgRating}`)}if(ln.newMoment&&ln.newMoment.generated){console.log("📸 [新动态] AI生成了一条新动态");const{moment:e}=ln.newMoment;e.likes=Math.floor(2e3*Math.random())+Math.floor(500*Math.random()),e.comments=Math.floor(100*Math.random())+Math.floor(20*Math.random()),e.shares=Math.floor(50*Math.random())+Math.floor(10*Math.random()),e.userName=o.nickname,e.userAvatar=o.avatar,e.id=Date.now(),e.isGenerated=!0,console.log("🎨 [新动态生成] 动态发布者信息:",{nickname:o.nickname,avatar:o.avatar,momentUserName:e.userName,momentUserAvatar:e.userAvatar}),e.commentsList&&Array.isArray(e.commentsList)&&e.commentsList.forEach(n=>{const e=["male","female","unisex"][Math.floor(3*Math.random())];n.avatar=this.getRandomAvatar(e),!n.user&&n.commenterName&&(n.user=n.commenterName),!n.text&&n.commentText&&(n.text=n.commentText)}),o.moments||(o.moments=[]),o.moments.push(e),w>0&&o.momentsGenerationHistory[w]++;try{const t=`mapDatingData_${n.currentAccountId||"main"}`,o=await S.xMapDatingData.get(t);if(o&&o.data&&o.data.nearbyUsers){const n=o.data.nearbyUsers.findIndex(n=>n.id===a);-1!==n&&(o.data.nearbyUsers[n].moments||(o.data.nearbyUsers[n].moments=[]),o.data.nearbyUsers[n].moments.push(e),o.data.nearbyUsers[n].momentsGenerationHistory||(o.data.nearbyUsers[n].momentsGenerationHistory={20:0,40:0,60:0,80:0,100:0}),w>0&&o.data.nearbyUsers[n].momentsGenerationHistory[w]++,await S.xMapDatingData.put(o),this.allUsers=o.data.nearbyUsers,this.currentUsers=[...o.data.nearbyUsers],console.log("🔄 [新动态] 已同步更新allUsers和currentUsers"),console.log("✅ [新动态] 已保存新动态到数据库"))}}catch(n){console.error("❌ [新动态] 保存新动态失败:",n)}const t=o.moments.filter(n=>n.isGenerated).length;console.log(`  |- 动态用户: ${e.userName}`),console.log(`  |- 动态内容: ${e.text.substring(0,30)}...`),console.log(`  |- 配图描述: ${e.imageDescription||"无"}`),console.log(`  |- 心情标签: ${e.mood||"无"}`),console.log(`  |- 点赞: ${e.likes}, 评论: ${e.comments}, 转发: ${e.shares}`),console.log(`  |- 发布时间: ${e.time}`),console.log(`  |- 当前动态总数: ${o.moments.length}条 (AI生成: ${t}/10)`),console.log(`  |- 分段${w}触发计数: ${o.momentsGenerationHistory[w]}/2`),this.addSystemMessage(`📸 ${o.nickname} posted a new moment. Check their profile to view it!`)}return console.log(`✅ [第十六个情景] AI生成对话完成，共${ln.messages.length}条消息`),console.log(`  |- 对话对象: ${o.nickname} (@${o.handle})`),console.log(`  |- 消息类型分布: ${ln.messages.map(n=>n.type).join(", ")}`),console.log(`  |- 💖 AI决策的好感度变化: ${ln.affectionChange>0?"+":""}${ln.affectionChange}`),console.log(`  |- 📝 AI记录的笔记数量: ${ln.notes.length}条`),console.log(`  |- 💭 AI记录的用户笔记数量: ${ln.userNotes.length}条`),r&&console.log(`  |- 🚨 处理举报数量: ${ln.reports?.length||0}个`),ln}catch(n){return console.error("❌ [第十六个情景] 附近私信对话生成失败:",n),null}},async saveChatToDatabase(n=null){try{let t,o,a;if(n){const e=this.allUsers.find(e=>e.id===n)||this.currentUsers.find(e=>e.id===n);if(!e)return void console.warn(`⚠️ [聊天记录保存] 未找到用户 ${n}，跳过保存`);t=e.id,o=e.nickname,a=e.handle,console.log(`💾 [聊天记录保存] 使用传入的userId保存: ${o} (${t})`)}else{if(!this.currentChatUser)return void console.warn("⚠️ [聊天记录保存] 没有当前聊天对象且未传入userId，跳过保存");t=this.currentChatUser.id,o=this.currentChatUser.nickname,a=this.currentChatUser.handle}const i=e();if(!i)return void console.error("❌ [聊天记录保存] 无法获取数据库");const r=`mapChat_${t}_${vt||"main"}`,s={id:r,accountId:vt||"main",userId:t,userName:o,userHandle:a,messages:this.chatMessages[t]||[],affectionData:this.chatAffectionData[t]||null,notes:this.chatNotes[t]||{},userMarkedNotes:this.userMarkedNotes[t]||[],npcNotesAboutUser:this.npcNotesAboutUser[t]||[],lastUpdated:(new Date).toISOString()};if(await i.xMapChats.put(s),console.log(`✅ [聊天记录保存] 已保存与 ${o} 的聊天记录`),console.log(`  |- 聊天ID: ${r}`),console.log(`  |- 消息数量: ${s.messages.length}`),this.chatAffectionData[t]){const n=this.chatAffectionData[t];console.log(`  |- 好感度: ${n.affection.toFixed(1)}/100 (阈值: ${n.threshold}, 增长率: ${n.growthRate.toFixed(2)}x)`)}if(this.chatNotes[t]){const n=this.chatNotes[t],e=Object.keys(n).length;e>0&&console.log(`  |- 📝 AI笔记数量: ${e}条 (${Object.keys(n).join("、")})`)}if(this.userMarkedNotes[t]){const n=this.userMarkedNotes[t];n.length>0&&console.log(`  |- 📌 用户标记笔记数量: ${n.length}条`)}if(this.npcNotesAboutUser[t]){const n=this.npcNotesAboutUser[t];n.length>0&&console.log(`  |- 💭 NPC观察笔记数量: ${n.length}条`)}}catch(n){console.error("❌ [聊天记录保存] 保存失败:",n)}},generateMockMessages(n){const e=new Date;return[{type:"received",text:"Heya himanshi",timestamp:new Date(e-18e6).toISOString()},{type:"received",text:"Couldn't stop myself from texting coz you're just so pretty",timestamp:new Date(e-18e6+1e4).toISOString()},{type:"sent",text:"Thankyouu so much!!",timestamp:new Date(e-72e5).toISOString()},{type:"received",text:"You're wlcm bbg",timestamp:new Date(e-288e4).toISOString()},{type:"received",text:"Idk why I ain't getting notifications",timestamp:new Date(e-288e4+1e4).toISOString()},{type:"received",text:"How old are uh?",timestamp:new Date(e-288e4+2e4).toISOString()},{type:"received",text:"Should I guess?",timestamp:new Date(e-18e5).toISOString()},{type:"sent",text:"U should guess",timestamp:new Date(e-3e5).toISOString()},{type:"sent",text:"I think",timestamp:new Date(e-3e5+5e3).toISOString()}]},formatChatTime(n){const e=new Date-n;if(e<864e5){const e=n.getHours(),t=e>=12?"pm":"am";return`Today, ${e%12||12}:${n.getMinutes().toString().padStart(2,"0")} ${t}`}if(e<1728e5){const e=n.getHours(),t=e>=12?"pm":"am";return`Yesterday, ${e%12||12}:${n.getMinutes().toString().padStart(2,"0")} ${t}`}const t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][n.getMonth()],o=n.getDate(),a=n.getHours(),i=a>=12?"pm":"am";return`${t} ${o}, ${a%12||12}:${n.getMinutes().toString().padStart(2,"0")} ${i}`},async refreshNearbyUsers(){try{const n=document.getElementById("mapRefreshBtn");if(!n)return;if(n.classList.contains("refreshing"))return void console.log("⚠️ 正在刷新中，请勿重复点击");n.classList.add("refreshing"),console.log("🔄 [刷新开始] 开始刷新附近的人..."),console.log("🤖 [AI调用] 正在调用AI生成新用户数据，请耐心等待...");const e=await this.generateMapDatingData(!0);if(console.log("🤖 [AI返回] AI调用完成，返回数据:",e?"成功":"失败"),e&&e.nearbyUsers){console.log(`📊 [数据处理] 开始处理 ${e.nearbyUsers.length} 个用户数据...`),this.allUsers=e.nearbyUsers,this.currentUsers=[...this.allUsers],console.log("✅ [数据更新] 用户列表已更新"),this.closeDetailCard();try{console.log("🎨 [UI渲染] 开始渲染用户列表..."),this.renderUserList(),console.log("✅ [UI渲染] 用户列表渲染完成")}catch(n){console.error("❌ [UI渲染] 渲染用户列表失败:",n)}try{console.log("🗺️ [地图渲染] 开始渲染地图标记..."),this.renderMapMarkers(),console.log("✅ [地图渲染] 地图标记渲染完成")}catch(n){console.error("❌ [地图渲染] 渲染地图标记失败:",n)}try{console.log("🔔 [提醒徽章] 开始更新提醒徽章..."),await this.updateNotificationBadge(),console.log("✅ [提醒徽章] 提醒徽章更新完成")}catch(n){console.error("❌ [提醒徽章] 更新提醒徽章失败:",n)}console.log(`✅✅✅ [刷新完成] 已成功更新 ${e.nearbyUsers.length} 个附近的人`),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")}else console.error("❌ [刷新失败] 未获取到新的用户数据，newData:",e),alert("刷新失败，请重试")}catch(n){console.error("❌❌❌ [致命错误] 刷新附近的人失败:",n),console.error("错误堆栈:",n.stack),alert("刷新失败，请重试")}finally{console.log("🔧 [清理] 移除刷新动画...");const n=document.getElementById("mapRefreshBtn");n&&(n.classList.remove("refreshing"),console.log("✅ [清理] 刷新动画已移除"))}},openMapSettings(){if(!this.isShowingUserProfile)return;if(!this.userMapProfile)return void console.warn("⚠️ 用户资料未初始化");const n=document.getElementById("mapSettingsModal");n&&(this.loadMapSettingsToForm(),n.style.display="flex")},closeMapSettings(){const n=document.getElementById("mapSettingsModal");n&&(n.style.display="none")},loadMapSettingsToForm(){const n=this.userMapProfile,e=document.getElementById("mapSettingsNickname"),t=document.getElementById("mapSettingsHandle"),o=document.getElementById("mapSettingsFollowers"),a=document.getElementById("mapSettingsLikes");e&&(e.value=n.nickname||""),t&&(t.value=n.handle||""),o&&(o.value=n.followers||1e3),a&&(a.value=n.likes||15e3);const i=document.getElementById("mapSettingsAvatarBubbleEnabled"),r=document.getElementById("mapSettingsAvatarBubbleText"),s=document.getElementById("mapSettingsAvatarBubbleTextSection");if(i&&r){const e=n.avatarBubble&&""!==n.avatarBubble.trim();i.checked=e,r.value=n.avatarBubble||"",s&&(s.style.display=e?"flex":"none"),i.onchange=()=>{s&&(s.style.display=i.checked?"flex":"none")}}const l=document.getElementById("mapSettingsStatusEnabled"),c=document.getElementById("mapSettingsStatusText"),d=document.getElementById("mapSettingsStatusTextSection");if(l&&c){const e=n.status&&""!==n.status.trim();l.checked=e,c.value=n.status||"",d&&(d.style.display=e?"flex":"none"),l.onchange=()=>{d&&(d.style.display=l.checked?"flex":"none")}}this.renderSettingsTags()},renderSettingsTags(){const n=document.getElementById("mapSettingsTagsContainer");if(!n||!this.userMapProfile)return;const e=this.userMapProfile.tags||[];n.innerHTML=e.map((n,e)=>`\n        <div class="map-settings-tag" data-tag-index="${e}">\n          ${n}\n          <div class="map-settings-tag-remove" onclick="MapDatingController.removeTag(${e})">\n            <svg viewBox="0 0 24 24">\n              <line x1="18" y1="6" x2="6" y2="18"></line>\n              <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n          </div>\n        </div>\n      `).join("")},addNewTag(){if(!this.userMapProfile)return;const n=prompt("请输入新标签内容:");n&&""!==n.trim()&&(this.userMapProfile.tags.length>=6?alert("标签数量已达上限（最多6个）"):this.userMapProfile.tags.includes(n.trim())?alert("该标签已存在"):(this.userMapProfile.tags.push(n.trim()),this.renderSettingsTags()))},removeTag(n){this.userMapProfile&&confirm("确定要删除这个标签吗？")&&(this.userMapProfile.tags.splice(n,1),this.renderSettingsTags())},async saveMapSettings(){if(!this.userMapProfile)return;const n=document.getElementById("mapSettingsNickname"),e=document.getElementById("mapSettingsHandle"),t=document.getElementById("mapSettingsFollowers"),o=document.getElementById("mapSettingsLikes");if(n){const e=n.value.trim();if(!e)return void alert("昵称不能为空！");this.userMapProfile.nickname=e}if(e){const n=e.value.trim();if(n&&/^[a-z0-9_]{1,15}$/.test(n))this.userMapProfile.handle=n;else if(n)return void alert("句柄格式不正确！必须是纯英文小写+数字+下划线，1-15个字符")}if(t){const n=parseInt(t.value);if(!(n>=100&&n<=5e4))return void alert("粉丝数必须在100-50000之间！");this.userMapProfile.followers=n}if(o){const n=parseInt(o.value);if(!(n>=1e3&&n<=25e5))return void alert("获赞数必须在1000-2500000之间！");this.userMapProfile.likes=n}const a=document.getElementById("mapSettingsAvatarBubbleEnabled"),i=document.getElementById("mapSettingsAvatarBubbleText"),r=document.getElementById("mapSettingsStatusEnabled"),s=document.getElementById("mapSettingsStatusText");if(a&&i&&(this.userMapProfile.avatarBubble=a.checked?i.value.trim():""),r&&s&&(this.userMapProfile.status=r.checked?s.value.trim():""),await this.saveUserMapProfile(),this.renderCurrentUserMarker(),"none"!==document.getElementById("mapUserDetailCard").style.display){const n=this.userMapProfile,e=document.getElementById("mapCardNickname"),t=document.getElementById("mapCardHandle"),o=document.getElementById("mapCardFollowersCount"),a=document.getElementById("mapCardLikesCount");e&&(e.textContent=n.nickname||"未命名用户"),t&&(t.textContent=`@${n.handle||"unknown"}`),o&&(o.textContent=this.formatNumber(n.followers||0)),a&&(a.textContent=this.formatNumber(n.likes||0));const i=document.getElementById("mapCardAvatarBubble");i&&(i.textContent=n.avatarBubble||"",i.style.display=n.avatarBubble?"flex":"none"),this.refreshTagsDisplay()}this.closeMapSettings(),console.log("✅ [地图设置] 设置已保存")},closeMapPage(){Ts()}};function Ms(){if(void 0!==n.xSocialAuth&&!n.xSocialAuth.hasAccess())return console.log("🔒 访问地图约会功能需要社交功能权限"),void n.xSocialAuth.requestAccess();!function(){if(document.getElementById("x-map-styles"))return;const n=document.createElement("style");n.id="x-map-styles",n.textContent='\n     /* ==================== 地图约会主题变量 ==================== */\n      :root {\n        /* 暗色主题（默认） */\n        --map-bg-primary: #2a2a2a;\n        --map-bg-secondary: #1a1a1a;\n        --map-road-main: #3a3a3a;\n        --map-road-secondary: #404040;\n        --map-building: #353535;\n        --map-building-alt: #2f2f2f;\n        --map-park: rgba(100,150,100,0.2);\n        --map-park-alt: rgba(100,150,100,0.15);\n        --map-line: rgba(255,255,255,0.1);\n        --map-shadow: rgba(0,0,0,0.3);\n        /* 侧边栏主题 */\n        --sidebar-bg: #1a1a1a;\n        --sidebar-border: #2f3336;\n        --sidebar-input-bg: #202327;\n        --sidebar-text-primary: #fff;\n        --sidebar-text-secondary: #71767b;\n        --sidebar-hover: rgba(255,255,255,0.03);\n      }\n      /* 亮色主题支持 */\n      #x-map-container.light-theme {\n        --map-bg-primary: #e8e8e8;\n        --map-bg-secondary: #f5f5f5;\n        --map-road-main: #d0d0d0;\n        --map-road-secondary: #e0e0e0;\n        --map-building: #fff;\n        --map-building-alt: #fafafa;\n        --map-park: rgba(180,220,180,0.3);\n        --map-park-alt: rgba(180,220,180,0.2);\n        --map-line: rgba(255,255,255,0.4);\n        --map-shadow: rgba(0,0,0,0.05);\n        --sidebar-bg: #fff;\n        --sidebar-border: #e0e0e0;\n        --sidebar-input-bg: #f5f5f5;\n        --sidebar-text-primary: #000;\n        --sidebar-text-secondary: #666;\n        --sidebar-hover: rgba(0,0,0,0.05);\n      }\n        \n      /* ==================== 🚨 关键修复：主容器高度设置 ==================== */\n      #map-dating-container {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        position: relative;\n        overflow: hidden;\n      }\n        \n      /* ==================== 左侧边栏 ==================== */\n      .map-sidebar {\n        width: 85%;\n        max-width: 360px;\n        background: var(--sidebar-bg);\n        display: flex;\n        flex-direction: column;\n        border-right: 1px solid var(--sidebar-border);\n        position: fixed;\n        top: 0;\n        left: 0;\n        height: 100%;\n        z-index: 100;\n        transform: translateX(-100%);\n        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: 2px 0 8px rgba(0,0,0,0.3);\n      }\n\n      .map-sidebar.show {\n        transform: translateX(0);\n      }\n\n      .map-header {\n        padding: 16px 20px;\n        border-bottom: 1px solid var(--sidebar-border);\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n\n      .map-header h2 {\n        font-size: 20px;\n        font-weight: 700;\n        color: var(--sidebar-text-primary);\n        flex: 1;\n      }\n\n      .map-back-btn {\n        background: none;\n        border: none;\n        padding: 8px;\n        cursor: pointer;\n        border-radius: 50%;\n        transition: background-color 0.2s;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .map-back-btn:hover {\n        background-color: rgba(239,243,244,0.1);\n      }\n\n      .map-back-btn svg {\n        width: 20px;\n        height: 20px;\n        fill: var(--sidebar-text-primary);\n      }\n\n      .map-search-box {\n        padding: 12px 16px;\n        background: var(--sidebar-bg);\n      }\n\n      .map-search-box input {\n        width: 100%;\n        background: var(--sidebar-input-bg);\n        border: none;\n        border-radius: 20px;\n        padding: 10px 16px;\n        color: var(--sidebar-text-primary);\n        font-size: 15px;\n        outline: none;\n      }\n\n      .map-search-box input::placeholder {\n        color: var(--sidebar-text-secondary);\n      }\n\n      .map-filters {\n        padding: 12px 16px;\n        display: flex;\n        gap: 8px;\n        border-bottom: 1px solid var(--sidebar-border);\n      }\n\n      .filter-group {\n        display: flex;\n        gap: 8px;\n        flex: 1;\n      }\n\n      .filter-select {\n        flex: 1;\n        background: var(--sidebar-input-bg);\n        border: none;\n        border-radius: 6px;\n        padding: 8px 12px;\n        color: var(--sidebar-text-primary);\n        font-size: 13px;\n        cursor: pointer;\n        outline: none;\n      }\n\n      .filter-btn {\n        background: #1d9bf0;\n        border: none;\n        border-radius: 6px;\n        padding: 8px 16px;\n        color: #fff;\n        font-size: 13px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: background-color 0.2s;\n      }\n\n      .filter-btn:hover {\n        background: #1a8cd8;\n      }\n\n      .map-user-list {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 8px 0;\n        min-height: 0;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      .map-user-list::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-user-list::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-user-list::-webkit-scrollbar-thumb {\n        background: #3a3a3a;\n        border-radius: 3px;\n      }\n\n      .map-user-item {\n        padding: 12px 16px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        cursor: pointer;\n        transition: background-color 0.2s;\n        position: relative;\n      }\n\n      .map-user-item:hover {\n        background: var(--sidebar-hover);\n      }\n\n      .map-user-item.active {\n        background: rgba(29,155,240,0.1);\n        border-left: 3px solid #1d9bf0;\n      }\n\n      .map-user-avatar-container {\n        position: relative;\n        flex-shrink: 0;\n      }\n\n      .map-user-avatar {\n        width: 48px;\n        height: 48px;\n        border-radius: 50%;\n        object-fit: cover;\n      }\n\n      .map-online-indicator {\n        position: absolute;\n        bottom: 0;\n        right: 0;\n        width: 14px;\n        height: 14px;\n        background: #00ba7c;\n        border: 2px solid var(--sidebar-bg);\n        border-radius: 50%;\n      }\n\n      .map-user-info {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .map-user-name {\n        font-size: 15px;\n        font-weight: 600;\n        color: var(--sidebar-text-primary);\n        margin-bottom: 2px;\n      }\n\n      .map-user-meta {\n        font-size: 13px;\n        color: var(--sidebar-text-secondary);\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n\n      .map-distance {\n        display: flex;\n        align-items: center;\n        gap: 3px;\n      }\n\n      .map-distance svg {\n        width: 12px;\n        height: 12px;\n        fill: var(--sidebar-text-secondary);\n      }\n\n      .map-view-icon {\n        width: 20px;\n        height: 20px;\n        fill: var(--sidebar-text-secondary);\n        transition: fill 0.2s;\n      }\n\n      .map-user-item:hover .map-view-icon {\n        fill: #1d9bf0;\n      }\n\n      /* 侧边栏遮罩 */\n      .map-sidebar-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.5);\n        z-index: 99;\n        opacity: 0;\n        visibility: hidden;\n        transition: opacity 0.3s, visibility 0.3s;\n      }\n\n      .map-sidebar-overlay.show {\n        opacity: 1;\n        visibility: visible;\n      }\n\n      /* ==================== 右侧地图区域 ==================== */\n      .map-area {\n        width: 100%;\n        height: 100%;\n        position: relative;\n        background: var(--map-bg-primary);\n        overflow: hidden;\n      }\n\n      /* 羊图标按钮（咩三三报纸）- 在提醒按钮下方、设置按钮上方 */\n      .map-newspaper-btn {\n        position: absolute;\n        top: 228px; /* 186 + 32 + 10 = 提醒按钮top + 提醒按钮高度 + 间距 */\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.15s ease, transform 0.2s ease;\n        padding: 0;\n      }\n\n      .map-newspaper-btn:hover {\n        opacity: 0.7;\n      }\n\n      .map-newspaper-btn:active {\n        transform: scale(0.95);\n      }\n\n      .map-newspaper-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));\n      }\n\n      /* 关闭按钮 - ins风格简洁设计 */\n      .map-close-btn {\n        position: absolute;\n        top: 60px;\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.2s;\n        padding: 0;\n      }\n\n      .map-close-btn:hover {\n        opacity: 0.6;\n      }\n\n      .map-close-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n      }\n\n      /* 刷新按钮 - 在关闭按钮下方 */\n      .map-refresh-btn {\n        position: absolute;\n        top: 102px; /* 60 + 32 + 10 = 关闭按钮top + 关闭按钮高度 + 间距 */\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.2s;\n        padding: 0;\n      }\n\n      .map-refresh-btn:hover {\n        opacity: 0.6;\n      }\n\n      .map-refresh-btn.refreshing {\n        pointer-events: none;\n        opacity: 0.5;\n      }\n\n      .map-refresh-btn.refreshing svg {\n        animation: map-refresh-rotate 1s linear infinite;\n      }\n\n      @keyframes map-refresh-rotate {\n        from {\n          transform: rotate(0deg);\n        }\n        to {\n          transform: rotate(360deg);\n        }\n      }\n\n      .map-refresh-btn svg {\n        width: 24px;\n        height: 24px;\n        fill: #fff;\n        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n      }\n\n      /* 聊天列表按钮样式 */\n      .map-chats-btn {\n        position: absolute;\n        top: 144px; /* 102 + 32 + 10 = 刷新按钮top + 刷新按钮高度 + 间距 */\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.2s;\n        padding: 0;\n      }\n\n      .map-chats-btn:hover {\n        opacity: 0.6;\n      }\n\n      .map-chats-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n      }\n\n      /* ==================== 提醒功能 - 黑白灰简约ins风格 ==================== */\n      /* 提醒按钮 - 简约设计 */\n      .map-notifications-btn {\n        position: absolute;\n        top: 186px;\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.15s ease;\n        padding: 0;\n      }\n\n      .map-notifications-btn:hover {\n        opacity: 0.7;\n      }\n\n      .map-notifications-btn:active {\n        transform: scale(0.95);\n      }\n\n      .map-notifications-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));\n      }\n\n      /* 未读徽章 - 黑色圆点 */\n      .map-notifications-badge {\n        position: absolute;\n        top: -2px;\n        right: -2px;\n        min-width: 18px;\n        height: 18px;\n        background: #000;\n        border-radius: 9px;\n        border: 2px solid rgba(42, 42, 42, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 11px;\n        font-weight: 700;\n        color: #fff;\n        padding: 0 4px;\n        box-sizing: border-box;\n      }\n\n      .map-notifications-badge.hidden {\n        display: none;\n      }\n\n      /* ==================== 城市乘车按钮 - 简约设计 ==================== */\n      .map-ride-btn {\n        position: absolute;\n        top: 270px; /* 228 + 32 + 10 = 报纸按钮top + 报纸按钮高度 + 间距 */\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.15s ease, transform 0.2s ease;\n        padding: 0;\n      }\n\n      .map-ride-btn:hover {\n        opacity: 0.7;\n      }\n\n      .map-ride-btn:active {\n        transform: scale(0.95);\n      }\n\n      .map-ride-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));\n      }\n\n      /* ==================== 应用设置按钮 - 简约设计 ==================== */\n      .map-app-settings-btn {\n        position: absolute;\n        top: 312px; /* 270 + 32 + 10 = 乘车按钮top + 乘车按钮高度 + 间距 */\n        left: 20px;\n        z-index: 10;\n        width: 32px;\n        height: 32px;\n        background: none;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: opacity 0.15s ease, transform 0.2s ease;\n        padding: 0;\n      }\n\n      .map-app-settings-btn:hover {\n        opacity: 0.7;\n      }\n\n      .map-app-settings-btn:active {\n        transform: scale(0.95);\n      }\n\n      .map-app-settings-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        filter: drop-shadow(0 1px 3px rgba(0,0,0,0.4));\n      }\n\n      /* 提醒列表弹窗 - Instagram风格 */\n      .map-notifications-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.65);\n        z-index: 299;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-notifications-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-notifications-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 300;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-notifications-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 提醒内容容器 - 全新设计 */\n      .map-notifications-content {\n        width: calc(100% - 40px);\n        max-width: 480px;\n        max-height: calc(100vh - 80px);\n        background: #000;\n        border-radius: 24px;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);\n        animation: modalSlideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      @keyframes modalSlideUp {\n        from {\n          opacity: 0;\n          transform: translateY(30px) scale(0.9);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n      }\n\n      /* 弹窗头部 - 极简设计 */\n      .map-notifications-header {\n        padding: 24px 20px 16px;\n        background: #000;\n        border-bottom: none;\n        display: flex;\n        align-items: flex-start;\n        justify-content: space-between;\n        flex-shrink: 0;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      .map-notifications-header-top {\n        width: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .map-notifications-title {\n        font-size: 28px;\n        font-weight: 700;\n        color: #fff;\n        letter-spacing: -0.5px;\n      }\n\n      .map-notifications-close-btn {\n        width: 36px;\n        height: 36px;\n        background: #1a1a1a;\n        border: none;\n        border-radius: 18px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s ease;\n        padding: 0;\n      }\n\n      .map-notifications-close-btn:hover {\n        background: #2a2a2a;\n        transform: scale(1.05);\n      }\n\n      .map-notifications-close-btn:active {\n        background: #1a1a1a;\n        transform: scale(0.95);\n      }\n\n      .map-notifications-close-btn svg {\n        width: 20px;\n        height: 20px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        stroke-linecap: round;\n      }\n\n      /* 统计卡片 */\n      .map-notifications-stats {\n        width: 100%;\n        background: #1a1a1a;\n        border-radius: 14px;\n        padding: 14px 18px;\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        box-sizing: border-box;\n      }\n\n      .map-notifications-stats-icon {\n        width: 48px;\n        height: 48px;\n        background: #fff;\n        border-radius: 24px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n      }\n\n      .map-notifications-stats-icon svg {\n        width: 24px;\n        height: 24px;\n        stroke: #000;\n        fill: none;\n        stroke-width: 2;\n      }\n\n      .map-notifications-stats-info {\n        flex: 1;\n      }\n\n      .map-notifications-stats-label {\n        font-size: 13px;\n        color: #8e8e8e;\n        font-weight: 500;\n        margin-bottom: 4px;\n      }\n\n      .map-notifications-stats-count {\n        font-size: 24px;\n        font-weight: 700;\n        color: #fff;\n        letter-spacing: -0.5px;\n      }\n\n      /* 分类Tab */\n      .map-notifications-tabs {\n        width: 100%;\n        display: flex;\n        gap: 8px;\n        overflow-x: auto;\n        scrollbar-width: none;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      .map-notifications-tabs::-webkit-scrollbar {\n        display: none;\n      }\n\n      .map-notifications-tab {\n        padding: 8px 16px;\n        background: transparent;\n        border: 1.5px solid #2a2a2a;\n        border-radius: 20px;\n        color: #8e8e8e;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        white-space: nowrap;\n        flex-shrink: 0;\n        box-sizing: border-box;\n      }\n\n      .map-notifications-tab:hover {\n        border-color: #3a3a3a;\n        color: #b0b0b0;\n      }\n\n      .map-notifications-tab.active {\n        background: #fff;\n        border-color: #fff;\n        color: #000;\n      }\n\n      /* 提醒列表容器 - Toast风格 */\n      .map-notifications-list-container {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        min-height: 0;\n        background: #000;\n        padding: 8px 16px 16px;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      .map-notifications-list-container::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-notifications-list-container::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-notifications-list-container::-webkit-scrollbar-thumb {\n        background: #2a2a2a;\n        border-radius: 3px;\n      }\n\n      .map-notifications-list-container::-webkit-scrollbar-thumb:hover {\n        background: #3a3a3a;\n      }\n\n      /* 提醒卡片 - Toast简约风格 */\n      .map-notification-item {\n        margin-bottom: 8px;\n        padding: 14px 16px;\n        background: #0a0a0a;\n        border: 1px solid #1a1a1a;\n        border-radius: 12px;\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        box-sizing: border-box;\n      }\n\n      .map-notification-item:hover {\n        background: #141414;\n        border-color: #2a2a2a;\n      }\n\n      .map-notification-item:active {\n        background: #0a0a0a;\n        transform: scale(0.98);\n      }\n\n      /* 未读标识 - 左侧色条 */\n      .map-notification-item.unread {\n        border-left: 3px solid #fff;\n        padding-left: 13px;\n      }\n\n      /* 通知图标 */\n      .map-notification-icon {\n        width: 40px;\n        height: 40px;\n        background: #1a1a1a;\n        border-radius: 10px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n      }\n\n      .map-notification-icon svg {\n        width: 20px;\n        height: 20px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n        stroke-linecap: round;\n        stroke-linejoin: round;\n      }\n\n      /* 提醒信息区域 */\n      .map-notification-info {\n        flex: 1;\n        min-width: 0;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n      }\n\n      /* 顶部：标题 + 时间 */\n      .map-notification-header {\n        display: flex;\n        align-items: baseline;\n        justify-content: space-between;\n        gap: 12px;\n      }\n\n      .map-notification-title {\n        font-size: 15px;\n        font-weight: 600;\n        color: #fff;\n        letter-spacing: -0.2px;\n      }\n\n      .map-notification-time {\n        font-size: 12px;\n        color: #666;\n        font-weight: 500;\n        white-space: nowrap;\n        flex-shrink: 0;\n      }\n\n      /* 内容文本 */\n      .map-notification-content {\n        font-size: 14px;\n        color: #999;\n        line-height: 1.4;\n        display: -webkit-box;\n        -webkit-line-clamp: 2;\n        -webkit-box-orient: vertical;\n        overflow: hidden;\n        word-wrap: break-word;\n      }\n\n      /* 空状态 - 极简设计 */\n      .map-notifications-empty {\n        text-align: center;\n        padding: 80px 32px;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        height: 100%;\n        background: #000;\n      }\n\n      .map-notifications-empty-icon {\n        width: 64px;\n        height: 64px;\n        margin-bottom: 16px;\n        background: #0a0a0a;\n        border-radius: 16px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .map-notifications-empty-icon svg {\n        width: 32px;\n        height: 32px;\n        stroke: #333;\n        fill: none;\n        stroke-width: 2;\n      }\n\n      .map-notifications-empty-text {\n        font-size: 14px;\n        color: #666;\n        line-height: 1.5;\n        font-weight: 500;\n      }\n\n      /* ==================== 城市乘车面板 - 黑白灰简约ins风格 ==================== */\n      /* 乘车面板遮罩 */\n      .ride-panel-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 249;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .ride-panel-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 乘车面板主容器 - 半屏抽屉 */\n      .ride-panel {\n        position: fixed;\n        bottom: 0;\n        left: 0;\n        width: 100%;\n        height: 58vh;\n        background: rgba(10, 10, 10, 0.75);\n        backdrop-filter: blur(24px) saturate(180%);\n        -webkit-backdrop-filter: blur(24px) saturate(180%);\n        border-top: 1px solid #2a2a2a;\n        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.6);\n        z-index: 250;\n        overflow-y: auto;\n        overflow-x: hidden;\n        clip-path: polygon(0 3%, 3% 0, 97% 0, 100% 3%, 100% 100%, 0 100%);\n        transform: translateY(100%);\n        transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .ride-panel.show {\n        transform: translateY(0);\n      }\n\n      .ride-panel.hide {\n        transform: translateY(100%);\n      }\n\n      /* 面板拖动手柄 */\n      .ride-panel-handle {\n        width: 48px;\n        height: 5px;\n        background: #404040;\n        border-radius: 3px;\n        margin: 12px auto 0;\n      }\n\n      /* 面板内容容器 */\n      .ride-panel-content {\n        padding: 24px 20px 40px;\n        max-width: 640px;\n        margin: 0 auto;\n      }\n\n      /* 路线信息横幅 */\n      .ride-route-banner {\n        background: linear-gradient(135deg, #2a2a2a 0%, #666 100%);\n        color: #fff;\n        padding: 14px 20px;\n        border-radius: 10px;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);\n      }\n\n      .ride-route-banner-left {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n\n      .ride-route-icon {\n        width: 20px;\n        height: 20px;\n      }\n\n      .ride-route-text {\n        font-size: 13px;\n        font-weight: 500;\n        letter-spacing: 0.2px;\n      }\n\n      .ride-route-time {\n        font-size: 18px;\n        font-weight: 700;\n        font-family: \'SF Mono\', \'Monaco\', Consolas, monospace;\n      }\n\n      /* 位置选择区域 */\n      .ride-location-section {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 12px;\n        margin-bottom: 24px;\n      }\n\n      .ride-location-box {\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        padding: 14px 16px;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        cursor: pointer;\n      }\n\n      .ride-location-box:hover {\n        background: #252525;\n        border-color: #3a3a3a;\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n\n      .ride-location-box.selecting {\n        border-color: #fff;\n        background: #252525;\n        animation: selectingPulse 1.5s ease-in-out infinite;\n      }\n\n      @keyframes selectingPulse {\n        0%, 100% {\n          border-color: #fff;\n        }\n        50% {\n          border-color: #666;\n        }\n      }\n\n      .ride-location-label {\n        font-size: 10px;\n        font-weight: 700;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        color: #707070;\n        margin-bottom: 6px;\n      }\n\n      .ride-location-value {\n        font-size: 13px;\n        font-weight: 500;\n        color: #fff;\n        line-height: 1.4;\n      }\n\n      .ride-location-value.placeholder {\n        color: #707070;\n        font-style: italic;\n      }\n\n      /* 区域标题 */\n      .ride-section-title {\n        font-size: 17px;\n        font-weight: 700;\n        letter-spacing: -0.3px;\n        color: #fff;\n        margin-bottom: 16px;\n      }\n\n      /* 车辆选择网格 */\n      .ride-vehicles-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n        gap: 12px;\n        margin-bottom: 24px;\n      }\n\n      /* 车辆卡片 */\n      .ride-vehicle-card {\n        background: #1a1a1a;\n        border: 2px solid #2a2a2a;\n        border-radius: 14px;\n        padding: 18px 14px;\n        cursor: pointer;\n        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        overflow: hidden;\n      }\n\n      .ride-vehicle-card::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(135deg, transparent 0%, #252525 100%);\n        opacity: 0;\n        transition: opacity 0.35s ease;\n      }\n\n      .ride-vehicle-card:hover {\n        border-color: #666;\n        transform: translateY(-4px) scale(1.02);\n        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.5);\n      }\n\n      .ride-vehicle-card:hover::before {\n        opacity: 1;\n      }\n\n      .ride-vehicle-card.selected {\n        border-color: #fff;\n        background: #252525;\n        box-shadow: 0 0 0 1px #fff inset;\n      }\n\n      .ride-vehicle-card > * {\n        position: relative;\n        z-index: 1;\n      }\n\n      /* 车辆图片容器 */\n      .ride-vehicle-image {\n        width: 100%;\n        height: 70px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        margin-bottom: 14px;\n      }\n\n      .ride-vehicle-image svg {\n        max-width: 90%;\n        max-height: 100%;\n        filter: drop-shadow(2px 3px 5px rgba(0, 0, 0, 0.3));\n        transition: transform 0.35s ease;\n      }\n\n      .ride-vehicle-card:hover .ride-vehicle-image svg {\n        transform: scale(1.08);\n      }\n\n      /* 车辆信息 */\n      .ride-vehicle-name {\n        font-size: 15px;\n        font-weight: 700;\n        color: #fff;\n        margin-bottom: 5px;\n        letter-spacing: -0.2px;\n      }\n\n      .ride-vehicle-capacity {\n        font-size: 11px;\n        color: #a0a0a0;\n        margin-bottom: 10px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n      }\n\n      .ride-capacity-icon {\n        width: 14px;\n        height: 14px;\n      }\n\n      /* 车辆价格 */\n      .ride-vehicle-pricing {\n        display: flex;\n        align-items: baseline;\n        justify-content: space-between;\n      }\n\n      .ride-vehicle-price {\n        font-size: 20px;\n        font-weight: 800;\n        color: #fff;\n        font-family: \'SF Mono\', \'Monaco\', Consolas, monospace;\n      }\n\n      .ride-vehicle-eta {\n        font-size: 10px;\n        color: #707070;\n        font-weight: 500;\n      }\n\n      /* 支付方式区域 */\n      .ride-payment-section {\n        margin-bottom: 20px;\n      }\n\n      .ride-payment-title {\n        font-size: 14px;\n        font-weight: 600;\n        color: #fff;\n        margin-bottom: 12px;\n      }\n\n      .ride-payment-options {\n        display: grid;\n        grid-template-columns: repeat(2, 1fr);\n        gap: 10px;\n      }\n\n      .ride-payment-option {\n        background: #1a1a1a;\n        border: 2px solid #2a2a2a;\n        border-radius: 10px;\n        padding: 12px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        font-size: 13px;\n        font-weight: 500;\n        color: #fff;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .ride-payment-option:hover {\n        border-color: #666;\n        background: #252525;\n      }\n\n      .ride-payment-option.selected {\n        border-color: #fff;\n        background: #252525;\n      }\n\n      .ride-payment-icon {\n        width: 18px;\n        height: 18px;\n      }\n\n      /* 预订按钮 */\n      .ride-book-btn {\n        width: 100%;\n        padding: 17px 24px;\n        background: #fff;\n        color: #000;\n        border: none;\n        border-radius: 12px;\n        font-size: 15px;\n        font-weight: 700;\n        letter-spacing: 0.3px;\n        text-transform: uppercase;\n        cursor: pointer;\n        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);\n        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .ride-book-btn:hover {\n        transform: translateY(-3px);\n        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);\n      }\n\n      .ride-book-btn:active {\n        transform: translateY(-1px);\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);\n      }\n\n      .ride-book-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n\n      /* 选择目的地提示 */\n      .ride-selection-hint {\n        position: fixed;\n        top: 24px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: rgba(10, 10, 10, 0.75);\n        backdrop-filter: blur(12px);\n        -webkit-backdrop-filter: blur(12px);\n        border: 1px solid #2a2a2a;\n        padding: 12px 24px;\n        border-radius: 24px;\n        font-size: 13px;\n        font-weight: 600;\n        color: #fff;\n        z-index: 260;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n      }\n\n      .ride-selection-hint.show {\n        opacity: 1;\n      }\n\n      /* 地图上的路线SVG容器 */\n      .ride-route-svg {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        z-index: 5;\n      }\n\n      .ride-route-path {\n        fill: none;\n        stroke: #b0b0b0;\n        stroke-width: 3;\n        stroke-linecap: round;\n        stroke-linejoin: round;\n        stroke-dasharray: 12 6;\n        animation: routeFlow 25s linear infinite;\n      }\n\n      @keyframes routeFlow {\n        to {\n          stroke-dashoffset: -180;\n        }\n      }\n\n      /* 地图上的车辆标记 */\n      .ride-vehicle-marker {\n        position: absolute;\n        width: 32px;\n        height: 32px;\n        z-index: 6;\n        animation: vehicleFloat 3.5s ease-in-out infinite;\n        filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.6));\n        pointer-events: none;\n      }\n\n      .ride-vehicle-marker svg {\n        width: 100%;\n        height: 100%;\n      }\n\n      @keyframes vehicleFloat {\n        0%, 100% {\n          transform: translateY(0) rotate(0deg);\n        }\n        50% {\n          transform: translateY(-5px) rotate(2deg);\n        }\n      }\n\n      /* 选中的目的地地标发光效果 */\n      .landmark-label.ride-destination-selected .landmark-label-icon {\n        animation: destinationGlow 2s ease-in-out infinite;\n      }\n\n      @keyframes destinationGlow {\n        0%, 100% {\n          filter: drop-shadow(0 0 8px currentColor);\n        }\n        50% {\n          filter: drop-shadow(0 0 16px currentColor);\n        }\n      }\n\n      /* 滚动条样式 */\n      .ride-panel::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .ride-panel::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .ride-panel::-webkit-scrollbar-thumb {\n        background: #404040;\n        border-radius: 3px;\n      }\n\n      .ride-panel::-webkit-scrollbar-thumb:hover {\n        background: #707070;\n      }\n\n      /* ==================== 城市乘车面板 - 亮色主题适配 ==================== */\n      #x-map-container.light-theme .ride-panel-overlay {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .ride-panel {\n        background: rgba(255, 255, 255, 0.75);\n        border-top: 1px solid #e5e5e5;\n        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-panel-handle {\n        background: #cccccc;\n      }\n\n      #x-map-container.light-theme .ride-route-banner {\n        background: linear-gradient(135deg, #2a2a2a 0%, #666 100%);\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-location-box {\n        background: #f8f8f8;\n        border: 1px solid #e5e5e5;\n      }\n\n      #x-map-container.light-theme .ride-location-box:hover {\n        background: #f0f0f0;\n        border-color: #d0d0d0;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\n      }\n\n      #x-map-container.light-theme .ride-location-box.selecting {\n        border-color: #000;\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .ride-location-label {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .ride-location-value {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-location-value.placeholder {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .ride-section-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-card {\n        background: #f8f8f8;\n        border: 2px solid #e5e5e5;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-card::before {\n        background: linear-gradient(135deg, transparent 0%, #f0f0f0 100%);\n      }\n\n      #x-map-container.light-theme .ride-vehicle-card:hover {\n        border-color: #666;\n        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-vehicle-card.selected {\n        border-color: #000;\n        background: #f0f0f0;\n        box-shadow: 0 0 0 1px #000 inset;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-name {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-capacity {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-price {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-vehicle-eta {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .ride-payment-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-payment-option {\n        background: #f8f8f8;\n        border: 2px solid #e5e5e5;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .ride-payment-option:hover {\n        border-color: #666;\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .ride-payment-option.selected {\n        border-color: #000;\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .ride-book-btn {\n        background: #000;\n        color: #fff;\n        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-book-btn:hover {\n        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.16);\n      }\n\n      #x-map-container.light-theme .ride-book-btn:active {\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-selection-hint {\n        background: rgba(255, 255, 255, 0.75);\n        border: 1px solid #e5e5e5;\n        color: #000;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .ride-route-path {\n        stroke: #4a4a4a;\n      }\n\n      #x-map-container.light-theme .ride-panel::-webkit-scrollbar-thumb {\n        background: #cccccc;\n      }\n\n      #x-map-container.light-theme .ride-panel::-webkit-scrollbar-thumb:hover {\n        background: #a0a0a0;\n      }\n\n      /* ==================== 等待司机悬浮小球 ==================== */\n      .waiting-driver-float-btn {\n        position: fixed;\n        bottom: 100px;\n        right: 24px;\n        width: 64px;\n        height: 64px;\n        background: rgba(10, 10, 10, 0.85);\n        border: 2px solid #2a2a2a;\n        border-radius: 50%;\n        display: none;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        z-index: 999;\n        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n        backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n      }\n\n      .waiting-driver-float-btn.active {\n        display: flex;\n      }\n\n      .waiting-driver-float-btn::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.3);\n        animation: driverPulse 2s ease-out infinite;\n        z-index: -1;\n      }\n\n      @keyframes driverPulse {\n        0% {\n          transform: scale(1);\n          opacity: 0.8;\n        }\n        100% {\n          transform: scale(2);\n          opacity: 0;\n        }\n      }\n\n      .waiting-driver-float-btn:hover {\n        transform: scale(1.1);\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n      }\n\n      .waiting-driver-float-btn svg {\n        width: 32px;\n        height: 32px;\n        stroke: #ffffff;\n        stroke-width: 1.5;\n        transition: stroke 0.3s ease;\n      }\n\n      /* 摇晃动画（车辆到达时） */\n      .waiting-driver-float-btn.shake {\n        animation: driverShake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) infinite;\n      }\n\n      @keyframes driverShake {\n        0%, 100% { transform: translateX(0) rotate(0deg); }\n        10%, 30%, 50%, 70%, 90% { transform: translateX(-4px) rotate(-5deg); }\n        20%, 40%, 60%, 80% { transform: translateX(4px) rotate(5deg); }\n      }\n\n      /* 亮色主题适配 */\n      #x-map-container.light-theme .waiting-driver-float-btn {\n        background: rgba(255, 255, 255, 0.85);\n        border-color: #e5e5e5;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);\n      }\n\n      #x-map-container.light-theme .waiting-driver-float-btn::before {\n        background: rgba(42, 42, 42, 0.3);\n      }\n\n      #x-map-container.light-theme .waiting-driver-float-btn svg {\n        stroke: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-float-btn:hover {\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\n      }\n\n      /* ==================== 等待司机弹窗 ==================== */\n      .waiting-driver-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.4);\n        backdrop-filter: blur(8px);\n        z-index: 2500;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        visibility: hidden;\n        transition: opacity 0.3s ease, visibility 0.3s ease;\n      }\n\n      .waiting-driver-modal-overlay.active {\n        opacity: 1;\n        visibility: visible;\n      }\n\n      .waiting-driver-modal {\n        position: relative;\n        width: 90%;\n        max-width: 420px;\n        background: rgba(10, 10, 10, 0.85);\n        border: 1px solid #2a2a2a;\n        backdrop-filter: blur(24px) saturate(180%);\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n        clip-path: polygon(\n          16px 0,\n          calc(100% - 16px) 0,\n          100% 16px,\n          100% calc(100% - 24px),\n          calc(100% - 24px) 100%,\n          24px 100%,\n          0 calc(100% - 24px),\n          0 16px\n        );\n        padding: 32px 24px 24px;\n        transform: scale(0.8);\n        opacity: 0;\n        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .waiting-driver-modal-overlay.active .waiting-driver-modal {\n        transform: scale(1);\n        opacity: 1;\n      }\n\n      .waiting-driver-close {\n        position: absolute;\n        top: 12px;\n        right: 12px;\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s ease;\n        z-index: 1;\n      }\n\n      .waiting-driver-close:hover {\n        background: #252525;\n        transform: rotate(90deg);\n      }\n\n      .waiting-driver-close svg {\n        width: 20px;\n        height: 20px;\n        stroke: #a0a0a0;\n        stroke-width: 2;\n      }\n\n      .waiting-driver-header {\n        text-align: center;\n        margin-bottom: 24px;\n      }\n\n      .waiting-driver-status {\n        font-size: 13px;\n        font-weight: 500;\n        letter-spacing: 1.2px;\n        text-transform: uppercase;\n        color: #707070;\n        margin-bottom: 8px;\n      }\n\n      .waiting-driver-eta {\n        font-size: 32px;\n        font-weight: 700;\n        letter-spacing: -0.5px;\n        color: #ffffff;\n        font-family: \'SF Pro Display\', -apple-system, BlinkMacSystemFont, sans-serif;\n      }\n\n      .waiting-driver-eta-label {\n        font-size: 14px;\n        font-weight: 400;\n        color: #a0a0a0;\n        margin-top: 4px;\n      }\n\n      .waiting-driver-card {\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 20px;\n        padding: 20px;\n        margin-bottom: 20px;\n        display: flex;\n        align-items: center;\n        gap: 16px;\n        position: relative;\n        overflow: hidden;\n        transition: all 0.3s ease;\n      }\n\n      .waiting-driver-card::before {\n        content: \'\';\n        position: absolute;\n        top: -50%;\n        left: -50%;\n        width: 200%;\n        height: 200%;\n        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);\n        transform: rotate(45deg);\n        animation: driverCardShimmer 3s infinite;\n      }\n\n      @keyframes driverCardShimmer {\n        0% { transform: translateX(-100%) rotate(45deg); }\n        100% { transform: translateX(100%) rotate(45deg); }\n      }\n\n      .waiting-driver-avatar {\n        position: relative;\n        width: 64px;\n        height: 64px;\n        border-radius: 50%;\n        overflow: hidden;\n        flex-shrink: 0;\n        z-index: 1;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n\n      .waiting-driver-avatar::after {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border-radius: 50%;\n        border: 2px solid #d5d5d5;\n        opacity: 0.3;\n      }\n\n      .waiting-driver-avatar img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n      }\n\n      .waiting-driver-info {\n        flex: 1;\n        z-index: 1;\n      }\n\n      .waiting-driver-name {\n        font-size: 18px;\n        font-weight: 700;\n        color: #ffffff;\n        margin-bottom: 4px;\n        letter-spacing: -0.3px;\n      }\n\n      .waiting-driver-rating {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        margin-bottom: 6px;\n      }\n\n      .waiting-driver-rating svg {\n        width: 14px;\n        height: 14px;\n        fill: #ffffff;\n      }\n\n      .waiting-driver-rating-value {\n        font-size: 13px;\n        font-weight: 600;\n        color: #ffffff;\n        margin-left: 2px;\n      }\n\n      .waiting-driver-vehicle {\n        font-size: 13px;\n        color: #a0a0a0;\n        font-weight: 500;\n      }\n\n      .waiting-driver-plate {\n        display: inline-block;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        padding: 2px 8px;\n        border-radius: 4px;\n        font-size: 11px;\n        font-weight: 700;\n        letter-spacing: 0.5px;\n        margin-left: 6px;\n        font-family: \'Courier New\', monospace;\n        color: #ffffff;\n      }\n\n      .waiting-driver-route-map {\n        position: relative;\n        width: 100%;\n        height: 200px;\n        background: #151515;\n        border-radius: 16px;\n        overflow: hidden;\n        margin-bottom: 20px;\n        border: 1px solid #2a2a2a;\n      }\n\n      .waiting-driver-route-grid {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-image:\n          repeating-linear-gradient(0deg, transparent, transparent 19px, #2a2a2a 19px, #2a2a2a 20px),\n          repeating-linear-gradient(90deg, transparent, transparent 19px, #2a2a2a 19px, #2a2a2a 20px);\n        opacity: 0.3;\n      }\n\n      .waiting-driver-route-line {\n        position: absolute;\n        top: 50%;\n        left: 20%;\n        width: 60%;\n        height: 2px;\n        background: transparent;\n        transform: translateY(-50%);\n      }\n\n      .waiting-driver-route-line::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: repeating-linear-gradient(\n          to right,\n          #b0b0b0 0px,\n          #b0b0b0 8px,\n          transparent 8px,\n          transparent 16px\n        );\n        animation: driverRouteFlow 1.5s linear infinite;\n      }\n\n      @keyframes driverRouteFlow {\n        0% { transform: translateX(0); }\n        100% { transform: translateX(16px); }\n      }\n\n      .waiting-driver-user-marker {\n        position: absolute;\n        left: 80%;\n        top: 50%;\n        transform: translate(-50%, -50%);\n        z-index: 2;\n      }\n\n      .waiting-driver-user-pin {\n        width: 32px;\n        height: 32px;\n        background: #d5d5d5;\n        border: 3px solid #0a0a0a;\n        border-radius: 50%;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .waiting-driver-user-pin svg {\n        width: 16px;\n        height: 16px;\n        stroke: #0a0a0a;\n        stroke-width: 2.5;\n      }\n\n      .waiting-driver-car-marker {\n        position: absolute;\n        left: 20%;\n        top: 50%;\n        transform: translate(-50%, -50%);\n        z-index: 3;\n      }\n\n      .waiting-driver-car-icon {\n        width: 40px;\n        height: 40px;\n        background: #0a0a0a;\n        border: 2px solid #d5d5d5;\n        border-radius: 50%;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        position: relative;\n      }\n\n      .waiting-driver-car-icon::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.3);\n        animation: driverCarPulse 2s ease-out infinite;\n        z-index: -1;\n      }\n\n      @keyframes driverCarPulse {\n        0% {\n          transform: scale(1);\n          opacity: 0.6;\n        }\n        100% {\n          transform: scale(2.5);\n          opacity: 0;\n        }\n      }\n\n      .waiting-driver-car-icon svg {\n        width: 20px;\n        height: 20px;\n        stroke: #d5d5d5;\n        stroke-width: 2;\n      }\n\n      .waiting-driver-car-label {\n        position: absolute;\n        bottom: -28px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: rgba(10, 10, 10, 0.85);\n        border: 1px solid #2a2a2a;\n        padding: 4px 10px;\n        border-radius: 12px;\n        font-size: 11px;\n        font-weight: 600;\n        color: #ffffff;\n        white-space: nowrap;\n        backdrop-filter: blur(8px);\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n      }\n\n      .waiting-driver-distance-info {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px;\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 12px;\n        margin-bottom: 20px;\n      }\n\n      .waiting-driver-distance-item {\n        text-align: center;\n        flex: 1;\n      }\n\n      .waiting-driver-distance-value {\n        font-size: 20px;\n        font-weight: 700;\n        color: #ffffff;\n        letter-spacing: -0.3px;\n      }\n\n      .waiting-driver-distance-label {\n        font-size: 11px;\n        color: #707070;\n        margin-top: 2px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n\n      .waiting-driver-distance-divider {\n        width: 1px;\n        height: 32px;\n        background: #2a2a2a;\n      }\n\n      .waiting-driver-actions {\n        display: flex;\n        gap: 12px;\n      }\n\n      .waiting-driver-action-btn {\n        flex: 1;\n        height: 48px;\n        border: 1px solid #2a2a2a;\n        border-radius: 12px;\n        background: #1a1a1a;\n        color: #ffffff;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        transition: all 0.2s ease;\n      }\n\n      .waiting-driver-action-btn:hover {\n        background: #252525;\n        transform: translateY(-2px);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\n      }\n\n      .waiting-driver-action-btn svg {\n        width: 18px;\n        height: 18px;\n        stroke: #ffffff;\n        stroke-width: 2;\n      }\n\n      .waiting-driver-action-btn.cancel {\n        background: transparent;\n        border: 2px solid #d5d5d5;\n      }\n\n      .waiting-driver-action-btn.cancel:hover {\n        background: #d5d5d5;\n        color: #0a0a0a;\n      }\n\n      .waiting-driver-action-btn.cancel:hover svg {\n        stroke: #0a0a0a;\n      }\n\n      /* 亮色主题适配 */\n      #x-map-container.light-theme .waiting-driver-modal {\n        background: rgba(255, 255, 255, 0.85);\n        border-color: #e5e5e5;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .waiting-driver-close:hover {\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .waiting-driver-close svg {\n        stroke: #666666;\n      }\n\n      #x-map-container.light-theme .waiting-driver-status {\n        color: #999999;\n      }\n\n      #x-map-container.light-theme .waiting-driver-eta {\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-eta-label {\n        color: #666666;\n      }\n\n      #x-map-container.light-theme .waiting-driver-card {\n        background: #f8f8f8;\n        border-color: #e5e5e5;\n      }\n\n      #x-map-container.light-theme .waiting-driver-card::before {\n        background: linear-gradient(45deg, transparent, rgba(0, 0, 0, 0.05), transparent);\n      }\n\n      #x-map-container.light-theme .waiting-driver-avatar::after {\n        border-color: #2a2a2a;\n      }\n\n      #x-map-container.light-theme .waiting-driver-name {\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-rating svg {\n        fill: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-rating-value {\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-vehicle {\n        color: #666666;\n      }\n\n      #x-map-container.light-theme .waiting-driver-plate {\n        background: #ffffff;\n        border-color: #e5e5e5;\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-route-map {\n        background: #ebebeb;\n        border-color: #e5e5e5;\n      }\n\n      #x-map-container.light-theme .waiting-driver-route-grid {\n        background-image:\n          repeating-linear-gradient(0deg, transparent, transparent 19px, #d5d5d5 19px, #d5d5d5 20px),\n          repeating-linear-gradient(90deg, transparent, transparent 19px, #d5d5d5 19px, #d5d5d5 20px);\n      }\n\n      #x-map-container.light-theme .waiting-driver-route-line::before {\n        background: repeating-linear-gradient(\n          to right,\n          #4a4a4a 0px,\n          #4a4a4a 8px,\n          transparent 8px,\n          transparent 16px\n        );\n      }\n\n      #x-map-container.light-theme .waiting-driver-user-pin {\n        background: #2a2a2a;\n        border-color: #ffffff;\n      }\n\n      #x-map-container.light-theme .waiting-driver-user-pin svg {\n        stroke: #ffffff;\n      }\n\n      #x-map-container.light-theme .waiting-driver-car-icon {\n        background: #ffffff;\n        border-color: #2a2a2a;\n      }\n\n      #x-map-container.light-theme .waiting-driver-car-icon::before {\n        background: rgba(42, 42, 42, 0.3);\n      }\n\n      #x-map-container.light-theme .waiting-driver-car-icon svg {\n        stroke: #2a2a2a;\n      }\n\n      #x-map-container.light-theme .waiting-driver-car-label {\n        background: rgba(255, 255, 255, 0.85);\n        border-color: #e5e5e5;\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-distance-info {\n        background: #f8f8f8;\n        border-color: #e5e5e5;\n      }\n\n      #x-map-container.light-theme .waiting-driver-distance-value {\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-distance-label {\n        color: #999999;\n      }\n\n      #x-map-container.light-theme .waiting-driver-distance-divider {\n        background: #e5e5e5;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn {\n        background: #f8f8f8;\n        border-color: #e5e5e5;\n        color: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn:hover {\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn svg {\n        stroke: #000000;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn.cancel {\n        border-color: #2a2a2a;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn.cancel:hover {\n        background: #2a2a2a;\n        color: #ffffff;\n      }\n\n      #x-map-container.light-theme .waiting-driver-action-btn.cancel:hover svg {\n        stroke: #ffffff;\n      }\n\n      /* 移动端适配 */\n      @media (max-width: 480px) {\n        .waiting-driver-modal {\n          width: 95%;\n          padding: 28px 20px 20px;\n        }\n\n        .waiting-driver-eta {\n          font-size: 28px;\n        }\n\n        .waiting-driver-card {\n          padding: 16px;\n        }\n\n        .waiting-driver-route-map {\n          height: 180px;\n        }\n      }\n\n      /* ==================== 移动端适配：提醒弹窗 ==================== */\n      @media (max-width: 480px) {\n        .map-notifications-content {\n          width: calc(100% - 20px);\n          max-width: 100%;\n          border-radius: 20px;\n        }\n\n        .map-notifications-header {\n          padding: 20px 16px 16px;\n          gap: 12px;\n        }\n\n        .map-notifications-title {\n          font-size: 24px;\n        }\n\n        .map-notifications-close-btn {\n          width: 32px;\n          height: 32px;\n        }\n\n        .map-notifications-stats {\n          padding: 12px 16px;\n          gap: 12px;\n          border-radius: 12px;\n        }\n\n        .map-notifications-stats-icon {\n          width: 40px;\n          height: 40px;\n          border-radius: 20px;\n        }\n\n        .map-notifications-stats-icon svg {\n          width: 20px;\n          height: 20px;\n        }\n\n        .map-notifications-stats-label {\n          font-size: 12px;\n        }\n\n        .map-notifications-stats-count {\n          font-size: 20px;\n        }\n\n        .map-notifications-tabs {\n          gap: 6px;\n        }\n\n        .map-notifications-tab {\n          padding: 6px 14px;\n          font-size: 13px;\n          border-radius: 16px;\n        }\n\n        .map-notifications-list-container {\n          padding: 8px 12px 12px;\n        }\n\n        .map-notification-item {\n          padding: 12px 14px;\n          gap: 12px;\n          border-radius: 10px;\n        }\n\n        .map-notification-icon {\n          width: 36px;\n          height: 36px;\n          border-radius: 9px;\n        }\n\n        .map-notification-icon svg {\n          width: 18px;\n          height: 18px;\n        }\n\n        .map-notification-title {\n          font-size: 14px;\n        }\n\n        .map-notification-content {\n          font-size: 13px;\n        }\n\n        .map-notification-time {\n          font-size: 11px;\n        }\n\n        .map-notifications-empty {\n          padding: 60px 24px;\n        }\n\n        .map-notifications-empty-icon {\n          width: 56px;\n          height: 56px;\n          border-radius: 14px;\n        }\n\n        .map-notifications-empty-icon svg {\n          width: 28px;\n          height: 28px;\n        }\n\n        .map-notifications-empty-text {\n          font-size: 13px;\n        }\n      }\n\n      /* ==================== 接收私信确认弹窗 - 极简黑白灰 ==================== */\n      .map-accept-message-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 399;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-accept-message-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-accept-message-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 400;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-accept-message-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 确认弹窗内容容器 */\n      .map-accept-message-content {\n        width: calc(100% - 32px);\n        max-width: 380px;\n        background: #1a1a1a;\n        border-radius: 20px;\n        overflow: hidden;\n        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6);\n        animation: confirmModalZoom 0.3s cubic-bezier(0.32, 0.72, 0, 1);\n      }\n\n      @keyframes confirmModalZoom {\n        from {\n          opacity: 0;\n          transform: scale(0.88);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1);\n        }\n      }\n\n      /* 确认弹窗内容区 */\n      .map-accept-message-header {\n        padding: 24px 20px;\n        background: #1a1a1a;\n      }\n\n      .map-accept-message-user {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 16px;\n      }\n\n      .map-accept-message-avatar {\n        width: 52px;\n        height: 52px;\n        border-radius: 50%;\n        object-fit: cover;\n        border: 1.5px solid #333333;\n        flex-shrink: 0;\n      }\n\n      .map-accept-message-user-info h3 {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e5e5e5;\n        margin: 0 0 4px 0;\n        letter-spacing: -0.2px;\n      }\n\n      .map-accept-message-user-info p {\n        font-size: 13px;\n        color: #8e8e8e;\n        margin: 0;\n      }\n\n      .map-accept-message-title {\n        font-size: 13px;\n        color: #8e8e8e;\n        margin: 0 0 10px 0;\n        font-weight: 500;\n      }\n\n      /* 私信内容预览框 */\n      .map-accept-message-text {\n        background: #262626;\n        border-radius: 14px;\n        padding: 14px 16px;\n        font-size: 15px;\n        color: #e5e5e5;\n        line-height: 1.5;\n        max-height: 180px;\n        overflow-y: auto;\n        border: 1px solid #333333;\n      }\n\n      .map-accept-message-text::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-accept-message-text::-webkit-scrollbar-thumb {\n        background: #444444;\n        border-radius: 3px;\n      }\n\n      /* 确认弹窗按钮 */\n      .map-accept-message-actions {\n        padding: 20px;\n        background: #1a1a1a;\n        display: flex;\n        gap: 12px;\n        border-top: 1px solid #333333;\n      }\n\n      .map-accept-btn,\n      .map-decline-btn {\n        flex: 1;\n        padding: 13px 20px;\n        border: none;\n        border-radius: 12px;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-accept-btn {\n        background: #fff;\n        color: #000;\n      }\n\n      .map-accept-btn:hover {\n        background: #e5e5e5;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);\n      }\n\n      .map-accept-btn:active {\n        background: #d0d0d0;\n        transform: translateY(0);\n      }\n\n      .map-decline-btn {\n        background: #2a2a2a;\n        color: #e5e5e5;\n        border: 1.5px solid #444444;\n      }\n\n      .map-decline-btn:hover {\n        background: #333333;\n        border-color: #555555;\n      }\n\n      .map-decline-btn:active {\n        background: #282828;\n      }\n\n      /* ==================== 🚨 举报弹窗 - 简约ins风格 ==================== */\n      .map-report-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.75);\n        z-index: 499;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-report-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-report-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 500;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        padding: 20px;\n        box-sizing: border-box;\n      }\n\n      .map-report-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-report-content {\n        width: 100%;\n        max-width: 420px;\n        max-height: 85vh;\n        background: #1a1a1a;\n        border-radius: 20px;\n        overflow: hidden;\n        box-shadow: 0 16px 56px rgba(0, 0, 0, 0.7);\n        animation: reportModalSlide 0.3s cubic-bezier(0.32, 0.72, 0, 1);\n        display: flex;\n        flex-direction: column;\n      }\n\n      @keyframes reportModalSlide {\n        from {\n          opacity: 0;\n          transform: scale(0.92) translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1) translateY(0);\n        }\n      }\n\n      /* 举报弹窗头部 */\n      .map-report-header {\n        padding: 20px 20px 18px;\n        background: #1a1a1a;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        flex-shrink: 0;\n      }\n\n      .map-report-title {\n        font-size: 18px;\n        font-weight: 600;\n        color: #e5e5e5;\n        margin: 0;\n        letter-spacing: -0.3px;\n      }\n\n      .map-report-close-btn {\n        width: 32px;\n        height: 32px;\n        border: none;\n        background: transparent;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: background 0.2s ease;\n        padding: 0;\n        flex-shrink: 0;\n      }\n\n      .map-report-close-btn svg {\n        width: 20px;\n        height: 20px;\n        stroke: #8e8e8e;\n        stroke-width: 2.5;\n        stroke-linecap: round;\n      }\n\n      .map-report-close-btn:hover {\n        background: rgba(255, 255, 255, 0.08);\n      }\n\n      .map-report-close-btn:hover svg {\n        stroke: #e5e5e5;\n      }\n\n      .map-report-close-btn:active {\n        background: rgba(255, 255, 255, 0.12);\n      }\n\n      /* 举报弹窗主体 */\n      .map-report-body {\n        padding: 20px;\n        background: #1a1a1a;\n        overflow-y: auto;\n        overflow-x: hidden;\n        flex: 1;\n      }\n\n      .map-report-body::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-report-body::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-report-body::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.15);\n        border-radius: 3px;\n      }\n\n      .map-report-body::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.25);\n      }\n\n      /* 被举报用户信息 */\n      .map-report-user-info {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 16px;\n        background: #242424;\n        border-radius: 14px;\n        margin-bottom: 24px;\n        border: 1px solid #2a2a2a;\n      }\n\n      .map-report-user-avatar {\n        width: 48px;\n        height: 48px;\n        border-radius: 50%;\n        object-fit: cover;\n        border: 1.5px solid #333333;\n        flex-shrink: 0;\n      }\n\n      .map-report-user-details h4 {\n        font-size: 15px;\n        font-weight: 600;\n        color: #e5e5e5;\n        margin: 0 0 4px 0;\n        letter-spacing: -0.2px;\n      }\n\n      .map-report-user-details p {\n        font-size: 13px;\n        color: #8e8e8e;\n        margin: 0;\n      }\n\n      /* 举报表单区块 */\n      .map-report-section {\n        margin-bottom: 24px;\n      }\n\n      .map-report-section:last-child {\n        margin-bottom: 0;\n      }\n\n      .map-report-section-label {\n        display: block;\n        font-size: 14px;\n        font-weight: 600;\n        color: #e5e5e5;\n        margin-bottom: 12px;\n        letter-spacing: -0.1px;\n      }\n\n      /* 举报理由列表 */\n      .map-report-reasons {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      .map-report-reason-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 14px 16px;\n        background: #242424;\n        border: 1.5px solid #2a2a2a;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        user-select: none;\n      }\n\n      .map-report-reason-item:hover {\n        background: #2a2a2a;\n        border-color: #3a3a3a;\n      }\n\n      .map-report-reason-item input[type="checkbox"] {\n        width: 20px;\n        height: 20px;\n        cursor: pointer;\n        margin: 0;\n        flex-shrink: 0;\n        appearance: none;\n        -webkit-appearance: none;\n        background: #1a1a1a;\n        border: 2px solid #444444;\n        border-radius: 6px;\n        position: relative;\n        transition: all 0.2s ease;\n      }\n\n      .map-report-reason-item input[type="checkbox"]:checked {\n        background: #fff;\n        border-color: #fff;\n      }\n\n      .map-report-reason-item input[type="checkbox"]:checked::after {\n        content: \'\';\n        position: absolute;\n        left: 5px;\n        top: 2px;\n        width: 6px;\n        height: 10px;\n        border: solid #000;\n        border-width: 0 2.5px 2.5px 0;\n        transform: rotate(45deg);\n      }\n\n      .map-report-reason-item input[type="checkbox"]:hover {\n        border-color: #666666;\n      }\n\n      .map-report-reason-text {\n        font-size: 14px;\n        color: #e5e5e5;\n        font-weight: 500;\n        letter-spacing: -0.1px;\n      }\n\n      /* 举报描述输入框 */\n      .map-report-textarea {\n        width: 100%;\n        padding: 14px 16px;\n        background: #242424;\n        border: 1.5px solid #2a2a2a;\n        border-radius: 12px;\n        color: #e5e5e5;\n        font-size: 14px;\n        font-family: inherit;\n        line-height: 1.5;\n        resize: vertical;\n        min-height: 100px;\n        transition: all 0.2s ease;\n        box-sizing: border-box;\n      }\n\n      .map-report-textarea::placeholder {\n        color: #666666;\n      }\n\n      .map-report-textarea:focus {\n        outline: none;\n        border-color: #3a3a3a;\n        background: #2a2a2a;\n      }\n\n      .map-report-textarea::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-report-textarea::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.15);\n        border-radius: 3px;\n      }\n\n      /* 举报弹窗底部按钮 */\n      .map-report-actions {\n        padding: 16px 20px;\n        background: #1a1a1a;\n        border-top: 1px solid #2a2a2a;\n        display: flex;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      .map-report-cancel-btn,\n      .map-report-submit-btn {\n        flex: 1;\n        padding: 13px 20px;\n        border: none;\n        border-radius: 12px;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-report-cancel-btn {\n        background: #2a2a2a;\n        color: #e5e5e5;\n        border: 1.5px solid #3a3a3a;\n      }\n\n      .map-report-cancel-btn:hover {\n        background: #333333;\n        border-color: #444444;\n      }\n\n      .map-report-cancel-btn:active {\n        background: #282828;\n      }\n\n      .map-report-submit-btn {\n        background: #fff;\n        color: #000;\n      }\n\n      .map-report-submit-btn:hover {\n        background: #e5e5e5;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);\n      }\n\n      .map-report-submit-btn:active {\n        background: #d0d0d0;\n        transform: translateY(0);\n      }\n\n      .map-report-submit-btn:disabled {\n        background: #3a3a3a;\n        color: #666666;\n        cursor: not-allowed;\n        transform: none;\n        box-shadow: none;\n      }\n\n      /* ==================== 举报详情弹窗 - ins简约风格 ==================== */\n      /* 举报详情遮罩 */\n      .map-report-detail-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 499;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-report-detail-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 举报详情弹窗容器 */\n      .map-report-detail-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 500;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        padding: 20px;\n        box-sizing: border-box;\n      }\n\n      .map-report-detail-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 举报详情内容 */\n      .map-report-detail-content {\n        width: 100%;\n        max-width: 480px;\n        max-height: 90vh;\n        background: #1a1a1a;\n        border-radius: 24px;\n        overflow: hidden;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);\n        animation: reportDetailSlide 0.35s cubic-bezier(0.32, 0.72, 0, 1);\n        display: flex;\n        flex-direction: column;\n      }\n\n      @keyframes reportDetailSlide {\n        from {\n          opacity: 0;\n          transform: scale(0.94) translateY(20px);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1) translateY(0);\n        }\n      }\n\n      /* 举报详情头部 */\n      .map-report-detail-header {\n        padding: 24px 24px 20px;\n        background: #1a1a1a;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        flex-shrink: 0;\n      }\n\n      .map-report-detail-title {\n        font-size: 20px;\n        font-weight: 700;\n        color: #e5e5e5;\n        margin: 0;\n        letter-spacing: -0.4px;\n      }\n\n      .map-report-detail-close-btn {\n        width: 36px;\n        height: 36px;\n        border: none;\n        background: transparent;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: background 0.2s ease;\n        padding: 0;\n        flex-shrink: 0;\n      }\n\n      .map-report-detail-close-btn svg {\n        width: 22px;\n        height: 22px;\n        stroke: #8e8e8e;\n        stroke-width: 2.5;\n        stroke-linecap: round;\n      }\n\n      .map-report-detail-close-btn:hover {\n        background: rgba(255, 255, 255, 0.08);\n      }\n\n      .map-report-detail-close-btn:hover svg {\n        stroke: #e5e5e5;\n      }\n\n      .map-report-detail-close-btn:active {\n        background: rgba(255, 255, 255, 0.12);\n      }\n\n      /* 判定结果徽章容器 */\n      .map-report-detail-badge-container {\n        padding: 24px 24px 20px;\n        background: #1a1a1a;\n        display: flex;\n        justify-content: center;\n      }\n\n      .map-report-detail-badge {\n        display: inline-flex;\n        align-items: center;\n        gap: 10px;\n        padding: 14px 24px;\n        border-radius: 20px;\n        border: 2px solid;\n        animation: badgePulse 0.5s ease;\n      }\n\n      @keyframes badgePulse {\n        0% { transform: scale(0.9); opacity: 0; }\n        60% { transform: scale(1.05); }\n        100% { transform: scale(1); opacity: 1; }\n      }\n\n      .map-report-detail-badge.approved {\n        border-color: #4a4a4a;\n        background: rgba(255, 255, 255, 0.03);\n      }\n\n      .map-report-detail-badge.declined {\n        border-color: #4a4a4a;\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      .map-report-detail-badge-icon {\n        width: 22px;\n        height: 22px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        position: relative;\n      }\n\n      .map-report-detail-badge.approved .map-report-detail-badge-icon::before {\n        content: \'\';\n        position: absolute;\n        width: 8px;\n        height: 14px;\n        border: solid #e5e5e5;\n        border-width: 0 2.5px 2.5px 0;\n        transform: rotate(45deg);\n        margin-top: -3px;\n      }\n\n      .map-report-detail-badge.declined .map-report-detail-badge-icon::before {\n        content: \'\';\n        position: absolute;\n        width: 16px;\n        height: 2.5px;\n        background: #e5e5e5;\n        transform: rotate(45deg);\n      }\n\n      .map-report-detail-badge.declined .map-report-detail-badge-icon::after {\n        content: \'\';\n        position: absolute;\n        width: 16px;\n        height: 2.5px;\n        background: #e5e5e5;\n        transform: rotate(-45deg);\n      }\n\n      .map-report-detail-badge-text {\n        font-size: 16px;\n        font-weight: 700;\n        color: #e5e5e5;\n        letter-spacing: -0.2px;\n      }\n\n      /* 举报详情主体 */\n      .map-report-detail-body {\n        padding: 20px 24px;\n        background: #1a1a1a;\n        overflow-y: auto;\n        overflow-x: hidden;\n        flex: 1;\n      }\n\n      .map-report-detail-body::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-report-detail-body::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-report-detail-body::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.15);\n        border-radius: 3px;\n      }\n\n      .map-report-detail-body::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.25);\n      }\n\n      /* 详情区块 */\n      .map-report-detail-section {\n        margin-bottom: 24px;\n      }\n\n      .map-report-detail-section:last-child {\n        margin-bottom: 0;\n      }\n\n      .map-report-detail-section-label {\n        display: block;\n        font-size: 12px;\n        font-weight: 700;\n        color: #8e8e8e;\n        margin-bottom: 10px;\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n      }\n\n      /* 用户卡片 */\n      .map-report-detail-user-card {\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        padding: 16px;\n        background: #242424;\n        border-radius: 16px;\n        border: 1px solid #2a2a2a;\n      }\n\n      .map-report-detail-user-avatar {\n        width: 52px;\n        height: 52px;\n        border-radius: 50%;\n        object-fit: cover;\n        border: 2px solid #333333;\n        flex-shrink: 0;\n      }\n\n      .map-report-detail-user-nickname {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e5e5e5;\n        margin-bottom: 4px;\n        letter-spacing: -0.2px;\n      }\n\n      .map-report-detail-user-handle {\n        font-size: 14px;\n        color: #8e8e8e;\n      }\n\n      /* 举报理由标签 */\n      .map-report-detail-reasons {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n      }\n\n      .map-report-detail-reason-tag {\n        display: inline-flex;\n        align-items: center;\n        padding: 8px 16px;\n        background: #242424;\n        border: 1px solid #3a3a3a;\n        border-radius: 14px;\n        font-size: 13px;\n        font-weight: 500;\n        color: #e5e5e5;\n        letter-spacing: -0.1px;\n      }\n\n      /* 举报描述 */\n      .map-report-detail-description {\n        padding: 16px;\n        background: #242424;\n        border-radius: 16px;\n        border: 1px solid #2a2a2a;\n        font-size: 14px;\n        line-height: 1.6;\n        color: #c0c0c0;\n        letter-spacing: -0.1px;\n      }\n\n      /* AI判定原因 */\n      .map-report-detail-reason {\n        padding: 18px;\n        background: #242424;\n        border-radius: 16px;\n        border: 1px solid #2a2a2a;\n        font-size: 14px;\n        line-height: 1.7;\n        color: #e5e5e5;\n        letter-spacing: -0.1px;\n      }\n\n      /* 举报时间 */\n      .map-report-detail-time {\n        padding: 14px 16px;\n        background: #242424;\n        border-radius: 14px;\n        border: 1px solid #2a2a2a;\n        font-size: 14px;\n        color: #8e8e8e;\n        font-family: \'SF Mono\', \'Menlo\', \'Consolas\', monospace;\n      }\n\n      /* 底部按钮 */\n      .map-report-detail-actions {\n        padding: 20px 24px;\n        background: #1a1a1a;\n        border-top: 1px solid #2a2a2a;\n        flex-shrink: 0;\n      }\n\n      .map-report-detail-acknowledge-btn {\n        width: 100%;\n        padding: 15px 24px;\n        border: none;\n        border-radius: 16px;\n        font-size: 16px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        background: #fff;\n        color: #000;\n        letter-spacing: -0.2px;\n      }\n\n      .map-report-detail-acknowledge-btn:hover {\n        background: #e5e5e5;\n        transform: translateY(-2px);\n        box-shadow: 0 6px 16px rgba(255, 255, 255, 0.25);\n      }\n\n      .map-report-detail-acknowledge-btn:active {\n        background: #d0d0d0;\n        transform: translateY(0);\n      }\n\n      /* 亮色模式适配 */\n      @media (prefers-color-scheme: light) {\n        .map-report-detail-content,\n        .map-report-detail-header,\n        .map-report-detail-body {\n          background: #ffffff;\n        }\n\n        .map-report-detail-header {\n          border-bottom-color: #e5e5e5;\n        }\n\n        .map-report-detail-title,\n        .map-report-detail-user-nickname,\n        .map-report-detail-badge-text,\n        .map-report-detail-reason {\n          color: #1a1a1a;\n        }\n\n        .map-report-detail-close-btn svg {\n          stroke: #666666;\n        }\n\n        .map-report-detail-close-btn:hover {\n          background: rgba(0, 0, 0, 0.05);\n        }\n\n        .map-report-detail-close-btn:hover svg {\n          stroke: #1a1a1a;\n        }\n\n        .map-report-detail-badge.approved,\n        .map-report-detail-badge.declined {\n          border-color: #d0d0d0;\n          background: #f8f8f8;\n        }\n\n        .map-report-detail-badge.approved .map-report-detail-badge-icon::before {\n          border-color: #1a1a1a;\n        }\n\n        .map-report-detail-badge.declined .map-report-detail-badge-icon::before,\n        .map-report-detail-badge.declined .map-report-detail-badge-icon::after {\n          background: #1a1a1a;\n        }\n\n        .map-report-detail-section-label {\n          color: #666666;\n        }\n\n        .map-report-detail-user-card,\n        .map-report-detail-description,\n        .map-report-detail-reason,\n        .map-report-detail-time {\n          background: #f8f8f8;\n          border-color: #e5e5e5;\n        }\n\n        .map-report-detail-user-avatar {\n          border-color: #d0d0d0;\n        }\n\n        .map-report-detail-user-handle {\n          color: #666666;\n        }\n\n        .map-report-detail-reason-tag {\n          background: #f0f0f0;\n          border-color: #d0d0d0;\n          color: #1a1a1a;\n        }\n\n        .map-report-detail-description {\n          color: #4a4a4a;\n        }\n\n        .map-report-detail-time {\n          color: #666666;\n        }\n\n        .map-report-detail-actions {\n          background: #ffffff;\n          border-top-color: #e5e5e5;\n        }\n\n        .map-report-detail-acknowledge-btn {\n          background: #1a1a1a;\n          color: #ffffff;\n        }\n\n        .map-report-detail-acknowledge-btn:hover {\n          background: #2a2a2a;\n          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);\n        }\n\n        .map-report-detail-acknowledge-btn:active {\n          background: #1a1a1a;\n        }\n      }\n\n      /* ==================== 应用设置弹窗 - 黑白灰简约ins风格 ==================== */\n      /* 应用设置弹窗遮罩 */\n      .map-app-settings-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 399;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-app-settings-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 应用设置弹窗主容器 */\n      .map-app-settings-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 400;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-app-settings-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 应用设置内容卡片 - ins风格 */\n      .map-app-settings-content {\n        width: calc(100% - 40px);\n        max-width: 380px;\n        background: #1a1a1a;\n        border-radius: 24px;\n        overflow: hidden;\n        box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5);\n        animation: appSettingsSlideIn 0.3s cubic-bezier(0.32, 0.72, 0, 1);\n      }\n\n      @keyframes appSettingsSlideIn {\n        from {\n          opacity: 0;\n          transform: scale(0.92) translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1) translateY(0);\n        }\n      }\n\n      /* 应用设置弹窗头部 */\n      .map-app-settings-header {\n        padding: 20px 24px;\n        background: #1a1a1a;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .map-app-settings-title {\n        font-size: 18px;\n        font-weight: 700;\n        color: #e5e5e5;\n        letter-spacing: -0.3px;\n      }\n\n      .map-app-settings-close-btn {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        border-radius: 50%;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background 0.15s ease;\n        padding: 0;\n      }\n\n      .map-app-settings-close-btn:hover {\n        background: rgba(255, 255, 255, 0.08);\n      }\n\n      .map-app-settings-close-btn:active {\n        background: rgba(255, 255, 255, 0.12);\n      }\n\n      .map-app-settings-close-btn svg {\n        width: 20px;\n        height: 20px;\n        stroke: #e5e5e5;\n        fill: none;\n        stroke-width: 2.5;\n        stroke-linecap: round;\n      }\n\n      /* 应用设置弹窗主体 */\n      .map-app-settings-body {\n        padding: 24px;\n        background: #1a1a1a;\n        max-height: 70vh;\n        overflow-y: auto;\n        overflow-x: hidden;\n      }\n\n      /* 滚动条样式 - 设置弹窗 */\n      .map-app-settings-body::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-app-settings-body::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-app-settings-body::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 3px;\n      }\n\n      .map-app-settings-body::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      /* 应用设置项 */\n      .map-app-setting-item {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px 0;\n        border-bottom: 1px solid #2a2a2a;\n      }\n\n      .map-app-setting-item:last-child {\n        border-bottom: none;\n      }\n\n      .map-app-setting-label {\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n      }\n\n      .map-app-setting-label-text {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e5e5e5;\n        letter-spacing: -0.2px;\n      }\n\n      .map-app-setting-label-desc {\n        font-size: 13px;\n        color: #8e8e8e;\n        line-height: 1.4;\n      }\n\n      /* 主题切换开关 - 滑动开关设计 */\n      .map-theme-toggle {\n        position: relative;\n        width: 64px;\n        height: 32px;\n        background: #2a2a2a;\n        border-radius: 16px;\n        cursor: pointer;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        border: 2px solid #3a3a3a;\n        overflow: hidden;\n      }\n\n      .map-theme-toggle:hover {\n        border-color: #4a4a4a;\n      }\n\n      .map-theme-toggle.light {\n        background: #e5e5e5;\n        border-color: #d0d0d0;\n      }\n\n      .map-theme-toggle.light:hover {\n        border-color: #c0c0c0;\n      }\n\n      /* 滑动圆圈 */\n      .map-theme-toggle-circle {\n        position: absolute;\n        top: 2px;\n        left: 2px;\n        width: 24px;\n        height: 24px;\n        background: #fff;\n        border-radius: 50%;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);\n      }\n\n      .map-theme-toggle.light .map-theme-toggle-circle {\n        left: 34px;\n        background: #000;\n      }\n\n      /* 月亮/太阳图标 */\n      .map-theme-toggle-icon {\n        width: 16px;\n        height: 16px;\n        display: block;\n        flex-shrink: 0;\n      }\n\n      /* 暗色模式：月亮图标（填充） */\n      .map-theme-toggle-icon {\n        fill: #000;\n        stroke: none;\n      }\n\n      /* 亮色模式：太阳图标（描边） */\n      .map-theme-toggle.light .map-theme-toggle-icon {\n        fill: none;\n        stroke: #fff;\n        stroke-width: 2;\n        stroke-linecap: round;\n        stroke-linejoin: round;\n      }\n\n      /* ==================== 自定义头像管理 ==================== */\n      .map-app-setting-section {\n        padding: 24px 0 0;\n        border-top: 1px solid #2a2a2a;\n        margin-top: 16px;\n      }\n\n      .map-app-setting-section-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e5e5e5;\n        letter-spacing: -0.2px;\n        margin-bottom: 4px;\n      }\n\n      .map-app-setting-section-desc {\n        font-size: 13px;\n        color: #8e8e8e;\n        line-height: 1.4;\n        margin-bottom: 16px;\n      }\n\n      .map-avatar-add-form {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      .map-avatar-url-input {\n        width: 100%;\n        padding: 12px 16px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        color: #e5e5e5;\n        font-size: 14px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        transition: all 0.2s ease;\n        box-sizing: border-box;\n      }\n\n      .map-avatar-url-input:focus {\n        outline: none;\n        border-color: #4a4a4a;\n        background: #0f0f0f;\n      }\n\n      .map-avatar-url-input::placeholder {\n        color: #666;\n      }\n\n      .map-avatar-category-selector {\n        display: flex;\n        gap: 8px;\n      }\n\n      .map-avatar-category-option {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 10px 16px;\n        background: #0a0a0a;\n        border: 1.5px solid #2a2a2a;\n        border-radius: 10px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        position: relative;\n      }\n\n      .map-avatar-category-option:hover {\n        border-color: #3a3a3a;\n        background: #0f0f0f;\n      }\n\n      .map-avatar-category-option input[type="radio"] {\n        position: absolute;\n        opacity: 0;\n        pointer-events: none;\n      }\n\n      .map-avatar-category-option input[type="radio"]:checked + .map-avatar-category-label {\n        color: #000;\n      }\n\n      .map-avatar-category-option:has(input[type="radio"]:checked) {\n        background: #fff;\n        border-color: #fff;\n      }\n\n      .map-avatar-category-label {\n        font-size: 14px;\n        font-weight: 600;\n        color: #8e8e8e;\n        transition: color 0.2s ease;\n      }\n\n      .map-avatar-add-btn {\n        width: 100%;\n        padding: 12px;\n        background: #fff;\n        border: none;\n        border-radius: 10px;\n        color: #000;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-avatar-add-btn:hover {\n        background: #f0f0f0;\n        transform: translateY(-1px);\n      }\n\n      .map-avatar-add-btn:active {\n        background: #e0e0e0;\n        transform: translateY(0);\n      }\n\n      .map-avatar-list {\n        margin-top: 16px;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        max-height: 300px;\n        overflow-y: auto;\n      }\n\n      .map-avatar-list::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-avatar-list::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-avatar-list::-webkit-scrollbar-thumb {\n        background: #2a2a2a;\n        border-radius: 3px;\n      }\n\n      .map-avatar-list::-webkit-scrollbar-thumb:hover {\n        background: #3a3a3a;\n      }\n\n      .map-avatar-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 10px 12px;\n        background: #0a0a0a;\n        border: 1px solid #1a1a1a;\n        border-radius: 10px;\n        transition: all 0.2s ease;\n      }\n\n      .map-avatar-item:hover {\n        background: #0f0f0f;\n        border-color: #2a2a2a;\n      }\n\n      .map-avatar-thumb {\n        width: 40px;\n        height: 40px;\n        border-radius: 8px;\n        object-fit: cover;\n        border: 1px solid #2a2a2a;\n        flex-shrink: 0;\n      }\n\n      .map-avatar-info {\n        flex: 1;\n        min-width: 0;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n      }\n\n      .map-avatar-url {\n        font-size: 13px;\n        color: #8e8e8e;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .map-avatar-category-badge {\n        display: inline-block;\n        padding: 2px 8px;\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 6px;\n        font-size: 11px;\n        font-weight: 600;\n        color: #8e8e8e;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        width: fit-content;\n      }\n\n      .map-avatar-delete-btn {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: 1px solid #2a2a2a;\n        border-radius: 8px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n      }\n\n      .map-avatar-delete-btn:hover {\n        background: #1a1a1a;\n        border-color: #3a3a3a;\n      }\n\n      .map-avatar-delete-btn:active {\n        background: #0a0a0a;\n        transform: scale(0.95);\n      }\n\n      .map-avatar-delete-btn svg {\n        width: 16px;\n        height: 16px;\n        stroke: #e5e5e5;\n        fill: none;\n        stroke-width: 2;\n        stroke-linecap: round;\n      }\n\n      /* ==================== 地标管理 CSS ==================== */\n\n      .map-landmark-section {\n        margin-bottom: 32px;\n      }\n\n      .map-landmark-mode-toggle {\n        display: flex;\n        gap: 8px;\n        margin-bottom: 16px;\n      }\n\n      .map-landmark-mode-btn {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 10px 16px;\n        background: #0a0a0a;\n        border: 1.5px solid #2a2a2a;\n        border-radius: 10px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        font-size: 14px;\n        font-weight: 600;\n        color: #8e8e8e;\n      }\n\n      .map-landmark-mode-btn:hover {\n        border-color: #3a3a3a;\n        background: #0f0f0f;\n      }\n\n      .map-landmark-mode-btn.active {\n        background: #fff;\n        border-color: #fff;\n        color: #000;\n      }\n\n      .map-landmark-custom-form,\n      .map-landmark-ai-form {\n        display: none;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      .map-landmark-custom-form.active,\n      .map-landmark-ai-form.active {\n        display: flex;\n      }\n\n      .map-landmark-name-input,\n      .map-landmark-desc-input,\n      .map-landmark-ai-input {\n        width: 100%;\n        padding: 12px 16px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        color: #e5e5e5;\n        font-size: 14px;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        transition: all 0.2s ease;\n        box-sizing: border-box;\n      }\n\n      .map-landmark-desc-input,\n      .map-landmark-ai-input {\n        min-height: 80px;\n        resize: vertical;\n      }\n\n      .map-landmark-name-input:focus,\n      .map-landmark-desc-input:focus,\n      .map-landmark-ai-input:focus {\n        outline: none;\n        border-color: #4a4a4a;\n        background: #0f0f0f;\n      }\n\n      .map-landmark-name-input::placeholder,\n      .map-landmark-desc-input::placeholder,\n      .map-landmark-ai-input::placeholder {\n        color: #666;\n      }\n\n      .map-landmark-icon-color-row {\n        display: flex;\n        gap: 12px;\n      }\n\n      .map-landmark-icon-selector {\n        /* 平均分配空间，对称布局 */\n        flex: 1;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .map-landmark-icon-preview {\n        width: 40px;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 8px;\n        font-size: 20px;\n      }\n\n      .map-landmark-icon-input {\n        /* emoji只需要1-2个字符，固定宽度即可 */\n        width: 80px;\n        padding: 10px 14px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        color: #e5e5e5;\n        font-size: 14px;\n        text-align: center;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-icon-input:focus {\n        outline: none;\n        border-color: #4a4a4a;\n        background: #0f0f0f;\n      }\n\n      .map-landmark-color-picker-wrapper {\n        /* 平均分配空间，对称布局 */\n        flex: 1;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .map-landmark-color-preview {\n        width: 40px;\n        height: 40px;\n        border-radius: 8px;\n        border: 1px solid #2a2a2a;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-color-preview:hover {\n        transform: scale(1.05);\n        border-color: #4a4a4a;\n      }\n\n      .map-landmark-color-input {\n        /* 固定宽度100px，足够显示7个字符的颜色代码，不会溢出弹窗 */\n        width: 100px;\n        padding: 10px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        color: #e5e5e5;\n        font-size: 13px;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-color-input:focus {\n        outline: none;\n        border-color: #4a4a4a;\n        background: #0f0f0f;\n      }\n\n      .map-landmark-pick-position {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      .map-landmark-pick-btn {\n        width: 100%;\n        padding: 12px;\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        color: #e5e5e5;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n      }\n\n      .map-landmark-pick-btn:hover {\n        background: #2a2a2a;\n        border-color: #3a3a3a;\n      }\n\n      .map-landmark-pick-btn.active {\n        background: #fff;\n        color: #000;\n        border-color: #fff;\n      }\n\n      .map-landmark-position-display {\n        padding: 10px 14px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        font-size: 13px;\n        color: #8e8e8e;\n        text-align: center;\n      }\n\n      .map-landmark-position-display.has-position {\n        color: #e5e5e5;\n      }\n\n      .map-landmark-save-btn,\n      .map-landmark-generate-btn {\n        width: 100%;\n        padding: 12px;\n        background: #fff;\n        border: none;\n        border-radius: 10px;\n        color: #000;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-save-btn:hover,\n      .map-landmark-generate-btn:hover {\n        background: #f0f0f0;\n        transform: translateY(-1px);\n      }\n\n      .map-landmark-save-btn:active,\n      .map-landmark-generate-btn:active {\n        background: #e0e0e0;\n        transform: translateY(0);\n      }\n\n      .map-landmark-save-btn:disabled,\n      .map-landmark-generate-btn:disabled {\n        background: #2a2a2a;\n        color: #666;\n        cursor: not-allowed;\n        transform: none;\n      }\n\n      /* 地图选点模式提示条 */\n      .map-landmark-pick-hint {\n        position: fixed;\n        top: 80px;\n        left: 50%;\n        transform: translateX(-50%);\n        padding: 14px 28px;\n        background: rgba(0, 0, 0, 0.92);\n        backdrop-filter: blur(10px);\n        border-radius: 16px;\n        color: #fff;\n        font-size: 15px;\n        font-weight: 600;\n        z-index: 9999;\n        display: none;\n        align-items: center;\n        gap: 12px;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n        pointer-events: none;\n        animation: slideDown 0.3s ease;\n        white-space: nowrap;\n      }\n\n      @keyframes slideDown {\n        from {\n          opacity: 0;\n          transform: translateX(-50%) translateY(-20px);\n        }\n        to {\n          opacity: 1;\n          transform: translateX(-50%) translateY(0);\n        }\n      }\n\n      .map-landmark-pick-hint.active {\n        display: flex;\n      }\n\n      .map-landmark-cancel-btn {\n        padding: 6px 14px;\n        background: rgba(255, 255, 255, 0.12);\n        border: 1px solid rgba(255, 255, 255, 0.25);\n        border-radius: 10px;\n        color: #fff;\n        font-size: 13px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        pointer-events: auto;\n        flex-shrink: 0;\n      }\n\n      .map-landmark-cancel-btn:hover {\n        background: rgba(255, 255, 255, 0.2);\n        border-color: rgba(255, 255, 255, 0.5);\n      }\n\n      .map-landmark-cancel-btn:active {\n        transform: scale(0.95);\n      }\n\n      /* 地图选点模式：地图区域光标 */\n      .map-area.picking-landmark {\n        cursor: crosshair;\n      }\n\n      /* 地标列表 */\n      .map-landmark-list {\n        margin-top: 16px;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        max-height: 400px;\n        overflow-y: auto;\n      }\n\n      .map-landmark-list::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-landmark-list::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-landmark-list::-webkit-scrollbar-thumb {\n        background: #2a2a2a;\n        border-radius: 3px;\n      }\n\n      .map-landmark-list::-webkit-scrollbar-thumb:hover {\n        background: #3a3a3a;\n      }\n\n      .map-landmark-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px;\n        background: #0a0a0a;\n        border: 1px solid #1a1a1a;\n        border-radius: 10px;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-item:hover {\n        background: #0f0f0f;\n        border-color: #2a2a2a;\n      }\n\n      .map-landmark-item.selected {\n        background: #1a1a1a;\n        border-color: #3a3a3a;\n      }\n\n      .map-landmark-checkbox {\n        width: 20px;\n        height: 20px;\n        border: 2px solid #2a2a2a;\n        border-radius: 6px;\n        background: transparent;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .map-landmark-checkbox:hover {\n        border-color: #4a4a4a;\n      }\n\n      .map-landmark-checkbox.checked {\n        background: #fff;\n        border-color: #fff;\n      }\n\n      .map-landmark-checkbox.checked::after {\n        content: \'✓\';\n        color: #000;\n        font-size: 14px;\n        font-weight: bold;\n      }\n\n      .map-landmark-icon-display {\n        width: 44px;\n        height: 44px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 10px;\n        font-size: 24px;\n        flex-shrink: 0;\n        border: 1px solid #2a2a2a;\n      }\n\n      .map-landmark-info {\n        flex: 1;\n        min-width: 0;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n      }\n\n      .map-landmark-name {\n        font-size: 15px;\n        font-weight: 600;\n        color: #e5e5e5;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .map-landmark-desc {\n        font-size: 13px;\n        color: #8e8e8e;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        line-height: 1.3;\n      }\n\n      .map-landmark-position-badge {\n        display: inline-block;\n        padding: 2px 8px;\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 6px;\n        font-size: 11px;\n        font-weight: 600;\n        color: #8e8e8e;\n        letter-spacing: 0.3px;\n        width: fit-content;\n        margin-top: 2px;\n      }\n\n      .map-landmark-actions {\n        display: flex;\n        gap: 6px;\n        flex-shrink: 0;\n      }\n\n      .map-landmark-edit-btn,\n      .map-landmark-delete-btn {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: 1px solid #2a2a2a;\n        border-radius: 8px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n      }\n\n      .map-landmark-edit-btn:hover {\n        background: #1a1a1a;\n        border-color: #3a3a3a;\n      }\n\n      .map-landmark-delete-btn:hover {\n        background: #2a0000;\n        border-color: #5a0000;\n      }\n\n      .map-landmark-edit-btn:active,\n      .map-landmark-delete-btn:active {\n        transform: scale(0.95);\n      }\n\n      .map-landmark-edit-btn svg,\n      .map-landmark-delete-btn svg {\n        width: 16px;\n        height: 16px;\n        stroke: #e5e5e5;\n        fill: none;\n        stroke-width: 2;\n        stroke-linecap: round;\n      }\n\n      /* 批量操作栏 */\n      .map-landmark-batch-actions {\n        display: none;\n        align-items: center;\n        gap: 12px;\n        padding: 12px;\n        background: #0a0a0a;\n        border: 1px solid #2a2a2a;\n        border-radius: 10px;\n        margin-bottom: 12px;\n      }\n\n      .map-landmark-batch-actions.active {\n        display: flex;\n      }\n\n      .map-landmark-select-all-btn {\n        padding: 8px 14px;\n        background: #1a1a1a;\n        border: 1px solid #2a2a2a;\n        border-radius: 8px;\n        color: #e5e5e5;\n        font-size: 13px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-select-all-btn:hover {\n        background: #2a2a2a;\n        border-color: #3a3a3a;\n      }\n\n      .map-landmark-selected-count {\n        flex: 1;\n        font-size: 13px;\n        color: #8e8e8e;\n      }\n\n      .map-landmark-batch-delete-btn {\n        padding: 8px 16px;\n        background: #3a0000;\n        border: 1px solid #5a0000;\n        border-radius: 8px;\n        color: #ff6b6b;\n        font-size: 13px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-landmark-batch-delete-btn:hover {\n        background: #5a0000;\n        border-color: #7a0000;\n        color: #ff8888;\n      }\n\n      .map-landmark-batch-delete-btn:active {\n        transform: scale(0.97);\n      }\n\n      .map-landmark-batch-delete-btn:disabled {\n        background: #1a1a1a;\n        border-color: #2a2a2a;\n        color: #666;\n        cursor: not-allowed;\n      }\n\n      /* 亮色主题覆盖 */\n      #x-map-container.light-theme {\n        /* CSS变量会自动切换 */\n      }\n\n      #x-map-container.light-theme .map-app-settings-content {\n        background: #fff;\n        box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);\n      }\n\n      #x-map-container.light-theme .map-app-settings-header {\n        background: #fff;\n        border-bottom-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-app-settings-title {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-app-settings-close-btn svg {\n        stroke: #262626;\n      }\n\n      #x-map-container.light-theme .map-app-settings-close-btn:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-app-settings-close-btn:active {\n        background: rgba(0, 0, 0, 0.08);\n      }\n\n      #x-map-container.light-theme .map-app-settings-body {\n        background: #fff;\n      }\n\n      /* 滚动条样式 - 日间模式 */\n      #x-map-container.light-theme .map-app-settings-body::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-app-settings-body::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.25);\n      }\n\n      #x-map-container.light-theme .map-app-setting-item {\n        border-bottom-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-app-setting-label-text {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-app-setting-label-desc {\n        color: #8e8e8e;\n      }\n\n      /* 亮色主题：自定义头像管理 */\n      #x-map-container.light-theme .map-app-setting-section {\n        border-top-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-app-setting-section-title {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-avatar-url-input {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-avatar-url-input:focus {\n        border-color: #c0c0c0;\n        background: #efefef;\n      }\n\n      #x-map-container.light-theme .map-avatar-category-option {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-avatar-category-option:hover {\n        border-color: #c0c0c0;\n        background: #efefef;\n      }\n\n      #x-map-container.light-theme .map-avatar-category-option:has(input[type="radio"]:checked) {\n        background: #000;\n        border-color: #000;\n      }\n\n      #x-map-container.light-theme .map-avatar-category-option input[type="radio"]:checked + .map-avatar-category-label {\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-avatar-add-btn {\n        background: #000;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-avatar-add-btn:hover {\n        background: #262626;\n      }\n\n      #x-map-container.light-theme .map-avatar-add-btn:active {\n        background: #1a1a1a;\n      }\n\n      #x-map-container.light-theme .map-avatar-list::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-avatar-list::-webkit-scrollbar-thumb:hover {\n        background: #b0b0b0;\n      }\n\n      #x-map-container.light-theme .map-avatar-item {\n        background: #f5f5f5;\n        border-color: #e8e8e8;\n      }\n\n      #x-map-container.light-theme .map-avatar-item:hover {\n        background: #efefef;\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-avatar-thumb {\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-avatar-url {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-avatar-category-badge {\n        background: #e8e8e8;\n        border-color: #d0d0d0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-avatar-delete-btn {\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-avatar-delete-btn:hover {\n        background: #e8e8e8;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-avatar-delete-btn:active {\n        background: #d8d8d8;\n      }\n\n      #x-map-container.light-theme .map-avatar-delete-btn svg {\n        stroke: #262626;\n      }\n\n      /* ==================== 亮色主题：地标管理 ==================== */\n\n      #x-map-container.light-theme .map-landmark-mode-btn {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-landmark-mode-btn:hover {\n        border-color: #c0c0c0;\n        background: #efefef;\n      }\n\n      #x-map-container.light-theme .map-landmark-mode-btn.active {\n        background: #000;\n        border-color: #000;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-landmark-name-input,\n      #x-map-container.light-theme .map-landmark-desc-input,\n      #x-map-container.light-theme .map-landmark-ai-input {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-name-input:focus,\n      #x-map-container.light-theme .map-landmark-desc-input:focus,\n      #x-map-container.light-theme .map-landmark-ai-input:focus {\n        border-color: #c0c0c0;\n        background: #efefef;\n      }\n\n      #x-map-container.light-theme .map-landmark-name-input::placeholder,\n      #x-map-container.light-theme .map-landmark-desc-input::placeholder,\n      #x-map-container.light-theme .map-landmark-ai-input::placeholder {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-landmark-icon-preview {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-landmark-icon-input,\n      #x-map-container.light-theme .map-landmark-color-input {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-icon-input:focus,\n      #x-map-container.light-theme .map-landmark-color-input:focus {\n        border-color: #c0c0c0;\n        background: #efefef;\n      }\n\n      #x-map-container.light-theme .map-landmark-color-preview {\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-landmark-color-preview:hover {\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-btn {\n        background: #e8e8e8;\n        border-color: #d0d0d0;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-btn:hover {\n        background: #d8d8d8;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-btn.active {\n        background: #000;\n        color: #fff;\n        border-color: #000;\n      }\n\n      #x-map-container.light-theme .map-landmark-position-display {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-landmark-position-display.has-position {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-save-btn,\n      #x-map-container.light-theme .map-landmark-generate-btn {\n        background: #000;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-landmark-save-btn:hover,\n      #x-map-container.light-theme .map-landmark-generate-btn:hover {\n        background: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-save-btn:active,\n      #x-map-container.light-theme .map-landmark-generate-btn:active {\n        background: #1a1a1a;\n      }\n\n      #x-map-container.light-theme .map-landmark-save-btn:disabled,\n      #x-map-container.light-theme .map-landmark-generate-btn:disabled {\n        background: #d0d0d0;\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-overlay {\n        background: rgba(255, 255, 255, 0.7);\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-hint {\n        background: rgba(0, 0, 0, 0.9);\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-landmark-list::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-landmark-list::-webkit-scrollbar-thumb:hover {\n        background: #b0b0b0;\n      }\n\n      #x-map-container.light-theme .map-landmark-item {\n        background: #f5f5f5;\n        border-color: #e8e8e8;\n      }\n\n      #x-map-container.light-theme .map-landmark-item:hover {\n        background: #efefef;\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-landmark-item.selected {\n        background: #e8e8e8;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-landmark-checkbox {\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-landmark-checkbox:hover {\n        border-color: #b0b0b0;\n      }\n\n      #x-map-container.light-theme .map-landmark-checkbox.checked {\n        background: #000;\n        border-color: #000;\n      }\n\n      #x-map-container.light-theme .map-landmark-checkbox.checked::after {\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-landmark-icon-display {\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-landmark-name {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-desc {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-landmark-position-badge {\n        background: #e8e8e8;\n        border-color: #d0d0d0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-landmark-edit-btn,\n      #x-map-container.light-theme .map-landmark-delete-btn {\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-landmark-edit-btn:hover {\n        background: #e8e8e8;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-landmark-delete-btn:hover {\n        background: #ffe8e8;\n        border-color: #ffb0b0;\n      }\n\n      #x-map-container.light-theme .map-landmark-edit-btn:active,\n      #x-map-container.light-theme .map-landmark-delete-btn:active {\n        background: #d8d8d8;\n      }\n\n      #x-map-container.light-theme .map-landmark-edit-btn svg,\n      #x-map-container.light-theme .map-landmark-delete-btn svg {\n        stroke: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-batch-actions {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-landmark-select-all-btn {\n        background: #e8e8e8;\n        border-color: #d0d0d0;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-select-all-btn:hover {\n        background: #d8d8d8;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-landmark-selected-count {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-landmark-batch-delete-btn {\n        background: #ffe8e8;\n        border-color: #ffb0b0;\n        color: #c00000;\n      }\n\n      #x-map-container.light-theme .map-landmark-batch-delete-btn:hover {\n        background: #ffd0d0;\n        border-color: #ff8888;\n        color: #a00000;\n      }\n\n      #x-map-container.light-theme .map-landmark-batch-delete-btn:disabled {\n        background: #e8e8e8;\n        border-color: #d0d0d0;\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-landmark-pick-hint {\n        background: rgba(255, 255, 255, 0.95);\n        color: #262626;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n        border: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-landmark-cancel-btn {\n        background: rgba(0, 0, 0, 0.05);\n        border-color: rgba(0, 0, 0, 0.15);\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-landmark-cancel-btn:hover {\n        background: rgba(0, 0, 0, 0.1);\n        border-color: rgba(0, 0, 0, 0.25);\n      }\n\n      /* ==================== 咩三三城市报纸弹窗 - 电视机风格 ==================== */\n      /* 报纸遮罩 */\n      .map-newspaper-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 599;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-newspaper-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 报纸弹窗主容器 */\n      .map-newspaper-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: transparent;\n        z-index: 600;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);\n        padding: 20px;\n        box-sizing: border-box;\n      }\n\n      .map-newspaper-modal.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      /* 报纸容器 - 电视机风格异形设计 */\n      .newspaper-container {\n        width: 100%;\n        max-width: 720px;\n        background: #0a0a0a;\n        position: relative;\n        animation: tvTurnOn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\n        border-radius: 40px 40px 60px 60px;\n        overflow: visible;\n        box-shadow:\n          0 0 0 3px #fff,\n          0 0 0 8px #2a2a2a,\n          0 0 0 10px #fff,\n          0 20px 60px rgba(255, 255, 255, 0.15);\n        padding: 12px;\n      }\n\n      #x-map-container.light-theme .newspaper-container {\n        background: #fff;\n        box-shadow:\n          0 0 0 3px #000,\n          0 0 0 8px #e0e0e0,\n          0 0 0 10px #000,\n          0 20px 60px rgba(0, 0, 0, 0.3);\n      }\n\n      @keyframes tvTurnOn {\n        0% {\n          opacity: 0;\n          transform: scale(0.8, 0.001) translateY(-100px);\n        }\n        50% {\n          opacity: 1;\n          transform: scale(1.05, 0.02) translateY(0);\n        }\n        100% {\n          opacity: 1;\n          transform: scale(1, 1) translateY(0);\n        }\n      }\n\n      /* 电视机扫描线效果 */\n      .newspaper-scanline {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(\n          to bottom,\n          transparent 50%,\n          rgba(255, 255, 255, 0.02) 50%\n        );\n        background-size: 100% 4px;\n        pointer-events: none;\n        z-index: 999;\n        animation: scanlineMove 8s linear infinite;\n        border-radius: 40px 40px 60px 60px;\n      }\n\n      #x-map-container.light-theme .newspaper-scanline {\n        background: linear-gradient(\n          to bottom,\n          transparent 50%,\n          rgba(0, 0, 0, 0.03) 50%\n        );\n        background-size: 100% 4px;\n      }\n\n      @keyframes scanlineMove {\n        0% { transform: translateY(0); }\n        100% { transform: translateY(8px); }\n      }\n\n      /* 内容屏幕 */\n      .newspaper-screen {\n        background: #0a0a0a;\n        border-radius: 32px 32px 52px 52px;\n        overflow: hidden;\n        position: relative;\n      }\n\n      #x-map-container.light-theme .newspaper-screen {\n        background: #fff;\n      }\n\n      /* 浏览器风格顶栏 */\n      .newspaper-browser-bar {\n        background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);\n        border-bottom: 2px solid #fff;\n        padding: 8px 12px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      #x-map-container.light-theme .newspaper-browser-bar {\n        background: linear-gradient(180deg, #e8e8e8 0%, #d0d0d0 100%);\n        border-bottom-color: #000;\n      }\n\n      .newspaper-browser-dots {\n        display: flex;\n        gap: 6px;\n      }\n\n      .newspaper-dot {\n        width: 12px;\n        height: 12px;\n        border-radius: 50%;\n        border: 2px solid #fff;\n        transition: all 0.2s;\n      }\n\n      .newspaper-dot:hover {\n        transform: scale(1.2);\n      }\n\n      #x-map-container.light-theme .newspaper-dot {\n        border-color: #000;\n      }\n\n      .newspaper-dot:nth-child(1) { background: #3a3a3a; }\n      .newspaper-dot:nth-child(2) { background: #666; }\n      .newspaper-dot:nth-child(3) { background: #999; }\n\n      #x-map-container.light-theme .newspaper-dot:nth-child(1) { background: #f5f5f5; }\n      #x-map-container.light-theme .newspaper-dot:nth-child(2) { background: #b0b0b0; }\n      #x-map-container.light-theme .newspaper-dot:nth-child(3) { background: #808080; }\n\n      .newspaper-url-bar {\n        flex: 1;\n        background: #1a1a1a;\n        border: 2px solid #fff;\n        border-radius: 12px;\n        padding: 4px 12px;\n        font-family: "Courier New", monospace;\n        font-size: 11px;\n        font-weight: 700;\n        color: #fff;\n        box-shadow: inset 0 1px 3px rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-url-bar {\n        background: #fff;\n        border-color: #000;\n        color: #000;\n        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);\n      }\n\n      /* 关闭按钮 */\n      .newspaper-close-btn {\n        width: 28px;\n        height: 28px;\n        border: 2px solid #fff;\n        background: #1a1a1a;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.3s;\n        clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);\n      }\n\n      .newspaper-close-btn:hover {\n        transform: rotate(90deg);\n        background: #fff;\n        box-shadow: 0 0 0 2px #000;\n      }\n\n      .newspaper-close-btn:hover svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .newspaper-close-btn {\n        background: #fff;\n        border-color: #000;\n      }\n\n      #x-map-container.light-theme .newspaper-close-btn:hover {\n        background: #000;\n        box-shadow: 0 0 0 2px #fff;\n      }\n\n      #x-map-container.light-theme .newspaper-close-btn:hover svg {\n        stroke: #fff;\n      }\n\n      .newspaper-close-btn svg {\n        width: 14px;\n        height: 14px;\n        stroke: #fff;\n        stroke-width: 2.5;\n        transition: stroke 0.3s;\n      }\n\n      #x-map-container.light-theme .newspaper-close-btn svg {\n        stroke: #000;\n      }\n\n      /* 主内容区 - 博客风格双栏布局 */\n      .newspaper-content {\n        display: grid;\n        grid-template-columns: 1fr 200px;\n        gap: 12px;\n        padding: 12px;\n        max-height: 70vh;\n        overflow-y: auto;\n        scrollbar-width: thin;\n      }\n\n      .newspaper-content::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .newspaper-content::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .newspaper-content::-webkit-scrollbar-thumb {\n        background: #3a3a3a;\n        border-radius: 3px;\n      }\n\n      #x-map-container.light-theme .newspaper-content::-webkit-scrollbar-thumb {\n        background: #ccc;\n      }\n\n      /* 左侧主栏 */\n      .newspaper-main-column {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      }\n\n      /* 右侧边栏 */\n      .newspaper-sidebar {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n        position: sticky;\n        top: 0;\n        align-self: start;\n      }\n\n      /* 头像名片 - 异形设计 */\n      .newspaper-profile-card {\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px solid #fff;\n        padding: 12px;\n        position: relative;\n        clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%);\n        box-shadow: 2px 2px 0 rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-profile-card {\n        background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);\n        border-color: #000;\n        box-shadow: 2px 2px 0 rgba(0,0,0,0.1);\n      }\n\n      .newspaper-avatar-box {\n        position: relative;\n        width: 64px;\n        height: 64px;\n        margin: 0 auto 8px;\n      }\n\n      .newspaper-avatar {\n        width: 64px;\n        height: 64px;\n        border: 3px solid #fff;\n        background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 32px;\n        clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);\n        animation: avatarFloat 3s ease-in-out infinite;\n        box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-avatar {\n        border-color: #000;\n        background: linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%);\n        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);\n      }\n\n      @keyframes avatarFloat {\n        0%, 100% { transform: translateY(0); }\n        50% { transform: translateY(-6px); }\n      }\n\n      .newspaper-status-badge {\n        position: absolute;\n        bottom: -4px;\n        right: -4px;\n        background: #fff;\n        color: #000;\n        font-size: 9px;\n        font-weight: 700;\n        padding: 3px 7px;\n        border-radius: 8px;\n        border: 2px solid #0a0a0a;\n        letter-spacing: 0.5px;\n        box-shadow: 0 2px 4px rgba(255,255,255,0.3);\n      }\n\n      #x-map-container.light-theme .newspaper-status-badge {\n        background: #000;\n        color: #fff;\n        border-color: #fff;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n      }\n\n      .newspaper-profile-name {\n        font-family: "Courier New", monospace;\n        font-size: 16px;\n        font-weight: 900;\n        color: #fff;\n        text-align: center;\n        margin-bottom: 4px;\n        letter-spacing: 1px;\n        text-shadow: 1px 1px 0 rgba(255,255,255,0.05);\n      }\n\n      #x-map-container.light-theme .newspaper-profile-name {\n        color: #000;\n        text-shadow: 1px 1px 0 rgba(0,0,0,0.05);\n      }\n\n      .newspaper-profile-role {\n        font-size: 10px;\n        color: #999;\n        text-align: center;\n        line-height: 1.5;\n      }\n\n      #x-map-container.light-theme .newspaper-profile-role {\n        color: #666;\n      }\n\n      /* 像素风日期时钟 */\n      .newspaper-pixel-clock {\n        background: #fff;\n        color: #000;\n        padding: 10px;\n        font-family: "Courier New", monospace;\n        font-size: 11px;\n        text-align: center;\n        border: 2px solid #fff;\n        position: relative;\n        overflow: hidden;\n        box-shadow: inset 0 0 10px rgba(255,255,255,0.5);\n      }\n\n      #x-map-container.light-theme .newspaper-pixel-clock {\n        background: #000;\n        color: #fff;\n        border-color: #000;\n        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);\n      }\n\n      .newspaper-pixel-clock::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: -100%;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(90deg, transparent, rgba(0,0,0,0.3), transparent);\n        animation: pixelScan 3s infinite;\n      }\n\n      #x-map-container.light-theme .newspaper-pixel-clock::before {\n        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);\n      }\n\n      @keyframes pixelScan {\n        0% { left: -100%; }\n        100% { left: 100%; }\n      }\n\n      .newspaper-clock-date {\n        font-weight: 700;\n        margin-bottom: 2px;\n        letter-spacing: 1px;\n      }\n\n      .newspaper-clock-time {\n        font-size: 14px;\n        font-weight: 900;\n        letter-spacing: 2px;\n      }\n\n      /* 标签云 - 博客风格 */\n      .newspaper-tags-widget {\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px dashed #fff;\n        padding: 10px;\n        clip-path: polygon(0 10px, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);\n      }\n\n      #x-map-container.light-theme .newspaper-tags-widget {\n        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);\n        border-color: #000;\n      }\n\n      .newspaper-widget-title {\n        font-size: 11px;\n        font-weight: 900;\n        color: #fff;\n        margin-bottom: 8px;\n        letter-spacing: 1px;\n        text-transform: uppercase;\n      }\n\n      #x-map-container.light-theme .newspaper-widget-title {\n        color: #000;\n      }\n\n      .newspaper-tag-cloud {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 4px;\n      }\n\n      .newspaper-tag {\n        font-size: 10px;\n        color: #000;\n        background: #fff;\n        padding: 3px 9px;\n        border-radius: 10px;\n        font-weight: 700;\n        cursor: pointer;\n        transition: all 0.2s;\n        transform: rotate(calc(var(--random) * 1deg));\n        box-shadow: 1px 1px 2px rgba(255,255,255,0.2);\n      }\n\n      .newspaper-tag:hover {\n        transform: scale(1.15) rotate(0deg);\n        box-shadow: 2px 2px 4px rgba(255,255,255,0.3);\n      }\n\n      #x-map-container.light-theme .newspaper-tag {\n        background: #000;\n        color: #fff;\n        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);\n      }\n\n      #x-map-container.light-theme .newspaper-tag:hover {\n        box-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n      }\n\n      .newspaper-tag:nth-child(1) { --random: -3; }\n      .newspaper-tag:nth-child(2) { --random: 2; }\n      .newspaper-tag:nth-child(3) { --random: -1; }\n      .newspaper-tag:nth-child(4) { --random: 3; }\n      .newspaper-tag:nth-child(5) { --random: -2; }\n\n      /* 迷你统计卡片 */\n      .newspaper-stats-mini {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 4px;\n      }\n\n      .newspaper-stat-item {\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px solid #fff;\n        padding: 8px;\n        text-align: center;\n        clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);\n        transition: all 0.3s;\n        box-shadow: 1px 1px 0 rgba(255,255,255,0.1);\n      }\n\n      .newspaper-stat-item:hover {\n        transform: scale(1.05) rotate(-2deg);\n        box-shadow: 2px 2px 4px rgba(255,255,255,0.2);\n      }\n\n      #x-map-container.light-theme .newspaper-stat-item {\n        background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);\n        border-color: #000;\n        box-shadow: 1px 1px 0 rgba(0,0,0,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-stat-item:hover {\n        box-shadow: 2px 2px 4px rgba(0,0,0,0.2);\n      }\n\n      .newspaper-stat-value {\n        font-family: "Courier New", monospace;\n        font-size: 18px;\n        font-weight: 900;\n        color: #fff;\n        text-shadow: 1px 1px 0 rgba(255,255,255,0.05);\n      }\n\n      #x-map-container.light-theme .newspaper-stat-value {\n        color: #000;\n        text-shadow: 1px 1px 0 rgba(0,0,0,0.05);\n      }\n\n      .newspaper-stat-label {\n        font-size: 9px;\n        color: #999;\n        font-weight: 700;\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n        margin-top: 2px;\n      }\n\n      #x-map-container.light-theme .newspaper-stat-label {\n        color: #666;\n      }\n\n      /* 邮件通知 - 信封风格 */\n      .newspaper-mail-notice {\n        background: #1a1a1a;\n        border: 2px solid #fff;\n        padding: 10px;\n        position: relative;\n        transform: rotate(-2deg);\n        margin: 4px;\n        box-shadow: 3px 3px 0 rgba(255,255,255,0.15);\n      }\n\n      #x-map-container.light-theme .newspaper-mail-notice {\n        background: #fff;\n        border-color: #000;\n        box-shadow: 3px 3px 0 rgba(0,0,0,0.15);\n      }\n\n      .newspaper-mail-stamp {\n        position: absolute;\n        top: 4px;\n        right: 4px;\n        width: 26px;\n        height: 26px;\n        border: 2px dashed #fff;\n        border-radius: 4px;\n        font-size: 13px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: rgba(255,255,255,0.05);\n      }\n\n      #x-map-container.light-theme .newspaper-mail-stamp {\n        border-color: #000;\n        background: rgba(0,0,0,0.02);\n      }\n\n      .newspaper-mail-content {\n        font-size: 10px;\n        color: #fff;\n        line-height: 1.6;\n        font-family: "Courier New", monospace;\n        font-weight: 600;\n      }\n\n      #x-map-container.light-theme .newspaper-mail-content {\n        color: #000;\n      }\n\n      /* 天气预报 - 异形卡片 */\n      .newspaper-weather-card {\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px solid #fff;\n        padding: 14px;\n        clip-path: polygon(0 0, 100% 0, 100% calc(100% - 16px), calc(100% - 16px) 100%, 0 100%);\n        position: relative;\n        box-shadow: 2px 2px 0 rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-weather-card {\n        background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);\n        border-color: #000;\n        box-shadow: 2px 2px 0 rgba(0,0,0,0.1);\n      }\n\n      .newspaper-weather-icon-big {\n        font-size: 52px;\n        text-align: center;\n        margin-bottom: 10px;\n        animation: weatherBounce 2s ease-in-out infinite;\n        filter: drop-shadow(2px 2px 4px rgba(255,255,255,0.2));\n      }\n\n      #x-map-container.light-theme .newspaper-weather-icon-big {\n        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));\n      }\n\n      @keyframes weatherBounce {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.08); }\n      }\n\n      .newspaper-weather-temp-big {\n        font-family: "Courier New", monospace;\n        font-size: 36px;\n        font-weight: 900;\n        color: #fff;\n        text-align: center;\n        margin-bottom: 6px;\n        text-shadow: 2px 2px 0 rgba(255,255,255,0.05);\n      }\n\n      #x-map-container.light-theme .newspaper-weather-temp-big {\n        color: #000;\n        text-shadow: 2px 2px 0 rgba(0,0,0,0.05);\n      }\n\n      .newspaper-weather-desc-big {\n        font-size: 12px;\n        color: #999;\n        text-align: center;\n        font-weight: 700;\n        letter-spacing: 1px;\n      }\n\n      #x-map-container.light-theme .newspaper-weather-desc-big {\n        color: #666;\n      }\n\n      /* 重大新闻 - 报纸风格 */\n      .newspaper-news-card {\n        background: #0a0a0a;\n        border: 3px double #fff;\n        padding: 16px;\n        clip-path: polygon(0 8px, 8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%);\n        position: relative;\n        box-shadow: 3px 3px 0 rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-news-card {\n        background: #fff;\n        border-color: #000;\n        box-shadow: 3px 3px 0 rgba(0,0,0,0.1);\n      }\n\n      .newspaper-breaking-badge {\n        position: absolute;\n        top: -12px;\n        left: 14px;\n        background: #fff;\n        color: #000;\n        font-size: 10px;\n        font-weight: 900;\n        padding: 5px 14px;\n        letter-spacing: 2px;\n        clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);\n        box-shadow: 0 2px 4px rgba(255,255,255,0.3);\n      }\n\n      #x-map-container.light-theme .newspaper-breaking-badge {\n        background: #000;\n        color: #fff;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n      }\n\n      .newspaper-news-headline {\n        font-family: Georgia, "Times New Roman", serif;\n        font-size: 20px;\n        font-weight: 900;\n        color: #fff;\n        line-height: 1.3;\n        margin-bottom: 10px;\n      }\n\n      #x-map-container.light-theme .newspaper-news-headline {\n        color: #000;\n      }\n\n      .newspaper-news-meta {\n        font-size: 11px;\n        color: #666;\n        margin-bottom: 10px;\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        font-family: "Courier New", monospace;\n      }\n\n      #x-map-container.light-theme .newspaper-news-meta {\n        color: #999;\n      }\n\n      .newspaper-news-body {\n        font-size: 13px;\n        line-height: 1.7;\n        color: #ccc;\n      }\n\n      #x-map-container.light-theme .newspaper-news-body {\n        color: #333;\n      }\n\n      .newspaper-emoticon-comment {\n        font-family: "Courier New", monospace;\n        font-size: 12px;\n        color: #999;\n        font-style: italic;\n        margin-top: 10px;\n        padding: 8px 10px;\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border-left: 3px solid #fff;\n        box-shadow: inset 1px 1px 2px rgba(255,255,255,0.05);\n      }\n\n      #x-map-container.light-theme .newspaper-emoticon-comment {\n        color: #666;\n        background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);\n        border-left-color: #000;\n        box-shadow: inset 1px 1px 2px rgba(0,0,0,0.05);\n      }\n\n      /* 群众投稿 - 便签纸风格 */\n      .newspaper-submission-sticky {\n        border: none;\n        padding: 12px;\n        box-shadow: 4px 4px 10px rgba(0,0,0,0.5);\n        transform: rotate(calc(var(--rotate) * 1deg));\n        margin: 10px 4px;\n        position: relative;\n      }\n\n      .newspaper-submission-sticky::before {\n        content: \'\';\n        position: absolute;\n        top: 0;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 45px;\n        height: 14px;\n        background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.08) 100%);\n        border-radius: 0 0 8px 8px;\n      }\n\n      #x-map-container.light-theme .newspaper-submission-sticky::before {\n        background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.05) 100%);\n      }\n\n      .newspaper-submission-sticky:nth-child(1) {\n        --rotate: -2;\n        background: linear-gradient(135deg, #1a1a1a 0%, #141414 100%);\n      }\n      .newspaper-submission-sticky:nth-child(2) {\n        --rotate: 1;\n        background: linear-gradient(135deg, #1f1f1f 0%, #181818 100%);\n      }\n      .newspaper-submission-sticky:nth-child(3) {\n        --rotate: -1;\n        background: linear-gradient(135deg, #252525 0%, #1c1c1c 100%);\n      }\n      .newspaper-submission-sticky:nth-child(4) {\n        --rotate: 0.5;\n        background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);\n      }\n\n      #x-map-container.light-theme .newspaper-submission-sticky:nth-child(1) {\n        background: linear-gradient(135deg, #fff 0%, #fafafa 100%);\n      }\n      #x-map-container.light-theme .newspaper-submission-sticky:nth-child(2) {\n        background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);\n      }\n      #x-map-container.light-theme .newspaper-submission-sticky:nth-child(3) {\n        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);\n      }\n      #x-map-container.light-theme .newspaper-submission-sticky:nth-child(4) {\n        background: linear-gradient(135deg, #fcfcfc 0%, #f8f8f8 100%);\n      }\n\n      .newspaper-sticky-tag {\n        font-size: 9px;\n        font-weight: 900;\n        color: #000;\n        background: #fff;\n        padding: 3px 10px;\n        border-radius: 10px;\n        display: inline-block;\n        margin-bottom: 8px;\n        letter-spacing: 1px;\n        box-shadow: 1px 1px 2px rgba(255,255,255,0.2);\n      }\n\n      #x-map-container.light-theme .newspaper-sticky-tag {\n        background: #000;\n        color: #fff;\n        box-shadow: 1px 1px 2px rgba(0,0,0,0.2);\n      }\n\n      .newspaper-sticky-title {\n        font-weight: 700;\n        font-size: 13px;\n        color: #fff;\n        margin-bottom: 8px;\n      }\n\n      #x-map-container.light-theme .newspaper-sticky-title {\n        color: #000;\n      }\n\n      .newspaper-sticky-content {\n        font-size: 11px;\n        color: #999;\n        line-height: 1.6;\n      }\n\n      #x-map-container.light-theme .newspaper-sticky-content {\n        color: #666;\n      }\n\n      /* 广告横幅 - 异形 */\n      .newspaper-ad-banner-special {\n        background: linear-gradient(45deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px solid #fff;\n        padding: 14px;\n        clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));\n        position: relative;\n        overflow: hidden;\n        margin: 10px 0;\n        box-shadow: 2px 2px 0 rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-ad-banner-special {\n        background: linear-gradient(45deg, #f5f5f5 0%, #e8e8e8 100%);\n        border-color: #000;\n        box-shadow: 2px 2px 0 rgba(0,0,0,0.1);\n      }\n\n      .newspaper-ad-corner {\n        position: absolute;\n        top: 6px;\n        right: 6px;\n        font-size: 9px;\n        font-weight: 900;\n        color: #666;\n        letter-spacing: 1px;\n        transform: rotate(45deg);\n        opacity: 0.5;\n      }\n\n      #x-map-container.light-theme .newspaper-ad-corner {\n        color: #999;\n      }\n\n      .newspaper-ad-title {\n        font-weight: 900;\n        font-size: 15px;\n        color: #fff;\n        margin-bottom: 8px;\n        font-family: Georgia, serif;\n      }\n\n      #x-map-container.light-theme .newspaper-ad-title {\n        color: #000;\n      }\n\n      .newspaper-ad-text {\n        font-size: 11px;\n        color: #999;\n        line-height: 1.6;\n      }\n\n      #x-map-container.light-theme .newspaper-ad-text {\n        color: #666;\n      }\n\n      /* 联系方式 - 像素风 */\n      .newspaper-contact-pixel {\n        background: #fff;\n        color: #000;\n        padding: 12px;\n        font-family: "Courier New", monospace;\n        font-size: 10px;\n        border: 2px solid #fff;\n        image-rendering: pixelated;\n        box-shadow: inset 0 0 10px rgba(255,255,255,0.5);\n      }\n\n      #x-map-container.light-theme .newspaper-contact-pixel {\n        background: #000;\n        color: #fff;\n        border-color: #000;\n        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);\n      }\n\n      .newspaper-contact-line {\n        margin-bottom: 5px;\n        letter-spacing: 1px;\n        font-weight: 700;\n      }\n\n      .newspaper-contact-line:last-child {\n        margin-bottom: 0;\n      }\n\n      /* 装饰星星 */\n      .newspaper-star-deco {\n        position: absolute;\n        font-size: 14px;\n        animation: starTwinkle 2s ease-in-out infinite;\n        filter: drop-shadow(0 0 3px currentColor);\n      }\n\n      @keyframes starTwinkle {\n        0%, 100% { opacity: 0.4; transform: scale(1) rotate(0deg); }\n        50% { opacity: 1; transform: scale(1.3) rotate(180deg); }\n      }\n\n      .newspaper-star-deco:nth-child(1) { top: 5%; left: 5%; animation-delay: 0s; color: #fff; }\n      .newspaper-star-deco:nth-child(2) { top: 15%; right: 8%; animation-delay: 0.5s; color: #fff; }\n      .newspaper-star-deco:nth-child(3) { top: 60%; left: 3%; animation-delay: 1s; color: #fff; }\n      .newspaper-star-deco:nth-child(4) { bottom: 20%; right: 5%; animation-delay: 1.5s; color: #fff; }\n\n      #x-map-container.light-theme .newspaper-star-deco {\n        color: #000;\n      }\n\n      /* 对话框装饰 */\n      .newspaper-speech-bubble {\n        position: relative;\n        background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);\n        border: 2px solid #fff;\n        padding: 10px;\n        border-radius: 12px;\n        margin: 10px 0;\n        font-size: 11px;\n        color: #fff;\n        box-shadow: 2px 2px 0 rgba(255,255,255,0.1);\n      }\n\n      #x-map-container.light-theme .newspaper-speech-bubble {\n        background: linear-gradient(135deg, #fff 0%, #f8f8f8 100%);\n        border-color: #000;\n        color: #000;\n        box-shadow: 2px 2px 0 rgba(0,0,0,0.1);\n      }\n\n      .newspaper-speech-bubble::after {\n        content: \'\';\n        position: absolute;\n        bottom: -12px;\n        left: 22px;\n        width: 0;\n        height: 0;\n        border-left: 10px solid transparent;\n        border-right: 10px solid transparent;\n        border-top: 12px solid #fff;\n      }\n\n      #x-map-container.light-theme .newspaper-speech-bubble::after {\n        border-top-color: #000;\n      }\n\n      /* 像素装饰点 */\n      .newspaper-pixel-dots {\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        top: 0;\n        left: 0;\n        pointer-events: none;\n        z-index: 1;\n      }\n\n      .newspaper-pixel-dot {\n        position: absolute;\n        width: 3px;\n        height: 3px;\n        background: #fff;\n        opacity: 0.15;\n        image-rendering: pixelated;\n      }\n\n      #x-map-container.light-theme .newspaper-pixel-dot {\n        background: #000;\n        opacity: 0.1;\n      }\n\n      /* 底部签名 */\n      .newspaper-footer-sig {\n        text-align: center;\n        font-size: 11px;\n        color: #666;\n        font-style: italic;\n        padding: 14px;\n        margin-top: 10px;\n        border-top: 2px dashed #333;\n        font-family: "Courier New", monospace;\n      }\n\n      #x-map-container.light-theme .newspaper-footer-sig {\n        border-top-color: #e0e0e0;\n        color: #999;\n      }\n\n      /* 移动端适配 */\n      @media (max-width: 768px) {\n        .newspaper-content {\n          grid-template-columns: 1fr;\n          gap: 10px;\n          padding: 10px;\n        }\n\n        .newspaper-sidebar {\n          position: static;\n          order: -1;\n        }\n\n        .newspaper-profile-card,\n        .newspaper-tags-widget,\n        .newspaper-mail-notice {\n          transform: rotate(0);\n        }\n\n        .newspaper-submission-sticky {\n          transform: rotate(0);\n          margin: 8px 0;\n        }\n      }\n\n    /* ==================== 亮色主题：提醒功能 - Toast风格 ==================== */\n      #x-map-container.light-theme .map-notifications-badge {\n        background: #000;\n      }\n        \n      #x-map-container.light-theme .map-notifications-content {\n        background: #fff;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-notifications-header {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-notifications-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notifications-close-btn {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .map-notifications-close-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .map-notifications-close-btn:hover {\n        background: #e8e8e8;\n      }\n\n      #x-map-container.light-theme .map-notifications-close-btn:active {\n        background: #d8d8d8;\n      }\n\n      /* 统计卡片 - 亮色 */\n      #x-map-container.light-theme .map-notifications-stats {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .map-notifications-stats-icon {\n        background: #000;\n      }\n\n      #x-map-container.light-theme .map-notifications-stats-icon svg {\n        stroke: #fff;\n      }\n\n      #x-map-container.light-theme .map-notifications-stats-label {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notifications-stats-count {\n        color: #000;\n      }\n\n      /* 分类Tabs - 亮色 */\n      #x-map-container.light-theme .map-notifications-tab {\n        border-color: #e0e0e0;\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-notifications-tab.active {\n        background: #000;\n        border-color: #000;\n        color: #fff;\n      }\n\n      /* 列表容器 - 亮色 */\n      #x-map-container.light-theme .map-notifications-list-container {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-notifications-list-container::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-notifications-list-container::-webkit-scrollbar-thumb:hover {\n        background: #b0b0b0;\n      }\n\n      /* 通知项 - 亮色 Toast风格 */\n      #x-map-container.light-theme .map-notification-item {\n        background: #fafafa;\n        border-color: #e8e8e8;\n      }\n\n      #x-map-container.light-theme .map-notification-item:hover {\n        background: #f5f5f5;\n        border-color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-notification-item:active {\n        background: #fafafa;\n      }\n\n      /* 未读标识 - 亮色 */\n      #x-map-container.light-theme .map-notification-item.unread {\n        border-left-color: #000;\n      }\n\n      /* 通知图标 - 亮色 */\n      #x-map-container.light-theme .map-notification-icon {\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .map-notification-icon svg {\n        stroke: #000;\n      }\n\n      /* 通知文本 - 亮色 */\n      #x-map-container.light-theme .map-notification-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notification-time {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-notification-content {\n        color: #666;\n      }\n\n      /* 空状态 - 亮色 */\n      #x-map-container.light-theme .map-notifications-empty {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-notifications-empty-icon {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .map-notifications-empty-icon svg {\n        stroke: #ccc;\n      }\n\n      #x-map-container.light-theme .map-notifications-empty-text {\n        color: #999;\n      }\n\n      /* ==================== 亮色主题：接收私信确认弹窗 ==================== */\n      #x-map-container.light-theme .map-accept-message-content {\n        background: #fff;\n        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-accept-message-header {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-accept-message-avatar {\n        border-color: #dbdbdb;\n      }\n\n      #x-map-container.light-theme .map-accept-message-user-info h3 {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-accept-message-text {\n        background: #f5f5f5;\n        color: #262626;\n        border-color: #ebebeb;\n      }\n\n      #x-map-container.light-theme .map-accept-message-text::-webkit-scrollbar-thumb {\n        background: #dbdbdb;\n      }\n\n      #x-map-container.light-theme .map-accept-message-actions {\n        background: #fff;\n        border-top-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-accept-btn {\n        background: #000;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-accept-btn:hover {\n        background: #1a1a1a;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);\n      }\n\n      #x-map-container.light-theme .map-accept-btn:active {\n        background: #0a0a0a;\n      }\n\n      #x-map-container.light-theme .map-decline-btn {\n        background: #fff;\n        color: #262626;\n        border-color: #dbdbdb;\n      }\n\n      #x-map-container.light-theme .map-decline-btn:hover {\n        background: #f5f5f5;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-decline-btn:active {\n        background: #ebebeb;\n      }\n\n      /* ==================== 亮色主题：举报弹窗 ==================== */\n      #x-map-container.light-theme .map-report-content {\n        background: #fff;\n        box-shadow: 0 16px 56px rgba(0, 0, 0, 0.25);\n      }\n\n      #x-map-container.light-theme .map-report-header {\n        background: #fff;\n        border-bottom-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-report-title {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-close-btn:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-report-close-btn:hover svg {\n        stroke: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-close-btn:active {\n        background: rgba(0, 0, 0, 0.08);\n      }\n\n      #x-map-container.light-theme .map-report-body {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-report-body::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-report-body::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.25);\n      }\n\n      #x-map-container.light-theme .map-report-user-info {\n        background: #f9f9f9;\n        border-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-report-user-avatar {\n        border-color: #dbdbdb;\n      }\n\n      #x-map-container.light-theme .map-report-user-details h4 {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-section-label {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item {\n        background: #f9f9f9;\n        border-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item:hover {\n        background: #f5f5f5;\n        border-color: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item input[type="checkbox"] {\n        background: #fff;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item input[type="checkbox"]:checked {\n        background: #000;\n        border-color: #000;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item input[type="checkbox"]:checked::after {\n        border-color: #fff;\n      }\n\n      #x-map-container.light-theme .map-report-reason-item input[type="checkbox"]:hover {\n        border-color: #8e8e8e;\n      }\n\n      #x-map-container.light-theme .map-report-reason-text {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-textarea {\n        background: #f9f9f9;\n        border-color: #efefef;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-report-textarea::placeholder {\n        color: #8e8e8e;\n      }\n\n      #x-map-container.light-theme .map-report-textarea:focus {\n        border-color: #e0e0e0;\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .map-report-textarea::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-report-actions {\n        background: #fff;\n        border-top-color: #efefef;\n      }\n\n      #x-map-container.light-theme .map-report-cancel-btn {\n        background: #fff;\n        color: #262626;\n        border-color: #dbdbdb;\n      }\n\n      #x-map-container.light-theme .map-report-cancel-btn:hover {\n        background: #f5f5f5;\n        border-color: #c0c0c0;\n      }\n\n      #x-map-container.light-theme .map-report-cancel-btn:active {\n        background: #ebebeb;\n      }\n\n      #x-map-container.light-theme .map-report-submit-btn {\n        background: #000;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-report-submit-btn:hover {\n        background: #1a1a1a;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-report-submit-btn:active {\n        background: #0a0a0a;\n      }\n\n      #x-map-container.light-theme .map-report-submit-btn:disabled {\n        background: #dbdbdb;\n        color: #8e8e8e;\n      }\n\n      /* ==================== 亮色主题：侧边栏 ==================== */\n      #x-map-container.light-theme .map-sidebar {\n        box-shadow: 2px 0 8px rgba(0,0,0,0.15);\n      }\n\n      #x-map-container.light-theme .map-user-list::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-user-list::-webkit-scrollbar-thumb:hover {\n        background: #b0b0b0;\n      }\n\n      /* 亮色主题下的按钮颜色调整 */\n      #x-map-container.light-theme .map-app-settings-btn svg,\n      #x-map-container.light-theme .map-notifications-btn svg,\n      #x-map-container.light-theme .map-newspaper-btn svg,\n      #x-map-container.light-theme .map-ride-btn svg,\n      #x-map-container.light-theme .map-chats-btn svg,\n      #x-map-container.light-theme .map-close-btn svg {\n        stroke: #000;\n        filter: drop-shadow(0 1px 3px rgba(255,255,255,0.6));\n      }\n\n      #x-map-container.light-theme .map-refresh-btn svg {\n        fill: #000;\n        filter: drop-shadow(0 1px 3px rgba(255,255,255,0.6));\n      }\n\n      #x-map-container.light-theme .map-notifications-badge {\n        background: #fff;\n        color: #000;\n        border: 2px solid rgba(255, 255, 255, 0.8);\n      }\n\n      /* ==================== 亮色主题：地图控制和标记 ==================== */\n      #x-map-container.light-theme .map-control-btn {\n        background: #fff;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      }\n\n      #x-map-container.light-theme .map-control-btn:active {\n        background: #e8e8e8;\n      }\n\n      #x-map-container.light-theme .map-control-btn svg {\n        fill: #000;\n      }\n\n      #x-map-container.light-theme .map-weather-info {\n        background: #fff;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      }\n\n      #x-map-container.light-theme .landmark-label {\n        background: rgba(0, 0, 0, 0.15);\n        color: #000;\n        border: 1px solid rgba(0, 0, 0, 0.3);\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15),\n                    0 2px 8px rgba(0, 0, 0, 0.1),\n                    inset 0 1px 0 rgba(0, 0, 0, 0.1),\n                    inset 0 -1px 0 rgba(255, 255, 255, 0.3);\n      }\n\n      #x-map-container.light-theme .landmark-label::after {\n        border-top: 5px solid rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .marker-status-bubble {\n        background: #fff;\n        color: #000;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      }\n\n      #x-map-container.light-theme .marker-status-bubble::after {\n        border-top: 5px solid #fff;\n      }\n\n      #x-map-container.light-theme .map-swipe-hint {\n        background: rgba(255,255,255,0.9);\n        color: #000;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n      }\n\n      #x-map-container.light-theme .marker-avatar {\n        border: 3px solid #000;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 -2px 4px rgba(0,0,0,0.1);\n      }\n\n      #x-map-container.light-theme .map-marker:hover .marker-avatar {\n        box-shadow: 0 6px 20px rgba(29,155,240,0.6), inset 0 -2px 4px rgba(0,0,0,0.1);\n      }\n\n      #x-map-container.light-theme .marker-container::after {\n        background: radial-gradient(ellipse at center, rgba(0,0,0,0.15) 0%, transparent 70%);\n      }\n\n      /* ==================== 亮色主题：用户详情卡片 ==================== */\n      #x-map-container.light-theme .map-user-detail-card {\n        background: #fff;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n      }\n\n      #x-map-container.light-theme .card-header {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .card-back-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .card-header-nickname {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-action-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .card-avatar-section {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .card-avatar {\n        border: 3px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .card-avatar-bubble {\n        background: #a0a0a0;\n      }\n\n      #x-map-container.light-theme .card-user-info {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-handle {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .card-stat-item::after {\n        background: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .card-stat-value {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-stat-label {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .card-btn-message {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-btn-message:hover {\n        background: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .card-btn-secondary {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-btn-secondary:hover {\n        background: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .card-bio-section {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .card-bio {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-tag {\n        background: #f0f0f0;\n        color: #000;\n        border: 1px solid #d0d0d0;\n      }\n\n      #x-map-container.light-theme .card-distance-info {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .card-distance-info svg {\n        stroke: #666;\n      }\n\n      /* ==================== 亮色主题：评价/留言区 ==================== */\n      #x-map-container.light-theme .card-reviews-section {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .reviews-header {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .reviews-back-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .reviews-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .reviews-summary {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .reviews-rating-number {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .reviews-rating-max {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .reviews-count {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .review-item {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .review-name {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .review-rating {\n        background: #e0e0e0;\n      }\n\n      #x-map-container.light-theme .review-time {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .review-content {\n        color: #333;\n      }\n\n      #x-map-container.light-theme .review-reply-icon {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .review-reply-label {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .review-reply-content {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .review-action-btn {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .reviews-empty-text {\n        color: #999;\n      }\n\n      /* ==================== 亮色主题：地图设置弹窗 ==================== */\n      #x-map-container.light-theme .map-settings-modal {\n        background: rgba(0, 0, 0, 0.4);\n      }\n\n      #x-map-container.light-theme .map-settings-content {\n        background: #fff;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-settings-header {\n        background: #fff;\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-settings-back-btn:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-settings-back-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .map-settings-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-settings-body::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      #x-map-container.light-theme .map-settings-section-title {\n        color: rgba(0, 0, 0, 0.6);\n      }\n\n      #x-map-container.light-theme .map-settings-item {\n        border-bottom: 1px solid rgba(0, 0, 0, 0.1);\n      }\n\n      #x-map-container.light-theme .map-settings-item-label {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-settings-item-desc {\n        color: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-settings-toggle-label {\n        background: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-settings-toggle-label::after {\n        background: #000;\n      }\n\n      #x-map-container.light-theme .map-settings-input {\n        background: rgba(0, 0, 0, 0.05);\n        border: 1px solid rgba(0, 0, 0, 0.15);\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-settings-input::placeholder {\n        color: rgba(0, 0, 0, 0.4);\n      }\n\n      #x-map-container.light-theme .map-settings-input:focus {\n        background: rgba(0, 0, 0, 0.08);\n      }\n\n      #x-map-container.light-theme .map-settings-tags-container {\n        background: rgba(0, 0, 0, 0.03);\n      }\n\n      #x-map-container.light-theme .map-settings-add-tag-btn {\n        background: rgba(0, 0, 0, 0.05);\n        border: 1px dashed rgba(0, 0, 0, 0.25);\n        color: rgba(0, 0, 0, 0.7);\n      }\n\n      #x-map-container.light-theme .map-settings-add-tag-btn:hover {\n        background: rgba(0, 0, 0, 0.08);\n        border-color: rgba(0, 0, 0, 0.4);\n        color: #000;\n      }\n\n      /* ==================== 亮色主题：社交圈弹窗 ==================== */\n      #x-map-container.light-theme .map-social-circle-modal {\n        background: rgba(0, 0, 0, 0.4);\n      }\n\n      #x-map-container.light-theme .map-social-circle-content {\n        background: #fff;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-social-circle-header {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-social-circle-back-btn {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-social-circle-back-btn:hover {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      #x-map-container.light-theme .map-social-circle-back-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .map-social-circle-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-social-circle-body::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      #x-map-container.light-theme .map-social-circle-empty svg {\n        color: rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-social-circle-empty-text {\n        color: rgba(0, 0, 0, 0.8);\n      }\n\n      #x-map-container.light-theme .map-social-circle-empty-desc {\n        color: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-card {\n        background: rgba(0, 0, 0, 0.03);\n        border: 1px solid rgba(0, 0, 0, 0.1);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-card:hover {\n        background: rgba(0, 0, 0, 0.05);\n        border-color: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-name {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-handle {\n        color: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-relationship {\n        background: rgba(0, 0, 0, 0.08);\n        color: rgba(0, 0, 0, 0.8);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-bio {\n        color: rgba(0, 0, 0, 0.7);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-stat {\n        color: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-social-circle-friend-stat-value {\n        color: rgba(0, 0, 0, 0.8);\n      }\n\n      /* ==================== 亮色主题：聊天弹窗 ==================== */\n      #x-map-container.light-theme .map-chat-modal {\n        background: #fff;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-chat-header {\n        background: #fff;\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-chat-back-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-user-name {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-more-btn svg {\n        fill: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-more-menu {\n        background: #fff;\n        border: 1px solid #e0e0e0;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);\n      }\n\n      #x-map-container.light-theme .map-chat-more-menu-item {\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-chat-more-menu-item:hover {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .map-chat-messages {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-chat-messages::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-chat-timestamp {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-chat-message-row.received .map-chat-bubble {\n        background: #fff;\n        border: 1px solid #000;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-message-row.sent .map-chat-bubble {\n        background: #e0e0e0;\n        color: #000;\n      }\n\n      /* 表情包样式 - light theme（保持一致，无需额外样式） */\n\n      /* 🚨 系统消息 - light theme */\n      #x-map-container.light-theme .map-chat-system-message {\n        background: rgba(0, 0, 0, 0.03);\n        border: 1px solid rgba(0, 0, 0, 0.1);\n        border-left-color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-system-message-icon {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-system-message-text {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-chat-footer {\n        background: #fff;\n        border-top: 1px solid #e0e0e0;\n      }\n\n      /* 删除模式工具栏 - 亮色主题适配 */\n      #x-map-container.light-theme .map-chat-delete-toolbar {\n        background: #fff;\n        border-top: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-checkbox-wrapper span {\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn {\n        background: #f5f5f5;\n        color: #262626;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn:hover:not(:disabled) {\n        background: #e5e5e5;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn:disabled {\n        opacity: 0.4;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn.danger {\n        background: #dc3545;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn.danger:hover {\n        background: #c82333;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn.exit {\n        background: #28a745;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .map-chat-delete-btn.exit:hover {\n        background: #218838;\n      }\n\n      /* 删除模式下消息气泡 - 亮色主题适配 */\n      #x-map-container.light-theme .map-chat-bubble.delete-mode {\n        cursor: pointer;\n      }\n\n      #x-map-container.light-theme .map-chat-bubble.delete-mode.selected {\n        border: 2px solid #4a9eff;\n        background: rgba(74, 158, 255, 0.12) !important;\n        box-shadow: 0 0 0 4px rgba(74, 158, 255, 0.08);\n      }\n\n      #x-map-container.light-theme .map-chat-add-btn svg {\n        stroke: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-add-btn:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-chat-input {\n        background: #f5f5f5;\n        border: 1px solid #d0d0d0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-input:focus {\n        border-color: #aaa;\n      }\n\n      #x-map-container.light-theme .map-chat-input::placeholder {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-chat-like-btn svg {\n        fill: #000;\n      }\n\n      #x-map-container.light-theme .map-chat-like-btn:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .map-chat-overlay {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-chat-function-item {\n        background: #f0f0f0;\n        border: 1px solid #d0d0d0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-chat-function-item:hover {\n        background: #e0e0e0;\n      }\n\n      /* ==================== 亮色主题：笔记弹窗 ==================== */\n      #x-map-container.light-theme .map-notes-overlay {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-notes-modal {\n        background: #fff;\n        border: 1px solid #d0d0d0;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-notes-header {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-notes-main-tabs {\n        background: #f0f0f0;\n      }\n\n      #x-map-container.light-theme .map-notes-main-tab {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notes-main-tab:hover {\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-notes-main-tab.active {\n        background: #fff;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notes-close {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notes-close:hover {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notes-tabs {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-notes-tab {\n        border: 1px solid #d0d0d0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notes-empty {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-notes-empty svg {\n        color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-notes-empty p {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notes-empty span {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-notes-item {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-notes-item-category {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notes-item-time {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-notes-item-text {\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-notes-item-action {\n        border: 1px solid #d0d0d0;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-notes-picker-overlay {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-notes-picker {\n        background: #fff;\n        border: 1px solid #d0d0d0;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-notes-picker-header {\n        border-bottom: 1px solid #d0d0d0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-notes-picker-item {\n        border-bottom: 1px solid #e0e0e0;\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-notes-picker-item:hover {\n        background: #f5f5f5;\n      }\n\n      /* ==================== 亮色主题：聊天列表弹窗 ==================== */\n      #x-map-container.light-theme .map-chats-list-overlay {\n        background: rgba(0, 0, 0, 0.5);\n      }\n\n      #x-map-container.light-theme .map-chats-list-modal {\n        background: #fff;\n        border: 1px solid #d0d0d0;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .map-chats-list-header {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-chats-list-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chats-list-close {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-chats-list-close:hover {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chats-list-content::-webkit-scrollbar-thumb {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-chats-list-empty {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-chats-list-empty svg {\n        color: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-chats-list-empty p {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-chats-list-empty span {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item {\n        background: #f5f5f5;\n        border: 1px solid #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item:hover {\n        background: #ebebeb;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item-avatar {\n        background: #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item-name {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item-preview {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-chats-list-item-delete {\n        color: #999;\n      }\n\n      /* ==================== 亮色主题：指定筛选弹窗 ==================== */\n      #x-map-container.light-theme .map-advanced-filter-overlay {\n        background: rgba(0, 0, 0, 0.4);\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-modal {\n        background: #fff;\n        border: 1px solid #d0d0d0;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-header {\n        border-bottom: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-title {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-close {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-close:hover {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-filter-label {\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-filter-radio input[type="radio"] {\n        border: 2px solid #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-filter-radio span {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-filter-input {\n        background: #f5f5f5;\n        border: 1px solid #d0d0d0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-filter-input:focus {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-filter-separator {\n        color: #666;\n      }\n\n      #x-map-container.light-theme .map-filter-textarea {\n        background: #f5f5f5;\n        border: 1px solid #d0d0d0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-filter-textarea:focus {\n        background: #fff;\n      }\n\n      #x-map-container.light-theme .map-filter-textarea::placeholder,\n      #x-map-container.light-theme .map-filter-input::placeholder {\n        color: #999;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-footer {\n        border-top: 1px solid #e0e0e0;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-btn-cancel {\n        color: #666;\n        border: 1px solid #d0d0d0;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-btn-cancel:hover {\n        background: #f0f0f0;\n        color: #333;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-btn-clear {\n        background: #f0f0f0;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .map-advanced-filter-btn-clear:hover {\n        background: #e0e0e0;\n      }\n\n      .map-controls {\n        position: absolute;\n        top: 80px;\n        right: 20px;\n        z-index: 10;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n\n      .map-control-btn {\n        width: 40px;\n        height: 40px;\n        background: #1a1a1a;\n        border: none;\n        border-radius: 8px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        transition: all 0.2s;\n        position: relative;\n      }\n\n      .map-control-btn:active {\n        transform: scale(0.95);\n        background: #2a2a2a;\n      }\n\n      .map-control-btn:hover::after {\n        content: attr(title);\n        position: absolute;\n        right: calc(100% + 8px);\n        background: rgba(0,0,0,0.8);\n        color: #fff;\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        white-space: nowrap;\n        pointer-events: none;\n      }\n\n      .map-control-btn svg {\n        width: 20px;\n        height: 20px;\n        fill: #e5e5e5;\n        transition: fill 0.2s;\n      }\n\n      .map-control-btn:active svg {\n        fill: #1d9bf0;\n      }\n\n      .map-canvas {\n        position: absolute;\n        width: 300%;\n        height: 300%;\n        top: 0;\n        left: 0;\n        background: var(--map-bg-primary);\n        cursor: grab;\n        transition: none;\n        will-change: transform;\n        transform-origin: 0 0;\n      }\n\n      .map-canvas:active {\n        cursor: grabbing;\n      }\n\n      #mapCanvasBg {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n      }\n\n      /* ==================== 地标标签 ==================== */\n      .landmark-label {\n        position: absolute;\n        /* 液态玻璃磨砂效果 - ins风格 */\n        background: rgba(255, 255, 255, 0.15);\n        backdrop-filter: blur(20px) saturate(180%);\n        -webkit-backdrop-filter: blur(20px) saturate(180%);\n        color: #ffffff;\n        padding: 6px 14px;\n        border-radius: 18px;\n        font-size: 12px;\n        font-weight: 600;\n        white-space: nowrap;\n        pointer-events: auto;\n        cursor: default;\n        transform: translate(-50%, -100%);\n        margin-top: -10px;\n        /* 玻璃质感阴影：外阴影 + 内阴影 */\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),\n                    0 2px 8px rgba(0, 0, 0, 0.15),\n                    inset 0 1px 0 rgba(255, 255, 255, 0.3),\n                    inset 0 -1px 0 rgba(0, 0, 0, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        display: flex;\n        align-items: center;\n        gap: 2px;\n        opacity: 0;\n        transform: translate(-50%, -100%) scale(0.85);\n        transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),\n                    transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);\n      }\n\n      .landmark-label.visible {\n        opacity: 1;\n        transform: translate(-50%, -100%) scale(1);\n      }\n\n      /* 有事件的地标显示手指光标 */\n      .landmark-label.has-event {\n        cursor: pointer;\n      }\n\n      .landmark-label-icon {\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        width: 16px;\n        height: 16px;\n        margin-right: 6px;\n        flex-shrink: 0;\n      }\n\n      .landmark-label-icon svg {\n        width: 100%;\n        height: 100%;\n        display: block;\n      }\n\n      .landmark-label::after {\n        content: \'\';\n        position: absolute;\n        bottom: -5px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 0;\n        height: 0;\n        border-left: 5px solid transparent;\n        border-right: 5px solid transparent;\n        border-top: 5px solid rgba(255, 255, 255, 0.15);\n        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));\n      }\n\n      .map-marker {\n        position: absolute;\n        cursor: pointer;\n        transition: opacity 0.3s, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        z-index: 5;\n        transform-origin: center center;\n        pointer-events: auto;\n      }\n\n      .map-marker:active {\n        transform: scale(0.95);\n        z-index: 6;\n      }\n\n      .marker-container {\n        position: relative;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));\n      }\n\n      .marker-avatar {\n        width: 44px;\n        height: 44px;\n        border-radius: 50%;\n        border: 3px solid #fff;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 -2px 4px rgba(0,0,0,0.2);\n        object-fit: cover;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        position: relative;\n        z-index: 2;\n      }\n\n      .map-marker:hover .marker-avatar {\n        border-color: #1d9bf0;\n        box-shadow: 0 6px 20px rgba(29,155,240,0.6), inset 0 -2px 4px rgba(0,0,0,0.2);\n        transform: scale(1.05);\n      }\n\n      .marker-container::after {\n        content: \'\';\n        position: absolute;\n        bottom: -6px;\n        width: 50px;\n        height: 12px;\n        background: radial-gradient(ellipse at center, rgba(0,0,0,0.4) 0%, transparent 70%);\n        border-radius: 50%;\n        z-index: 1;\n        transition: all 0.3s;\n      }\n\n      .map-marker:hover .marker-container::after {\n        transform: scale(1.2);\n        opacity: 0.6;\n      }\n\n      .marker-pulse {\n        position: absolute;\n        width: 44px;\n        height: 44px;\n        border-radius: 50%;\n        background: rgba(29,155,240,0.3);\n        animation: mapPulse 2s infinite;\n        z-index: 1;\n      }\n\n      @keyframes mapPulse {\n        0% { transform: scale(1); opacity: 0.6; }\n        50% { transform: scale(1.5); opacity: 0.2; }\n        100% { transform: scale(1); opacity: 0.6; }\n      }\n\n      /* 用户自己的标记 - 简洁设计 */\n      .map-marker.current-user {\n        z-index: 10;\n      }\n\n      .map-marker.current-user .marker-avatar {\n        width: 44px;\n        height: 44px;\n        /* border颜色通过内联样式动态设置（使用主题色） */\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 -2px 4px rgba(0,0,0,0.2);\n      }\n\n      /* ==================== 气泡状态设计 ==================== */\n      .marker-status-bubble {\n        position: absolute;\n        top: -35px;\n        left: 50%;\n        transform: translateX(-50%) scale(0);\n        background: #1a1a1a;\n        color: #e5e5e5;\n        padding: 4px 10px;\n        border-radius: 12px;\n        font-size: 12px;\n        font-weight: 600;\n        white-space: nowrap;\n        pointer-events: none;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        opacity: 0;\n        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n                    transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        z-index: 3;\n      }\n\n      .marker-status-bubble::after {\n        content: \'\';\n        position: absolute;\n        bottom: -4px;\n        left: 50%;\n        transform: translateX(-50%);\n        width: 0;\n        height: 0;\n        border-left: 5px solid transparent;\n        border-right: 5px solid transparent;\n        border-top: 5px solid #1a1a1a;\n      }\n\n      .marker-status-bubble.visible {\n        opacity: 1;\n        transform: translateX(-50%) scale(1);\n      }\n\n      /* ==================== 用户详情卡片 - TikTok风格 ==================== */\n      .map-user-detail-card {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: calc(100% - 40px);\n        max-width: 420px;\n        max-height: calc(100% - 60px);\n        background: #000;\n        border-radius: 0;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.6);\n        overflow-y: auto;\n        z-index: 350; /* 修正：提高层级，在聊天弹窗(300)之上，确认弹窗(400)之下 */\n        animation: mapCardZoomIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        -webkit-overflow-scrolling: touch;\n        display: none;\n      }\n\n      .map-user-detail-card.active {\n        display: block;\n      }\n\n      @keyframes mapCardZoomIn {\n        from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; }\n        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }\n      }\n\n      /* TikTok风格顶部Header区域 */\n      .card-header {\n        position: relative;\n        padding: 12px 16px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        background: #000;\n      }\n\n      /* 返回按钮 - 左侧，有实际功能 */\n      .card-back-btn {\n        width: 72px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: flex-start;\n        transition: opacity 0.2s;\n        padding: 0;\n      }\n\n      .card-back-btn:hover {\n        opacity: 0.6;\n      }\n\n      .card-back-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n      }\n\n      /* 中间昵称区域 */\n      .card-header-center {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n      }\n\n      .card-header-nickname {\n        font-size: 16px;\n        font-weight: 700;\n        color: #fff;\n      }\n\n      .card-header-verified {\n        width: 16px;\n        height: 16px;\n        color: #0095f6;\n        flex-shrink: 0;\n      }\n\n      /* 右侧装饰按钮组 */\n      .card-header-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n      }\n\n      .card-action-btn {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        cursor: default;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 0;\n      }\n\n      .card-action-btn svg {\n        width: 22px;\n        height: 22px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n      }\n\n      /* 头像区域 - 简化padding */\n      .card-avatar-section {\n        padding: 12px 20px 20px;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        background: #000;\n      }\n\n      .card-avatar-wrapper {\n        position: relative;\n        margin-bottom: 16px;\n      }\n\n      .card-avatar {\n        width: 120px;\n        height: 120px;\n        border-radius: 50%;\n        object-fit: cover;\n        border: 3px solid #262626;\n      }\n\n      /* 头像气泡 - 思考气泡风格（参考meme图，右上角，深灰色背景） */\n      .card-avatar-bubble {\n        position: absolute;\n        top: -8px;\n        right: -24px;\n        min-width: 56px;\n        height: 40px;\n        padding: 0 12px;\n        background: #6a6a6a;\n        border: none;\n        border-radius: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 22px;\n        color: #fff;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        z-index: 1;\n      }\n\n      /* 思考气泡小尾巴 - 连接到头像左下方 */\n      .card-avatar-bubble::before {\n        content: \'\';\n        position: absolute;\n        bottom: -10px;\n        left: 8px;\n        width: 10px;\n        height: 10px;\n        background: #6a6a6a;\n        border: none;\n        border-radius: 50%;\n      }\n\n      .card-avatar-bubble::after {\n        content: \'\';\n        position: absolute;\n        bottom: -18px;\n        left: 4px;\n        width: 6px;\n        height: 6px;\n        background: #6a6a6a;\n        border: none;\n        border-radius: 50%;\n      }\n\n      /* 用户信息 - 移除昵称（已移至header） */\n      .card-user-info {\n        text-align: center;\n        color: #fff;\n        margin-bottom: 16px;\n      }\n\n      .card-handle {\n        font-size: 14px;\n        color: #a8a8a8;\n      }\n\n      /* 统计数据 */\n      .card-stats {\n        display: flex;\n        justify-content: center;\n        gap: 0;\n        padding: 12px 0 20px;\n        margin-bottom: 0;\n      }\n\n      .card-stat-item {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 2px;\n        padding: 0 24px;\n        position: relative;\n      }\n\n      /* 竖线分隔符 - 在第2和第3项之间 */\n      .card-stat-item:not(:last-child)::after {\n        content: \'\';\n        position: absolute;\n        right: 0;\n        top: 50%;\n        transform: translateY(-50%);\n        width: 1px;\n        height: 20px;\n        background: #262626;\n      }\n\n      .card-stat-value {\n        font-size: 18px;\n        font-weight: 600;\n        color: #fff;\n      }\n\n      .card-stat-label {\n        font-size: 13px;\n        color: #a8a8a8;\n      }\n\n      /* 按钮组 */\n      .card-buttons {\n        display: flex;\n        gap: 8px;\n        padding: 0 16px 20px;\n      }\n\n      .card-btn {\n        padding: 10px 16px;\n        border: none;\n        border-radius: 8px;\n        font-size: 15px;\n        font-weight: 600;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        transition: all 0.2s;\n      }\n\n      .card-btn-message {\n        flex: 1;\n        background: #363636;\n        color: #fff;\n      }\n\n      .card-btn-message:hover {\n        background: #404040;\n      }\n\n      .card-btn-secondary {\n        background: #363636;\n        color: #fff;\n        padding: 10px 14px;\n        flex: 0 0 auto;\n        min-width: 44px;\n      }\n\n      .card-btn-secondary:hover {\n        background: #404040;\n      }\n\n      .card-btn svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      /* 下拉菜单容器 */\n      .card-btn-dropdown-wrapper {\n        position: relative;\n        flex: 0 0 auto;\n      }\n\n      /* 下拉菜单 */\n      .card-dropdown-menu {\n        position: absolute;\n        top: calc(100% + 8px);\n        right: 0;\n        min-width: 50px;\n        background: #1a1a1a;\n        border-radius: 12px;\n        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);\n        padding: 8px 0;\n        z-index: 1000;\n        opacity: 0;\n        transform: translateY(-10px);\n        transition: opacity 0.2s ease, transform 0.2s ease;\n        pointer-events: none;\n      }\n\n      .card-dropdown-menu.show {\n        opacity: 1;\n        transform: translateY(0);\n        pointer-events: auto;\n      }\n\n      #x-map-container.light-theme .card-dropdown-menu {\n        background: #fff;\n        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);\n      }\n\n      .card-dropdown-item {\n        width: 100%;\n        padding: 12px;\n        background: transparent;\n        border: none;\n        color: #fff;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 12px;\n        transition: background 0.2s ease;\n        text-align: center;\n      }\n\n      .card-dropdown-item:hover {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      #x-map-container.light-theme .card-dropdown-item {\n        color: #000;\n      }\n\n      #x-map-container.light-theme .card-dropdown-item:hover {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      .card-dropdown-item svg {\n        width: 20px;\n        height: 20px;\n        flex-shrink: 0;\n        stroke: currentColor;\n      }\n\n      .card-btn-message svg {\n        width: 18px;\n        height: 18px;\n        stroke-width: 2;\n        transform: rotate(-30deg);\n      }\n\n      /* 简介部分 */\n      .card-bio-section {\n        padding: 16px 20px;\n        background: #000;\n      }\n\n      .card-bio {\n        color: #fff;\n        font-size: 14px;\n        line-height: 1.6;\n        text-align: center;\n        margin-bottom: 16px;\n        white-space: pre-line; /* 支持换行 */\n      }\n\n      /* 标签 */\n      .card-tags {\n        display: flex;\n        flex-wrap: wrap;\n        justify-content: center;\n        gap: 8px;\n        margin-bottom: 16px;\n      }\n\n      .card-tag {\n        background: #1a1a1a;\n        color: #fff;\n        padding: 6px 12px;\n        border-radius: 6px;\n        font-size: 13px;\n        font-weight: 500;\n        border: 1px solid #262626;\n      }\n\n      /* 距离信息 */\n      .card-distance-info {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        color: #a8a8a8;\n        font-size: 14px;\n      }\n\n      .card-distance-info svg {\n        width: 16px;\n        height: 16px;\n        stroke: #a8a8a8;\n        fill: none;\n      }\n\n      /* ==================== 评价/留言弹窗 ==================== */\n      .card-reviews-section {\n        display: none;\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: #000;\n        overflow-y: auto;\n        z-index: 2;\n      }\n\n      .card-reviews-section.active {\n        display: block;\n      }\n\n      /* 评价顶部header */\n      .reviews-header {\n        padding: 16px;\n        background: #000;\n        position: sticky;\n        top: 0;\n        z-index: 10;\n      }\n\n      .reviews-header-top {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 16px;\n      }\n\n      .reviews-back-btn {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        padding: 0;\n      }\n\n      .reviews-back-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        fill: none;\n        stroke-width: 2;\n      }\n\n      .reviews-title {\n        font-size: 16px;\n        font-weight: 700;\n        color: #fff;\n        flex: 1;\n        text-align: center;\n      }\n\n      .reviews-placeholder {\n        width: 32px;\n      }\n\n      /* 总评分区域 */\n      .reviews-summary {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 24px;\n        padding: 16px;\n        background: #1a1a1a;\n        border-radius: 12px;\n      }\n\n      .reviews-rating-big {\n        text-align: center;\n      }\n\n      .reviews-rating-number {\n        font-size: 48px;\n        font-weight: 700;\n        color: #fff;\n        line-height: 1;\n      }\n\n      .reviews-rating-max {\n        font-size: 16px;\n        color: #666;\n      }\n\n      .reviews-stars {\n        display: flex;\n        gap: 4px;\n        margin-top: 8px;\n        justify-content: center;\n      }\n\n      .reviews-stars svg {\n        width: 16px;\n        height: 16px;\n        fill: #ffd700;\n      }\n\n      .reviews-count {\n        font-size: 13px;\n        color: #a8a8a8;\n        margin-top: 4px;\n      }\n\n      /* 评价列表 */\n      .reviews-list {\n        padding: 16px;\n      }\n\n      .review-item {\n        background: #1a1a1a;\n        border-radius: 12px;\n        padding: 16px;\n        margin-bottom: 12px;\n      }\n\n      .review-header {\n        display: flex;\n        align-items: flex-start;\n        gap: 12px;\n        margin-bottom: 12px;\n      }\n\n      .review-avatar {\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        object-fit: cover;\n        flex-shrink: 0;\n      }\n\n      .review-info {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .review-name-line {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 4px;\n      }\n\n      .review-name {\n        font-size: 14px;\n        font-weight: 600;\n        color: #fff;\n      }\n\n      .review-rating {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        background: #262626;\n        padding: 2px 8px;\n        border-radius: 12px;\n      }\n\n      .review-rating-number {\n        font-size: 13px;\n        font-weight: 600;\n        color: #ffd700;\n      }\n\n      .review-rating svg {\n        width: 12px;\n        height: 12px;\n        fill: #ffd700;\n      }\n\n      .review-time {\n        font-size: 12px;\n        color: #666;\n      }\n\n      .review-content {\n        color: #e0e0e0;\n        font-size: 14px;\n        line-height: 1.6;\n        margin-bottom: 12px;\n      }\n\n      .review-reply {\n        display: flex;\n        align-items: flex-start;\n        gap: 8px;\n        margin-top: 10px;\n        padding-left: 8px;\n      }\n\n      .review-reply-icon {\n        width: 14px;\n        height: 14px;\n        color: #666;\n        flex-shrink: 0;\n        margin-top: 2px;\n      }\n\n      .review-reply-body {\n        flex: 1;\n        line-height: 1.4;\n      }\n\n      .review-reply-label {\n        font-size: 13px;\n        color: #fff;\n        font-weight: 600;\n      }\n\n      .review-reply-content {\n        font-size: 13px;\n        color: #a8a8a8;\n        margin-left: 6px;\n      }\n\n      .review-actions {\n        display: flex;\n        align-items: center;\n        gap: 16px;\n      }\n\n      .review-action-btn {\n        background: none;\n        border: none;\n        color: #666;\n        font-size: 13px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        cursor: pointer;\n        transition: color 0.2s;\n        padding: 0;\n      }\n\n      .review-action-btn:hover {\n        color: #1d9bf0;\n      }\n\n      .review-action-btn svg {\n        width: 16px;\n        height: 16px;\n        fill: currentColor;\n      }\n\n      /* 空状态 */\n      .reviews-empty {\n        text-align: center;\n        padding: 60px 20px;\n      }\n\n      .reviews-empty-icon {\n        font-size: 48px;\n        margin-bottom: 16px;\n      }\n\n      .reviews-empty-text {\n        font-size: 15px;\n        color: #666;\n        line-height: 1.6;\n      }\n\n      /* ==================== 触摸滑动提示 ==================== */\n      .map-swipe-hint {\n        position: absolute;\n        top: 50%;\n        left: 20px;\n        transform: translateY(-50%);\n        background: rgba(26,26,26,0.9);\n        color: #e5e5e5;\n        padding: 12px 16px;\n        border-radius: 12px;\n        font-size: 14px;\n        font-weight: 500;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n        animation: swipeHintAnim 2s infinite;\n        z-index: 5;\n        pointer-events: none;\n      }\n\n      .map-swipe-hint.hidden {\n        display: none;\n      }\n\n      @keyframes swipeHintAnim {\n        0%, 100% { transform: translateY(-50%) translateX(0); opacity: 1; }\n        50% { transform: translateY(-50%) translateX(10px); opacity: 0.7; }\n      }\n\n      /* ==================== 天气特效系统 ==================== */\n      .map-weather-container {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        z-index: 3;\n        overflow: hidden;\n      }\n\n      /* 晴天 - 阳光射线效果 */\n      .weather-sunny {\n        background: radial-gradient(circle at 15% 15%, rgba(255,200,50,0.15) 0%, transparent 50%);\n      }\n\n      .weather-sunny::before {\n        content: \'\';\n        position: absolute;\n        top: 5%;\n        left: 10%;\n        width: 80px;\n        height: 80px;\n        background: radial-gradient(circle, rgba(255,220,100,0.6) 0%, rgba(255,180,50,0.3) 40%, transparent 70%);\n        border-radius: 50%;\n        animation: sunPulse 4s ease-in-out infinite;\n      }\n\n      @keyframes sunPulse {\n        0%, 100% { transform: scale(1); opacity: 0.8; }\n        50% { transform: scale(1.1); opacity: 1; }\n      }\n\n      /* 多云 - 全屏幕飘动的云层 */\n      .weather-cloudy {\n        background: linear-gradient(180deg, rgba(150,150,150,0.08) 0%, transparent 30%);\n      }\n\n      .weather-cloudy .cloud {\n        position: absolute;\n        background: rgba(200,200,200,0.25);\n        border-radius: 50%;\n        filter: blur(25px);\n        animation: cloudFloat linear infinite;\n        opacity: 0.8;\n      }\n\n      @keyframes cloudFloat {\n        0% { transform: translateX(0); opacity: 0; }\n        10% { opacity: 0.8; }\n        90% { opacity: 0.8; }\n        100% { transform: translateX(calc(100vw + 300px)); opacity: 0; }\n      }\n\n      /* 小雨 - 稀疏雨滴 */\n      .weather-rain {\n        background: linear-gradient(180deg, rgba(100,120,140,0.2) 0%, transparent 50%);\n      }\n\n      .weather-rain .rain-drop {\n        position: absolute;\n        width: 2px;\n        height: 15px;\n        background: linear-gradient(180deg, transparent, rgba(174,194,224,0.6));\n        animation: rainFall 1s linear infinite;\n      }\n\n      @keyframes rainFall {\n        0% { transform: translateY(-20px); opacity: 0; }\n        10% { opacity: 1; }\n        90% { opacity: 1; }\n        100% { transform: translateY(100vh); opacity: 0; }\n      }\n\n      /* 大雨 - 密集雨滴 + 涟漪 */\n      .weather-heavy-rain {\n        background: linear-gradient(180deg, rgba(60,80,100,0.35) 0%, rgba(80,100,120,0.15) 50%, transparent 100%);\n      }\n\n      .weather-heavy-rain .rain-drop {\n        position: absolute;\n        width: 3px;\n        height: 25px;\n        background: linear-gradient(180deg, transparent, rgba(150,180,220,0.7));\n        animation: heavyRainFall 0.6s linear infinite;\n      }\n\n      @keyframes heavyRainFall {\n        0% { transform: translateY(-30px) rotate(15deg); opacity: 0; }\n        10% { opacity: 1; }\n        90% { opacity: 0.8; }\n        100% { transform: translateY(100vh) rotate(15deg); opacity: 0; }\n      }\n\n      .weather-heavy-rain .ripple {\n        position: absolute;\n        bottom: 10%;\n        width: 20px;\n        height: 10px;\n        border: 1px solid rgba(150,180,220,0.5);\n        border-radius: 50%;\n        animation: rippleExpand 1.5s ease-out infinite;\n      }\n\n      @keyframes rippleExpand {\n        0% { transform: scale(0); opacity: 1; }\n        100% { transform: scale(3); opacity: 0; }\n      }\n\n      /* 雷暴 - 闪电 + 大雨 */\n      .weather-thunder {\n        background: linear-gradient(180deg, rgba(40,50,70,0.4) 0%, rgba(60,70,90,0.2) 50%, transparent 100%);\n      }\n\n      .weather-thunder .rain-drop {\n        position: absolute;\n        width: 3px;\n        height: 30px;\n        background: linear-gradient(180deg, transparent, rgba(130,160,200,0.8));\n        animation: heavyRainFall 0.5s linear infinite;\n      }\n\n      .weather-thunder .lightning {\n        position: absolute;\n        top: 0;\n        left: 50%;\n        width: 100%;\n        height: 100%;\n        background: rgba(255,255,255,0);\n        animation: lightningFlash 8s ease-in-out infinite;\n      }\n\n      @keyframes lightningFlash {\n        0%, 89%, 91%, 93%, 100% { background: rgba(255,255,255,0); }\n        90% { background: rgba(255,255,255,0.3); }\n        92% { background: rgba(255,255,255,0.5); }\n      }\n\n      /* 雪 - 飘落雪花 */\n      .weather-snow {\n        background: linear-gradient(180deg, rgba(200,210,230,0.15) 0%, transparent 40%);\n      }\n\n      .weather-snow .snowflake {\n        position: absolute;\n        color: rgba(255,255,255,0.9);\n        font-size: 12px;\n        animation: snowFall 8s linear infinite;\n        text-shadow: 0 0 3px rgba(255,255,255,0.5);\n      }\n\n      @keyframes snowFall {\n        0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }\n        10% { opacity: 1; }\n        90% { opacity: 0.8; }\n        100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }\n      }\n\n      /* 雾 - 弥漫雾气 */\n      .weather-fog {\n        background: linear-gradient(180deg, rgba(180,180,190,0.4) 0%, rgba(160,160,170,0.3) 50%, rgba(150,150,160,0.2) 100%);\n      }\n\n      .weather-fog::before,\n      .weather-fog::after {\n        content: \'\';\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(90deg, transparent, rgba(200,200,210,0.3), transparent);\n        animation: fogDrift 20s ease-in-out infinite;\n      }\n\n      .weather-fog::after {\n        animation-delay: -10s;\n        animation-direction: reverse;\n      }\n\n      @keyframes fogDrift {\n        0%, 100% { transform: translateX(-20%); opacity: 0.6; }\n        50% { transform: translateX(20%); opacity: 0.8; }\n      }\n\n      /* 沙尘 - 黄沙飞舞 */\n      .weather-dust {\n        background: linear-gradient(180deg, rgba(180,150,100,0.35) 0%, rgba(160,130,80,0.2) 50%, transparent 100%);\n      }\n\n      .weather-dust .dust-particle {\n        position: absolute;\n        width: 4px;\n        height: 4px;\n        background: rgba(180,150,100,0.6);\n        border-radius: 50%;\n        animation: dustBlow 3s linear infinite;\n      }\n\n      @keyframes dustBlow {\n        0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }\n        20% { opacity: 0.8; }\n        80% { opacity: 0.6; }\n        100% { transform: translate(100vw, 30vh) rotate(720deg); opacity: 0; }\n      }\n\n      /* 开发者测试按钮 */\n      .map-weather-test-btn {\n        position: absolute;\n        bottom: 20px;\n        left: 20px;\n        z-index: 15;\n        background: rgba(255,100,100,0.9);\n        color: #fff;\n        border: none;\n        border-radius: 8px;\n        padding: 8px 12px;\n        font-size: 12px;\n        font-weight: 600;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        transition: all 0.2s;\n      }\n\n      .map-weather-test-btn:hover {\n        background: rgba(255,80,80,1);\n        transform: translateY(-2px);\n      }\n\n      .map-weather-test-btn::before {\n        content: \'🔧\';\n      }\n\n      /* 天气信息显示 - 圆形按钮样式，垂直排列 */\n      .map-weather-info {\n        /* 移除position定位，作为flex子元素自动垂直排列 */\n        width: 40px;\n        height: 40px;\n        background: #1a1a1a;\n        border: none;\n        border-radius: 8px;\n        cursor: default;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n        transition: all 0.2s;\n        position: relative; /* 保留relative以支持::after定位 */\n      }\n\n      .map-weather-info:hover::after {\n        content: attr(data-weather-name);\n        position: absolute;\n        right: calc(100% + 8px);\n        background: rgba(0,0,0,0.8);\n        color: #fff;\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        white-space: nowrap;\n        pointer-events: none;\n      }\n\n      .map-weather-icon {\n        font-size: 20px;\n      }\n\n      /* ==================== 动态(Moments)弹窗样式 ==================== */\n\n      /* 动态弹窗容器 */\n      .map-moments-modal {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: transparent;\n        z-index: 10000;\n        display: none;\n        opacity: 0;\n        transition: opacity 0.3s ease;\n        pointer-events: none;\n      }\n\n      .map-moments-modal.active {\n        display: block;\n        opacity: 1;\n        pointer-events: auto;\n      }\n\n      .map-moments-modal > * {\n        pointer-events: auto;\n      }\n\n      #x-map-container.light-theme .map-moments-modal {\n        background: transparent;\n      }\n\n      /* 关闭按钮 */\n      .moments-close-btn {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        width: 44px;\n        height: 44px;\n        border-radius: 22px;\n        background: rgba(255, 255, 255, 0.1);\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 10;\n        transition: all 0.2s ease;\n      }\n\n      .moments-close-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n      }\n\n      .moments-close-btn:active {\n        transform: scale(0.95);\n      }\n\n      .moments-close-btn svg {\n        width: 20px;\n        height: 20px;\n        stroke: #fff;\n        stroke-width: 2;\n      }\n\n      #x-map-container.light-theme .moments-close-btn {\n        background: rgba(0, 0, 0, 0.05);\n      }\n\n      #x-map-container.light-theme .moments-close-btn:hover {\n        background: rgba(0, 0, 0, 0.1);\n      }\n\n      #x-map-container.light-theme .moments-close-btn svg {\n        stroke: #000;\n      }\n\n      /* 卡片堆叠容器 */\n      .moments-cards-wrapper {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 100%;\n        max-width: 420px;\n        height: 75vh;\n        max-height: 700px;\n        perspective: 1000px;\n      }\n\n      /* 单个动态卡片 */\n      .moment-card {\n        position: absolute;\n        width: 100%;\n        height: 100%;\n        background: #1a1a1a;\n        border-radius: 28px;\n        overflow: hidden;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);\n        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n        cursor: grab;\n        user-select: none;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .moment-card:active {\n        cursor: grabbing;\n      }\n\n      #x-map-container.light-theme .moment-card {\n        background: #fff;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);\n      }\n\n      /* 卡片层级和位置 */\n      .moment-card[data-position="0"] {\n        z-index: 5;\n        transform: translate(0, 0) scale(1) rotateY(0deg);\n        opacity: 1;\n      }\n\n      .moment-card[data-position="1"] {\n        z-index: 4;\n        transform: translate(0, 16px) scale(0.96) rotateY(0deg);\n        opacity: 0.7;\n        pointer-events: none;\n      }\n\n      .moment-card[data-position="2"] {\n        z-index: 3;\n        transform: translate(0, 32px) scale(0.92) rotateY(0deg);\n        opacity: 0.4;\n        pointer-events: none;\n      }\n\n      .moment-card.swiping-left {\n        transform: translateX(var(--swipe-x, 0)) rotate(var(--swipe-rotate, 0deg));\n      }\n\n      .moment-card.swiping-right {\n        transform: translateX(var(--swipe-x, 0)) rotate(var(--swipe-rotate, 0deg));\n      }\n\n      .moment-card.removed-left {\n        transform: translateX(-150%) rotate(-30deg);\n        opacity: 0;\n      }\n\n      .moment-card.removed-right {\n        transform: translateX(150%) rotate(30deg);\n        opacity: 0;\n      }\n\n      /* 卡片内容 */\n      .moment-card-image {\n        width: 100%;\n        height: 45%;\n        background: #0a0a0a;\n        position: relative;\n        overflow: hidden;\n        flex-shrink: 0;\n      }\n\n      #x-map-container.light-theme .moment-card-image {\n        background: #f5f5f5;\n      }\n\n      .moment-card-image img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n      }\n\n      .moment-card-image-placeholder {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #333;\n        font-size: 14px;\n        font-weight: 500;\n        letter-spacing: 1px;\n      }\n\n      #x-map-container.light-theme .moment-card-image-placeholder {\n        color: #ccc;\n      }\n\n      /* 文字配图渲染样式 - 黑白灰主题 */\n      .moment-card-text-image {\n        width: 100%;\n        height: 100%;\n        position: relative;\n        background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);\n        overflow: hidden;\n        padding: 20px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .text-image-content {\n        position: relative;\n        width: 100%;\n        max-height: 100%;\n        z-index: 2;\n        color: #e0e0e0;\n        font-size: 15px;\n        line-height: 1.7;\n        text-align: center;\n        font-weight: 500;\n        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding-right: 8px;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      /* 文字配图滚动条样式 */\n      .text-image-content::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .text-image-content::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .text-image-content::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n        border-radius: 2px;\n      }\n\n      .text-image-content::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n\n      .text-image-overlay {\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0%, rgba(0, 0, 0, 0.3) 100%);\n        pointer-events: none;\n        z-index: 1;\n      }\n\n      #x-map-container.light-theme .moment-card-text-image {\n        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);\n      }\n\n      #x-map-container.light-theme .text-image-content {\n        color: #333333;\n        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n\n      #x-map-container.light-theme .text-image-content::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.2);\n      }\n\n      #x-map-container.light-theme .text-image-content::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      .moment-card-content {\n        flex: 1;\n        padding: 24px;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      }\n\n      .moment-card-header {\n        display: flex;\n        align-items: center;\n        margin-bottom: 16px;\n        flex-shrink: 0;\n      }\n\n      .moment-user-avatar {\n        width: 40px;\n        height: 40px;\n        border-radius: 20px;\n        background: #fff;\n        color: #000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 14px;\n        font-weight: 600;\n        margin-right: 12px;\n        flex-shrink: 0;\n        object-fit: cover;\n      }\n\n      #x-map-container.light-theme .moment-user-avatar {\n        background: #000;\n        color: #fff;\n      }\n\n      .moment-user-info {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .moment-username {\n        font-size: 15px;\n        font-weight: 600;\n        color: #fff;\n        margin-bottom: 2px;\n      }\n\n      #x-map-container.light-theme .moment-username {\n        color: #000;\n      }\n\n      .moment-time {\n        font-size: 12px;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .moment-time {\n        color: #999;\n      }\n\n      .moment-card-text {\n        flex: 1;\n        font-size: 15px;\n        line-height: 1.6;\n        color: #ccc;\n        overflow-y: auto;\n        margin-bottom: 16px;\n        white-space: pre-wrap;\n        word-wrap: break-word;\n      }\n\n      #x-map-container.light-theme .moment-card-text {\n        color: #333;\n      }\n\n      .moment-card-stats {\n        display: flex;\n        gap: 20px;\n        padding: 16px 0;\n        border-top: 1px solid #2a2a2a;\n        border-bottom: 1px solid #2a2a2a;\n        font-size: 13px;\n        color: #999;\n        flex-shrink: 0;\n      }\n\n      #x-map-container.light-theme .moment-card-stats {\n        border-color: #f0f0f0;\n        color: #666;\n      }\n\n      .moment-stat-item {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n\n      .moment-stat-number {\n        font-weight: 600;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .moment-stat-number {\n        color: #000;\n      }\n\n      .moment-card-actions {\n        display: flex;\n        gap: 8px;\n        margin-top: 12px;\n        flex-shrink: 0;\n      }\n\n      .moment-action-btn {\n        flex: 1;\n        height: 44px;\n        border-radius: 22px;\n        background: #2a2a2a;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n        font-size: 13px;\n        font-weight: 500;\n        color: #999;\n        transition: all 0.2s ease;\n      }\n\n      .moment-action-btn:active {\n        transform: scale(0.95);\n      }\n\n      .moment-action-btn.active {\n        background: #fff;\n        color: #000;\n      }\n\n      #x-map-container.light-theme .moment-action-btn {\n        background: #f5f5f5;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .moment-action-btn.active {\n        background: #000;\n        color: #fff;\n      }\n\n      .moment-action-btn svg {\n        width: 18px;\n        height: 18px;\n        stroke: currentColor;\n        stroke-width: 2;\n      }\n\n      /* 评论弹窗遮罩 */\n      .moments-comments-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.6);\n        z-index: 2001;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.3s ease;\n      }\n\n      .moments-comments-overlay.show {\n        opacity: 1;\n        pointer-events: auto;\n      }\n\n      /* 评论弹窗 */\n      .moments-comments-drawer {\n        position: fixed;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        max-height: 70vh;\n        background: #1a1a1a;\n        border-radius: 24px 24px 0 0;\n        z-index: 2002;\n        transform: translateY(100%);\n        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n        display: flex;\n        flex-direction: column;\n        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);\n      }\n\n      .moments-comments-drawer.show {\n        transform: translateY(0);\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer {\n        background: #fff;\n        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);\n      }\n\n      /* 评论抽屉顶部 */\n      .moments-comments-drawer-header {\n        padding: 16px 20px;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        flex-shrink: 0;\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-header {\n        border-bottom-color: #f0f0f0;\n      }\n\n      .moments-comments-drawer-handle {\n        width: 40px;\n        height: 4px;\n        background: #333;\n        border-radius: 2px;\n        position: absolute;\n        top: 8px;\n        left: 50%;\n        transform: translateX(-50%);\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-handle {\n        background: #ddd;\n      }\n\n      .moments-comments-drawer-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #fff;\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-title {\n        color: #000;\n      }\n\n      .moments-comments-drawer-close {\n        width: 32px;\n        height: 32px;\n        border-radius: 16px;\n        background: #2a2a2a;\n        border: none;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s ease;\n      }\n\n      .moments-comments-drawer-close:hover {\n        background: #333;\n      }\n\n      .moments-comments-drawer-close:active {\n        transform: scale(0.95);\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-close {\n        background: #f5f5f5;\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-close:hover {\n        background: #e8e8e8;\n      }\n\n      .moments-comments-drawer-close svg {\n        width: 16px;\n        height: 16px;\n        stroke: #999;\n        stroke-width: 2;\n      }\n\n      #x-map-container.light-theme .moments-comments-drawer-close svg {\n        stroke: #666;\n      }\n\n      /* 评论列表 */\n      .moments-comments-list {\n        flex: 1;\n        overflow-y: auto;\n        padding: 16px 20px;\n        min-height: 200px;\n        max-height: 50vh;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      /* 评论列表滚动条样式 */\n      .moments-comments-list::-webkit-scrollbar {\n        width: 4px;\n      }\n\n      .moments-comments-list::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .moments-comments-list::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 2px;\n      }\n\n      .moments-comments-list::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n\n      #x-map-container.light-theme .moments-comments-list::-webkit-scrollbar-thumb {\n        background: rgba(0, 0, 0, 0.15);\n      }\n\n      #x-map-container.light-theme .moments-comments-list::-webkit-scrollbar-thumb:hover {\n        background: rgba(0, 0, 0, 0.25);\n      }\n\n      .moment-comment-item {\n        display: flex;\n        gap: 12px;\n        margin-bottom: 16px;\n      }\n\n      .moment-comment-item:last-child {\n        margin-bottom: 0;\n      }\n\n      .moment-comment-avatar {\n        width: 32px;\n        height: 32px;\n        border-radius: 16px;\n        background: #2a2a2a;\n        color: #999;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 12px;\n        font-weight: 600;\n        flex-shrink: 0;\n        object-fit: cover;\n        overflow: hidden;\n      }\n\n      #x-map-container.light-theme .moment-comment-avatar {\n        background: #ddd;\n        color: #666;\n      }\n\n      .moment-comment-content {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .moment-comment-user {\n        font-size: 13px;\n        font-weight: 600;\n        color: #fff;\n        margin-bottom: 4px;\n      }\n\n      #x-map-container.light-theme .moment-comment-user {\n        color: #000;\n      }\n\n      .moment-comment-text {\n        font-size: 13px;\n        line-height: 1.5;\n        color: #999;\n        margin-bottom: 4px;\n      }\n\n      #x-map-container.light-theme .moment-comment-text {\n        color: #666;\n      }\n\n      .moment-comment-time {\n        font-size: 11px;\n        color: #666;\n      }\n\n      #x-map-container.light-theme .moment-comment-time {\n        color: #999;\n      }\n\n      /* 指示器 */\n      .moments-indicator {\n        position: absolute;\n        bottom: 40px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        gap: 8px;\n        z-index: 6;\n      }\n\n      .moments-indicator-dot {\n        width: 6px;\n        height: 6px;\n        border-radius: 3px;\n        background: rgba(255, 255, 255, 0.3);\n        transition: all 0.3s ease;\n      }\n\n      .moments-indicator-dot.active {\n        width: 20px;\n        background: rgba(255, 255, 255, 0.9);\n      }\n\n      #x-map-container.light-theme .moments-indicator-dot {\n        background: rgba(0, 0, 0, 0.3);\n      }\n\n      #x-map-container.light-theme .moments-indicator-dot.active {\n        background: rgba(0, 0, 0, 0.9);\n      }\n\n      /* 空状态 */\n      .moments-empty-state {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 85%;\n        max-width: 340px;\n        height: auto;\n        min-height: 240px;\n        max-height: 320px;\n        background: #1a1a1a;\n        border-radius: 24px;\n        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        text-align: center;\n        color: rgba(255, 255, 255, 0.5);\n        font-size: 14px;\n        padding: 32px 24px;\n      }\n\n      #x-map-container.light-theme .moments-empty-state {\n        background: #fff;\n        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);\n        color: rgba(0, 0, 0, 0.5);\n      }\n\n      .moments-empty-state svg {\n        width: 48px;\n        height: 48px;\n        margin-bottom: 12px;\n        stroke: rgba(255, 255, 255, 0.3);\n      }\n\n      #x-map-container.light-theme .moments-empty-state svg {\n        stroke: rgba(0, 0, 0, 0.3);\n      }\n\n      /* 移动端适配 */\n      @media (max-width: 768px) {\n        .moments-cards-wrapper {\n          max-width: 90%;\n          height: 80vh;\n        }\n\n        .moment-card {\n          border-radius: 24px;\n        }\n\n        .moment-card-content {\n          padding: 20px;\n        }\n\n        .moments-close-btn {\n          top: 16px;\n          right: 16px;\n        }\n\n        .moments-indicator {\n          bottom: 30px;\n        }\n\n        .moments-comments-drawer {\n          max-height: 80vh;\n          border-radius: 20px 20px 0 0;\n        }\n\n        .moments-comments-drawer-header {\n          padding: 16px;\n        }\n\n        .moments-comments-list {\n          padding: 12px 16px;\n        }\n      }\n\n      /* ==================== 地图设置弹窗样式 - Instagram风格 ==================== */\n      .map-settings-modal {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.6);\n        backdrop-filter: blur(10px);\n        z-index: 1001;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        animation: map-settings-fade-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      @keyframes map-settings-fade-in {\n        from {\n          opacity: 0;\n        }\n        to {\n          opacity: 1;\n        }\n      }\n\n      .map-settings-content {\n        width: 90%;\n        max-width: 500px;\n        max-height: 65vh;\n        background: #000;\n        border-radius: 16px;\n        overflow: hidden;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        animation: map-settings-slide-up 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        display: flex;\n        flex-direction: column;\n      }\n\n      @keyframes map-settings-slide-up {\n        from {\n          transform: translateY(50px);\n          opacity: 0;\n        }\n        to {\n          transform: translateY(0);\n          opacity: 1;\n        }\n      }\n\n      .map-settings-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px 20px;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        background: #000;\n        flex-shrink: 0;\n      }\n\n      .map-settings-back-btn {\n        background: none;\n        border: none;\n        cursor: pointer;\n        padding: 8px;\n        width: 40px;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        transition: all 0.2s;\n      }\n\n      .map-settings-back-btn:hover {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .map-settings-back-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        stroke-width: 2;\n        fill: none;\n      }\n\n      .map-settings-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #fff;\n        flex: 1;\n        text-align: center;\n      }\n\n      .map-settings-save-btn {\n        background: none;\n        border: none;\n        cursor: pointer;\n        padding: 8px 12px;\n        color: #1d9bf0;\n        font-size: 15px;\n        font-weight: 600;\n        border-radius: 8px;\n        transition: all 0.2s;\n      }\n\n      .map-settings-save-btn:hover {\n        background: rgba(29, 155, 240, 0.1);\n      }\n\n      .map-settings-body {\n        flex: 1;\n        overflow-y: auto;\n        overflow-x: hidden;\n        padding: 20px;\n        min-height: 0;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      .map-settings-body::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-settings-body::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-settings-body::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 3px;\n      }\n\n      .map-settings-section {\n        margin-bottom: 32px;\n      }\n\n      .map-settings-section:last-child {\n        margin-bottom: 0;\n      }\n\n      .map-settings-section-title {\n        font-size: 13px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.6);\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n        margin-bottom: 16px;\n      }\n\n      .map-settings-item {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 16px 0;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .map-settings-item:last-child {\n        border-bottom: none;\n      }\n\n      .map-settings-item-left {\n        flex: 1;\n      }\n\n      .map-settings-item-label {\n        font-size: 15px;\n        font-weight: 500;\n        color: #fff;\n        margin-bottom: 4px;\n      }\n\n      .map-settings-item-desc {\n        font-size: 13px;\n        color: rgba(255, 255, 255, 0.5);\n      }\n\n      /* Instagram风格的Toggle开关 */\n      .map-settings-toggle {\n        position: relative;\n      }\n\n      .map-settings-toggle-input {\n        display: none;\n      }\n\n      .map-settings-toggle-label {\n        display: block;\n        width: 50px;\n        height: 30px;\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 15px;\n        cursor: pointer;\n        position: relative;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      }\n\n      .map-settings-toggle-label::after {\n        content: "";\n        position: absolute;\n        width: 26px;\n        height: 26px;\n        background: #fff;\n        border-radius: 50%;\n        top: 2px;\n        left: 2px;\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n      }\n\n      .map-settings-toggle-input:checked + .map-settings-toggle-label {\n        background: #1d9bf0;\n      }\n\n      .map-settings-toggle-input:checked + .map-settings-toggle-label::after {\n        left: 22px;\n      }\n\n      /* 输入框样式 */\n      .map-settings-input-wrapper {\n        width: 180px;\n      }\n\n      .map-settings-input {\n        width: 100%;\n        padding: 10px 14px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px solid rgba(255, 255, 255, 0.2);\n        border-radius: 10px;\n        color: #fff;\n        font-size: 14px;\n        outline: none;\n        transition: all 0.2s;\n      }\n\n      .map-settings-input::placeholder {\n        color: rgba(255, 255, 255, 0.4);\n      }\n\n      .map-settings-input:focus {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: #1d9bf0;\n      }\n\n      /* 标签管理样式 */\n      .map-settings-tags-container {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n        margin-bottom: 16px;\n        min-height: 40px;\n        padding: 12px;\n        background: rgba(255, 255, 255, 0.05);\n        border-radius: 12px;\n      }\n\n      .map-settings-tag {\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        padding: 8px 12px;\n        background: rgba(29, 155, 240, 0.15);\n        border: 1px solid rgba(29, 155, 240, 0.3);\n        border-radius: 20px;\n        color: #1d9bf0;\n        font-size: 13px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .map-settings-tag:hover {\n        background: rgba(29, 155, 240, 0.25);\n        border-color: rgba(29, 155, 240, 0.5);\n      }\n\n      .map-settings-tag-remove {\n        width: 16px;\n        height: 16px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.2);\n        transition: all 0.2s;\n      }\n\n      .map-settings-tag-remove:hover {\n        background: rgba(255, 255, 255, 0.4);\n      }\n\n      .map-settings-tag-remove svg {\n        width: 10px;\n        height: 10px;\n        stroke: currentColor;\n        stroke-width: 2;\n      }\n\n      .map-settings-add-tag-btn {\n        display: inline-flex;\n        align-items: center;\n        gap: 6px;\n        padding: 10px 16px;\n        background: rgba(255, 255, 255, 0.1);\n        border: 1px dashed rgba(255, 255, 255, 0.3);\n        border-radius: 10px;\n        color: rgba(255, 255, 255, 0.7);\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .map-settings-add-tag-btn:hover {\n        background: rgba(255, 255, 255, 0.15);\n        border-color: rgba(255, 255, 255, 0.5);\n        color: #fff;\n      }\n\n      .map-settings-add-tag-btn svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      /* ==================== 社交圈弹窗样式 - Instagram风格 ==================== */\n      .map-social-circle-modal {\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.6);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 105;\n        animation: fadeIn 0.2s ease;\n      }\n\n      .map-social-circle-content {\n        width: 90%;\n        max-width: 500px;\n        max-height: 80%;\n        background: #1a1a1a;\n        border-radius: 24px;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        animation: slideUp 0.3s ease;\n      }\n\n      .map-social-circle-header {\n        display: flex;\n        align-items: center;\n        padding: 20px 24px;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      }\n\n      .map-social-circle-back-btn {\n        width: 32px;\n        height: 32px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: rgba(255, 255, 255, 0.1);\n        border: none;\n        border-radius: 50%;\n        color: #fff;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .map-social-circle-back-btn:hover {\n        background: rgba(255, 255, 255, 0.2);\n      }\n\n      .map-social-circle-back-btn svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      .map-social-circle-title {\n        flex: 1;\n        text-align: center;\n        font-size: 18px;\n        font-weight: 700;\n        color: #fff;\n        letter-spacing: -0.5px;\n      }\n\n      .map-social-circle-placeholder {\n        width: 32px;\n      }\n\n      .map-social-circle-body {\n        flex: 1;\n        overflow-y: auto;\n        padding: 16px;\n      }\n\n      .map-social-circle-body::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-social-circle-body::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-social-circle-body::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.2);\n        border-radius: 3px;\n      }\n\n      /* Empty State */\n      .map-social-circle-empty {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 60px 32px;\n        text-align: center;\n      }\n\n      .map-social-circle-empty svg {\n        width: 64px;\n        height: 64px;\n        color: rgba(255, 255, 255, 0.3);\n        margin-bottom: 20px;\n      }\n\n      .map-social-circle-empty-text {\n        font-size: 18px;\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.8);\n        margin-bottom: 8px;\n      }\n\n      .map-social-circle-empty-desc {\n        font-size: 14px;\n        color: rgba(255, 255, 255, 0.5);\n        line-height: 1.5;\n      }\n\n      /* 社交圈好友列表 */\n      .map-social-circle-list {\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n      }\n\n      /* 好友卡片 */\n      .map-social-circle-friend-card {\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 16px;\n        padding: 16px;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .map-social-circle-friend-card:hover {\n        background: rgba(255, 255, 255, 0.08);\n        border-color: rgba(255, 255, 255, 0.2);\n        transform: translateY(-2px);\n      }\n\n      .map-social-circle-friend-header {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 12px;\n      }\n\n      .map-social-circle-friend-avatar {\n        width: 48px;\n        height: 48px;\n        border-radius: 50%;\n        object-fit: cover;\n      }\n\n      .map-social-circle-friend-info {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .map-social-circle-friend-name {\n        font-size: 16px;\n        font-weight: 600;\n        color: #fff;\n        margin-bottom: 4px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .map-social-circle-friend-handle {\n        font-size: 14px;\n        color: rgba(255, 255, 255, 0.5);\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }\n\n      .map-social-circle-friend-relationship {\n        padding: 4px 12px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 12px;\n        font-size: 12px;\n        font-weight: 500;\n        color: rgba(255, 255, 255, 0.8);\n        white-space: nowrap;\n      }\n\n      .map-social-circle-friend-bio {\n        font-size: 14px;\n        color: rgba(255, 255, 255, 0.7);\n        line-height: 1.5;\n        margin-bottom: 12px;\n        overflow: hidden;\n        display: -webkit-box;\n        -webkit-line-clamp: 2;\n        -webkit-box-orient: vertical;\n      }\n\n      .map-social-circle-friend-stats {\n        display: flex;\n        gap: 16px;\n      }\n\n      .map-social-circle-friend-stat {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        font-size: 13px;\n        color: rgba(255, 255, 255, 0.5);\n      }\n\n      .map-social-circle-friend-stat-value {\n        font-weight: 600;\n        color: rgba(255, 255, 255, 0.8);\n      }\n\n      /* ==================== 聊天弹窗样式 ==================== */\n      .map-chat-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 90%;\n        max-width: 480px;\n        height: 80%;\n        max-height: 700px;\n        background: #000;\n        border-radius: 20px;\n        z-index: 300;\n        display: none;\n        flex-direction: column;\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n        overflow: hidden;\n      }\n\n      .map-chat-modal.show {\n        display: flex;\n      }\n\n      /* 聊天顶栏 */\n      .map-chat-header {\n        display: flex;\n        align-items: center;\n        padding: 16px 20px;\n        border-bottom: 1px solid #2f2f2f;\n        background: #000;\n      }\n\n      .map-chat-back-btn {\n        background: none;\n        border: none;\n        padding: 8px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        margin-right: 12px;\n      }\n\n      .map-chat-back-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        stroke-width: 2;\n        fill: none;\n      }\n\n      .map-chat-user-info {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        flex: 1;\n      }\n\n      .map-chat-user-avatar {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        object-fit: cover;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-chat-user-avatar:hover {\n        transform: scale(1.08);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n      }\n\n      .map-chat-user-avatar:active {\n        transform: scale(0.98);\n      }\n\n      .map-chat-user-name {\n        font-size: 16px;\n        font-weight: 600;\n        color: #fff;\n      }\n\n      .map-chat-more-btn {\n        background: none;\n        border: none;\n        padding: 8px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .map-chat-more-btn svg {\n        width: 20px;\n        height: 20px;\n        fill: #fff;\n      }\n\n      /* More options下拉菜单 */\n      .map-chat-more-menu {\n        position: absolute;\n        top: 56px;\n        right: 12px;\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        min-width: 180px;\n        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);\n        opacity: 0;\n        pointer-events: none;\n        transform: translateY(-10px);\n        transition: all 0.2s ease;\n        z-index: 50;\n      }\n\n      .map-chat-more-menu.show {\n        opacity: 1;\n        pointer-events: all;\n        transform: translateY(0);\n      }\n\n      .map-chat-more-menu-item {\n        width: 100%;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px 16px;\n        background: transparent;\n        border: none;\n        color: #e0e0e0;\n        font-size: 14px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        text-align: left;\n      }\n\n      .map-chat-more-menu-item:hover {\n        background: #333;\n      }\n\n      .map-chat-more-menu-item svg {\n        stroke: #4a9eff;\n        flex-shrink: 0;\n      }\n\n      /* 消息列表区域 */\n      .map-chat-messages {\n        flex: 1;\n        overflow-y: auto;\n        padding: 20px;\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n        background: #000;\n      }\n\n      .map-chat-messages::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-chat-messages::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-chat-messages::-webkit-scrollbar-thumb {\n        background: #3a3a3a;\n        border-radius: 3px;\n      }\n\n      /* 时间戳 */\n      .map-chat-timestamp {\n        text-align: center;\n        font-size: 12px;\n        color: #71767b;\n        margin: 12px 0;\n      }\n\n      /* 消息组（同一发送者的连续消息） */\n      .map-chat-message-group {\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n        margin-bottom: 12px;\n      }\n\n      .map-chat-message-group.sent {\n        align-items: flex-end;\n      }\n\n      .map-chat-message-group.received {\n        align-items: flex-start;\n      }\n\n      /* 消息行（包含头像和气泡） */\n      .map-chat-message-row {\n        display: flex;\n        align-items: flex-end;\n        gap: 8px;\n        max-width: 80%;\n      }\n\n      .map-chat-message-row.sent {\n        flex-direction: row-reverse;\n        margin-left: auto;\n      }\n\n      .map-chat-message-row.received {\n        flex-direction: row;\n        margin-right: auto;\n      }\n\n      /* 头像占位（隐藏时保持布局） */\n      .map-chat-message-avatar-placeholder {\n        width: 36px;\n        height: 36px;\n        flex-shrink: 0;\n        visibility: hidden;\n      }\n\n      .map-chat-message-avatar {\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        object-fit: cover;\n        flex-shrink: 0;\n      }\n\n      /* 消息气泡 */\n      .map-chat-bubble {\n        padding: 12px 16px;\n        font-size: 15px;\n        line-height: 1.4;\n        word-wrap: break-word;\n        position: relative;\n      }\n\n      /* 接收的消息（左侧，黑色边框气泡） */\n      .map-chat-message-row.received .map-chat-bubble {\n        background: #000;\n        border: 1px solid #3a3a3a;\n        border-radius: 18px;\n        border-top-left-radius: 4px;\n        color: #fff;\n      }\n\n      /* 接收消息组中非最后一条的圆角 */\n      .map-chat-message-group.received .map-chat-message-row:not(:last-child) .map-chat-bubble {\n        border-radius: 18px;\n      }\n\n      /* 发送的消息（右侧，灰色气泡） */\n      .map-chat-message-row.sent .map-chat-bubble {\n        background: #3a3a3a;\n        border-radius: 18px;\n        border-top-right-radius: 4px;\n        color: #fff;\n      }\n\n      /* 发送消息组中非最后一条的圆角 */\n      .map-chat-message-group.sent .map-chat-message-row:not(:last-child) .map-chat-bubble {\n        border-radius: 18px;\n      }\n\n      /* 表情包样式 - 不要气泡，直接显示图片 */\n      .map-chat-sticker {\n        max-width: 120px;\n        max-height: 120px;\n        width: auto;\n        height: auto;\n        border-radius: 8px;\n        object-fit: contain;\n        user-select: none;\n        cursor: default;\n        display: block;\n      }\n\n      /* 🚨 系统消息样式 */\n      .map-chat-system-message {\n        display: flex;\n        align-items: flex-start;\n        gap: 12px;\n        padding: 16px;\n        margin: 16px 0;\n        background: rgba(255, 255, 255, 0.05);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 14px;\n        border-left: 3px solid #fff;\n      }\n\n      .map-chat-system-message-icon {\n        width: 20px;\n        height: 20px;\n        flex-shrink: 0;\n        color: #fff;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n\n      .map-chat-system-message-icon svg {\n        width: 100%;\n        height: 100%;\n      }\n\n      .map-chat-system-message-text {\n        flex: 1;\n        font-size: 14px;\n        line-height: 1.5;\n        color: #e5e5e5;\n        font-weight: 500;\n      }\n\n      /* ==================== 🗑️ 删除模式样式 ==================== */\n      /* 删除模式工具栏 */\n      .map-chat-delete-toolbar {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 10px 16px;\n        background: #1a1a1a;\n        border-top: 1px solid #2f2f2f;\n        gap: 12px;\n      }\n\n      .map-chat-delete-left {\n        display: flex;\n        align-items: center;\n      }\n\n      .map-chat-delete-checkbox-wrapper {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        cursor: pointer;\n        user-select: none;\n      }\n\n      .map-chat-delete-checkbox-wrapper input[type="checkbox"] {\n        width: 18px;\n        height: 18px;\n        cursor: pointer;\n      }\n\n      .map-chat-delete-checkbox-wrapper span {\n        font-size: 14px;\n        color: #d0d0d0;\n        font-weight: 500;\n      }\n\n      .map-chat-delete-actions {\n        display: flex;\n        gap: 8px;\n      }\n\n      .map-chat-delete-btn {\n        padding: 8px 12px;\n        border: none;\n        border-radius: 6px;\n        font-size: 13px;\n        font-weight: 500;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        transition: all 0.2s ease;\n        background: #2a2a2a;\n        color: #d0d0d0;\n      }\n\n      .map-chat-delete-btn:hover:not(:disabled) {\n        background: #3a3a3a;\n        color: #fff;\n      }\n\n      .map-chat-delete-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n\n      .map-chat-delete-btn.danger {\n        background: #dc3545;\n        color: #fff;\n      }\n\n      .map-chat-delete-btn.danger:hover {\n        background: #c82333;\n      }\n\n      .map-chat-delete-btn.exit {\n        background: #28a745;\n        color: #fff;\n      }\n\n      .map-chat-delete-btn.exit:hover {\n        background: #218838;\n      }\n\n      .map-chat-delete-btn svg {\n        flex-shrink: 0;\n      }\n\n      /* 删除模式下消息气泡的选中状态 */\n      .map-chat-bubble.delete-mode {\n        cursor: pointer;\n        user-select: none;\n        transition: all 0.2s ease;\n      }\n\n      .map-chat-bubble.delete-mode:hover {\n        transform: scale(0.98);\n        opacity: 0.9;\n      }\n\n      .map-chat-bubble.delete-mode.selected {\n        border: 2px solid #4a9eff;\n        background: rgba(74, 158, 255, 0.15) !important;\n        box-shadow: 0 0 0 4px rgba(74, 158, 255, 0.1);\n      }\n\n      .map-chat-bubble.delete-mode.selected .map-chat-bubble-content {\n        opacity: 0.9;\n      }\n\n      /* 聊天底栏 */\n      .map-chat-footer {\n        display: flex;\n        align-items: center;\n        padding: 12px 16px;\n        border-top: 1px solid #2f2f2f;\n        background: #000;\n        gap: 12px;\n      }\n\n      .map-chat-add-btn {\n        background: none;\n        border: none;\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        flex-shrink: 0;\n        transition: background 0.2s;\n      }\n\n      .map-chat-add-btn:hover {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .map-chat-add-btn svg {\n        width: 24px;\n        height: 24px;\n        stroke: #fff;\n        stroke-width: 2;\n        fill: none;\n      }\n\n      .map-chat-input-wrapper {\n        flex: 1;\n        position: relative;\n      }\n\n      .map-chat-input {\n        width: 100%;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 20px;\n        padding: 10px 16px;\n        color: #fff;\n        font-size: 15px;\n        outline: none;\n        transition: border-color 0.2s;\n      }\n\n      .map-chat-input:focus {\n        border-color: #555;\n      }\n\n      .map-chat-input::placeholder {\n        color: #71767b;\n      }\n\n      .map-chat-like-btn {\n        background: none;\n        border: none;\n        width: 36px;\n        height: 36px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        flex-shrink: 0;\n        transition: background 0.2s;\n      }\n\n      .map-chat-like-btn:hover {\n        background: rgba(255, 255, 255, 0.1);\n      }\n\n      .map-chat-like-btn svg {\n        width: 24px;\n        height: 24px;\n        fill: #fff;\n      }\n\n      /* 聊天遮罩 */\n      .map-chat-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 299;\n        display: none;\n      }\n\n      .map-chat-overlay.show {\n        display: block;\n      }\n\n      /* ==================== 📌 功能收纳菜单样式（简约暗色） ==================== */\n      .map-chat-function-menu-wrapper {\n        position: relative;\n      }\n\n      .map-chat-function-menu {\n        position: absolute;\n        bottom: 100%;\n        left: 0;\n        margin-bottom: 10px;\n        opacity: 0;\n        transform: translateY(10px);\n        transition: all 0.2s ease;\n        pointer-events: none;\n      }\n\n      .map-chat-function-menu.show {\n        opacity: 1;\n        transform: translateY(0);\n        pointer-events: all;\n      }\n\n      .map-chat-function-item {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        width: 40px;\n        height: 40px;\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        color: #888;\n      }\n\n      .map-chat-function-item:hover {\n        background: #333;\n        color: #4a9eff;\n        border-color: #4a9eff;\n      }\n\n      .map-chat-function-item svg {\n        width: 20px;\n        height: 20px;\n      }\n\n      /* ==================== 📌 笔记弹窗样式（简约暗色） ==================== */\n      .map-notes-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 399;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.2s ease;\n      }\n\n      .map-notes-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-notes-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(0.95);\n        width: min(480px, 90vw);\n        max-height: 70vh;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 12px;\n        z-index: 400;\n        opacity: 0;\n        pointer-events: none;\n        transition: all 0.2s ease;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      }\n\n      .map-notes-modal.show {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n        pointer-events: all;\n      }\n\n      .map-notes-container {\n        display: flex;\n        flex-direction: column;\n        flex: 1;\n        min-height: 0;\n        overflow: hidden;\n      }\n\n      /* 头部 */\n      .map-notes-header {\n        padding: 16px 20px;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n\n      .map-notes-main-tabs {\n        display: flex;\n        gap: 4px;\n        background: #2a2a2a;\n        padding: 3px;\n        border-radius: 8px;\n      }\n\n      .map-notes-main-tab {\n        padding: 6px 16px;\n        background: transparent;\n        border: none;\n        border-radius: 6px;\n        font-size: 14px;\n        font-weight: 500;\n        color: #888;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        white-space: nowrap;\n      }\n\n      .map-notes-main-tab:hover {\n        color: #b0b0b0;\n      }\n\n      .map-notes-main-tab.active {\n        background: #1a1a1a;\n        color: #e0e0e0;\n      }\n\n      .map-notes-close {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #888;\n        transition: all 0.2s ease;\n      }\n\n      .map-notes-close:hover {\n        background: #2a2a2a;\n        color: #e0e0e0;\n      }\n\n      /* Tabs过滤 */\n      .map-notes-tabs {\n        padding: 12px 20px;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        gap: 8px;\n        overflow-x: auto;\n        scrollbar-width: none;\n        flex-wrap: nowrap;\n        flex-shrink: 0;\n        align-items: center;\n      }\n\n      .map-notes-tabs::-webkit-scrollbar {\n        display: none;\n      }\n\n      .map-notes-tab {\n        padding: 6px 14px;\n        background: transparent;\n        border: 1px solid #3a3a3a;\n        border-radius: 6px;\n        color: #888;\n        font-size: 13px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        white-space: nowrap;\n        flex-shrink: 0;\n      }\n\n      .map-notes-tab:hover {\n        border-color: #4a9eff;\n        color: #4a9eff;\n      }\n\n      .map-notes-tab.active {\n        background: #4a9eff;\n        border-color: #4a9eff;\n        color: #fff;\n      }\n\n      /* 笔记列表（时间线式） */\n      .map-notes-list {\n        flex: 1;\n        overflow-y: auto;\n        padding: 20px;\n        min-height: 0;\n        -webkit-overflow-scrolling: touch;\n      }\n\n      .map-notes-list::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-notes-list::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-notes-list::-webkit-scrollbar-thumb {\n        background: #3a3a3a;\n        border-radius: 3px;\n      }\n\n      .map-notes-list::-webkit-scrollbar-thumb:hover {\n        background: #4a4a4a;\n      }\n\n      /* 空状态 */\n      .map-notes-empty {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 40px 20px;\n        text-align: center;\n        color: #666;\n      }\n\n      .map-notes-empty svg {\n        color: #3a3a3a;\n        margin-bottom: 16px;\n      }\n\n      .map-notes-empty p {\n        font-size: 15px;\n        font-weight: 500;\n        color: #888;\n        margin: 0 0 8px 0;\n      }\n\n      .map-notes-empty span {\n        font-size: 13px;\n        color: #666;\n      }\n\n      /* 笔记项（时间线式） */\n      .map-notes-item {\n        display: flex;\n        gap: 12px;\n        padding: 16px 0;\n        border-bottom: 1px solid #2a2a2a;\n        animation: noteItemIn 0.3s ease;\n      }\n\n      .map-notes-item:last-child {\n        border-bottom: none;\n      }\n\n      .map-notes-item-icon {\n        width: 36px;\n        height: 36px;\n        flex-shrink: 0;\n        background: #4a9eff;\n        border-radius: 8px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #fff;\n      }\n\n      .map-notes-item-icon svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      .map-notes-item-content {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .map-notes-item-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 6px;\n      }\n\n      .map-notes-item-category {\n        font-size: 13px;\n        font-weight: 500;\n        color: #e0e0e0;\n      }\n\n      .map-notes-item-time {\n        font-size: 12px;\n        color: #666;\n      }\n\n      .map-notes-item-text {\n        font-size: 14px;\n        line-height: 1.5;\n        color: #b0b0b0;\n        word-break: break-word;\n      }\n\n      .map-notes-item-actions {\n        display: flex;\n        gap: 8px;\n        margin-top: 10px;\n      }\n\n      .map-notes-item-action {\n        padding: 5px 12px;\n        background: transparent;\n        border: 1px solid #3a3a3a;\n        border-radius: 5px;\n        color: #888;\n        font-size: 12px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n      }\n\n      .map-notes-item-action:hover {\n        border-color: #4a9eff;\n        color: #4a9eff;\n      }\n\n      .map-notes-item-action svg {\n        width: 14px;\n        height: 14px;\n      }\n\n      @keyframes noteItemIn {\n        from {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      /* ==================== 📌 分类选择菜单（简洁列表） ==================== */\n      .map-notes-picker-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 498;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.2s ease;\n      }\n\n      .map-notes-picker-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-notes-picker {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(0.95);\n        width: min(280px, 85vw);\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        z-index: 499;\n        opacity: 0;\n        pointer-events: none;\n        transition: all 0.2s ease;\n        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n      }\n\n      .map-notes-picker.show {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n        pointer-events: all;\n      }\n\n      .map-notes-picker-header {\n        padding: 14px 16px;\n        border-bottom: 1px solid #3a3a3a;\n        font-size: 14px;\n        font-weight: 600;\n        color: #e0e0e0;\n      }\n\n      .map-notes-picker-list {\n        max-height: 400px;\n        overflow-y: auto;\n      }\n\n      .map-notes-picker-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px 16px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        border-bottom: 1px solid #2a2a2a;\n        color: #b0b0b0;\n      }\n\n      .map-notes-picker-item:last-child {\n        border-bottom: none;\n      }\n\n      .map-notes-picker-item:hover {\n        background: #333;\n      }\n\n      .map-notes-picker-item svg {\n        width: 18px;\n        height: 18px;\n        color: #4a9eff;\n      }\n\n      /* 消息标记高亮效果（简约灰色边框） */\n      .map-chat-bubble.marking {\n        border: 2px solid #4a9eff !important;\n        background: rgba(74, 158, 255, 0.1) !important;\n      }\n\n\n      /* 聊天列表弹窗样式 */\n      .map-chats-list-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 399;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.2s ease;\n      }\n\n      .map-chats-list-overlay.show {\n        opacity: 1;\n        pointer-events: all;\n      }\n\n      .map-chats-list-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(0.95);\n        width: min(420px, 90vw);\n        max-height: 70vh;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 12px;\n        z-index: 400;\n        opacity: 0;\n        pointer-events: none;\n        transition: all 0.2s ease;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n      }\n\n      .map-chats-list-modal.show {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n        pointer-events: all;\n      }\n\n      .map-chats-list-container {\n        display: flex;\n        flex-direction: column;\n        max-height: 70vh;\n        height: 100%;\n      }\n\n      /* 头部 */\n      .map-chats-list-header {\n        padding: 16px 20px;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        flex-shrink: 0;\n      }\n\n      .map-chats-list-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e0e0e0;\n        margin: 0;\n      }\n\n      .map-chats-list-close {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #888;\n        transition: all 0.2s ease;\n      }\n\n      .map-chats-list-close:hover {\n        background: #2a2a2a;\n        color: #e0e0e0;\n      }\n\n      /* 聊天列表内容 */\n      .map-chats-list-content {\n        flex: 1;\n        overflow-y: auto;\n        padding: 12px;\n        min-height: 0;\n      }\n\n      .map-chats-list-content::-webkit-scrollbar {\n        width: 6px;\n      }\n\n      .map-chats-list-content::-webkit-scrollbar-track {\n        background: transparent;\n      }\n\n      .map-chats-list-content::-webkit-scrollbar-thumb {\n        background: #3a3a3a;\n        border-radius: 3px;\n      }\n\n      .map-chats-list-content::-webkit-scrollbar-thumb:hover {\n        background: #4a4a4a;\n      }\n\n      /* 空状态 */\n      .map-chats-list-empty {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 40px 20px;\n        text-align: center;\n        color: #666;\n      }\n\n      .map-chats-list-empty svg {\n        color: #3a3a3a;\n        margin-bottom: 16px;\n      }\n\n      .map-chats-list-empty p {\n        font-size: 15px;\n        font-weight: 500;\n        color: #888;\n        margin: 0 0 8px 0;\n      }\n\n      .map-chats-list-empty span {\n        font-size: 13px;\n        color: #666;\n      }\n\n      /* 聊天项 */\n      .map-chats-list-item {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        padding: 12px;\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 10px;\n        margin-bottom: 8px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        animation: chatItemIn 0.3s ease;\n      }\n\n      .map-chats-list-item:hover {\n        background: #333;\n        border-color: #4a9eff;\n      }\n\n      .map-chats-list-item:last-child {\n        margin-bottom: 0;\n      }\n\n      @keyframes chatItemIn {\n        from {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n\n      .map-chats-list-item-avatar {\n        width: 48px;\n        height: 48px;\n        border-radius: 50%;\n        flex-shrink: 0;\n        object-fit: cover;\n        background: #3a3a3a;\n      }\n\n      .map-chats-list-item-info {\n        flex: 1;\n        min-width: 0;\n      }\n\n      .map-chats-list-item-name {\n        font-size: 14px;\n        font-weight: 500;\n        color: #e0e0e0;\n        margin: 0 0 4px 0;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .map-chats-list-item-preview {\n        font-size: 13px;\n        color: #888;\n        margin: 0;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .map-chats-list-item-delete {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #666;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n      }\n\n      .map-chats-list-item-delete:hover {\n        background: #ff4444;\n        color: #fff;\n      }\n\n      .map-chats-list-item-delete svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      /* 🎯 指定筛选弹窗样式（简约暗色风格） */\n      .map-advanced-filter-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.6);\n        z-index: 498;\n        opacity: 0;\n        visibility: hidden;\n        transition: all 0.3s ease;\n      }\n\n      .map-advanced-filter-overlay.show {\n        opacity: 1;\n        visibility: visible;\n      }\n\n      .map-advanced-filter-modal {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%) scale(0.95);\n        width: min(420px, 90vw);\n        max-height: 80vh;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 12px;\n        z-index: 499;\n        opacity: 0;\n        visibility: hidden;\n        transition: all 0.3s ease;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);\n        display: flex;\n        flex-direction: column;\n      }\n\n      .map-advanced-filter-modal.show {\n        opacity: 1;\n        visibility: visible;\n        transform: translate(-50%, -50%) scale(1);\n      }\n\n      .map-advanced-filter-container {\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n        overflow: hidden;\n      }\n\n      .map-advanced-filter-header {\n        padding: 16px 20px;\n        border-bottom: 1px solid #2a2a2a;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        flex-shrink: 0;\n      }\n\n      .map-advanced-filter-title {\n        font-size: 16px;\n        font-weight: 600;\n        color: #e0e0e0;\n        margin: 0;\n      }\n\n      .map-advanced-filter-close {\n        width: 32px;\n        height: 32px;\n        background: transparent;\n        border: none;\n        border-radius: 6px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #888;\n        transition: all 0.2s ease;\n      }\n\n      .map-advanced-filter-close:hover {\n        background: #2a2a2a;\n        color: #e0e0e0;\n      }\n\n      .map-advanced-filter-form {\n        padding: 20px;\n        overflow-y: auto;\n        flex: 1;\n      }\n\n      .map-filter-field {\n        margin-bottom: 20px;\n      }\n\n      .map-filter-field:last-child {\n        margin-bottom: 0;\n      }\n\n      .map-filter-label {\n        display: block;\n        font-size: 13px;\n        font-weight: 500;\n        color: #b0b0b0;\n        margin-bottom: 8px;\n      }\n\n      .map-filter-radio-group {\n        display: flex;\n        gap: 12px;\n      }\n\n      .map-filter-radio {\n        display: flex;\n        align-items: center;\n        cursor: pointer;\n        user-select: none;\n      }\n\n      .map-filter-radio input[type="radio"] {\n        appearance: none;\n        width: 18px;\n        height: 18px;\n        border: 2px solid #3a3a3a;\n        border-radius: 50%;\n        margin-right: 8px;\n        position: relative;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-filter-radio input[type="radio"]:checked {\n        border-color: #4a9eff;\n      }\n\n      .map-filter-radio input[type="radio"]:checked::before {\n        content: \'\';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 8px;\n        height: 8px;\n        background: #4a9eff;\n        border-radius: 50%;\n      }\n\n      .map-filter-radio span {\n        font-size: 14px;\n        color: #e0e0e0;\n      }\n\n      .map-filter-range {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n\n      .map-filter-input {\n        flex: 1;\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 6px;\n        padding: 10px 12px;\n        color: #e0e0e0;\n        font-size: 14px;\n        outline: none;\n        transition: all 0.2s ease;\n      }\n\n      .map-filter-input:focus {\n        border-color: #4a9eff;\n        background: #252525;\n      }\n\n      .map-filter-separator {\n        color: #888;\n        font-size: 14px;\n      }\n\n      .map-filter-textarea {\n        width: 100%;\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 6px;\n        padding: 10px 12px;\n        color: #e0e0e0;\n        font-size: 14px;\n        outline: none;\n        resize: none;\n        transition: all 0.2s ease;\n      }\n\n      .map-filter-textarea:focus {\n        border-color: #4a9eff;\n        background: #252525;\n      }\n\n      .map-filter-textarea-multi {\n        resize: vertical;\n      }\n\n      .map-filter-textarea::placeholder,\n      .map-filter-input::placeholder {\n        color: #666;\n      }\n\n      .map-advanced-filter-footer {\n        padding: 16px 20px;\n        border-top: 1px solid #2a2a2a;\n        display: flex;\n        gap: 12px;\n        flex-shrink: 0;\n      }\n\n      .map-advanced-filter-btn {\n        flex: 1;\n        padding: 10px 16px;\n        border: none;\n        border-radius: 6px;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.2s ease;\n      }\n\n      .map-advanced-filter-btn-cancel {\n        background: transparent;\n        color: #888;\n        border: 1px solid #3a3a3a;\n      }\n\n      .map-advanced-filter-btn-cancel:hover {\n        background: #2a2a2a;\n        color: #b0b0b0;\n      }\n\n      .map-advanced-filter-btn-clear {\n        background: #2a2a2a;\n        color: #e0e0e0;\n      }\n\n      .map-advanced-filter-btn-clear:hover {\n        background: #333;\n      }\n\n      .map-advanced-filter-btn-apply {\n        background: #4a9eff;\n        color: #fff;\n      }\n\n      .map-advanced-filter-btn-apply:hover {\n        background: #3a8eef;\n      }\n\n      /* 指定筛选按钮样式 */\n      .filter-btn-advanced {\n        margin-left: 4px;\n      }\n\n      .filter-btn-advanced svg {\n        width: 18px;\n        height: 18px;\n      }\n\n      /* ==================== 地标事件系统样式 ==================== */\n\n      /* 有事件的地标样式 */\n      .map-landmark.has-event {\n        position: relative;\n        animation: landmarkPulse 2s ease-in-out infinite;\n      }\n\n      @keyframes landmarkPulse {\n        0%, 100% {\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 0 0 0 rgba(201, 48, 44, 0.7);\n        }\n        50% {\n          box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7), 0 0 0 10px rgba(201, 48, 44, 0);\n        }\n      }\n\n      /* 事件徽章（右上角红点）*/\n      .map-landmark.has-event::after {\n        content: \'\';\n        position: absolute;\n        top: -2px;\n        right: -2px;\n        width: 14px;\n        height: 14px;\n        border-radius: 50%;\n        background: #ff3b30;\n        border: 2px solid var(--map-bg-primary, #1a1a1a);\n        animation: badgePulse 1.5s ease-in-out infinite;\n        z-index: 1;\n      }\n\n      @keyframes badgePulse {\n        0%, 100% {\n          transform: scale(1);\n          opacity: 1;\n        }\n        50% {\n          transform: scale(1.2);\n          opacity: 0.8;\n        }\n      }\n\n      /* 光晕效果 */\n      .map-landmark.has-event::before {\n        content: \'\';\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 70px;\n        height: 70px;\n        border-radius: 50%;\n        background: radial-gradient(circle, rgba(201, 48, 44, 0.3) 0%, transparent 70%);\n        transform: translate(-50%, -50%);\n        animation: landmarkGlow 2s ease-in-out infinite;\n        pointer-events: none;\n        z-index: -1;\n      }\n\n      @keyframes landmarkGlow {\n        0%, 100% {\n          opacity: 0.5;\n          transform: translate(-50%, -50%) scale(1);\n        }\n        50% {\n          opacity: 0.8;\n          transform: translate(-50%, -50%) scale(1.2);\n        }\n      }\n\n      /* ==================== 事件弹窗样式 ==================== */\n\n      /* CSS变量扩展 - 事件系统专用 */\n      :root {\n        --event-bg-primary: #1a1a1a;\n        --event-bg-secondary: #252525;\n        --event-bg-tertiary: #2f2f2f;\n        --event-bg-paper: #1e1e1e;\n        --event-text-primary: #f5f5f5;\n        --event-text-secondary: #d0d0d0;\n        --event-text-muted: #909090;\n        --event-border-light: #3a3a3a;\n        --event-border-medium: #4a4a4a;\n        --event-border-dark: #2a2a2a;\n        --event-accent: #c9302c;\n        --event-accent-hover: #ac2925;\n        --event-overlay: rgba(0, 0, 0, 0.92);\n        --event-shadow-sm: rgba(0, 0, 0, 0.3);\n        --event-shadow-md: rgba(0, 0, 0, 0.5);\n        --event-shadow-lg: rgba(0, 0, 0, 0.7);\n        --event-image-filter: grayscale(0.3) contrast(1.1);\n      }\n\n      /* 浅色主题 - 事件系统变量 */\n      #x-map-container.light-theme {\n        --event-bg-primary: #fefefe;\n        --event-bg-secondary: #f8f8f8;\n        --event-bg-tertiary: #f0f0f0;\n        --event-bg-paper: #ffffff;\n        --event-text-primary: #1a1a1a;\n        --event-text-secondary: #3a3a3a;\n        --event-text-muted: #707070;\n        --event-border-light: #e0e0e0;\n        --event-border-medium: #c0c0c0;\n        --event-border-dark: #a0a0a0;\n        --event-accent: #c9302c;\n        --event-accent-hover: #ac2925;\n        --event-overlay: rgba(0, 0, 0, 0.7);\n        --event-shadow-sm: rgba(0, 0, 0, 0.08);\n        --event-shadow-md: rgba(0, 0, 0, 0.12);\n        --event-shadow-lg: rgba(0, 0, 0, 0.16);\n        --event-image-filter: grayscale(0.2) contrast(1.05);\n      }\n\n      /* Modal 结构 */\n      .event-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: var(--event-overlay);\n        display: none;\n        align-items: center;\n        justify-content: center;\n        z-index: 100000;\n        padding: 20px;\n        animation: eventFadeIn 0.25s ease;\n        overflow-y: auto;\n        backdrop-filter: blur(8px);\n      }\n\n      .event-modal-overlay.active {\n        display: flex;\n      }\n\n      @keyframes eventFadeIn {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n\n      .event-modal-container {\n        background: var(--event-bg-paper);\n        width: 100%;\n        max-width: 720px;\n        max-height: 90vh;\n        border-radius: 4px;\n        box-shadow:\n          0 0 0 1px var(--event-border-medium),\n          0 20px 60px var(--event-shadow-lg);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n        animation: eventSlideUp 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);\n        position: relative;\n      }\n\n      @keyframes eventSlideUp {\n        from {\n          opacity: 0;\n          transform: translateY(40px) scale(0.96);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n      }\n\n      .event-controls {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        display: flex;\n        gap: 10px;\n        z-index: 10;\n      }\n\n      .event-btn {\n        width: 40px;\n        height: 40px;\n        border: 1px solid var(--event-border-medium);\n        background: var(--event-bg-primary);\n        color: var(--event-text-primary);\n        border-radius: 50%;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 20px;\n        transition: all 0.2s ease;\n        backdrop-filter: blur(10px);\n        box-shadow: 0 2px 12px var(--event-shadow-md);\n      }\n\n      .event-btn:hover {\n        background: var(--event-accent);\n        border-color: var(--event-accent);\n        color: white;\n        transform: scale(1.08);\n      }\n\n      .event-btn:active {\n        transform: scale(0.92);\n      }\n\n      .event-content {\n        padding: 0;\n        overflow-y: auto;\n        flex: 1;\n      }\n\n      /* 报纸头部 */\n      .event-paper-header {\n        border-bottom: 3px double var(--event-border-dark);\n        padding: 24px 32px 16px;\n        background: var(--event-bg-secondary);\n        position: relative;\n      }\n\n      .event-paper-header::before,\n      .event-paper-header::after {\n        content: \'\';\n        position: absolute;\n        left: 0;\n        right: 0;\n        height: 1px;\n        background: var(--event-border-light);\n      }\n\n      .event-paper-header::before { top: 0; }\n      .event-paper-header::after { bottom: 0; }\n\n      .event-masthead {\n        font-family: "Playfair Display", serif;\n        font-size: 36px;\n        font-weight: 900;\n        text-align: center;\n        letter-spacing: 2px;\n        color: var(--event-text-primary);\n        margin-bottom: 8px;\n        text-transform: uppercase;\n      }\n\n      .event-tagline {\n        font-family: "Courier New", monospace;\n        font-size: 11px;\n        text-align: center;\n        color: var(--event-text-muted);\n        letter-spacing: 1.5px;\n        text-transform: uppercase;\n      }\n\n      .event-header-meta {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-top: 12px;\n        padding-top: 12px;\n        border-top: 1px solid var(--event-border-light);\n        font-size: 11px;\n        color: var(--event-text-muted);\n        font-family: "Courier New", monospace;\n      }\n\n      /* 文章内容区 */\n      .event-article {\n        padding: 32px 40px 40px;\n      }\n\n      .event-tags {\n        margin-bottom: 20px;\n      }\n\n      .event-tag {\n        display: inline-block;\n        background: var(--event-accent);\n        color: white;\n        font-size: 10px;\n        font-weight: 700;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        padding: 5px 12px;\n        border-radius: 2px;\n        margin-right: 6px;\n        margin-bottom: 8px;\n      }\n\n      .event-tag.secondary {\n        background: var(--event-bg-tertiary);\n        color: var(--event-text-primary);\n        border: 1px solid var(--event-border-medium);\n      }\n\n      .event-headline {\n        font-family: "Playfair Display", serif;\n        font-size: 42px;\n        font-weight: 900;\n        line-height: 1.15;\n        color: var(--event-text-primary);\n        margin-bottom: 16px;\n        letter-spacing: -0.8px;\n      }\n\n      .event-subheadline {\n        font-family: "Merriweather", serif;\n        font-size: 26px;\n        font-weight: 700;\n        line-height: 1.3;\n        color: var(--event-text-primary);\n        margin-top: 32px;\n        margin-bottom: 14px;\n      }\n\n      .event-title {\n        font-family: "Merriweather", serif;\n        font-size: 20px;\n        font-weight: 700;\n        color: var(--event-text-primary);\n        margin-top: 24px;\n        margin-bottom: 12px;\n      }\n\n      .event-lead {\n        font-family: "Libre Baskerville", serif;\n        font-size: 20px;\n        line-height: 1.7;\n        color: var(--event-text-secondary);\n        margin-bottom: 24px;\n        font-weight: 400;\n      }\n\n      .event-body {\n        font-family: "Crimson Text", serif;\n        font-size: 19px;\n        line-height: 1.8;\n        color: var(--event-text-secondary);\n        margin-bottom: 18px;\n      }\n\n      .event-body-sans {\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;\n        font-size: 16px;\n        line-height: 1.7;\n        color: var(--event-text-secondary);\n        margin-bottom: 16px;\n      }\n\n      .event-caption {\n        font-size: 14px;\n        line-height: 1.6;\n        color: var(--event-text-muted);\n        font-style: italic;\n      }\n\n      .event-drop-cap::first-letter {\n        font-family: "Playfair Display", serif;\n        font-size: 80px;\n        font-weight: 900;\n        line-height: 0.85;\n        float: left;\n        margin: 8px 12px 0 0;\n        color: var(--event-accent);\n      }\n\n      .event-quote {\n        font-family: "Libre Baskerville", serif;\n        font-size: 22px;\n        font-style: italic;\n        line-height: 1.65;\n        color: var(--event-text-primary);\n        border-left: 3px solid var(--event-accent);\n        padding-left: 24px;\n        margin: 32px 0;\n        position: relative;\n      }\n\n      .event-quote::before {\n        content: \'"\';\n        font-family: "Playfair Display", serif;\n        font-size: 60px;\n        position: absolute;\n        left: -10px;\n        top: -15px;\n        color: var(--event-accent);\n        opacity: 0.3;\n      }\n\n      .event-quote-author {\n        font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n        font-size: 14px;\n        font-style: normal;\n        font-weight: 600;\n        color: var(--event-text-muted);\n        margin-top: 10px;\n        text-transform: uppercase;\n        letter-spacing: 0.8px;\n      }\n\n      .event-byline {\n        font-size: 13px;\n        color: var(--event-text-muted);\n        margin-bottom: 20px;\n        padding-bottom: 20px;\n        border-bottom: 1px solid var(--event-border-light);\n      }\n\n      .event-byline strong {\n        color: var(--event-text-primary);\n        font-weight: 600;\n      }\n\n      .event-divider {\n        border: none;\n        border-top: 1px solid var(--event-border-light);\n        margin: 28px 0;\n      }\n\n      .event-divider-thick {\n        border: none;\n        border-top: 3px solid var(--event-text-primary);\n        margin: 32px 0;\n      }\n\n      .event-divider-double {\n        border: none;\n        border-top: 3px double var(--event-border-dark);\n        margin: 28px 0;\n      }\n\n      .event-list {\n        margin: 20px 0;\n        padding-left: 28px;\n      }\n\n      .event-list li {\n        font-family: "Crimson Text", serif;\n        font-size: 19px;\n        line-height: 1.8;\n        color: var(--event-text-secondary);\n        margin-bottom: 10px;\n      }\n\n      .event-list-clean {\n        list-style: none;\n        padding-left: 0;\n      }\n\n      .event-list-clean li {\n        padding-left: 24px;\n        position: relative;\n      }\n\n      .event-list-clean li::before {\n        content: \'•\';\n        position: absolute;\n        left: 8px;\n        color: var(--event-accent);\n        font-weight: bold;\n      }\n\n      .event-box {\n        background: var(--event-bg-secondary);\n        border: 1px solid var(--event-border-medium);\n        padding: 20px 24px;\n        border-radius: 3px;\n        margin: 28px 0;\n      }\n\n      .event-box-highlight {\n        background: var(--event-bg-tertiary);\n        border-left: 4px solid var(--event-accent);\n        padding: 20px 24px;\n        margin: 28px 0;\n      }\n\n      .event-box-alert {\n        background: var(--event-accent);\n        color: white;\n        padding: 20px 24px;\n        border-radius: 3px;\n        margin: 28px 0;\n        font-weight: 600;\n      }\n\n      .event-box-alert * {\n        color: white !important;\n      }\n\n      .event-table {\n        width: 100%;\n        border-collapse: collapse;\n        margin: 28px 0;\n        font-size: 15px;\n        border: 1px solid var(--event-border-medium);\n      }\n\n      .event-table th {\n        background: var(--event-bg-secondary);\n        color: var(--event-text-primary);\n        font-weight: 700;\n        text-align: left;\n        padding: 14px 16px;\n        border-bottom: 2px solid var(--event-border-dark);\n        font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n        font-size: 13px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n\n      .event-table td {\n        padding: 14px 16px;\n        border-bottom: 1px solid var(--event-border-light);\n        color: var(--event-text-secondary);\n        font-family: "Crimson Text", serif;\n        font-size: 17px;\n      }\n\n      .event-table tr:last-child td {\n        border-bottom: none;\n      }\n\n      .event-columns-2 {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 24px;\n        margin: 28px 0;\n      }\n\n      .event-sidebar-box {\n        background: var(--event-bg-secondary);\n        border: 1px solid var(--event-border-medium);\n        padding: 20px;\n        margin-bottom: 20px;\n      }\n\n      .event-sidebar-box h3 {\n        font-family: "Merriweather", serif;\n        font-size: 16px;\n        font-weight: 700;\n        margin-bottom: 12px;\n        color: var(--event-text-primary);\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n\n      .event-emphasis {\n        color: var(--event-accent);\n        font-weight: 600;\n      }\n\n      .event-bold {\n        font-weight: 700;\n        color: var(--event-text-primary);\n      }\n\n      .event-footer {\n        border-top: 3px double var(--event-border-dark);\n        padding: 20px 40px;\n        background: var(--event-bg-secondary);\n        text-align: center;\n        font-size: 11px;\n        color: var(--event-text-muted);\n        font-family: "Courier New", monospace;\n        letter-spacing: 1px;\n      }\n\n      /* 响应式 */\n      @media (max-width: 768px) {\n        .event-modal-overlay {\n          padding: 0;\n          align-items: flex-end;\n        }\n\n        .event-modal-container {\n          max-width: 100%;\n          max-height: 95vh;\n          border-radius: 12px 12px 0 0;\n        }\n\n        .event-paper-header {\n          padding: 20px 20px 14px;\n        }\n\n        .event-masthead {\n          font-size: 28px;\n        }\n\n        .event-article {\n          padding: 24px 20px 32px;\n        }\n\n        .event-headline {\n          font-size: 32px;\n        }\n\n        .event-subheadline {\n          font-size: 22px;\n        }\n\n        .event-lead {\n          font-size: 18px;\n        }\n\n        .event-body {\n          font-size: 17px;\n        }\n\n        .event-quote {\n          font-size: 19px;\n          padding-left: 20px;\n        }\n\n        .event-columns-2 {\n          grid-template-columns: 1fr;\n          gap: 16px;\n        }\n\n        .event-controls {\n          top: 16px;\n          right: 16px;\n        }\n\n        .event-btn {\n          width: 36px;\n          height: 36px;\n          font-size: 18px;\n        }\n\n        .event-footer {\n          padding: 16px 20px;\n        }\n      }\n    ',document.head.appendChild(n)}();let e=document.getElementById("x-map-container");e||(e=document.createElement("div"),e.id="x-map-container",e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        z-index: 9999;\n        background: #000;\n      ",document.body.appendChild(e)),e.innerHTML=`\n      <div id="map-dating-container">\n        \x3c!-- 侧边栏遮罩 --\x3e\n        <div class="map-sidebar-overlay" id="mapSidebarOverlay"></div>\n\n        \x3c!-- 左侧边栏 --\x3e\n        <div class="map-sidebar" id="mapSidebar">\n          <div class="map-header">\n            <button class="map-back-btn" id="mapBackBtn">\n              ${gs}\n            </button>\n            <h2>附近的人</h2>\n          </div>\n\n          <div class="map-search-box">\n            <input type="text" placeholder="搜索..." id="mapSearchInput">\n          </div>\n\n          <div class="map-filters">\n            <div class="filter-group">\n              <select class="filter-select" id="mapDistanceFilter">\n                <option value="all">全部距离</option>\n                <option value="1">1km内</option>\n                <option value="3">3km内</option>\n                <option value="5">5km内</option>\n              </select>\n              <select class="filter-select" id="mapGenderFilter">\n                <option value="all">不限性别</option>\n                <option value="male">男性</option>\n                <option value="female">女性</option>\n              </select>\n            </div>\n            <button class="filter-btn" id="mapApplyFilterBtn">\n              ${vs}\n            </button>\n            <button class="filter-btn filter-btn-advanced" id="mapAdvancedFilterBtn" title="指定筛选">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="4" y1="21" x2="4" y2="14"></line>\n                <line x1="4" y1="10" x2="4" y2="3"></line>\n                <line x1="12" y1="21" x2="12" y2="12"></line>\n                <line x1="12" y1="8" x2="12" y2="3"></line>\n                <line x1="20" y1="21" x2="20" y2="16"></line>\n                <line x1="20" y1="12" x2="20" y2="3"></line>\n                <line x1="1" y1="14" x2="7" y2="14"></line>\n                <line x1="9" y1="8" x2="15" y2="8"></line>\n                <line x1="17" y1="16" x2="23" y2="16"></line>\n              </svg>\n            </button>\n          </div>\n\n          <div class="map-user-list" id="mapUserList">\n            \x3c!-- 动态生成用户列表 --\x3e\n          </div>\n        </div>\n\n        \x3c!-- 右侧地图区域 --\x3e\n        <div class="map-area" id="mapArea">\n          \x3c!-- 关闭按钮 --\x3e\n          <button class="map-close-btn" id="mapCloseBtn">\n            ${ms}\n          </button>\n\n          \x3c!-- 刷新按钮 --\x3e\n          <button class="map-refresh-btn" id="mapRefreshBtn" title="刷新附近的人">\n            ${xs}\n          </button>\n\n          \x3c!-- 聊天列表按钮 --\x3e\n          <button class="map-chats-btn" id="mapChatsBtn" title="Saved Chats">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n            </svg>\n          </button>\n\n          \x3c!-- 提醒按钮 --\x3e\n          <button class="map-notifications-btn" id="mapNotificationsBtn" title="Notifications">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>\n              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>\n            </svg>\n            <div class="map-notifications-badge hidden" id="mapNotificationsBadge">0</div>\n          </button>\n\n          \x3c!-- 咩三三报纸按钮 --\x3e\n          <button class="map-newspaper-btn" id="mapNewspaperBtn" title="咩三三的城市报纸">\n            ${Cs}\n          </button>\n\n          \x3c!-- 城市乘车按钮 --\x3e\n          <button class="map-ride-btn" id="mapRideBtn" title="城市乘车">\n            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />\n              <path d="M12 17l-1 -4l-4 -1l9 -4z" />\n            </svg>\n          </button>\n\n          \x3c!-- 应用设置按钮 --\x3e\n          <button class="map-app-settings-btn" id="mapAppSettingsBtn" title="Settings">\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <circle cx="12" cy="12" r="3"></circle>\n              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>\n            </svg>\n          </button>\n\n          \x3c!-- 滑动提示 --\x3e\n          <div class="map-swipe-hint" id="mapSwipeHint">\n            👈 向右滑动查看附近的人\n          </div>\n\n          <div class="map-controls">\n            \x3c!-- 天气信息显示 - 放在我的位置上方 --\x3e\n            <div class="map-weather-info map-control-btn" id="mapWeatherInfo" style="display: none;" data-weather-name="晴天">\n              <span class="map-weather-icon" id="mapWeatherIcon">☀️</span>\n            </div>\n\n            <button class="map-control-btn" title="我的位置" id="mapCenterBtn">\n              ${hs}\n            </button>\n            <button class="map-control-btn" title="放大" id="mapZoomInBtn">\n              ${fs}\n            </button>\n            <button class="map-control-btn" title="缩小" id="mapZoomOutBtn">\n              ${bs}\n            </button>\n          </div>\n\n          \x3c!-- 天气特效容器 --\x3e\n          <div class="map-weather-container" id="mapWeatherContainer"></div>\n\n          <div class="map-canvas" id="mapCanvas">\n            \x3c!-- Canvas地图背景 --\x3e\n            <canvas id="mapCanvasBg"></canvas>\n            \x3c!-- 动态生成地图标记 --\x3e\n          </div>\n\n          \x3c!-- 地图选点提示条 --\x3e\n          <div class="map-landmark-pick-hint" id="mapLandmarkPickHint" style="display: none;">\n            <span style="font-size: 18px;">📍</span>\n            <span>Click on the map to place your landmark</span>\n            <button class="map-landmark-cancel-btn" onclick="MapDatingController.cancelLandmarkPick()">\n              <span>✕</span>\n            </button>\n          </div>\n\n          \x3c!-- 用户详情卡片 - TikTok风格 --\x3e\n          <div class="map-user-detail-card" id="mapUserDetailCard" style="display: none;">\n            \x3c!-- TikTok风格顶部Header --\x3e\n            <div class="card-header">\n              \x3c!-- 左侧返回按钮（有功能） --\x3e\n              <button class="card-back-btn" id="mapCardCloseBtn">\n                <svg viewBox="0 0 24 24">\n                  <line x1="19" y1="12" x2="5" y2="12"></line>\n                  <polyline points="12 19 5 12 12 5"></polyline>\n                </svg>\n              </button>\n\n              \x3c!-- 中间昵称（居中显示，无认证标志） --\x3e\n              <div class="card-header-center">\n                <span class="card-header-nickname" id="mapCardNickname">昵称</span>\n              </div>\n\n              \x3c!-- 右侧装饰按钮（铃铛和分享） --\x3e\n              <div class="card-header-actions">\n                <button class="card-action-btn" id="mapCardReviewsBtn">\n                  <svg viewBox="0 0 24 24" fill="currentColor">\n                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>\n                  </svg>\n                </button>\n                <button class="card-action-btn" id="mapCardSettingsBtn">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <polygon points="5 3 19 12 5 21 5 3"></polygon>\n                  </svg>\n                </button>\n              </div>\n            </div>\n\n            \x3c!-- 头像区域 --\x3e\n            <div class="card-avatar-section">\n              <div class="card-avatar-wrapper">\n                <img class="card-avatar" id="mapCardAvatar" src="" alt="">\n                <div class="card-avatar-bubble" id="mapCardAvatarBubble">😊</div>\n              </div>\n\n              <div class="card-user-info">\n                <div class="card-handle">\n                  <span id="mapCardHandle">@handle</span>\n                  <svg class="card-header-verified" viewBox="0 0 24 24" fill="currentColor" style="display: inline-block; vertical-align: middle; margin-left: 4px;">\n                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n                  </svg>\n                </div>\n              </div>\n\n              \x3c!-- 统计数据 --\x3e\n              <div class="card-stats">\n                <div class="card-stat-item">\n                  <span class="card-stat-value">0</span>\n                  <span class="card-stat-label">Following</span>\n                </div>\n                <div class="card-stat-item">\n                  <span class="card-stat-value" id="mapCardFollowers">0</span>\n                  <span class="card-stat-label">Followers</span>\n                </div>\n                <div class="card-stat-item">\n                  <span class="card-stat-value" id="mapCardLikes">0</span>\n                  <span class="card-stat-label">Likes</span>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 按钮组 - TikTok风格3个按钮 --\x3e\n            <div class="card-buttons">\n              <button class="card-btn card-btn-message" id="mapSendMsgBtn">\n                <svg viewBox="0 0 24 24" fill="currentColor">\n                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n                </svg>\n                Message\n              </button>\n              <button class="card-btn card-btn-secondary" id="mapSocialCircleBtn">\n                <svg viewBox="0 0 24 24" fill="currentColor">\n                  <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>\n                </svg>\n              </button>\n              <div class="card-btn-dropdown-wrapper" id="mapViewProfileDropdownWrapper">\n                <button class="card-btn card-btn-secondary" id="mapViewProfileBtn">\n                  <svg viewBox="0 0 24 24" fill="currentColor">\n                    <path d="M7 10l5 5 5-5z"/>\n                  </svg>\n                </button>\n                \x3c!-- 下拉菜单 --\x3e\n                <div class="card-dropdown-menu" id="mapProfileDropdownMenu">\n                  <button class="card-dropdown-item" id="mapViewMomentsBtn">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">\n                      <path d="M7 3m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />\n                      <path d="M4.012 7.26a2.005 2.005 0 0 0 -1.012 1.737v10c0 1.1 .9 2 2 2h10c.75 0 1.158 -.385 1.5 -1" />\n                      <path d="M17 7h.01" />\n                      <path d="M7 13l3.644 -3.644a1.21 1.21 0 0 1 1.712 0l3.644 3.644" />\n                      <path d="M15 12l1.644 -1.644a1.21 1.21 0 0 1 1.712 0l2.644 2.644" />\n                    </svg>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 简介部分 --\x3e\n            <div class="card-bio-section">\n              <div class="card-bio" id="mapCardBio">个人简介...</div>\n\n              <div class="card-tags" id="mapCardTags">\n                \x3c!-- 动态生成标签 --\x3e\n              </div>\n\n              <div class="card-distance-info" id="mapCardDistanceInfo">\n                <svg viewBox="0 0 24 24"><path d="M10 9l-3 3l3 3"/><path d="M14 9l3 3l-3 3"/></svg>\n                <span id="mapCardDistance">1.2km</span>\n              </div>\n            </div>\n\n            \x3c!-- 评价/留言弹窗 --\x3e\n            <div class="card-reviews-section" id="mapCardReviewsSection">\n              <div class="reviews-header">\n                <div class="reviews-header-top">\n                  <button class="reviews-back-btn" id="mapReviewsBackBtn">\n                    <svg viewBox="0 0 24 24">\n                      <line x1="19" y1="12" x2="5" y2="12"></line>\n                      <polyline points="12 19 5 12 12 5"></polyline>\n                    </svg>\n                  </button>\n                  <div class="reviews-title">评价</div>\n                  <div class="reviews-placeholder"></div>\n                </div>\n\n                <div class="reviews-summary" id="mapReviewsSummary">\n                  <div class="reviews-rating-big">\n                    <div>\n                      <span class="reviews-rating-number" id="mapReviewsAvgRating">4.8</span>\n                      <span class="reviews-rating-max">/5</span>\n                    </div>\n                    <div class="reviews-stars" id="mapReviewsStars">\n                      \x3c!-- 动态生成星星 --\x3e\n                    </div>\n                    <div class="reviews-count" id="mapReviewsCount">0条评价</div>\n                  </div>\n                </div>\n              </div>\n\n              <div class="reviews-list" id="mapReviewsList">\n                \x3c!-- 动态生成评价列表 --\x3e\n              </div>\n            </div>\n\n            \x3c!-- 地图设置弹窗 - Instagram风格 --\x3e\n            <div class="map-settings-modal" id="mapSettingsModal" style="display: none;">\n              <div class="map-settings-content">\n                \x3c!-- 顶部Header --\x3e\n                <div class="map-settings-header">\n                  <button class="map-settings-back-btn" id="mapSettingsBackBtn">\n                    <svg viewBox="0 0 24 24">\n                      <line x1="19" y1="12" x2="5" y2="12"></line>\n                      <polyline points="12 19 5 12 12 5"></polyline>\n                    </svg>\n                  </button>\n                  <div class="map-settings-title">地图资料设置</div>\n                  <button class="map-settings-save-btn" id="mapSettingsSaveBtn">完成</button>\n                </div>\n\n                \x3c!-- 设置表单内容 --\x3e\n                <div class="map-settings-body">\n                  \x3c!-- 基本资料编辑 --\x3e\n                  <div class="map-settings-section">\n                    <div class="map-settings-section-title">基本资料</div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">昵称</div>\n                        <div class="map-settings-item-desc">你的显示名称</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="text" id="mapSettingsNickname" class="map-settings-input" placeholder="输入昵称" maxlength="20">\n                      </div>\n                    </div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">句柄</div>\n                        <div class="map-settings-item-desc">@用户名（纯英文小写+数字+下划线）</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="text" id="mapSettingsHandle" class="map-settings-input" placeholder="username_123" maxlength="15">\n                      </div>\n                    </div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">粉丝数</div>\n                        <div class="map-settings-item-desc">followers数量（100-50000）</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="number" id="mapSettingsFollowers" class="map-settings-input" placeholder="1000" min="100" max="50000">\n                      </div>\n                    </div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">获赞数</div>\n                        <div class="map-settings-item-desc">likes数量（粉丝数的10-50倍）</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="number" id="mapSettingsLikes" class="map-settings-input" placeholder="15000" min="1000" max="2500000">\n                      </div>\n                    </div>\n                  </div>\n\n                  \x3c!-- 头像气泡设置 --\x3e\n                  <div class="map-settings-section">\n                    <div class="map-settings-section-title">头像气泡</div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">启用头像气泡</div>\n                        <div class="map-settings-item-desc">在地图标记上显示气泡</div>\n                      </div>\n                      <div class="map-settings-toggle">\n                        <input type="checkbox" id="mapSettingsAvatarBubbleEnabled" class="map-settings-toggle-input">\n                        <label for="mapSettingsAvatarBubbleEnabled" class="map-settings-toggle-label"></label>\n                      </div>\n                    </div>\n\n                    <div class="map-settings-item" id="mapSettingsAvatarBubbleTextSection">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">气泡内容</div>\n                        <div class="map-settings-item-desc">单个emoji或1-2个颜文字</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="text" id="mapSettingsAvatarBubbleText" class="map-settings-input" placeholder="👋" maxlength="4">\n                      </div>\n                    </div>\n                  </div>\n\n                  \x3c!-- 状态气泡设置 --\x3e\n                  <div class="map-settings-section">\n                    <div class="map-settings-section-title">状态气泡</div>\n\n                    <div class="map-settings-item">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">启用状态气泡</div>\n                        <div class="map-settings-item-desc">在地图标记上显示状态</div>\n                      </div>\n                      <div class="map-settings-toggle">\n                        <input type="checkbox" id="mapSettingsStatusEnabled" class="map-settings-toggle-input">\n                        <label for="mapSettingsStatusEnabled" class="map-settings-toggle-label"></label>\n                      </div>\n                    </div>\n\n                    <div class="map-settings-item" id="mapSettingsStatusTextSection">\n                      <div class="map-settings-item-left">\n                        <div class="map-settings-item-label">状态内容</div>\n                        <div class="map-settings-item-desc">显示你的当前状态</div>\n                      </div>\n                      <div class="map-settings-input-wrapper">\n                        <input type="text" id="mapSettingsStatusText" class="map-settings-input" placeholder="探索中..." maxlength="20">\n                      </div>\n                    </div>\n                  </div>\n\n                  \x3c!-- 标签管理 --\x3e\n                  <div class="map-settings-section">\n                    <div class="map-settings-section-title">个人标签</div>\n                    <div class="map-settings-tags-container" id="mapSettingsTagsContainer">\n                      \x3c!-- 动态生成标签 --\x3e\n                    </div>\n                    <button class="map-settings-add-tag-btn" id="mapSettingsAddTagBtn">\n                      <svg viewBox="0 0 24 24" fill="currentColor">\n                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>\n                      </svg>\n                      添加标签\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 社交圈弹窗 - Instagram风格 --\x3e\n            <div class="map-social-circle-modal" id="mapSocialCircleModal" style="display: none;">\n              <div class="map-social-circle-content">\n                \x3c!-- 顶部Header --\x3e\n                <div class="map-social-circle-header">\n                  <button class="map-social-circle-back-btn" id="mapSocialCircleBackBtn">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                      <line x1="19" y1="12" x2="5" y2="12"></line>\n                      <polyline points="12 19 5 12 12 5"></polyline>\n                    </svg>\n                  </button>\n                  <div class="map-social-circle-title">Social Circle</div>\n                  <div class="map-social-circle-placeholder"></div>\n                </div>\n\n                \x3c!-- 社交圈好友列表 --\x3e\n                <div class="map-social-circle-body" id="mapSocialCircleBody">\n                  \x3c!-- Empty state --\x3e\n                  <div class="map-social-circle-empty" id="mapSocialCircleEmpty">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                      <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>\n                    </svg>\n                    <div class="map-social-circle-empty-text">No friends in social circle yet</div>\n                    <div class="map-social-circle-empty-desc">Friends will appear here as you chat</div>\n                  </div>\n\n                  \x3c!-- 社交圈列表 --\x3e\n                  <div class="map-social-circle-list" id="mapSocialCircleList">\n                    \x3c!-- 动态生成好友卡片 --\x3e\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 动态(Moments)弹窗 --\x3e\n      <div class="map-moments-modal" id="mapMomentsModal" style="display: none;">\n        <button class="moments-close-btn" id="mapMomentsCloseBtn">\n          <svg viewBox="0 0 24 24" fill="none">\n            <line x1="18" y1="6" x2="6" y2="18"/>\n            <line x1="6" y1="6" x2="18" y2="18"/>\n          </svg>\n        </button>\n\n        <div class="moments-cards-wrapper" id="mapMomentsCardsWrapper"></div>\n\n        <div class="moments-indicator" id="mapMomentsIndicator"></div>\n\n        \x3c!-- 空状态 --\x3e\n        <div class="moments-empty-state" id="mapMomentsEmptyState" style="display: none;">\n          <svg viewBox="0 0 24 24" fill="none">\n            <path d="M7 3m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" />\n            <path d="M4.012 7.26a2.005 2.005 0 0 0 -1.012 1.737v10c0 1.1 .9 2 2 2h10c.75 0 1.158 -.385 1.5 -1" />\n            <path d="M17 7h.01" />\n            <path d="M7 13l3.644 -3.644a1.21 1.21 0 0 1 1.712 0l3.644 3.644" />\n            <path d="M15 12l1.644 -1.644a1.21 1.21 0 0 1 1.712 0l2.644 2.644" />\n          </svg>\n          <div>No moments yet</div>\n        </div>\n\n        \x3c!-- 动态评论弹窗 --\x3e\n        <div class="moments-comments-overlay" id="mapMomentsCommentsOverlay"></div>\n        <div class="moments-comments-drawer" id="mapMomentsCommentsDrawer">\n          <div class="moments-comments-drawer-handle"></div>\n          <div class="moments-comments-drawer-header">\n            <div class="moments-comments-drawer-title" id="mapMomentsCommentsTitle">Comments</div>\n            <button class="moments-comments-drawer-close" id="mapMomentsCommentsClose">\n              <svg viewBox="0 0 24 24" fill="none">\n                <line x1="18" y1="6" x2="6" y2="18"/>\n                <line x1="6" y1="6" x2="18" y2="18"/>\n              </svg>\n            </button>\n          </div>\n          <div class="moments-comments-list" id="mapMomentsCommentsList"></div>\n        </div>\n      </div>\n\n      \x3c!-- 聊天弹窗遮罩 --\x3e\n      <div class="map-chat-overlay" id="mapChatOverlay"></div>\n\n      \x3c!-- 聊天弹窗 --\x3e\n      <div class="map-chat-modal" id="mapChatModal">\n        \x3c!-- 聊天顶栏 --\x3e\n        <div class="map-chat-header">\n          <button class="map-chat-back-btn" id="mapChatBackBtn">\n            ${$s}\n          </button>\n          <div class="map-chat-user-info">\n            <img class="map-chat-user-avatar" id="mapChatUserAvatar" src="" alt="Avatar">\n            <span class="map-chat-user-name" id="mapChatUserName">User Name</span>\n          </div>\n          <button class="map-chat-more-btn" id="mapChatMoreBtn">\n            ${ks}\n          </button>\n          \x3c!-- More options下拉菜单 --\x3e\n          <div class="map-chat-more-menu" id="mapChatMoreMenu">\n            <button class="map-chat-more-menu-item" id="mapChatAddToListBtn">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="12" y1="5" x2="12" y2="19"></line>\n                <line x1="5" y1="12" x2="19" y2="12"></line>\n              </svg>\n              <span>Add to Chats</span>\n            </button>\n            <button class="map-chat-more-menu-item" id="mapChatReportBtn">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n                <line x1="12" y1="9" x2="12" y2="13"></line>\n                <line x1="12" y1="17" x2="12.01" y2="17"></line>\n              </svg>\n              <span>Report User</span>\n            </button>\n            <button class="map-chat-more-menu-item" id="mapChatManageBtn">\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"></polyline>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                <line x1="10" y1="11" x2="10" y2="17"></line>\n                <line x1="14" y1="11" x2="14" y2="17"></line>\n              </svg>\n              <span>Manage Messages</span>\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- 消息列表 --\x3e\n        <div class="map-chat-messages" id="mapChatMessages">\n          \x3c!-- 消息将动态生成 --\x3e\n        </div>\n\n        \x3c!-- 删除模式工具栏（默认隐藏） --\x3e\n        <div class="map-chat-delete-toolbar" id="mapChatDeleteToolbar" style="display: none;">\n          <div class="map-chat-delete-left">\n            <label class="map-chat-delete-checkbox-wrapper">\n              <input type="checkbox" id="mapChatDeleteSelectAll">\n              <span>Select All</span>\n            </label>\n          </div>\n          <div class="map-chat-delete-actions">\n            <button class="map-chat-delete-btn" id="mapChatDeleteSelected" disabled>\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="3 6 5 6 21 6"></polyline>\n                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n              </svg>\n              Delete\n            </button>\n            <button class="map-chat-delete-btn danger" id="mapChatClearAll">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="10"></circle>\n                <line x1="15" y1="9" x2="9" y2="15"></line>\n                <line x1="9" y1="9" x2="15" y2="15"></line>\n              </svg>\n              Clear All\n            </button>\n            <button class="map-chat-delete-btn exit" id="mapChatDeleteExit">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n              Exit\n            </button>\n          </div>\n        </div>\n\n        \x3c!-- 聊天底栏 --\x3e\n        <div class="map-chat-footer">\n          \x3c!-- 功能收纳按钮（原加号） --\x3e\n          <div class="map-chat-function-menu-wrapper">\n            <button class="map-chat-add-btn" id="mapChatAddBtn">\n              ${ys}\n            </button>\n            \x3c!-- 功能菜单（圆形放射状） --\x3e\n            <div class="map-chat-function-menu" id="mapChatFunctionMenu">\n              <button class="map-chat-function-item" id="mapChatNotesBtn" data-function="notes">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M6 4h12a2 2 0 0 1 2 2v7h-5a2 2 0 0 0 -2 2v5h-7a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2z" />\n                  <path d="M20 13v.172a2 2 0 0 1 -.586 1.414l-4.828 4.828a2 2 0 0 1 -1.414 .586h-.172" />\n                </svg>\n              </button>\n            </div>\n          </div>\n\n          <div class="map-chat-input-wrapper">\n            <input\n              type="text"\n              class="map-chat-input"\n              id="mapChatInput"\n              placeholder="Type a message..."\n            >\n          </div>\n          <button class="map-chat-like-btn" id="mapChatLikeBtn">\n            ${ws}\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- 📌 用户笔记弹窗（简约暗色风格） --\x3e\n      <div class="map-notes-overlay" id="mapNotesOverlay"></div>\n      <div class="map-notes-modal" id="mapNotesModal">\n        <div class="map-notes-container">\n          \x3c!-- 头部 --\x3e\n          <div class="map-notes-header">\n            <div class="map-notes-main-tabs">\n              <button class="map-notes-main-tab active" id="mapNotesMainTabMine" data-tab="mine">我的笔记</button>\n              <button class="map-notes-main-tab" id="mapNotesMainTabTheirs" data-tab="theirs">TA的笔记</button>\n            </div>\n            <button class="map-notes-close" id="mapNotesCloseBtn">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 分类过滤tabs --\x3e\n          <div class="map-notes-tabs" id="mapNotesTabs">\n            <button class="map-notes-tab active" data-category="all">All</button>\n          </div>\n\n          \x3c!-- 笔记列表（时间线式） --\x3e\n          <div class="map-notes-list" id="mapNotesList">\n            \x3c!-- 空状态 --\x3e\n            <div class="map-notes-empty" id="mapNotesEmpty">\n              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>\n                <polyline points="14 2 14 8 20 8"></polyline>\n                <line x1="12" y1="11" x2="12" y2="17"></line>\n                <line x1="9" y1="14" x2="15" y2="14"></line>\n              </svg>\n              <p>No notes yet</p>\n              <span>Double-tap messages to add notes</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 📌 分类选择菜单（简洁列表） --\x3e\n      <div class="map-notes-picker-overlay" id="mapNotesPickerOverlay"></div>\n      <div class="map-notes-picker" id="mapNotesPicker">\n        <div class="map-notes-picker-header">Select Category</div>\n        <div class="map-notes-picker-list" id="mapNotesPickerList"></div>\n      </div>\n\n      \x3c!-- 📌 聊天列表弹窗 --\x3e\n      <div class="map-chats-list-overlay" id="mapChatsListOverlay"></div>\n      <div class="map-chats-list-modal" id="mapChatsListModal">\n        <div class="map-chats-list-container">\n          \x3c!-- 头部 --\x3e\n          <div class="map-chats-list-header">\n            <h3 class="map-chats-list-title">Saved Chats</h3>\n            <button class="map-chats-list-close" id="mapChatsListCloseBtn">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 聊天列表 --\x3e\n          <div class="map-chats-list-content" id="mapChatsListContent">\n            \x3c!-- 空状态 --\x3e\n            <div class="map-chats-list-empty" id="mapChatsListEmpty">\n              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n              </svg>\n              <p>No saved chats</p>\n              <span>Add chats via More options in chat window</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🎯 指定筛选弹窗（简约暗色风格） --\x3e\n      <div class="map-advanced-filter-overlay" id="mapAdvancedFilterOverlay"></div>\n      <div class="map-advanced-filter-modal" id="mapAdvancedFilterModal">\n        <div class="map-advanced-filter-container">\n          \x3c!-- 头部 --\x3e\n          <div class="map-advanced-filter-header">\n            <h3 class="map-advanced-filter-title">Advanced Filter</h3>\n            <button class="map-advanced-filter-close" id="mapAdvancedFilterCloseBtn">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 筛选表单 --\x3e\n          <div class="map-advanced-filter-form">\n            \x3c!-- 性别 --\x3e\n            <div class="map-filter-field">\n              <label class="map-filter-label">Gender</label>\n              <div class="map-filter-radio-group">\n                <label class="map-filter-radio">\n                  <input type="radio" name="advGender" value="all" checked>\n                  <span>All</span>\n                </label>\n                <label class="map-filter-radio">\n                  <input type="radio" name="advGender" value="male">\n                  <span>Male</span>\n                </label>\n                <label class="map-filter-radio">\n                  <input type="radio" name="advGender" value="female">\n                  <span>Female</span>\n                </label>\n              </div>\n            </div>\n\n            \x3c!-- 年龄区间 --\x3e\n            <div class="map-filter-field">\n              <label class="map-filter-label">Age Range</label>\n              <div class="map-filter-range">\n                <input type="number" class="map-filter-input" id="advAgeMin" placeholder="Min" min="18" max="99" value="18">\n                <span class="map-filter-separator">-</span>\n                <input type="number" class="map-filter-input" id="advAgeMax" placeholder="Max" min="18" max="99" value="50">\n              </div>\n            </div>\n\n            \x3c!-- 性格 --\x3e\n            <div class="map-filter-field">\n              <label class="map-filter-label">Personality</label>\n              <input type="text" class="map-filter-textarea" id="advPersonality" placeholder="e.g., outgoing, shy, funny...">\n            </div>\n\n            \x3c!-- 标签 --\x3e\n            <div class="map-filter-field">\n              <label class="map-filter-label">Tags</label>\n              <input type="text" class="map-filter-textarea" id="advTags" placeholder="e.g., music, sports, travel...">\n            </div>\n\n            \x3c!-- 类型（自由输入） --\x3e\n            <div class="map-filter-field">\n              <label class="map-filter-label">Type / Other</label>\n              <textarea class="map-filter-textarea map-filter-textarea-multi" id="advType" placeholder="Any other requirements..." rows="3"></textarea>\n            </div>\n          </div>\n\n          \x3c!-- 底部按钮 --\x3e\n          <div class="map-advanced-filter-footer">\n            <button class="map-advanced-filter-btn map-advanced-filter-btn-cancel" id="mapAdvancedFilterCancelBtn">Cancel</button>\n            <button class="map-advanced-filter-btn map-advanced-filter-btn-clear" id="mapAdvancedFilterClearBtn">Clear</button>\n            <button class="map-advanced-filter-btn map-advanced-filter-btn-apply" id="mapAdvancedFilterApplyBtn">Apply</button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🔔 提醒弹窗 - Toast风格极简设计 --\x3e\n      <div class="map-notifications-overlay" id="mapNotificationsOverlay"></div>\n      <div class="map-notifications-modal" id="mapNotificationsModal">\n        <div class="map-notifications-content">\n          \x3c!-- 头部 --\x3e\n          <div class="map-notifications-header">\n            \x3c!-- 顶部：标题 + 关闭按钮 --\x3e\n            <div class="map-notifications-header-top">\n              <h3 class="map-notifications-title">Notifications</h3>\n              <button class="map-notifications-close-btn" id="mapNotificationsCloseBtn">\n                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <line x1="18" y1="6" x2="6" y2="18"></line>\n                  <line x1="6" y1="6" x2="18" y2="18"></line>\n                </svg>\n              </button>\n            </div>\n\n            \x3c!-- 统计卡片 --\x3e\n            <div class="map-notifications-stats">\n              <div class="map-notifications-stats-icon">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>\n                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>\n                </svg>\n              </div>\n              <div class="map-notifications-stats-info">\n                <div class="map-notifications-stats-label">Unread</div>\n                <div class="map-notifications-stats-count" id="mapNotificationsUnreadCount">0</div>\n              </div>\n            </div>\n\n            \x3c!-- 分类Tabs --\x3e\n            <div class="map-notifications-tabs" id="mapNotificationsTabs">\n              <button class="map-notifications-tab active" data-filter="all">All</button>\n              <button class="map-notifications-tab" data-filter="likes">Likes</button>\n              <button class="map-notifications-tab" data-filter="messages">Messages</button>\n              <button class="map-notifications-tab" data-filter="follows">Follows</button>\n              <button class="map-notifications-tab" data-filter="reports">Reports</button>\n            </div>\n          </div>\n\n          \x3c!-- 提醒列表 --\x3e\n          <div class="map-notifications-list-container" id="mapNotificationsListContainer">\n            \x3c!-- 空状态 --\x3e\n            <div class="map-notifications-empty" id="mapNotificationsEmpty">\n              <div class="map-notifications-empty-icon">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>\n                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>\n                </svg>\n              </div>\n              <p class="map-notifications-empty-text">No notifications yet</p>\n            </div>\n\n            \x3c!-- 提醒列表（动态生成） --\x3e\n            <div id="mapNotificationsList"></div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 💬 接收私信确认弹窗 - 简约设计 --\x3e\n      <div class="map-accept-message-overlay" id="mapAcceptMessageOverlay"></div>\n      <div class="map-accept-message-modal" id="mapAcceptMessageModal">\n        <div class="map-accept-message-content">\n          \x3c!-- 头部 --\x3e\n          <div class="map-accept-message-header">\n            <div class="map-accept-message-user">\n              <img class="map-accept-message-avatar" id="mapAcceptMsgAvatar" src="" alt="">\n              <div class="map-accept-message-user-info">\n                <h3 id="mapAcceptMsgNickname">User</h3>\n                <p id="mapAcceptMsgHandle">@handle</p>\n              </div>\n            </div>\n            <p class="map-accept-message-title">Sent you a message:</p>\n            <div class="map-accept-message-text" id="mapAcceptMsgText">\n              Message content...\n            </div>\n          </div>\n\n          \x3c!-- 按钮 --\x3e\n          <div class="map-accept-message-actions">\n            <button class="map-decline-btn" id="mapDeclineMessageBtn">Decline</button>\n            <button class="map-accept-btn" id="mapAcceptMessageBtn">Accept</button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🚨 举报用户弹窗 - 简约设计 --\x3e\n      <div class="map-report-overlay" id="mapReportOverlay"></div>\n      <div class="map-report-modal" id="mapReportModal">\n        <div class="map-report-content">\n          \x3c!-- 头部 --\x3e\n          <div class="map-report-header">\n            <h3 class="map-report-title">Report User</h3>\n            <button class="map-report-close-btn" id="mapReportCloseBtn">\n              <svg viewBox="0 0 24 24">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 举报表单 --\x3e\n          <div class="map-report-body">\n            \x3c!-- 被举报用户信息 --\x3e\n            <div class="map-report-user-info">\n              <img class="map-report-user-avatar" id="mapReportUserAvatar" src="" alt="">\n              <div class="map-report-user-details">\n                <h4 id="mapReportUserNickname">User</h4>\n                <p id="mapReportUserHandle">@handle</p>\n              </div>\n            </div>\n\n            \x3c!-- 举报理由 --\x3e\n            <div class="map-report-section">\n              <label class="map-report-section-label">Reason for report</label>\n              <div class="map-report-reasons">\n                <label class="map-report-reason-item">\n                  <input type="checkbox" name="reportReason" value="inappropriate_content" />\n                  <span class="map-report-reason-text">Inappropriate Content</span>\n                </label>\n                <label class="map-report-reason-item">\n                  <input type="checkbox" name="reportReason" value="harassment" />\n                  <span class="map-report-reason-text">Harassment</span>\n                </label>\n                <label class="map-report-reason-item">\n                  <input type="checkbox" name="reportReason" value="abuse" />\n                  <span class="map-report-reason-text">Verbal Abuse</span>\n                </label>\n                <label class="map-report-reason-item">\n                  <input type="checkbox" name="reportReason" value="spam" />\n                  <span class="map-report-reason-text">Spam</span>\n                </label>\n                <label class="map-report-reason-item">\n                  <input type="checkbox" name="reportReason" value="other" />\n                  <span class="map-report-reason-text">Other</span>\n                </label>\n              </div>\n            </div>\n\n            \x3c!-- 举报描述 --\x3e\n            <div class="map-report-section">\n              <label class="map-report-section-label" for="mapReportDescription">Additional details (optional)</label>\n              <textarea\n                class="map-report-textarea"\n                id="mapReportDescription"\n                placeholder="Provide more information about the issue..."\n                rows="4"\n              ></textarea>\n            </div>\n          </div>\n\n          \x3c!-- 底部按钮 --\x3e\n          <div class="map-report-actions">\n            <button class="map-report-cancel-btn" id="mapReportCancelBtn">Cancel</button>\n            <button class="map-report-submit-btn" id="mapReportSubmitBtn">Submit Report</button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 📋 举报详情弹窗 - ins简约风格 --\x3e\n      <div class="map-report-detail-overlay" id="mapReportDetailOverlay"></div>\n      <div class="map-report-detail-modal" id="mapReportDetailModal">\n        <div class="map-report-detail-content">\n          \x3c!-- 头部 --\x3e\n          <div class="map-report-detail-header">\n            <h3 class="map-report-detail-title">Report Result</h3>\n            <button class="map-report-detail-close-btn" id="mapReportDetailCloseBtn">\n              <svg viewBox="0 0 24 24">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 判定结果徽章 --\x3e\n          <div class="map-report-detail-badge-container">\n            <div class="map-report-detail-badge" id="mapReportDetailBadge">\n              <div class="map-report-detail-badge-icon" id="mapReportDetailBadgeIcon"></div>\n              <div class="map-report-detail-badge-text" id="mapReportDetailBadgeText"></div>\n            </div>\n          </div>\n\n          \x3c!-- 详情主体 --\x3e\n          <div class="map-report-detail-body">\n            \x3c!-- 被举报用户 --\x3e\n            <div class="map-report-detail-section">\n              <div class="map-report-detail-section-label">Reported User</div>\n              <div class="map-report-detail-user-card">\n                <img class="map-report-detail-user-avatar" id="mapReportDetailUserAvatar" src="" alt="">\n                <div class="map-report-detail-user-info">\n                  <div class="map-report-detail-user-nickname" id="mapReportDetailUserNickname"></div>\n                  <div class="map-report-detail-user-handle" id="mapReportDetailUserHandle"></div>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 举报理由 --\x3e\n            <div class="map-report-detail-section">\n              <div class="map-report-detail-section-label">Report Reasons</div>\n              <div class="map-report-detail-reasons" id="mapReportDetailReasons"></div>\n            </div>\n\n            \x3c!-- 举报描述 --\x3e\n            <div class="map-report-detail-section" id="mapReportDetailDescSection">\n              <div class="map-report-detail-section-label">Additional Details</div>\n              <div class="map-report-detail-description" id="mapReportDetailDescription"></div>\n            </div>\n\n            \x3c!-- AI判定原因 --\x3e\n            <div class="map-report-detail-section">\n              <div class="map-report-detail-section-label">Review Result</div>\n              <div class="map-report-detail-reason" id="mapReportDetailReason"></div>\n            </div>\n\n            \x3c!-- 举报时间 --\x3e\n            <div class="map-report-detail-section">\n              <div class="map-report-detail-section-label">Report Time</div>\n              <div class="map-report-detail-time" id="mapReportDetailTime"></div>\n            </div>\n          </div>\n\n          \x3c!-- 底部按钮 --\x3e\n          <div class="map-report-detail-actions">\n            <button class="map-report-detail-acknowledge-btn" id="mapReportDetailAcknowledgeBtn">Acknowledge</button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 🚗 城市乘车面板 - ins风格 --\x3e\n      \x3c!-- 选择目的地提示 --\x3e\n      <div class="ride-selection-hint" id="rideSelectionHint">\n        点击地图上的地标选择目的地\n      </div>\n\n      \x3c!-- 乘车面板遮罩 --\x3e\n      <div class="ride-panel-overlay" id="ridePanelOverlay"></div>\n\n      \x3c!-- 乘车面板 - 半屏抽屉 --\x3e\n      <div class="ride-panel" id="ridePanel">\n        \x3c!-- 面板拖动手柄 --\x3e\n        <div class="ride-panel-handle"></div>\n\n        \x3c!-- 面板内容 --\x3e\n        <div class="ride-panel-content">\n          \x3c!-- 路线信息横幅 --\x3e\n          <div class="ride-route-banner">\n            <div class="ride-route-banner-left">\n              <svg class="ride-route-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10"/>\n                <polyline points="12 6 12 12 16 14"/>\n              </svg>\n              <span class="ride-route-text">预计到达</span>\n            </div>\n            <span class="ride-route-time" id="rideEstimatedTime">--</span>\n          </div>\n\n          \x3c!-- 位置选择 --\x3e\n          <div class="ride-location-section">\n            <div class="ride-location-box">\n              <div class="ride-location-label">Start</div>\n              <div class="ride-location-value">当前位置</div>\n            </div>\n            <div class="ride-location-box" id="rideDestinationBox">\n              <div class="ride-location-label">Finish</div>\n              <div class="ride-location-value placeholder" id="rideDestinationValue">点击选择目的地</div>\n            </div>\n          </div>\n\n          \x3c!-- 车辆选择标题 --\x3e\n          <h2 class="ride-section-title">选择车型</h2>\n\n          \x3c!-- 车辆选择网格 --\x3e\n          <div class="ride-vehicles-grid" id="rideVehiclesGrid">\n            \x3c!-- 经济型 --\x3e\n            <div class="ride-vehicle-card selected" data-type="economy" data-base-price="18" data-rate="1.2">\n              <div class="ride-vehicle-image">\n                <svg viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <ellipse cx="60" cy="68" rx="32" ry="6" fill="currentColor" opacity="0.1"/>\n                  <path d="M 24,58 L 18,50 L 18,32 L 30,24 L 90,24 L 102,32 L 102,50 L 96,58 Z" fill="currentColor" opacity="0.25"/>\n                  <ellipse cx="35" cy="58" rx="11" ry="11" fill="currentColor" opacity="0.5"/>\n                  <ellipse cx="85" cy="58" rx="11" ry="11" fill="currentColor" opacity="0.5"/>\n                  <rect x="28" y="18" width="64" height="22" rx="4" fill="currentColor" opacity="0.35"/>\n                  <rect x="42" y="12" width="36" height="10" rx="2.5" fill="currentColor" opacity="0.45"/>\n                </svg>\n              </div>\n              <div class="ride-vehicle-name">经济型</div>\n              <div class="ride-vehicle-capacity">\n                <svg class="ride-capacity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>\n                  <circle cx="12" cy="7" r="4"/>\n                </svg>\n                <span>1-3</span>\n              </div>\n              <div class="ride-vehicle-pricing">\n                <span class="ride-vehicle-price">¥<span class="ride-price-value">18</span></span>\n                <span class="ride-vehicle-eta">5 min</span>\n              </div>\n            </div>\n\n            \x3c!-- 舒适型 --\x3e\n            <div class="ride-vehicle-card" data-type="comfort" data-base-price="32" data-rate="2.0">\n              <div class="ride-vehicle-image">\n                <svg viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <ellipse cx="60" cy="68" rx="34" ry="6" fill="currentColor" opacity="0.12"/>\n                  <path d="M 22,58 L 16,49 L 16,30 L 28,21 L 92,21 L 104,30 L 104,49 L 98,58 Z" fill="currentColor" opacity="0.3"/>\n                  <ellipse cx="34" cy="58" rx="12" ry="12" fill="currentColor" opacity="0.6"/>\n                  <ellipse cx="86" cy="58" rx="12" ry="12" fill="currentColor" opacity="0.6"/>\n                  <rect x="26" y="16" width="68" height="24" rx="5" fill="currentColor" opacity="0.4"/>\n                  <rect x="40" y="10" width="40" height="11" rx="3" fill="currentColor" opacity="0.5"/>\n                </svg>\n              </div>\n              <div class="ride-vehicle-name">舒适型</div>\n              <div class="ride-vehicle-capacity">\n                <svg class="ride-capacity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>\n                  <circle cx="9" cy="7" r="4"/>\n                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>\n                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>\n                </svg>\n                <span>1-4</span>\n              </div>\n              <div class="ride-vehicle-pricing">\n                <span class="ride-vehicle-price">¥<span class="ride-price-value">32</span></span>\n                <span class="ride-vehicle-eta">8 min</span>\n              </div>\n            </div>\n\n            \x3c!-- 商务型 --\x3e\n            <div class="ride-vehicle-card" data-type="business" data-base-price="56" data-rate="3.5">\n              <div class="ride-vehicle-image">\n                <svg viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <ellipse cx="60" cy="68" rx="36" ry="6" fill="currentColor" opacity="0.14"/>\n                  <path d="M 20,58 L 14,48 L 14,28 L 26,18 L 94,18 L 106,28 L 106,48 L 100,58 Z" fill="currentColor" opacity="0.35"/>\n                  <ellipse cx="33" cy="58" rx="13" ry="13" fill="currentColor" opacity="0.7"/>\n                  <ellipse cx="87" cy="58" rx="13" ry="13" fill="currentColor" opacity="0.7"/>\n                  <rect x="24" y="14" width="72" height="26" rx="6" fill="currentColor" opacity="0.45"/>\n                  <rect x="38" y="8" width="44" height="12" rx="3.5" fill="currentColor" opacity="0.55"/>\n                </svg>\n              </div>\n              <div class="ride-vehicle-name">商务型</div>\n              <div class="ride-vehicle-capacity">\n                <svg class="ride-capacity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>\n                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>\n                </svg>\n                <span>1-4</span>\n              </div>\n              <div class="ride-vehicle-pricing">\n                <span class="ride-vehicle-price">¥<span class="ride-price-value">56</span></span>\n                <span class="ride-vehicle-eta">10 min</span>\n              </div>\n            </div>\n\n            \x3c!-- 豪华型 --\x3e\n            <div class="ride-vehicle-card" data-type="luxury" data-base-price="128" data-rate="6.0">\n              <div class="ride-vehicle-image">\n                <svg viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg">\n                  <ellipse cx="60" cy="68" rx="38" ry="6" fill="currentColor" opacity="0.16"/>\n                  <path d="M 18,58 L 12,47 L 12,26 L 24,15 L 96,15 L 108,26 L 108,47 L 102,58 Z" fill="currentColor" opacity="0.4"/>\n                  <ellipse cx="32" cy="58" rx="14" ry="14" fill="currentColor" opacity="0.8"/>\n                  <ellipse cx="88" cy="58" rx="14" ry="14" fill="currentColor" opacity="0.8"/>\n                  <rect x="22" y="11" width="76" height="28" rx="7" fill="currentColor" opacity="0.5"/>\n                  <rect x="36" y="5" width="48" height="13" rx="4" fill="currentColor" opacity="0.6"/>\n                </svg>\n              </div>\n              <div class="ride-vehicle-name">豪华型</div>\n              <div class="ride-vehicle-capacity">\n                <svg class="ride-capacity-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>\n                </svg>\n                <span>1-4</span>\n              </div>\n              <div class="ride-vehicle-pricing">\n                <span class="ride-vehicle-price">¥<span class="ride-price-value">128</span></span>\n                <span class="ride-vehicle-eta">15 min</span>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 支付方式 --\x3e\n          <div class="ride-payment-section">\n            <h3 class="ride-payment-title">支付方式</h3>\n            <div class="ride-payment-options">\n              <button class="ride-payment-option selected" data-payment="cash">\n                <svg class="ride-payment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <line x1="12" y1="1" x2="12" y2="23"/>\n                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>\n                </svg>\n                <span>现金</span>\n              </button>\n              <button class="ride-payment-option" data-payment="online">\n                <svg class="ride-payment-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>\n                  <line x1="1" y1="10" x2="23" y2="10"/>\n                </svg>\n                <span>在线支付</span>\n              </button>\n            </div>\n          </div>\n\n          \x3c!-- 预订按钮 --\x3e\n          <button class="ride-book-btn" id="rideBookBtn" disabled>请先选择目的地</button>\n        </div>\n      </div>\n\n      \x3c!-- 等待司机悬浮小球 --\x3e\n      <button class="waiting-driver-float-btn" id="waitingDriverFloatBtn">\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />\n          <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />\n          <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5" />\n        </svg>\n      </button>\n\n      \x3c!-- 等待司机弹窗 --\x3e\n      <div class="waiting-driver-modal-overlay" id="waitingDriverModalOverlay">\n        <div class="waiting-driver-modal">\n          \x3c!-- 关闭按钮 --\x3e\n          <button class="waiting-driver-close" id="waitingDriverCloseBtn">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 6L6 18M6 6l12 12"/>\n            </svg>\n          </button>\n\n          \x3c!-- Header --\x3e\n          <div class="waiting-driver-header">\n            <div class="waiting-driver-status">Driver on the way</div>\n            <div class="waiting-driver-eta" id="waitingDriverEta">0:00</div>\n            <div class="waiting-driver-eta-label">Estimated Arrival</div>\n          </div>\n\n          \x3c!-- 司机卡片 --\x3e\n          <div class="waiting-driver-card">\n            <div class="waiting-driver-avatar">\n              <img id="waitingDriverAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect fill='%23d5d5d5' width='64' height='64'/%3E%3Ctext x='50%25' y='50%25' fill='%23666' text-anchor='middle' dy='.3em' font-size='24' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E" alt="Driver">\n            </div>\n            <div class="waiting-driver-info">\n              <div class="waiting-driver-name" id="waitingDriverName">Driver</div>\n              <div class="waiting-driver-rating">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>\n                <span class="waiting-driver-rating-value" id="waitingDriverRating">5.0</span>\n              </div>\n              <div class="waiting-driver-vehicle">\n                <span id="waitingDriverVehicle">Vehicle</span>\n                <span class="waiting-driver-plate" id="waitingDriverPlate">XXXXXXXX</span>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- 路线图 --\x3e\n          <div class="waiting-driver-route-map">\n            <div class="waiting-driver-route-grid"></div>\n            <div class="waiting-driver-route-line"></div>\n\n            \x3c!-- 用户标记 --\x3e\n            <div class="waiting-driver-user-marker">\n              <div class="waiting-driver-user-pin">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>\n                  <circle cx="12" cy="7" r="4"/>\n                </svg>\n              </div>\n            </div>\n\n            \x3c!-- 司机标记 --\x3e\n            <div class="waiting-driver-car-marker" id="waitingDriverCarMarker">\n              <div class="waiting-driver-car-icon">\n                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n                  <path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />\n                  <path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" />\n                  <path d="M5 17h-2v-6l2 -5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5" />\n                </svg>\n              </div>\n              <div class="waiting-driver-car-label" id="waitingDriverDistance">0.0 km</div>\n            </div>\n          </div>\n\n          \x3c!-- 距离信息 --\x3e\n          <div class="waiting-driver-distance-info">\n            <div class="waiting-driver-distance-item">\n              <div class="waiting-driver-distance-value" id="waitingDriverDistanceKm">0.0</div>\n              <div class="waiting-driver-distance-label">Distance (km)</div>\n            </div>\n            <div class="waiting-driver-distance-divider"></div>\n            <div class="waiting-driver-distance-item">\n              <div class="waiting-driver-distance-value" id="waitingDriverSpeed">0</div>\n              <div class="waiting-driver-distance-label">Speed (km/h)</div>\n            </div>\n          </div>\n\n          \x3c!-- 操作按钮 --\x3e\n          <div class="waiting-driver-actions">\n            <button class="waiting-driver-action-btn" id="waitingDriverContactBtn">\n              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>\n              </svg>\n              <span id="waitingDriverContactText">Contact</span>\n            </button>\n            <button class="waiting-driver-action-btn cancel" id="waitingDriverCancelBtn">\n              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10"/>\n                <path d="M15 9l-6 6M9 9l6 6"/>\n              </svg>\n              Cancel Ride\n            </button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- ⚙️ 应用设置弹窗 - ins风格 --\x3e\n      <div class="map-app-settings-overlay" id="mapAppSettingsOverlay"></div>\n      <div class="map-app-settings-modal" id="mapAppSettingsModal">\n        <div class="map-app-settings-content">\n          \x3c!-- 头部 --\x3e\n          <div class="map-app-settings-header">\n            <h3 class="map-app-settings-title">Settings</h3>\n            <button class="map-app-settings-close-btn" id="mapAppSettingsCloseBtn">\n              <svg viewBox="0 0 24 24">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n\n          \x3c!-- 设置主体 --\x3e\n          <div class="map-app-settings-body">\n            \x3c!-- 主题切换 --\x3e\n            <div class="map-app-setting-item">\n              <div class="map-app-setting-label">\n                <div class="map-app-setting-label-text">Appearance</div>\n                <div class="map-app-setting-label-desc">Switch between light and dark theme</div>\n              </div>\n              <div class="map-theme-toggle" id="mapThemeToggle">\n                <div class="map-theme-toggle-circle">\n                  <svg class="map-theme-toggle-icon" viewBox="0 0 24 24">\n                    \x3c!-- 月亮图标（暗色模式） --\x3e\n                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>\n                  </svg>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- 地标管理 --\x3e\n            <div class="map-app-setting-section map-landmark-section">\n              <div class="map-app-setting-section-title">Landmark Management</div>\n              <div class="map-app-setting-section-desc">Add custom landmarks or generate them with AI</div>\n\n              \x3c!-- 模式切换 --\x3e\n              <div class="map-landmark-mode-toggle">\n                <button class="map-landmark-mode-btn active" data-mode="custom">\n                  Custom Landmark\n                </button>\n                <button class="map-landmark-mode-btn" data-mode="ai">\n                  AI Generate\n                </button>\n              </div>\n\n              \x3c!-- 自定义地标表单 --\x3e\n              <div class="map-landmark-custom-form active">\n                <input\n                  type="text"\n                  class="map-landmark-name-input"\n                  id="mapLandmarkNameInput"\n                  placeholder="Landmark name (e.g., Starbucks, Central Park)"\n                  maxlength="50"\n                />\n\n                <textarea\n                  class="map-landmark-desc-input"\n                  id="mapLandmarkDescInput"\n                  placeholder="Landmark description (optional)"\n                  maxlength="200"\n                ></textarea>\n\n                <div class="map-landmark-icon-color-row">\n                  \x3c!-- 图标选择 --\x3e\n                  <div class="map-landmark-icon-selector">\n                    <div class="map-landmark-icon-preview" id="mapLandmarkIconPreview">📍</div>\n                    <input\n                      type="text"\n                      class="map-landmark-icon-input"\n                      id="mapLandmarkIconInput"\n                      placeholder="Icon emoji"\n                      maxlength="2"\n                      value="📍"\n                    />\n                  </div>\n\n                  \x3c!-- 颜色选择 --\x3e\n                  <div class="map-landmark-color-picker-wrapper">\n                    <div class="map-landmark-color-preview" id="mapLandmarkColorPreview" style="background-color: #ff6b6b;"></div>\n                    <input\n                      type="text"\n                      class="map-landmark-color-input"\n                      id="mapLandmarkColorInput"\n                      placeholder="Color (e.g., #ff6b6b)"\n                      maxlength="7"\n                      value="#ff6b6b"\n                    />\n                  </div>\n                </div>\n\n                \x3c!-- 地图选点 --\x3e\n                <div class="map-landmark-pick-position">\n                  <button class="map-landmark-pick-btn" id="mapLandmarkPickBtn">\n                    <span>📍</span>\n                    <span>Click to pick position on map</span>\n                  </button>\n                  <div class="map-landmark-position-display" id="mapLandmarkPositionDisplay">\n                    No position selected\n                  </div>\n                </div>\n\n                <button class="map-landmark-save-btn" id="mapLandmarkSaveBtn" disabled>\n                  Save Landmark\n                </button>\n              </div>\n\n              \x3c!-- AI生成地标表单 --\x3e\n              <div class="map-landmark-ai-form">\n                <textarea\n                  class="map-landmark-ai-input"\n                  id="mapLandmarkAiInput"\n                  placeholder="Describe what landmarks you want AI to generate (e.g., 'Generate 5-10 restaurants and cafes in downtown area')"\n                ></textarea>\n\n                <button class="map-landmark-generate-btn" id="mapLandmarkGenerateBtn">\n                  Generate Landmarks with AI\n                </button>\n              </div>\n\n              \x3c!-- 批量操作栏 --\x3e\n              <div class="map-landmark-batch-actions" id="mapLandmarkBatchActions">\n                <button class="map-landmark-select-all-btn" id="mapLandmarkSelectAllBtn">\n                  Select All\n                </button>\n                <span class="map-landmark-selected-count" id="mapLandmarkSelectedCount">\n                  0 selected\n                </span>\n                <button class="map-landmark-batch-delete-btn" id="mapLandmarkBatchDeleteBtn" disabled>\n                  Delete Selected\n                </button>\n              </div>\n\n              \x3c!-- 地标列表 --\x3e\n              <div class="map-landmark-list" id="mapLandmarkList">\n                \x3c!-- 动态生成 --\x3e\n              </div>\n            </div>\n\n            \x3c!-- 自定义头像管理 --\x3e\n            <div class="map-app-setting-section">\n              <div class="map-app-setting-section-title">Custom Avatars</div>\n              <div class="map-app-setting-section-desc">Add your own avatar URLs to the library</div>\n\n              \x3c!-- 添加头像表单 --\x3e\n              <div class="map-avatar-add-form">\n                <input\n                  type="text"\n                  class="map-avatar-url-input"\n                  id="mapAvatarUrlInput"\n                  placeholder="Enter URL(s), separate with commas for batch upload"\n                />\n\n                <div class="map-avatar-category-selector">\n                  <label class="map-avatar-category-option">\n                    <input type="radio" name="avatarCategory" value="unisex" checked />\n                    <span class="map-avatar-category-label">Unisex</span>\n                  </label>\n                  <label class="map-avatar-category-option">\n                    <input type="radio" name="avatarCategory" value="male" />\n                    <span class="map-avatar-category-label">Male</span>\n                  </label>\n                  <label class="map-avatar-category-option">\n                    <input type="radio" name="avatarCategory" value="female" />\n                    <span class="map-avatar-category-label">Female</span>\n                  </label>\n                </div>\n\n                <button class="map-avatar-add-btn" id="mapAvatarAddBtn">Add Avatar</button>\n              </div>\n\n              \x3c!-- 已添加头像列表 --\x3e\n              <div class="map-avatar-list" id="mapCustomAvatarList">\n                \x3c!-- 动态生成 --\x3e\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 地标事件弹窗 --\x3e\n      <div class="event-modal-overlay" id="eventModalOverlay">\n        <div class="event-modal-container">\n          <div class="event-controls">\n            <button class="event-btn" id="eventModalCloseBtn" title="关闭">×</button>\n          </div>\n          <div class="event-content" id="eventModalContent">\n            \x3c!-- AI生成的事件HTML将动态注入这里 --\x3e\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- 咩三三城市报纸弹窗 --\x3e\n      <div class="map-newspaper-overlay" id="newspaperOverlay"></div>\n      <div class="map-newspaper-modal" id="newspaperModal">\n        <div class="newspaper-container">\n          \x3c!-- 扫描线效果 --\x3e\n          <div class="newspaper-scanline"></div>\n\n          \x3c!-- 装饰星星 --\x3e\n          <span class="newspaper-star-deco">✦</span>\n          <span class="newspaper-star-deco">✧</span>\n          <span class="newspaper-star-deco">✦</span>\n          <span class="newspaper-star-deco">✧</span>\n\n          \x3c!-- 像素装饰点 --\x3e\n          <div class="newspaper-pixel-dots">\n            <span class="newspaper-pixel-dot" style="top: 10%; left: 15%;"></span>\n            <span class="newspaper-pixel-dot" style="top: 25%; right: 20%;"></span>\n            <span class="newspaper-pixel-dot" style="top: 45%; left: 8%;"></span>\n            <span class="newspaper-pixel-dot" style="top: 70%; right: 12%;"></span>\n            <span class="newspaper-pixel-dot" style="bottom: 15%; left: 25%;"></span>\n          </div>\n\n          <div class="newspaper-screen">\n            \x3c!-- 浏览器风格顶栏 --\x3e\n            <div class="newspaper-browser-bar">\n              <div class="newspaper-browser-dots">\n                <div class="newspaper-dot"></div>\n                <div class="newspaper-dot"></div>\n                <div class="newspaper-dot"></div>\n              </div>\n              <div class="newspaper-url-bar">mie333://city-news.daily</div>\n              <button class="newspaper-close-btn" id="newspaperCloseBtn">\n                <svg viewBox="0 0 24 24" fill="none">\n                  <path d="M18 6L6 18M6 6L18 18" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n              </button>\n            </div>\n\n            \x3c!-- 主内容区 - 双栏布局 --\x3e\n            <div class="newspaper-content">\n              \x3c!-- 右侧边栏 --\x3e\n              <div class="newspaper-sidebar">\n                \x3c!-- 头像名片 --\x3e\n                <div class="newspaper-profile-card">\n                  <div class="newspaper-avatar-box">\n                    <div class="newspaper-avatar">🐑</div>\n                    <div class="newspaper-status-badge">ONLINE</div>\n                  </div>\n                  <div class="newspaper-profile-name">MIE333</div>\n                  <div class="newspaper-profile-role">News Reporter<br>Weather Reporter<br>Merchant</div>\n                </div>\n\n                \x3c!-- 像素时钟 --\x3e\n                <div class="newspaper-pixel-clock">\n                  <div class="newspaper-clock-date" id="newspaperClockDate">2024-01-15</div>\n                  <div class="newspaper-clock-time" id="newspaperClockTime">10:23 PM</div>\n                </div>\n\n                \x3c!-- 标签云 --\x3e\n                <div class="newspaper-tags-widget">\n                  <div class="newspaper-widget-title">TAGS</div>\n                  <div class="newspaper-tag-cloud">\n                    <span class="newspaper-tag">NEWS</span>\n                    <span class="newspaper-tag">WEATHER</span>\n                    <span class="newspaper-tag">TIPS</span>\n                    <span class="newspaper-tag">ADS</span>\n                    <span class="newspaper-tag">STORY</span>\n                  </div>\n                </div>\n\n                \x3c!-- 迷你统计 --\x3e\n                <div class="newspaper-stats-mini">\n                  <div class="newspaper-stat-item">\n                    <div class="newspaper-stat-value" id="newspaperViewsCount">0</div>\n                    <div class="newspaper-stat-label">Views</div>\n                  </div>\n                  <div class="newspaper-stat-item">\n                    <div class="newspaper-stat-value" id="newspaperTipsCount">0</div>\n                    <div class="newspaper-stat-label">Tips</div>\n                  </div>\n                </div>\n\n                \x3c!-- 邮件通知 --\x3e\n                <div class="newspaper-mail-notice">\n                  <div class="newspaper-mail-stamp">📮</div>\n                  <div class="newspaper-mail-content">\n                    Contact via<br>\n                    mie333@city-news.com\n                  </div>\n                </div>\n              </div>\n\n              \x3c!-- 左侧主栏 --\x3e\n              <div class="newspaper-main-column" id="newspaperMainContent">\n                \x3c!-- AI生成的报纸内容将动态注入这里 --\x3e\n                <div style="padding: 40px; text-align: center; color: var(--map-text-secondary);">\n                  Loading...\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,e.style.display="block",Ss.init()}function Ts(){const n=document.getElementById("x-map-container");n&&(n.style.display="none",n.innerHTML="")}function As(e=null){const t=e||[{title:"RETRO GAME CONSOLE",seller:"@pixel_collector",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.7",sellerSales:"342",price:"$89",status:"new",image:"https://images.unsplash.com/photo-1611532736597-de2d4265fba3?w=800",description:"Classic gaming console in pristine condition. Includes original controllers and power adapter. Perfect for retro gaming enthusiasts and collectors. Tested and fully functional.",specs:{condition:"Like New",location:"Tokyo, Japan",shipping:"Free Shipping",posted:"3 days ago"}},{title:"VINTAGE CAMERA KIT",seller:"@retro_shop",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.9",sellerSales:"567",price:"$156",status:"rare",image:"https://images.unsplash.com/photo-1526738549149-8e07eca6c147?w=800",description:"Professional vintage camera with multiple lenses. Excellent working condition. Includes original leather case, lens caps, and manual. A true collector's item for photography lovers.",specs:{condition:"95%新",location:"Berlin, Germany",shipping:"Free Shipping",posted:"1 week ago"}},{title:"PIXEL ART POSTER",seller:"@art_gallery",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.6",sellerSales:"892",price:"$34",status:"hot",image:"https://images.unsplash.com/photo-1591370874773-6702e8f12fd8?w=800",description:"Limited edition pixel art print. High quality print on premium paper. Signed by the artist. Perfect for gaming room or studio decoration. Ships carefully packaged.",specs:{condition:"Brand New",location:"Los Angeles, US",shipping:"包邮",posted:"刚刚"}},{title:"MECHANICAL KEYBOARD",seller:"@tech_deals",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.8",sellerSales:"1245",price:"$112",status:"new",image:"https://images.unsplash.com/photo-1583394838336-acd977736f90?w=800",description:"Premium mechanical keyboard with RGB backlighting. Cherry MX switches. Full programmable keys. Excellent for gaming and typing. Brand new in box with warranty.",specs:{condition:"全新",location:"Shenzhen, China",shipping:"Free Shipping",posted:"5小时前"}},{title:"VINTAGE SUNGLASSES",seller:"@fashion_archive",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.5",sellerSales:"234",price:"$67",status:"rare",image:"https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=800",description:"Authentic vintage sunglasses from the 80s. Classic aviator style. Original case included. Lenses in perfect condition. A stylish piece of fashion history.",specs:{condition:"85%新",location:"Paris, France",shipping:"€5 Shipping",posted:"4 days ago"}},{title:"SMART WATCH BANDS",seller:"@gadget_zone",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.7",sellerSales:"1876",price:"$23",status:"hot",image:"https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=800",description:"Set of 3 premium watch bands. Compatible with most smart watches. High quality materials. Easy to install. Multiple colors available for different styles.",specs:{condition:"Brand New",location:"Hong Kong",shipping:"包邮",posted:"2天前"}},{title:"VINTAGE HEADPHONES",seller:"@audio_classics",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.9",sellerSales:"423",price:"$145",status:"rare",image:"https://images.unsplash.com/photo-1588508065123-287b28e013da?w=800",description:"Classic studio headphones. Exceptional sound quality. Original cable and adapter. Well-maintained and fully functional. Perfect for audiophiles and collectors.",specs:{condition:"Like New (90%)",location:"London, UK",shipping:"Free Shipping",posted:"1 week ago"}},{title:"FILM CAMERA BUNDLE",seller:"@photo_lab",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"5.0",sellerSales:"156",price:"$289",status:"new",image:"https://images.unsplash.com/photo-1603302576837-37561b2e2302?w=800",description:"Complete film camera set with 3 lenses. Professional grade equipment. Includes camera bag, filters, and accessories. Excellent condition. Ready for analog photography.",specs:{condition:"99新",location:"Seoul, Korea",shipping:"Free Shipping",posted:"1天前"}},{title:"RETRO GAMING MOUSE",seller:"@gamer_gear",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.6",sellerSales:"1032",price:"$78",status:"hot",image:"https://images.unsplash.com/photo-1625225233840-695456021cde?w=800",description:"High precision gaming mouse with retro design. Customizable DPI settings. RGB lighting. Ergonomic grip. Perfect for long gaming sessions. Brand new condition.",specs:{condition:"Brand New",location:"Taipei, Taiwan",shipping:"Free Shipping",posted:"6小时前"}},{title:"WIRELESS EARBUDS",seller:"@sound_market",isCharacterSeller:!1,characterHandle:"",characterName:"",sellerRating:"4.8",sellerSales:"2341",price:"$95",status:"new",image:"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800",description:"Premium wireless earbuds with active noise cancellation. Long battery life. Comfortable fit. Crystal clear sound quality. Includes charging case and accessories.",specs:{condition:"全新",location:"Shanghai, China",shipping:"包邮",posted:"3小时前"}}];Us=t,console.log("✅ 已更新商品列表，共",Us.length,"个商品");const o=document.getElementById("shopThemeToggle"),a=document.querySelector(".shop-container");function i(){const n=document.getElementById("shopTime");if(!n)return;const e=new Date,t=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");n.textContent=`${t}:${o}:${a}`}o&&a&&!o.dataset.eventBound&&(o.addEventListener("click",()=>{a.classList.toggle("shop-light-theme");const n=o.querySelector("span");n&&(n.textContent=a.classList.contains("shop-light-theme")?"☾":"☀")}),o.dataset.eventBound="true"),i(),n.shopClockInterval||(n.shopClockInterval=setInterval(i,1e3)),document.querySelectorAll(".shop-item-card, .shop-nav-btn, .shop-addressbar-btn, .shop-tab").forEach(n=>{!n.classList.contains("shop-item-card")&&n.dataset.rippleBound||(n.addEventListener("click",function(n){const e=document.createElement("span");e.classList.add("shop-ripple");const t=this.getBoundingClientRect(),o=Math.max(t.width,t.height);e.style.width=e.style.height=o+"px",e.style.left=n.clientX-t.left-o/2+"px",e.style.top=n.clientY-t.top-o/2+"px",this.appendChild(e),setTimeout(()=>e.remove(),600)}),n.classList.contains("shop-item-card")||(n.dataset.rippleBound="true"))}),document.querySelectorAll(".shop-tab").forEach(n=>{n.dataset.tabBound||(n.addEventListener("click",function(){document.querySelectorAll(".shop-tab").forEach(n=>n.classList.remove("active")),this.classList.add("active")}),n.dataset.tabBound="true")}),document.querySelectorAll(".shop-nav-btn, .shop-addressbar-btn, .shop-titlebar-btn:not([onclick])").forEach(n=>{n.dataset.preventBound||(n.addEventListener("click",n=>n.preventDefault()),n.dataset.preventBound="true")});const r=document.querySelectorAll(".shop-nav-btn");if(r.length>=3){const n=r[2];n&&!n.dataset.refreshBound&&(n.addEventListener("click",async n=>{n.preventDefault(),n.stopPropagation(),console.log("🔄 点击刷新按钮"),await _s()}),n.dataset.refreshBound="true",console.log("✅ 刷新按钮事件已绑定"))}const s=document.getElementById("shopItemModal"),l=s?s.querySelector(".shop-modal-window"):null;if(l&&(l.dataset.eventBound||(l.addEventListener("click",n=>{n.stopPropagation()}),l.dataset.eventBound="true")),s){const e=s.querySelectorAll(".shop-action-btn");if(e.length>=2){const t=e[1];t&&!t.dataset.wishlistBound&&(t.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const o=s.getAttribute("data-current-index");if(null!==o){const e=parseInt(o,10),a=Us[e];if(a){await n.addToWishlist(a)&&(t.style.opacity="0.6",setTimeout(()=>{t.style.opacity="1"},300))}}}),t.dataset.wishlistBound="true",console.log("✅ ADD TO WISHLIST按钮事件已绑定"))}}!function(){const n=document.getElementById("shopItemsGrid");if(!n)return;n.innerHTML=t.map((n,e)=>`\n        <div class="shop-item-card" onclick="openShopItemModal(${e})">\n          <div class="shop-item-image-container">\n            <img src="${n.image.replace("w=800","w=400")}" alt="${n.title}" class="shop-item-image">\n          </div>\n          <div class="shop-item-title">${n.title}</div>\n          <div class="shop-item-seller shop-pixel-text">seller: ${n.seller}</div>\n          <div class="shop-item-footer">\n            <div class="shop-item-price">${n.price}</div>\n            <div class="shop-item-status">${n.status}</div>\n          </div>\n        </div>\n      `).join("");const e=document.getElementById("shopItemCount");e&&(e.textContent=`${t.length} items`)}(),function(){console.log("📄 页面导航系统初始化");const n=document.querySelectorAll(".shop-nav-btn");if(n.length>=2){const e=n[0],t=n[1];e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),Es&&Bs()}),e.dataset.navBound="true",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),Es||zs()}),t.dataset.navBound="true",console.log("✅ Nav-btn导航事件已绑定")}}()}n.openMapPage=Ms,n.closeMapPage=Ts,n.regenerateMapDatingData=async function(){try{console.log("🔄 [第十五个情景] 开始重新生成地图约会数据...");const t=e();if(!t)return void console.error("❌ 无法获取数据库");const o=`mapDatingData_${vt||"main"}`;await t.xMapDatingData.delete(o),console.log("✅ [第十五个情景] 已删除旧数据"),n.MapGenerator&&(n.MapGenerator.landmarks=[]);await Ss.generateMapDatingData()?(console.log("✅ [第十五个情景] 重新生成完成，正在刷新页面..."),Ts(),setTimeout(()=>{Ms()},100)):console.error("❌ [第十五个情景] 重新生成失败")}catch(n){console.error("❌ [第十五个情景] 重新生成出错:",n)}},n.openUserMapProfile=function(){Ss.showUserProfileCard()},n.MapDatingController=Ss,n.MapGenerator=Is;let Es=!1;function zs(){const n=document.getElementById("shopItemsGrid"),e=document.getElementById("wishlistContent");n&&(n.style.display="none"),e&&(e.classList.add("active"),Ls()),Es=!0,console.log("➡️ 切换到收藏页面")}function Bs(){const n=document.getElementById("shopItemsGrid"),e=document.getElementById("wishlistContent");n&&(n.style.display="grid"),e&&e.classList.remove("active"),Es=!1,console.log("⬅️ 返回首页")}async function Ls(){try{const t=n.currentAccountId||"main",o=await e(),a=`wishlist_${t}`,i=await o.xAccountProfiles.get(a),r=i&&i.items?i.items:[];console.log(`💝 加载收藏列表，共 ${r.length} 个商品`);const s=document.getElementById("wishlistHeaderCount");s&&(s.textContent=r.length,s.classList.remove("updated"),s.offsetWidth,s.classList.add("updated"),setTimeout(()=>s.classList.remove("updated"),400));const l=document.getElementById("wishlistStatValue"),c=document.getElementById("wishlistStatWeek"),d=document.getElementById("wishlistStatAvg");if(r.length>0){const n=r.map(n=>{const e=n.price.replace(/[^0-9.]/g,"");return parseFloat(e)||0}),e=n.reduce((n,e)=>n+e,0),t=e/n.length;l&&(l.textContent=`$${e.toFixed(0)}`),d&&(d.textContent=`$${t.toFixed(0)}`)}else l&&(l.textContent="$0"),d&&(d.textContent="$0");const p=Date.now()-6048e5,g=r.filter(n=>n.addedAt&&n.addedAt>p).length;c&&(c.textContent=g);const m=document.getElementById("wishlistItemsGrid");if(!m)return;const x=m.querySelector(".wishlist-empty");if(x&&r.length>0&&x.remove(),0===r.length)x||(m.innerHTML='\n            <div class="wishlist-empty">\n              <div class="wishlist-empty-icon">□</div>\n              <h2 class="wishlist-empty-title">No Items Saved</h2>\n              <p class="wishlist-empty-text">\n                Click "ADD TO WISHLIST" in product details<br>\n                to start building your archive\n              </p>\n            </div>\n          ');else{const e=r.map((n,e)=>renderWishlistItemCard(n,e)).join("");m.innerHTML=e,m.querySelectorAll(".wishlist-remove-btn").forEach((n,e)=>{n.addEventListener("click",n=>{n.stopPropagation(),Ps(e)})}),m.querySelectorAll(".wishlist-archive-card").forEach((e,t)=>{e.addEventListener("click",e=>{if(e.target.classList.contains("wishlist-remove-btn"))return;!function(e){const t=Us.findIndex(n=>n.title===e.title&&n.seller===e.seller);-1!==t?n.openShopItemModal(t):console.log("ℹ️ 商品不在当前列表中，显示收藏的商品信息")}(r[t])})})}}catch(n){console.error("❌ 加载收藏列表失败:",n)}}async function Ps(t){try{const o=n.currentAccountId||"main",a=await e(),i=`wishlist_${o}`,r=await a.xAccountProfiles.get(i);if(!r||!r.items)return;const s=r.items,l=s[t];s.splice(t,1);const c={handle:i,name:"wishlist",accountId:o,items:s,totalCount:s.length,updatedAt:Date.now()};await a.xAccountProfiles.put(c),console.log("🗑️ 商品已从收藏列表移除:",l.title),Ds("Removed from wishlist","success"),Ls()}catch(n){console.error("❌ 从收藏列表移除失败:",n),Ds("Failed to remove from wishlist","error")}}function Ds(n,e="info"){const t=document.createElement("div");t.style.cssText=`\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      padding: 16px 24px;\n      background: ${"success"===e?"#4a4a4a":"error"===e?"#6a4a4a":"#5a5a5a"};\n      color: #fff;\n      font-family: 'IBM Plex Mono', monospace;\n      font-size: 12px;\n      border: 2px solid ${"success"===e?"#6a6a6a":"error"===e?"#8a6a6a":"#7a7a7a"};\n      border-radius: 4px;\n      z-index: 99999;\n      pointer-events: none;\n      animation: toastFadeIn 0.3s ease-out;\n    `,t.textContent=n,document.body.appendChild(t),setTimeout(()=>{t.style.animation="toastFadeOut 0.3s ease-out",setTimeout(()=>{document.body.removeChild(t)},300)},2e3)}n.switchToWishlist=zs,n.switchToHome=Bs,n.addToWishlist=async function(t){try{const o=n.currentAccountId||"main",a=await e(),i=`wishlist_${o}`,r=await a.xAccountProfiles.get(i);let s=r&&r.items?r.items:[];if(s.some(n=>n.title===t.title&&n.seller===t.seller))return console.log("⚠️ 商品已在收藏列表中"),Ds("This item is already in your wishlist","info"),!1;const l={...t,addedAt:Date.now()};s.push(l);const c={handle:i,name:"wishlist",accountId:o,items:s,totalCount:s.length,updatedAt:Date.now()};return await a.xAccountProfiles.put(c),console.log("💝 商品已添加到收藏列表:",t.title),Ds("Added to wishlist!","success"),Es&&Ls(),!0}catch(n){return console.error("❌ 添加到收藏列表失败:",n),Ds("Failed to add to wishlist","error"),!1}},n.removeFromWishlist=Ps,n.loadWishlistItems=Ls;let Ns=!1,Rs=!1,Hs=!1,js=[],Us=[];async function Os(){try{const{xDb:e}=await g.loadConfigAndSettings(),t=`shopProducts_${n.currentAccountId||"main"}`,o=await e.xAccountProfiles.get(t);return o&&o.products&&o.products.length>0?(console.log("📦 [第十八情景] 加载已保存的商品数据:",o.products.length,"个商品"),js=o.products,Hs=!0,o.products):(console.log("ℹ️ [第十八情景] 数据库中无商品数据"),null)}catch(n){return console.error("❌ [第十八情景] 加载商品数据失败:",n),null}}async function _s(){if(Rs)return console.log("⚠️ 商品正在生成中，请稍候..."),void("function"==typeof n.showXToast&&n.showXToast("🛍️ 商品正在生成中，请稍候...","info"));if(confirm("🔄 确认刷新商品数据？\n\n⚠️ 这将重新生成所有商品（但保留角色店铺映射）")){console.log("🔄 开始刷新商品数据..."),"function"==typeof n.showXToast&&n.showXToast("🔄 正在重新生成商品，请稍候...","info");try{const{xDb:e}=await g.loadConfigAndSettings(),t=`shopProducts_${n.currentAccountId||"main"}`;await e.xAccountProfiles.delete(t),console.log("✅ 已清空商品数据"),js=[],Hs=!1,console.log("🎯 触发第十八情景重新生成商品...");const o=await n.generateShopProducts();if(!(o&&o.length>0))throw new Error("生成的商品数据为空");{console.log(`✅ 商品刷新成功！共生成 ${o.length} 个商品`),Us=o;const e=document.getElementById("shopItemsGrid");e&&(console.log("🔄 开始更新商品显示（带动画）..."),e.classList.add("shop-grid-fade-out"),setTimeout(()=>{e.innerHTML=Us.map((n,e)=>`\n              <div class="shop-item-card" onclick="openShopItemModal(${e})">\n                <div class="shop-item-image-container">\n                  <img src="${n.image.replace("w=800","w=400")}" alt="${n.title}" class="shop-item-image">\n                </div>\n                <div class="shop-item-title">${n.title}</div>\n                <div class="shop-item-seller shop-pixel-text">seller: ${n.seller}</div>\n                <div class="shop-item-footer">\n                  <div class="shop-item-price">${n.price}</div>\n                  <div class="shop-item-status">${n.status}</div>\n                </div>\n              </div>\n            `).join("");const n=document.getElementById("shopItemCount");n&&(n.textContent=`${Us.length} items`),e.classList.remove("shop-grid-fade-out"),e.classList.add("shop-grid-fade-in"),setTimeout(()=>{e.classList.remove("shop-grid-fade-in"),console.log("✅ 商品显示已更新（动画完成）")},600)},300)),"function"==typeof n.showXToast?n.showXToast(`✅ 商品刷新成功！共生成 ${o.length} 个商品`,"success"):alert(`✅ 商品刷新成功！共生成 ${o.length} 个商品`)}}catch(e){console.error("❌ 商品刷新失败:",e),"function"==typeof n.showXToast?n.showXToast("❌ 商品刷新失败，请稍后重试","error"):alert("❌ 商品刷新失败，请稍后重试"),await Os()}}else console.log("ℹ️ 用户取消了商品刷新")}async function Fs(){try{console.log("🚀 初始化 X Social App..."),yl&&(clearInterval(yl),yl=null),wn&&(clearInterval(wn),wn=null),wl=!1,kn=!1,function(){const n="x-social-app-styles";if(document.getElementById(n))return;const e=document.createElement("style");e.id=n,e.textContent='\n /* ========== X社交页面主题变量 ========== */\n /* 将CSS变量限定在X应用容器内,避免影响其他页面 */\n #x-social-screen {\n --x-bg-primary: #000; --x-bg-secondary: #1a1a1a; --x-bg-hover: rgba(255,255,255,0.03); --x-border-color: #2f3336; --x-text-primary: #fff; --x-text-secondary: #71767b; --x-text-tertiary: #8b98a5; --x-accent: #1d9bf0; --x-input-bg: #1a1a1a; --x-modal-overlay: rgba(91, 112, 131, 0.4); }\n /* 日间模式 */\n #x-social-screen.x-theme-light {\n --x-bg-primary: #fff; --x-bg-secondary: #f7f9f9; --x-bg-hover: rgba(0,0,0,0.03); --x-border-color: #eff3f4; --x-text-primary: #0f1419; --x-text-secondary: #536471; --x-text-tertiary: #5b7083; --x-accent: #1d9bf0; --x-input-bg: #f7f9f9; --x-modal-overlay: rgba(0, 0, 0, 0.4); }\n /* ========== X社交页面基础样式 ========== */\n /* 自定义滚动条样式 - X风格（细长短小亮蓝色） */\n .tab-content::-webkit-scrollbar,\n #x-comments-page::-webkit-scrollbar,\n .comments-container::-webkit-scrollbar,\n .settings-content::-webkit-scrollbar,\n .profile-content::-webkit-scrollbar,\n .tweets-container::-webkit-scrollbar,\n #detail-comments-container::-webkit-scrollbar,\n .modal-body::-webkit-scrollbar,\n #identity-characters-list::-webkit-scrollbar,\n #characters-list::-webkit-scrollbar,\n #x-presets-list::-webkit-scrollbar,\n .tweet-media-scrollable::-webkit-scrollbar {\n width: 3px; }\n .tab-content::-webkit-scrollbar-track,\n #x-comments-page::-webkit-scrollbar-track,\n .comments-container::-webkit-scrollbar-track,\n .settings-content::-webkit-scrollbar-track,\n .profile-content::-webkit-scrollbar-track,\n .tweets-container::-webkit-scrollbar-track,\n #detail-comments-container::-webkit-scrollbar-track,\n .modal-body::-webkit-scrollbar-track,\n #identity-characters-list::-webkit-scrollbar-track,\n #characters-list::-webkit-scrollbar-track,\n #x-presets-list::-webkit-scrollbar-track,\n .tweet-media-scrollable::-webkit-scrollbar-track {\n background: transparent; }\n .tab-content::-webkit-scrollbar-thumb,\n #x-comments-page::-webkit-scrollbar-thumb,\n .comments-container::-webkit-scrollbar-thumb,\n .settings-content::-webkit-scrollbar-thumb,\n .profile-content::-webkit-scrollbar-thumb,\n .tweets-container::-webkit-scrollbar-thumb,\n #detail-comments-container::-webkit-scrollbar-thumb,\n .modal-body::-webkit-scrollbar-thumb,\n #identity-characters-list::-webkit-scrollbar-thumb,\n #characters-list::-webkit-scrollbar-thumb,\n #x-presets-list::-webkit-scrollbar-thumb,\n .tweet-media-scrollable::-webkit-scrollbar-thumb {\n background-color: color-mix(in srgb, var(--x-accent) 50%, transparent); border-radius: 10px; min-height: 30px; max-height: 80px; }\n .tab-content::-webkit-scrollbar-thumb:hover,\n #x-comments-page::-webkit-scrollbar-thumb:hover,\n .comments-container::-webkit-scrollbar-thumb:hover,\n .settings-content::-webkit-scrollbar-thumb:hover,\n .profile-content::-webkit-scrollbar-thumb:hover,\n .tweets-container::-webkit-scrollbar-thumb:hover,\n #detail-comments-container::-webkit-scrollbar-thumb:hover,\n .modal-body::-webkit-scrollbar-thumb:hover,\n #identity-characters-list::-webkit-scrollbar-thumb:hover,\n #characters-list::-webkit-scrollbar-thumb:hover,\n #x-presets-list::-webkit-scrollbar-thumb:hover,\n .tweet-media-scrollable::-webkit-scrollbar-thumb:hover {\n background-color: color-mix(in srgb, var(--x-accent) , 0.8); }\n .tab-content::-webkit-scrollbar-thumb:active,\n #x-comments-page::-webkit-scrollbar-thumb:active,\n .comments-container::-webkit-scrollbar-thumb:active,\n .settings-content::-webkit-scrollbar-thumb:active,\n .profile-content::-webkit-scrollbar-thumb:active,\n .tweets-container::-webkit-scrollbar-thumb:active,\n #detail-comments-container::-webkit-scrollbar-thumb:active,\n .modal-body::-webkit-scrollbar-thumb:active,\n #identity-characters-list::-webkit-scrollbar-thumb:active,\n #characters-list::-webkit-scrollbar-thumb:active,\n #x-presets-list::-webkit-scrollbar-thumb:active,\n .tweet-media-scrollable::-webkit-scrollbar-thumb:active {\n background-color: var(--x-accent); }\n /* 修复X社交页面高度布局问题 */\n #x-social-screen {\n height: 100vh !important; overflow: hidden !important; background-color:var(--x-bg-primary) !important; color:var(--x-text-primary) !important; }\n #x-social-screen .x-pages-container {\n min-height: 0 !important; background-color:var(--x-bg-primary) !important; }\n #x-social-screen .x-page {\n min-height: 0 !important; background-color:var(--x-bg-primary) !important; }\n #x-social-screen .x-bottom-nav {\n flex-shrink: 0 !important; background-color:var(--x-bg-primary) !important; border-top: 1px solid var(--x-border-color) !important; }\n /* 所有页面容器使用主题背景色 */\n #x-home-page,\n #x-search-page,\n #x-notifications-page,\n #x-messages-page,\n #x-comments-page,\n #x-settings-page,\n #x-tweet-detail-page,\n #x-profile-page,\n #account-profile-page {\n background-color:var(--x-bg-primary) !important; }\n /* 顶部导航栏 - 限定在X应用内 - 🔥 使用全局padding变量系统 */\n /* 主顶栏 - 整个X应用的顶栏 */\n #x-social-screen .x-top-bar {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; padding: var(--app-header-total-padding) 15px 15px 15px !important; }\n /* 内部子页面的顶栏 - 不需要响应全局padding（它们已经在主顶栏下方） */\n #x-social-screen .settings-header,\n #x-social-screen .tweet-detail-header,\n #x-social-screen .profile-header {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; }\n /* 独立全屏页面的顶栏 - 需要响应全局padding */\n #x-social-screen .message-detail-header {\n background-color:var(--x-bg-primary) !important; padding: var(--app-header-total-padding) 16px 12px 16px !important; }\n /* X提问箱页顶栏（独立全屏） */\n #x-askbox-page > div:nth-child(2) > div:nth-child(1) {\n padding: var(--base-top-padding) 16px 12px 16px !important; }\n /* X直播页顶栏（独立全屏） */\n #x-live-page > div:nth-child(1) {\n padding: var(--app-header-total-padding) 16px 12px 16px !important; }\n /* X文章页顶栏（独立全屏） */\n #x-article-page > div > div:nth-child(1) {\n padding: var(--app-header-total-padding) 16px 12px 16px !important; }\n /* 标签栏 - 限定在X应用内 */\n #x-social-screen .x-home-tabs,\n #x-social-screen .search-tabs,\n #x-social-screen .profile-tabs {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; }\n /* 输入区域 - 限定在X应用内 */\n #x-social-screen .comment-input-area,\n #x-social-screen .detail-comment-input-area {\n background-color:var(--x-bg-primary) !important; border-top: 1px solid var(--x-border-color) !important; }\n /* 设置页面内容 - 限定在X应用内 */\n #x-social-screen .settings-content {\n background-color:var(--x-bg-primary) !important; }\n /* 搜索头部 - 限定在X应用内 */\n #x-social-screen .search-header {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; }\n /* 搜索框 - 限定在X应用内 */\n #x-social-screen .search-box {\n background-color: var(--x-input-bg) !important; }\n /* 热搜视图 - 限定在X应用内 */\n #trending-view,\n #x-social-screen .trending-list {\n background-color:var(--x-bg-primary) !important; }\n /* 搜索结果内容 */\n #search-results-content {\n background-color:var(--x-bg-primary) !important; }\n /* 弹窗和模态框 - 限定在X应用内 */\n #x-social-screen .modal-content,\n #x-social-screen .compose-modal-content,\n #x-social-screen #edit-profile-modal .modal-content,\n #x-social-screen #compose-tweet-modal .compose-modal-content,\n #character-x-profile-modal > div > div,\n #relationship-modal > div > div,\n #category-manager-modal > div,\n #character-relationship-graph-modal > div > div,\n #edit-relationship-detail-modal > div > div,\n #npc-edit-modal > div > div {\n background-color:var(--x-bg-primary) !important; }\n /* 模态框头部 - 限定在X应用内 */\n #x-social-screen .modal-header,\n #x-social-screen .compose-header {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; }\n /* 模态框主体内容区域 - 限定在X应用内 */\n #x-social-screen .modal-body,\n #x-social-screen .compose-body {\n background-color:var(--x-bg-primary) !important; }\n /* 表单元素 - 限定在X应用内 */\n #x-social-screen input[type="text"],\n #x-social-screen input[type="url"],\n #x-social-screen input[type="email"],\n #x-social-screen textarea,\n #x-social-screen select {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n #x-social-screen input[type="text"]:focus,\n #x-social-screen input[type="url"]:focus,\n #x-social-screen input[type="email"]:focus,\n #x-social-screen textarea:focus,\n #x-social-screen select:focus {\n border-color: var(--x-accent) !important; }\n /* 引用推文 - 限定在X应用内 */\n #x-social-screen .quoted-tweet {\n border-color: var(--x-border-color) !important; background-color: var(--x-bg-hover) !important; }\n /* 回复连接线 - 限定在X应用内 */\n #x-social-screen .comment-item.has-replies::after,\n #x-social-screen .reply-item::before {\n background-color: var(--x-border-color) !important; border-color: var(--x-border-color) !important; }\n /* 卡片和容器 */\n #character-info-display,\n #character-relationships-list,\n #identity-characters-list,\n #characters-list,\n #npcs-list,\n #npc-bind-users {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; }\n /* 内容容器 - 限定在X应用内 */\n #x-social-screen .tab-content,\n #x-social-screen .tweets-container,\n #x-social-screen .comments-container,\n #detail-comments-container,\n #tweet-detail-container,\n #x-profile-tweets-container,\n #account-tweets-container,\n #x-social-screen .profile-content {\n background-color:var(--x-bg-primary) !important; }\n /* 列表项悬停效果 - 限定在X应用内 */\n #x-social-screen .tweet-item:hover,\n #x-social-screen .comment-item:hover,\n #x-social-screen .trending-item:hover {\n background-color: var(--x-bg-hover) !important; }\n /* 账户资料页面 - 限定在X应用内 */\n #x-social-screen .user-info-section,\n #x-social-screen .edit-avatar-section,\n #x-social-screen .edit-form-section {\n background-color:var(--x-bg-primary) !important; }\n /* 设置区域的卡片 */\n #character-binding-area > div,\n #relationship-binding-area > div,\n #npc-binding-area > div {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; }\n /* 热搜项目 - 限定在X应用内 */\n #x-social-screen .trending-item {\n background-color:var(--x-bg-primary) !important; }\n /* 推文详情页面 - 限定在X应用内 */\n #x-social-screen .tweet-detail-content {\n background-color:var(--x-bg-primary) !important; }\n /* 所有文本颜色 */\n #x-social-screen span,\n #x-social-screen div:not(.tweet-action):not(.comment-action) {\n color: inherit; }\n /* 标签文本 - 限定在X应用内 */\n #x-social-screen .x-tab {\n color:var(--x-text-secondary) !important; }\n #x-social-screen .x-tab.active {\n color:var(--x-text-primary) !important; }\n /* SVG图标颜色 - 非激活状态 */\n #x-social-screen .x-back-btn svg,\n #x-social-screen .x-settings svg,\n #x-social-screen .x-refresh-btn svg,\n #x-social-screen .settings-back-btn svg,\n #x-social-screen .comments-back-btn svg,\n #x-social-screen .profile-back-btn svg,\n #x-social-screen .tweet-detail-back-btn svg {\n fill: var(--x-text-primary) !important; }\n /* 次要SVG图标 */\n #x-social-screen .tweet-more {\n color:var(--x-text-secondary) !important; }\n /* 按钮文本颜色 */\n #x-social-screen button {\n color: inherit; }\n /* 占位符文本 */\n #x-social-screen ::placeholder {\n color:var(--x-text-secondary) !important; }\n /* 次要文本元素 */\n .tweet-time,\n .tweet-user-handle,\n .comment-time,\n .quoted-user-handle,\n .quoted-user-time {\n color:var(--x-text-secondary) !important; }\n /* 主要文本元素 */\n .tweet-user-name,\n .tweet-content,\n .comment-content,\n .quoted-user-name,\n .quoted-content {\n color:var(--x-text-primary) !important; }\n /* 热搜标题和类别 */\n .trending-title {\n color:var(--x-text-primary) !important; }\n .trending-category,\n .trending-count {\n color:var(--x-text-secondary) !important; }\n /* 关系预览区域 */\n #relationship-preview {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 关系图编辑器 */\n #relationship-graph-canvas {\n background-color:var(--x-bg-primary) !important; }\n /* ========== 账户主页和详情页动态元素样式 ========== */\n /* 账户主页推文容器内的所有span（覆盖内联样式） */\n #account-tweets-container span[style*="color: #fff"],\n #account-tweets-container span[style*="color:#fff"],\n #account-tweets-container span[style*="color: rgb(255, 255, 255)"] {\n color:var(--x-text-primary) !important; }\n #account-tweets-container span[style*="color: #71767b"],\n #account-tweets-container span[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 账户主页推文容器内的div文本颜色 */\n #account-tweets-container div[style*="color: #fff"],\n #account-tweets-container div[style*="color:#fff"],\n #account-tweets-container div[style*="color: #e7e9ea"],\n #account-tweets-container div[style*="color:#e7e9ea"] {\n color:var(--x-text-primary) !important; }\n #account-tweets-container div[style*="color: #71767b"],\n #account-tweets-container div[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 账户主页推文容器内的边框 */\n #account-tweets-container > div[style*="border-bottom"] {\n border-bottom-color: var(--x-border-color) !important; }\n /* 账户主页推文容器内的背景卡片 */\n #account-tweets-container div[style*="background-color: #202327"],\n #account-tweets-container div[style*="background-color:#202327"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 账户主页推文容器内的SVG图标 */\n #account-tweets-container svg[style*="fill: currentColor"] {\n fill: currentColor !important; }\n #account-tweets-container svg[style*="fill: #71767b"],\n #account-tweets-container svg[style*="fill:#71767b"] {\n fill: var(--x-text-secondary) !important; }\n /* 推文详情页评论容器内的所有文本 */\n #detail-comments-container span[style*="color: #fff"],\n #detail-comments-container span[style*="color:#fff"] {\n color:var(--x-text-primary) !important; }\n #detail-comments-container span[style*="color: #71767b"],\n #detail-comments-container span[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n #detail-comments-container div[style*="color: #fff"],\n #detail-comments-container div[style*="color:#fff"] {\n color:var(--x-text-primary) !important; }\n #detail-comments-container div[style*="color: #71767b"],\n #detail-comments-container div[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 推文详情页评论容器内的边框和连接线 */\n #detail-comments-container div[style*="border-bottom"] {\n border-bottom-color: var(--x-border-color) !important; }\n #detail-comments-container div[style*="background-color: #2f3336"],\n #detail-comments-container div[style*="background-color:#2f3336"] {\n background-color: var(--x-border-color) !important; }\n /* 推文详情页评论容器内的卡片背景 */\n #detail-comments-container div[style*="background-color: #202327"],\n #detail-comments-container div[style*="background-color:#202327"],\n #detail-comments-container div[style*="background-color: #1a1a1a"],\n #detail-comments-container div[style*="background-color:#1a1a1a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 推文详情容器内的所有文本 */\n #tweet-detail-container span[style*="color: #fff"],\n #tweet-detail-container span[style*="color:#fff"] {\n color:var(--x-text-primary) !important; }\n #tweet-detail-container span[style*="color: #71767b"],\n #tweet-detail-container span[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n #tweet-detail-container div[style*="color: #fff"],\n #tweet-detail-container div[style*="color:#fff"] {\n color:var(--x-text-primary) !important; }\n #tweet-detail-container div[style*="color: #71767b"],\n #tweet-detail-container div[style*="color:#71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 推文详情容器内的边框 */\n #tweet-detail-container div[style*="border-bottom"],\n #tweet-detail-container div[style*="border-top"] {\n border-color: var(--x-border-color) !important; }\n /* 所有动态生成的互动按钮悬停效果 */\n #account-tweets-container div[style*="cursor: pointer"],\n #detail-comments-container div[style*="cursor: pointer"],\n #tweet-detail-container div[style*="cursor: pointer"] {\n color: inherit !important; }\n /* 蓝色高亮文本（@提及、链接等） */\n span[style*="color: var(--x-accent)"],\n span[style*="color:#1d9bf0"],\n div[style*="color: var(--x-accent)"],\n div[style*="color:#1d9bf0"] {\n color: var(--x-accent) !important; }\n /* 账户主页标签栏的"已置顶"文本 */\n #account-tweets-container span[style*="color: #71767b"][style*="font-size: 13px"][style*="font-weight: 700"] {\n color:var(--x-text-secondary) !important; }\n /* 账户主页的所有互动数字 */\n #account-tweets-container span[style*="font-size: 13px"]:not([style*="font-weight"]) {\n color:var(--x-text-secondary) !important; }\n /* ========== 角色X资料设置弹窗样式修复 ========== */\n /* 弹窗背景遮罩 */\n #character-x-profile-modal[style*="background-color: rgba(0,0,0,0.8)"],\n #relationship-modal[style*="background-color: rgba(0,0,0,0.8)"] {\n background-color: rgba(0,0,0,0.6) !important; }\n /* 弹窗主容器 */\n #character-x-profile-modal > div > div[style*="background-color:#000"],\n #relationship-modal > div > div[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; border-color: var(--x-border-color) !important; }\n /* 弹窗头部 */\n #character-x-profile-modal h2,\n #character-x-profile-modal h3,\n #relationship-modal h3 {\n color:var(--x-text-primary) !important; }\n /* 弹窗头部关闭按钮 */\n #character-x-profile-modal button[onclick*="close"] svg,\n #relationship-modal button[onclick*="close"] svg {\n fill: var(--x-text-secondary) !important; }\n /* 弹窗所有边框 */\n #character-x-profile-modal div[style*="border-bottom: 1px solid #333"],\n #character-x-profile-modal div[style*="border: 1px solid #333"],\n #relationship-modal div[style*="border-bottom: 1px solid #333"] {\n border-color: var(--x-border-color) !important; }\n /* 角色信息显示区域 */\n #character-info-display[style*="background-color: #0a0a0a"] {\n background-color:var(--x-bg-secondary) !important; }\n /* 弹窗内所有label文字 */\n #character-x-profile-modal label,\n #relationship-modal label {\n color:var(--x-text-primary) !important; }\n /* 弹窗内所有次要文字 */\n #character-x-profile-modal div[style*="color: #71767b"],\n #relationship-modal div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 弹窗内所有输入框 */\n #character-x-profile-modal input[type="text"],\n #character-x-profile-modal input[type="url"],\n #character-x-profile-modal textarea,\n #character-x-profile-modal select,\n #relationship-modal input[type="text"],\n #relationship-modal textarea,\n #relationship-modal select {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* 输入框焦点状态 */\n #character-x-profile-modal input:focus,\n #character-x-profile-modal textarea:focus,\n #character-x-profile-modal select:focus,\n #relationship-modal input:focus,\n #relationship-modal textarea:focus,\n #relationship-modal select:focus {\n border-color: var(--x-accent) !important; }\n /* 弹窗内的头像预览 */\n #character-x-avatar,\n #character-x-cover-preview {\n border-color: var(--x-border-color) !important; }\n /* 角色X资料弹窗头像填充 */\n #character-x-avatar {\n object-fit: cover !important; overflow: hidden !important; box-sizing: border-box !important; }\n /* 弹窗内的span文字 */\n #character-x-profile-modal span[style*="color: #fff"],\n #relationship-modal span[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n #character-x-profile-modal span[style*="color: #71767b"],\n #relationship-modal span[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 提示框背景 */\n #character-x-profile-modal div[style*="background-color: color-mix(in srgb, var(--x-accent) , 0.1)"] {\n background-color: color-mix(in srgb, var(--x-accent) , 0.1) !important; border-color: var(--x-accent) !important; }\n /* 提示框内的文字 */\n #character-x-profile-modal div[style*="color: var(--x-accent)"] {\n color: var(--x-accent) !important; }\n /* 弹窗内的按钮 */\n #character-x-profile-modal button[type="button"][style*="background-color: transparent"],\n #relationship-modal button[type="button"][style*="background-color: transparent"] {\n border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* ========== X设置页面样式修复 ========== */\n /* 设置页面头部 */\n .settings-header[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; border-bottom-color: var(--x-border-color) !important; }\n /* 设置页面标题和返回按钮 */\n .settings-header span[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n .settings-back-btn svg[style*="fill: #fff"] {\n fill: var(--x-text-primary) !important; }\n /* 主题切换按钮图标 */\n #theme-icon-dark[style*="fill: #fff"] {\n fill: var(--x-text-primary) !important; }\n #theme-icon-light[style*="fill: #000"] {\n fill: var(--x-text-primary) !important; }\n /* 设置页面所有label */\n #x-settings-page label {\n color:var(--x-text-primary) !important; }\n /* 设置页面所有次要文字 */\n #x-settings-page p[style*="color: #71767b"],\n #x-settings-page div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 设置页面所有输入框和文本域 */\n #x-settings-page textarea,\n #x-settings-page input[type="text"] {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* 设置页面输入框焦点状态 */\n #x-settings-page textarea:focus,\n #x-settings-page input:focus {\n border-color: var(--x-accent) !important; }\n /* 设置页面所有容器背景 */\n #x-settings-page div[style*="background-color: #1a1a1a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 设置页面所有容器边框 */\n#x-settings-page div[style*="border: 1px solid #333"],\n#x-settings-page div[style*="border-bottom: 1px solid #333"],\n#x-settings-page div[style*="border-top: 1px solid #333"] {\nborder-color: var(--x-border-color) !important; }\n/* 世界事件分类标签 - 强制白色字体 */\n#world-events-list span[style*="background-color: var(--x-accent)"] {\ncolor: #ffffff !important; }\n /* 角色关系预览区域 */\n #relationship-preview[style*="background-color: #0a0a0a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 关系预览占位符文字 */\n #relationship-preview-placeholder {\n color:var(--x-text-secondary) !important; }\n /* 关系统计框 */\n #relationship-stats[style*="background-color: color-mix(in srgb, var(--x-accent) , 0.1)"] {\n background-color: color-mix(in srgb, var(--x-accent) , 0.1) !important; }\n #relationship-stats div[style*="color: var(--x-accent)"] {\n color: var(--x-accent) !important; }\n /* 切换开关背景 - 限定在X应用内 */\n #x-social-screen .toggle-switch[style*="background-color: #333"] {\n background-color: var(--x-border-color) !important; }\n /* 切换开关圆圈 - 限定在X应用内 */\n #x-social-screen .toggle-circle[style*="background-color:#fff"] {\n background-color:var(--x-text-primary) !important; }\n /* 设置页面标题文字 */\n #x-settings-page div[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n /* 预设管理区域 - 限定在X应用内 */\n #x-social-screen .preset-management h3 {\n color:var(--x-text-primary) !important; }\n /* NPC列表和角色列表容器 */\n #npcs-list,\n #characters-list {\n background-color: transparent !important; }\n /* 底部导航栏图标颜色 - 限定在X应用内 */\n #x-social-screen .x-nav-item svg {\n fill: var(--x-text-secondary) !important; }\n #x-social-screen .x-nav-item.active svg {\n fill: var(--x-accent) !important; }\n /* 底部导航栏的高亮点 - 限定在X应用内 */\n #x-social-screen .x-nav-item .nav-highlight {\n background-color: var(--x-accent) !important; }\n /* 浮动按钮 - 限定在X应用内 */\n #x-social-screen .compose-btn {\n background-color: var(--x-accent) !important; }\n /* ========== 用户主页样式修复 ========== */\n /* 用户头像边框颜色和填充 - 更强制性地覆盖 */\n #x-profile-main-avatar {\n border: 5px solid var(--x-bg-primary) !important; object-fit: cover !important; background-color:var(--x-bg-primary) !important; box-sizing: border-box !important; overflow: hidden !important; }\n #edit-main-avatar {\n border: 4px solid var(--x-bg-primary) !important; object-fit: cover !important; background-color:var(--x-bg-primary) !important; box-sizing: border-box !important; overflow: hidden !important; }\n /* 用户头像在账户主页 */\n #account-avatar-image {\n border: 4px solid var(--x-bg-primary) !important; object-fit: cover !important; background-color:var(--x-bg-primary) !important; box-sizing: border-box !important; overflow: hidden !important; }\n /* 用户名和关注数据 */\n #x-profile-user-name,\n #x-profile-following-count,\n #x-profile-followers-count {\n color:var(--x-text-primary) !important; }\n /* 用户简介 */\n #x-profile-bio {\n color:var(--x-text-primary) !important; }\n /* 编辑资料按钮 */\n .user-info-section button {\n color:var(--x-text-primary) !important; border-color: var(--x-border-color) !important; }\n /* ========== 角色信息显示区域修复 ========== */\n /* 角色信息显示区域内的所有文字 */\n #character-info-display div[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n #character-info-display div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* ========== 搜索结果用户卡片修复 ========== */\n /* 搜索结果中的用户卡片边框 */\n #search-results-content > div[style*="border-bottom: 1px solid #2f3336"] {\n border-bottom-color: var(--x-border-color) !important; }\n /* 搜索结果中的用户名 */\n #search-results-content span[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n /* 搜索结果中的用户句柄 */\n #search-results-content div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 搜索结果中的用户简介 */\n #search-results-content div[style*="color: #e7e9ea"] {\n color:var(--x-text-primary) !important; }\n /* ========== NPC编辑弹窗修复 ========== */\n /* NPC弹窗背景 */\n #npc-edit-modal > div[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; }\n /* NPC弹窗头部边框 */\n #npc-edit-modal div[style*="border-bottom: 1px solid #2f3336"] {\n border-bottom-color: var(--x-border-color) !important; }\n /* NPC弹窗标题 */\n #npc-modal-title {\n color:var(--x-text-primary) !important; }\n /* NPC弹窗关闭按钮图标 */\n #npc-edit-modal svg[style*="fill: #fff"] {\n fill: var(--x-text-primary) !important; }\n /* NPC弹窗所有label */\n #npc-edit-modal label {\n color:var(--x-text-secondary) !important; }\n /* NPC弹窗所有输入框和文本域 */\n #npc-edit-modal input,\n #npc-edit-modal textarea {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* NPC弹窗输入框焦点状态 */\n #npc-edit-modal input:focus,\n #npc-edit-modal textarea:focus {\n border-color: var(--x-accent) !important; }\n /* NPC绑定用户列表容器 */\n #npc-bind-users {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* ========== NPC列表修复 ========== */\n /* NPC列表项背景和边框 */\n #npcs-list > div[style*="background-color: #0a0a0a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* NPC列表中的主要文字 */\n #npcs-list div[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n /* NPC列表中的次要文字 */\n #npcs-list div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* NPC列表项边框 */\n #npcs-list > div[style*="border: 1px solid #2f3336"] {\n border-color: var(--x-border-color) !important; }\n /* NPC列表空状态文字 */\n #npcs-list p[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* ========== 角色关系册修复 ========== */\n /* 角色关系册管理区域容器 */\n #relationship-binding-area > div[style*="background-color: #1a1a1a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 角色关系册标题 */\n #relationship-binding-area div[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n /* 角色关系册次要文字 */\n #relationship-binding-area div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系列表项 */\n #relationship-links-list > div[style*="background-color: #1a1a1a"] {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 角色关系列表中的文字 */\n #relationship-links-list span[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n #relationship-links-list span[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n #relationship-links-list div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系列表项的边框 */\n #relationship-links-list div[style*="border-top: 1px solid #2f3336"] {\n border-top-color: var(--x-border-color) !important; }\n /* 角色关系列表空状态 */\n #relationship-links-list > div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系详情弹窗背景 */\n #relationship-detail-modal > div > div[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; border-color: var(--x-border-color) !important; }\n /* 角色关系详情弹窗标题和label */\n #relationship-detail-modal h3,\n #relationship-detail-modal label {\n color:var(--x-text-primary) !important; }\n /* 角色关系详情弹窗次要文字 */\n #relationship-detail-modal div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系详情弹窗输入框 */\n #relationship-detail-modal input,\n #relationship-detail-modal textarea,\n #relationship-detail-modal select {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* 角色关系详情弹窗输入框焦点 */\n #relationship-detail-modal input:focus,\n #relationship-detail-modal textarea:focus,\n #relationship-detail-modal select:focus {\n border-color: var(--x-accent) !important; }\n /* 角色关系详情弹窗边框 */\n #relationship-detail-modal div[style*="border: 1px solid #333"],\n #relationship-detail-modal div[style*="border-bottom: 1px solid #333"] {\n border-color: var(--x-border-color) !important; }\n /* 角色关系详情弹窗关闭按钮 */\n #relationship-detail-modal button[onclick*="close"] svg {\n fill: var(--x-text-secondary) !important; }\n /* ========== 角色关系图编辑器弹窗修复 ========== */\n /* 角色关系图弹窗背景 */\n #character-relationship-graph-modal > div[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; border-color: var(--x-border-color) !important; }\n /* 角色关系图弹窗头部 */\n #character-relationship-graph-modal h2 {\n color:var(--x-text-primary) !important; }\n /* 角色关系图弹窗统计文字 */\n #character-relationship-graph-modal div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系图弹窗关闭按钮图标 */\n #character-relationship-graph-modal svg[style*="fill: #fff"] {\n fill: var(--x-text-primary) !important; }\n /* 角色关系图工具栏 */\n #character-relationship-graph-modal div[style*="background-color: #0a0a0a"] {\n background-color:var(--x-bg-secondary) !important; }\n /* 角色关系图工具栏提示文字 */\n #character-relationship-graph-modal > div > div:nth-child(2) div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 角色关系图画布区域背景 */\n #character-relationship-graph-modal div[style*="height: 500px"][style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; }\n /* 角色关系图空状态图标 */\n #graph-empty-state svg {\n fill: var(--x-border-color) !important; }\n /* 角色关系图底部按钮区域 */\n #character-relationship-graph-modal > div > div:last-child[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; }\n /* 角色关系图底部取消按钮 */\n #character-relationship-graph-modal button[onclick*="closeCharacter"] {\n border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* 关系列表区域标题 */\n #character-relationship-graph-modal div[style*="padding: 12px 20px"] div[style*="color: #fff"] {\n color:var(--x-text-primary) !important; }\n /* 角色关系图边框 */\n #character-relationship-graph-modal div[style*="border: 1px solid #333"],\n #character-relationship-graph-modal div[style*="border-bottom: 1px solid #333"] {\n border-color: var(--x-border-color) !important; }\n /* 角色关系图画布容器 */\n #character-relationship-graph-modal > div[style*="border: 1px solid #333"] {\n border-color: var(--x-border-color) !important; }\n /* 角色关系图空状态 */\n #graph-empty-state div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 关系列表标题文字 */\n #relationship-links-list-container h3 {\n color:var(--x-text-primary) !important; }\n /* 关系列表空状态 */\n #relationship-links-list div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 编辑关系详情弹窗背景遮罩 */\n #edit-relationship-detail-modal[style*="background-color: rgba(0, 0, 0"] {\n background-color: rgba(0, 0, 0, 0.85) !important; }\n /* 编辑关系详情弹窗主容器 */\n #edit-relationship-detail-modal > div > div[style*="background-color:#000"] {\n background-color:var(--x-bg-primary) !important; border-color: var(--x-border-color) !important; }\n /* 编辑关系详情弹窗标题 */\n #edit-relationship-detail-modal h3 {\n color:var(--x-text-primary) !important; }\n /* 编辑关系详情弹窗label */\n #edit-relationship-detail-modal label {\n color:var(--x-text-primary) !important; }\n /* 编辑关系详情弹窗次要文字 */\n #edit-relationship-detail-modal div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 编辑关系详情弹窗角色信息区域 */\n #relationship-characters-info {\n background-color:var(--x-bg-secondary) !important; border-color: var(--x-border-color) !important; }\n /* 编辑关系详情弹窗角色名称 */\n #char-a-name,\n #char-b-name {\n color:var(--x-text-primary) !important; }\n /* 编辑关系详情弹窗箭头符号 */\n #relationship-characters-info div[style*="color: #71767b"] {\n color:var(--x-text-secondary) !important; }\n /* 编辑关系详情弹窗关闭按钮图标 */\n #edit-relationship-detail-modal svg[style*="fill: #fff"] {\n fill: var(--x-text-primary) !important; }\n /* 编辑关系详情弹窗输入框 */\n #edit-relationship-detail-modal input,\n #edit-relationship-detail-modal textarea {\n background-color: var(--x-input-bg) !important; border-color: var(--x-border-color) !important; color:var(--x-text-primary) !important; }\n /* 编辑关系详情弹窗输入框焦点 */\n #edit-relationship-detail-modal input:focus,\n #edit-relationship-detail-modal textarea:focus {\n border-color: var(--x-accent) !important; }\n /* 编辑关系详情弹窗边框 */\n #edit-relationship-detail-modal div[style*="border: 1px solid #333"],\n #edit-relationship-detail-modal div[style*="border-bottom: 1px solid #333"] {\n border-color: var(--x-border-color) !important; }\n /* 编辑关系详情弹窗关闭按钮 */\n #edit-relationship-detail-modal button[onclick*="close"] svg {\n fill: var(--x-text-secondary) !important; }\n /* 个人资料标签栏 - 激活状态 - 限定在X应用内 */\n #x-social-screen .profile-tab.active {\n color:var(--x-text-primary) !important; font-weight: 700 !important; }\n /* 个人资料标签栏 - 非激活状态 - 限定在X应用内 */\n #x-social-screen .profile-tab:not(.active) {\n color:var(--x-text-secondary) !important; }\n /* 个人资料页面的其他文本 */\n #x-profile-header-name {\n color:var(--x-text-primary) !important; }\n /* 用户主页顶部功能按钮图标 - 限定在X应用内 */\n #x-social-screen .profile-header svg {\n fill: var(--x-text-primary) !important; }\n /* 返回按钮 - 限定在X应用内 */\n #x-social-screen .profile-back-btn svg {\n fill: var(--x-text-primary) !important; }\n /* 提问箱和更多选项按钮的图标 */\n #x-profile-page .profile-header > div > div svg {\n fill: var(--x-text-primary) !important; }\n /* ========== 推文详情页样式修复 ========== */\n /* 详情页顶栏背景和边框 */\n .tweet-detail-header {\n background-color:var(--x-bg-primary) !important; border-bottom: 1px solid var(--x-border-color) !important; }\n /* 详情页顶栏标题和返回按钮 */\n .tweet-detail-header span {\n color:var(--x-text-primary) !important; }\n .tweet-detail-header svg,\n .tweet-detail-back-btn svg {\n fill: var(--x-text-primary) !important; }\n /* 详情页主要内容区域 */\n #x-tweet-detail-page {\n background-color:var(--x-bg-primary) !important; }\n #tweet-detail-container {\n background-color:var(--x-bg-primary) !important; }\n /* 详情页推文内容区域 */\n .tweet-detail-content {\n background-color:var(--x-bg-primary) !important; }\n /* 详情页推文用户名和内容 */\n #tweet-detail-container .tweet-user-name,\n #tweet-detail-container .tweet-content,\n #x-tweet-detail-page .tweet-user-name,\n #x-tweet-detail-page .tweet-content {\n color:var(--x-text-primary) !important; }\n /* 详情页评论区域背景 */\n #detail-comments-container {\n background-color:var(--x-bg-primary) !important; }\n /* 详情页评论内容 */\n #detail-comments-container .comment-content,\n #detail-comments-container .tweet-user-name,\n #x-tweet-detail-page .comment-user-name {\n color:var(--x-text-primary) !important; }\n /* 详情页时间和其他次要文本 */\n #tweet-detail-container .tweet-time,\n #tweet-detail-container .tweet-user-handle,\n #detail-comments-container .tweet-user-handle,\n #detail-comments-container .comment-time,\n #x-tweet-detail-page .tweet-time,\n #x-tweet-detail-page .tweet-user-handle {\n color:var(--x-text-secondary) !important; }\n /* 详情页评论输入区域 */\n .detail-comment-input-area {\n background-color:var(--x-bg-primary) !important; border-top: 1px solid var(--x-border-color) !important; }\n .detail-comment-input-area textarea {\n background-color: var(--x-input-bg) !important; color:var(--x-text-primary) !important; border-color: var(--x-border-color) !important; }\n /* 详情页按钮颜色 */\n #reroll-replies-btn svg,\n .refresh-btn svg,\n #x-tweet-detail-page .refresh-btn svg {\n fill: var(--x-text-primary) !important; }\n /* 详情页所有span元素 */\n #x-tweet-detail-page span,\n #tweet-detail-container span {\n color: inherit; }\n /* 确保所有可滚动容器都有正确的高度设置 */\n .comments-container,\n .settings-content,\n .profile-content,\n .tab-content {\n min-height: 0 !important; }\n /* 确保推文容器也有正确的滚动 */\n .tweets-container {\n overflow-y: auto; min-height: 0; }\n /* 用户评论删除功能样式 */\n .comment-user-info {\n display: flex !important; align-items: center !important; gap: 4px !important; }\n .comment-delete-btn:hover {\n background-color: rgba(239, 68, 68, 0.1) !important; }\n .comment-delete-btn svg {\n transition: fill 0.2s ease; }\n .comment-delete-btn:hover svg {\n fill: #dc2626 !important; }\n /* 用户人设设置按钮样式 */\n .persona-setting-btn {\n box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }\n .persona-setting-btn:hover {\n box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }\n .persona-setting-btn:active {\n transform: scale(0.95) !important; }\n /* 推文项目 */\n #x-social-screen .tweet-item {\n padding: 15px; border-bottom: 1px solid var(--x-border-color); display: flex; gap: 12px; background-color:var(--x-bg-primary); }\n /* 用户头像 */\n #x-social-screen .tweet-avatar {\n width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; }\n /* 推文主要内容区域 */\n #x-social-screen .tweet-main {\n flex: 1; min-width: 0; }\n /* 用户信息行 */\n #x-social-screen .tweet-user-info {\n display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }\n #x-social-screen .tweet-user-name {\n font-weight: 700; color:var(--x-text-primary); font-size: 15px; }\n #x-social-screen .tweet-verified {\n width: 18px; height: 18px; fill: var(--x-accent); }\n #x-social-screen .tweet-user-handle {\n color:var(--x-text-secondary); font-size: 15px; }\n #x-social-screen .tweet-time {\n color:var(--x-text-secondary); font-size: 15px; }\n #x-social-screen .tweet-more {\n margin-left: auto; color: #71767b; cursor: pointer; padding: 5px; border-radius: 50%; }\n #x-social-screen .tweet-more:hover {\n background-color: color-mix(in srgb, var(--x-accent) , 0.1); color: var(--x-accent); }\n /* 推文内容 */\n #x-social-screen .tweet-content {\n color:var(--x-text-primary); font-size: 15px; line-height: 1.3; margin-bottom: 12px; word-wrap: break-word; }\n /* 话题标签和提及的高亮样式 */\n #x-social-screen .hashtag,\n #x-social-screen .mention {\n color: var(--x-accent); text-decoration: none; cursor: pointer; }\n #x-social-screen .hashtag:hover,\n #x-social-screen .mention:hover {\n text-decoration: underline; }\n /* 媒体内容 */\n #x-social-screen .tweet-media {\n margin-bottom: 12px; border-radius: 16px; overflow: hidden; position: relative; }\n #x-social-screen .tweet-image {\n width: 100%; max-height: 300px; object-fit: cover; display: block; }\n /* 敏感内容遮罩 */\n #x-social-screen .sensitive-overlay {\n position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; cursor: pointer; }\n #x-social-screen .sensitive-text {\n font-size: 15px; font-weight: 700; margin-bottom: 8px; }\n #x-social-screen .sensitive-description {\n font-size: 13px; color: #71767b; text-align: center; padding: 0 20px; }\n /* 互动按钮 - 限定在X应用内 */\n #x-social-screen .tweet-actions {\n display: flex; justify-content: space-between; max-width: 425px; margin-top: 5px; }\n #x-social-screen .tweet-action {\n display: flex; align-items: center; gap: 5px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; font-size: 13px; transition: all 0.2s; }\n #x-social-screen .tweet-action:hover {\n background-color: color-mix(in srgb, var(--x-accent) , 0.1); }\n #x-social-screen .tweet-action.comment:hover {\n color: var(--x-accent); }\n #x-social-screen .tweet-action.retweet:hover {\n color: #00ba7c; }\n #x-social-screen .tweet-action.like:hover,\n #x-social-screen .tweet-action.like.liked {\n color: #f91880; }\n #x-social-screen .tweet-action.bookmark:hover {\n color: var(--x-accent); }\n #x-social-screen .tweet-action.share:hover {\n color: var(--x-accent); }\n #x-social-screen .action-icon {\n width: 18px; height: 18px; }\n /* 点赞动画效果 */\n #x-social-screen .like-animation {\n animation: likeHeartbeat 0.6s ease-in-out; }\n @keyframes likeHeartbeat {\n 0% {\n transform: scale(1); }\n 25% {\n transform: scale(1.2); }\n 50% {\n transform: scale(1.4); }\n 75% {\n transform: scale(1.2); }\n 100% {\n transform: scale(1); }\n }\n #x-social-screen .tweet-action.like.liked .like-icon {\n fill: #f91880; }\n #x-social-screen .tweet-action.like.liked .like-count {\n color: #f91880; }\n /* 评论样式 */\n #x-social-screen .comment-item {\n padding: 15px; border-bottom: 1px solid var(--x-border-color); display: flex; gap: 12px; position: relative; background-color:var(--x-bg-primary); }\n /* 主评论后有回复时的连接线 */\n #x-social-screen .comment-item.has-replies::after {\n content: \'\'; position: absolute; left: 35px; /* 头像中心位置 */\n bottom: -1px; width: 1px; height: 28px; background-color: #2f3336; }\n #x-social-screen .comment-main {\n flex: 1; min-width: 0; }\n #x-social-screen .comment-user-info {\n display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }\n #x-social-screen .comment-content {\n color:var(--x-text-primary); font-size: 15px; line-height: 1.3; margin-bottom: 8px; word-wrap: break-word; }\n #x-social-screen .comment-actions {\n display: flex; justify-content: flex-start; gap: 60px; margin-top: 5px; }\n #x-social-screen .comment-action {\n display: flex; align-items: center; gap: 5px; padding: 8px; border-radius: 50%; cursor: pointer; color: #71767b; font-size: 13px; transition: all 0.2s; }\n /* 回复评论样式 */\n #x-social-screen .reply-item {\n margin-left: 50px; /* 精确对齐主评论的头像右侧 */\n padding-left: 0; padding-top: 8px; padding-bottom: 8px; border-left: none; position: relative; display: flex; align-items: flex-start; gap: 12px; }\n #x-social-screen .reply-item::before {\n content: \'\'; position: absolute; left: -30px; top: 16px; width: 14px; height: 14px; border-left: 1px solid #2f3336; border-bottom: 1px solid #2f3336; border-bottom-left-radius: 6px; }\n #x-social-screen .reply-to {\n color: var(--x-accent); margin-right: 5px; font-weight: 400; }\n /* 回复评论的头像稍小一些 */\n #x-social-screen .reply-item .tweet-avatar {\n width: 32px; height: 32px; }\n /* 引用推文样式 */\n #x-social-screen .quoted-tweet {\n border: 1px solid #2f3336; border-radius: 16px; margin: 12px 0; padding: 12px; background-color: rgba(0, 0, 0, 0.3); transition: background-color 0.2s ease; cursor: pointer; }\n #x-social-screen .quoted-tweet:hover {\n background-color: rgba(255, 255, 255, 0.03); }\n #x-social-screen .quoted-user-info {\n display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }\n #x-social-screen .quoted-user-avatar {\n width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0; }\n #x-social-screen .quoted-user-name {\n font-weight: 600; color: #fff; font-size: 13px; }\n #x-social-screen .quoted-user-handle {\n color: #71767b; font-size: 13px; }\n #x-social-screen .quoted-user-time {\n color: #71767b; font-size: 13px; }\n #x-social-screen .quoted-content {\n color: #fff; font-size: 14px; line-height: 1.3; word-wrap: break-word; }\n #x-social-screen .quote-indicator {\n color: #71767b; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 4px; }\n #x-social-screen .quote-indicator svg {\n width: 16px; height: 16px; fill: currentColor; }\n /* 搜索页面样式 - 🔥 使用全局padding变量 */\n #x-social-screen .search-header {\n padding: var(--base-top-padding) 16px 12px 16px; background: #000; border-bottom: 1px solid #2f3336; }\n #x-social-screen .search-box {\n display: flex; align-items: center; background: #202327; border-radius: 20px; padding: 10px 16px; gap: 12px; }\n #x-social-screen .search-box svg {\n width: 20px; height: 20px; fill: #71767b; flex-shrink: 0; }\n #x-social-screen .search-box input {\n flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 15px; }\n #x-social-screen .search-box input::placeholder {\n color: #71767b; }\n #x-social-screen .search-tabs {\n display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid #2f3336; gap: 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }\n #x-social-screen .search-tabs::-webkit-scrollbar {\n display: none; }\n #x-social-screen .search-tab {\n padding: 16px 0; cursor: pointer; color: #71767b; font-weight: 500; font-size: 15px; white-space: nowrap; position: relative; transition: color 0.2s; }\n #x-social-screen .search-tab.active {\n color: #fff; font-weight: 700; }\n #x-social-screen .search-tab.active::after {\n content: \'\'; position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: var(--x-accent); border-radius: 2px 2px 0 0; }\n #x-social-screen .search-tab:hover {\n color: #fff; }\n #x-social-screen .add-category-btn {\n display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: background 0.2s; }\n #x-social-screen .add-category-btn svg {\n width: 20px; height: 20px; fill: #71767b; }\n #x-social-screen .add-category-btn:hover {\n background: color-mix(in srgb, var(--x-accent) , 0.1); }\n #x-social-screen .add-category-btn:hover svg {\n fill: var(--x-accent); }\n #x-social-screen .trending-list {\n flex: 1; overflow-y: auto; }\n #x-social-screen .trending-item {\n padding: 12px 16px; cursor: pointer; transition: background 0.2s; position: relative; }\n #x-social-screen .trending-item:hover {\n background: rgba(255, 255, 255, 0.03); }\n #x-social-screen .trending-header {\n display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }\n #x-social-screen .trending-category {\n color: #71767b; font-size: 14px; font-weight: 800; line-height: 16px; }\n #x-social-screen .trending-more {\n padding: 4px; border-radius: 50%; cursor: pointer; transition: background 0.2s; }\n #x-social-screen .trending-more:hover {\n background: color-mix(in srgb, var(--x-accent) , 0.1); }\n #x-social-screen .trending-more svg {\n width: 18px; height: 18px; fill: #71767b; }\n #x-social-screen .trending-title {\n color: #fff; font-size: 15px; font-weight: 700; line-height: 20px; margin-bottom: 2px; }\n #x-social-screen .trending-count {\n color: #71767b; font-size: 13px; line-height: 16px; font-weight: 400; }\n #x-social-screen .refresh-trends-btn {\n position: fixed; right: 20px; bottom: 80px; width: 56px; height: 56px; background: var(--x-accent); border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); display: none; align-items: center; justify-content: center; transition: transform 0.2s, background 0.2s; z-index: 100; }\n #x-social-screen .refresh-trends-btn:hover {\n background: #1a8cd8; transform: scale(1.05); }\n #x-social-screen .refresh-trends-btn:active {\n transform: scale(0.95); }\n #x-social-screen .refresh-trends-btn svg {\n width: 24px; height: 24px; fill: #fff; }\n #x-social-screen .refresh-trends-btn.spinning svg {\n animation: spin 1s linear infinite; }\n @keyframes spin {\n from { transform: rotate(0deg); }\n to { transform: rotate(360deg); }\n }\n /* 脉冲动画 */\n @keyframes pulse {\n 0% {\n opacity: 1; transform: scale(1); }\n 50% {\n opacity: 0.6; transform: scale(1.2); }\n 100% {\n opacity: 1; transform: scale(1); }\n }\n /* 钱包成功弹窗入场动画 */\n @keyframes walletSuccessIn {\n from {\n opacity: 0; transform: scale(0.7) translateY(30px); }\n to {\n opacity: 1; transform: scale(1) translateY(0); }\n }\n /* 钱包成功图标检查动画 */\n @keyframes walletSuccessCheck {\n 0% {\n opacity: 0; transform: scale(0.3); }\n 50% {\n opacity: 1; transform: scale(1.1); }\n 100% {\n opacity: 1; transform: scale(1); }\n }\n /* 钱包激活按钮加载动画 */\n @keyframes walletActivating {\n 0% {\n background-position: 0% 50%; }\n 50% {\n background-position: 100% 50%; }\n 100% {\n background-position: 0% 50%; }\n }\n/* 轮盘光晕脉动动画 */\n@keyframes pulse {\n  0% {\n    opacity: 0.2;\n    transform: scale(0.98);\n  }\n  30% {\n    opacity: 0.4;\n    transform: scale(1.03);\n  }\n  60% {\n    opacity: 0.5;\n    transform: scale(1.06);\n  }\n  100% {\n    opacity: 0.2;\n    transform: scale(0.98);\n  }\n}\n\n/* 标签微脉动动画 */\n@keyframes labelPulse {\n  0%, 100% {\n    opacity: 0.35;\n  }\n  50% {\n    opacity: 0.5;\n  }\n}\n\n/* 点赞上浮动画 */\n@keyframes floatUp {\n  0% {\n    opacity: 1;\n    transform: translateY(0) scale(0.8) rotate(0deg);\n  }\n  20% {\n    opacity: 1;\n    transform: translateY(-50px) scale(1) rotate(5deg);\n  }\n  50% {\n    opacity: 0.8;\n    transform: translateY(-125px) scale(1.2) rotate(-3deg);\n  }\n  80% {\n    opacity: 0.3;\n    transform: translateY(-200px) scale(1.35) rotate(2deg);\n  }\n  100% {\n    opacity: 0;\n    transform: translateY(-250px) scale(1.4) rotate(0deg);\n  }\n}\n\n/* 标签悬停浮起效果 */\n@keyframes tagFloat {\n  0% {\n    transform: translateY(0) scale(1);\n  }\n  50% {\n    transform: translateY(-3px) scale(1.03);\n  }\n  100% {\n    transform: translateY(-2px) scale(1.02);\n  }\n}\n\n/* 按钮按下动画 */\n@keyframes btnPress {\n  0% {\n    transform: translateY(-1px) scale(1);\n  }\n  50% {\n    transform: translateY(3px) scale(0.95);\n  }\n  100% {\n    transform: translateY(2px) scale(0.97);\n  }\n}\n\n/* 弹幕列表初始化动画 */\n@keyframes danmakuScroll {\n  0% {\n    transform: translateY(-15px);\n    opacity: 0;\n    filter: blur(3px);\n  }\n  100% {\n    transform: translateY(0);\n    opacity: 1;\n    filter: blur(0);\n  }\n}\n\n/* ========== 用户资料下拉菜单主题适配 ========== */\n/* 下拉菜单背景和边框 */\n#profile-dropdown-menu {\n  background-color: var(--x-bg-secondary) !important;\n  border-color: var(--x-border-color) !important;\n}\n\n/* 下拉菜单项文字颜色 */\n#profile-dropdown-menu > div {\n  color: var(--x-text-primary) !important;\n}\n\n/* 下拉菜单项SVG图标颜色 */\n#profile-dropdown-menu svg {\n  fill: var(--x-text-primary) !important;\n}\n\n/* 下拉菜单项悬停背景 */\n#profile-dropdown-menu > div:hover {\n  background-color: var(--x-bg-hover) !important;\n}\n',document.head.appendChild(e),console.log("✅ X Social App: 样式已注入")}(),function(){if(document.getElementById("x-social-screen"))return void console.log("⚠️ X Social Screen 已存在，跳过创建");const n=document.createElement("div");n.id="x-social-screen",n.className="screen",n.style.cssText="background-color:var(--x-bg-primary); color:var(--x-text-primary); display: flex; flex-direction: column; height: 100vh; overflow: hidden;",n.innerHTML='\n\n<div class="x-top-bar"\n style="display: flex; justify-content: space-between; align-items: center; padding: var(--app-header-total-padding) 15px 15px 15px; border-bottom: 1px solid #333; position: relative;">\n\n <div style="display: flex; align-items: center; gap: 12px;">\n<div class="x-back-btn" onclick="showScreen(\'home-screen\')" style="cursor: pointer;">\n<svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n<g>\n<path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>\n</g>\n</svg>\n</div>\n\n\x3c!-- 添加直播按钮 --\x3e\n<div class="x-live-btn" onclick="switchXPage(\'live\')" style="cursor: pointer;">\n<svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: none; stroke: var(--x-text-primary); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M10.5 20h-5.5a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h1a2 2 0 0 0 2 -2a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v2.5" />\n<path d="M14.569 11.45a3 3 0 1 0 -4.518 3.83" />\n<path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n</svg>\n</div>\n</div>\n\n <div class="x-profile-pic"\n style="display: flex; justify-content: center; align-items: center; position: absolute; left: 50%; transform: translateX(-50%);">\n <img id="top-bar-avatar"\n src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"\n alt="Profile"\n onclick="switchXPage(\'profile\')"\n style="width: 36px; height: 36px; border-radius: 50%; cursor: pointer; transition: opacity 0.2s;"\n onmouseover="this.style.opacity=\'0.8\'"\n onmouseout="this.style.opacity=\'1\'">\n </div>\n\n <div style="display: flex; align-items: center; gap: 15px;">\n\n <div class="x-refresh-btn" onclick="refreshXTweets()" style="cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 22px; height: 22px; fill: #fff;">\n <g>\n <path\n d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z">\n </path>\n </g>\n </svg>\n </div>\n\n <div class="x-settings" onclick="switchXPage(\'settings\')" style="cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 24px; height: 24px; fill: #fff;">\n <g>\n <path\n d="M10.54 1.75h2.92l1.57 2.36c.11.17.32.25.53.21l2.53-.59 2.17 2.17-.58 2.54c-.05.2.04.41.21.53l2.36 1.57v2.92l-2.36 1.57c-.17.12-.26.33-.21.53l.58 2.54-2.17 2.17-2.53-.59c-.21-.04-.42.04-.53.21l-1.57 2.36h-2.92l-1.58-2.36c-.11-.17-.32-.25-.52-.21l-2.54.59-2.17-2.17.58-2.54c.05-.2-.03-.41-.21-.53l-2.35-1.57v-2.92L4.1 8.97c.18-.12.26-.33.21-.53L3.73 5.9 5.9 3.73l2.54.59c.2.04.41-.04.52-.21l1.58-2.36zm1.07 2l-.98 1.47C10.05 6.08 9 6.5 7.99 6.27l-1.46-.34-.6.6.33 1.46c.24 1.01-.18 2.07-1.05 2.64l-1.46.98v.78l1.46.98c.87.57 1.29 1.63 1.05 2.64l-.33 1.46.6.6 1.46-.34c1.01-.23 2.06.19 2.64 1.05l.98 1.47h.78l.97-1.47c.58-.86 1.63-1.28 2.65-1.05l1.45.34.61-.6-.34-1.46c-.23-1.01.18-2.07 1.05-2.64l1.47-.98v-.78l-1.47-.98c-.87-.57-1.28-1.63-1.05-2.64l.34-1.46-.61-.6-1.45.34c-1.02.23-2.07-.19-2.65-1.05l-.97-1.47h-.78zM12 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5c.82 0 1.5-.67 1.5-1.5s-.68-1.5-1.5-1.5zM8.5 12c0-1.93 1.56-3.5 3.5-3.5 1.93 0 3.5 1.57 3.5 3.5s-1.57 3.5-3.5 3.5c-1.94 0-3.5-1.57-3.5-3.5z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n</div>\n\n<div class="x-pages-container"\n style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; position: relative;">\n\n <div id="x-home-page" class="x-page active"\n style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">\n\n <div class="x-home-tabs" style="display: flex; border-bottom: 1px solid #333;">\n\n <div class="x-tab active" onclick="switchHomeTab(\'for-you\')"\n style="flex: 1; text-align: center; padding: 15px 0; font-weight: 600; cursor: pointer; position: relative;">\n <span data-i18n="homeForYou">为你推荐</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background-color: var(--x-accent); border-radius: 2px;">\n </div>\n </div>\n\n <div class="x-tab" onclick="switchHomeTab(\'following\')"\n style="flex: 1; text-align: center; padding: 15px 0; font-weight: 600; cursor: pointer; position: relative; color: #71767b;">\n <span data-i18n="homeFollowing">正在关注</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background-color: var(--x-accent); border-radius: 2px; display: none;">\n </div>\n </div>\n </div>\n\n <div id="for-you-content" class="tab-content active"\n style="flex: 1; display: flex; flex-direction: column; overflow-y: auto; min-height: 0;">\n\n <div class="tweets-container" style="padding: 0;">\n\n </div>\n </div>\n\n <div id="following-content" class="tab-content"\n style="flex: 1; display: none; flex-direction: column; overflow-y: auto; min-height: 0;">\n\n <div class="tweets-container" style="padding: 0;">\n\n </div>\n </div>\n\n <div class="compose-btn" onclick="openComposeTweetModal()"\n style="position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background-color: var(--x-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 24px; height: 24px; fill: #fff; stroke-width: 2;">\n <g>\n <path d="M12 4L12 20M4 12L20 12" stroke="white" stroke-linecap="round"></path>\n </g>\n </svg>\n </div>\n </div>\n\n <div id="character-x-profile-modal"\n style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 30; backdrop-filter: blur(8px);">\n <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">\n <div\n style="background-color:#000; border: 1px solid #333; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">\n\n <div\n style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px 20px; border-bottom: 1px solid #333;">\n <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">设置X资料</h2>\n <button onclick="closeCharacterXProfileModal()"\n style="background: none; border: none; color: #71767b; cursor: pointer; padding: 8px;">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <path\n d="M18.36 6.64c.39.39.39 1.02 0 1.41L13.41 12l4.95 4.95c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L12 13.41l-4.95 4.95c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41L10.59 12 5.64 7.05c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L12 10.59l4.95-4.95c.39-.39 1.02-.39 1.41 0z" />\n </svg>\n </button>\n </div>\n\n <div id="character-info-display"\n style="padding: 20px; border-bottom: 1px solid #333; background-color: #0a0a0a;">\n\n </div>\n\n <div style="padding: 20px;">\n <form id="character-x-profile-form">\n\n <div style="margin-bottom: 24px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">X头像</label>\n <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">\n <img id="character-x-avatar" src="" alt="X头像"\n style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #333; object-fit: cover; overflow: hidden; box-sizing: border-box;">\n <div style="flex: 1;">\n <div style="color: #71767b; font-size: 13px; margin-bottom: 8px;">头像链接</div>\n <input type="url" id="character-x-avatar-url" placeholder="https://example.com/avatar.jpg"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"\n oninput="updateCharacterXAvatar(this.value)" onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'#333\'">\n </div>\n </div>\n <div style="color: #71767b; font-size: 12px;">\n 请输入图片链接URL，支持JPG、PNG、GIF格式\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">X用户名</label>\n <input type="text" id="character-x-name" placeholder="显示名称"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none;"\n maxlength="50">\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">X句柄</label>\n <div style="position: relative;">\n <span\n style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #71767b; font-size: 15px;">@</span>\n <input type="text" id="character-x-handle" placeholder="username"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px 12px 12px 30px; font-size: 15px; outline: none;"\n maxlength="15">\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">\n <input type="checkbox" id="character-x-verified"\n style="width: 18px; height: 18px; accent-color: var(--x-accent);">\n <span style="color: #fff; font-size: 15px; font-weight: 600;">认证用户</span>\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <path\n d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z" />\n </svg>\n </label>\n </div>\n\n <div style="margin-bottom: 24px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">背景图（封面图）</label>\n <div style="margin-bottom: 12px;">\n <img id="character-x-cover-preview" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg" alt="背景图预览"\n style="width: 100%; height: 120px; border-radius: 8px; object-fit: cover; border: 1px solid #333;">\n </div>\n <div style="color: #71767b; font-size: 13px; margin-bottom: 8px;">背景图链接</div>\n <input type="url" id="character-x-cover-url" placeholder="https://example.com/cover.jpg"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"\n oninput="updateCharacterXCover(this.value)" onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'#333\'">\n <div style="color: #71767b; font-size: 12px; margin-top: 4px;">\n 请输入图片链接URL，支持JPG、PNG、GIF格式\n </div>\n </div>\n\n <div style="margin-bottom: 24px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">自定义标签1</label>\n <div style="display: flex; gap: 8px; margin-bottom: 8px;">\n <input type="text" id="character-tag1-icon" placeholder="✨" maxlength="2" style="width: 50px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; text-align: center; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <input type="text" id="character-custom-tag1" placeholder="例如：科技博主" maxlength="30" style="flex: 1; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 15px; outline: none; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n </div>\n <div style="display: flex; gap: 8px; align-items: center;">\n <label style="color: #71767b; font-size: 12px; min-width: 40px;">颜色:</label>\n <input type="color" id="character-tag1-color" value="#71767b" style="width: 40px; height: 32px; border: 1px solid #333; border-radius: 4px; background: transparent; cursor: pointer; outline: none; ">\n </div>\n </div>\n\n <div style="margin-bottom: 24px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">自定义标签2</label>\n <div style="display: flex; gap: 8px; margin-bottom: 8px;">\n <input type="text" id="character-tag2-icon" placeholder="📅" maxlength="2" style="width: 50px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; text-align: center; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <input type="text" id="character-custom-tag2" placeholder="例如：2024年加入" maxlength="30" style="flex: 1; background-color: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 15px; outline: none; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n </div>\n <div style="display: flex; gap: 8px; align-items: center;">\n <label style="color: #71767b; font-size: 12px; min-width: 40px;">颜色:</label>\n <input type="color" id="character-tag2-color" value="#71767b" style="width: 40px; height: 32px; border: 1px solid #333; border-radius: 4px; background: transparent; cursor: pointer; outline: none; ">\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">正在关注数量</label>\n <input type="text" id="character-following-count" placeholder="156, 1.2K, 2.5M等" maxlength="20" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <div style="color: #71767b; font-size: 12px; margin-top: 4px;">可输入任意数字、字母、符号组合</div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">关注者数量</label>\n <input type="text" id="character-followers-count" placeholder="89, 1.5K, 3.2M等" maxlength="20" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <div style="color: #71767b; font-size: 12px; margin-top: 4px;">可输入任意数字、字母、符号组合</div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">X简介</label>\n <textarea id="character-x-bio" placeholder="介绍一下这个角色在X上的身份..."\n style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit;"\n maxlength="160"></textarea>\n <div style="text-align: right; color: #71767b; font-size: 13px; margin-top: 4px;">\n <span id="character-bio-count">0</span>/160\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">公众身份</label>\n <div style="color: #71767b; font-size: 13px; margin-bottom: 8px; line-height: 1.4;">\n 描述角色在X平台的公众身份（如明星、网红、博主等）。这将影响其他用户对该角色的讨论几率，身份越知名可能引起更多关注和讨论。此信息完全公开。\n </div>\n\n <div\n style="background-color: color-mix(in srgb, var(--x-accent) , 0.1); border: 1px solid var(--x-accent); border-radius: 8px; padding: 12px; margin-bottom: 12px;">\n <div style="color: var(--x-accent); font-size: 13px; line-height: 1.4;">\n <strong>📌 重要提醒：</strong>角色将根据完整人设进行扮演，但<strong\n style="color: var(--x-accent);">X平台其他用户无法读取角色人设</strong>，仅能看到此公众身份信息。如需让其他用户了解的角色特点、背景故事等内容，请全部详细填写至公众身份中。\n </div>\n </div>\n <textarea id="character-public-identity"\n placeholder="例如：知名演员、歌手、网络红人、专业博主等... 可详细描述角色的公开背景、成就、特点等，无字数限制"\n style="width: 100%; min-height: 120px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit;"></textarea>\n <div style="color: #71767b; font-size: 12px; margin-top: 4px;">\n 💡 无字数限制，可详细描述角色的公开信息\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">真名设置</label>\n <div style="color: #71767b; font-size: 13px; margin-bottom: 12px; line-height: 1.4;">\n 选择是否公开角色的真实姓名。公开后，其他用户都能看到角色真名，情侣认证时也会显示双方真名。\n </div>\n\n <div style="margin-bottom: 12px;">\n <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\n <input type="checkbox" id="character-show-real-name" style="width: 16px; height: 16px; accent-color: var(--x-accent); " onchange="toggleCharacterRealNameInput()">\n <span style="color: #fff; font-size: 15px;">公开真实姓名</span>\n </label>\n </div>\n\n <div id="character-real-name-input-container" style="display: none;">\n <input type="text" id="character-real-name" placeholder="请输入角色的真实姓名"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none;"\n maxlength="50">\n <div style="text-align: right; color: #71767b; font-size: 13px; margin-top: 4px;">\n <span id="character-real-name-count">0</span>/50\n </div>\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">\n <label style="color: #fff; font-size: 15px; font-weight: 600;">NPC关系绑定</label>\n <button type="button" onclick="openAddRelationshipModal()"\n style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 16px; padding: 6px 12px; font-size: 12px; cursor: pointer;">\n + 添加关系\n </button>\n </div>\n <div style="color: #71767b; font-size: 13px; margin-bottom: 12px;">\n 绑定NPC角色作为朋友、亲人等，让角色能够识别和互动\n </div>\n\n <div id="character-relationships-list" style="max-height: 200px; overflow-y: auto;">\n\n </div>\n </div>\n\n <div style="margin-bottom: 20px; border-top: 1px solid #333; padding-top: 20px;">\n <label style="display: block; color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 8px;">🤖 后台自动活动</label>\n <div style="color: #71767b; font-size: 13px; margin-bottom: 12px; line-height: 1.4;">\n 启用后，当与该角色在X平台私信达到设定的无互动时间后，角色将主动在后台发送消息和推文\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\n <input type="checkbox" id="character-auto-message-enabled" style="width: 16px; height: 16px; accent-color: var(--x-accent); " onchange="toggleAutoMessageSettings()">\n <span style="color: #fff; font-size: 15px;">启用后台自动发消息</span>\n </label>\n </div>\n\n <div id="auto-message-time-settings" style="display: none;">\n <label style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">无互动触发时间</label>\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <input type="number" id="character-auto-message-interval" placeholder="60" min="10" max="3600" style="width: 100px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 8px 12px; font-size: 14px; outline: none; ">\n <span style="color:var(--x-text-primary); font-size: 14px;">秒</span>\n </div>\n <div style="color: #71767b; font-size: 12px; line-height: 1.4;">\n 设置无互动多少秒后角色会主动发消息（建议60-300秒，最少10秒，最多3600秒）\n </div>\n </div>\n </div>\n\n <div style="display: flex; gap: 12px; margin-top: 32px;">\n <button type="button" onclick="closeCharacterXProfileModal()"\n style="flex: 1; background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 12px 24px; font-size: 15px; font-weight: 700; cursor: pointer;">\n 取消\n </button>\n <button type="submit"\n style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 12px 24px; font-size: 15px; font-weight: 700; cursor: pointer;">\n 保存X资料\n </button>\n </div>\n </form>\n </div>\n </div>\n </div>\n </div>\n\n <div id="relationship-modal"\n style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 40; backdrop-filter: blur(8px);">\n <div style="display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;">\n <div\n style="background-color:#000; border: 1px solid #333; border-radius: 16px; width: 100%; max-width: 500px;">\n\n <div\n style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px 20px; border-bottom: 1px solid #333;">\n <h3 id="relationship-modal-title" style="color: #fff; font-size: 18px; font-weight: 700; margin: 0;">\n 添加NPC关系</h3>\n <button onclick="closeRelationshipModal()"\n style="background: none; border: none; color: #71767b; cursor: pointer; padding: 8px;">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <path\n d="M18.36 6.64c.39.39.39 1.02 0 1.41L13.41 12l4.95 4.95c.39.39.39 1.02 0 1.41-.39.39-1.02.39-1.41 0L12 13.41l-4.95 4.95c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41L10.59 12 5.64 7.05c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L12 10.59l4.95-4.95c.39-.39 1.02-.39 1.41 0z" />\n </svg>\n </button>\n </div>\n\n <div style="padding: 20px;">\n <form id="relationship-form">\n\n <div style="margin-bottom: 16px;">\n <label\n style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">NPC名称</label>\n <input type="text" id="relationship-npc-name" placeholder="输入NPC的名称"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;"\n maxlength="30">\n </div>\n\n <div style="margin-bottom: 16px;">\n <label\n style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">NPC句柄</label>\n <div style="position: relative;">\n <span\n style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #71767b; font-size: 14px;">@</span>\n <input type="text" id="relationship-npc-handle" placeholder="npc_username"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px 12px 12px 30px; font-size: 14px; outline: none;"\n maxlength="15">\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label\n style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">关系类型</label>\n <select id="relationship-type"\n style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none;">\n <option value="朋友">朋友</option>\n <option value="亲人">亲人</option>\n <option value="恋人">恋人</option>\n <option value="同事">同事</option>\n <option value="同学">同学</option>\n <option value="邻居">邻居</option>\n <option value="其他">其他</option>\n </select>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label\n style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">关系描述</label>\n <textarea id="relationship-description" placeholder="详细描述两人的关系，如何认识的，相处模式等..."\n style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit;"\n maxlength="200"></textarea>\n <div style="text-align: right; color: #71767b; font-size: 12px; margin-top: 4px;">\n <span id="relationship-desc-count">0</span>/200\n </div>\n </div>\n\n <div style="display: flex; gap: 12px;">\n <button type="button" onclick="closeRelationshipModal()"\n style="flex: 1; background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer;">\n 取消\n </button>\n <button type="submit"\n style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer;">\n 保存关系\n </button>\n </div>\n </form>\n </div>\n </div>\n </div>\n </div>\n\n <div id="x-search-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">\n\n <div class="search-header">\n <button id="search-back-btn" onclick="backToTrending()" style="display: none; background: none; border: none; padding: 8px; cursor: pointer; margin-right: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g>\n </svg>\n </button>\n <div class="search-box">\n <button onclick="openMapPage()" style="display: flex; align-items: center; justify-content: center; background: none; border: none; padding: 4px; cursor: pointer; border-radius: 50%; transition: background-color 0.2s; flex-shrink: 0; " onmouseover="this.style.backgroundColor=\'rgba(29,155,240,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'" title="地图">\n  <svg viewBox="0 0 32 32" style="width: 20px; height: 20px; stroke: #71767b; fill: none; stroke-width: 1.5;">\n   <path d="M16 2C11.5817 2 8 5.58172 8 10C8 15.5 16 26 16 26C16 26 24 15.5 24 10C24 5.58172 20.4183 2 16 2Z"/>\n   <circle cx="16" cy="10" r="3"/>\n  </svg>\n </button>\n <svg viewBox="0 0 24 24" aria-hidden="true">\n <g><path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path></g>\n </svg>\n <input type="text" placeholder="搜索 X" id="search-input"\n oninput="toggleSearchButton()"\n onkeydown="if(event.key===\'Enter\') performSearch()">\n <button id="search-submit-btn" onclick="performSearch()" style="display: none; background: none; border: none; padding: 8px; cursor: pointer; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(29,155,240,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M2.504 21.866l.526-2.108C3.04 19.719 4 15.823 4 12s-.96-7.719-.97-7.757l-.527-2.109L22.236 12 2.504 21.866zM5.981 13c-.072 1.962-.34 3.833-.583 5.183L17.764 12 5.398 5.818c.242 1.349.51 3.221.583 5.183H10v2H5.981z"></path></g>\n </svg>\n </button>\n </div>\n </div>\n\n <div id="trending-view" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">\n\n <div class="search-tabs">\n <div class="search-tab active" onclick="switchSearchTab(\'recommended\')">为你推荐</div>\n <div class="search-tab" onclick="switchSearchTab(\'trending\')">当前趋势</div>\n <div class="add-category-btn" onclick="openAddCategoryModal()" title="添加自定义分类">\n <svg viewBox="0 0 24 24" aria-hidden="true">\n <g><path d="M19.5 12.75h-6.75V19.5h-1.5v-6.75H4.5v-1.5h6.75V4.5h1.5v6.75h6.75v1.5z"></path></g>\n </svg>\n </div>\n </div>\n\n <div class="trending-list" id="trending-list">\n\n </div>\n </div>\n\n <div id="search-results-view" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">\n\n <div class="search-tabs">\n <div class="search-tab active" onclick="switchSearchResultTab(\'top\')">热门</div>\n <div class="search-tab" onclick="switchSearchResultTab(\'latest\')">最新</div>\n <div class="search-tab" onclick="switchSearchResultTab(\'users\')">用户</div>\n </div>\n\n <div id="search-results-content" style="flex: 1; overflow-y: auto; background: #000; ">\n\n </div>\n </div>\n\n <button class="refresh-trends-btn" onclick="refreshTrends()" title="刷新热搜">\n <svg viewBox="0 0 24 24" aria-hidden="true">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n </button>\n </div>\n\n <div id="category-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 30; overflow-y: auto; backdrop-filter: blur(8px); " onclick="closeCategoryModal(event)">\n <div style="background-color:#000; margin: 40px auto; border-radius: 16px; max-width: 600px; width: calc(100% - 40px); border: 1px solid #333; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #333; ">\n <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">管理热搜分类</h2>\n <div onclick="closeCategoryModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto;">\n\n <div style="background-color: color-mix(in srgb, var(--x-accent) , 0.1); border: 1px solid var(--x-accent); border-radius: 8px; padding: 12px; margin-bottom: 20px; ">\n <p style="color: var(--x-accent); font-size: 13px; line-height: 1.4; margin: 0;">\n 💡 自定义分类将在刷新热搜时生成相应内容。可以添加任意分类（如"动漫"、"二次元"等），并描述该分类下的内容类型。\n </p>\n </div>\n\n <div style="margin-bottom: 20px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; ">\n <h3 style="color: #fff; font-size: 16px; font-weight: 600; margin: 0;">自定义分类</h3>\n <button onclick="addNewCategory()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n + 添加分类\n </button>\n </div>\n\n <div id="custom-categories-list" style="display: flex; flex-direction: column; gap: 12px;">\n\n </div>\n </div>\n\n <button onclick="saveCustomCategories()" style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存设置\n </button>\n </div>\n </div>\n </div>\n\n <div id="x-notifications-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">\n\n <div class="notifications-tabs" style="display: flex; border-bottom: 1px solid var(--x-border-color); background-color:var(--x-bg-primary);">\n\n <div class="notification-tab active" onclick="switchNotificationTab(\'all\')" style="flex: 1; text-align: center; padding: 15px 0; font-weight: 700; font-size: 15px; cursor: pointer; position: relative; color:var(--x-text-primary); transition: background-color 0.2s; ">\n <span data-i18n="notificationsTabAll">全部</span>\n <div class="tab-indicator" style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--x-accent); border-radius: 2px; "></div>\n </div>\n\n <div class="notification-tab" onclick="switchNotificationTab(\'mentions\')" style="flex: 1; text-align: center; padding: 15px 0; font-weight: 700; font-size: 15px; cursor: pointer; position: relative; color:var(--x-text-secondary); transition: background-color 0.2s; ">\n <span data-i18n="notificationsTabMentions">提及</span>\n <div class="tab-indicator" style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background-color: var(--x-accent); border-radius: 2px; display: none; "></div>\n </div>\n </div>\n\n <div id="notifications-all-content" class="notification-content" style="flex: 1; overflow-y: auto; background-color:var(--x-bg-primary); ">\n\n <div id="notifications-all-list" class="notifications-list">\n\n </div>\n </div>\n\n <div id="notifications-mentions-content" class="notification-content" style="flex: 1; overflow-y: auto; background-color:var(--x-bg-primary); display: none; ">\n\n <div id="notifications-mentions-list" class="notifications-list">\n\n </div>\n </div>\n\n <div id="refresh-messages-btn" class="refresh-messages-btn" onclick="refreshStrangerMessages()" style="position: fixed; bottom: 80px; right: 16px; width: 56px; height: 56px; background-color: var(--x-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s; z-index: 100; " onmouseover="this.style.transform=\'scale(1.1)\'"\n onmouseout="this.style.transform=\'scale(1)\'">\n <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #fff;">\n <g><path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path></g>\n </svg>\n </div>\n </div>\n\n <div id="x-messages-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">\n\n <div id="messages-list-container" class="messages-list-container" style="flex: 1; overflow-y: auto; background-color:var(--x-bg-primary); ">\n\n </div>\n\n <div id="compose-message-btn" class="compose-message-btn" onclick="openNewMessageModal()" style="position: fixed; bottom: 80px; right: 16px; width: 56px; height: 56px; background-color: var(--x-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.2s; z-index: 100; " onmouseover="this.style.transform=\'scale(1.1)\'"\n onmouseout="this.style.transform=\'scale(1)\'">\n <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #fff;">\n <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>\n </svg>\n </div>\n </div>\n\n <div id="x-message-detail-page" class="x-page"\n style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 20; background-color:var(--x-bg-primary);">\n\n <div class="message-detail-header" style="display: flex; align-items: center; padding: var(--app-header-total-padding) 16px 12px 16px; background-color:var(--x-bg-primary); ">\n\n <div onclick="closeMessageDetail()" style="cursor: pointer; margin-right: 20px; display: flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g>\n </svg>\n </div>\n\n <div style="flex: 1; display: flex; align-items: center; gap: 12px; min-width: 0;">\n <img id="message-detail-top-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"\n alt="User"\n style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: opacity 0.2s;"\n onmouseover="this.style.opacity=\'0.8\'"\n onmouseout="this.style.opacity=\'1\'"\n onclick="handleMessageDetailAvatarClick()">\n <span id="message-detail-top-name" style="font-size: 16px; font-weight: 700; color:var(--x-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">用户名</span>\n </div>\n\n <div style="display: flex; gap: 8px;">\n\n <div style="width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h6C12.881 3 14 4.119 14 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-6C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v13c0 .276.224.5.5.5h6c.276 0 .5-.224.5-.5v-13c0-.276-.224-.5-.5-.5h-6zM15.5 6l5.5-3v18l-5.5-3v-12z"></path></g>\n </svg>\n </div>\n\n <div style="width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n\n <div id="message-detail-scrollable" style="flex: 1; overflow-y: auto; background-color:var(--x-bg-primary); ">\n\n <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 16px; background-color:var(--x-bg-primary); border-bottom: 1px solid var(--x-border-color); ">\n\n <img id="message-detail-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"\n alt="User"\n style="width: 64px; height: 64px; border-radius: 50%; margin-bottom: 12px;">\n\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">\n <span id="message-detail-name" style="font-size: 20px; font-weight: 700; color:var(--x-text-primary); ">用户名</span>\n </div>\n\n <div id="message-detail-handle" style="font-size: 15px; color:var(--x-text-secondary); margin-bottom: 12px; ">@handle</div>\n\n <div id="message-detail-bio" style="font-size: 15px; color:var(--x-text-primary); text-align: center; line-height: 1.4; margin-bottom: 12px; display: none; "></div>\n\n <div id="message-detail-followers" style="font-size: 14px; color:var(--x-text-secondary); " data-i18n-template="messageFollowers">0 位关注者</div>\n </div>\n\n <div id="message-detail-content" class="message-detail-content" style="padding: 16px; background-color:var(--x-bg-primary); min-height: 300px; ">\n\n </div>\n </div>\n\n <div class="message-input-area" style="padding: 12px 16px; background-color:var(--x-bg-primary); ">\n\n <div style="display: flex; align-items: center; gap: 8px; background-color:var(--x-bg-secondary); border-radius: 20px; padding: 8px 12px; position: relative; ">\n\n <div style="position: relative;">\n\n <div id="message-add-btn" onclick="toggleMessageFunctionMenu()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent); transition: transform 0.2s;">\n <g><path d="M12 4C11.4477 4 11 4.44772 11 5V11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H11V19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19V13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13V5C13 4.44772 12.5523 4 12 4Z"></path></g>\n </svg>\n </div>\n\n <div id="message-function-menu" style="position: absolute; bottom: 100%; left: 0; margin-bottom: 8px; background-color:var(--x-bg-primary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 4px; display: none; flex-direction: row; gap: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; ">\n\n <div onclick="openImageTypeSelector(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"></path></g>\n </svg>\n </div>\n\n <div onclick="openStickerPicker(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></g>\n </svg>\n </div>\n\n <div onclick="regenerateAIResponse(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: none; stroke: var(--x-accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />\n <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />\n </svg>\n </div>\n\n <div onclick="openVoiceMessageDialog(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M12 3c-1.66 0-3 1.34-3 3v6c0 1.66 1.34 3 3 3s3-1.34 3-3V6c0-1.66-1.34-3-3-3zm0 2c.55 0 1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V6c0-.55.45-1 1-1zm5 7c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-2.08c3.39-.49 6-3.39 6-6.92h-2z"></path></g>\n </svg>\n </div>\n\n <div onclick="openTransferDialog(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM6.64 15.748L12 10.388l5.36 5.36c-.48.32-1.04.56-1.68.72L12 12.78l-3.68 3.69c-.64-.16-1.2-.4-1.68-.72zM12 4c4.41 0 8 3.59 8 8 0 1.85-.63 3.55-1.69 4.9L12 10.59 5.69 16.9C4.63 15.55 4 13.85 4 12c0-4.41 3.59-8 8-8z"></path></g>\n </svg>\n </div>\n\n<div id="fangroup-announcement-btn" onclick="openFanGroupAnnouncementModal(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: none; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'transparent\'">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: none; stroke: var(--x-accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M3 3m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" />\n<path d="M9 15h-2" />\n<path d="M13 12h-6" />\n<path d="M11 9h-4" />\n </svg>\n </div>\n\n <div id="fangroup-files-btn" onclick="openFanGroupFilesModal(); toggleMessageFunctionMenu();" style="cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; display: none; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'transparent\'">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: none; stroke: var(--x-accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n </svg>\n </div>\n </div>\n </div>\n\n <textarea id="message-input" placeholder="开始写私信"\n data-i18n-placeholder="messageInputPlaceholder"\n style="flex: 1; min-height: 36px; max-height: 100px; background-color: transparent; border: none; color:var(--x-text-primary); font-size: 15px; resize: none; outline: none; font-family: inherit; padding: 4px 0; line-height: 1.4; "\n oninput="autoResizeMessageInput(this)"\n onkeydown="handleMessageInputKeydown(event)"></textarea>\n\n <button id="fangroup-auto-reaction-btn" onclick="triggerFanGroupAutoReaction()" style="display: none; background-color:var(--x-bg-secondary); color: var(--x-accent); border: 1px solid var(--x-accent); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; transition: all 0.2s; padding: 0; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 4px; "\n onmouseover="this.style.backgroundColor=\'var(--x-accent)\'; this.style.color=\'#fff\'; this.querySelector(\'svg\').style.stroke=\'#fff\'"\n onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'; this.style.color=\'var(--x-accent)\'; this.querySelector(\'svg\').style.stroke=\'var(--x-accent)\'">\n <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--x-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transition: stroke 0.2s;">\n <path d="M3 12h4.5l1.5 -6l4 12l2 -9l1.5 3h4.5" />\n </svg>\n </button>\n\n <button id="message-send-btn" onclick="getAIResponse()" style="display: flex; background-color: var(--x-accent); color: #fff; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; transition: opacity 0.2s; padding: 0; align-items: center; justify-content: center; flex-shrink: 0; ">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n <g><path d="M2.504 21.866l.526-2.108C3.04 19.719 4 15.823 4 12s-.96-7.719-.97-7.757l-.527-2.109L22.236 12 2.504 21.866zM5.981 13c-.072 1.962-.34 3.833-.583 5.183L17.764 12 5.398 5.818c.242 1.349.51 3.221.583 5.183H10v2H5.981z"></path></g>\n </svg>\n </button>\n </div>\n\n <input type="file" id="message-image-input" accept="image/*" multiple style="display: none;" onchange="handleMessageImageUpload(event)">\n </div>\n\n \n\n <div id="sticker-manager-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 32; " onclick="closeStickerManager()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n <div style="padding: 16px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; ">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">表情包管理</div>\n <div onclick="closeStickerManager()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n <div id="sticker-manager-list" style="flex: 1; overflow-y: auto; padding: 16px; ">\n\n </div>\n <div style="padding: 16px; border-top: 1px solid var(--x-border-color); display: flex; gap: 8px; justify-content: flex-end; ">\n <button onclick="clearAllStickers()" style="background-color: rgba(239, 68, 68, 0.1); color: rgb(239, 68, 68); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">清空全部</button>\n </div>\n </div>\n </div>\n\n <div id="voice-message-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 31; " onclick="closeVoiceMessageDialog()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 500px; width: 90%; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">发送语音消息</div>\n <div onclick="closeVoiceMessageDialog()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n <div style="font-size: 13px; color:var(--x-text-secondary); margin-bottom: 12px;">\n 输入要转换为语音的文字内容\n </div>\n <div style="margin-bottom: 16px;">\n <textarea id="voice-message-text-input" placeholder="输入文字内容..." style="width: 100%; min-height: 100px; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.5; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'var(--x-border-color)\'"></textarea>\n </div>\n <div style="display: flex; gap: 8px; justify-content: flex-end;">\n <button onclick="closeVoiceMessageDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">取消</button>\n <button onclick="sendVoiceMessage()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">发送语音</button>\n </div>\n </div>\n </div>\n\n <div id="transfer-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 31; overflow-y: auto; " onclick="closeTransferDialog()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 400px; width: 90%; max-height: 85vh; margin: 20px auto; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: flex; flex-direction: column; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 16px; flex-shrink: 0;">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">发起转账</div>\n <div onclick="closeTransferDialog()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="flex: 1; overflow-y: auto; padding: 0 20px; min-height: 0;">\n\n <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--x-border-color);">\n <div style="display: flex; gap: 8px;">\n <button id="transfer-type-normal-btn" onclick="switchTransferType(\'normal\')" style="flex: 1; padding: 8px 16px; border: 1px solid var(--x-border-color); background-color: var(--x-accent); color: #fff; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;">\n <g><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></g>\n </svg>\n 普通转账\n </button>\n <button id="transfer-type-business-btn" onclick="switchTransferType(\'business\')" style="flex: 1; padding: 8px 16px; border: 1px solid var(--x-border-color); background-color: transparent; color:var(--x-text-primary); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path><path d="M12 10L14.5 14L17 10L14.5 12L12 10ZM10 10L7.5 12L10 14L7.5 14L10 10Z"></path></g>\n </svg>\n 商业转账\n </button>\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n 转账金额\n </label>\n <div style="position: relative;">\n <input type="number" id="transfer-amount-input" placeholder="0.00" min="0.01" step="0.01" style="width: 100%; padding: 12px 16px 12px 36px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 16px; outline: none; font-family: inherit; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'">\n <div style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color:var(--x-text-secondary); font-weight: 600; font-size: 16px; ">$</div>\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n 转账备注（可选）\n </label>\n <textarea id="transfer-note-input" placeholder="添加转账说明..." maxlength="100" style="width: 100%; min-height: 60px; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.5; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'"\n oninput="updateTransferNoteCounter()"></textarea>\n <div style="text-align: right; margin-top: 4px;">\n <span id="transfer-note-counter" style="font-size: 12px; color:var(--x-text-secondary);">0 / 100</span>\n </div>\n </div>\n\n <div id="business-transfer-section" style="display: none;">\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n 定金比例\n </label>\n <select id="transfer-deposit-ratio" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; font-family: inherit; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'">\n <option value="0">0% - 无定金（任务完成后全额支付）</option>\n <option value="20" selected>20% - 先付20%定金</option>\n <option value="30">30% - 先付30%定金</option>\n <option value="50">50% - 先付50%定金</option>\n </select>\n <div style="font-size: 12px; color:var(--x-text-secondary); margin-top: 4px;">\n 定金会在对方接受转账时立即支付，余款在任务完成后支付\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n 任务描述 <span style="color: #ef4444;">*</span>\n </label>\n <textarea id="transfer-task-description" placeholder="例如：发布一条关于XX产品的宣传推文，需包含产品链接..." maxlength="500" style="width: 100%; min-height: 100px; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.5; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'"\n oninput="updateTaskDescriptionCounter()"></textarea>\n <div style="text-align: right; margin-top: 4px;">\n <span id="transfer-task-counter" style="font-size: 12px; color:var(--x-text-secondary);">0 / 500</span>\n </div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n 任务期限 <span style="color: #ef4444;">*</span>\n </label>\n <input type="number" id="transfer-task-deadline" placeholder="小时数" min="1" max="720" value="24" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; font-family: inherit; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'">\n <div style="font-size: 12px; color:var(--x-text-secondary); margin-top: 4px;">\n 从对方接受转账起计算，建议1-72小时（最长30天）\n </div>\n </div>\n\n <div style="background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 12px; margin-bottom: 16px; ">\n <div style="display: flex; gap: 8px; align-items: flex-start;">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-text-secondary); flex-shrink: 0; margin-top: 2px;">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></g>\n </svg>\n <div style="font-size: 12px; color:var(--x-text-primary); line-height: 1.5;">\n <strong>商业转账说明：</strong><br>\n • 对方接受后必须完成任务才能获得全款<br>\n • AI会自动检测任务完成情况<br>\n • 对方也可能拒绝或接受但不完成任务\n </div>\n </div>\n </div>\n </div>\n </div>\n\n <div style="padding: 16px 20px 20px; border-top: 1px solid var(--x-border-color); flex-shrink: 0;">\n <div style="display: flex; gap: 8px; justify-content: flex-end;">\n <button onclick="closeTransferDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; ">取消</button>\n <button onclick="sendTransfer()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; ">发送转账</button>\n </div>\n </div>\n </div>\n </div>\n\n <div id="transfer-details-modal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 32; " onclick="closeTransferDetails()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 360px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.4); overflow: hidden; " onclick="event.stopPropagation()">\n\n <div id="transfer-details-content">\n\n </div>\n </div>\n </div>\n\n <div id="image-type-selector-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 31; " onclick="closeImageTypeSelector()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 360px; width: 90%; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 16px;">选择图片类型</div>\n <div style="display: flex; flex-direction: column; gap: 12px;">\n\n <div onclick="selectImageType(\'real\')" style="padding: 16px; border: 2px solid var(--x-border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; " onmouseover="this.style.borderColor=\'var(--x-accent)\'; this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.borderColor=\'var(--x-border-color)\'; this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--x-accent); flex-shrink: 0;">\n <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"></path></g>\n </svg>\n <div>\n <div style="font-size: 15px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">上传真实图片</div>\n <div style="font-size: 13px; color:var(--x-text-secondary);">从设备中选择图片文件</div>\n </div>\n </div>\n\n <div onclick="selectImageType(\'text\')" style="padding: 16px; border: 2px solid var(--x-border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; " onmouseover="this.style.borderColor=\'var(--x-accent)\'; this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.borderColor=\'var(--x-border-color)\'; this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: var(--x-accent); flex-shrink: 0;">\n <g><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></g>\n </svg>\n <div>\n <div style="font-size: 15px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">发送文字图片</div>\n <div style="font-size: 13px; color:var(--x-text-secondary);">用文字描述图片内容</div>\n </div>\n </div>\n </div>\n <div style="margin-top: 16px; display: flex; justify-content: flex-end;">\n <button onclick="closeImageTypeSelector()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">取消</button>\n </div>\n </div>\n </div>\n\n <div id="text-image-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 32; " onclick="closeTextImageDialog()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 500px; width: 90%; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">发送文字图片</div>\n <div onclick="closeTextImageDialog()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n <div style="font-size: 13px; color:var(--x-text-secondary); margin-bottom: 12px;">\n 用文字描述你想发送的图片内容（例如：一张美丽的日落照片）\n </div>\n <div style="margin-bottom: 16px;">\n <textarea id="text-image-description-input" placeholder="输入图片描述..." maxlength="500" style="width: 100%; min-height: 120px; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.5; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\n onblur="this.style.borderColor=\'var(--x-border-color)\'"\n oninput="updateTextImageCounter()"></textarea>\n <div style="text-align: right; margin-top: 4px;">\n <span id="text-image-counter" style="font-size: 12px; color:var(--x-text-secondary);">0 / 500</span>\n </div>\n </div>\n <div style="display: flex; gap: 8px; justify-content: flex-end;">\n <button onclick="closeTextImageDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">取消</button>\n <button onclick="sendTextImage()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">发送</button>\n </div>\n </div>\n </div>\n\n <div id="add-sticker-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 31; " onclick="closeAddStickerDialog()">\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 500px; width: 90%; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px;">批量导入表情包</div>\n <div style="font-size: 13px; color:var(--x-text-secondary); margin-bottom: 16px;">\n 每行一个表情包，格式：描述 链接<br>\n 例如：开心 https://example.com/happy.gif\n </div>\n <div style="margin-bottom: 16px;">\n <textarea id="sticker-batch-input" placeholder="开心 https://example.com/happy.gif\n难过 https://example.com/sad.gif\n惊讶 https://example.com/wow.gif" style="width: 100%; min-height: 150px; padding: 12px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.5; "></textarea>\n </div>\n <div style="display: flex; gap: 8px; justify-content: flex-end;">\n <button onclick="closeAddStickerDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">取消</button>\n <button onclick="batchAddStickers()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; ">批量导入</button>\n </div>\n </div>\n</div>\n</div>\n\n<div id="fangroup-announcement-modal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 35; backdrop-filter: blur(8px); padding: 0 8px; box-sizing: border-box; " onclick="closeFanGroupAnnouncementModal()">\n<div style="background-color:var(--x-bg-primary); border-radius: 20px; width: 100%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; " onclick="event.stopPropagation()">\n\n<div style="padding: 24px 24px 16px; border-bottom: 1px solid var(--x-border-color); flex-shrink: 0;">\n<div style="display: flex; align-items: center; justify-content: space-between;">\n<div style="display: flex; align-items: center; gap: 12px;">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 28px; height: 28px; fill: none; stroke: var(--x-accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M3 3m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v14a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" />\n<path d="M9 15h-2" />\n<path d="M13 12h-6" />\n<path d="M11 9h-4" />\n</svg>\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 24px; font-weight: 700;">群公告</h3>\n</div>\n<button onclick="closeFanGroupAnnouncementModal()" style="background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'transparent\'">\n<svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: currentColor;">\n<g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n</svg>\n</button>\n</div>\n</div>\n\n<div id="fangroup-announcements-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 24px 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 280px), 1fr)); gap: 24px 16px; align-content: flex-start; justify-items: center; min-height: 200px; background: radial-gradient(circle at 20% 30%, rgba(29, 155, 240, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(249, 24, 128, 0.02) 0%, transparent 50%), var(--x-bg-secondary); ">\n\n<div style="width: 100%; text-align: center; color:var(--x-text-secondary); font-size: 14px; padding: 40px 20px; grid-column: 1 / -1;">\n📌 暂无公告，点击下方按钮创建第一条公告\n</div>\n</div>\n\n<div style="padding: 16px 24px; border-top: 1px solid var(--x-border-color); flex-shrink: 0; display: flex; gap: 12px;">\n<button onclick="openCreateAnnouncementDialog()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 24px; padding: 14px 24px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(29, 155, 240, 0.3); " onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(29, 155, 240, 0.4)\'"\nonmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(29, 155, 240, 0.3)\'">\n+ 新建公告\n</button>\n</div>\n</div>\n</div>\n\n<div id="create-announcement-dialog" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 36; backdrop-filter: blur(4px); " onclick="closeCreateAnnouncementDialog()">\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); overflow: hidden; " onclick="event.stopPropagation()">\n<div style="padding: 20px 24px; border-bottom: 1px solid var(--x-border-color);">\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 20px; font-weight: 700;">新建公告</h3>\n</div>\n<div style="padding: 24px;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n公告内容 <span style="color: #ef4444;">*</span>\n</label>\n<textarea id="announcement-content-input" placeholder="输入公告内容..." maxlength="500" style="width: 100%; min-height: 150px; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.6; transition: border-color 0.2s; " onfocus="this.style.borderColor=\'var(--x-accent)\'"\nonblur="this.style.borderColor=\'var(--x-border-color)\'"\noninput="updateAnnouncementCounter()"></textarea>\n<div style="text-align: right; margin-top: 6px;">\n<span id="announcement-counter" style="font-size: 12px; color:var(--x-text-secondary);">0 / 500</span>\n</div>\n\n<div style="margin-top: 20px; padding: 16px; background-color:var(--x-bg-secondary); border-radius: 12px; border: 1px solid var(--x-border-color);">\n<label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">\n<input type="checkbox" id="mention-all-checkbox" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--x-accent);">\n<div style="flex: 1;">\n<div style="color:var(--x-text-primary); font-size: 14px; font-weight: 600; margin-bottom: 4px;">\n@全体成员\n</div>\n<div style="color:var(--x-text-secondary); font-size: 12px; line-height: 1.4;">\n勾选后将通知所有成员并触发AI反应\n</div>\n</div>\n</label>\n</div>\n</div>\n<div style="padding: 16px 24px; border-top: 1px solid var(--x-border-color); display: flex; gap: 12px; justify-content: flex-end;">\n<button onclick="closeCreateAnnouncementDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n取消\n</button>\n<button onclick="saveFanGroupAnnouncement()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 24px; font-size: 14px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity=\'0.9\'"\nonmouseout="this.style.opacity=\'1\'">\n发布公告\n</button>\n </div>\n </div>\n </div>\n\n <div id="x-comments-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">\n </div>\n\n <div id="x-settings-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden; min-height: 0;">\n\n <div class="settings-header"\n style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333; background-color:#000;">\n <div style="display: flex; align-items: center;">\n <div class="settings-back-btn" onclick="switchXPage(\'home\')" style="cursor: pointer; margin-right: 15px;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>\n </g>\n </svg>\n </div>\n <span style="font-size: 20px; font-weight: 700; color: #fff;">设置</span>\n </div>\n <div style="display: flex; align-items: center; gap: 8px;">\n\n <div id="review-toggle-btn" onclick="openReviewPage()"\n style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'"\n title="审核">\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--x-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M5 10v-4a3 3 0 0 1 3 -3h8a3 3 0 0 1 3 3v4" />\n <path d="M16 15v-2a3 3 0 1 1 3 3v3h-14v-3a3 3 0 1 1 3 -3v2" />\n <path d="M8 12h8" />\n <path d="M7 19v2" />\n <path d="M17 19v2" />\n </svg>\n </div>\n \n <div id="help-toggle-btn" onclick="openHelpPage()"\n style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'"\n title="答疑">\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--x-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M15.02 19.52c-2.341 .736 -5 .606 -7.32 -.52l-4.7 1l1.3 -3.9c-2.324 -3.437 -1.426 -7.872 2.1 -10.374c3.526 -2.501 8.59 -2.296 11.845 .48c1.649 1.407 2.575 3.253 2.742 5.152" />\n <path d="M19 22v.01" />\n <path d="M19 19a2.003 2.003 0 0 0 .914 -3.782a1.98 1.98 0 0 0 -2.414 .483" />\n </svg>\n </div>\n\n <div id="accent-color-toggle-btn" onclick="openAccentColorPicker()"\n style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'\'"\n title="更改主题色">\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--x-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M12 21a9 9 0 0 1 0 -18c4.97 0 9 3.582 9 8c0 1.06 -.474 2.078 -1.318 2.828c-.844 .75 -1.989 1.172 -3.182 1.172h-2.5a2 2 0 0 0 -1 3.75a1.3 1.3 0 0 1 -1 2.25" />\n <path d="M8.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />\n <path d="M12.5 7.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />\n <path d="M16.5 10.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />\n </svg>\n </div>\n\n <div id="language-toggle-btn" onclick="toggleXLanguage()"\n style="cursor: pointer; padding: 8px 12px; border-radius: 20px; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; background-color: rgba(255,255,255,0.05);"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.15)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.05)\'"\n title="切换语言">\n <span id="language-text" style="font-size: 13px; font-weight: 600; color:var(--x-text-primary);">中文</span>\n </div>\n\n <div id="theme-toggle-btn" onclick="toggleXTheme()"\n style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'"\n title="切换主题">\n\n <svg id="theme-icon-dark" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff; display: block;">\n <g><path d="M20.742 13.045a8.088 8.088 0 0 1-2.077.271c-2.135 0-4.14-.83-5.646-2.336a8.025 8.025 0 0 1-2.064-7.723A1 1 0 0 0 9.73 2.034a10.014 10.014 0 0 0-4.489 2.582c-3.898 3.898-3.898 10.243 0 14.143a9.937 9.937 0 0 0 7.072 2.93 9.93 9.93 0 0 0 7.07-2.929 10.007 10.007 0 0 0 2.583-4.491 1.001 1.001 0 0 0-1.224-1.224zm-2.772 4.301a7.947 7.947 0 0 1-5.656 2.343 7.953 7.953 0 0 1-5.658-2.344c-3.118-3.119-3.118-8.195 0-11.314a7.923 7.923 0 0 1 2.06-1.483 10.027 10.027 0 0 0 2.89 7.848 9.972 9.972 0 0 0 7.848 2.891 8.036 8.036 0 0 1-1.484 2.059z"></path></g>\n </svg>\n\n <svg id="theme-icon-light" viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #000; display: none;">\n <g><path d="M12 2.5a1 1 0 0 1 1 1V5a1 1 0 1 1-2 0V3.5a1 1 0 0 1 1-1zm0 15a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9zm0 2a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13zM12 18a1 1 0 0 1 1 1v1.5a1 1 0 1 1-2 0V19a1 1 0 0 1 1-1zm9.5-6a1 1 0 0 1-1 1H19a1 1 0 1 1 0-2h1.5a1 1 0 0 1 1 1zM5 12a1 1 0 0 1-1 1H2.5a1 1 0 1 1 0-2H4a1 1 0 0 1 1 1zm12.864-6.864a1 1 0 0 1 0 1.414l-1.06 1.06a1 1 0 1 1-1.415-1.414l1.061-1.06a1 1 0 0 1 1.414 0zm-11.728 0a1 1 0 0 1 1.414 0l1.061 1.06A1 1 0 1 1 7.197 7.61l-1.06-1.06a1 1 0 0 1 0-1.415zM18.925 17.804a1 1 0 0 1 0 1.414l-1.061 1.061a1 1 0 0 1-1.414-1.414l1.06-1.061a1 1 0 0 1 1.415 0zm-13.85 0a1 1 0 0 1 1.414 0l1.061 1.061a1 1 0 0 1-1.414 1.414l-1.061-1.06a1 1 0 0 1 0-1.415z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n\n <div class="settings-content"\n style="flex: 1; padding: 15px; width: 100%; box-sizing: border-box; overflow-y: auto; min-height: 0;">\n\n <div class="settings-section" style="margin-bottom: 30px;">\n <label style="display: block; color: #fff; font-size: 17px; font-weight: 600; margin-bottom: 10px;" data-i18n="settingsPrompt">\n 提示词\n </label>\n <textarea id="x-system-prompt" placeholder="输入系统提示词..." data-i18n="settingsPromptPlaceholder"\n style="width: 100%; min-height: 120px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; line-height: 1.4;"\n onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n <div class="settings-section" style="margin-bottom: 30px;">\n <label style="display: block; color: #fff; font-size: 17px; font-weight: 600; margin-bottom: 10px;" data-i18n="settingsWorldView">\n 世界观设定\n </label>\n <textarea id="x-world-setting" placeholder="描述角色所在的世界观、背景设定..." data-i18n="settingsWorldViewPlaceholder"\n style="width: 100%; min-height: 100px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; line-height: 1.4;"\n onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n             <div class="settings-section" style="margin-bottom: 30px;">\n              <label style="color: #fff; font-size: 17px; font-weight: 600; display: block; margin-bottom: 10px;" data-i18n="settingsWorldBooks">\n                世界书管理\n              </label>\n              <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;" data-i18n="settingsWorldBooksDesc">\n                世界书可以为AI提供额外的知识库，支持绑定到不同场景和角色\n              </p>\n              <button onclick="openWorldBooksManageModal()" style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; color:var(--x-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; " onmouseover="this.style.borderColor=\'var(--x-accent)\'" onmouseout="this.style.borderColor=\'var(--x-border-color)\'">\n                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n                  <g><path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v13c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-13c0-.276-.224-.5-.5-.5h-13zM16 10H13V7h-2v3H8v2h3v3h2v-3h3v-2z"></path></g>\n                </svg>\n                <span data-i18n="settingsWorldBooksButton">打开世界书管理面板</span>\n              </button>\n            </div>\n\n            <div class="settings-section" style="margin-bottom: 30px;">\n              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n                <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsWorldEvents">\n                  世界运转大事件\n                </label>\n                <div class="x-toggle" onclick="toggleWorldEvents()" style="cursor: pointer;">\n                  <div id="world-events-toggle" class="toggle-switch"\n                    style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n                    <div class="toggle-circle"\n                      style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;" data-i18n="settingsWorldEventsDesc">\n                开启后，AI将根据世界观生成地点、天气和近期大事件，让推文生成更真实连贯\n              </p>\n\n              <div id="world-events-area" style="display: none;">\n                \x3c!-- 事件信息卡片 --\x3e\n                <div id="world-events-info" style="background-color: var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px;">\n                  \x3c!-- 地点和天气 --\x3e\n                  <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">\n                    <div style="flex: 1; min-width: 200px;">\n                      <div style="color: var(--x-text-secondary); font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">\n                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-text-secondary);">\n                          <g><path d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37c.324-.216 7.945-5.365 7.945-11.332C20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z"></path></g>\n                        </svg>\n                        <span data-i18n="settingsWorldEventsLocation">所在地点</span>\n                      </div>\n                      <div id="world-location" style="color: var(--x-text-primary); font-size: 16px; font-weight: 600;">--</div>\n                    </div>\n                    <div style="flex: 1; min-width: 200px;">\n                      <div style="color: var(--x-text-secondary); font-size: 13px; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">\n                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-text-secondary);">\n                          <g><path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z M16 12c1.1 0 2 .9 2 2v8H6v-8c0-1.1.9-2 2-2h8z"></path></g>\n                        </svg>\n                        <span data-i18n="settingsWorldEventsWeather">天气状况</span>\n                      </div>\n                      <div id="world-weather" style="color: var(--x-text-primary); font-size: 15px;">\n                        <span id="weather-condition">--</span> <span id="weather-temp" style="color: var(--x-accent);">--</span>\n                      </div>\n                      <div id="weather-tip" style="color: var(--x-text-secondary); font-size: 12px; margin-top: 2px;">--</div>\n                    </div>\n                  </div>\n\n                  \x3c!-- 生成时间 --\x3e\n                  <div style="color: var(--x-text-secondary); font-size: 12px; padding-top: 12px; border-top: 1px solid var(--x-border-color);">\n                    <span data-i18n="settingsWorldEventsLastGenerated">上次生成</span>: <span id="last-generated-time">--</span>\n                    <span style="margin-left: 16px;" data-i18n="settingsWorldEventsLastProgressed">上次推进</span>: <span id="last-progressed-time">--</span>\n                  </div>\n                </div>\n\n                \x3c!-- 大事件列表 --\x3e\n                <div style="background-color: var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; margin-bottom: 12px;">\n                  <div style="color: var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 12px;" data-i18n="settingsWorldEventsRecentEvents">近期大事件</div>\n                  <div id="world-events-list" style="max-height: 400px; overflow-y: auto;">\n                    <p style="color: var(--x-text-secondary); text-align: center; padding: 20px;" data-i18n="settingsWorldEventsNoEvents">暂无事件</p>\n                  </div>\n                </div>\n\n                \x3c!-- 操作按钮 --\x3e\n                <div style="display: flex; gap: 12px;">\n                  <button onclick="refreshWorldEvents()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n                      <g><path d="M4.5 12c0-4.14 3.36-7.5 7.5-7.5 1.47 0 2.84.43 4 1.16V3.5c0-.28.22-.5.5-.5s.5.22.5.5v3.5c0 .28-.22.5-.5.5H13c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h2.23c-.93-.59-2.02-.93-3.23-.93-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c2.49 0 4.64-1.39 5.75-3.45.11-.2.36-.27.56-.16.2.11.27.36.16.56C16.74 17.53 14.49 19 12 19c-4.14 0-7.5-3.36-7.5-7.5z"></path></g>\n                    </svg>\n                    <span data-i18n="settingsWorldEventsRefresh">更新事件</span>\n                  </button>\n                  <button id="progress-world-events-btn" onclick="progressWorldEvents()" style="flex: 1; background-color: #10b981; color: #fff; border: none; border-radius: 20px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;" onmouseover="this.style.backgroundColor=\'#059669\'" onmouseout="this.style.backgroundColor=\'#10b981\'">\n                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n                      <g><path d="M8 5.14v14l11-7-11-7z"></path></g>\n                    </svg>\n                    <span data-i18n="settingsWorldEventsProgress">推进事件</span>\n                  </button>\n                </div>\n                <p id="progress-cooldown-tip" style="color: var(--x-text-secondary); font-size: 12px; margin-top: 8px; text-align: center; display: none;" data-i18n="settingsWorldEventsCooldownTip">\n                  推进功能需要间隔3小时使用\n                </p>\n              </div>\n            </div>\n\n <div class="settings-section" style="margin-bottom: 30px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsAutoTweetDetection">\n 智能发推检测\n </label>\n <div class="x-toggle" onclick="toggleChatHistoryDetection()" style="cursor: pointer;">\n <div id="chat-history-detection-toggle" class="toggle-switch"\n style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n <div class="toggle-circle"\n style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n </div>\n </div>\n </div>\n </div>\n <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;">\n <span data-i18n="settingsAutoTweetDetectionDesc">开启后，每隔5分钟自动检测已绑定角色的聊天记忆，生成New Tweet通知</span><br>\n <span style="color: var(--x-accent); font-size: 13px;" data-i18n="settingsAutoTweetDetectionNote">仅对设置了"角色身份识别"和"专属用户人设"的角色生效</span>\n </p>\n <div id="chat-history-detection-status" style="padding: 12px; border-radius: 8px; background-color: #1a1a1a; border: 1px solid #333; color: #71767b; font-size: 14px; display: none; ">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <div id="detection-status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background-color: #10b981; animation: pulse 2s infinite; "></div>\n <span style="color: var(--x-accent); font-weight: 600;" data-i18n="settingsDetectionRunning">检测服务运行中</span>\n </div>\n <div style="font-size: 13px;">\n <span data-i18n="settingsNextDetectionTime">下次检测时间</span>: <span id="next-detection-time">--</span>\n </div>\n </div>\n </div>\n\n <div class="settings-section" style="margin-bottom: 30px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsAutoRefreshFeed">\n 智能刷新主页\n </label>\n <div class="x-toggle" onclick="toggleAutoRefreshFeed()" style="cursor: pointer;">\n <div id="auto-refresh-feed-toggle" class="toggle-switch"\n style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n <div class="toggle-circle"\n style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n </div>\n </div>\n </div>\n </div>\n <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;">\n <span data-i18n="settingsAutoRefreshFeedDesc">开启后，每隔10分钟自动刷新主页推文</span>\n </p>\n <div id="auto-refresh-feed-status" style="padding: 12px; border-radius: 8px; background-color: #1a1a1a; border: 1px solid #333; color: #71767b; font-size: 14px; display: none; ">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <div id="refresh-status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background-color: #10b981; animation: pulse 2s infinite; "></div>\n <span style="color: var(--x-accent); font-weight: 600;" data-i18n="settingsRefreshRunning">刷新服务运行中</span>\n </div>\n <div style="font-size: 13px;">\n <span data-i18n="settingsNextRefreshTime">下次刷新时间</span>: <span id="next-refresh-time">--</span>\n </div>\n </div>\n </div>\n\n <div class="settings-section" style="margin-bottom: 40px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsCharacterBinding">\n 绑定角色\n </label>\n <div class="x-toggle" onclick="toggleCharacterBinding()" style="cursor: pointer;">\n <div id="x-character-toggle" class="toggle-switch"\n style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n <div class="toggle-circle"\n style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n </div>\n </div>\n </div>\n </div>\n <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;" data-i18n="settingsCharacterBindingDesc">\n 开启后，绑定的角色可以在X上发布推文\n </p>\n\n <div id="character-binding-area" style="display: none;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;" data-i18n="settingsSelectCharacter">选择要绑定的角色</div>\n <div id="characters-list" style="max-height: 300px; overflow-y: auto;">\n\n </div>\n </div>\n </div>\n </div>\n\n <div class="settings-section" style="margin-bottom: 40px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsRelationship">\n 角色关系册\n </label>\n <div class="x-toggle" onclick="toggleCharacterRelationship()" style="cursor: pointer;">\n <div id="x-relationship-toggle" class="toggle-switch"\n style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n <div class="toggle-circle"\n style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n </div>\n </div>\n </div>\n </div>\n <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;" data-i18n="settingsRelationshipDesc">\n 开启后，可以为已绑定的角色建立关系网络，设置角色之间的双向关系\n </p>\n\n <div id="relationship-binding-area" style="display: none;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600;" data-i18n="settingsRelationshipGraph">角色关系图</div>\n <button onclick="openCharacterRelationshipGraph()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsEditGraph">\n 编辑关系图\n </button>\n </div>\n\n <div id="relationship-preview" style="background-color: #0a0a0a; border: 1px solid #2f3336; border-radius: 8px; padding: 20px; min-height: 150px; display: flex; align-items: center; justify-content: center; position: relative; ">\n <canvas id="relationship-preview-canvas" width="400" height="150" style="width: 100%; height: 100%;"></canvas>\n <div id="relationship-preview-placeholder" style="color: #71767b; font-size: 14px; text-align: center; ">\n <span data-i18n="relationshipNoData">暂无关系数据</span><br>\n <span style="font-size: 12px;" data-i18n="relationshipNoDataHint">点击上方按钮开始创建角色关系</span>\n </div>\n </div>\n\n <div id="relationship-stats" style="margin-top: 12px; padding: 12px; background-color: color-mix(in srgb, var(--x-accent) , 0.1); border-radius: 8px; display: none; ">\n <div style="color: var(--x-accent); font-size: 13px; display: flex; justify-content: space-around;">\n <div style="text-align: center;">\n <div style="font-weight: 700; font-size: 18px;" id="relationship-character-count">0</div>\n <div style="opacity: 0.8;" data-i18n="relationshipCharacterCount">角色数</div>\n </div>\n <div style="text-align: center;">\n <div style="font-weight: 700; font-size: 18px;" id="relationship-link-count">0</div>\n <div style="opacity: 0.8;" data-i18n="relationshipLinkCount">关系数</div>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n\n <div class="settings-section" style="margin-bottom: 40px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">\n <label style="color: #fff; font-size: 17px; font-weight: 600;" data-i18n="settingsNPCBinding">\n 绑定NPC\n </label>\n <div class="x-toggle" onclick="toggleNPCBinding()" style="cursor: pointer;">\n <div id="x-npc-toggle" class="toggle-switch"\n style="width: 50px; height: 30px; background-color: #333; border-radius: 15px; position: relative; transition: all 0.3s ease;">\n <div class="toggle-circle"\n style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.3s ease;">\n </div>\n </div>\n </div>\n </div>\n <p style="color: #71767b; font-size: 14px; margin: 0 0 15px 0; line-height: 1.4;" data-i18n="settingsNPCBindingDesc">\n 开启后，可以创建和管理自定义NPC，设置其人设、发帖习惯和绑定用户\n </p>\n\n <div id="npc-binding-area" style="display: none;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600;" data-i18n="settingsNPCList">NPC列表</div>\n <button onclick="openCreateNPCModal()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsCreateNPC">\n + 创建NPC\n </button>\n </div>\n <div id="npcs-list" style="max-height: 300px; overflow-y: auto;">\n\n </div>\n </div>\n </div>\n </div>\n\n <div class="settings-buttons" style="display: flex; flex-direction: column; gap: 12px;">\n\n <button onclick="saveXSettings()"\n style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 12px 24px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsSave">\n 保存设置\n </button>\n\n <button onclick="saveXPreset()"\n style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 12px 24px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsSavePreset">\n 保存为预设\n </button>\n\n <div style="display: flex; gap: 12px;">\n <button onclick="importXData()"\n style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsImport">\n 导入数据\n </button>\n <button onclick="exportXData()"\n style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'" data-i18n="settingsExport">\n 导出数据\n </button>\n </div>\n </div>\n\n <div class="preset-management" style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #333;">\n <h3 style="color: #fff; font-size: 18px; font-weight: 700; margin-bottom: 15px;" data-i18n="settingsPresetManagement">预设管理</h3>\n <div id="x-presets-list" style="display: flex; flex-direction: column;">\n\n </div>\n </div>\n </div>\n </div>\n\n <div id="x-tweet-detail-page" class="x-page"\n style="flex: 1; display: none; flex-direction: column; overflow: hidden;">\n\n <div class="tweet-detail-header"\n style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 5;">\n <div style="display: flex; align-items: center;">\n <div class="tweet-detail-back-btn" onclick="goBackFromTweetDetail()"\n style="cursor: pointer; margin-right: 15px;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>\n </g>\n </svg>\n </div>\n <span style="font-size: 20px; font-weight: 700; color: #fff;" data-i18n="tweetDetailTitle">帖子</span>\n </div>\n\n <div id="reroll-replies-btn"\n onclick="rerollAIReplies()"\n onmousedown="handleTweetRerollButtonMouseDown()"\n onmouseup="handleTweetRerollButtonMouseUp()"\n onmouseleave="handleTweetRerollButtonMouseUp()"\n ontouchstart="handleTweetRerollButtonMouseDown()"\n ontouchend="handleTweetRerollButtonMouseUp()"\n ontouchcancel="handleTweetRerollButtonMouseUp()"\n style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background-color: transparent; border: none; border-radius: 50%; cursor: pointer; transition: all 0.2s; user-select: none; -webkit-user-select: none; "\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'"\n title="重新生成回复">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g>\n <path\n d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />\n </g>\n </svg>\n </div>\n </div>\n\n <div class="tweet-detail-content" style="flex: 1; overflow-y: auto;">\n <div id="tweet-detail-container" style="padding: 0;">\n\n </div>\n\n <div style="border-top: 1px solid var(--x-border-color);">\n\n <div id="detail-comments-container" style="padding: 0; padding-bottom: 70px;">\n\n </div>\n </div>\n\n <div class="detail-comment-input-area"\n style="border-top: 1px solid var(--x-border-color); padding: 10px 15px; background-color:var(--x-bg-primary); position: fixed; bottom: 0; left: 0; right: 0; z-index: 10;">\n <div style="display: flex; align-items: flex-start; gap: 12px; max-width: 100%;">\n\n <img id="detail-comment-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Your avatar"\n style="width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;">\n\n <div style="flex: 1;">\n <textarea id="detail-comment-input" placeholder="发布你的回复" data-i18n="tweetDetailReplyPlaceholder"\n style="width: 100%; min-height: 18px; max-height: 100px; background: transparent; border: none; color: #fff; font-size: 15px; resize: none; outline: none; font-family: inherit; line-height: 1.3;"\n onkeydown="handleDetailCommentInput(event)" oninput="autoResizeDetail(this)"></textarea>\n\n <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">\n\n <div style="display: flex; gap: 12px;">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent); cursor: pointer;" onclick="triggerDetailCommentImageUpload()">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n                 <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent); cursor: pointer; opacity: 0.5;">\n                    <g>\n                        <path\n                            d="M3 5.5C3 4.119 4.12 3 5.5 3h13C19.88 3 21 4.119 21 5.5v13c0 1.381-1.12 2.5-2.5 2.5h-13C4.12 21 3 19.881 3 18.5v-13zM5.5 5c-.28 0-.5.224-.5.5v13c0 .276.22.5.5.5h13c.28 0 .5-.224.5-.5v-13c0-.276-.22-.5-.5-.5h-13zM18 10.711V9.25h-3.74v5.5h1.44v-1.719h1.7V11.57h-1.7v-.859H18zM11.79 9.25h1.44v5.5h-1.44v-5.5zm-3.07 1.375c.34 0 .77.172 1.02.43l1.03-.86c-.51-.601-1.28-.945-2.05-.945C7.19 9.25 6 10.453 6 12s1.19 2.75 2.72 2.75c.77 0 1.54-.344 2.05-.945l-1.03-.86c-.25.258-.68.43-1.02.43-.76 0-1.29-.546-1.29-1.375S8.03 10.625 8.79 10.625z">\n                        </path>\n                    </g>\n                </svg>\n                <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent); cursor: pointer;" onclick="openCommentStickers()">\n                    <g>\n                        <path\n                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z">\n                        </path>\n                    </g>\n                </svg>\n </div>\n\n <button id="detail-reply-btn" onclick="submitDetailComment()"\n style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 18px; padding: 6px 16px; font-size: 14px; font-weight: 700; cursor: pointer; opacity: 0.5;"\n disabled data-i18n="tweetDetailReply">\n 回复\n </button>\n </div>\n\n <div id="detail-comment-image-preview" style="display: none; margin-top: 10px; position: relative;">\n <img id="detail-comment-image-preview-img" src="" style="max-width: 180px; max-height: 180px; border-radius: 12px; display: block;">\n <button onclick="removeDetailCommentImage()"\n style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.75); border: none; border-radius: 50%; width: 26px; height: 26px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n </div>\n\n <input type="file" id="detail-comment-image-input" accept="image/*" style="display: none;" onchange="handleDetailCommentImageUpload(event)">\n </div>\n </div>\n </div>\n </div>\n </div>\n\n <div id="x-profile-page" class="x-page" style="flex: 1; display: none; flex-direction: column; overflow-y: auto; padding: 0; margin: 0;">\n\n <div class="profile-header"\n style="display: flex; align-items: center; padding: 10px 15px; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: relative; z-index: 5; margin: 0;">\n <div class="profile-back-btn" onclick="switchXPage(\'home\')" style="cursor: pointer; margin-right: 15px;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path>\n </g>\n </svg>\n </div>\n <div style="flex: 1;">\n <div id="x-profile-header-name" style="font-size: 20px; font-weight: 700; color: #fff;">我</div>\n <div id="x-profile-header-count" style="font-size: 13px; color: #71767b;">0 帖子</div>\n </div>\n <div style="display: flex; gap: 15px;">\n\n <div onclick="switchXPage(\'askbox\')" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'"\n title="提问箱">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>\n </g>\n </svg>\n </div>\n\n <div id="profile-menu-btn" onclick="toggleProfileMenu()"\n style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; position: relative;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path\n d="M3 12c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm7 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z">\n </path>\n </g>\n </svg>\n\n <div id="profile-dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); min-width: 200px; z-index: 50; margin-top: 8px; overflow: hidden; ">\n <div onclick="openAccountManager()" style="padding: 12px 16px; color: #fff; font-size: 15px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.03)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n <g>\n <path\n d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.5C18.5 4.4 16.6 2.5 14.5 2L14 0H10L9.5 2C7.4 2.5 5.5 4.4 5 6.5L3 7V9L5 9.5C5.5 11.6 7.4 13.5 9.5 14L10 16H14L14.5 14C16.6 13.5 18.5 11.6 19 9.5L21 9ZM12 8C13.66 8 15 9.34 15 11C15 12.66 13.66 14 12 14C10.34 14 9 12.66 9 11C9 9.34 10.34 8 12 8ZM19 17H5V19H19V17ZM12 20C10.9 20 10 20.9 10 22H14C14 20.9 13.1 20 12 20Z">\n </path>\n </g>\n </svg>\n <span data-i18n="profileAccountManager">账号管理</span>\n </div>\n <div onclick="openAccountWallet()" style="padding: 12px 16px; color: #fff; font-size: 15px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.03)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n <g>\n <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>\n </g>\n </svg>\n <span data-i18n="profileAccountWallet">账户钱包</span>\n </div>\n <div onclick="openToolModal()" style="padding: 12px 16px; color: #fff; font-size: 15px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.03)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n <g>\n <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/>\n </g>\n </svg>\n <span data-i18n="profileAccountTools">账户道具</span>\n </div>\n </div>\n </div>\n </div>\n </div>\n\n <div class="cover-section" style="position: relative; height: 140px; background-color: #333; margin: 0; padding: 0; margin-top: -1px;">\n <img id="x-profile-cover-image" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg"\n style="width: 100%; height: 100%; object-fit: cover; display: block; margin: 0; padding: 0; vertical-align: top;" alt="封面图">\n </div>\n\n <div class="user-info-section" style="padding: 8px 16px 0; position: relative;">\n\n <div style="position: relative; margin-bottom: 8px;">\n <img id="x-profile-main-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"\n style="width: 88px; height: 88px; border-radius: 50%; border: 5px solid #000; position: absolute; top: -44px; left: 0; object-fit: cover; overflow: hidden; box-sizing: border-box;"\n alt="用户头像">\n </div>\n\n <div style="display: flex; justify-content: flex-end; margin: 8px 0;">\n <button onclick="editProfile()"\n style="background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'" data-i18n="profileEditProfile">\n 编辑个人资料\n </button>\n </div>\n\n <div style="margin-top: 8px; margin-bottom: 0px; padding-left: 8px;">\n <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 4px;">\n <span id="x-profile-user-name" style="font-size: 20px; font-weight: 700; color: #fff;">我</span>\n <svg id="x-profile-verified-badge" viewBox="0 0 24 24"\n style="width: 20px; height: 20px; fill: var(--x-accent); display: none;">\n <g>\n <path\n d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z">\n </path>\n </g>\n </svg>\n </div>\n <div id="x-profile-user-handle" style="font-size: 15px; color: #71767b; margin-bottom: 8px;">@me</div>\n </div>\n\n <div id="x-profile-bio" style="font-size: 15px; color: #fff; line-height: 1.3; margin-bottom: 8px; padding-left: 8px;">\n 欢迎来到我的X主页！\n </div>\n\n <div class="profile-tags"\n style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; padding-left: 8px;">\n <div style="display: flex; align-items: center; gap: 4px;">\n <span id="x-profile-tag1-icon" style="font-size: 14px;">✨</span>\n <span id="x-profile-tag1" style="color: #71767b; font-size: 14px;">科技爱好者</span>\n </div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <span id="x-profile-tag2-icon" style="font-size: 14px;">📅</span>\n <span id="x-profile-tag2" style="color: #71767b; font-size: 14px;">2024年加入</span>\n </div>\n </div>\n\n <div style="display: flex; gap: 16px; margin-bottom: 8px; padding-left: 8px;">\n <div style="cursor: pointer;" onmouseover="this.querySelector(\'span\').style.textDecoration=\'underline\'"\n onmouseout="this.querySelector(\'span\').style.textDecoration=\'none\'">\n <span id="x-profile-following-count" style="color: #fff; font-weight: 700; font-size: 14px;">156</span>\n <span style="color: #71767b; margin-left: 2px; font-size: 14px; font-weight: 400;" data-i18n="profileFollowing">正在关注</span>\n </div>\n <div style="cursor: pointer;" onmouseover="this.querySelector(\'span\').style.textDecoration=\'underline\'"\n onmouseout="this.querySelector(\'span\').style.textDecoration=\'none\'">\n <span id="x-profile-followers-count" style="color: #fff; font-weight: 700; font-size: 14px;">89</span>\n <span style="color: #71767b; margin-left: 2px; font-size: 14px; font-weight: 400;" data-i18n="profileFollowers">关注者</span>\n </div>\n </div>\n </div>\n\n <div class="profile-tabs" style="display: flex; border-bottom: 1px solid #2f3336;">\n <div class="profile-tab active" onclick="switchProfileTab(\'posts\')"\n style="flex: 1; text-align: center; padding: 14px 0; font-weight: 600; font-size: 15px; cursor: pointer; position: relative; color: #fff;">\n <span data-i18n="profilePosts">帖子</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--x-accent); border-radius: 2px;">\n </div>\n </div>\n <div class="profile-tab" onclick="switchProfileTab(\'likes\')"\n style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">\n <span data-i18n="profileLikes">喜欢</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--x-accent); border-radius: 2px; display: none;">\n </div>\n </div>\n <div class="profile-tab" onclick="switchProfileTab(\'highlights\')"\n style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">\n <span data-i18n="profileHighlights">亮点</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--x-accent); border-radius: 2px; display: none;">\n </div>\n </div>\n <div class="profile-tab" onclick="switchProfileTab(\'articles\')"\n style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">\n <span data-i18n="profileArticles">文章</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--x-accent); border-radius: 2px; display: none;">\n </div>\n </div>\n <div class="profile-tab" onclick="switchProfileTab(\'media\')"\n style="flex: 1; text-align: center; padding: 14px 0; font-weight: 500; font-size: 15px; cursor: pointer; position: relative; color: #71767b;">\n <span data-i18n="profileMedia">媒体</span>\n <div class="tab-indicator"\n style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--x-accent); border-radius: 2px; display: none;">\n </div>\n </div>\n </div>\n\n <div class="profile-content" style="flex: 1;">\n\n <div id="profile-posts-content" class="profile-tab-content" style="display: block;">\n <div id="x-profile-tweets-container" style="padding: 0;">\n\n </div>\n </div>\n\n <div id="profile-likes-content" class="profile-tab-content" style="display: none;">\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;" data-i18n="profileNoLikes">还没有喜欢的推文</div>\n <div style="color: #71767b; font-size: 15px;" data-i18n="profileNoLikesDesc">当你喜欢一条推文时，它会显示在这里。</div>\n </div>\n </div>\n <div id="profile-highlights-content" class="profile-tab-content" style="display: none;">\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;" data-i18n="profileNoHighlights">还没有亮点</div>\n <div style="color: #71767b; font-size: 15px;" data-i18n="profileNoHighlightsDesc">点赞最多的推文会显示在这里。</div>\n </div>\n </div>\n <div id="profile-articles-content" class="profile-tab-content" style="display: none;">\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;" data-i18n="profileNoArticles">还没有文章</div>\n <div style="color: #71767b; font-size: 15px;" data-i18n="profileNoArticlesDesc">发布的文章会显示在这里。</div>\n </div>\n </div>\n <div id="profile-media-content" class="profile-tab-content" style="display: none;">\n <div style="padding: 60px 32px; text-align: center;">\n <div style="color: #71767b; font-size: 31px; font-weight: 800; margin-bottom: 8px;" data-i18n="profileNoMedia">还没有媒体</div>\n <div style="color: #71767b; font-size: 15px;" data-i18n="profileNoMediaDesc">包含照片和视频的推文会显示在这里。</div>\n </div>\n </div>\n </div>\n </div>\n</div>\n\n<div id="edit-profile-modal" class="profile-modal" onclick="closeEditProfileModal(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(91, 112, 131, 0.4); z-index: 20; overflow-y: auto;\n">\n <div class="modal-content" onclick="event.stopPropagation()" style="background-color:#000; margin: 40px auto; border-radius: 16px; max-width: 600px; width: calc(100% - 40px); max-height: calc(100vh - 80px); position: relative; overflow: hidden; ">\n\n <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #2f3336; position: sticky; top: 0; background-color:#000; z-index: 25; ">\n <div style="display: flex; align-items: center; gap: 24px;">\n\n <div class="modal-close-btn" onclick="closeEditProfileModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path\n d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">\n </path>\n </g>\n </svg>\n </div>\n\n <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0; ">编辑个人资料</h2>\n </div>\n\n <button id="save-profile-btn" onclick="saveProfileChanges()" style="background-color:#fff; color: #000; border: none; border-radius: 20px; padding: 6px 16px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#d7dbdc\'" onmouseout="this.style.backgroundColor=\'#fff\'">\n 保存\n </button>\n </div>\n\n <div class="modal-body" style="padding: 0; overflow-y: auto; max-height: calc(100vh - 140px); ">\n\n <div class="edit-cover-section" style="position: relative; height: 200px; background-color: #333; overflow: hidden; ">\n <img id="edit-cover-image" src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg"\n style="width: 100%; height: 100%; object-fit: cover;" alt="封面图">\n\n <div class="cover-edit-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; gap: 12px; ">\n\n <div class="cover-edit-btn" onclick="editCoverImage()" style="background-color: rgba(0, 0, 0, 0.75); border-radius: 50%; padding: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(0,0,0,0.85)\'"\n onmouseout="this.style.backgroundColor=\'rgba(0,0,0,0.75)\'">\n <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n </div>\n\n <div class="cover-remove-btn" onclick="removeCoverImage()" style="background-color: rgba(0, 0, 0, 0.75); border-radius: 50%; padding: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(0,0,0,0.85)\'"\n onmouseout="this.style.backgroundColor=\'rgba(0,0,0,0.75)\'">\n <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">\n <g>\n <path\n d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n </div>\n\n <div class="edit-avatar-section" style="padding: 12px 16px; position: relative; margin-top: -67px; z-index: 3; ">\n <div style="position: relative; width: 134px;">\n <img id="edit-main-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg"\n style="width: 134px; height: 134px; border-radius: 50%; border: 4px solid #000; object-fit: cover; overflow: hidden; box-sizing: border-box;" alt="用户头像">\n\n <div class="avatar-edit-btn" onclick="editAvatarImage()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.75); border-radius: 50%; padding: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(0,0,0,0.85)\'"\n onmouseout="this.style.backgroundColor=\'rgba(0,0,0,0.75)\'">\n <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n </div>\n\n <div class="edit-form-section" style="padding: 24px 16px;">\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 2px; ">名称</label>\n <input type="text" id="edit-user-name" placeholder="名称" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="50"\n oninput="updateCharacterCounts()">\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 50</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 2px; ">用户名</label>\n <input type="text" id="edit-user-handle" placeholder="用户名" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="15"\n oninput="updateCharacterCounts()">\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 15</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 2px; ">自我介绍</label>\n <textarea id="edit-user-bio" placeholder="自我介绍" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; resize: vertical; min-height: 80px; max-height: 150px; font-family: inherit; line-height: 1.3; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="160"\n oninput="updateCharacterCounts()"></textarea>\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 160</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 25px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">自定义标签1</label>\n\n <div style="display: flex; gap: 8px; margin-bottom: 8px;">\n\n <input type="text" id="edit-tag1-icon" placeholder="✨" maxlength="2" style="width: 50px; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; text-align: center; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n\n <input type="text" id="edit-custom-tag1" placeholder="例如：科技爱好者" style="flex: 1; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="30"\n oninput="updateCharacterCounts()">\n </div>\n\n <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">\n <label style="color: #8b98a5; font-size: 12px; min-width: 40px;">颜色:</label>\n <input type="color" id="edit-tag1-color" value="#71767b" style="width: 40px; height: 32px; border: 1px solid #333; border-radius: 4px; background: transparent; cursor: pointer; outline: none; " onchange="updateTag1ColorFromPicker()">\n <input type="text" id="edit-tag1-color-text" placeholder="#71767b" maxlength="7" style="flex: 1; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 8px 12px; font-size: 14px; outline: none; font-family: monospace; transition: border-color 0.2s; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"\n oninput="updateTag1ColorFromText()" onchange="updateTag1ColorFromText()">\n </div>\n <div style="color: #8b98a5; font-size: 13px;">0 / 30</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 25px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">自定义标签2</label>\n\n <div style="display: flex; gap: 8px; margin-bottom: 8px;">\n\n <input type="text" id="edit-tag2-icon" placeholder="📅" maxlength="2" style="width: 50px; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; text-align: center; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n\n <input type="text" id="edit-custom-tag2" placeholder="例如：2024年加入" style="flex: 1; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="30"\n oninput="updateCharacterCounts()">\n </div>\n\n <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">\n <label style="color: #8b98a5; font-size: 12px; min-width: 40px;">颜色:</label>\n <input type="color" id="edit-tag2-color" value="#71767b" style="width: 40px; height: 32px; border: 1px solid #333; border-radius: 4px; background: transparent; cursor: pointer; outline: none; " onchange="updateTag2ColorFromPicker()">\n <input type="text" id="edit-tag2-color-text" placeholder="#71767b" maxlength="7" style="flex: 1; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 8px 12px; font-size: 14px; outline: none; font-family: monospace; transition: border-color 0.2s; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"\n oninput="updateTag2ColorFromText()" onchange="updateTag2ColorFromText()">\n </div>\n <div style="color: #8b98a5; font-size: 13px;">0 / 30</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 2px; ">正在关注数量</label>\n <input type="text" id="edit-following-count" placeholder="156, 1.2K, 2.5M等" maxlength="20" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">可输入任意数字、字母、符号组合</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 2px; ">关注者数量</label>\n <input type="text" id="edit-followers-count" placeholder="89, 1.5K, 3.2M等" maxlength="20" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">可输入任意数字、字母、符号组合</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 25px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">认证类型</label>\n <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">\n 选择您的认证类型，不同认证类型会显示不同的图标和含义。\n </div>\n\n <div style="margin-bottom: 12px;">\n <select id="edit-verification-type" style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"\n onchange="updateVerificationTypeUI()">\n <option value="none" style="background-color:#000; color: #fff;">无认证</option>\n <option value="verified" style="background-color:#000; color: #fff;">已认证 - 蓝色勾标</option>\n <option value="couple" style="background-color:#000; color: #fff;">情侣认证 - 白色心形</option>\n <option value="married" style="background-color:#000; color: #fff;">已婚认证 - 白色圆环</option>\n <option value="vip" style="background-color:#000; color: #fff;">VIP认证 - 白色菱形</option>\n </select>\n </div>\n\n <div id="couple-binding-section" style="display: none;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">情侣对象角色</label>\n <div style="color: #71767b; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">\n 选择与您是情侣关系的角色。绑定后，其他推特观众都会知道你们的情侣关系。\n </div>\n <select id="edit-couple-character" style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <option value="" style="background-color:#000; color: #fff;">未选择角色</option>\n\n </select>\n </div>\n </div>\n\n <div class="form-group" style="margin-bottom: 25px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">公众身份</label>\n <div style="color: #71767b; font-size: 12px; margin-bottom: 8px; line-height: 1.4;">\n 描述您在X平台的公众身份（如明星、网红、博主等）。这将影响其他用户对您的讨论几率，身份越知名可能引起更多关注和讨论。此信息完全公开。\n </div>\n\n <div\n style="background-color: color-mix(in srgb, var(--x-accent) , 0.1); border: 1px solid var(--x-accent); border-radius: 6px; padding: 12px; margin-bottom: 12px;">\n <div style="color: var(--x-accent); font-size: 12px; line-height: 1.4;">\n <strong>📌 重要提醒：</strong>您将以完整身份进行互动，但<strong\n style="color: var(--x-accent);">X平台其他用户无法读取您的个人设定</strong>，仅能看到此公众身份信息。如需让其他用户了解的个人特点、背景经历等内容，请全部详细填写至公众身份中。\n </div>\n </div>\n <textarea id="edit-public-identity" placeholder="例如：知名科技博主、演员、歌手、网络红人等... 可详细描述您的公开背景、成就、特点等，无字数限制" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; resize: vertical; min-height: 120px; max-height: 200px; font-family: inherit; line-height: 1.3; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n <div style="color: #8b98a5; font-size: 12px; margin-top: 4px;">💡 无字数限制，可详细描述您的公开信息</div>\n </div>\n\n <div class="form-group" style="margin-bottom: 25px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">真名设置</label>\n <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">\n 选择是否公开您的真实姓名。公开后，其他用户和角色都能看到您的真名，情侣认证时也会显示双方真名。\n </div>\n\n <div style="margin-bottom: 12px;">\n <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">\n <input type="checkbox" id="edit-show-real-name" style="width: 16px; height: 16px; accent-color: var(--x-accent); " onchange="toggleRealNameInput()">\n <span style="color: #fff; font-size: 15px;">公开真实姓名</span>\n </label>\n </div>\n\n <div id="real-name-input-container" style="display: none;">\n <input type="text" id="edit-real-name" placeholder="请输入您的真实姓名" style="width: 100%; background-color: transparent; border: 1px solid #333; border-radius: 4px; color: #fff; padding: 12px; font-size: 17px; outline: none; transition: border-color 0.2s; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="50"\n oninput="updateCharacterCounts()">\n <div style="color: #8b98a5; font-size: 13px; margin-top: 4px;">0 / 50</div>\n </div>\n </div>\n\n <div class="form-group" style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; font-weight: 400; margin-bottom: 8px; ">角色身份识别</label>\n <div style="color: #71767b; font-size: 12px; margin-bottom: 12px; line-height: 1.4;">\n 选择哪些角色知道您的真实身份。被选中的角色会认识您，在互动时会表现得像朋友一样。\n <br><br>\n <strong style="color: var(--x-accent);">功能说明：</strong><br>\n • 知道您身份的角色会在评论区与您自然互动<br>\n • 您发帖时，这些角色可能会来留言<br>\n • 只有已绑定X资料的角色才能被选择<br>\n • <strong style="color: var(--x-accent);">点击右侧按钮</strong>可设置专属的用户人设<br>\n • 🔵 蓝色<strong>+</strong>按钮：未设置 | 🟢 绿色<strong>✏️</strong>按钮：已设置\n </div>\n\n <div id="identity-characters-list" style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; ">\n\n </div>\n </div>\n </div>\n </div>\n </div>\n</div>\n\n<div id="compose-tweet-modal" class="compose-modal" onclick="closeComposeTweetModal(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(91, 112, 131, 0.4); z-index: 20; overflow-y: auto;\n">\n <div class="compose-modal-content" onclick="event.stopPropagation()" style="background-color:#000; margin: 40px auto; border-radius: 16px; max-width: 600px; width: calc(100% - 40px); max-height: calc(100vh - 80px); position: relative; overflow: hidden; ">\n\n <div class="compose-header" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #2f3336; position: sticky; top: 0; background-color:#000; z-index: 25; ">\n <div style="display: flex; align-items: center; gap: 24px;">\n\n <div class="compose-close-btn" onclick="closeComposeTweetModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g>\n <path\n d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n\n <button id="compose-tweet-btn" onclick="publishTweet()" disabled style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 20px; font-size: 15px; font-weight: 700; cursor: pointer; opacity: 0.5; transition: all 0.2s; ">\n 发帖\n </button>\n </div>\n\n <div class="compose-body" style="padding: 16px; overflow-y: auto; max-height: calc(100vh - 200px); ">\n\n <div style="display: flex; gap: 12px; margin-bottom: 20px;">\n\n <img id="compose-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="用户头像"\n style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;">\n\n <div style="flex: 1; min-width: 0;">\n\n <textarea id="compose-text-input" placeholder="有什么新鲜事？" style="width: 100%; min-height: 120px; max-height: 300px; background: transparent; border: none; color: #fff; font-size: 20px; resize: none; outline: none; font-family: inherit; line-height: 1.3; box-sizing: border-box; " oninput="handleComposeInput()" onkeyup="processHashtagsAndMentions()"></textarea>\n\n <div id="quote-content-preview"\n style="display: none; margin-top: 16px; border: 1px solid #2f3336; border-radius: 16px; padding: 12px; background-color: rgba(0,0,0,0.3);">\n <div\n style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n <div style="display: flex; align-items: center; gap: 4px;">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #71767b;">\n <g>\n <path\n d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z">\n </path>\n </g>\n </svg>\n <span id="quote-type-text" style="color: #71767b; font-size: 13px;">引用推文</span>\n </div>\n <div onclick="removeQuoteContent()"\n style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #71767b;">\n <g>\n <path\n d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <img id="quote-user-avatar" style="width: 20px; height: 20px; border-radius: 50%;" alt="用户头像">\n <span id="quote-user-name" style="font-weight: 600; color: #fff; font-size: 13px;"></span>\n <svg id="quote-user-verified" viewBox="0 0 24 24"\n style="width: 14px; height: 14px; fill: var(--x-accent); display: none;">\n <g>\n <path\n d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.27 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.46 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z">\n </path>\n </g>\n </svg>\n <span id="quote-user-handle" style="color: #71767b; font-size: 13px;"></span>\n <span id="quote-user-time" style="color: #71767b; font-size: 13px;"></span>\n </div>\n <div id="quote-content-text"\n style="color: #fff; font-size: 14px; line-height: 1.3; word-wrap: break-word;"></div>\n\n <div id="quote-image-container" style="display: none;"></div>\n </div>\n\n <div style="display: flex; justify-content: flex-end; margin-top: 8px;">\n <div id="compose-char-count" style="color: #71767b; font-size: 13px; ">0 / 280</div>\n </div>\n\n <div id="business-task-selection" style="display: none; margin-top: 16px; margin-bottom: 16px;">\n <div style="background-color: #1a1a1a; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px;">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #f59e0b;">\n <g><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" /></g>\n </svg>\n <div style="color: #f59e0b; font-size: 15px; font-weight: 700;">选择商业任务</div>\n </div>\n <div id="business-tasks-list" style="display: flex; flex-direction: column; gap: 8px;">\n\n </div>\n </div>\n </div>\n\n <div style="margin-top: 16px;">\n\n <div id="compose-image-section" style="display: none; margin-bottom: 16px;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">添加图片</div>\n\n <div style="display: flex; gap: 12px; margin-bottom: 16px;">\n <button onclick="selectImageMethod(\'description\')" id="img-desc-btn" style="flex: 1; background-color: #333; color: #fff; border: 1px solid #536471; border-radius: 8px; padding: 8px 12px; font-size: 13px; cursor: pointer; transition: all 0.2s; ">文字描述</button>\n <button onclick="selectImageMethod(\'upload\')" id="img-upload-btn" style="flex: 1; background-color: #333; color: #fff; border: 1px solid #536471; border-radius: 8px; padding: 8px 12px; font-size: 13px; cursor: pointer; transition: all 0.2s; ">本地上传</button>\n </div>\n\n <div id="image-description-input" style="display: none;">\n <textarea placeholder="描述图片内容..." style="width: 100%; min-height: 80px; background-color:#000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n <div id="image-upload-area" style="display: none;">\n <div style="border: 2px dashed #333; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; " onclick="triggerImageUpload()" onmouseover="this.style.borderColor=\'var(--x-accent)\'"\n onmouseout="this.style.borderColor=\'#333\'">\n <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #71767b; margin-bottom: 8px;">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n <div style="color: #71767b; font-size: 15px;">点击选择图片文件</div>\n <div style="color: #71767b; font-size: 13px; margin-top: 4px;">支持 JPG、PNG、GIF，最多4张，每张最大 5MB</div>\n </div>\n <input type="file" id="image-file-input" accept="image/*" multiple style="display: none;"\n onchange="handleImageUpload(event)">\n <div id="uploaded-image-preview" style="display: none; margin-top: 12px;">\n <div id="preview-images-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;"></div>\n </div>\n </div>\n\n <div style="display: flex; gap: 8px; margin-top: 12px;">\n <button onclick="saveImageData()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存图片\n </button>\n <button onclick="removeImage()" style="flex: 1; background-color: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(244,33,46,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n 移除图片\n </button>\n </div>\n </div>\n </div>\n\n <div id="compose-location-section" style="display: none; margin-bottom: 16px;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">添加位置</div>\n <input type="text" id="location-input" placeholder="输入位置信息..." style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n <div style="display: flex; gap: 8px; margin-top: 12px;">\n <button onclick="saveLocationData()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存位置\n </button>\n <button onclick="removeLocation()" style="flex: 1; background-color: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(244,33,46,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n 移除位置\n </button>\n </div>\n </div>\n </div>\n\n <div id="compose-link-section" style="display: none; margin-bottom: 16px;">\n <div style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 16px;">\n <div style="color: #fff; font-size: 15px; font-weight: 600; margin-bottom: 12px;">附带链接</div>\n\n <input type="text" id="link-title-input" placeholder="链接标题..." style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; margin-bottom: 12px; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n\n <input type="text" id="link-url-input" placeholder="example.com" style="width: 100%; background-color:#000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; margin-bottom: 12px; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n\n <textarea id="link-description-input" placeholder="简述链接内容..." style="width: 100%; min-height: 60px; background-color:#000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; font-family: inherit; box-sizing: border-box; margin-bottom: 12px; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n\n <div style="margin-bottom: 12px;">\n <label\n style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">链接首图（可选）</label>\n <div style="border: 2px dashed #333; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; " onclick="triggerLinkImageUpload()" onmouseover="this.style.borderColor=\'var(--x-accent)\'"\n onmouseout="this.style.borderColor=\'#333\'">\n <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #71767b; margin-bottom: 4px;">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n <div style="color: #71767b; font-size: 13px;">点击上传链接首图</div>\n </div>\n <input type="file" id="link-image-input" accept="image/*" style="display: none;"\n onchange="handleLinkImageUpload(event)">\n <div id="link-image-preview" style="display: none; margin-top: 8px;">\n <img id="link-preview-image"\n style="width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px;" alt="链接首图预览">\n </div>\n </div>\n <div style="display: flex; gap: 8px;">\n <button onclick="saveLinkData()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存链接\n </button>\n <button onclick="removeLink()" style="flex: 1; background-color: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 8px; padding: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(244,33,46,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n 移除链接\n </button>\n </div>\n </div>\n </div>\n\n <div\n style="display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #2f3336; padding-top: 16px;">\n\n <div style="display: flex; gap: 16px;">\n\n <div id="image-btn" onclick="toggleImageSection()" style="padding: 8px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(29,155,240,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g>\n <path\n d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z">\n </path>\n </g>\n </svg>\n </div>\n\n <div id="location-btn" onclick="toggleLocationSection()" style="padding: 8px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(29,155,240,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g>\n <path\n d="M12 7c-1.93 0-3.5 1.57-3.5 3.5S10.07 14 12 14s3.5-1.57 3.5-3.5S13.93 7 12 7zm0 5c-.827 0-1.5-.673-1.5-1.5S11.173 9 12 9s1.5.673 1.5 1.5S12.827 12 12 12zm0-10c-4.687 0-8.5 3.813-8.5 8.5 0 5.967 7.621 11.116 7.945 11.332l.555.37.555-.37C12.879 21.616 20.5 16.467 20.5 10.5 20.5 5.813 16.687 2 12 2zm0 17.77c-1.665-1.241-6.5-5.196-6.5-9.27C5.5 6.916 8.416 4 12 4s6.5 2.916 6.5 6.5c0 4.073-4.835 8.028-6.5 9.27z">\n </path>\n </g>\n </svg>\n </div>\n\n <div id="attach-btn" onclick="toggleLinkSection()" style="padding: 8px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(29,155,240,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g>\n <path\n d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z">\n </path>\n </g>\n </svg>\n </div>\n </div>\n\n <div id="privacy-setting-btn" onclick="togglePrivacySettings()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #536471; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.03)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg id="privacy-icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <g>\n <path id="privacy-icon-path"\n d="M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z">\n </path>\n </g>\n </svg>\n <span id="privacy-text" style="color: var(--x-accent); font-size: 13px; font-weight: 600;">所有人可以回复</span>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n </div>\n</div>\n\n<div id="character-relationship-graph-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); z-index: 25; overflow-y: auto; backdrop-filter: blur(8px);\n" onclick="closeCharacterRelationshipGraph(event)">\n <div style="background-color:#000; margin: 20px auto; border-radius: 16px; max-width: min(900px, calc(100vw - 20px)); width: calc(100% - 40px); max-height: calc(100vh - 40px); position: relative; overflow: hidden; border: 1px solid #333; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #333; background-color:#000; ">\n <div style="display: flex; align-items: center; gap: 12px;">\n <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">角色关系图编辑器</h2>\n <div style="color: #71767b; font-size: 13px; display: flex; align-items: center; gap: 8px;">\n <span id="graph-character-count">0 角色</span>\n <span>·</span>\n <span id="graph-link-count">0 关系</span>\n </div>\n </div>\n <div onclick="closeCharacterRelationshipGraph()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; border-bottom: 1px solid #333; background-color: #0a0a0a; ">\n <button onclick="addRelationshipLink()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>\n </svg>\n 添加关系\n </button>\n <button onclick="clearAllRelationships()" style="background-color: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 20px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; " onmouseover="this.style.backgroundColor=\'rgba(244,33,46,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2zM9 4h6v2H9zM8 8h9v12H7V8z"/>\n </svg>\n 清空所有\n </button>\n <div style="margin-left: auto; color: #71767b; font-size: 12px;">\n 点击角色头像连线，点击连线编辑关系\n </div>\n </div>\n\n <div style="height: min(500px, 60vh); background-color:#000; position: relative; overflow: hidden; ">\n <canvas id="relationship-graph-canvas" style="width: 100%; height: 100%; display: block; cursor: grab; "></canvas>\n\n <div id="graph-empty-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #71767b; pointer-events: none; ">\n <svg viewBox="0 0 24 24" style="width: 64px; height: 64px; fill: #2f3336; margin-bottom: 12px;">\n <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>\n </svg>\n <div style="font-size: 15px; margin-bottom: 4px;">暂无角色关系</div>\n <div style="font-size: 13px; opacity: 0.7;">请先绑定角色，然后点击"添加关系"</div>\n </div>\n </div>\n\n <div style="max-height: 200px; overflow-y: auto; background-color: #0a0a0a; border-top: 1px solid #333; ">\n <div style="padding: 12px 20px; border-bottom: 1px solid #333;">\n <div style="color: #fff; font-size: 15px; font-weight: 600;">关系列表</div>\n </div>\n <div id="relationship-links-list" style="padding: 12px 20px;">\n\n </div>\n </div>\n\n <div style="display: flex; gap: 12px; padding: 16px 20px; border-top: 1px solid #333; background-color:#000; ">\n <button onclick="closeCharacterRelationshipGraph()" style="flex: 1; background-color: transparent; color: #fff; border: 1px solid #536471; border-radius: 20px; padding: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n 取消\n </button>\n <button onclick="saveRelationshipGraph()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存关系图\n </button>\n </div>\n </div>\n</div>\n\n<div id="edit-relationship-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 30; backdrop-filter: blur(4px);\n" onclick="closeEditRelationshipDetail(event)">\n <div style="background-color:#000; margin: 60px auto; border-radius: 16px; max-width: min(500px, calc(100vw - 20px)); width: calc(100% - 40px); border: 1px solid #333; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #333; ">\n <h3 style="color: #fff; font-size: 18px; font-weight: 700; margin: 0;">编辑关系</h3>\n <div onclick="closeEditRelationshipDetail()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n <path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"/>\n </svg>\n </div>\n </div>\n\n <div style="padding: 20px;">\n\n <div id="relationship-characters-info" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-bottom: 20px; ">\n <div style="flex: 1; text-align: center;">\n <div id="char-a-name" style="color: #fff; font-size: 14px; font-weight: 600;"></div>\n </div>\n <div style="color: #71767b; font-size: 20px; margin: 0 12px;">⇆</div>\n <div style="flex: 1; text-align: center;">\n <div id="char-b-name" style="color: #fff; font-size: 14px; font-weight: 600;"></div>\n </div>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">\n <span id="char-a-to-b-label"></span>\n </label>\n <input type="text" id="relationship-a-to-b" placeholder="例如：好朋友、同事、哥哥等" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">\n <span id="char-b-to-a-label"></span>\n </label>\n <input type="text" id="relationship-b-to-a" placeholder="例如：好朋友、同事、妹妹等" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n </div>\n\n <div style="margin-bottom: 24px;">\n <label style="display: block; color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 8px;">\n 关系情节 (可选)\n </label>\n <textarea id="relationship-story" placeholder="补充背景故事、相识经历等..." style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 14px; outline: none; box-sizing: border-box; resize: vertical; font-family: inherit; line-height: 1.4; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n <div style="color: #71767b; font-size: 12px; margin-top: 4px;">\n 例如：如何相识、共同经历、特殊事件等\n </div>\n </div>\n\n <div style="display: flex; gap: 12px;">\n <button onclick="deleteRelationshipLink()" style="flex: 1; background-color: transparent; color: #f4212e; border: 1px solid #f4212e; border-radius: 20px; padding: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(244,33,46,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n 删除关系\n </button>\n <button onclick="saveRelationshipDetail()" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'"\n onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存\n </button>\n </div>\n </div>\n </div>\n</div>\n\n<div id="npc-edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(91, 112, 131, 0.4); z-index: 20; overflow-y: auto;\n" onclick="closeNPCEditModal(event)">\n <div style="background-color:#000; margin: 40px auto; border-radius: 16px; max-width: 600px; width: calc(100% - 40px); max-height: calc(100vh - 80px); position: relative; overflow: hidden; " onclick="event.stopPropagation()">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #2f3336; ">\n <div style="display: flex; align-items: center; gap: 24px;">\n <div onclick="closeNPCEditModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'"\n onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;" id="npc-modal-title">编辑NPC</h2>\n </div>\n </div>\n\n <div style="padding: 20px; overflow-y: auto; max-height: calc(100vh - 200px);">\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPC姓名</label>\n <input type="text" id="npc-name" placeholder="输入NPC姓名" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="50">\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPC句柄</label>\n <input type="text" id="npc-handle" placeholder="@句柄" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'" maxlength="30">\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPC头像URL</label>\n <input type="text" id="npc-avatar" placeholder="输入头像URL" style="width: 100%; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'">\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">NPC人设</label>\n <textarea id="npc-personality" placeholder="描述NPC的性格、背景、行为特征..." style="width: 100%; min-height: 120px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">发帖习惯</label>\n <textarea id="npc-posting-habits" placeholder="描述NPC的发帖风格、频率、内容偏好..." style="width: 100%; min-height: 100px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">主页内容设置</label>\n <textarea id="npc-homepage" placeholder="描述NPC主页的展示内容、简介等..." style="width: 100%; min-height: 80px; background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 12px; font-size: 15px; resize: vertical; outline: none; box-sizing: border-box; " onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'#333\'"></textarea>\n </div>\n\n <div style="margin-bottom: 20px;">\n <label style="display: block; color: #8b98a5; font-size: 13px; margin-bottom: 8px;">绑定用户（可多选）</label>\n <div id="npc-bind-users" style="background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; ">\n\n </div>\n </div>\n\n <button onclick="saveNPC()" style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 保存NPC\n </button>\n </div>\n </div>\n</div>\n\n<div id="x-askbox-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 15;">\n\n <div id="askbox-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url(\'https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg\'); background-size: cover; background-position: center; z-index: 0; "></div>\n\n <div style="position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">\n\n <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--base-top-padding) 16px 12px 16px;">\n\n <div onclick="switchXPage(\'profile\')" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.3)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.2)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>\n </svg>\n </div>\n\n <div onclick="openAskboxSettings()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.3)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.2)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>\n </svg>\n </div>\n </div>\n\n <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 16px;">\n\n <div onclick="changeAskboxAvatar()" style="cursor: pointer; margin-bottom: 12px; position: relative; transition: transform 0.2s;"\n onmouseover="this.style.transform=\'scale(1.05)\'"\n onmouseout="this.style.transform=\'scale(1)\'">\n <img id="askbox-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"\n style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">\n </div>\n\n <div style="display: flex; align-items: center; gap: 8px; background-color: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 20px;">\n <span id="askbox-nickname"\n contenteditable="true"\n style="color: #fff; font-size: 14px; font-weight: 500; outline: none; cursor: text; min-width: 20px;"\n onblur="saveAskboxNickname()"\n onkeydown="if(event.key===\'Enter\'){event.preventDefault();this.blur();}">= =</span>\n </div>\n </div>\n\n <div style="margin: 0 20px 24px 20px; background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; padding: 32px 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); transition: all 0.2s; min-height: 120px; display: flex; align-items: center; justify-content: center; ">\n <div id="askbox-prompt"\n contenteditable="true"\n style="color: #333; font-size: 16px; line-height: 1.6; text-align: center; word-break: break-word; outline: none; cursor: text; width: 100%; "\n onblur="saveAskboxPrompt()"\n onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();this.blur();}">请向我匿名提问!waiting...</div>\n </div>\n\n <div onclick="getNewQuestion()" style="margin: 0 20px 32px 20px; background-color: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-radius: 24px; padding: 14px 24px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.95)\'; this.style.transform=\'translateY(-1px)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.85)\'; this.style.transform=\'translateY(0)\'">\n <span style="color: #333; font-size: 15px; font-weight: 600;">获取新的提问</span>\n </div>\n\n <div style="padding: 0 20px 20px 20px;">\n <div id="answered-questions-title" style="color: rgba(255,255,255,0.8); font-size: 15px; font-weight: 500; margin-bottom: 16px; text-align: center; display: none; ">最新提问如下</div>\n <div id="answered-questions-list">\n\n </div>\n </div>\n </div>\n</div>\n\n\x3c!-- 直播页面 --\x3e\n<div id="x-live-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 21; background-color:#0f0f0f;">\n\n\x3c!-- 顶部导航栏 --\x3e\n<div style="display: flex; justify-content: space-between; align-items: center; padding: var(--app-header-total-padding) 16px 12px 16px; position: sticky; top: 0; background-color:#0f0f0f; z-index: 10;">\n  <div style="display: flex; align-items: center; gap: 16px;">\n    <div onclick="switchXPage(\'home\')" style="cursor: pointer;">\n      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n        <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>\n      </svg>\n    </div>\n    \n    <div style="color: #fff; font-size: 20px; font-weight: 700;" data-i18n="liveTitle">直播</div>\n  </div>\n  \n  <div style="display: flex; align-items: center; gap: 16px;">\n    <div style="cursor: pointer;">\n      <svg viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: #fff;">\n        <path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"></path>\n      </svg>\n    </div>\n    <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden;">\n      <img id="live-page-user-avatar" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" style="width: 100%; height: 100%; object-fit: cover;">\n    </div>\n  </div>\n</div>\n\n\x3c!-- 用户频道栏 --\x3e\n<div style="overflow-x: auto; padding: 8px 16px; display: flex; gap: 16px; background-color:#0f0f0f;">\n  <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 64px;">\n    <div style="width: 56px; height: 56px; border-radius: 50%; overflow: hidden; position: relative;">\n      <img src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg" style="width: 100%; height: 100%; object-fit: cover;">\n      <div style="position: absolute; top: 0; right: 0; width: 18px; height: 18px; background-color: var(--x-accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid #0f0f0f;">\n        <span style="color: white; font-size: 10px; font-weight: bold;">+</span>\n      </div>\n    </div>\n    <span style="color: #fff; font-size: 12px; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 60px;">直播达人</span>\n  </div>\n</div>\n\n\x3c!-- 分类标签栏 --\x3e\n<div style="overflow-x: auto; white-space: nowrap; padding: 4px 16px; background-color:#0f0f0f;">\n  <div id="live-categories-container" style="display: inline-flex; gap: 8px; padding-bottom: 4px;">\n    <div class="live-tab live-tab-active" onclick="switchLiveTab(\'audio\')" \n      style="padding: 8px 12px; background-color: rgba(255,255,255,0.1); border-radius: 16px; font-size: 14px; font-weight: 500; cursor: pointer; color: #fff;">\n      <span data-i18n="liveAudioTab">语音直播</span>\n    </div>\n    <div class="live-tab" onclick="switchLiveTab(\'video\')" \n      style="padding: 8px 12px; background-color: rgba(255,255,255,0.1); border-radius: 16px; font-size: 14px; font-weight: 500; cursor: pointer; color: #71767b;">\n      <span data-i18n="liveVideoTab">视频直播</span>\n    </div>\n    \x3c!-- 自定义分类将动态插入到这里 --\x3e\n    <div class="live-add-category-btn" onclick="openLiveCategoryModal()" \n      style="padding: 8px 10px; background-color: rgba(255,255,255,0.1); border-radius: 16px; font-size: 14px; font-weight: 500; cursor: pointer; color: #71767b; display: flex; align-items: center; min-width: 36px; justify-content: center;"\n      onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.2)\'"\n      onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'">\n      <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n        <path d="M19.5 12.75h-6.75V19.5h-1.5v-6.75H4.5v-1.5h6.75V4.5h1.5v6.75h6.75v1.5z"></path>\n      </svg>\n    </div>\n  </div>\n</div>\n\n\x3c!-- 直播列表内容区域 --\x3e\n<div style="flex: 1; overflow-y: auto; padding: 0; background-color:#0f0f0f; position: relative;">\n  \x3c!-- 语音直播内容 --\x3e\n  <div id="live-audio-content" class="live-tab-content" style="display: block; padding: 16px 16px 80px 16px;">\n    <div id="live-audio-list" style="display: flex; flex-direction: column; gap: 16px;">\n      \x3c!-- 动态生成的语音直播卡片将插入到这里 --\x3e\n    </div>\n  </div>\n  \n  \x3c!-- 视频直播内容 --\x3e\n  <div id="live-video-content" class="live-tab-content" style="display: none; padding: 16px 16px 80px 16px;">\n    <div id="live-video-list" style="display: flex; flex-direction: column; gap: 16px;">\n      \x3c!-- 动态生成的视频直播卡片将插入到这里 --\x3e\n    </div>\n  </div>\n  \n  \x3c!-- 直播收纳按钮区域 --\x3e\n  <div id="live-action-container" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 15; display: flex; align-items: center; justify-content: center; pointer-events: none;">\n        \x3c!-- 刷新直播按钮 (左侧) --\x3e\n    <div id="live-refresh-btn" class="live-action-btn" onclick="refreshLiveStreams()" \n      style="position: absolute; right: 80px; top: 4px; width: 48px; height: 48px; border-radius: 50%; background-color: var(--x-accent); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: scale(0); opacity: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto;"\n      onmouseover="handleLiveSubBtnMouseOver(this)"\n      onmouseout="handleLiveSubBtnMouseOut(this)"\n      ontouchstart="handleLiveSubBtnTouchStart(this)"\n      ontouchend="handleLiveSubBtnTouchEnd(this)">\n      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: none; stroke: #fff; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;">\n        <path d="M10.09 4.01l.496 -.495a2 2 0 0 1 2.828 0l7.071 7.07a2 2 0 0 1 0 2.83l-7.07 7.07a2 2 0 0 1 -2.83 0l-7.07 -7.07a2 2 0 0 1 0 -2.83l3.535 -3.535h-3.988" />\n        <path d="M7.05 11.038v-3.988" />\n      </svg>\n    </div>\n    \n    \x3c!-- 主收纳按钮 (中央) --\x3e\n    <div id="live-main-btn" class="live-action-btn" onclick="toggleLiveActionButtons()" \n      style="width: 56px; height: 56px; border-radius: 50%; background-color: var(--x-accent); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 0 6px 20px rgba(0,0,0,0.4); position: relative; z-index: 16; pointer-events: auto;"\n      onmouseover="handleLiveMainBtnMouseOver()"\n      onmouseout="handleLiveMainBtnMouseOut()"\n      ontouchstart="handleLiveMainBtnTouchStart()"\n      ontouchend="handleLiveMainBtnTouchEnd()">\n      <svg id="live-main-icon" viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: none; stroke: #fff; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; transition: transform 0.3s ease;">\n        <path d="M17.891 10.132a1.2 1.2 0 0 0 -.309 -2.228l-13.582 -3.904l3.904 13.563a1.2 1.2 0 0 0 2.228 .308" />\n        <path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z" />\n      </svg>\n    </div>\n    \n    \x3c!-- 开启直播按钮 (右侧) --\x3e\n    <div id="live-start-btn" class="live-action-btn" onclick="startLiveStream()" \n      style="position: absolute; left: 80px; top: 4px; width: 48px; height: 48px; border-radius: 50%; background-color: var(--x-accent); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: scale(0); opacity: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: auto;"\n      onmouseover="handleLiveSubBtnMouseOver(this)"\n      onmouseout="handleLiveSubBtnMouseOut(this)"\n      ontouchstart="handleLiveSubBtnTouchStart(this)"\n      ontouchend="handleLiveSubBtnTouchEnd(this)">\n      <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: none; stroke: #fff; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round;">\n        <path d="M7 4v16l13 -8z" />\n      </svg>\n    </div>\n  </div>\n</div>\n\n</div>\n\n\x3c!-- 直播分类管理模态框 --\x3e\n<div id="live-category-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 30; overflow-y: auto; backdrop-filter: blur(8px);" onclick="closeLiveCategoryModal(event)">\n  <div style="background-color:#0f0f0f; margin: 40px auto; border-radius: 16px; max-width: 600px; width: calc(100% - 40px); border: 1px solid #333;" onclick="event.stopPropagation()">\n    \n    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #333;">\n      <h2 style="color: #fff; font-size: 20px; font-weight: 700; margin: 0;">管理直播分类</h2>\n      <div onclick="closeLiveCategoryModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" \n        onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.1)\'"\n        onmouseout="this.style.backgroundColor=\'transparent\'">\n        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n          <path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path>\n        </svg>\n      </div>\n    </div>\n    \n    <div style="padding: 20px; max-height: calc(100vh - 200px); overflow-y: auto;">\n      \n      <div style="background-color: rgba(29,155,240,0.1); border: 1px solid var(--x-accent); border-radius: 8px; padding: 12px; margin-bottom: 20px;">\n        <p style="color: var(--x-accent); font-size: 13px; line-height: 1.4; margin: 0;">\n          💡 自定义直播分类将显示在标签栏中。可以添加任意分类（如"游戏"、"音乐"、"教育"等），并描述该分类下的内容类型。\n        </p>\n      </div>\n      \n      <div style="margin-bottom: 20px;">\n        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">\n          <h3 style="color: #fff; font-size: 16px; font-weight: 600; margin: 0;">自定义分类</h3>\n          <button onclick="addNewLiveCategory()" \n            style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" \n            onmouseover="this.style.opacity=\'0.9\'"\n            onmouseout="this.style.opacity=\'1\'">\n            + 添加分类\n          </button>\n        </div>\n        \n        <div id="live-custom-categories-list" style="display: flex; flex-direction: column; gap: 12px;">\n          \x3c!-- 动态生成的分类列表 --\x3e\n        </div>\n      </div>\n      \n      <button onclick="saveLiveCustomCategories()" \n        style="width: 100%; background-color: var(--x-accent); color: #fff; border: none; border-radius: 25px; padding: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;" \n        onmouseover="this.style.opacity=\'0.9\'"\n        onmouseout="this.style.opacity=\'1\'">\n        保存设置\n      </button>\n    </div>\n  </div>\n</div>\n\n<div id="x-article-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 21; background-color:var(--x-bg-primary);">\n <style>\n @import url("https://fontsapi.zeoseven.com/256/main/result.css"); @import url("data:text/css,%40font-face%7Bfont-family%3A%22ZSFT-685%22%3Bsrc%3Aurl(%22https%3A%2F%2Ffontsapi.zeoseven.com%2F685%2Fmain.woff2%22)%20format(%22woff2%22)%2Curl(%22https%3A%2F%2Ffontsapi-storage.zeoseven.com%2F685%2Fmain.woff2%22)%20format(%22woff2%22)%3Bfont-style%3Anormal%3Bfont-weight%3A400%3Bfont-display%3Aswap%3B%7D"); .article-title {\n font-family: "Huiwen-mincho", serif; }\n .article-title-en {\n font-family: "ZSFT-685", serif; }\n .article-content {\n line-height: 1.8; word-break: break-word; }\n .article-content strong {\n font-weight: 600; color: var(--x-accent); word-break: break-word; }\n .article-content em {\n font-style: italic; border-bottom: 2px solid var(--x-accent); padding-bottom: 2px; word-break: break-word; }\n @media (max-width: 600px) {\n .article-title {\n font-size: 22px !important; }\n .article-content {\n font-size: 14px !important; }\n }\n </style>\n\n <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">\n\n <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--app-header-total-padding) 16px 12px 16px; position: sticky; top: 0; background-color:var(--x-bg-primary); z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">\n\n <div onclick="closeArticlePage()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color:var(--x-bg-secondary); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>\n </svg>\n </div>\n\n <div onclick="shareArticle()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color:var(--x-bg-secondary); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\n onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M17.53 7.47l-5-5c-.293-.293-.768-.293-1.06 0l-5 5c-.294.293-.294.768 0 1.06s.767.294 1.06 0l3.72-3.72V15c0 .414.336.75.75.75s.75-.336.75-.75V4.81l3.72 3.72c.146.147.338.22.53.22s.384-.072.53-.22c.293-.293.293-.767 0-1.06z"></path><path d="M19.708 21.944H4.292C3.028 21.944 2 20.916 2 19.652V14c0-.414.336-.75.75-.75s.75.336.75.75v5.652c0 .437.355.792.792.792h15.416c.437 0 .792-.355.792-.792V14c0-.414.336-.75.75-.75s.75.336.75.75v5.652c0 1.264-1.028 2.292-2.292 2.292z"></path></g>\n </svg>\n </div>\n </div>\n\n <div id="article-cover" style="width: 100%; height: 35vh; min-height: 250px; max-height: 400px; background-size: cover; background-position: center; background-repeat: no-repeat; margin-bottom: 20px; "></div>\n\n <div style="padding: 0 16px 40px 16px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box;">\n\n <h1 id="article-title" class="article-title" style="font-size: 24px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 16px; line-height: 1.3; word-wrap: break-word; "></h1>\n\n <div style="display: flex; align-items: center; gap: 8px; padding-bottom: 12px; margin-bottom: 20px; border-bottom: 1px solid var(--x-border-color); flex-wrap: wrap; ">\n <span id="article-author" style="color:var(--x-text-secondary); font-size: 13px; "></span>\n <span style="color:var(--x-text-secondary);">·</span>\n <span id="article-source" style="color:var(--x-text-secondary); font-size: 13px; word-break: break-all; "></span>\n </div>\n\n <div id="article-body" class="article-content" style="color:var(--x-text-primary); font-size: 15px; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; "></div>\n </div>\n </div>\n</div>\n\n<div id="account-profile-page" class="x-page" style="display: none; flex-direction: column; height: 100%; overflow: hidden;">\n\n <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid var(--x-border-color); background-color:var(--x-bg-primary); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 10;">\n <div style="display: flex; align-items: center;">\n <div onclick="closeAccountProfile()" style="cursor: pointer; padding: 8px; margin-right: 30px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"></path></g>\n </svg>\n </div>\n <div>\n <div id="account-profile-nav-name" style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; line-height: 1.2;"></div>\n <div id="account-profile-nav-count" style="color:var(--x-text-secondary); font-size: 13px; margin-top: 2px;">0 个帖子</div>\n </div>\n </div>\n\n <div style="display: flex; align-items: center; gap: 8px;">\n\n <div onclick="openAccountAskbox()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'" onmouseout="this.style.backgroundColor=\'transparent\'" title="提问箱">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>\n </svg>\n </div>\n\n <div onclick="refreshAccountProfile()" onmousedown="handleRefreshButtonMouseDown()" onmouseup="handleRefreshButtonMouseUp()" ontouchstart="handleRefreshButtonMouseDown()" ontouchend="handleRefreshButtonMouseUp()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'" onmouseout="this.style.backgroundColor=\'transparent\'" title="刷新账户主页">\n <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--x-text-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n <path d="M9 4.55a8 8 0 0 1 6 14.9m0 -4.45v5h5" />\n <path d="M5.63 7.16l0 .01" />\n <path d="M4.06 11l0 .01" />\n <path d="M4.63 15.1l0 .01" />\n <path d="M7.16 18.37l0 .01" />\n <path d="M11 19.94l0 .01" />\n </svg>\n </div>\n </div>\n </div>\n\n <div style="flex: 1; overflow-y: auto;">\n\n <div id="account-cover-image" style="width: 100%; height: 140px; background-color:var(--x-bg-secondary); background-size: cover; background-position: center; position: relative;"></div>\n\n <div style="padding: 8px 16px 0 16px;">\n\n <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 12px;">\n\n <img id="account-avatar-image" src="" alt="账户头像" style="width: 68px; height: 68px; border-radius: 50%; border: 4px solid var(--x-bg-primary); background-color:var(--x-bg-primary); position: absolute; top: -34px; left: 0; object-fit: cover; overflow: hidden; box-sizing: border-box;">\n\n <div style="display: flex; gap: 8px; margin-left: auto; margin-top: 8px;">\n\n <button onclick="sendMessageToAccount()" style="width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--x-border-color); background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);">\n <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>\n </svg>\n </button>\n\n <button id="account-notify-btn" onclick="toggleAccountNotifications()" style="width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--x-border-color); background: transparent; display: none; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(239,243,244,0.1)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);">\n <g><path d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z"></path></g>\n </svg>\n </button>\n\n <button id="account-follow-btn" onclick="toggleAccountFollow()" style="min-width: 110px; height: 36px; border-radius: 18px; border: none; background: var(--x-text-primary); color: var(--x-bg-primary); font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; padding: 0 16px; " onmouseover="if(this.textContent.includes(\'关注\')||this.textContent.includes(\'Follow\')){this.style.opacity=\'0.9\';}" onmouseout="this.style.opacity=\'1\';">\n 关注\n </button>\n </div>\n </div>\n\n <div style="margin-bottom: 4px; margin-top: 8px; padding-left: 8px;">\n <div style="display: flex; align-items: center; gap: 4px;">\n <span id="account-display-name" style="color:var(--x-text-primary); font-size: 20px; font-weight: 800; line-height: 1.2;"></span>\n <div id="account-verified-badge" style="display: none;"></div>\n </div>\n </div>\n\n <div style="margin-bottom: 8px; padding-left: 8px;">\n <span id="account-handle-text" style="color:var(--x-text-secondary); font-size: 15px;"></span>\n </div>\n\n <div id="account-bio-text" style="color:var(--x-text-primary); font-size: 15px; line-height: 20px; margin-bottom: 8px; padding-left: 8px; display: none;"></div>\n\n <div id="account-tags-container" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; padding-left: 8px;"></div>\n\n <div style="display: flex; gap: 20px; margin-bottom: 16px; padding-left: 8px;">\n <div style="cursor: pointer;" onmouseover="this.querySelector(\'span\').style.textDecoration=\'underline\'" onmouseout="this.querySelector(\'span\').style.textDecoration=\'none\'">\n <span id="account-following-count" style="color:var(--x-text-primary); font-weight: 700; font-size: 14px;">0</span>\n <span style="color:var(--x-text-secondary); margin-left: 4px; font-size: 14px;" data-i18n="accountFollowingLabel">正在关注</span>\n </div>\n <div style="cursor: pointer;" onmouseover="this.querySelector(\'span\').style.textDecoration=\'underline\'" onmouseout="this.querySelector(\'span\').style.textDecoration=\'none\'">\n <span id="account-followers-count" style="color:var(--x-text-primary); font-weight: 700; font-size: 14px;">0</span>\n <span style="color:var(--x-text-secondary); margin-left: 4px; font-size: 14px;" data-i18n="accountFollowersLabel">关注者</span>\n </div>\n </div>\n\n <div id="account-follows-you" style="display: none; color:var(--x-text-secondary); font-size: 13px; margin-bottom: 16px; padding-left: 8px;" data-i18n="accountFollowsYou">\n 关注你\n </div>\n </div>\n\n <div style="display: flex; border-bottom: 1px solid var(--x-border-color);">\n <div class="account-tab active" onclick="switchAccountTab(\'posts\')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 700; color:var(--x-text-primary); cursor: pointer; position: relative; border-bottom: 4px solid var(--x-accent);">\n <span data-i18n="accountPostsTab">帖子</span>\n </div>\n <div class="account-tab" onclick="switchAccountTab(\'replies\')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 500; color:var(--x-text-secondary); cursor: pointer; position: relative; border-bottom: 4px solid transparent;">\n <span data-i18n="accountRepliesTab">回复</span>\n </div>\n <div class="account-tab" onclick="switchAccountTab(\'likes\')" style="flex: 1; text-align: center; padding: 16px 0; font-size: 15px; font-weight: 500; color:var(--x-text-secondary); cursor: pointer; position: relative; border-bottom: 4px solid transparent;">\n <span data-i18n="accountLikesTab">喜欢</span>\n </div>\n </div>\n\n <div id="account-tweets-container">\n\n </div>\n </div>\n</div>\n\n<div id="account-askbox-page" class="x-page" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; overflow: hidden; z-index: 15;">\n\n <div id="account-askbox-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url(\'https://i.postimg.cc/tJvBC00j/mmexport1759642131681.jpg\'); background-size: cover; background-position: center; z-index: 0; "></div>\n\n <div style="position: relative; z-index: 1; width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto;">\n\n <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--base-top-padding) 16px 12px 16px;">\n\n <div onclick="closeAccountAskbox()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.3)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.2)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <path d="M7.414 13l5.043 5.04-1.414 1.42L3.586 12l7.457-7.46 1.414 1.42L7.414 11H21v2H7.414z"/>\n </svg>\n </div>\n\n <div onclick="openAccountAskboxSettings()" style="cursor: pointer; padding: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); transition: all 0.2s;"\n onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.3)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.2)\'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;">\n <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22l-1.92 3.32c-.12.22.07.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>\n </svg>\n </div>\n </div>\n\n <div style="display: flex; flex-direction: column; align-items: center; padding: 20px 16px;">\n\n <div onclick="changeAccountAskboxAvatar()" style="cursor: pointer; margin-bottom: 12px; position: relative; transition: transform 0.2s;"\n onmouseover="this.style.transform=\'scale(1.05)\'"\n onmouseout="this.style.transform=\'scale(1)\'">\n <img id="account-askbox-avatar" src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"\n style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">\n </div>\n\n <div style="display: flex; align-items: center; gap: 8px; background-color: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 20px;">\n <span id="account-askbox-nickname"\n contenteditable="true"\n style="color: #fff; font-size: 14px; font-weight: 500; outline: none; cursor: text; min-width: 20px;"\n onblur="saveAccountAskboxNickname()"\n onkeydown="if(event.key===\'Enter\'){event.preventDefault();this.blur();}">⩌⌯⩌</span>\n </div>\n </div>\n\n <div style="margin: 0 20px 24px 20px; background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; padding: 32px 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); transition: all 0.2s; min-height: 120px; display: flex; align-items: center; justify-content: center; ">\n <div id="account-askbox-prompt"\n contenteditable="true"\n style="color: #333; font-size: 16px; line-height: 1.6; text-align: center; word-break: break-word; outline: none; cursor: text; width: 100%; "\n onblur="saveAccountAskboxPrompt()"\n onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();this.blur();}">在这里输入你的匿名提问，或点击下方按钮生成随机提问...</div>\n </div>\n\n <div onclick="getNewAccountQuestion()" style="margin: 0 20px 32px 20px; background-color: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-radius: 24px; padding: 14px 24px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.95)\'; this.style.transform=\'translateY(-1px)\'"\n onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.85)\'; this.style.transform=\'translateY(0)\'">\n <span style="color: #333; font-size: 15px; font-weight: 600;">获取回答 / 生成随机提问</span>\n </div>\n\n <div style="padding: 0 20px 20px 20px;">\n <div id="account-answered-questions-title" style="color: rgba(255,255,255,0.8); font-size: 15px; font-weight: 500; margin-bottom: 16px; text-align: center; display: none; ">最新提问如下</div>\n <div id="account-answered-questions-list">\n\n </div>\n </div>\n </div>\n</div>\n</div>\n\n<div id="sticker-picker-modal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 40; " onclick="closeStickerPicker()">\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; max-width: 500px; width: 95%; max-height: 75vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.4); " onclick="event.stopPropagation()">\n\n<div style="padding: 16px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; ">\n<div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">选择表情包</div>\n<div onclick="closeStickerPicker()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'transparent\'">\n<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n<g><path d="M10.59 12L4.54 5.96l1.06-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n</svg>\n</div>\n</div>\n\n<div style="padding: 12px 16px 0 16px; display: flex; gap: 8px; border-bottom: 1px solid var(--x-border-color); ">\n<div id="sticker-tab-frequent" onclick="switchStickerTab(\'frequent\')" style="padding: 8px 16px; cursor: pointer; border-bottom: 2px solid var(--x-accent); color:var(--x-text-primary); font-size: 14px; font-weight: 600; transition: all 0.2s; ">常用</div>\n<div id="sticker-tab-all" onclick="switchStickerTab(\'all\')" style="padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; color:var(--x-text-secondary); font-size: 14px; font-weight: 600; transition: all 0.2s; ">全部</div>\n</div>\n\n<div id="sticker-list" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; align-content: start; align-items: start; ">\n\n</div>\n\n<div style="padding: 16px; border-top: 1px solid var(--x-border-color); display: flex; justify-content: space-between; gap: 8px; ">\n<button onclick="openAddStickerDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; flex: 1; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n+ 导入表情包\n</button>\n<button onclick="openStickerManager()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'"\nonmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n管理\n</button>\n</div>\n</div>\n</div>\n\n<div class="x-bottom-nav"\nstyle="display: flex; justify-content: space-around; padding: 12px 0 20px 0; border-top: 1px solid #333; background-color:#000;">\n\n<div class="x-nav-item active" onclick="switchXPage(\'home\')"\nstyle="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">\n<svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: var(--x-accent);">\n<g>\n<path\nd="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z">\n</path>\n</g>\n</svg>\n\n<div id="home-notification-dot" style="position: absolute; top: 2px; right: 8px; width: 8px; height: 8px; background-color: var(--x-accent); border-radius: 50%; border: 2px solid var(--x-bg-primary); display: none; "></div>\n\n<div class="nav-highlight"\nstyle="position: absolute; width: 5px; height: 5px; background-color: var(--x-accent); border-radius: 50%; bottom: -8px;">\n</div>\n</div>\n\n <div class="x-nav-item" onclick="switchXPage(\'search\')"\n style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">\n <g>\n <path\n d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z">\n </path>\n </g>\n </svg>\n <div class="nav-highlight"\n style="position: absolute; width: 5px; height: 5px; background-color: var(--x-accent); border-radius: 50%; bottom: -8px; display: none;">\n </div>\n </div>\n\n <div class="x-nav-item" onclick="switchXPage(\'notifications\')"\n style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">\n <g>\n <path\n d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z">\n </path>\n </g>\n </svg>\n\n <div id="notifications-notification-dot" style="position: absolute; top: 2px; right: 8px; width: 8px; height: 8px; background-color: var(--x-accent); border-radius: 50%; border: 2px solid var(--x-bg-primary); display: none; "></div>\n <div class="nav-highlight"\n style="position: absolute; width: 5px; height: 5px; background-color: var(--x-accent); border-radius: 50%; bottom: -8px; display: none;">\n </div>\n </div>\n\n <div class="x-nav-item" onclick="switchXPage(\'messages\')"\n style="display: flex; justify-content: center; align-items: center; position: relative; padding: 5px 15px; cursor: pointer;">\n <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 26px; height: 26px; fill: #fff;">\n <g>\n <path\n d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z">\n </path>\n </g>\n </svg>\n\n <div id="messages-notification-dot" style="position: absolute; top: 2px; right: 8px; width: 8px; height: 8px; background-color: var(--x-accent); border-radius: 50%; border: 2px solid var(--x-bg-primary); display: none; "></div>\n <div class="nav-highlight"\n style="position: absolute; width: 5px; height: 5px; background-color: var(--x-accent); border-radius: 50%; bottom: -8px; display: none;">\n </div>\n </div>\n</div>\n',document.body.appendChild(n),console.log("✅ X Social App: HTML结构已创建")}(),await $t(),console.log("📌 当前活跃账户:",vt,"(window.currentAccountId:",n.currentAccountId+")"),await async function(){try{const t=e(),o=vt||"main",a=await t.xUserProfile.get(o);if(a)Object.assign(n.userProfileData,a);else{const e=qs(o);Object.assign(n.userProfileData,e),await t.xUserProfile.put(n.userProfileData),console.log("📝 已创建默认用户资料:",o)}Vs(n.userProfileData),console.log("✅ 用户资料已加载:",n.userProfileData.name,"(账户:",o+")"),console.log("🔍 用户资料详情:",{"认证类型":n.userProfileData.verificationType,"情侣角色":n.userProfileData.coupleCharacterName,"已知身份角色数":n.userProfileData.knownIdentityCharacters?.length||0})}catch(e){console.error("❌ 加载用户资料失败:",e);const t=qs("main");Object.assign(n.userProfileData,t)}}(),await oe();try{const n=e(),t=`worldEvents_${vt||"main"}`,o=await n.xWorldEvents.get(t);o&&o.enabled&&(o.enabled=!1,await n.xWorldEvents.put(o),console.log("🔴 [世界大事件] 已强制重置为关闭状态（仅允许用户手动开启）"));const a=`xSettings_${vt||"main"}`;let i=await n.xSettings.get(a);i&&i.worldEventsEnabled&&(i.worldEventsEnabled=!1,await n.xSettings.put(i),console.log("🔴 [设置] 已强制重置世界大事件开关为关闭"))}catch(n){console.error("强制重置世界大事件状态失败:",n)}await async function(){try{const n=e(),t=await n.xTweetsData.get("tweets");t&&t.forYouTweets&&t.followingTweets&&(P.length=0,D.length=0,P.push(...t.forYouTweets),D.push(...t.followingTweets),console.log("已加载保存的推文数据，最后更新时间:",t.lastUpdated))}catch(n){console.error("加载推文数据失败，使用默认数据:",n)}q(P,"for-you-content"),q(D,"following-content")}(),function(){const n=document.getElementById("character-x-profile-form");n&&(n.addEventListener("submit",be),console.log("✅ 已绑定角色X资料表单提交事件"));const e=document.getElementById("character-x-bio");e&&e.addEventListener("input",he);const t=document.getElementById("relationship-form");t&&(t.addEventListener("submit",Ie),console.log("✅ 已绑定关系表单提交事件"));const o=document.getElementById("relationship-description");o&&o.addEventListener("input",$e);const a=document.getElementById("character-real-name");a&&a.addEventListener("input",fe);console.log("✅ 所有事件处理器已绑定")}(),dt(),await async function(){try{const n=e(),t=`xTheme_${vt||"main"}`,o=await n.xSettings.get(t);if(o&&o.theme){const n=document.getElementById("x-social-screen");if(!n)return;if("light"===o.theme){n.classList.add("x-theme-light");const e=document.getElementById("theme-icon-dark"),t=document.getElementById("theme-icon-light");e&&t&&(e.style.display="none",t.style.display="block"),_n()}console.log("🎨 已加载主题偏好: "+("light"===o.theme?"日间模式":"夜间模式"))}}catch(n){console.error("加载主题偏好失败:",n)}}(),await qn(),setTimeout(()=>{Jc()},12e4),setTimeout(()=>{xt()},12e4),await async function(){try{const n="v2.7";if(localStorage.getItem("x-app-welcome-popup-version")===n)return void console.log("🎉 当前版本弹窗已显示过，跳过");console.log("🎉 显示欢迎弹窗 (版本:",n+")");const e=document.createElement("style");e.id="pixel-font-style",e.textContent='\n @import url("https://fontsapi.zeoseven.com/569/main/result.css");\n\n .pixel-font {\n font-family: "Fusion Pixel 10px P zh_hans", monospace;\n font-weight: normal;\n }\n ',document.head.appendChild(e);const t=document.createElement("div");t.id="welcome-popup",t.style.cssText='\n position: fixed;\n top: 0;\n left: 0;\n width: 100vw;\n height: 100vh;\n background: rgba(0, 0, 0, 0.5);\n display: flex;\n align-items: center;\n justify-content: center;\n z-index: 99999;\n font-family: "Fusion Pixel 10px P zh_hans", monospace;\n ',t.innerHTML='\n <div style="\n background: #c0c0c0;\n border: 3px outset #c0c0c0;\n border-image: none;\n width: 400px;\n max-width: 90%;\n box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n ">\n \x3c!-- 标题栏 --\x3e\n <div style="\n background: linear-gradient(90deg, #0000ff 0%, #000080 100%);\n color: white;\n padding: 2px 4px;\n font-size: 11px;\n display: flex;\n align-items: center;\n justify-content: space-between;\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n ">\n <span style="font-weight: bold;">吃点羊提醒您</span>\n <button id="welcome-popup-close" style="\n background: #c0c0c0;\n border: 1px outset #c0c0c0;\n color: black;\n font-size: 10px;\n width: 16px;\n height: 14px;\n padding: 0;\n cursor: pointer;\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n font-weight: bold;\n ">×</button>\n </div>\n\n \x3c!-- 内容区域 --\x3e\n <div style="\n padding: 16px;\n background: #c0c0c0;\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n ">\n <div style="\n display: flex;\n align-items: flex-start;\n gap: 12px;\n margin-bottom: 12px;\n ">\n \x3c!-- 图标 --\x3e\n <div style="\n width: 32px;\n height: 32px;\n background: #ffff00;\n border: 2px inset #c0c0c0;\n display: flex;\n align-items: center;\n justify-content: center;\n font-size: 16px;\n flex-shrink: 0;\n ">💡</div>\n\n \x3c!-- 消息内容 --\x3e\n <div style="\n flex: 1;\n font-size: 11px;\n line-height: 1.4;\n color: #000;\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n ">\n <div style="font-weight: bold; margin-bottom: 6px;">吃点羊提醒您：</div>\n            <div style="font-weight: bold; margin-bottom: 8px;">地图更新+道具更新</div>\n            <div style="margin-bottom: 4px;">+城市日报和地标事件+道具系统的一部分简陋内容</div>\n            <div style="margin-bottom: 4px;">+乘车功能未完善请不要使用！！</div>\n            <div>+一些小彩蛋</div>\n </div>\n </div>\n\n \x3c!-- 按钮区域 --\x3e\n <div style="\n display: flex;\n justify-content: center;\n gap: 8px;\n margin-top: 16px;\n ">\n <button id="welcome-popup-ok" style="\n background: #c0c0c0;\n border: 2px outset #c0c0c0;\n color: black;\n font-size: 11px;\n padding: 4px 16px;\n cursor: pointer;\n font-family: \'Fusion Pixel 10px P zh_hans\', monospace;\n min-width: 60px;\n ">确定</button>\n </div>\n </div>\n </div>\n ';const o=document.getElementById("x-social-screen");o?o.appendChild(t):document.body.appendChild(t);const a=document.getElementById("welcome-popup-close"),i=document.getElementById("welcome-popup-ok"),r=()=>{t.remove(),localStorage.setItem("x-app-welcome-popup-version",n),console.log("✅ 欢迎弹窗已关闭，当前版本:",n)};a.onclick=r,i.onclick=r,t.onclick=n=>{n.target===t&&r()},[a,i].forEach(n=>{n.onmouseenter=()=>{n.style.border="2px inset #c0c0c0"},n.onmouseleave=()=>{n.style.border=n===a?"1px outset #c0c0c0":"2px outset #c0c0c0"},n.onmousedown=()=>{n.style.border="2px inset #c0c0c0"},n.onmouseup=()=>{n.style.border=n===a?"1px outset #c0c0c0":"2px outset #c0c0c0"}})}catch(n){console.error("❌ 显示欢迎弹窗失败:",n)}}(),console.log("✅ X Social App 初始化完成"),console.log("💡 [提示] 智能刷新和智能检测需要手动开启")}catch(n){console.error("❌ X Social App 初始化失败:",n),mn("应用初始化失败: "+n.message,"error")}}function Xs(){console.log("🎬 渲染X社交页面");const n=document.getElementById("x-social-screen");n?(console.log("✅ X社交页面已存在，直接显示"),n.style.display="flex",u("home")):(console.log("⚠️ X社交页面未创建，开始初始化..."),Fs().then(()=>{console.log("✅ 初始化完成，显示主页");const n=document.getElementById("x-social-screen");n&&(n.style.display="flex",u("home"))}))}function qs(n="main"){return{id:n,name:"main"===n?"我":"新用户",handle:"main"===n?"@me":"@newuser_"+Date.now().toString().slice(-6),avatar:"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",coverImage:"https://i.postimg.cc/qRzMB6nQ/default-cover.jpg",verified:!1,verificationType:"none",bio:"欢迎来到我的X主页！",publicIdentity:"",showRealName:!1,realName:"",customTag1:"科技爱好者",customTag1Icon:"✨",customTag1Color:"#71767b",customTag2:"2024年加入",customTag2Icon:"📅",customTag2Color:"#71767b",followingCount:"main"===n?"156":"0",followersCount:"main"===n?"89":"0",knownIdentityCharacters:[],coupleCharacterId:"",coupleCharacterName:"",lastUpdated:(new Date).toISOString()}}function Vs(n){n.knownIdentityCharacters||(n.knownIdentityCharacters=[]),n.verificationType||(n.verificationType="none"),n.coupleCharacterId||(n.coupleCharacterId=""),n.coupleCharacterName||(n.coupleCharacterName=""),void 0===n.publicIdentity&&(n.publicIdentity=""),void 0===n.showRealName&&(n.showRealName=!1),void 0===n.realName&&(n.realName=""),n.customTag1Color||(n.customTag1Color="#71767b"),n.customTag2Color||(n.customTag2Color="#71767b")}n.openShopItemModal=function(n){const e=Us[n];if(!e)return void console.warn("⚠️ 商品不存在:",n);const t=document.getElementById("shopItemModal");if(!t)return;const o=document.getElementById("shopModalMainImage"),a=document.getElementById("shopModalTitle"),i=document.getElementById("shopModalSeller"),r=document.getElementById("shopModalPrice"),s=document.getElementById("shopModalStatus"),l=document.getElementById("shopModalDescription"),c=document.getElementById("shopImageIndex"),d=document.getElementById("shopImageTotal");a&&(a.textContent=e.title),i&&(i.textContent=e.seller),r&&(r.textContent=e.price),s&&(s.textContent=e.status),l&&(l.textContent=e.description),o&&(o.src=e.image),c&&(c.textContent="1"),d&&(d.textContent="1");const p=document.querySelector("#shopItemModal .shop-seller-stats");if(p&&e.sellerRating&&e.sellerSales){const n=p.querySelectorAll("span");n.length>=2&&(n[0].textContent=`Rating: ${e.sellerRating}/5.0`,n[1].textContent=`Sales: ${e.sellerSales}`)}if(e.specs){const n=document.querySelectorAll("#shopItemModal .shop-spec-value");n.length>=4&&(n[0].textContent=e.specs.condition||"Like New",n[1].textContent=e.specs.location||"New York, US",n[2].textContent=e.specs.shipping||"Free Shipping",n[3].textContent=e.specs.posted||"2 days ago")}t.setAttribute("data-current-index",n),t.classList.add("active"),document.body.style.overflow="hidden",console.log("✅ 打开商品详情:",e.title)},n.closeShopItemModal=function(){const n=document.getElementById("shopItemModal");n&&(n.classList.remove("active"),document.body.style.overflow="",console.log("✅ 关闭商品详情"))},n.openShopMarketplace=async function(){const e=document.getElementById("tool-modal"),t=document.getElementById("tool-modal-overlay");if(Ns=e&&(e.classList.contains("active")||"flex"===e.style.display||"block"===e.style.display)||t&&(t.classList.contains("active")||t.classList.contains("active")||"flex"===t.style.display||"block"===t.style.display),Rs)return"function"==typeof n.showXToast?n.showXToast("🛍️ 商店正在上架商品中，请稍候...","info"):alert("商店正在上架商品中，请稍候..."),void console.log("⚠️ 商品生成中，请稍候");if(!Hs){const e=await Os();if(!e||0===e.length)return console.log("⚠️ 没有商品数据，触发第十八情景生成..."),"function"==typeof n.showXToast?n.showXToast("🛍️ 商品正在上架中，请稍候...","info"):alert("商品正在上架中，请稍候..."),"function"==typeof n.generateShopProducts&&n.generateShopProducts().catch(e=>{console.error("❌ [第十八情景] 商品生成失败:",e),"function"==typeof n.showXToast&&n.showXToast("❌ 商品上架失败，请稍后重试","error")}),void console.log("⚠️ 商品生成已触发，请稍后重新打开商城")}if(Ns&&"function"==typeof n.closeToolModal)try{n.closeToolModal(),console.log("✅ 已关闭道具页面（已记录状态）")}catch(n){console.warn("⚠️ 关闭道具页面失败:",n)}["tool-modal","tool-modal-overlay","item-modal","pk-modal","live-room-container"].forEach(n=>{const e=document.getElementById(n);e&&(e.style.display="none",e.classList.remove("active"))}),function(){const n="x-shop-styles";if(document.getElementById(n))return;const e=document.createElement("style");e.id=n,e.textContent="\n    /* ========================================== */\n    /* SHOP MARKETPLACE STYLES */\n    /* ========================================== */\n\n    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=VT323&family=Press+Start+2P&family=Courier+Prime:wght@400;700&display=swap');\n\n    .shop-container * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n      -webkit-tap-highlight-color: transparent;\n    }\n\n    /* 商城容器 - 基础样式 + 深色主题变量 */\n    .shop-container {\n      /* CSS变量定义 - Dark Theme */\n      --bg-desktop: #2a2a2a;\n      --bg-window: #b8b8b8;\n      --bg-content: #e8e8e8;\n      --bg-titlebar: #efdadc;\n      --bg-button: #b8b8b8;\n      --text-primary: #1a1a1a;\n      --text-primary-rgb: 26, 26, 26;\n      --text-secondary: #6a6a6a;\n      --text-white: #f5f5f5;\n      --border-light: #d8d8d8;\n      --border-dark: #7a7a7a;\n      --border-darkest: #1a1a1a;\n      --accent: #efdadc;\n      --accent-dark: #d4b5b8;\n      --dot-pattern: #3a3a3a;\n\n      /* 基础样式 */\n      font-family: 'IBM Plex Mono', 'Courier Prime', monospace;\n      background-color: var(--bg-desktop);\n      color: var(--text-primary);\n      overflow: hidden;\n      width: 100vw;\n      height: 100vh;\n      position: fixed;\n      top: 0;\n      left: 0;\n      z-index: 9999;\n\n      /* Polka dot background */\n      background-image: radial-gradient(circle, var(--dot-pattern) 1px, transparent 1px);\n      background-size: 20px 20px;\n      background-position: 0 0, 10px 10px;\n      animation: desktopFloat 60s infinite linear;\n    }\n\n    /* 商城容器浅色主题变量 */\n    .shop-container.shop-light-theme {\n      /* Light Theme - 浅灰主体，粉色重点 */\n      --bg-desktop: #ececec;\n      --bg-window: #d4d4d4;\n      --bg-content: #fafafa;\n      --bg-titlebar: #efdadc;\n      --bg-button: #d4d4d4;\n      --text-primary: #2a2a2a;\n      --text-primary-rgb: 42, 42, 42;\n      --text-secondary: #8a8a8a;\n      --text-white: #fafafa;\n      --border-light: #f0f0f0;\n      --border-dark: #ababab;\n      --border-darkest: #5a5a5a;\n      --accent: #efdadc;\n      --accent-dark: #d4b5b8;\n      --dot-pattern: #e0e0e0;\n    }\n\n    @keyframes desktopFloat {\n      0% { background-position: 0 0, 10px 10px; }\n      100% { background-position: 20px 20px, 30px 30px; }\n    }\n\n    /* ASCII Art Decoration */\n    .shop-ascii-corner {\n      position: fixed;\n      font-family: 'VT323', monospace;\n      font-size: 12px;\n      line-height: 1;\n      color: var(--text-secondary);\n      opacity: 0.3;\n      pointer-events: none;\n      z-index: 0;\n    }\n\n    .shop-ascii-corner.top-left {\n      top: 10px;\n      left: 10px;\n    }\n\n    .shop-ascii-corner.top-right {\n      top: 10px;\n      right: 10px;\n    }\n\n    .shop-ascii-corner.bottom-left {\n      bottom: 50px;\n      left: 10px;\n    }\n\n    .shop-ascii-corner.bottom-right {\n      bottom: 50px;\n      right: 10px;\n    }\n\n    /* Main Window Container */\n    .shop-window {\n      position: absolute;\n      width: calc(100vw - 20px);\n      height: calc(100vh - 60px);\n      max-width: 100%;\n      top: 10px;\n      left: 10px;\n      background: var(--bg-window);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      box-shadow:\n        inset 1px 1px 0 var(--border-light),\n        inset -1px -1px 0 var(--border-dark),\n        2px 2px 10px rgba(0,0,0,0.3);\n      display: flex;\n      flex-direction: column;\n      animation: windowBoot 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n      z-index: 10;\n    }\n\n    @keyframes windowBoot {\n      0% {\n        opacity: 0;\n        transform: scale(0.8) translateY(20px);\n      }\n      60% {\n        transform: scale(1.02) translateY(-5px);\n      }\n      100% {\n        opacity: 1;\n        transform: scale(1) translateY(0);\n      }\n    }\n\n    /* Title Bar */\n    .shop-titlebar {\n      background: var(--bg-titlebar);\n      color: var(--text-white);\n      height: 24px;\n      display: flex;\n      align-items: center;\n      padding: 0 4px;\n      gap: 4px;\n      border-bottom: 1px solid var(--border-darkest);\n      flex-shrink: 0;\n    }\n\n    .shop-titlebar-icon {\n      width: 16px;\n      height: 16px;\n      background: var(--text-white);\n      border: 1px solid var(--text-white);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 10px;\n      font-family: 'VT323', monospace;\n    }\n\n    .shop-titlebar-text {\n      flex: 1;\n      font-size: 11px;\n      font-weight: 600;\n      letter-spacing: 0.5px;\n      white-space: nowrap;\n      overflow: hidden;\n      text-overflow: ellipsis;\n    }\n\n    .shop-titlebar-buttons {\n      display: flex;\n      gap: 2px;\n    }\n\n    .shop-titlebar-btn {\n      width: 16px;\n      height: 16px;\n      background: var(--bg-button);\n      border-top: 1px solid var(--border-light);\n      border-left: 1px solid var(--border-light);\n      border-right: 1px solid var(--border-darkest);\n      border-bottom: 1px solid var(--border-darkest);\n      font-size: 10px;\n      font-weight: bold;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      color: var(--text-primary);\n      font-family: 'VT323', monospace;\n    }\n\n    .shop-titlebar-btn:active {\n      border-top: 1px solid var(--border-darkest);\n      border-left: 1px solid var(--border-darkest);\n      border-right: 1px solid var(--border-light);\n      border-bottom: 1px solid var(--border-light);\n    }\n\n    /* Menu Bar */\n    .shop-menubar {\n      background: var(--bg-window);\n      height: 20px;\n      display: flex;\n      align-items: center;\n      padding: 0 4px;\n      gap: 8px;\n      border-bottom: 1px solid var(--border-dark);\n      font-size: 11px;\n      flex-shrink: 0;\n    }\n\n    .shop-menu-item {\n      padding: 2px 6px;\n      cursor: pointer;\n      user-select: none;\n    }\n\n    .shop-menu-item:hover {\n      background: var(--accent);\n      color: var(--text-primary);\n    }\n\n    /* Address Bar */\n    .shop-addressbar {\n      background: var(--bg-window);\n      padding: 4px;\n      display: flex;\n      gap: 4px;\n      align-items: center;\n      border-bottom: 1px solid var(--border-dark);\n      flex-shrink: 0;\n    }\n\n    .shop-addressbar-label {\n      font-size: 10px;\n      color: var(--text-secondary);\n    }\n\n    .shop-addressbar-input {\n      flex: 1;\n      height: 22px;\n      background: var(--bg-content);\n      border-top: 1px solid var(--border-dark);\n      border-left: 1px solid var(--border-dark);\n      border-right: 1px solid var(--border-light);\n      border-bottom: 1px solid var(--border-light);\n      padding: 2px 6px;\n      font-size: 10px;\n      font-family: 'IBM Plex Mono', monospace;\n      color: var(--text-primary);\n    }\n\n    .shop-addressbar-btn {\n      width: 50px;\n      height: 22px;\n      background: var(--bg-button);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      font-size: 9px;\n      cursor: pointer;\n      font-weight: 600;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 2px;\n    }\n\n    .shop-addressbar-btn:active {\n      border-top: 2px solid var(--border-darkest);\n      border-left: 2px solid var(--border-darkest);\n      border-right: 2px solid var(--border-light);\n      border-bottom: 2px solid var(--border-light);\n    }\n\n    /* Nav Buttons */\n    .shop-nav-buttons {\n      display: flex;\n      gap: 2px;\n    }\n\n    .shop-nav-btn {\n      width: 24px;\n      height: 22px;\n      background: var(--bg-button);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 10px;\n      font-family: 'VT323', monospace;\n    }\n\n    .shop-nav-btn:active {\n      border-top: 2px solid var(--border-darkest);\n      border-left: 2px solid var(--border-darkest);\n      border-right: 2px solid var(--border-light);\n      border-bottom: 2px solid var(--border-light);\n    }\n\n    /* Tabs */\n    .shop-tabs {\n      background: var(--bg-window);\n      display: flex;\n      padding: 4px 4px 0 4px;\n      gap: 2px;\n      overflow-x: auto;\n      overflow-y: hidden;\n      flex-shrink: 0;\n      scrollbar-width: thin;\n      scrollbar-color: var(--border-dark) var(--bg-window);\n    }\n\n    .shop-tabs::-webkit-scrollbar {\n      height: 12px;\n    }\n\n    .shop-tabs::-webkit-scrollbar-track {\n      background: var(--bg-window);\n    }\n\n    .shop-tabs::-webkit-scrollbar-thumb {\n      background: var(--border-dark);\n      border: 1px solid var(--border-darkest);\n    }\n\n    .shop-tab {\n      padding: 4px 12px;\n      background: var(--bg-button);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      font-size: 10px;\n      cursor: pointer;\n      white-space: nowrap;\n      user-select: none;\n      position: relative;\n      font-weight: 500;\n    }\n\n    .shop-tab.active {\n      background: var(--bg-content);\n      border-bottom: 2px solid var(--bg-content);\n      margin-bottom: -2px;\n      font-weight: 600;\n      box-shadow: inset 0 -3px 0 var(--accent);\n    }\n\n    .shop-tab:not(.active):active {\n      border-top: 2px solid var(--border-darkest);\n      border-left: 2px solid var(--border-darkest);\n      border-right: 2px solid var(--border-light);\n    }\n\n    /* Content Area */\n    .shop-content {\n      flex: 1;\n      background: var(--bg-content);\n      border-top: 2px solid var(--border-dark);\n      overflow-y: auto;\n      overflow-x: hidden;\n      padding: 8px;\n      position: relative;\n    }\n\n    .shop-content::-webkit-scrollbar {\n      width: 16px;\n    }\n\n    .shop-content::-webkit-scrollbar-track {\n      background: var(--bg-window);\n      border-left: 1px solid var(--border-dark);\n    }\n\n    .shop-content::-webkit-scrollbar-thumb {\n      background: var(--bg-button);\n      border-top: 1px solid var(--border-light);\n      border-left: 1px solid var(--border-light);\n      border-right: 1px solid var(--border-darkest);\n      border-bottom: 1px solid var(--border-darkest);\n    }\n\n    .shop-content::-webkit-scrollbar-button {\n      height: 16px;\n      background: var(--bg-button);\n      border-top: 1px solid var(--border-light);\n      border-left: 1px solid var(--border-light);\n      border-right: 1px solid var(--border-darkest);\n      border-bottom: 1px solid var(--border-darkest);\n    }\n\n    /* Pixel Border Decoration */\n    .shop-pixel-border {\n      position: relative;\n    }\n\n    .shop-pixel-border::before {\n      content: '';\n      position: absolute;\n      top: -4px;\n      left: -4px;\n      right: -4px;\n      bottom: -4px;\n      background:\n        linear-gradient(90deg, var(--text-primary) 1px, transparent 1px) 0 0,\n        linear-gradient(0deg, var(--text-primary) 1px, transparent 1px) 0 0;\n      background-size: 4px 4px;\n      opacity: 0.1;\n      pointer-events: none;\n    }\n\n    /* Items Grid */\n    .shop-items-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));\n      gap: 10px;\n      animation: gridFadeIn 0.6s ease-out;\n    }\n\n    @keyframes gridFadeIn {\n      from {\n        opacity: 0;\n        transform: translateY(10px);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    @keyframes gridFadeOut {\n      from {\n        opacity: 1;\n        transform: translateY(0);\n      }\n      to {\n        opacity: 0;\n        transform: translateY(-10px);\n      }\n    }\n\n    /* 🔥 动画辅助类 */\n    .shop-grid-fade-out {\n      animation: gridFadeOut 0.3s ease-out forwards;\n    }\n\n    .shop-grid-fade-in {\n      animation: gridFadeIn 0.6s ease-out forwards;\n    }\n\n    /* Item Card */\n    .shop-item-card {\n      background: var(--bg-window);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      padding: 6px;\n      cursor: pointer;\n      transition: all 0.2s;\n      animation: cardPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n      animation-fill-mode: backwards;\n      position: relative;\n      overflow: hidden;\n    }\n\n    .shop-item-card:nth-child(1) { animation-delay: 0.05s; }\n    .shop-item-card:nth-child(2) { animation-delay: 0.1s; }\n    .shop-item-card:nth-child(3) { animation-delay: 0.15s; }\n    .shop-item-card:nth-child(4) { animation-delay: 0.2s; }\n    .shop-item-card:nth-child(5) { animation-delay: 0.25s; }\n    .shop-item-card:nth-child(6) { animation-delay: 0.3s; }\n    .shop-item-card:nth-child(7) { animation-delay: 0.35s; }\n    .shop-item-card:nth-child(8) { animation-delay: 0.4s; }\n\n    @keyframes cardPop {\n      0% {\n        opacity: 0;\n        transform: scale(0.5) rotate(-10deg);\n      }\n      70% {\n        transform: scale(1.05) rotate(2deg);\n      }\n      100% {\n        opacity: 1;\n        transform: scale(1) rotate(0deg);\n      }\n    }\n\n    .shop-item-card:hover {\n      transform: translateY(-3px);\n      box-shadow:\n        inset -1px -1px 0 var(--border-light),\n        inset 1px 1px 0 var(--border-dark),\n        3px 3px 0 rgba(0,0,0,0.2),\n        0 0 0 2px var(--accent);\n    }\n\n    .shop-item-card:active {\n      border-top: 2px solid var(--border-darkest);\n      border-left: 2px solid var(--border-darkest);\n      border-right: 2px solid var(--border-light);\n      border-bottom: 2px solid var(--border-light);\n      transform: translateY(0);\n    }\n\n    .shop-item-image-container {\n      width: 100%;\n      height: 120px;\n      background: var(--bg-content);\n      border: 1px solid var(--border-dark);\n      margin-bottom: 6px;\n      overflow: hidden;\n      position: relative;\n    }\n\n    .shop-item-image {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n      image-rendering: auto;\n      filter: contrast(1.05) saturate(0.35) grayscale(0.3);\n      transition: filter 0.3s;\n    }\n\n    .shop-item-card:hover .shop-item-image {\n      filter: contrast(1.1) saturate(0.5) grayscale(0.2);\n    }\n\n    /* Scanline Effect on Images */\n    .shop-item-image-container::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: repeating-linear-gradient(\n        0deg,\n        transparent,\n        transparent 2px,\n        rgba(0,0,0,0.1) 2px,\n        rgba(0,0,0,0.1) 4px\n      );\n      pointer-events: none;\n      animation: scanlines 8s linear infinite;\n    }\n\n    @keyframes scanlines {\n      0% { transform: translateY(0); }\n      100% { transform: translateY(4px); }\n    }\n\n    .shop-item-title {\n      font-size: 11px;\n      font-weight: 600;\n      margin-bottom: 4px;\n      line-height: 1.3;\n      display: -webkit-box;\n      -webkit-line-clamp: 2;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n      font-family: 'IBM Plex Mono', monospace;\n    }\n\n    .shop-item-seller {\n      font-size: 9px;\n      color: var(--text-secondary);\n      margin-bottom: 6px;\n      font-family: 'VT323', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    .shop-item-footer {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding-top: 6px;\n      border-top: 1px dotted var(--border-dark);\n    }\n\n    .shop-item-price {\n      font-size: 12px;\n      font-weight: 700;\n      font-family: 'Press Start 2P', monospace;\n      letter-spacing: 1px;\n    }\n\n    .shop-item-status {\n      font-size: 8px;\n      padding: 2px 6px;\n      background: var(--accent);\n      color: var(--text-primary);\n      border: 1px solid var(--accent-dark);\n      font-family: 'VT323', monospace;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n      font-weight: 600;\n    }\n\n    /* Status Bar */\n    .shop-statusbar {\n      background: var(--bg-window);\n      height: 22px;\n      border-top: 1px solid var(--border-light);\n      display: flex;\n      align-items: center;\n      padding: 0 4px;\n      font-size: 10px;\n      gap: 8px;\n      flex-shrink: 0;\n    }\n\n    .shop-statusbar-section {\n      display: flex;\n      align-items: center;\n      gap: 4px;\n      padding: 2px 6px;\n      border-top: 1px solid var(--border-dark);\n      border-left: 1px solid var(--border-dark);\n      border-right: 1px solid var(--border-light);\n      border-bottom: 1px solid var(--border-light);\n      background: var(--bg-content);\n      font-family: 'VT323', monospace;\n    }\n\n    .shop-statusbar-section.flex {\n      flex: 1;\n    }\n\n    .shop-statusbar-icon {\n      width: 12px;\n      height: 12px;\n      background: var(--text-primary);\n      font-size: 8px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      color: var(--bg-content);\n    }\n\n    /* Loading Animation */\n    .shop-loading-bar {\n      width: 80px;\n      height: 12px;\n      border: 1px solid var(--border-dark);\n      background: var(--bg-content);\n      position: relative;\n      overflow: hidden;\n    }\n\n    .shop-loading-bar::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      height: 100%;\n      width: 60%;\n      background: var(--accent);\n      animation: loading 2s infinite linear;\n    }\n\n    @keyframes loading {\n      0% { left: -60%; }\n      100% { left: 100%; }\n    }\n\n    /* Theme Toggle */\n    .shop-theme-toggle {\n      position: fixed;\n      bottom: 60px;\n      right: 20px;\n      width: 40px;\n      height: 40px;\n      background: var(--accent);\n      border-top: 3px solid var(--border-light);\n      border-left: 3px solid var(--border-light);\n      border-right: 3px solid var(--accent-dark);\n      border-bottom: 3px solid var(--accent-dark);\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 16px;\n      z-index: 100;\n      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);\n      animation: toggleFloat 3s ease-in-out infinite;\n    }\n\n    @keyframes toggleFloat {\n      0%, 100% { transform: translateY(0); }\n      50% { transform: translateY(-5px); }\n    }\n\n    .shop-theme-toggle:active {\n      border-top: 3px solid var(--accent-dark);\n      border-left: 3px solid var(--accent-dark);\n      border-right: 3px solid var(--border-light);\n      border-bottom: 3px solid var(--border-light);\n    }\n\n    /* Pixel Font Elements */\n    .shop-pixel-text {\n      font-family: 'VT323', monospace;\n      letter-spacing: 1px;\n    }\n\n    .shop-retro-text {\n      font-family: 'Press Start 2P', monospace;\n      font-size: 8px;\n      line-height: 1.6;\n    }\n\n    /* Desktop Icons */\n    .shop-desktop-icon {\n      position: fixed;\n      width: 60px;\n      text-align: center;\n      cursor: pointer;\n      z-index: 1;\n      animation: iconFloat 4s ease-in-out infinite;\n    }\n\n    @keyframes iconFloat {\n      0%, 100% { transform: translateY(0) rotate(0deg); }\n      50% { transform: translateY(-8px) rotate(2deg); }\n    }\n\n    .shop-desktop-icon.icon-1 {\n      top: 20px;\n      left: 20px;\n      animation-delay: 0s;\n    }\n\n    .shop-desktop-icon.icon-2 {\n      top: 100px;\n      left: 20px;\n      animation-delay: 0.5s;\n    }\n\n    .shop-desktop-icon.icon-3 {\n      top: 20px;\n      right: 20px;\n      animation-delay: 1s;\n    }\n\n    .shop-desktop-icon-img {\n      width: 32px;\n      height: 32px;\n      margin: 0 auto 4px;\n      background: var(--bg-button);\n      border: 2px solid var(--border-dark);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 8px;\n      font-weight: 700;\n      font-family: 'VT323', monospace;\n      letter-spacing: 0.5px;\n      color: var(--text-primary);\n    }\n\n    .shop-desktop-icon-label {\n      font-size: 9px;\n      color: var(--text-primary);\n      text-shadow: 1px 1px 2px rgba(255,255,255,0.8);\n      font-weight: 600;\n      font-family: 'IBM Plex Mono', monospace;\n    }\n\n    /* Glitch Effect (Subtle) */\n    @keyframes glitch {\n      0%, 100% { transform: translate(0); }\n      20% { transform: translate(-1px, 1px); }\n      40% { transform: translate(1px, -1px); }\n      60% { transform: translate(-1px, -1px); }\n      80% { transform: translate(1px, 1px); }\n    }\n\n    .shop-window:hover .shop-titlebar {\n      animation: glitch 0.3s ease-in-out;\n    }\n\n    /* Ripple Effect */\n    .shop-ripple {\n      position: absolute;\n      border-radius: 50%;\n      background: rgba(0, 0, 0, 0.3);\n      transform: scale(0);\n      animation: rippleEffect 0.6s ease-out;\n      pointer-events: none;\n    }\n\n    @keyframes rippleEffect {\n      to {\n        transform: scale(4);\n        opacity: 0;\n      }\n    }\n\n    /* ========================================== */\n    /* MODAL / DETAIL WINDOW STYLES */\n    /* ========================================== */\n\n    .shop-modal-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: 100vh;\n      background: rgba(0, 0, 0, 0.7);\n      display: none;\n      align-items: center;\n      justify-content: center;\n      z-index: 10000;\n      padding: 10px;\n      animation: overlayFadeIn 0.3s ease-out;\n    }\n\n    .shop-modal-overlay.active {\n      display: flex;\n    }\n\n    @keyframes overlayFadeIn {\n      from { opacity: 0; }\n      to { opacity: 1; }\n    }\n\n    .shop-modal-window {\n      background: var(--bg-window);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      box-shadow:\n        inset 1px 1px 0 var(--border-light),\n        inset -1px -1px 0 var(--border-dark),\n        4px 4px 20px rgba(0,0,0,0.5);\n      max-width: 900px;\n      width: 100%;\n      max-height: 90vh;\n      display: flex;\n      flex-direction: column;\n      animation: modalPopIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n      position: relative;\n    }\n\n    @keyframes modalPopIn {\n      0% {\n        opacity: 0;\n        transform: scale(0.7) rotate(-5deg) translateY(50px);\n      }\n      60% {\n        transform: scale(1.05) rotate(2deg) translateY(-10px);\n      }\n      100% {\n        opacity: 1;\n        transform: scale(1) rotate(0) translateY(0);\n      }\n    }\n\n    /* Modal Content Area */\n    .shop-modal-content {\n      flex: 1;\n      background: var(--bg-content);\n      border-top: 2px solid var(--border-dark);\n      display: flex;\n      gap: 12px;\n      padding: 12px;\n      overflow-y: auto;\n      overflow-x: hidden;\n    }\n\n    .shop-modal-content::-webkit-scrollbar {\n      width: 14px;\n    }\n\n    .shop-modal-content::-webkit-scrollbar-track {\n      background: var(--bg-window);\n    }\n\n    .shop-modal-content::-webkit-scrollbar-thumb {\n      background: var(--bg-button);\n      border: 1px solid var(--border-dark);\n    }\n\n    /* Left Column - Image Gallery */\n    .shop-modal-left {\n      flex: 1;\n      min-width: 250px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n\n    .shop-modal-main-image {\n      background: var(--bg-window);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      padding: 8px;\n      position: relative;\n      animation: imageFadeIn 0.5s ease-out 0.2s backwards;\n    }\n\n    @keyframes imageFadeIn {\n      from {\n        opacity: 0;\n        transform: translateX(-20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(0);\n      }\n    }\n\n    .shop-modal-image {\n      width: 100%;\n      height: auto;\n      max-height: 400px;\n      object-fit: cover;\n      display: block;\n      border: 1px solid var(--border-dark);\n      filter: contrast(1.05) saturate(0.35) grayscale(0.3);\n    }\n\n    .shop-image-counter {\n      position: absolute;\n      bottom: 12px;\n      right: 12px;\n      background: var(--accent);\n      color: var(--text-primary);\n      padding: 4px 8px;\n      font-size: 10px;\n      border: 1px solid var(--accent-dark);\n      font-weight: 600;\n    }\n\n    .shop-modal-ascii {\n      font-family: 'VT323', monospace;\n      font-size: 10px;\n      line-height: 1.2;\n      color: var(--text-secondary);\n      margin-top: 8px;\n      padding: 6px;\n      background: var(--bg-window);\n      border: 1px dashed var(--border-dark);\n      animation: asciiBlink 2s ease-in-out infinite;\n    }\n\n    @keyframes asciiBlink {\n      0%, 100% { opacity: 0.6; }\n      50% { opacity: 1; }\n    }\n\n    /* Right Column - Product Info */\n    .shop-modal-right {\n      flex: 1;\n      min-width: 280px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      animation: infoSlideIn 0.5s ease-out 0.3s backwards;\n    }\n\n    @keyframes infoSlideIn {\n      from {\n        opacity: 0;\n        transform: translateX(20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(0);\n      }\n    }\n\n    .shop-info-block {\n      background: var(--bg-window);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      overflow: hidden;\n    }\n\n    .shop-info-header {\n      background: var(--accent);\n      color: var(--text-primary);\n      padding: 4px 8px;\n      font-size: 10px;\n      font-weight: 600;\n      border-bottom: 1px solid var(--accent-dark);\n      letter-spacing: 1px;\n    }\n\n    .shop-info-content {\n      padding: 10px;\n      background: var(--bg-content);\n    }\n\n    .shop-seller-name {\n      font-size: 14px;\n      font-weight: 600;\n      margin-bottom: 6px;\n      font-family: 'IBM Plex Mono', monospace;\n    }\n\n    .shop-seller-stats {\n      display: flex;\n      gap: 12px;\n      font-size: 9px;\n      color: var(--text-secondary);\n    }\n\n    .shop-modal-title {\n      font-size: 18px;\n      font-weight: 700;\n      margin-bottom: 10px;\n      line-height: 1.3;\n      font-family: 'IBM Plex Mono', monospace;\n      color: var(--text-primary);\n    }\n\n    .shop-modal-price-row {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      gap: 10px;\n    }\n\n    .shop-modal-price {\n      font-size: 24px;\n      font-weight: 700;\n      font-family: 'Press Start 2P', monospace;\n      letter-spacing: 2px;\n      color: var(--text-primary);\n    }\n\n    .shop-modal-status {\n      font-size: 10px;\n      padding: 4px 10px;\n      background: var(--accent);\n      color: var(--text-primary);\n      border: 1px solid var(--accent-dark);\n      font-family: 'VT323', monospace;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n      font-weight: 600;\n    }\n\n    .shop-modal-description {\n      font-size: 13px;\n      line-height: 1.6;\n      color: var(--text-primary);\n      font-family: 'IBM Plex Mono', monospace;\n    }\n\n    .shop-spec-list {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n    }\n\n    .shop-spec-item {\n      display: flex;\n      justify-content: space-between;\n      font-size: 11px;\n      padding: 6px 8px;\n      background: var(--bg-window);\n      border: 1px dotted var(--border-dark);\n    }\n\n    .shop-spec-label {\n      font-weight: 600;\n      font-family: 'VT323', monospace;\n      letter-spacing: 0.5px;\n    }\n\n    .shop-spec-value {\n      font-family: 'IBM Plex Mono', monospace;\n      color: var(--text-secondary);\n    }\n\n    /* Modal Actions */\n    .shop-modal-actions {\n      background: var(--bg-window);\n      padding: 10px;\n      border-top: 1px solid var(--border-dark);\n      display: flex;\n      gap: 8px;\n      flex-wrap: wrap;\n      animation: actionsSlideUp 0.5s ease-out 0.4s backwards;\n    }\n\n    @keyframes actionsSlideUp {\n      from {\n        opacity: 0;\n        transform: translateY(20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n\n    .shop-action-btn {\n      flex: 1;\n      min-width: 140px;\n      height: 36px;\n      background: var(--bg-button);\n      border-top: 2px solid var(--border-light);\n      border-left: 2px solid var(--border-light);\n      border-right: 2px solid var(--border-darkest);\n      border-bottom: 2px solid var(--border-darkest);\n      font-family: 'VT323', monospace;\n      font-size: 11px;\n      font-weight: 600;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n      transition: all 0.2s;\n      letter-spacing: 0.5px;\n      color: var(--text-primary);\n    }\n\n    .shop-action-btn:hover {\n      transform: translateY(-2px);\n      box-shadow: 2px 2px 4px rgba(0,0,0,0.2);\n    }\n\n    .shop-action-btn:active {\n      border-top: 2px solid var(--border-darkest);\n      border-left: 2px solid var(--border-darkest);\n      border-right: 2px solid var(--border-light);\n      border-bottom: 2px solid var(--border-light);\n      transform: translateY(0);\n    }\n\n    .shop-action-btn.primary-btn {\n      background: var(--accent);\n      border-right: 2px solid var(--accent-dark);\n      border-bottom: 2px solid var(--accent-dark);\n      font-weight: 700;\n    }\n\n    .shop-action-btn.primary-btn:active {\n      border-top: 2px solid var(--accent-dark);\n      border-left: 2px solid var(--accent-dark);\n      border-right: 2px solid var(--border-light);\n      border-bottom: 2px solid var(--border-light);\n    }\n\n    .shop-btn-icon {\n      font-size: 14px;\n      filter: grayscale(1);\n    }\n\n    /* Responsive */\n    @media (max-width: 768px) {\n      .shop-container {\n        padding-top: env(safe-area-inset-top);\n      }\n\n      .shop-window {\n        width: 100vw;\n        height: calc(100vh - env(safe-area-inset-top));\n        left: 0;\n        top: env(safe-area-inset-top);\n        border: none;\n      }\n\n      /* 移动端标题栏优化 - 适配灵动岛 */\n      .shop-titlebar {\n        height: 68px;\n        padding: 16px 10px 6px 10px;\n        align-items: flex-end;\n      }\n\n      .shop-titlebar-icon {\n        width: 28px;\n        height: 28px;\n        font-size: 16px;\n        margin-bottom: 2px;\n      }\n\n      .shop-titlebar-text {\n        font-size: 13px;\n        margin-bottom: 2px;\n      }\n\n      .shop-titlebar-btn {\n        width: 36px;\n        height: 36px;\n        font-size: 18px;\n        margin-bottom: 2px;\n      }\n\n      .shop-items-grid {\n        grid-template-columns: repeat(2, 1fr);\n        gap: 10px;\n      }\n\n      .shop-item-card {\n        padding: 8px;\n      }\n\n      .shop-item-image-container {\n        height: 120px;\n        margin-bottom: 8px;\n      }\n\n      .shop-item-title {\n        font-size: 12px;\n        margin-bottom: 6px;\n      }\n\n      .shop-item-seller {\n        font-size: 10px;\n        margin-bottom: 8px;\n      }\n\n      .shop-item-footer {\n        padding-top: 8px;\n      }\n\n      .shop-item-price {\n        font-size: 13px;\n      }\n\n      .shop-item-status {\n        font-size: 9px;\n        padding: 3px 8px;\n      }\n\n      .shop-tab {\n        padding: 8px 14px;\n        font-size: 10px;\n        min-height: 36px;\n        display: flex;\n        align-items: center;\n      }\n\n      .shop-desktop-icon {\n        display: none;\n      }\n\n      .shop-ascii-corner {\n        display: none;\n      }\n\n      .shop-addressbar {\n        flex-wrap: wrap;\n        padding: 8px 6px;\n      }\n\n      .shop-addressbar-input {\n        min-width: 100px;\n        height: 32px;\n        font-size: 11px;\n        padding: 4px 8px;\n      }\n\n      .shop-nav-btn {\n        width: 36px;\n        height: 32px;\n        font-size: 14px;\n      }\n\n      .shop-addressbar-btn {\n        width: 68px;\n        height: 32px;\n        font-size: 11px;\n      }\n\n      .shop-menubar {\n        height: 32px;\n        font-size: 12px;\n        padding: 0 6px;\n      }\n\n      .shop-menu-item {\n        padding: 6px 10px;\n      }\n\n      /* 移动端主题切换按钮 */\n      .shop-theme-toggle {\n        bottom: calc(60px + env(safe-area-inset-bottom));\n        width: 44px;\n        height: 44px;\n        font-size: 18px;\n      }\n\n      /* 底部状态栏适配 */\n      .shop-statusbar {\n        height: calc(22px + env(safe-area-inset-bottom));\n        padding-bottom: env(safe-area-inset-bottom);\n      }\n\n      /* Modal responsive */\n      .shop-modal-overlay {\n        padding: 0;\n        padding-top: env(safe-area-inset-top);\n      }\n\n      .shop-modal-window {\n        max-width: 100%;\n        max-height: 100vh;\n        height: calc(100vh - env(safe-area-inset-top));\n        border: none;\n      }\n\n      /* Modal标题栏移动端优化 - 适配灵动岛 */\n      .shop-modal-window .shop-titlebar {\n        height: 68px;\n        padding: 16px 10px 6px 10px;\n        align-items: flex-end;\n      }\n\n      .shop-modal-window .shop-titlebar-icon {\n        width: 28px;\n        height: 28px;\n        font-size: 16px;\n        margin-bottom: 2px;\n      }\n\n      .shop-modal-window .shop-titlebar-text {\n        font-size: 13px;\n        margin-bottom: 2px;\n      }\n\n      .shop-modal-window .shop-titlebar-btn {\n        width: 36px;\n        height: 36px;\n        font-size: 18px;\n        margin-bottom: 2px;\n      }\n\n      .shop-modal-content {\n        flex-direction: column;\n        gap: 10px;\n        padding: 10px;\n      }\n\n      .shop-modal-left,\n      .shop-modal-right {\n        min-width: 100%;\n      }\n\n      .shop-modal-main-image {\n        max-height: 250px;\n      }\n\n      .shop-modal-image {\n        max-height: 250px;\n      }\n\n      .shop-modal-title {\n        font-size: 16px;\n      }\n\n      .shop-modal-price {\n        font-size: 20px;\n      }\n\n      .shop-action-btn {\n        min-width: 110px;\n        font-size: 11px;\n        height: 48px;\n        gap: 8px;\n      }\n\n      .shop-btn-icon {\n        font-size: 16px;\n      }\n\n      .shop-modal-actions {\n        padding: 12px 10px calc(12px + env(safe-area-inset-bottom)) 10px;\n        gap: 10px;\n      }\n    }\n\n    @media (min-width: 769px) {\n      .shop-window {\n        max-width: 900px;\n        height: calc(100vh - 80px);\n        left: 50%;\n        transform: translateX(-50%);\n      }\n\n      .shop-items-grid {\n        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));\n        gap: 12px;\n      }\n\n      .shop-item-image-container {\n        height: 140px;\n      }\n    }\n\n    /* ========================================== */\n    /* GLOBAL ANIMATIONS */\n    /* ========================================== */\n\n    /* Toast Animations */\n    @keyframes toastFadeIn {\n      from {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.9);\n      }\n      to {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n      }\n    }\n\n    @keyframes toastFadeOut {\n      from {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1);\n      }\n      to {\n        opacity: 0;\n        transform: translate(-50%, -50%) scale(0.9);\n      }\n    }\n\n    /* Page Transition Animations */\n    .shop-page-container.active {\n      animation: pageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n\n    @keyframes pageSlideIn {\n      from {\n        opacity: 0;\n        transform: translateX(20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(0);\n      }\n    }\n\n    @keyframes itemSlideIn {\n      from {\n        opacity: 0;\n        transform: translateX(-20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateX(0);\n      }\n    }\n\n    @keyframes ripple {\n      to {\n        transform: translate(-50%, -50%) scale(2);\n        opacity: 0;\n      }\n    }\n\n    @keyframes screenFlicker {\n      0%, 100% { opacity: 1; }\n      50% { opacity: 0.98; }\n    }\n\n    @keyframes pulse {\n      0%, 100% { opacity: 0.3; }\n      50% { opacity: 0.5; }\n    }\n\n    ",document.head.appendChild(e),console.log("✅ 商城样式已注入")}(),function(){if(document.getElementById("shop-marketplace-container"))return void console.log("⚠️ 商城界面已存在，跳过创建");const e=document.createElement("div");e.id="shop-marketplace-container",e.className="shop-container",e.innerHTML='\n      \x3c!-- ASCII Art Corners --\x3e\n      <pre class="shop-ascii-corner top-left">\n /\\_/\\\n( o.o )\n > ^ <\n      </pre>\n      <pre class="shop-ascii-corner top-right">\n┌─┐\n│▓│\n└─┘\n      </pre>\n      <pre class="shop-ascii-corner bottom-left">\n[###]\n      </pre>\n      <pre class="shop-ascii-corner bottom-right">\n◢◤◢◤\n      </pre>\n\n      \x3c!-- Desktop Icons --\x3e\n      <div class="shop-desktop-icon icon-1">\n        <div class="shop-desktop-icon-img">PC</div>\n        <div class="shop-desktop-icon-label">My Computer</div>\n      </div>\n      <div class="shop-desktop-icon icon-2">\n        <div class="shop-desktop-icon-img">BIN</div>\n        <div class="shop-desktop-icon-label">Recycle Bin</div>\n      </div>\n      <div class="shop-desktop-icon icon-3">\n        <div class="shop-desktop-icon-img">DOC</div>\n        <div class="shop-desktop-icon-label">Documents</div>\n      </div>\n\n      \x3c!-- Main Window --\x3e\n      <div class="shop-window">\n        \x3c!-- Title Bar --\x3e\n        <div class="shop-titlebar">\n          <div class="shop-titlebar-icon">M</div>\n          <div class="shop-titlebar-text">MARKETPLACE.exe - Internet Explorer</div>\n          <div class="shop-titlebar-buttons">\n            <div class="shop-titlebar-btn">_</div>\n            <div class="shop-titlebar-btn">□</div>\n            <div class="shop-titlebar-btn" onclick="closeShopMarketplace()">✕</div>\n          </div>\n        </div>\n\n        \x3c!-- Menu Bar --\x3e\n        <div class="shop-menubar">\n          <div class="shop-menu-item">File</div>\n          <div class="shop-menu-item">Edit</div>\n          <div class="shop-menu-item">View</div>\n          <div class="shop-menu-item">Favorites</div>\n          <div class="shop-menu-item">Tools</div>\n          <div class="shop-menu-item">Help</div>\n        </div>\n\n        \x3c!-- Address Bar --\x3e\n        <div class="shop-addressbar">\n          <div class="shop-nav-buttons">\n            <div class="shop-nav-btn">◄</div>\n            <div class="shop-nav-btn">►</div>\n            <div class="shop-nav-btn">↻</div>\n            <div class="shop-nav-btn">⌂</div>\n          </div>\n          <span class="shop-addressbar-label shop-pixel-text">Address:</span>\n          <input type="text" class="shop-addressbar-input" value="https://marketplace.xiu.carrd.co/items" readonly>\n          <div class="shop-addressbar-btn">Go</div>\n        </div>\n\n        \x3c!-- Tabs --\x3e\n        <div class="shop-tabs">\n          <div class="shop-tab active shop-pixel-text">ALL ITEMS</div>\n          <div class="shop-tab shop-pixel-text">NEW ARRIVAL</div>\n          <div class="shop-tab shop-pixel-text">HOT DEALS</div>\n          <div class="shop-tab shop-pixel-text">RARE FINDS</div>\n          <div class="shop-tab shop-pixel-text">ELECTRONICS</div>\n          <div class="shop-tab shop-pixel-text">COLLECTIBLES</div>\n          <div class="shop-tab shop-pixel-text">VINTAGE</div>\n        </div>\n\n        \x3c!-- Content --\x3e\n        <div class="shop-content shop-pixel-border">\n          \x3c!-- Home Page: Items Grid --\x3e\n          <div class="shop-items-grid" id="shopItemsGrid">\n            \x3c!-- Items will be populated by JavaScript --\x3e\n          </div>\n\n        \x3c!-- Status Bar --\x3e\n        <div class="shop-statusbar">\n          <div class="shop-statusbar-section flex">\n            <span class="shop-pixel-text">Ready</span>\n          </div>\n          <div class="shop-statusbar-section">\n            <div class="shop-statusbar-icon">⏱</div>\n            <span class="shop-pixel-text" id="shopTime">00:00:00</span>\n          </div>\n          <div class="shop-statusbar-section">\n            <div class="shop-loading-bar"></div>\n          </div>\n          <div class="shop-statusbar-section">\n            <span class="shop-pixel-text" id="shopItemCount">0 items</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Item Detail Modal --\x3e\n      <div class="shop-modal-overlay" id="shopItemModal">\n        <div class="shop-modal-window">\n          \x3c!-- Modal Title Bar --\x3e\n          <div class="shop-titlebar">\n            <div class="shop-titlebar-icon">i</div>\n            <div class="shop-titlebar-text">ITEM_DETAIL.exe - Product Viewer</div>\n            <div class="shop-titlebar-buttons">\n              <div class="shop-titlebar-btn">_</div>\n              <div class="shop-titlebar-btn">□</div>\n              <div class="shop-titlebar-btn shop-modal-close">✕</div>\n            </div>\n          </div>\n\n          \x3c!-- Modal Content --\x3e\n          <div class="shop-modal-content">\n            \x3c!-- Left Column: Image Gallery --\x3e\n            <div class="shop-modal-left">\n              <div class="shop-modal-main-image">\n                <img id="shopModalMainImage" src="" alt="Product" class="shop-modal-image">\n                <div class="shop-image-counter shop-pixel-text">\n                  <span id="shopImageIndex">1</span>/<span id="shopImageTotal">1</span>\n                </div>\n              </div>\n\n              \x3c!-- ASCII Art Decoration --\x3e\n              <pre class="shop-modal-ascii">\n ╔═══╗\n ║ ◉ ║  LCD VIEW\n ╚═══╝\n              </pre>\n            </div>\n\n            \x3c!-- Right Column: Product Info --\x3e\n            <div class="shop-modal-right">\n              \x3c!-- Seller Info --\x3e\n              <div class="shop-info-block">\n                <div class="shop-info-header shop-pixel-text">SELLER.txt</div>\n                <div class="shop-info-content">\n                  <div class="shop-seller-name" id="shopModalSeller">@seller_name</div>\n                  <div class="shop-seller-stats shop-pixel-text">\n                    <span>Rating: 4.8/5.0</span>\n                    <span>Sales: 234</span>\n                  </div>\n                </div>\n              </div>\n\n              \x3c!-- Product Title & Price --\x3e\n              <div class="shop-info-block">\n                <div class="shop-info-header shop-pixel-text">PRODUCT.txt</div>\n                <div class="shop-info-content">\n                  <h2 class="shop-modal-title" id="shopModalTitle">Product Title</h2>\n                  <div class="shop-modal-price-row">\n                    <div class="shop-modal-price" id="shopModalPrice">$99</div>\n                    <div class="shop-modal-status" id="shopModalStatus">NEW</div>\n                  </div>\n                </div>\n              </div>\n\n              \x3c!-- Description --\x3e\n              <div class="shop-info-block">\n                <div class="shop-info-header shop-pixel-text">DESCRIPTION.txt</div>\n                <div class="shop-info-content">\n                  <p class="shop-modal-description" id="shopModalDescription">\n                    High quality product in excellent condition.\n                    Perfect for collectors and enthusiasts.\n                    Ships within 2-3 business days.\n                  </p>\n                </div>\n              </div>\n\n              \x3c!-- Specs --\x3e\n              <div class="shop-info-block">\n                <div class="shop-info-header shop-pixel-text">SPECS.dat</div>\n                <div class="shop-info-content">\n                  <div class="shop-spec-list">\n                    <div class="shop-spec-item">\n                      <span class="shop-spec-label">Condition:</span>\n                      <span class="shop-spec-value">Like New</span>\n                    </div>\n                    <div class="shop-spec-item">\n                      <span class="shop-spec-label">Location:</span>\n                      <span class="shop-spec-value">New York, US</span>\n                    </div>\n                    <div class="shop-spec-item">\n                      <span class="shop-spec-label">Shipping:</span>\n                      <span class="shop-spec-value">Free Shipping</span>\n                    </div>\n                    <div class="shop-spec-item">\n                      <span class="shop-spec-label">Posted:</span>\n                      <span class="shop-spec-value">2 days ago</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          \x3c!-- Modal Action Bar --\x3e\n          <div class="shop-modal-actions">\n            <button class="shop-action-btn primary-btn">\n              <span class="shop-btn-icon">✉</span>\n              <span>CONTACT SELLER</span>\n            </button>\n            <button class="shop-action-btn secondary-btn">\n              <span class="shop-btn-icon">♥</span>\n              <span>ADD TO WISHLIST</span>\n            </button>\n            <button class="shop-action-btn secondary-btn">\n              <span class="shop-btn-icon">↗</span>\n              <span>SHARE</span>\n            </button>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Theme Toggle --\x3e\n      <div class="shop-theme-toggle" id="shopThemeToggle">\n        <span style="filter: grayscale(1);">☀</span>\n      </div>\n    ',document.body.appendChild(e),console.log("✅ 商城HTML结构已创建");const t=document.getElementById("shopItemModal");if(t){t.addEventListener("click",e=>{e.target===t&&n.closeShopItemModal()});const e=t.querySelector(".shop-modal-close");e&&(e.addEventListener("click",e=>{e.stopPropagation(),n.closeShopItemModal()}),console.log("✅ 关闭按钮事件已直接绑定")),document.addEventListener("keydown",e=>{"Escape"===e.key&&t.classList.contains("active")&&n.closeShopItemModal()}),console.log("✅ 模态框关闭事件已绑定")}}(),As(js),console.log("✅ 商城系统已启动")},n.closeShopMarketplace=function(){const e=document.getElementById("shop-marketplace-container");e&&(n.shopClockInterval&&(clearInterval(n.shopClockInterval),n.shopClockInterval=null),e.style.opacity="0",e.style.transition="opacity 0.3s ease-out",setTimeout(()=>{if(e.remove(),document.body.style.overflow="",document.body.classList.remove("shop-light-theme"),Ns&&"function"==typeof n.openToolModal)try{setTimeout(()=>{n.openToolModal(),console.log("✅ 已恢复道具页面"),Ns=!1},100)}catch(n){console.warn("⚠️ 恢复道具页面失败:",n),Ns=!1}console.log("✅ 商城系统已关闭")},300))},n.generateShopProducts=async function(){if(Rs)console.log("⚠️ [第十八情景] 商品正在生成中，请稍候...");else{Rs=!0,console.log("🛍️ [第十八情景] 商城商品初始化生成器启动");try{console.log("📦 [第十八情景] 正在加载API配置和用户设置...");const{db:e,xDb:t,apiConfig:o,xSettings:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r,boundCharacters:l}=a;console.log("✅ [第十八情景] API配置加载完成"),console.log("🌍 [第十八情景] 世界观设定:",r||"现代都市背景");const c=s.buildUserXProfileInfo(n.userProfileData);console.log("👤 [第十八情景] 用户X资料已构建:",c.name,c.handle);const p=n.currentAccountId||"main",m=`shopProducts_${p}`,x=await t.xAccountProfiles.get(m);if(x&&x.products&&x.products.length>0)return console.log("✅ [第十八情景] 数据库中已有商品数据，共",x.products.length,"个商品"),js=x.products,Hs=!0,Rs=!1,x.products;console.log("📝 [第十八情景] 数据库无商品数据，开始AI生成...");let u=0;const h=new Date;let f=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 时间感知\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前北京时间：${h.toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",weekday:"long"})}\n【时间相关提示】：\n- 商品应该符合当前季节特征（如夏季避免厚重冬装，冬季避免泳装等）\n- 根据节假日特点，可以生成应景商品\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`+s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});u=d.logTokenUsage("商品生成器","时间感知+基础系统提示词",f,u);const b=await s.getApplicableWorldBooks("shop",{boundCharacters:l});b&&(f+=b,u=d.logTokenUsage("商品生成器","世界书内容",b,u));const v=`worldEvents_${p}`,y=await t.xWorldEvents.get(v);if(y&&y.enabled&&y.events&&y.events.length>0){const n=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌍 世界运转状态（商品生成必读）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【当前世界设定】：\n📍 所在地点：${y.location}\n🌤️ 天气状况：${y.weather?.condition||"--"} ${y.weather?.temp||"--"}\n💡 穿衣建议：${y.weather?.tip||"--"}\n\n【近期大事件】（${y.events.length}个热门事件）：\n${y.events.map((n,e)=>`\n${e+1}. [${n.category}] ${n.title}\n   详情：${n.detail}\n   影响：${n.impact}\n`).join("")}\n\n【大事件融入规则】：\n🎯 核心原则：约20-40%的商品应该与这些大事件相关，让商城显得与世界同步\n1. **事件相关商品**：直接与事件相关的商品（如体育赛事相关商品、节日商品等）\n2. **天气影响商品**：根据天气生成应季商品（如雨具、防晒用品、保暖衣物等）\n3. **地点特色商品**：符合当前地点特色的商品\n4. **事件周边**：大事件相关的周边商品、纪念品等\n5. **自然融入**：不要强行在每个商品中提及，保持多样性\n\n【注意】：\n- 其余60-80%的商品可以是常规商品\n- 商品应该符合当前世界设定和时代背景\n- 商品价格应该符合世界经济水平\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;f+=n,u=d.logTokenUsage("商品生成器","世界运转大事件",n,u),console.log(`🌍 [第十八情景] 已注入 ${y.events.length} 个世界大事件`)}else console.log("ℹ️ [第十八情景] 世界大事件未启用或无数据，生成常规商品");const w=await s.buildCompleteCharacterInfo(l,c,"shop");w&&(f+=w,u=d.logTokenUsage("商品生成器","角色资料信息",w,u),console.log("🎭 [第十八情景] 已加载角色资料，角色可作为商品卖家"));const k=`characterStoreNames_${p}`;let $=await t.xAccountProfiles.get(k),C={};$&&$.storeNames?(C=$.storeNames,console.log("🏪 [第十八情景] 已加载角色店铺映射:",Object.keys(C).length,"个映射")):console.log("🏪 [第十八情景] 角色店铺映射表为空，将由AI生成新店铺信息");let I="";if(l&&l.length>0){if(I="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🏪 角色店铺映射表（必须严格遵守）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【重要】：同一个角色的所有商品必须使用相同的店铺信息，避免用户混淆！\n\n",Object.keys(C).length>0){I+="【已有店铺映射】（必须严格使用这些信息，不要创造新的）：\n";for(const[n,e]of Object.entries(C)){const t=l.find(e=>e.handle===n),o=t?t.name:"未知";"string"==typeof e?I+=`- ${n}（${o}）→ 店铺名："${e}"（旧数据，需补充评分销量等信息）\n`:(I+=`- ${n}（${o}）→ 店铺信息：\n`,I+=`  * 店铺名："${e.storeName}"\n`,I+=`  * 评分：${e.rating}（可微调±0.2）\n`,I+=`  * 销量：${e.sales}（可微调±50）\n`,I+=`  * 发货地：${e.location}（必须完全一致）\n`,I+=`  * 配送：${e.shipping}（必须完全一致）\n`)}}const n=l.filter(n=>!C[n.handle]);n.length>0&&(I+="\n【需要生成店铺的角色】（为这些角色创建完整的店铺信息）：\n",n.forEach(n=>{I+=`- ${n.handle}（${n.name}）\n`})),I+='\n【店铺生成规则】：\n1. 店名应该符合角色人设、兴趣和专业领域\n2. 店名不要使用角色的X昵称或句柄\n3. 店名要简洁、有特色、容易记忆\n4. 中英文均可，但要符合世界观设定\n5. 示例：摄影师角色 → "光影工作室" / "Lens & Frame Shop"\n6. 示例：厨师角色 → "小厨娘的厨具店" / "Chef\'s Corner"\n7. 示例：科技爱好者 → "数码星球" / "Tech Haven"\n\n【店铺信息统一规则】（重要！）：\n⚠️ 同一个角色的所有商品必须使用完全相同的店铺信息：\n- seller字段：店铺名必须完全一致\n- sellerRating：评分必须一致（可在原基础上微调±0.2，如4.8→4.7或5.0）\n- sellerSales：销量必须一致（可在原基础上微调±50，如234→280）\n- specs.location：发货地点必须完全一致（同一店铺不可能从不同城市发货）\n- specs.shipping：配送方式必须完全一致（同一店铺配送策略相同）\n- specs.posted：发布时间可以不同（不同商品发布时间不同）\n- specs.condition：商品成色可以不同（同一店铺可以卖新旧不同的商品）\n\n【角色商品数量限制】：\n⚠️ 每个角色最多发布2个商品！不要让单个角色发布过多商品！\n- 如果有多个绑定角色，分散商品，每个角色最多2个\n- 保留足够的普通卖家商品，保持商城多样性\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n',f+=I,u=d.logTokenUsage("商品生成器","角色店铺映射表",I,u)}const S='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨🚨🚨 强制性系统指令 🚨🚨🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n❌ 警告：违反以下任何规则将导致系统崩溃和数据损坏！\n❌ 你必须100%严格遵守所有规则，没有任何例外！\n❌ 不要添加任何解释、注释、额外文字，只返回纯JSON！\n❌ JSON格式必须完美无误，任何语法错误都将导致系统崩溃！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🎯 核心任务说明 🎯\n你是X社交平台商城的商品数据生成器。\n你的任务：生成20-30个商品数据（必须至少20个，最多30个）\n\n🚨 **绝对禁止清单** 🚨\n以下行为严格禁止，违反将导致系统崩溃：\n❌ 禁止返回任何JSON之外的文字、解释、注释\n❌ 禁止在JSON中使用未定义的字段\n❌ 禁止让同一角色发布超过2个商品\n❌ 禁止让同一店铺使用不同的评分、销量、发货地、配送方式\n❌ 禁止在图片URL中使用人物相关词汇（person/people/human/face等）\n❌ 禁止角色卖家使用X昵称或句柄作为店铺名\n❌ 禁止为已有店铺映射的角色创造新的店铺名\n❌ 禁止世界观矛盾的商品（如古代背景出现电子产品）\n❌ 禁止商品名称、图片、描述不一致（如名称是相机但描述是键盘）\n❌ 禁止假冒者超过20%（最多3-5个假冒商品）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n【强制性生成要求】（每一条都必须100%遵守）：\n\n🚨 规则1：世界观一致性（绝对强制）\n   ✅ 必须：商品必须100%符合当前世界观设定\n   ✅ 现代都市背景：电子产品、时尚配饰、生活用品、运动器材等\n   ✅ 古代背景：传统工艺品、古董字画、茶具香炉、文房四宝等\n   ✅ 科幻背景：高科技装备、智能设备、未来感商品等\n   ❌ 严格禁止：世界观矛盾物品（如现代世界出现高科技武器，古代出现电子产品）\n   ❌ 违反此规则将导致严重的系统错误！\n\n🚨 规则2：商品类型多样化（强制要求）\n   ✅ 必须包含至少4种不同类型的商品\n   ✅ 生活用品：杯子、文具、装饰品、书籍、工艺品\n   ✅ 电子产品：耳机、键盘、鼠标、充电宝、音箱（仅现代/科幻）\n   ✅ 服饰配饰：帽子、围巾、手表、包包、首饰\n   ✅ 收藏品：海报、手办、徽章、明信片、模型\n   ✅ 运动器材：球类、护具、健身器材、户外装备\n   ❌ 禁止所有商品都是同一类型！\n\n🚨 规则3：商品图片与描述一致性（绝对强制）\n   ✅ 必须：商品名称title、图片提示词imagePrompt、详细描述description必须100%对应\n   ❌ 绝对禁止：描述是键盘但图片是相机的情况\n   ❌ 绝对禁止：title说CAMERA但description说键盘\n   ✅ 必须：图片提示词imagePrompt必须用简洁准确的英文描述，且与title完全匹配\n   ⚠️ 这是最容易出错的地方，必须特别小心检查！\n\n🚨 规则4：图片URL严格规则（违反=系统崩溃）\n   ✅ 必须格式：https://image.pollinations.ai/prompt/ + 英文描述（空格用%20替换）\n   ❌❌❌ 绝对禁止词汇（任何一个都不能出现）：\n      person, people, human, face, portrait, man, woman, child, boy, girl,\n      body, hand, foot, leg, arm, eye, finger, head, hair, skin\n   ✅ 正确示例：\n     * https://image.pollinations.ai/prompt/vintage%20camera%20on%20wooden%20desk\n     * https://image.pollinations.ai/prompt/mechanical%20keyboard%20with%20rgb%20backlight\n     * https://image.pollinations.ai/prompt/coffee%20cup%20and%20saucer%20on%20table\n   ❌ 错误示例（严格禁止）：\n     * https://image.pollinations.ai/prompt/person%20holding%20camera（包含person）\n     * https://image.pollinations.ai/prompt/hand%20with%20watch（包含hand）\n   ⚠️ 检查每一个图片URL，确保没有任何人物词汇！\n\n🚨 规则5：商品属性规范（必须严格遵守）\n   ✅ title（名称）：必须大写英文，2-4个单词，简短有力\n   ✅ seller（卖家）：@username格式或店铺名，必须多样化（至少15-20个不同卖家）\n   ✅ price（价格）：$10-$500，必须符合商品类型（电子产品可更高）\n   ✅ status（状态）：必须是 new、hot、rare 三者之一，比例：new 40%、hot 30%、rare 30%\n   ✅ description（描述）：50-100字中文，必须包含材质、功能、特点、适用场景\n\n🚨🚨🚨 规则6：角色卖家（绝对强制，违反=系统崩溃）🚨🚨🚨\n   ⚠️⚠️⚠️ 这是最重要的规则，必须100%严格遵守！⚠️⚠️⚠️\n\n   【强制规则A：店铺名映射】\n   ❌❌❌ 如果【角色店铺映射表】中已有店铺信息，必须100%使用该店铺名！\n   ❌❌❌ 绝对禁止为已有映射的角色创造新的店铺名！\n   ❌❌❌ 绝对禁止角色卖家使用X昵称或句柄（@handle）作为店铺名！\n   ✅ 如果角色尚未有店铺映射，为其捏造符合人设的店铺名（不使用X昵称/句柄）\n\n   【强制规则B：店铺信息统一】\n   ❌❌❌ 同一个角色的所有商品必须使用完全相同的店铺信息！\n   ✅ seller字段：必须完全一致\n   ✅ sellerRating字段：必须完全一致（可微调±0.2）\n   ✅ sellerSales字段：必须完全一致（可微调±50）\n   ✅ specs.location字段：必须完全一致（不可以变）\n   ✅ specs.shipping字段：必须完全一致（不可以变）\n   ⚠️ 检查每个角色的所有商品，确保信息统一！\n\n   【强制规则C：商品数量限制】\n   ❌❌❌ 每个角色最多只能发布2个商品！绝对不能超过2个！\n   ✅ 如果有多个绑定角色，分散商品，每个角色最多2个\n   ✅ 保留足够的普通卖家商品，保持商城多样性\n\n   【强制规则D：字段设置】\n   ✅ 角色卖家必须设置：isCharacterSeller: true, characterHandle: "@角色句柄", characterName: "角色名字"\n   ✅ 普通卖家必须设置：isCharacterSeller: false, characterHandle: "", characterName: ""\n   ✅ 角色发布的商品必须符合角色的人设、兴趣和专业领域\n\n🚨🚨🚨 规则7：假冒者机制（严格控制）🚨🚨🚨\n   ⚠️ 假冒者是趣味玩法，但必须严格控制数量和质量！\n\n   【强制规则A：数量控制】\n   ❌❌❌ 假冒者商品不能超过20%（在20-30个商品中，最多3-5个假冒商品）\n   ❌❌❌ 绝对禁止假冒者过多，会导致用户困惑！\n\n   【强制规则B：冒充对象】\n   ✅ 假冒者必须冒充已绑定的角色（从【角色店铺映射表】或【角色资料】中选择）\n   ❌ 禁止冒充不存在的角色\n   ❌ 禁止冒充普通卖家\n\n   【强制规则C：山寨店名】\n   ✅ 假冒者的seller字段必须是山寨化的店名（与真实角色店名相似但不同）\n   ✅ 示例：真实店名"光影工作室" → 假冒者"光影摄影工作室"、"光影工作坊"\n   ✅ 示例：真实店名"Tech Haven" → 假冒者"Tech Heaven"、"Tech Harbor"\n\n   【强制规则D：字段设置】\n   ✅ 假冒者必须设置：isImposter: true, impersonatingHandle: "@被冒充角色句柄", impersonatingName: "被冒充角色名字"\n   ✅ 假冒者的isCharacterSeller必须为false（因为不是真实角色发布）\n\n   【强制规则E：语气模仿】\n   ✅ 假冒者的商品描述必须模仿被冒充角色的语气、用词风格和人设特点\n   ✅ 参考被冒充角色的【角色资料】中的性格、语气、专业领域\n   ✅ 但要略有瑕疵，避免完全一致（保持游戏性，让用户能分辨真假）\n   ✅ 瑕疵示例：用词稍显生硬、描述不够专业、语气略显刻意、细节不够准确、错别字\n   ✅ 示例对比：\n      * 真实店铺（专业摄影师）："经典徕卡M6胶片机，光圈准确，快门声音清脆，测光系统精准。"\n      * 假冒店铺（模仿但有瑕疵）："经典莱卡M6相机，光圈很准，快门很好，测光很准。"（用词重复、不够专业）\n   ✅ 假冒者的商品可以更低价、成色更差、描述更简单\n\n【商品示例参考】（仅作格式参考，实际生成需要根据世界观调整）：\n{\n  "title": "RETRO FILM CAMERA",\n  "seller": "@vintage_finds",\n  "sellerRating": "4.8",\n  "sellerSales": "234",\n  "price": "$145",\n  "status": "rare",\n  "image": "https://image.pollinations.ai/prompt/vintage%20film%20camera%20with%20leather%20case",\n  "imagePrompt": "vintage film camera with leather case",\n  "description": "经典胶片相机，配原装皮革相机包。85%新，快门正常，测光准确。适合摄影爱好者收藏使用。包含原厂说明书和背带。",\n  "specs": {\n    "condition": "Like New (85%)",\n    "location": "New York, US",\n    "shipping": "Free Shipping",\n    "posted": "2 days ago"\n  }\n}\n';f+=S,u=d.logTokenUsage("商品生成器","核心任务说明",S,u);const M='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨🚨🚨 JSON返回格式（100%强制遵守）🚨🚨🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n❌ 警告：你只能返回JSON，不能有任何其他文字！\n❌ 警告：JSON必须完美无误，任何语法错误都会导致系统崩溃！\n❌ 警告：所有字段都必须严格按照下面的格式填写！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n```json\n{\n  "products": [\n    {\n      "title": "商品名称（大写英文，2-4个单词）",\n      "seller": "@卖家用户名或店铺名（多样化，至少15-20个不同卖家）",\n      "isCharacterSeller": false,\n      "characterHandle": "",\n      "characterName": "",\n      "isImposter": false,\n      "impersonatingHandle": "",\n      "impersonatingName": "",\n      "sellerRating": "评分（3.5-5.0之间，一位小数）",\n      "sellerSales": "销量（20-9000之间的数字字符串）",\n      "price": "$价格（根据商品类型合理定价，不设上限）",\n      "status": "new/hot/rare（之一）",\n      "image": "https://image.pollinations.ai/prompt/英文描述%20with%20spaces（禁止人物词汇）",\n      "imagePrompt": "英文图片描述原文（与image的描述部分完全一致）",\n      "description": "详细中文描述，50-100字，包含材质、功能、特点、适用场景，必须与title和imagePrompt对应",\n      "specs": {\n        "condition": "商品成色（如：全新 / 99新 / 95新 / Like New 等）",\n        "location": "发货地点（城市, 国家/地区）",\n        "shipping": "配送方式（如：包邮 / Free Shipping / 到付 等）",\n        "posted": "发布时间（如：刚刚 / 2天前 / 1周前 等）"\n      }\n    }\n  ]\n}\n```\n\n🚨🚨🚨【强制性字段规则】（每一条都必须100%遵守）🚨🚨🚨\n\n❌❌❌ 违反任何一条都会导致系统崩溃！请逐条检查！❌❌❌\n\n1. ✅ 必须生成20-30个商品（至少20个，最多30个）\n2. ❌❌❌ image字段的英文描述必须和imagePrompt完全一致！一个字都不能差！\n3. ❌❌❌ 商品title、imagePrompt、description必须100%对应，不能张冠李戴！\n4. ✅ 卖家必须多样化，至少15-20个不同卖家，格式为 @username 或店铺名\n5. ✅ sellerRating：必须是字符串（不是数字！），范围3.5-5.0，一位小数（如"4.8"）\n6. ✅ sellerSales：必须是字符串（不是数字！），纯数字，范围20-2000（如"234"）\n7. ✅ price：必须是字符串，必须包含$符号，根据商品类型合理定价（如"$145"）\n8. ❌❌❌ status：只能是 new、hot、rare 三者之一，不能是其他值！\n9. ❌❌❌ imagePrompt：绝对不能包含任何人物词汇（person/people/human/face等）！\n10. ✅ description：必须是中文，50-100字，必须与title和imagePrompt对应\n11. ✅ specs.condition：商品成色，中英文均可\n12. ✅ specs.location：发货地点，同一店铺必须完全一致\n13. ✅ specs.shipping：配送方式，同一店铺必须完全一致\n14. ✅ specs.posted：发布时间，随机生成（刚刚/几小时前/几天前/1-2周前）\n\n🚨🚨🚨  15. **角色卖家字段规则**（最重要！违反=系统崩溃）🚨🚨🚨\n    ❌❌❌ isCharacterSeller：布尔值（true/false），不是字符串！\n    ❌❌❌ characterHandle：角色卖家填"@角色句柄"，普通卖家填空字符串""（不是null！）\n    ❌❌❌ characterName：角色卖家填"角色名字"，普通卖家填空字符串""（不是null！）\n    ❌❌❌ seller字段：角色卖家必须使用【角色店铺映射表】中的店铺名！不能自己编！\n    ❌❌❌ 同一角色的所有商品，seller/sellerRating/sellerSales/location/shipping必须完全一致！\n    ❌❌❌ 每个角色最多2个商品！不能超过2个！\n\n🚨🚨🚨 16. **假冒者字段规则**（严格控制数量）🚨🚨🚨\n    ❌❌❌ isImposter：布尔值（true/false），不是字符串！\n    ❌❌❌ impersonatingHandle：假冒者填"@被冒充角色句柄"，否则填空字符串""\n    ❌❌❌ impersonatingName：假冒者填"被冒充角色名字"，否则填空字符串""\n    ❌❌❌ 假冒者的isCharacterSeller必须为false！\n    ❌❌❌ 假冒者的seller必须是山寨店名（与真实店名相似但不同）！\n    ❌❌❌ 假冒者最多3-5个（不超过20%）！不要太多！\n\n17. ✅ 所有字段必填，不允许null或空值（空字符串""是允许的）\n18. ❌❌❌ **绝对禁止任何人物、人体部位相关词汇！**\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔥🔥🔥 最后检查清单（生成前必须检查）🔥🔥🔥\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n□ 商品数量：20-30个\n□ 每个角色最多2个商品\n□ 同一店铺信息完全一致（rating/sales/location/shipping）\n□ 假冒者不超过3-5个\n□ 图片URL没有人物词汇\n□ title、imagePrompt、description完全对应\n□ 所有字段类型正确（布尔值不是字符串，字符串不是数字）\n□ 角色卖家使用映射表中的店铺名\n□ JSON格式完美无误，没有语法错误\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';f+=M,u=d.logTokenUsage("商品生成器","JSON格式要求",M,u);const T=[{role:"user",content:"🚨 强制性指令 🚨\n\n你必须生成20-30个商城商品数据（至少20个，最多30个）。\n\n❌ 警告：必须100%严格遵守所有规则，任何违反都会导致系统崩溃！\n\n强制检查清单（生成前必须确认）：\n✅ 商品title、imagePrompt、description完全对应（不能张冠李戴）\n✅ 图片URL不包含任何人物词汇（person/people/human/face等）\n✅ 每个角色最多2个商品\n✅ 同一店铺的rating/sales/location/shipping完全一致\n✅ 角色卖家使用【角色店铺映射表】中的店铺名\n✅ 假冒者不超过3-5个\n✅ 所有字段类型正确（布尔值不是字符串）\n✅ JSON格式完美无误\n\n请现在生成，只返回纯JSON，不要任何解释。"}];d.logFinalPrompt("商品生成器",f,T[0].content),console.log("📤 [第十八情景] 正在向AI发送请求...");const A=await g.sendAIRequest({apiConfig:o,systemPrompt:f,messages:T,temperature:.8});console.log("📥 [第十八情景] AI响应已接收"),console.log("🔍 [第十八情景] 正在解析JSON数据...");let E=g.parseJSONResponse(A);if(console.log("✅ [第十八情景] JSON解析成功"),!E.products||!Array.isArray(E.products))throw new Error("AI返回的数据格式不正确，缺少products数组");E.products.length<20?console.warn(`⚠️ [第十八情景] 生成了${E.products.length}个商品，建议20-30个`):console.log(`✅ [第十八情景] 生成了${E.products.length}个商品`),console.log("🎁 [第十八情景] 商品示例:"),E.products.length>0&&console.log("  -",E.products[0].title,"/",E.products[0].price),E.products.length>1&&console.log("  -",E.products[1].title,"/",E.products[1].price),js=E.products.map((n,e)=>{if(!n.image||!n.image.includes("pollinations.ai")){const t=(n.imagePrompt||n.title).toLowerCase().replace(/ /g,"%20");n.image=`https://image.pollinations.ai/prompt/${t}`,console.warn(`⚠️ [第十八情景] 商品${e+1}图片URL不规范，已自动修正`)}return n.specs&&"object"==typeof n.specs?n.specs={condition:n.specs.condition||"Like New",location:n.specs.location||"New York, US",shipping:n.specs.shipping||"Free Shipping",posted:n.specs.posted||"2 days ago"}:(n.specs={condition:"Like New",location:"New York, US",shipping:"Free Shipping",posted:"2 days ago"},console.warn(`⚠️ [第十八情景] 商品${e+1}缺少specs字段，已自动补充`)),{title:n.title||`ITEM ${e+1}`,seller:n.seller||"@shop_vendor",isCharacterSeller:n.isCharacterSeller||!1,characterHandle:n.characterHandle||"",characterName:n.characterName||"",isImposter:n.isImposter||!1,impersonatingHandle:n.impersonatingHandle||"",impersonatingName:n.impersonatingName||"",sellerRating:n.sellerRating||"4.5",sellerSales:n.sellerSales||"100",price:n.price||"$99",status:n.status||"new",image:n.image,imagePrompt:n.imagePrompt||"",description:n.description||"High quality product.",specs:n.specs}}),console.log("🔍 [第十八情景] 正在检查店铺信息统一性...");const z={};let B=0;js.forEach((n,e)=>{const t=n.seller;z[t]||(z[t]={rating:n.sellerRating,sales:n.sellerSales,location:n.specs.location,shipping:n.specs.shipping,isCharacterSeller:n.isCharacterSeller,characterHandle:n.characterHandle,firstProductIndex:e})}),js.forEach((n,e)=>{const t=n.seller,o=z[t];n.sellerRating!==o.rating&&(console.warn(`  ⚠️ 修正商品${e+1}：卖家"${t}"评分不一致（${n.sellerRating} → ${o.rating}）`),n.sellerRating=o.rating,B++),n.sellerSales!==o.sales&&(console.warn(`  ⚠️ 修正商品${e+1}：卖家"${t}"销量不一致（${n.sellerSales} → ${o.sales}）`),n.sellerSales=o.sales,B++),n.specs.location!==o.location&&(console.warn(`  ⚠️ 修正商品${e+1}：卖家"${t}"发货地不一致（${n.specs.location} → ${o.location}）`),n.specs.location=o.location,B++),n.specs.shipping!==o.shipping&&(console.warn(`  ⚠️ 修正商品${e+1}：卖家"${t}"配送方式不一致（${n.specs.shipping} → ${o.shipping}）`),n.specs.shipping=o.shipping,B++),n.isCharacterSeller!==o.isCharacterSeller&&(console.warn(`  ⚠️ 修正商品${e+1}：卖家"${t}"角色标记不一致`),n.isCharacterSeller=o.isCharacterSeller,n.characterHandle=o.characterHandle,B++)}),B>0?console.log(`✅ [第十八情景] 店铺信息统一性检查完成，修正 ${B} 处不一致`):console.log("✅ [第十八情景] 店铺信息统一性检查通过，无需修正"),console.log("💾 [第十八情景] 正在保存数据到数据库..."),await t.xAccountProfiles.put({handle:m,products:js,generatedAt:(new Date).toISOString(),worldSetting:r||"现代都市背景"}),console.log("🏪 [第十八情景] 正在更新角色店铺映射表...");const L={};let P=0,D=0;js.forEach(n=>{if(n.isCharacterSeller&&n.characterHandle&&n.seller){const e=n.characterHandle,t=n.seller,o=n.sellerRating,a=n.sellerSales,i=n.specs?.location||"Unknown",r=n.specs?.shipping||"Standard",s=C[e];if(s)if("string"==typeof s){const n={storeName:s,rating:o,sales:a,location:i,shipping:r,updatedAt:(new Date).toISOString()};C[e]=n,D++,console.log(`  🔄 升级店铺信息：${e} → "${s}"`),console.log(`     添加评分：${o}，销量：${a}，发货地：${i}`)}else{const n=parseFloat(s.rating),t=parseFloat(o),i=parseInt(s.sales),r=parseInt(a);Math.abs(t-n)<=.3&&Math.abs(r-i)<=100&&(C[e].rating=o,C[e].sales=a,C[e].updatedAt=(new Date).toISOString(),D++,console.log(`  🔄 更新店铺数据：${e} → 评分 ${n}→${t}，销量 ${i}→${r}`))}else{const n={storeName:t,rating:o,sales:a,location:i,shipping:r,createdAt:(new Date).toISOString()};L[e]=n,C[e]=n,P++,console.log(`  ✨ 新增店铺映射：${e} → "${t}"`),console.log(`     评分：${o}，销量：${a}，发货地：${i}`)}}}),P>0||D>0?(await t.xAccountProfiles.put({handle:k,storeNames:C,updatedAt:(new Date).toISOString()}),P>0&&D>0?console.log(`✅ [第十八情景] 角色店铺映射已更新：新增 ${P} 个，更新 ${D} 个`):P>0?console.log(`✅ [第十八情景] 角色店铺映射已更新：新增 ${P} 个`):console.log(`✅ [第十八情景] 角色店铺映射已更新：更新 ${D} 个`)):console.log("ℹ️ [第十八情景] 角色店铺映射无变化"),Hs=!0,Rs=!1,console.log("✅ [第十八情景] 商城商品初始化完成！"),console.log(`📦 [第十八情景] 共生成 ${js.length} 个商品`);const N=js.filter(n=>n.isImposter).length;return N>0&&console.log(`🎭 [第十八情景] 其中假冒者商品：${N} 个`),js}catch(n){throw console.error("❌ [第十八情景] 生成商品数据失败"),console.error("错误详情:",n),Rs=!1,console.log("⚠️ [第十八情景] 生成失败，等待用户手动触发重新生成"),Hs=!1,n}}},n.refreshShopProducts=_s,n.loadSavedShopProducts=Os,n.openShopItemModal=n.openShopItemModal||function(){},n.closeShopItemModal=n.closeShopItemModal||function(){},console.log("📦 商城模块已加载");let Gs={avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",nickname:"= =",prompt:"请向我匿名提问!waiting...",background:"https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg",answeredQuestions:[]},Ys=!1,Ws=new Set,Js=null;async function Ks(){try{const n=e(),t=vt||"main",o=`askbox_${t}`,a=await n.xAskbox.get(o);a?(Gs.id=a.id,Gs.avatar=a.avatar,Gs.nickname=a.nickname,Gs.prompt=a.prompt,Gs.background=a.background,Gs.answeredQuestions=a.answeredQuestions||[],console.log("✅ 提问箱数据已从数据库加载:",t,"提问数:",Gs.answeredQuestions.length)):(Gs.id=o,Gs.avatar="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",Gs.nickname="= =",Gs.prompt="请向我匿名提问!waiting...",Gs.background="https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg",Gs.answeredQuestions=[],await n.xAskbox.put({id:o,avatar:Gs.avatar,nickname:Gs.nickname,prompt:Gs.prompt,background:Gs.background,answeredQuestions:[]}),console.log("✅ 已为新账户创建默认提问箱数据:",t,"提问数: 0"))}catch(n){console.error("❌ 加载提问箱数据失败:",n)}}async function Qs(){try{const n=e(),t=vt||"main",o=`askbox_${t}`;Gs.id=o,await n.xAskbox.put(Gs),console.log("✅ 提问箱数据已保存到数据库:",t)}catch(n){console.error("❌ 保存提问箱数据失败:",n)}}async function Zs(){await Ks();const n=document.getElementById("askbox-avatar"),e=document.getElementById("askbox-nickname"),t=document.getElementById("askbox-prompt"),o=document.getElementById("askbox-background");n&&(n.src=Gs.avatar),e&&(e.textContent=Gs.nickname),t&&(t.textContent=Gs.prompt),o&&(o.style.backgroundImage=`url('${Gs.background}')`),nl()}function nl(){const n=document.getElementById("answered-questions-list"),e=document.getElementById("answered-questions-title");if(n){if(0===Gs.answeredQuestions.length)return e&&(e.style.display="none"),void(n.innerHTML='\n <div style="text-align: center; color: rgba(255,255,255,0.6); font-size: 14px; padding: 40px 20px; ">\n 暂无提问\n </div>\n ');e&&(e.style.display="block"),n.innerHTML=Gs.answeredQuestions.map((n,e)=>{const t=new Date(n.date).toLocaleDateString("zh-CN",{month:"short",day:"numeric"}),o=Ws.has(n.id);return`\n <div\n class="askbox-question-item"\n data-question-id="${n.id}"\n style="background-color: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.2s; ${o?"border: 3px solid var(--x-accent); background-color: color-mix(in srgb, var(--x-accent) , 0.1);":""}\n ${Ys?"border-left: 3px solid var(--x-accent);":""}\n "\n onmouseover="if(!${Ys}){this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)';}"\n onmouseout="if(!${Ys}){this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';}"\n onmousedown="startQuestionLongPress('${n.id}')"\n onmouseup="endQuestionLongPress()"\n onmouseleave="endQuestionLongPress()"\n ontouchstart="startQuestionLongPress('${n.id}')"\n ontouchend="endQuestionLongPress()"\n onclick="if(${Ys}){toggleQuestionSelection('${n.id}');event.stopPropagation();}"\n >\n\n <div style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); padding: 20px; color: #fff; ">\n <div style="font-size: 15px; line-height: 1.6; word-break: break-word;">\n ${n.question}\n </div>\n </div>\n\n <div style="background-color:#fff; padding: 20px; min-height: 60px; color: #333; ">\n <div id="answer-${n.id}"\n contenteditable="true"\n data-question-id="${n.id}"\n style="font-size: 14px; line-height: 1.6; word-break: break-word; outline: none; cursor: text; min-height: 20px; ${n.answer?"":"color: #999; text-align: center;"}\n "\n onblur="saveQuestionAnswer('${n.id}')"\n onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}"\n onfocus="if(this.textContent==='点击此处回复...'){this.textContent='';this.style.color='#333';this.style.textAlign='left';}">${n.answer||"点击此处回复..."}</div>\n </div>\n\n <div style="background-color: #f5f5f5; padding: 8px 20px; color: #999; font-size: 12px; text-align: right; ">\n ${t}\n </div>\n </div>\n`}).join("")}}function el(n){Ys||tl();const e=document.querySelector(`.askbox-question-item[data-question-id="${n}"]`);e&&(Ws.has(n)?(Ws.delete(n),e.style.border="",e.style.backgroundColor="rgba(255,255,255,0.9)"):(Ws.add(n),e.style.border="3px solid var(--x-accent)",e.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)"),al())}function tl(){Ys=!0,function(){let n=document.getElementById("askbox-delete-toolbar");n||(n=document.createElement("div"),n.id="askbox-delete-toolbar",n.style.cssText="\n position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 24px; padding: 12px 20px; display: flex; align-items: center; gap: 16px; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); ",n.innerHTML='\n <button onclick="selectAllQuestions()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#1a8cd8\'" onmouseout="this.style.backgroundColor=\'var(--x-accent)\'">\n 全选\n </button>\n <span id="askbox-selected-count" style="color: #fff; font-size: 14px; font-weight: 500;">已选择 0 个</span>\n <button onclick="deleteSelectedQuestions()" style="background-color: #f91880; color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'#d0155f\'" onmouseout="this.style.backgroundColor=\'#f91880\'">\n 删除\n </button>\n <button onclick="exitAskboxMultiSelectMode()" style="background-color: rgba(255,255,255,0.15); color: #fff; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor=\'rgba(255,255,255,0.25)\'" onmouseout="this.style.backgroundColor=\'rgba(255,255,255,0.15)\'">\n 取消\n </button>\n ',document.body.appendChild(n));n.style.display="flex"}(),document.querySelectorAll(".askbox-question-item").forEach(n=>{n.style.borderLeft="3px solid var(--x-accent)"}),console.log("✅ 已进入提问箱多选模式")}function ol(){Ys=!1,Ws.clear(),function(){const n=document.getElementById("askbox-delete-toolbar");n&&(n.style.display="none")}(),document.querySelectorAll(".askbox-question-item").forEach(n=>{n.style.border="",n.style.borderLeft="",n.style.backgroundColor="rgba(255,255,255,0.9)"}),console.log("✅ 已退出提问箱多选模式")}function al(){const n=document.getElementById("askbox-selected-count");n&&(n.textContent=`已选择 ${Ws.size} 个`)}function il(n){Rn[Hn]||Rn.zh;const e=document.createElement("div");e.className="mention-item",e.dataset.mentionId=n.id,e.style.cssText="\n display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--x-border-color); cursor: pointer; transition: background-color 0.2s; user-select: none; -webkit-user-select: none;\n";let t=!1,o=!0;const a=a=>{rl||(t=!1,o=!0,cl=!0,ll=setTimeout(()=>{if(cl&&!t){o=!1,dl();const t=e.querySelector(".mention-checkbox");t&&gl(n.id,t)}},500))},i=()=>{cl=!1,ll&&(clearTimeout(ll),ll=null)};e.addEventListener("touchstart",a,{passive:!0}),e.addEventListener("touchend",i),e.addEventListener("touchmove",()=>{t=!0,i()}),e.addEventListener("touchcancel",i),e.addEventListener("mousedown",a),e.addEventListener("mouseup",i),e.addEventListener("mouseleave",i),e.onmouseover=()=>{rl||(e.style.backgroundColor="var(--x-bg-hover)")},e.onmouseout=()=>{e.style.backgroundColor="transparent"},e.onclick=()=>{!rl&&o&&async function(n){try{const e=n=>({comments:n?.comments||0,retweets:n?.retweets||0,likes:n?.likes||0,views:n?.views||0}),t={id:n.id||`retweet_${Date.now()}`,user:n.user||{name:"未知用户",handle:"@unknown",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:n.retweetContent||"",time:n.time||"刚刚",timestamp:n.timestamp||Date.now(),stats:e(n.stats),quotedTweet:{type:"tweet",user:n.quotedTweet?.user||{name:"未知用户",handle:"@unknown",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:n.quotedTweet?.content||"",time:n.quotedTweet?.time||"刚刚",image:n.quotedTweet?.image||null,stats:e(n.quotedTweet?.stats)},comments:n.comments||[],_source:"retweet_mention"};console.log("📝 [转帖详情] 数据已准备:",t),await io(t)}catch(n){console.error("显示转帖详情失败:",n),mn("无法显示转帖详情","error")}}(n)};const r=document.createElement("div");r.style.cssText="width: 40px; display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0;";r.innerHTML='<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--x-accent);"><g><path d="M4.75 3.79l4.603 4.3-1.706 1.82L6 8.38v7.37c0 .97.784 1.75 1.75 1.75H13V20H7.75c-2.347 0-4.25-1.9-4.25-4.25V8.38L1.853 9.91.147 8.09l4.603-4.3zm11.5 2.71H11V4h5.25c2.347 0 4.25 1.9 4.25 4.25v7.37l1.647-1.53 1.706 1.82-4.603 4.3-4.603-4.3 1.706-1.82L18 15.62V8.25c0-.97-.784-1.75-1.75-1.75z"></path></g></svg>';const s=document.createElement("div");s.style.cssText="flex: 1; min-width: 0;";let l=`<div style="margin-bottom: 8px;"><img src="${n.user.avatar}" alt="${n.user.name}" style="width: 32px; height: 32px; border-radius: 50%;"></div>`,c="";return c="zh"===Hn?`${n.user.name} 转推了你的推文`:`${n.user.name} retweeted your post`,s.innerHTML=`\n ${l}\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 4px;">\n ${c}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 14px; margin-bottom: 12px;">\n ${n.time}\n </div>\n <div style="padding: 12px; border: 1px solid var(--x-border-color); border-radius: 12px;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; margin-bottom: 8px;">\n ${R(n.retweetContent)}\n </div>\n <div style="padding: 12px; border-left: 3px solid var(--x-border-color); background-color:var(--x-bg-secondary); border-radius: 4px;">\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-bottom: 4px;">\n ${n.quotedTweet.user.name} ${n.quotedTweet.user.handle}\n </div>\n <div style="color:var(--x-text-primary); font-size: 14px; line-height: 1.3;">\n ${n.quotedTweet.content.substring(0,100)}${n.quotedTweet.content.length>100?"...":""}\n </div>\n </div>\n </div>\n`,e.appendChild(r),e.appendChild(s),e}let rl=!1,sl=new Set,ll=null,cl=!1;function dl(){rl=!0,sl.clear(),function(){const n=document.getElementById("mentions-delete-toolbar");n&&n.remove();const e=document.createElement("div");e.id="mentions-delete-toolbar",e.style.cssText="\n position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--x-bg-primary); border: 1px solid var(--x-border-color); border-radius: 24px; padding: 12px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideUp 0.3s ease;\n",e.innerHTML='\n <button id="mentions-select-all-btn" style="background: transparent; border: none; color: var(--x-accent); font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s; ">全选</button>\n <div style="width: 1px; height: 24px; background: var(--x-border-color);"></div>\n <button id="mentions-delete-btn" style="background: transparent; border: none; color:var(--x-text-secondary); font-size: 15px; font-weight: 600; cursor: not-allowed; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; ">删除 (0)</button>\n <div style="width: 1px; height: 24px; background: var(--x-border-color);"></div>\n <button id="mentions-cancel-btn" style="background: transparent; border: none; color:var(--x-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: background-color 0.2s; ">取消</button>\n',document.body.appendChild(e),document.getElementById("mentions-select-all-btn").onclick=xl,document.getElementById("mentions-delete-btn").onclick=ul,document.getElementById("mentions-cancel-btn").onclick=pl;e.querySelectorAll("button").forEach(n=>{n.onmouseover=()=>{("mentions-delete-btn"!==n.id||sl.size>0)&&(n.style.backgroundColor="var(--x-bg-hover)")},n.onmouseout=()=>{n.style.backgroundColor="transparent"}})}();document.querySelectorAll(".mention-item").forEach(n=>{n.style.paddingLeft="56px";const e=document.createElement("div");e.className="mention-checkbox",e.style.cssText="\n position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: 2px solid var(--x-border-color); border-radius: 50%; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; ",n.style.position="relative",n.insertBefore(e,n.firstChild),e.onclick=t=>{t.stopPropagation();gl(n.dataset.mentionId,e)}}),console.log("✅ 进入 Mentions 删除模式")}function pl(){rl=!1,sl.clear(),function(){const n=document.getElementById("mentions-delete-toolbar");n&&n.remove()}();document.querySelectorAll(".mention-checkbox").forEach(n=>n.remove());document.querySelectorAll(".mention-item").forEach(n=>{n.style.paddingLeft="16px"}),console.log("✅ 退出 Mentions 删除模式")}function gl(n,e){sl.has(n)?(sl.delete(n),e.style.backgroundColor="transparent",e.innerHTML=""):(sl.add(n),e.style.backgroundColor="var(--x-accent)",e.style.borderColor="var(--x-accent)",e.innerHTML='<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><g><path d="M9 20l-7-7 1.41-1.41L9 17.17l11.59-11.58L22 7z"></path></g></svg>'),ml()}function ml(){const n=document.getElementById("mentions-delete-btn"),e=document.getElementById("mentions-select-all-btn");if(n){const e=sl.size;n.textContent=`删除 (${e})`,e>0?(n.style.color="#f4212e",n.style.cursor="pointer"):(n.style.color="var(--x-text-secondary)",n.style.cursor="not-allowed")}if(e){const n=document.querySelectorAll(".mention-item");sl.size===n.length&&n.length>0?e.textContent="取消全选":e.textContent="全选"}}function xl(){const n=document.querySelectorAll(".mention-item");document.getElementById("mentions-select-all-btn");if(sl.size===n.length){sl.clear();document.querySelectorAll(".mention-checkbox").forEach(n=>{n.style.backgroundColor="transparent",n.style.borderColor="var(--x-border-color)",n.innerHTML=""})}else n.forEach(n=>{const e=n.dataset.mentionId;sl.add(e);const t=n.querySelector(".mention-checkbox");t&&(t.style.backgroundColor="var(--x-accent)",t.style.borderColor="var(--x-accent)",t.innerHTML='<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;"><g><path d="M9 20l-7-7 1.41-1.41L9 17.17l11.59-11.58L22 7z"></path></g></svg>')});ml()}function ul(){if(0===sl.size)return;const n=sl.size;confirm("zh"===Hn?`确定要删除 ${n} 条通知吗？此操作不可恢复。`:`Delete ${n} notification${n>1?"s":""}? This action cannot be undone.`)&&async function(){try{const n=e(),t=`mentions_${vt||"main"}`,o=await n.xAccountProfiles.get(t);if(o&&o.data){const e=Array.from(sl);o.data=o.data.filter(n=>!e.includes(n.id)),await n.xAccountProfiles.put(o),console.log(`✅ 已删除 ${e.length} 条 Mentions 通知`),mn(`已删除 ${e.length} 条通知`,"success"),pl(),await bl()}}catch(n){console.error("❌ 删除 Mentions 通知失败:",n),mn("删除失败: "+n.message,"error")}}()}n.switchNotificationTab=function(n){const e=document.querySelectorAll(".notification-tab"),t=document.getElementById("notifications-all-content"),o=document.getElementById("notifications-mentions-content"),a=document.getElementById("refresh-messages-btn");rl&&pl(),e.forEach(e=>{"all"===n&&(e.textContent.includes("全部")||e.textContent.includes("All"))||"mentions"===n&&(e.textContent.includes("提及")||e.textContent.includes("Mentions"))?(e.classList.add("active"),e.style.color="var(--x-text-primary)",e.style.backgroundColor="transparent",e.querySelector(".tab-indicator").style.display="block"):(e.classList.remove("active"),e.style.color="var(--x-text-secondary)",e.style.backgroundColor="transparent",e.querySelector(".tab-indicator").style.display="none")}),"all"===n?(t.style.display="flex",o.style.display="none",a&&(a.style.display="flex")):(t.style.display="none",o.style.display="flex",a&&(a.style.display="none"))};const hl=[];function fl(n){const e=Rn[Hn]||Rn.zh,t=document.createElement("div");t.className="mention-item",t.dataset.mentionId=n.id,t.style.cssText="\n display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--x-border-color); cursor: pointer; transition: background-color 0.2s;\n";let o=null;const a=e=>{rl||(o=setTimeout(()=>{dl();const e=t.querySelector(".mention-checkbox");e&&gl(n.id,e),navigator.vibrate&&navigator.vibrate(50)},500))},i=()=>{o&&(clearTimeout(o),o=null)};t.addEventListener("touchstart",a),t.addEventListener("touchend",i),t.addEventListener("touchmove",i),t.addEventListener("mousedown",a),t.addEventListener("mouseup",i),t.addEventListener("mouseleave",i),"newTweet"===n.type&&n.tweet&&(t.onclick=()=>{rl||async function(n){try{console.log("📝 [New Tweet详情] 准备显示推文详情:",n);const e=n=>({comments:n?.comments||0,retweets:n?.retweets||0,likes:n?.likes||0,views:n?.views||0}),t={id:n.tweet.id||`newtweet_${Date.now()}`,user:n.tweet.user||n.user||{name:"未知用户",handle:"@unknown",avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",verified:!1},content:n.tweet.content||"",time:n.tweet.time||"刚刚",timestamp:n.tweet.timestamp||n.timestamp||Date.now(),image:n.tweet.image||null,stats:e(n.tweet.stats),comments:(n.tweet.comments||[]).map(n=>({...n,stats:e(n.stats)})),_source:"newtweet_mention",_mentionId:n.id};console.log("📝 [New Tweet详情] 数据已准备，包含 %d 条评论",t.comments.length),await io(t)}catch(n){console.error("显示 New Tweet 详情失败:",n),mn("无法显示推文详情","error")}}(n)}),t.onmouseover=()=>{t.style.backgroundColor="var(--x-bg-hover)"},t.onmouseout=()=>{t.style.backgroundColor="transparent"};const r=document.createElement("div");r.style.cssText="width: 40px; display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0;";let s="",l="";switch(n.type){case"newTweet":l="var(--x-accent)",s=`<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${l};"><g><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></g></svg>`;break;case"like":l="var(--x-accent)",s=`<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${l};"><g><path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>`;break;case"retweet":l="var(--x-accent)",s=`<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${l};"><g><path d="M4.75 3.79l4.603 4.3-1.706 1.82L6 8.38v7.37c0 .97.784 1.75 1.75 1.75H13V20H7.75c-2.347 0-4.25-1.9-4.25-4.25V8.38L1.853 9.91.147 8.09l4.603-4.3zm11.5 2.71H11V4h5.25c2.347 0 4.25 1.9 4.25 4.25v7.37l1.647-1.53 1.706 1.82-4.603 4.3-4.603-4.3 1.706-1.82L18 15.62V8.25c0-.97-.784-1.75-1.75-1.75z"></path></g></svg>`;break;case"reply":l="var(--x-accent)",s=`<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${l};"><g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g></svg>`;break;case"follow":l="var(--x-accent)",s=`<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${l};"><g><path d="M17.863 13.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44zM12 2C9.791 2 8 3.79 8 6s1.791 4 4 4 4-1.79 4-4-1.791-4-4-4z"></path></g></svg>`}r.innerHTML=s;const c=document.createElement("div");c.style.cssText="flex: 1; min-width: 0;";let d='<div style="display: flex; gap: 4px; margin-bottom: 8px;">';"newTweet"===n.type?n.user&&(d+=`<img src="${n.user.avatar}" alt="${n.user.name}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--x-bg-primary);">`):n.users&&n.users.length>0&&(d+=`<img src="${n.users[0].avatar}" alt="${n.users[0].name}" style="width: 32px; height: 32px; border-radius: 50%;">`),d+="</div>";let p="";if("newTweet"===n.type){if(n.user){const e=n.user.name;p="zh"===Hn?`${e} 发布了新推文`:`New Tweet from ${e}`}}else if(n.users&&n.users.length>0){const t=n.users[0].name,o=(n.users.length>1&&n.users[1].name,n.users.length>2?n.users.length-2:0);"like"===n.type?p="zh"===Hn?`${t} 喜欢了你的推文`:`${t} ${e.notificationsLiked}`:"retweet"===n.type?p="zh"===Hn?`${t}${o>0?` 和其他 ${o} 人`:""} 转推了推文`:`${t}${o>0?` and ${o} others`:""} ${e.notificationsRetweeted}`:"reply"===n.type?p="zh"===Hn?`${t} 回复了你`:`${t} ${e.notificationsReplied}`:"follow"===n.type&&(p="zh"===Hn?`${t} 关注了你`:`${t} ${e.notificationsFollowed}`)}let g="";if(n.tweet){let e="";if(n.tweet.image)if("object"==typeof n.tweet.image&&"description"===n.tweet.image.type)e=`\n <div style="margin-top: 8px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; box-sizing: border-box;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; width: 100%; box-sizing: border-box;">${n.tweet.image.content}</div>\n </div>\n `;else{e=`<img src="${"string"==typeof n.tweet.image?n.tweet.image:n.tweet.image.url}" style="width: 100%; border-radius: 12px; margin-top: 8px;">`}g=`\n <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--x-border-color); border-radius: 12px;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; margin-bottom: ${n.tweet.image?"8px":"0"};">\n ${n.tweet.content}\n </div>\n ${e}\n </div>\n `}const m=n.timestamp?Z(n.timestamp):n.time;return c.innerHTML=`\n ${d}\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 4px;">\n ${p}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 14px;">\n ${m}\n </div>\n ${g}\n`,t.appendChild(r),t.appendChild(c),t}async function bl(){const n=document.getElementById("notifications-all-list"),t=document.getElementById("notifications-mentions-list");if(!n)return;const o=Rn[Hn]||Rn.zh;try{const n=e(),t=`strangerMessages_${vt||"main"}`,o=await n.xAccountProfiles.get(t);o&&o.data&&Array.isArray(o.data)&&(hl.length=0,hl.push(...o.data),console.log("✅ 从数据库加载了",hl.length,"条陌生人私信"))}catch(n){console.error("加载陌生人私信数据失败:",n)}n.innerHTML="",t.innerHTML="",hl.length>0?hl.forEach(e=>{const t=function(n){Rn[Hn]||Rn.zh;const e=document.createElement("div");e.className="stranger-message-item",e.style.cssText="\n display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--x-border-color); cursor: pointer; transition: background-color 0.2s;\n",e.onmouseover=()=>{e.style.backgroundColor="var(--x-bg-hover)"},e.onmouseout=()=>{e.style.backgroundColor="transparent"},e.onclick=()=>{openMessageDetail(n)};const t=document.createElement("div");t.style.cssText="width: 40px; display: flex; align-items: flex-start; justify-content: flex-end; flex-shrink: 0;",t.innerHTML='<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--x-accent);"><g><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></g></svg>';const o=document.createElement("div");o.style.cssText="flex: 1; min-width: 0;";let a=`\n <img src="${n.user.avatar}"\n alt="${n.user.name}"\n style="width: 32px; height: 32px; border-radius: 50%; margin-bottom: 8px;">\n <div style="color:var(--x-text-secondary); font-size: 15px; margin-bottom: 4px;">\n In case you missed <strong style="color:var(--x-text-primary);">${n.user.name}</strong>'s Message\n </div>\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; margin-bottom: 8px; font-weight: 500;">\n ${n.preview}\n </div>\n ${n.link?`<div style="color: var(--x-accent); font-size: 15px; margin-bottom: 8px;">${n.link}</div>`:""}\n ${n.attachment?`<div style="color: var(--x-accent); font-size: 15px; margin-bottom: 8px;">${n.attachment}</div>`:""}\n ${n.tweetLink?`<div style="color: var(--x-accent); font-size: 15px;">${n.tweetLink}</div>`:""}\n`;return o.innerHTML=a,e.appendChild(t),e.appendChild(o),e}(e);n.appendChild(t)}):n.innerHTML='\n <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 32px; text-align: center;">\n <svg viewBox="0 0 24 24" style="width: 56px; height: 56px; fill: var(--x-text-secondary); margin-bottom: 16px;">\n <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>\n </svg>\n <div style="font-size: 28px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px;">暂无陌生人私信</div>\n <div style="font-size: 14px; color:var(--x-text-secondary); max-width: 320px;">点击右下角羽毛笔按钮生成新的陌生人私信</div>\n </div>\n ';let a=[];try{const n=e(),t=`mentions_${vt||"main"}`,o=await n.xAccountProfiles.get(t);o&&o.data&&Array.isArray(o.data)&&(a=o.data,console.log("✅ 从数据库加载了",a.length,"条Mentions通知"))}catch(n){console.error("加载Mentions通知失败:",n)}a.length>0?(a.sort((n,e)=>(e.timestamp||0)-(n.timestamp||0)),a.forEach(n=>{let e;e="like"===n.type?function(n){Rn[Hn]||Rn.zh;const e=document.createElement("div");e.className="mention-item",e.dataset.mentionId=n.id,e.style.cssText="\n display: flex; gap: 12px; padding: 16px; border-bottom: 1px solid var(--x-border-color); cursor: pointer; transition: background-color 0.2s; user-select: none; -webkit-user-select: none;\n";let t=!1;const o=o=>{rl||(t=!1,cl=!0,ll=setTimeout(()=>{if(cl&&!t){dl();const t=e.querySelector(".mention-checkbox");t&&gl(n.id,t)}},500))},a=()=>{cl=!1,ll&&(clearTimeout(ll),ll=null)};e.addEventListener("touchstart",o,{passive:!0}),e.addEventListener("touchend",a),e.addEventListener("touchmove",()=>{t=!0,a()}),e.addEventListener("touchcancel",a),e.addEventListener("mousedown",o),e.addEventListener("mouseup",a),e.addEventListener("mouseleave",a),e.onmouseover=()=>{rl||(e.style.backgroundColor="var(--x-bg-hover)")},e.onmouseout=()=>{e.style.backgroundColor="transparent"};const i=document.createElement("div");i.style.cssText="width: 40px; display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0;",i.innerHTML='<svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: var(--x-accent);"><g><path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></g></svg>';const r=document.createElement("div");r.style.cssText="flex: 1; min-width: 0;";let s='<div style="display: flex; gap: 4px; margin-bottom: 8px;">';n.users.slice(0,3).forEach(n=>{s+=`<img src="${n.avatar}" alt="${n.name}" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--x-bg-primary);">`}),s+="</div>";const l=n.users[0].name,c=n.users.length>1?n.users[1].name:"",d=n.othersCount||0;let p="";p="zh"===Hn?`${l}${c?` ${c}`:""}${d>0?` 和其他 ${d} 人`:""} 喜欢了你的推文`:`${l}${c?` ${c}`:""}${d>0?` and ${d} others`:""} liked your post`;let g="";n.tweet&&(g=`\n <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--x-border-color); border-radius: 12px;">\n <div style="color:var(--x-text-primary); font-size: 15px; line-height: 1.4; margin-bottom: ${n.tweet.image?"8px":"0"};">\n ${n.tweet.content}\n </div>\n ${n.tweet.image?'<div style="color:var(--x-text-secondary); font-size: 13px; margin-top: 8px;">[图片]</div>':""}\n </div>\n `);const m=n.timestamp?Z(n.timestamp):n.time;return r.innerHTML=`\n ${s}\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 4px;">\n ${p}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 14px;">\n ${m}\n </div>\n ${g}\n`,e.appendChild(i),e.appendChild(r),e}(n):"retweet"===n.type?il(n):fl(n),t.appendChild(e)})):t.innerHTML=`\n <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 32px; text-align: center;">\n <svg viewBox="0 0 24 24" style="width: 56px; height: 56px; fill: var(--x-text-secondary); margin-bottom: 16px;">\n <g><path d="M1.751 10c0-4.42 3.584-8.005 8.005-8.005h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.005zm8.005-6.005c-3.317 0-6.005 2.69-6.005 6.005 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></g>\n </svg>\n <div style="font-size: 28px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px;">${o.notificationsEmpty}</div>\n <div style="font-size: 14px; color:var(--x-text-secondary); max-width: 320px;">${o.notificationsEmptyDesc}</div>\n </div>\n`}async function vl(e,t=!1,o={}){try{const a=o.isAutoMessage||!1,i=o.timeSinceLastMessage||0,r=o.isAskboxViewed||!1,l=o.askboxContent||"",c=o.businessTaskEvaluation||null,p=o.isUnblockRequest||!1,m=o.unblockContext||null,x=o.liveUserData||null,u=o.isStreamerContact||!1,h=o.streamerContactData||null,{apiConfig:f,xSettings:b,xDb:v}=await g.loadConfigAndSettings();let y="stranger",w=null,k=null;e.id&&(e.id.startsWith("msg_account_")?(y="account",Sn&&Sn.accountInfo&&(k=Sn.accountInfo.handle.replace("@",""))):e.id.startsWith("msg_")&&"msg_001"!==e.id&&(y="character",w=e.id.replace("msg_",""))),console.log(`📨 私信类型: ${y}`,{characterId:w,accountHandle:k}),!e.user&&e.userName&&(e.user={name:e.userName,handle:e.userHandle,avatar:e.userAvatar,verified:e.verified||!1});let $=[];if(t){const n=`messageConversation_${vt||"main"}_${e.id}`,t=await v.xAccountProfiles.get(n);t&&t.data&&t.data.messages?($=t.data.messages,console.log(`📖 [私信生成器] 读取到 ${$.length} 条现有对话记录`)):console.log("📖 [私信生成器] 无现有对话记录（首次对话）")}let C=null;if(t&&$.length>0){const n=$.filter(n=>"transfer"===n.type&&n.isBusiness&&"in_progress"===n.taskStatus);n.length>0&&(C=n[n.length-1],console.log("💼 [商业转账] 检测到进行中的任务，接收方: "+(C.isOwn?"AI":"用户")))}const{userPrompt:I,worldSetting:S}=b,M=s.buildUserXProfileInfo(n.userProfileData),T=`userTweets_${vt||"main"}`,A=await v.xUserTweets.get(T),E=A?.tweets?.slice(0,5)||[];let z=0,B=s.buildBaseSystemPrompt({userPrompt:I,worldSetting:S});z=d.logTokenUsage("私信详情生成器","基础系统提示词",B,z);const L=new Date,P=new Date(L.getTime()+288e5),D=P.getUTCFullYear(),N=P.getUTCMonth()+1,R=P.getUTCDate(),H=P.getUTCHours(),j=P.getUTCMinutes(),U=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][P.getUTCDay()];let O="";O=H>=5&&H<9?"清晨":H>=9&&H<12?"上午":H>=12&&H<14?"中午":H>=14&&H<18?"下午":H>=18&&H<22?"晚上":"深夜",B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 当前时间信息 ⏰\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前时间（北京时间）：${D}年${N}月${R}日 ${U} ${String(H).padStart(2,"0")}:${String(j).padStart(2,"0")}\n时段：${O}\n**请根据当前时间生成符合时间情境的回复**：\n- 如果是清晨或上午，可以问候早安、讨论早餐或一天的计划\n- 如果是中午，可以讨论午餐或午休\n- 如果是下午，可以讨论工作或下午茶\n- 如果是晚上，可以问候晚安、讨论晚餐或晚间活动\n- 如果是深夜，考虑为什么还没睡或深夜的话题\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,z=d.logTokenUsage("私信详情生成器","时间信息",B.substring(B.lastIndexOf("⏰ 当前时间信息")),z);const _={boundCharacters:[]};"character"===y&&w?_.boundCharacters=[w]:"account"===y&&(_.boundCharacters=[]);const F=await s.getApplicableWorldBooks("messages",_);F&&(B+=F,z=d.logTokenUsage("私信详情生成器","世界书内容",F,z));const X=await bn("私信详情生成器",{usageRate:.15,usageDescription:'**私信对话场景的大事件使用**：\n1. **话题引入**：角色可能在私信中提及最近的大事件，作为聊天话题\n   - "你看到最近的XXX了吗？"\n   - "今天XXX闹得挺大，你怎么看？"\n2. **情绪影响**：大事件可能影响角色的情绪和状态\n   - 如果是灾难事件，角色可能表现出担忧、悲伤\n   - 如果是好事，角色可能表现出兴奋、开心\n3. **生活影响**：大事件可能影响角色的日常生活\n   - 天气事件影响出行计划\n   - 政策事件影响工作安排\n4. **轻度关联**：私信是私密对话，大事件只是背景话题，不会过分强调\n5. **自然融入**：只有约15%的私信涉及大事件，保持对话的私密性和个人化'});if(X&&(B+=X,z=d.logTokenUsage("私信详情生成器","世界运转大事件",X,z)),t)if("character"===y){if(r)B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（提问箱查看模式 - 角色私信）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。角色发现用户查看了自己的提问箱，现在主动发送私信。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- 🔍 角色${e.user.name}发现用户偷看了TA的提问箱\n- 📝 用户刚刚查看了以下提问箱内容：\n${l}\n**角色信息**：\n- 角色名：${e.user.name}\n- 角色句柄：${e.user.handle}\n- 这是一个已绑定的角色，有完整的人设、记忆和X平台资料\n**重要规则**：\n- 🚨 只生成角色${e.user.name}的主动消息，不要生成用户的消息\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n- 📖 **必须参考下方的【X平台私信对话记录】**，了解你们之前的对话内容，保持对话的连贯性和一致性\n- 角色知道用户查看了TA的提问箱，可以调侃、好奇或关心用户为什么要看\n- 可以结合提问箱的内容展开话题，询问用户的想法或意见\n- 生成1-8条符合角色性格的主动消息\n- 回复要严格符合角色的性格、说话风格和与用户的关系\n- 可以表现出：发现被偷看的惊讶、调皮、害羞、好奇等情绪（根据角色性格）\n- 结合之前的X平台私信对话记录和提问箱内容，保持一致性\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、文章链接（link：需要title、description、author、source、body完整正文）、转发推文、转发主页\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！link类型是文章链接，需要包含完整的文章内容\n- ⚠️ 禁止生成forward类型消息（这是用户手动转发产生的）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;else if(a){const n=o.likedTweetContext,t=n&&n.content;if(c&&c.isBusinessTaskEvaluation){const n=c.tweetData,t=c.businessTransfer,o=n.stats?.likes||0,a=n.stats?.retweets||0,i=n.stats?.comments||0,r=n.stats?.views||0;B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💼 核心任务说明（商业任务评估模式 - 角色私信）💼\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。角色雇佣了用户完成商业推广任务，现在评估任务完成情况并决定付款。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- 💼 角色${e.user.name}之前发起了商业转账\n- ✅ 用户已完成任务，发布了商业化推贴\n- 🤖 角色现在要评估任务完成情况，并决定如何付款\n**商业转账信息**：\n- 总金额：$${parseFloat(t.amount).toFixed(2)}\n- 已支付定金：$${parseFloat(t.depositAmount).toFixed(2)} (${t.depositRatio}%)\n- 待付尾款：$${parseFloat(t.remainingAmount).toFixed(2)}\n- 任务要求：${t.taskDescription}\n- 任务期限：${t.taskDeadlineHours}小时\n**用户完成的推贴内容**：\n- 推文内容："${n.content}"\n${n.image?`- 包含图片：${"description"===n.image.type?n.image.content:"已上传图片"}`:""}\n${n.location?`- 位置：${n.location}`:""}\n- 发布时间：${n.time||"刚刚"}\n**推文数据表现**：\n- 👍 喜欢数：${o}\n- 🔄 转发数：${a}\n- 💬 评论数：${i}\n- 👀 浏览量：${r}\n**评论区反馈**：\n${n.comments&&n.comments.length>0?n.comments.slice(0,5).map((n,e)=>`${e+1}. ${n.user.name}: "${n.content}"`).join("\n"):"暂无评论"}\n**用户公众身份**：\n- 用户名：${M.name}\n- 用户句柄：${M.handle}\n- 认证状态：${M.verified?"已认证":"未认证"}\n${M.publicIdentity?`- 公众身份：${M.publicIdentity}`:""}\n- 粉丝影响力：${M.publicIdentity?"有一定影响力":"普通用户"}\n**评估规则**：\n🎯 你需要根据以下标准评估任务完成情况：\n1. **内容质量**（40%）：\n- 推文是否符合任务要求？\n- 表达是否自然，不是生硬的广告？\n- 是否包含了要求的关键信息？\n2. **数据表现**（30%）：\n- 推文的互动数据（喜欢、转发、评论、浏览量）如何？\n- 与用户的粉丝基础相匹配吗？\n- 评论区反馈是否正面？\n3. **用户影响力**（30%）：\n- 用户的公众身份和影响力如何？\n- 认证状态是否增加可信度？\n- 是否值得额外投资？\n**付款决策**：\n根据评估结果，你需要决定：\n✅ **满意（80-100分）**：\n- 支付全额尾款 + 额外10-30%奖励\n- 示例：总额$200，定金$40，尾款$160，额外奖励$20-60\n- 在回复中表达满意，感谢合作，期待下次合作\n👍 **中规中矩（60-79分）**：\n- 支付全额尾款，无额外奖励\n- 示例：总额$200，定金$40，尾款$160\n- 在回复中表示认可，指出可以改进的地方\n😐 **不满意但可接受（40-59分）**：\n- 支付50-80%的尾款\n- 示例：总额$200，定金$40，尾款$160，实际支付$80-128\n- 在回复中指出不足，表达轻微失望\n❌ **非常不满意（<40分）**：\n- 不支付尾款或仅支付20-40%\n- 示例：总额$200，定金$40，尾款$160，实际支付$0-64\n- 在回复中明确指出问题，表达不满\n**重要规则**：\n- 🚨 只生成角色${e.user.name}的评估消息，不要生成用户的消息\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n- 💰 **必须发送转账消息支付尾款**（amount为尾款金额，note说明付款原因）\n- 📖 参考下方的【X平台私信对话记录】，保持对话的连贯性\n- 🎭 评估要符合角色性格，有的角色很大方，有的很挑剔\n- 💬 生成1-3条文本消息说明评估结果，然后发送转账\n- ⚠️ 转账消息的note要说明是尾款、奖励还是扣款\n**消息示例结构**：\n1. 文本消息：评估内容质量\n2. 文本消息（可选）：评估数据表现\n3. 转账消息：支付尾款（必须）\n4. 文本消息（可选）：感谢或建议\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}else{const a=o.isAwayReturn||!1;B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（自动发消息模式 - 角色私信）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。角色主动发起私信（后台自动活动）。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n${a?`- 🔙 **特殊情况：离开后返回**\n- 角色${e.user.name}之前因为有事暂时离开，现在忙完了，主动联系用户\n- 距离上次对话已经过去了约 ${Math.round(i/60)} 分钟\n- 🤖 角色应该解释自己去忙什么了，并对让用户等待表示歉意或说明情况\n- 生成1-5条符合角色性格的主动消息，体现出刚忙完的状态`:t?`- 💖 用户刚刚喜欢了角色${e.user.name}的推文\n- 📝 被喜欢的推文内容："${n.content}"\n- 🤖 角色发现用户喜欢了TA的推文，现在主动发送私信`:`- ⏰ 距离上一次对话已经过去了 ${i} 秒\n- 🤖 角色${e.user.name}现在主动发送私信`}\n**角色信息**：\n- 角色名：${e.user.name}\n- 角色句柄：${e.user.handle}\n- 这是一个已绑定的角色，有完整的人设、记忆和X平台资料\n**重要规则**：\n- 🚨 只生成角色${e.user.name}的主动消息，不要生成用户的消息\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n${a?"- 📖 **必须参考下方的【X平台私信对话记录】**，查看用户之前发送的消息\n- 🔙 角色现在忙完了，应该回应用户之前的消息内容\n- 可以先道歉/解释为什么离开了一段时间，然后回应用户的消息\n- 消息风格要自然，符合角色性格（有的角色会认真道歉，有的随意说明）\n- 根据角色性格和与用户的关系，调整道歉的正式程度\n- 回复要严格符合角色的性格、说话风格和与用户的关系\n- 参考角色的聊天记忆（包括X平台私信记忆和其他聊天记忆），保持一致性":t?"- 📖 **必须参考下方的【X平台私信对话记录】**，了解你们之前的对话内容，保持对话的连贯性和一致性\n- 💖 角色知道用户喜欢了TA的推文（上面显示的推文内容），可以表现出惊喜、开心、好奇等情绪\n- 可以结合推文内容展开话题，询问用户的想法或感受\n- 生成1-5条符合角色性格的主动消息，表现出看到自己的推文被喜欢的反应\n- 回复要严格符合角色的性格、说话风格和与用户的关系\n- 可以表现出：发现被关注的开心、想继续交流的期待等情绪（根据角色性格）\n- 结合之前的X平台私信对话记录和推文内容，保持一致性":"- 根据距离上次对话的时间，生成1-7条符合角色性格的主动消息\n- 主动消息可以是：想念对方、分享近况、询问对方、提及X平台的推文等\n- 回复要严格符合角色的性格、说话风格和与用户的关系\n- 参考角色的聊天记忆（包括X平台私信记忆和其他聊天记忆），保持一致性\n- 可以自然提及角色最近在X平台发布的推文或动态"}\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、文章链接（link：需要title、description、author、source、body完整正文）、转发推文、转发主页\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！link类型是文章链接，需要包含完整的文章内容\n- ⚠️ 禁止生成forward类型消息（这是用户手动转发产生的）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}}else if(p){const n=m?.triggerSource||"unknown",t=m?.triggerContent||"";B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔓 核心任务说明（拉黑解除评估 - 角色私信）🔓\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。你之前拉黑了用户，但用户通过其他方式联系了你，现在需要评估是否解除拉黑。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- ⚠️ **你之前已经拉黑了用户，用户无法直接发送私信**\n- 🔔 但用户通过${"mention"===n?"在推文中@你":"在评论区评论"}的方式联系了你\n**角色信息**：\n- 角色名：${e.user.name}\n- 角色句柄：${e.user.handle}\n- 这是一个已绑定的角色，有完整的人设、记忆和X平台资料\n**用户的触发内容**：\n${"mention"===n?"用户在推文中@了你：":"用户在评论区提到了你："}\n"${t}"\n**重要规则**：\n- 🚨 只生成角色${e.user.name}的回复消息，不要生成用户的消息\n- 📖 **必须参考下方的【X平台私信对话记录】**，了解之前为什么拉黑用户\n- 🤔 根据用户的触发内容，评估是否值得解除拉黑\n**解除拉黑决策**：\n你需要根据以下因素决定是否解除拉黑：\n1️⃣ **解除拉黑（推荐）**：\n- 用户的态度诚恳，有道歉或和解的意图\n- 用户提到的内容让你觉得可以原谅\n- 用户表现出改变或理解\n- 之前的冲突不算特别严重\n- **返回格式**：[解除拉黑系统提示] + 0-3条文本消息（可以是原谅的话、重新开始的话，或直接不发其他消息）\n2️⃣ **继续拉黑**：\n- 用户的态度依然恶劣或不真诚\n- 用户的内容让你更生气\n- 之前的冲突太严重，无法原谅\n- **返回格式**：返回空数组[]（表示不回应，继续拉黑）\n**解除拉黑系统提示格式**：\n{\n"type": "system",\n"systemType": "unblocked",\n"content": "对方已解除拉黑",\n"time": "刚刚"\n}\n⚠️ 如果决定解除拉黑，系统提示后可以跟0-3条文本消息：\n- 0条：直接解除，不说话（高冷风格）\n- 1-2条：简单回应（"算了，原谅你了"、"看在你道歉的份上..."）\n- 2-3条：详细回应（解释为什么原谅、提出要求等）\n⚠️ 如果决定继续拉黑，返回空数组[]即可，不需要任何消息\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`}else if(u){const t=h?.trigger||"unknown",o=h?.details||{};let a="";if(void 0!==n&&n.currentLiveRoomData){const e=n.currentLiveRoomData,t=e.details||{};if(a=`\n\n📺 **你的直播间资料**：\n- 直播标题：${t.title||"未设置"}\n- 直播简介：${t.description||"未设置"}\n- 直播公告：${t.announcement||"无公告"}\n- 直播状态：${e.isLive?"正在直播":"未直播"}\n${t.streamType?`- 直播分类：${t.streamType}`:""}\n\n🎭 **你的主播人设信息**：\n${t.streamerPersonality?`- 性格特点：${t.streamerPersonality}`:""}\n${t.contentTheme?`- 内容主题：${t.contentTheme}`:""}\n${t.targetAudience?`- 目标观众：${t.targetAudience}`:""}\n\n💬 **你在直播间的最近发言**（最近50条，体现你的说话风格和当前状态）：\n`,e.danmakuMessages&&e.danmakuMessages.length>0){const n=e.danmakuMessages.filter(n=>n.isStreamer).slice(-50).reverse();n.length>0?n.forEach((n,e)=>{a+=`  ${e+1}. "${n.text}"\n`}):a+="  （暂无发言记录）\n"}else a+="  （暂无发言记录）\n";if(a+="\n💭 **直播间最近互动**（最近50条弹幕，了解直播间氛围）：\n",e.danmakuMessages&&e.danmakuMessages.length>0){e.danmakuMessages.slice(-50).reverse().forEach((n,e)=>{const t=n.isStreamer?"[你]":`[${n.username||"观众"}]`;a+=`  ${e+1}. ${t}: "${n.text}"\n`})}else a+="  （暂无弹幕记录）\n";a+="\n⚠️ **重要提示**：\n- 以上是你在直播间的真实表现和说话风格，请在私信中保持一致\n- 你可以参考自己最近说过的话来确定当前的心情、状态和话题\n- 观察直播间氛围和观众互动，了解当前直播的情况\n- 私信回复应该符合你在直播间展现的性格和状态\n- **你主动私联是有目的的**：维护与高消费用户的关系，根据你的性格决定如何表达\n"}B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎤 核心任务说明（主播主动私联模式 - 角色私信）🎤\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。主播因为用户的特殊贡献，主动发起私信维护关系。\n\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- 🎤 主播${e.user.name}主动联系用户，想要维护金钱关系\n- ${"giftRank"===t?`💰 **触发原因：礼物榜排名**\n  - 用户在直播间礼物榜排名第 ${o.rank||"?"} 名\n  - 累计送礼积分：${o.totalPoints||0}P\n  - 主播注意到了这位土豪用户的慷慨支持`:`🌟 **触发原因：粉丝团等级**\n  - 用户粉丝团等级：LV${o.level||"?"} ${o.levelName||""}\n  - 累计粉丝团积分：${o.totalPoints||0}P\n  - 主播注意到了这位高等级粉丝的忠诚支持`}\n${a}\n\n**角色信息**：\n- 角色名：${e.user.name}\n- 角色句柄：${e.user.handle}\n- 这是一个主播账户，在直播间与用户有互动历史\n\n**重要规则**：\n- 🚨 只生成主播${e.user.name}的主动私信消息，不要生成用户的消息\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n- 💰 **这是主播主动私联，目的是维护与高消费用户的关系**\n- 🎭 **主播的态度取决于其性格**：\n  * 势利型：直白地表达感谢，暗示希望继续支持\n  * 温柔型：真诚感谢，关心用户，建立情感连接\n  * 高冷型：可能只是礼貌性问候，不会过于热情\n  * 商业型：可能提及专属福利、私下优惠等\n  * 傲娇型：表面不在意但实际很重视，委婉表达感激\n\n**用户在直播间的行为数据**：\n${"giftRank"===t&&o.giftHistory?`\n💰 **送礼历史**（最近送的礼物）：\n${o.giftHistory.slice(0,10).map((n,e)=>`  ${e+1}. 「${n.name}」- ${n.price}积分${n.description?` (${n.description})`:""}`).join("\n")}\n${o.giftHistory.length>10?`  ...还有${o.giftHistory.length-10}个礼物`:""}\n`:""}\n${o.fanClubData?`\n🌟 **粉丝团状态**：\n- ${o.fanClubData.joined?`✅ 已加入粉丝团 LV${o.fanClubData.level} (${o.fanClubData.points}积分)`:"❌ 未加入粉丝团"}\n`:""}\n${o.danmakuHistory&&o.danmakuHistory.length>0?`\n💬 **用户发送的弹幕**（最近${Math.min(o.danmakuHistory.length,10)}条）：\n${o.danmakuHistory.slice(0,10).map((n,e)=>`  ${e+1}. "${n}"`).join("\n")}\n`:""}\n\n**回复内容建议**：\n- 生成1-5条符合主播性格的主动私信\n- 可以包含：\n  * 感谢用户的支持（必须）\n  * 提及用户送的某个特别的礼物（如果有送礼历史）\n  * 询问用户的直播体验\n  * 提供专属福利或优惠\n  * 建立私下联系（如私人号码、其他平台账号）\n  * 分享一些不在直播间说的话\n  * 邀请参加线下活动（如果合适）\n  * 可以回应用户发的某条有趣的弹幕（如果有弹幕历史）\n- 消息类型包括：文本、图片、表情包、语音、链接、转发推文、转发主页\n- ⚠️ 注意：主播主动私联是有目的的行为，回复应体现出对高消费用户的重视\n- ⚠️ 不要编造或猜测没有提到的信息，只基于上述提供的数据\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}else if(B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（续写模式 - 角色私信）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。用户刚刚发送了新的私信，请扮演已绑定的角色生成回复。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n**角色信息**：\n- 角色名：${e.user.name}\n- 角色句柄：${e.user.handle}\n- 这是一个已绑定的角色，有完整的人设、记忆和X平台资料\n**重要规则**：\n- 🚨 只生成角色${e.user.name}的回复消息，不要生成用户的消息\n**回复决策（你可以选择如何回应）**：\n1️⃣ **正常回复**：生成1-10条符合角色人设的自然回复（最常见）\n2️⃣ **不回复**：如果这是首次对话且用户的消息不吸引人、内容冒犯、或角色没有回复的理由，可以返回空数组[]\n3️⃣ **拉黑用户**：如果发生严重冲突、用户持续骚扰、或对话已经恶化到无法继续，可以返回拉黑系统提示\n4️⃣ **暂时离开**：如果角色临时有事无法回复（工作、上课、睡觉等），可以返回离开系统提示，稍后会主动联系用户\n**正常回复要求**：\n- 回复要严格符合角色的性格、说话风格和与用户的关系\n- 参考角色的聊天记忆（包括X平台私信记忆和其他聊天记忆），保持一致性\n- 可以适当提及角色最近在X平台发布的推文或动态\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、文章链接（link：需要title、description、author、source、body完整正文）、转发推文、转发主页、系统提示（system）\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！link类型是文章链接，需要包含完整的文章内容\n- ⚠️ 禁止生成forward类型消息（这是用户手动转发产生的）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,C){const n=!C.isOwn,e=C.isOwn,t=C.taskDescription||"",a=parseFloat(C.remainingAmount||0).toFixed(2),i=["发帖","发推","发推特","发推文","post","tweet","宣传","推广"].some(n=>t.toLowerCase().includes(n.toLowerCase()));if(n&&!i)B+=`\n💼 **进行中的商业任务**（你是接收方）：\n- 任务要求：${t}\n- 任务期限：${C.taskDeadlineHours}小时内完成\n- 待付尾款：$${a}\n⚠️ **重要提示**：\n- 你需要在对话中自然地发送**图片消息**（type: "image"）作为完成任务的证明\n- 图片内容应该与任务要求相关，展示你完成了任务\n- 发送图片后，用户会查看并决定是否支付尾款\n- 在发送图片时，可以配合文本消息说明你完成了什么\n- 不要刻意催促，自然地在对话中展示成果即可\n`;else if(e&&!i){const n=(o.userMessages||[]).some(n=>"image"===n.type);B+=n?`\n💼 **进行中的商业任务**（用户是接收方）：\n- 任务要求：${t}\n- 任务期限：${C.taskDeadlineHours}小时内完成\n- 待付尾款：$${a}\n⚠️ **重要提示**：\n- 用户刚刚发送了图片，可能是完成任务的证明\n- 请识别图片内容，判断用户是否完成了任务要求\n- 如果你认为用户完成了任务：\n1. 先发送1-2条文本消息表达认可和评价\n2. 然后发送转账消息支付尾款（amount为${a}，note说明是任务尾款，status为"pending"）\n- 如果你认为用户未完成或不符合要求：\n1. 礼貌地指出问题\n2. 可以要求用户重新提交或补充\n3. 不发送转账消息\n- 根据完成质量，你可以：\n* 支付全额尾款：$${a}\n* 支付部分尾款：$${(.5*parseFloat(a)).toFixed(2)} - $${(.8*parseFloat(a)).toFixed(2)}（如果质量一般）\n* 支付尾款+奖励：$${(1.1*parseFloat(a)).toFixed(2)} - $${(1.3*parseFloat(a)).toFixed(2)}（如果超出预期）\n`:`\n💼 **进行中的商业任务**（用户是接收方）：\n- 任务要求：${t}\n- 任务期限：${C.taskDeadlineHours}小时内完成\n- 待付尾款：$${a}\n⚠️ **提示**：\n- 用户需要发送图片证明完成任务\n- 你可以在对话中自然地提醒或询问任务进度\n- 等待用户发送完成证明后再决定是否支付尾款\n`}}}else if("account"===y){if(B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（续写模式 - 账户私信）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。用户刚刚发送了新的私信，请扮演该账户主人生成回复。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n**账户信息**：\n- 账户名：${e.user.name}\n- 账户句柄：${e.user.handle}\n- 这是一个已生成的账户，有完整的主页资料、推文和背景信息\n`,x){console.log("💎 [私信生成器] 检测到直播间用户数据，添加上下文"),console.log("💎 [私信生成器] liveUserData 完整内容:",{hasFanClub:!!x.fanClub,fanClubJoined:x.fanClub?.joined,giftContribution:x.giftContribution,giftsCount:x.gifts?.length||0,gifts:x.gifts,danmakuCount:x.userDanmaku?.length||0,streamerFollowers:x.streamerFollowers});if(x.giftContribution>0||x.fanClub&&x.fanClub.joined||x.userDanmaku&&x.userDanmaku.length>0){let e="";if(void 0!==n&&n.currentLiveRoomData){const t=n.currentLiveRoomData,o=t.details||{};if(e=`\n📺 **你的直播间资料**：\n- 直播标题：${o.title||"未设置"}\n- 直播简介：${o.description||"未设置"}\n- 直播公告：${o.announcement||"无公告"}\n- 直播状态：${t.isLive?"正在直播":"未直播"}\n${o.streamType?`- 直播分类：${o.streamType}`:""}\n\n🎭 **你的主播人设信息**：\n${o.streamerPersonality?`- 性格特点：${o.streamerPersonality}`:""}\n${o.contentTheme?`- 内容主题：${o.contentTheme}`:""}\n${o.targetAudience?`- 目标观众：${o.targetAudience}`:""}\n\n💬 **你在直播间的最近发言**（最近50条，体现你的说话风格和当前状态）：\n`,t.danmakuMessages&&t.danmakuMessages.length>0){const n=t.danmakuMessages.filter(n=>n.isStreamer).slice(-50).reverse();n.length>0?n.forEach((n,t)=>{e+=`  ${t+1}. "${n.text}"\n`}):e+="  （暂无发言记录）\n"}else e+="  （暂无发言记录）\n";if(e+="\n💭 **直播间最近互动**（最近50条弹幕，了解直播间氛围）：\n",t.danmakuMessages&&t.danmakuMessages.length>0){t.danmakuMessages.slice(-50).reverse().forEach((n,t)=>{const o=n.isStreamer?"[你]":`[${n.username||"观众"}]`;e+=`  ${t+1}. ${o}: "${n.text}"\n`})}else e+="  （暂无弹幕记录）\n";e+="\n⚠️ **重要提示**：\n- 以上是你在直播间的真实表现和说话风格，请在私信中保持一致\n- 你可以参考自己最近说过的话来确定当前的心情、状态和话题\n- 观察直播间氛围和观众互动，了解当前直播的情况\n- 私信回复应该符合你在直播间展现的性格和状态\n"}B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎤 直播间上下文（用户来自直播间）🎤\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**重要**：用户是从你的直播间点击头像进入私信的，你们之间有直播互动的背景。\n\n${e}\n\n**用户在直播间的行为数据**：\n`,x.fanClub&&x.fanClub.joined?B+=`\n📊 **粉丝团状态**：\n- ✅ 用户已加入你的粉丝团\n- 等级：LV${x.fanClub.level}\n- 累计积分：${x.fanClub.points}P\n- 连续签到：${x.fanClub.checkinDays}天\n`:B+="\n📊 **粉丝团状态**：\n- ❌ 用户未加入你的粉丝团\n",x.gifts&&x.gifts.length>0&&x.giftContribution>0?(B+=`\n💰 **礼物贡献**：\n- 用户在你的直播间送了总共 ${x.giftContribution} 积分的礼物\n- 这是真金白银的支持！\n\n🎁 **用户送的礼物详情**（共${x.gifts.length}个）：\n`,x.gifts.forEach((n,e)=>{B+=`  ${e+1}. 「${n.name}」（${n.code}）- ${n.price}积分\n`,n.description&&(B+=`     描述：${n.description}\n`),n.isCustom&&(B+="     ⭐ 这是用户自定义的礼物（特别用心）\n")}),B+='\n⚠️ **重要提示**：\n- 你可以根据礼物的名称、价值、数量来判断用户的支持程度\n- 自定义礼物代表用户花了额外心思，可能更值得重视\n- 你可以自然地提到某个礼物（例如："我记得你送的那个XXX"）\n- 🚨 **只回复你看到的礼物信息，不要编造或猜测没有提到的礼物**\n'):x.giftContribution>0?B+=`\n💰 **礼物贡献**：\n- 用户在你的直播间送了总共 ${x.giftContribution} 积分的礼物\n- ⚠️ 具体礼物记录未保存，不要猜测或编造具体送了什么礼物\n`:B+="\n💰 **礼物贡献**：\n- 用户在直播间未送过礼物（0积分）\n",x.userDanmaku&&x.userDanmaku.length>0?(B+=`\n💬 **用户发送的弹幕**（共${x.userDanmaku.length}条）：\n`,x.userDanmaku.forEach((n,e)=>{B+=`  ${e+1}. "${n}"\n`})):B+="\n💬 **用户发送的弹幕**：\n- 用户在直播间未发送弹幕（只是默默观看）\n",B+=`\n👥 **你的追随者数量**：${x.streamerFollowers||0} 人\n- 这个数据可以帮助你判断自己的影响力和粉丝规模\n`,B+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎭 基于直播间数据的回复策略 🎭\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n**多样化、真实感、生动性是核心要求！**\n\n根据上述数据，你可以选择不同的回复策略（随机选择，保持多样性）：\n\n1️⃣ **势利眼主播**（粉丝多，看重礼物）：\n   - 如果用户没刷礼物或刷得少：可能不回复、冷淡回复、或暗示"你是谁？"\n   - 如果用户刷了很多礼物：热情回复、记得用户、特殊对待\n   - 典型回复：\n     * "？"（如果没刷礼物）\n     * "嗯，有事吗"（冷淡）\n     * "哦，谢谢支持~"（敷衍）\n     * "哇！是你啊！我记得你！谢谢一直支持！"（刷了很多礼物）\n\n 2️⃣ **耍大牌主播**（粉丝少，但装高冷）：\n    - 即使粉丝少，也可能装腔作势\n    - 可能不回复、晾着用户、或说"忙着呢"\n    - 典型回复：\n      * （不回复，特殊消息格式：{ "isBlocked": true }）\n      * "最近比较忙，有事直说"\n      * "？啥事"（不耐烦）\n\n3️⃣ **平易近人主播**（粉丝多，但很亲切）：\n   - 无论用户是否刷礼物，都会热情回复\n   - 可能记得用户在直播间的弹幕内容\n   - 可能感谢用户的支持（即使只是看直播）\n   - 典型回复：\n     * "嗨！刚才直播看到你了！有什么想聊的吗？"\n     * "谢谢你一直在直播间支持我！"\n     * "哈哈，我记得你发的那条弹幕！"\n\n4️⃣ **懒得在意主播**（忘记用户行为）：\n   - 不记得用户是否刷过礼物\n   - 不在意粉丝团等级\n   - 随意回复，把用户当普通粉丝\n   - 典型回复：\n     * "嗨，有什么事吗？"\n     * "欸？你是……？"\n     * "啊，谢谢支持！"（即使用户没刷礼物）\n\n5️⃣ **记忆力好主播**（记得用户的弹幕）：\n   - 可能提到用户在直播间发的弹幕内容\n   - 可能回应用户的问题或评论\n   - 典型回复：\n     * "哈哈，你刚才说的XXX，我看到了！"\n     * "你问的那个问题，我来回答你……"\n     * "谢谢你一直在弹幕里支持我！"\n\n6️⃣ **商业主播**（看重数据和收益）：\n   - 可能提到粉丝团等级，鼓励升级\n   - 可能暗示或明示希望用户刷礼物\n   - 典型回复：\n     * "你还不是粉丝团成员啊？要不要加入？"\n     * "你等级还挺高的！继续支持哦~"\n     * "下次直播记得来哦，有福利的！"\n\n7️⃣ **佛系主播**（不在意数据，随缘互动）：\n   - 不提礼物、粉丝团等\n   - 把用户当朋友聊天\n   - 典型回复：\n     * "嗨，有什么想聊的吗？"\n     * "直播还好玩吗？"\n     * "欢迎随时来直播间玩~"\n\n**重要规则**：\n  - 🎲 **随机性**：每次私信不要总是同一种风格，根据主播性格随机选择策略\n  - 🎭 **真实感**：有些主播可能势利，有些可能健忘，有些可能平易近人\n  - 🚫 **不回复机制**：如果主播是势利眼或耍大牌，且用户没刷礼物/等级低，可以选择不回复（输出特殊消息格式：{ "isBlocked": true, "reason": "The user hasn\'t responded yet. They might be busy or not interested in chatting." }）\n  - 📊 **数据利用**：灵活运用用户的粉丝团、礼物、弹幕数据，不要生硬套用\n  - 💬 **弹幕引用**：如果用户发了弹幕，可以自然地提到，但不是必须\n  - 🎤 **直播背景**：可以提到直播间的事，但不要过度强调，保持自然\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n'}else console.log("💎 [私信生成器] 用户来自直播间，但没有互动数据（未送礼、未加粉丝团、未发弹幕），跳过直播间上下文")}B+=`\n**重要规则**：\n- 🚨 只生成账户${e.user.name}的回复消息，不要生成用户的消息\n- 根据用户最近发送的消息内容，生成1-10条符合该账户特点的自然回复\n- 回复要符合该账户的身份、风格和在X平台的形象\n- 参考账户的主页资料和最近推文，保持一致性\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、文章链接（link：需要title、description、author、source、body完整正文）、转发推文、转发主页\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！link类型是文章链接，需要包含完整的文章内容\n- ⚠️ 禁止生成forward类型消息（这是用户手动转发产生的）\n- 发送者头像统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`}else B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明（续写模式 - 陌生人私信）🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。用户刚刚发送了新的私信，请生成对方的回复。\n**对话场景**：\n- 📱 这是X社交平台（类似Twitter/X）的私信功能\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n**私信发送者信息**：\n- 用户名：${e.user.name}\n- 用户句柄：${e.user.handle}\n**重要规则**：\n- 🚨 只生成对方${e.user.name}的回复消息，不要生成用户的消息\n- 根据用户最近发送的消息内容，生成1-10条自然的回复\n- 回复要符合之前对话的语境和对方的性格特点（如果有设定）\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、文章链接（link：需要title、description、author、source、body完整正文）、转发推文、转发主页\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！link类型是文章链接，需要包含完整的文章内容\n- ⚠️ 禁止生成forward类型消息（这是用户手动转发产生的）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;else B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的私信对话生成器。请为一场陌生人私信对话生成完整的详细信息和消息记录。\n**私信发送者信息**：\n- 用户名：${e.user.name}\n- 用户句柄：${e.user.handle}\n- 私信预览内容：${e.preview}\n${e.link?`- 附带链接：${e.link}`:""}\n${e.attachment?`- 附带附件：${e.attachment}`:""}\n${e.tweetLink?`- 提及推文：${e.tweetLink}`:""}\n**重要规则**：\n- 生成发送者的完整X资料（简介、关注者数量等）\n- 生成3-10条私信消息记录（只包含陌生人发送的消息）\n- 消息类型包括：文本、图片（image：只需imageDescription和sensitive）、表情包（sticker：只需stickerUrl）、语音、链接、转发推文、转发主页\n- ⚠️ 注意：image和sticker是完全不同的类型，不要混淆！\n- 对话要自然真实，符合陌生人私信的特点\n- 发送者头像统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const q=B.substring(B.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));z=d.logTokenUsage("私信详情生成器","核心任务说明",q,z);const V=B.length;await Mt();const G=It.creditScore||100;let Y="",W="";G>=90?(Y="优秀",W="信誉极佳，值得信赖的合作伙伴"):G>=70?(Y="良好",W="信誉良好，可以放心合作"):G>=50?(Y="一般",W="信誉一般，需要谨慎考虑"):G>=30?(Y="较差",W="信誉较差，合作风险较高"):(Y="极差",W="信誉极差，不建议合作"),B+=`\n【用户X平台资料】：\n- 用户名：${M.name}\n- 用户句柄：${M.handle}\n- 认证状态：${M.verified?"已认证":"未认证"}\n${M.publicIdentity?`- 公众身份：${M.publicIdentity}`:""}\n${M.bio?`- 个人简介：${M.bio}`:""}\n【用户信用等级】：\n- 信用值：${G}/100\n- 信用等级：${Y}\n- 信用评价：${W}\n⚠️ **商业转账与信用值规则**：\n- 💰 **发起商业转账**（你雇佣用户）：\n* 信用值 ≥ 70：正常合作，可以发起任何金额的商业转账\n* 信用值 50-69：谨慎合作，建议降低金额或提高定金比例\n* 信用值 30-49：高风险，只在紧急情况下合作，金额不超过50美元\n* 信用值 < 30：极高风险，强烈不建议合作，基本拒绝商业转账请求\n- 📨 **接受商业转账**（用户雇佣你）：\n* 信用值 ≥ 70：可以正常接受商业转账\n* 信用值 50-69：可以接受，但要求更高定金比例（至少30%）\n* 信用值 30-49：极少接受，只有任务特别简单或定金特别高（50%）时才考虑\n* 信用值 < 30：基本拒绝，除非有特殊理由（如老朋友、关系很好等）\n- 🎯 **信用值影响**：\n* 高信用值：更容易获得商业合作机会，金额更高\n* 低信用值：很难获得商业合作，即使有也是小额任务\n* 你应该根据用户的信用等级调整你的态度和决策\n* 低信用用户的合作请求要更加谨慎，可以直接拒绝\n`,E.length>0&&(B+="\n【用户最近推文】（供参考，对话可能涉及这些推文）：\n",E.forEach((n,e)=>{B+=`\n${e+1}. "${n.content}"\n- 发布时间：${n.time||"最近"}\n- 互动数据：${n.stats?.likes||0}喜欢，${n.stats?.comments||0}评论\n`}));const J=B.substring(V);if(z=d.logTokenUsage("私信详情生成器","用户资料和推文",J,z),t&&e.user&&e.user.handle){const n=B.length;try{const t=await s.getUnifiedProfile(e.user.handle,{userProfileInfo:M,messageId:e.id});if(t){if(B+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━",B+=s.formatProfileForPrompt(t,{includeType:!0,includeTweets:!0,includeRelationships:!0}),"account"===t.type){const n=t.accountData;if(n&&n.sourceContext&&n.sourceContext.source){B+="\n【账户生成来源】：\n";const e=n.sourceContext;"feed"===e.source?B+=`来源：首页推文\n该账户曾发布的内容："${e.tweetContent}"\n`:"comment"===e.source?B+=`来源：评论区\n该账户曾发表的评论："${e.commentContent}"\n`:"search"===e.source?B+=`来源：搜索结果\n搜索关键词："${e.searchQuery}"\n`:"dm"!==e.source&&"dm_quote_profile"!==e.source||(B+=`来源：私信\n${e.messagePreview?`私信预览："${e.messagePreview}"`:""}\n`)}}if(B+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【私信回复要求】：\n- 回复必须严格符合${t.name}的${"character"===t.type?"性格和说话风格":"npc"===t.type||"relationshipNpc"===t.type?"人设和说话风格":"身份和风格"}\n- 参考【X平台私信对话记录】（上面显示的当前私信历史）保持对话连贯性\n`,"character"===t.type){const n=t._characterId,e=M.knownIdentityCharacters.includes(n);B+=e?"- ✅ 该角色知道用户身份，回复时应该表现出认识用户\n- 可以自然地称呼用户、提及共同经历或了解的信息\n- 【其他聊天记忆】仅用于理解角色与用户的关系和性格，不要直接提及其中的具体对话内容\n- 与用户的互动要符合角色了解的用户信息\n":"- ❌ 该角色不知道用户身份，必须按照陌生人模式回复\n- 不要让角色猜测、暗示或表现出任何对用户的认识\n- 回复要完全基于当前X平台私信对话的内容\n- 不要使用任何只有认识的人才会知道的信息或称呼\n"}else"account"===t.type?B+="- 参考账户的推文内容和互动风格\n- 如果有账户生成来源信息，保持与来源内容的一致性\n":"npc"===t.type?B+="- 该账户是全局绑定的NPC，按照人设描述进行回复\n- 回复要符合NPC的性格特点和发帖习惯\n- 可以参考NPC的主页信息保持一致性\n":"relationshipNpc"===t.type?B+=`- 该账户是关系NPC，与角色${t.relationshipData.ownerCharacterName}有特殊关系\n- 回复要体现${t.relationshipData.relationshipType}的关系特点\n- 与用户的互动按照普通关系进行，不要表现出特殊关系（除非另有说明）\n`:"stranger"===t.type&&(B+="- 该账户是陌生人（未绑定），回复应该自然真实\n- 按照普通X平台用户的特点进行回复\n- 如果有自定义头像或设定，按照设定的风格回复\n");B+="- ⚠️ **这是X平台的私信对话，不是手机聊天或其他场景**\n- 可以自然地提及最近在X平台发布的推文或动态\n- 保持在X平台和私信中的身份一致性\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const e=B.substring(n),o={character:"角色",account:"账户",npc:"绑定NPC",relationshipNpc:"关系NPC",stranger:"陌生人"};z=d.logTokenUsage("私信详情生成器",`${o[t.type]||"发送者"}详细信息`,e,z)}}catch(n){console.error("❌ [私信详情生成器] 读取发送者信息失败:",n)}}if(t&&$.length>0){console.log(`📝 [私信生成器] 添加对话记录到提示词（共 ${$.length} 条，显示最近 ${Math.min($.length,100)} 条）`),B+="\n【X平台私信对话记录】（当前私信的历史记录，供参考，保持连贯性）：\n";$.slice(-100).forEach((n,t)=>{const o=n.isOwn?"用户":e.user.name;let a="";if("text"===n.type)a=n.content;else if("image"===n.type)a=n.isOwn&&n.imageData?"[用户发送了图片]":n.imageDescription?`[图片: ${n.imageDescription}]`:"[图片]";else if("voice"===n.type)a=`[语音: ${n.voiceText}]`;else if("sticker"===n.type)a=n.isOwn&&n.stickerDescription?`[用户发送的表情包: ${n.stickerDescription}]`:n.stickerUrl?`[表情包: ${n.stickerUrl}]`:"[表情包]";else if("transfer"===n.type){const e=parseFloat(n.amount||0).toFixed(2),t=n.note?` (${n.note})`:"",o=n.isOwn?"转出":"转入";if(n.isBusiness){const i=parseFloat(n.depositAmount||0).toFixed(2),r=parseFloat(n.remainingAmount||0).toFixed(2),s=n.taskDescription||"无任务描述",l=n.taskDeadlineHours||24,c=n.depositRatio||0,d=n.taskStatus||"pending";a=`[商业${o}${t}]\n`,a+=`总金额: $${e}\n`,a+=`定金: $${i} (${c}%)\n`,a+=`尾款: $${r}\n`,a+=`任务要求: ${s}\n`,a+=`任务期限: ${l}小时内完成\n`,a+=`当前状态: ${"pending"===d?"待接收":"accepted"===d?"已接受，进行中":"completed"===d?"已完成":"rejected"===d?"已拒绝":d}`}else a=`[${o}: $${e}${t}]`}else if("link"===n.type)a=`[文章链接]\n标题：${n.title}\n简介：${n.description||""}\n作者：${n.author||""}\n来源：${n.source||""}\n正文：${n.body||n.description||""}`;else if("quoteTweet"===n.type)a=`[转发推文: ${n.tweet.content}]`;else if("quoteProfile"===n.type)a=`[转发主页: ${n.profile.name}]`;else if("quoteFanGroup"===n.type)a="[转发粉丝群]\n",a+=`群名称：${n.fanGroup.name}\n`,a+=`成员数：${n.fanGroup.memberCount}人\n`,n.fanGroup.threshold&&(a+=`入群门槛：${n.fanGroup.threshold}\n`);else if("forward"===n.type)if("tweet"===n.forwardType)if(a="[转发了推文]\n",n.fullContext&&n.fullContext.tweet){const e=n.fullContext.tweet;a+=`推文作者：${e.user?.name||"未知"}\n推文内容：${e.content||""}\n`,n.fullContext.comments&&n.fullContext.comments.length>0&&(a+=`评论区（${n.fullContext.comments.length}条评论）：\n`,n.fullContext.comments.slice(0,3).forEach((n,e)=>{a+=` ${e+1}. ${n.user?.name||"未知"}: ${n.content||""}\n`}),n.fullContext.comments.length>3&&(a+=` ...还有${n.fullContext.comments.length-3}条评论\n`))}else a+=`${n.forwardContent?.content||""}`;else"comment"===n.forwardType&&(a="[转发了评论]\n",n.fullContext?(n.fullContext.parentTweet&&(a+=`原推文作者：${n.fullContext.parentTweet.user?.name||"未知"}\n原推文内容：${n.fullContext.parentTweet.content||""}\n\n`),n.fullContext.comment&&(a+=`评论作者：${n.fullContext.comment.user?.name||"未知"}\n评论内容：${n.fullContext.comment.content||""}`)):a+=`${n.forwardContent?.content||""}`);B+=`\n${t+1}. ${o}: ${a}\n时间：${n.time}\n`}),z=d.logTokenUsage("私信详情生成器","现有对话上下文",B.substring(B.lastIndexOf("【现有对话记录】")),z)}B+=t?`\n【私信回复要求】：\n🚨 **核心规则：绝对禁止生成用户发送的消息！**\n- 只生成对方${e.user.name}的回复消息，不要生成用户的消息\n- ⚠️ **这是X平台的私信对话，不是手机短信或其他聊天软件**\n- 根据【X平台私信对话记录】和用户最近的消息，生成1-8条自然的回复\n- 回复要符合X平台私信的语境，保持角色一致性\n【消息类型使用原则】（重要！）：\n- ⭐ **以文本消息为主**：大部分回复（80-90%）应该是纯文本消息（type: "text"）\n- 📷 **偶尔使用其他类型**：仅在特定情况下使用其他消息类型（10-20%）：\n* image：当需要分享照片、图片或视觉内容时\n* voice：当角色特别激动、情绪强烈或不方便打字时\n* sticker：⚠️ **极少使用**（不超过5%）！只在情绪特别强烈且适合用表情包表达时才使用，且必须根据世界书中的表情包描述选择最符合当前情境的表情包URL，不要重复使用同一个表情包\n* transfer：⚠️ **极少使用，需谨慎！** 分为两种：\n- 普通转账：角色主动送钱、红包、礼物或感谢等（建议5-30美元，最多不超过50美元）\n- 商业转账：需要对方完成任务的付费合作（50-300美元），设置isBusiness为true并填写任务描述和期限\n- 🚫 **陌生人不要轻易转账**：只有关系亲密或有明确理由时才考虑转账\n* link：当需要分享网页、文章或链接时\n* quoteTweet：当提及或讨论某条推文时\n* quoteProfile：当推荐某个账户或介绍某人时\n* forward：⚠️ **禁止AI主动生成**！这是用户手动转发推文/评论的消息类型，AI不要生成此类型\n- 🚫 **禁止每种类型都使用**：不要为了展示多样性而强行使用所有消息类型\n- ✅ **自然使用**：根据对话内容和情境自然选择消息类型，不刻意\n- 🚫 **禁止连续使用同一表情包**：如果在之前的对话中已经使用过某个表情包URL，就不要再使用，要选择不同的表情包\n【消息类型详解】：\n* text：纯文本消息（最常用，首选）\n* image：图片消息（只包含imageDescription和sensitive，不需要caption，不要与sticker混淆）\n* voice：语音消息（包含voiceText和duration）\n* sticker：表情包消息（⚠️ 只包含stickerUrl字段！必须从世界书中仔细选择最符合当前情境和情绪的表情包URL，严禁重复使用同一个表情包，不要与image类型混淆）\n* transfer：转账消息（普通转账：包含amount和note；商业转账：额外需要isBusiness、taskDescription、taskDeadlineHours、depositRatio）\n* link：文章链接消息（包含title、description、author、source、body完整文章正文，可使用**加粗**和__下划线__标记重点）\n* quoteTweet：转发推文（包含tweet对象）\n* quoteProfile：转发主页（包含profile对象）\n* forward：⚠️ **用户转发的推文/评论**（AI不要生成此类型，这是用户手动操作产生的。如果在对话记录中看到此类型，AI可以根据其中包含的完整推文和评论内容进行回应）\n* system：⚠️ **系统提示消息**（特殊类型，用于以下场景）：\n- 不回复：如果你认为不应该回复用户（首次对话且内容不吸引人、内容冒犯等），返回空数组[]\n- 拉黑用户：如果对话出现严重冲突、用户持续骚扰、或你强烈不想继续对话，返回拉黑系统提示\n- 解除拉黑：如果之前拉黑了用户，但用户通过@或评论等方式道歉/和解，你决定原谅，返回解除拉黑系统提示\n- 暂时离开（仅绑定角色）：如果你临时有事无法回复，返回离开系统提示\n【特殊系统提示消息格式】：\n1. 拉黑用户（适用于严重冲突、骚扰等情况）：\n{\n"type": "system",\n"systemType": "blocked",\n"content": "对方已将你拉黑",\n"time": "刚刚"\n}\n2. 解除拉黑（适用于原谅用户，重新开始对话）：\n{\n"type": "system",\n"systemType": "unblocked",\n"content": "对方已解除拉黑",\n"time": "刚刚"\n}\n3. 暂时离开（⚠️ 仅绑定角色可用，陌生人/账户不能使用）：\n{\n"type": "system",\n"systemType": "away",\n"content": "对方正在[具体活动]中，暂时无法回复消息",\n"awayDuration": 数字（分钟，建议30-180分钟）,\n"time": "刚刚"\n}\n⚠️ 使用规则：\n- **不回复**：直接返回空数组 []，不需要任何消息\n- **拉黑**：只在极端情况下使用（严重冲突、持续骚扰、明显恶意等）\n- **解除拉黑**：只在用户通过其他渠道（@、评论等）展现诚意后使用，表示原谅用户\n- **暂时离开**：只有已绑定的角色才能使用，陌生人和账户不能使用此功能\n- **离开原因示例**：工作、上课、开会、睡觉、运动、吃饭、处理事情等\n- **离开时长**：30-180分钟为宜，不要太短或太长\n- 时间使用相对时间（如"刚刚"、"1分钟前"等）\n- 不要包含 isOwn 字段\n`:`\n【私信详细信息要求】：\n- 生成发送者的完整资料：\n* 简介（bio）：符合其身份和私信主题的个人简介\n* 关注者数量（followers）：100-2000之间的随机数字\n* 认证状态（verified）：通常为false\n【私信消息记录要求】：\n🚨 **核心规则：绝对禁止生成用户发送的消息！**\n- 只生成陌生人发送给用户的私信内容，不包含任何用户的回复\n- 生成3-6条消息，全部来自陌生人\n- 第一条消息必须是预览内容："${e.preview}"\n【消息类型使用原则】（重要！）：\n- ⭐ **以文本消息为主**：大部分消息（80-90%）应该是纯文本消息（type: "text"）\n- 📷 **偶尔使用其他类型**：仅在特定情况下使用其他消息类型（10-20%）：\n* image：当需要分享照片、图片或视觉内容时\n* voice：当角色特别激动、情绪强烈或不方便打字时\n* sticker：⚠️ **极少使用**（不超过5%）！只在情绪特别强烈且适合用表情包表达时才使用，且必须根据世界书中的表情包描述选择最符合当前情境的表情包URL，每次使用不同的表情包\n* transfer：⚠️ **极少使用，需谨慎！** 分为两种：\n- 普通转账：角色主动送钱、红包、礼物或感谢等（建议5-30美元，最多不超过50美元）\n- 商业转账：需要对方完成任务的付费合作（50-300美元），设置isBusiness为true并填写任务描述和期限\n- 🚫 **陌生人不要轻易转账**：只有关系亲密或有明确理由时才考虑转账\n* link：当需要分享文章、新闻或故事时（需包含完整的文章内容：title、description、author、source、body正文）\n* quoteTweet：当提及或讨论某条推文时\n* quoteProfile：当推荐某个账户或介绍某人时\n* forward：⚠️ **禁止AI主动生成**！这是用户手动转发推文/评论的消息类型\n- 🚫 **禁止每种类型都使用**：不要为了展示多样性而强行使用所有消息类型\n- ✅ **自然使用**：根据对话内容和情境自然选择消息类型，不刻意\n【消息类型详解】：\n* text：纯文本消息（最常用，首选）\n* image：图片消息（只包含imageDescription和sensitive，不需要caption，不要与sticker混淆）\n* voice：语音消息（包含voiceText和duration）\n* sticker：表情包消息（⚠️ 只包含stickerUrl字段！必须从世界书中仔细选择最符合当前情境和情绪的表情包URL，每次使用不同的表情包，不要与image类型混淆）\n* transfer：转账消息（普通转账：包含amount和note；商业转账：额外需要isBusiness、taskDescription、taskDeadlineHours、depositRatio）\n* link：链接消息（包含url、title、description）\n* quoteTweet：转发推文（包含tweet对象）\n* quoteProfile：转发主页（包含profile对象）\n* forward：⚠️ **禁止AI生成此类型**（这是用户手动转发产生的）\n- 时间从最早到最新排列\n- 不要包含 isOwn 字段\n`,B+=t?"\n【JSON返回格式】：\n```json\n[消息数组]\n```\n":'\n【JSON返回格式】：\n```json\n{\n"senderProfile": {\n"bio": "个人简介",\n"followers": 关注者数量（数字）,\n"verified": false\n},\n"messages": [消息数组]\n}\n```\n',B+='\n消息对象结构示例：\n1. 文本消息：\n{\n"type": "text",\n"content": "消息内容",\n"time": "时间描述"\n}\n2. 图片消息：\n{\n"type": "image",\n"imageDescription": "图片内容的文字描述",\n"sensitive": false,\n"time": "时间描述"\n}\n3. 语音消息：\n{\n"type": "voice",\n"voiceText": "先用括号标注出对声音的形容，再是语音内容的文字",\n"duration": "时长如0:15",\n"time": "时间描述"\n}\n4. 表情包消息：\n{\n"type": "sticker",\n"stickerUrl": "表情包图片链接（从世界书中选择）",\n"time": "时间描述"\n}\n⚠️ 注意：sticker类型只包含stickerUrl字段，不要与image类型混淆！\n5. 转账消息（两种类型）：\n5.1 普通转账：\n{\n"type": "transfer",\n"amount": 20.00,\n"note": "请你喝咖啡",\n"status": "pending",\n"time": "时间描述"\n}\n5.2 商业转账（适用于合作、接广告、买水军等商业场景）：\n{\n"type": "transfer",\n"amount": 150.00,\n"note": "合作费用",\n"status": "pending",\n"isBusiness": true,\n"taskDescription": "帮我发一条推文宣传新产品，需要包含产品特点和购买链接，语气要自然不刻意",\n"taskDeadlineHours": 24,\n"depositRatio": 20,\n"time": "时间描述"\n}\n⚠️ 转账消息说明：\n- amount：转账金额，必须是数字类型（不是字符串），建议5-30美元（普通转账）或50-300美元（商业转账）\n- note：转账备注，可选字段，用于说明转账目的\n- status：转账状态，必须是以下之一：\n* "pending"：待处理（默认状态，用于主动发起转账）\n* "accepted"：已接收（用于回应用户的转账请求，表示接受）\n* "rejected"：已拒绝（用于回应用户的转账请求，表示拒绝）\n- 🚫 **转账需谨慎**：与陌生人对话时不要随意转账，只有关系亲密或有明确理由时才考虑\n⚠️ 商业转账额外字段（当isBusiness为true时必填）：\n- isBusiness：布尔值，true表示这是商业转账\n- taskDescription：任务描述（字符串，50-500字），详细说明需要对方完成的任务，可以是：\n* 发帖宣传（指定内容、风格、话题标签等）\n* 转发推广（要求转发特定内容并评论）\n* 买水军/刷数据（要求点赞、评论、转发等）\n* 接广告（要求发布广告内容）\n* 其他商业合作任务\n- taskDeadlineHours：任务期限（数字，单位：小时），建议12-72小时，必填\n- depositRatio：定金比例（数字，0、20、30或50），表示先支付总金额的百分之几作为定金\n* 0：不支付定金，任务完成后再付款\n* 20：先支付20%作为定金\n* 30：先支付30%作为定金\n* 50：先支付50%作为定金\n⚠️ 转账使用场景：\n- 普通转账：关系亲密时可以送钱、红包、礼物、感谢费等（5-30美元）\n- 商业转账：有明确商业合作需求时的付费任务（50-300美元）\n* AI可以主动发起商业转账雇佣用户，但需要有合理的商业理由和场景\n* AI可以响应用户的商业转账，决定是否接受任务\n* 商业转账会显示任务要求、期限、定金比例等详细信息\n* 接收商业转账即表示同意完成任务\n- 🚫 **陌生人不要轻易转账**：初次对话、不熟悉的人基本不应该主动转账\n- ⚠️ **转账需要理由**：不要无缘无故转账，要有合理的情境支撑\n⚠️ 转账响应规则：\n- 当用户发送了待处理(pending)状态的转账给你时，你可以选择：\n* 发送status为"accepted"的转账消息表示接收\n- 普通转账：直接收到全款\n- 商业转账：收到定金，需要根据任务要求完成任务（如发推文等）\n* 发送status为"rejected"的转账消息表示拒绝\n* 你接收或拒绝后会自动生成系统通知，无需额外文本说明\n⚠️ 商业转账处理（重要！）：\n- 如果用户发送了商业转账（isBusiness为true），你需要：\n1. 查看taskDescription（任务描述）和taskDeadlineHours（任务期限）\n2. 决定是否接受任务（根据角色性格和任务要求）：\n* accepted：表示接受任务和定金，AI会自动开始执行任务\n* rejected：表示拒绝任务，定金会退回给用户\n3. 如果接受了包含"发帖"、"发推"等关键词的任务，AI会自动在规定时间内发布推文\n4. 用户看到推文后，如果满意会确认完成任务并支付尾款\n5. 接受商业转账时，可以在回复消息中表达对任务的理解和态度\n⚠️ AI主动发起转账：\n- AI也可以主动发起转账（普通或商业），但需要谨慎，不要轻易转账\n- 🚫 **陌生人场景**：如果是陌生人私信或初次对话，基本不应该主动转账\n- ✅ **熟人/绑定角色场景**：关系亲密时可以考虑小额转账（5-30美元），大额需有明确理由\n- 转账金额要符合情境和角色经济状况，普通转账建议5-30美元，商业转账50-300美元\n- 商业转账的任务描述要具体明确，符合商业合作的真实场景\n- 可以雇佣用户完成任务（如"帮我发条推文宣传"、"帮我刷点数据"等），但要有合理的商业理由\n6. 链接消息（文章类型）：\n{\n"type": "link",\n"url": "文章来源网址（可选）",\n"title": "文章标题",\n"description": "文章简介/摘要",\n"author": "文章作者",\n"source": "文章来源名称",\n"body": "文章正文内容（完整的文章内容，可使用**文本**表示加粗重点，使用__文本__表示下划线重点）",\n"time": "时间描述"\n}\n⚠️ 链接消息说明：\n- title：文章的标题，应该简洁有力\n- description：文章的简介或摘要，显示在私信卡片中\n- author：文章作者名称\n- source：文章来源（如"XX日报"、"XX杂志"等）\n- body：完整的文章正文，可以使用markdown格式：\n* 使用**文本**表示加粗重点（会显示为蓝色高亮）\n* 使用__文本__表示下划线重点（会显示为下划线）\n* 支持换行，使用\n分段\n- url：文章的来源链接（可选，可以不填）\n- 文章内容应该真实、有深度，符合分享场景\n- 适合分享新闻、评论、故事、学术文章等\n7. 转发推文：\n{\n"type": "quoteTweet",\n"tweet": {\n"userName": "推文作者名",\n"userHandle": "@handle",\n"userAvatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n"verified": false,\n"content": "推文内容",\n"time": "推文时间"\n},\n"caption": "转发时的说明（可选）",\n"time": "时间描述"\n}\n8. 转发主页：\n{\n"type": "quoteProfile",\n"profile": {\n"name": "账户名",\n"handle": "@handle",\n"avatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n"bio": "个人简介",\n"followers": 关注者数量（数字）,\n"verified": false\n},\n"caption": "转发时的说明（可选）",\n"time": "时间描述"\n}\n9. 转发粉丝群：\n{\n"type": "quoteFanGroup",\n"fanGroup": {\n"id": "粉丝群ID",\n"name": "粉丝群名称",\n"avatar": "粉丝群头像链接",\n"memberCount": 成员数量（数字）,\n"threshold": "入群门槛说明（可选）"\n},\n"caption": "转发时的说明（可选）",\n"time": "时间描述"\n}\n⚠️ 转发粉丝群说明：\n- 这是用户转发粉丝群邀请给你时的消息类型\n- 包含粉丝群的基本信息：名称、头像、成员数、入群门槛等\n- 你可以根据粉丝群信息决定是否感兴趣、是否想加入等\n- AI不应该主动生成此类型消息（除非有合理的场景理由）\n- 用户转发粉丝群通常是想邀请你加入或分享这个群\n10. 转发推文/评论（forward）：\n⚠️ **此类型禁止AI生成！这是用户手动转发操作产生的消息类型。**\n如果在【X平台私信对话记录】中看到此类型消息，说明用户转发了推文或评论给你，你可以查看其中的完整内容：\n- 转发推文时，包含完整推文内容和该推文的所有评论区内容\n- 转发评论时，包含评论内容和该评论所属的推文内容\nAI应该根据这些完整的上下文信息来理解用户分享的内容并给出回应。\n关键规则：\n1. 🚨 所有消息都来自陌生人，不包含用户发送的消息\n2. verified字段必须是布尔值(true/false)\n3. followers和duration中的数字必须是纯数字（语音时长是字符串格式如"0:15"）\n4. 可选字段不使用时完全省略，不要设为null\n5. ⚠️ **图片消息（image）和表情包消息（sticker）是完全不同的类型**：\n- image类型：只包含imageDescription和sensitive字段，不要包含caption\n- sticker类型：只包含stickerUrl字段，是表情包图片链接\n- 严禁混淆这两种类型！\n6. 时间描述使用相对时间（如"刚刚"、"5分钟前"、"1小时前"等）\n7. 所有头像统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n';const K=B.substring(B.lastIndexOf("【JSON返回格式】"));z=d.logTokenUsage("私信详情生成器","JSON格式要求",K,z);let Q,Z=[];console.log("💎 [私信生成器] 检查礼物图片数据:",{hasLiveUserData:!!x,hasGifts:!(!x||!x.gifts),giftsLength:x?.gifts?.length||0,gifts:x?.gifts}),x&&x.gifts&&x.gifts.length>0?(Z=x.gifts.filter(n=>n.useLocalImage&&n.imageLocal),console.log(`💎 [私信生成器] 礼物过滤结果: 总共${x.gifts.length}个礼物，其中${Z.length}个包含本地图片`),Z.length>0?(console.log(`📸 [私信生成器] 检测到${Z.length}个礼物包含本地图片，将使用多模态识图`),Z.forEach((n,e)=>{console.log(`📸 [私信生成器] 礼物 ${e+1}: ${n.name}, useLocalImage=${n.useLocalImage}, imageLocal=${n.imageLocal?.substring(0,50)}...`)})):console.log("💎 [私信生成器] 没有礼物包含本地图片")):console.log("💎 [私信生成器] 没有礼物数据");const nn=o.userMessages||[];if(r)Q=`角色主动发起对话，因为发现用户查看了TA的提问箱。请生成角色${e.user.name}的主动消息。`;else if(nn.length>0){const n=nn.some(n=>"image"===n.type&&n.imageData),e=Z.length>0;if(n||e){Q=[];const n=nn.filter(n=>"text"===n.type),t=nn.filter(n=>"image"===n.type&&n.imageData),o=nn.filter(n=>"image"===n.type&&n.imageDescription&&!n.imageData),a=nn.filter(n=>"sticker"===n.type),i=nn.filter(n=>"voice"===n.type);let r="用户刚刚发送了新消息，请分析并回复：";n.length>0&&(r+="\n"+n.map(n=>n.content).join("\n")),i.length>0&&(r+="\n用户发送了语音消息："+i.map(n=>`[语音时长${n.duration}: ${n.voiceText}]`).join("、")),a.length>0&&(r+="\n用户发送了表情包："+a.map(n=>n.stickerDescription).join("、")),o.length>0&&(r+="\n用户发送了文字图片描述："+o.map(n=>`"${n.imageDescription}"`).join("、")),t.length>0&&(r+=`\n用户还发送了${t.length}张真实图片，请识别图片内容并结合图片内容给出回复。`),e&&(r+=`\n\n📸 用户在直播间送的礼物图片识别（共${Z.length}个）：`,Z.forEach((n,e)=>{r+=`\n  ${e+1}. 礼物「${n.name}」（${n.price}积分）`,n.description&&(r+=` - ${n.description}`),r+=`\n     图片：[第${e+1}张图片是该礼物的样式/外观]`}),r+="\n\n⚠️ 重要：请识别这些礼物图片的实际样子（颜色、形状、设计、风格等），在回复中可以自然地评价礼物的外观。",r+='\n例如："我记得你送的那个礼物，设计很特别！" 或 "那个礼物的图案我很喜欢"等。'),Q.push({type:"text",text:r}),t.forEach(n=>{n.imageData&&Q.push({type:"image_url",image_url:{url:n.imageData}})}),Z.forEach(n=>{n.imageLocal&&(Q.push({type:"image_url",image_url:{url:n.imageLocal}}),console.log(`📸 [私信生成器] 添加礼物图片: ${n.name} (${n.imageLocal.substring(0,50)}...)`))}),console.log(`✅ [私信生成器] 构建多模态消息: ${t.length}张用户图片 + ${Z.length}张礼物图片`)}else{const n=nn.filter(n=>"text"===n.type),e=nn.filter(n=>"image"===n.type&&n.imageDescription&&!n.imageData),t=nn.filter(n=>"sticker"===n.type),o=nn.filter(n=>"voice"===n.type);let a="用户刚刚发送了新消息，请回复：";n.length>0&&(a+="\n"+n.map(n=>n.content).join("\n")),o.length>0&&(a+="\n用户发送了语音消息："+o.map(n=>`[语音时长${n.duration}: ${n.voiceText}]`).join("、")),t.length>0&&(a+="\n用户发送了表情包："+t.map(n=>n.stickerDescription).join("、")),e.length>0&&(a+="\n用户发送了文字图片描述："+e.map(n=>`"${n.imageDescription}"`).join("、")),Q=a}}else if(Z.length>0){console.log(`📸 [私信生成器-初始模式] 构建多模态消息，包含${Z.length}个礼物图片`),Q=[];let n="请生成完整的私信对话详情。";n+=`\n\n📸 用户在直播间送的礼物图片识别（共${Z.length}个）：`,Z.forEach((e,t)=>{n+=`\n  ${t+1}. 礼物「${e.name}」（${e.price}积分）`,e.description&&(n+=` - ${e.description}`),n+=`\n     图片：[第${t+1}张图片是该礼物的样式/外观]`}),n+="\n\n⚠️ 重要：请识别这些礼物图片的实际样子（颜色、形状、设计、风格等），在回复中可以自然地评价礼物的外观。",n+='\n例如："我记得你送的那个礼物，设计很特别！" 或 "那个礼物的图案我很喜欢"等。',Q.push({type:"text",text:n}),Z.forEach(n=>{n.imageLocal&&(Q.push({type:"image_url",image_url:{url:n.imageLocal}}),console.log(`📸 [私信生成器-初始模式] 添加礼物图片: ${n.name} (${n.imageLocal.substring(0,50)}...)`))})}else Q="请生成完整的私信对话详情";const en=[{role:"user",content:Q}],tn=Array.isArray(Q)?Q.map(n=>n.text||"[图片]").join(" "):Q;d.logFinalPrompt("私信详情生成器",B,tn);const on=await g.sendAIRequest({apiConfig:f,systemPrompt:B,messages:en,temperature:.8});let an=g.parseJSONResponse(on);if(t){if(!Array.isArray(an))throw new Error("AI返回的数据格式不正确，期望消息数组");const n=an.some(n=>"system"===n.type&&"blocked"===n.systemType),e=an.some(n=>"system"===n.type&&"unblocked"===n.systemType),t=an.some(n=>"system"===n.type&&"away"===n.systemType);return n?console.log("⚠️ AI决定拉黑用户"):e?console.log("🎉 AI决定解除拉黑"):t?console.log("⏰ AI暂时离开"):0===an.length?console.log("📭 AI决定不回复"):console.log(`✅ 生成了${an.length}条AI回复`),an}if(!an.senderProfile||!an.messages||!Array.isArray(an.messages))throw new Error("AI返回的数据格式不正确");an.messages.forEach(n=>{n.timestamp||(n.timestamp=(new Date).toISOString())});try{const n=`messageConversation_${vt||"main"}_${e.id}`;await v.xAccountProfiles.put({handle:n,name:"messageConversation",data:an,messageId:e.id,accountId:vt||"main",updatedAt:(new Date).toISOString()}),console.log("✅ 私信对话数据已保存到数据库")}catch(n){console.error("保存私信对话数据失败:",n)}return an}catch(n){return console.error("生成私信对话详情失败:",n),mn(`生成失败: ${n.message}`,"error"),null}}n.loadNotifications=bl,n.refreshStrangerMessages=async function(){const t=document.getElementById("refresh-messages-btn");t.style.animation="spin 1s linear infinite";const o=document.createElement("style");o.textContent="\n @keyframes spin {\n from {transform: rotate(0deg); }\n to {transform: rotate(360deg); }\n }\n",document.head.appendChild(o);try{const{apiConfig:t,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r}=o,l=s.buildUserXProfileInfo(n.userProfileData),c=`userTweets_${vt||"main"}`,p=await a.xUserTweets.get(c),m=p?.tweets?.slice(0,5)||[];let x=0,u=s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});x=d.logTokenUsage("陌生人私信生成器","基础系统提示词",u,x);const h=await s.getApplicableWorldBooks("messages",{boundCharacters:[]});h&&(u+=h,x=d.logTokenUsage("陌生人私信生成器","世界书内容",h,x));const f=await bn("陌生人私信生成器",{usageRate:.2,usageDescription:'**陌生人私信场景的大事件使用**：\n1. **商务合作**：如果用户是高曝光人物，陌生人可能因为大事件找用户合作\n   - 灾难事件："想邀请您参加XXX慈善活动"\n   - 热点事件："能否请您就XXX事件发表看法？"\n2. **粉丝留言**：粉丝可能提及大事件，询问用户看法\n   - "看到最近的XXX事件，想知道您怎么看"\n   - "希望您能为XXX发声！"\n3. **推荐/分享**：陌生人可能因大事件而推荐内容\n   - "最近XXX闹得挺大，给您推荐个相关资源"\n4. **随机搭讪**：大事件可能成为搭讪话题\n   - "今天XXX你看了吗？太震惊了"\n5. **自然融入**：只有约20%的陌生人私信涉及大事件，其余是常规内容'});f&&(u+=f,x=d.logTokenUsage("陌生人私信生成器","世界运转大事件",f,x)),u+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的陌生人私信生成器。请生成3-8条来自陌生用户的私信消息。\n**重要规则**：\n- 这些私信来自陌生用户，不是用户的朋友或熟人\n- 私信内容可以是：商务合作、粉丝留言、问询、推荐、随机搭讪等\n- 私信发送者都是虚构的X平台用户\n- 头像统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const b=u.substring(u.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));x=d.logTokenUsage("陌生人私信生成器","核心任务说明",b,x);const v=u.length;u+=`\n【用户X平台资料】：\n- 用户名：${l.name}\n- 用户句柄：${l.handle}\n- 认证状态：${l.verified?"已认证":"未认证"}\n${l.publicIdentity?`- 公众身份：${l.publicIdentity}`:""}\n${l.bio?`- 个人简介：${l.bio}`:""}\n`,m.length>0&&(u+="\n【用户最近推文】（供参考，陌生人可能看过这些推文）：\n",m.forEach((n,e)=>{u+=`\n${e+1}. "${n.content}"\n- 发布时间：${n.time||"最近"}\n- 互动数据：${n.stats?.likes||0}喜欢，${n.stats?.comments||0}评论\n`}));const y=u.substring(v);x=d.logTokenUsage("陌生人私信生成器","用户资料和推文",y,x),u+='\n【私信内容要求】：\n- 私信类型多样化：商务邀请、粉丝留言、合作咨询、内容推荐、社交搭讪等\n- 可以参考用户的推文内容或公众身份来设计私信话题\n- 私信长度适中（20-100字）\n- 部分私信可以附带链接、图片描述或推文链接\n【JSON返回格式】：\n```json\n{\n"messages": [私信数组]\n}\n```\n私信对象结构：\n- user: {name, handle, avatar, verified}\n- preview: 私信预览内容（主要文本）\n- link: 附带链接（可选，如个人网站、项目链接等）\n- attachment: 附带的图片/文件描述（可选）\n- tweetLink: 提及的推文链接（可选，如"你的这条推文xxx"）\n关键规则：\n1. verified字段必须是布尔值(true/false)，陌生人一般为false\n2. user.avatar统一使用：https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n3. 可选字段不使用时完全省略，不要设为null\n4. 私信内容要真实自然，符合陌生人私信的特点\n';const w=u.substring(u.lastIndexOf("【JSON返回格式】"));x=d.logTokenUsage("陌生人私信生成器","JSON格式要求",w,x);const k=[{role:"user",content:"请生成新的陌生人私信数据"}];d.logFinalPrompt("陌生人私信生成器",u,k[0].content);const $=await g.sendAIRequest({apiConfig:t,systemPrompt:u,messages:k,temperature:.8}),C=g.parseJSONResponse($);if(!C.messages||!Array.isArray(C.messages))throw new Error("AI返回的数据格式不正确，缺少messages数组");const I=Date.now();C.messages.forEach((n,e)=>{n.id=`sm_${I}_${e}`}),hl.length=0,hl.push(...C.messages);try{const n=e(),t=`strangerMessages_${vt||"main"}`;await n.xAccountProfiles.put({handle:t,name:"strangerMessages",data:C.messages,updatedAt:(new Date).toISOString()}),console.log("✅ 陌生人私信数据已保存到数据库")}catch(n){console.error("保存陌生人私信数据失败:",n)}bl();Rl({title:"X",message:"en"===Hn?"Stranger messages have been refreshed!":"陌生人私信已刷新！",avatar:n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"})}catch(n){console.error("刷新陌生人私信失败:",n),mn(`刷新失败: ${n.message}`,"error")}finally{t.style.animation="",o&&o.parentNode&&o.remove()}};let yl=null,wl=!1;const kl=3e5;async function $l(){try{console.log("⏰ [聊天记忆检测] 开始定时检测..."),await async function(){try{console.log("🔍 [聊天记忆Tweet检测] 开始检测其他平台聊天记忆中的发帖意图");const o=e(),a=`xSettings_${vt||"main"}`,i=await o.xSettings.get(a);if(!i||!i.boundCharacters||0===i.boundCharacters.length)return void console.log("⏭️ [聊天记忆Tweet检测] 没有绑定角色，跳过");const r=s.buildUserXProfileInfo(n.userProfileData),l=t(),c=await l.chats.toArray(),d=await o.xCharacterProfiles.toArray(),p=[];for(const n of i.boundCharacters){if(!r.knownIdentityCharacters.includes(n))continue;const e=c.find(e=>e.id===n);if(!e)continue;const t=d.find(e=>e.characterId===n);t&&(t.userPersona&&t.userPersona.trim()?e.history&&0!==e.history.length?p.push({character:e,xProfile:t}):console.log(`⏭️ [聊天记忆Tweet检测] ${e.name}: 没有聊天记忆，跳过`):console.log(`⏭️ [聊天记忆Tweet检测] ${e.name}: 未设置专属用户人设，跳过`))}console.log(`✅ [聊天记忆Tweet检测] 找到 ${p.length} 个符合条件的角色`);for(const{character:n,xProfile:e}of p)await Sl(n,e)}catch(n){console.error("❌ [聊天记忆Tweet检测] 失败:",n)}}(),Cl()}catch(n){console.error("❌ [聊天记忆检测] 定时检测失败:",n)}}function Cl(){const n=new Date(Date.now()+kl),e=`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`,t=document.getElementById("next-detection-time");t&&(t.textContent=e)}async function Il(n){try{const t=e(),o=`xSettings_${vt||"main"}`,a=await t.xSettings.get(o);a&&(a.chatHistoryDetectionEnabled=n,await t.xSettings.put(a))}catch(n){console.error("保存检测状态失败:",n)}}async function Sl(n,t){try{console.log(`🔍 [聊天记忆Tweet检测] 检查角色: ${n.name}`);const o=["发帖","发推","发推特","发推文","发tweet","发条推","发个帖","发条帖","发个推","发一条","发布推文","发布帖子","post","tweet","tweeted","posting","gonna post","will post","going to post","publish","share on x","share on twitter","发到X上","发到推特","发到平台","分享到X","晒到X"],a=n.history.slice(-20);let i=!1,r=-1;for(let e=a.length-1;e>=0;e--){const t=a[e];if("assistant"===t.role&&t.content){const a=t.content.toLowerCase();if(o.some(n=>a.includes(n.toLowerCase()))){i=!0,r=e,console.log(`✅ [聊天记忆Tweet检测] ${n.name} 主动提及发帖: ${t.content.substring(0,50)}`);break}}}if(!i)return void console.log(`⏭️ [聊天记忆Tweet检测] ${n.name} 未主动提及发帖`);const s=Math.max(0,r-10),l=Math.min(a.length,r+11),c=a.slice(s,l).map(n=>({type:"text",content:n.content||"",isOwn:"user"===n.role,time:"最近"})),d={id:`msg_${n.id}`,user:{name:t.xName,handle:t.xHandle,avatar:t.xAvatar,verified:t.xVerified||!1}},p=await Tl(d,c);if(!p)return void console.log(`⚠️ [聊天记忆Tweet检测] ${n.name} 的AI未生成推文内容`);const g=Date.now(),m={id:`mention_newtweet_chat_${g}`,type:"newTweet",user:d.user,content:`New Tweet from ${d.user.name}`,time:"刚刚",timestamp:g,tweet:p},x=e(),u=`mentions_${vt||"main"}`;let h=await x.xAccountProfiles.get(u);h||(h={handle:u,id:u,data:[]}),h.data.unshift(m),await x.xAccountProfiles.put(h),console.log(`✅ [聊天记忆Tweet检测] ${n.name} 的推文通知已生成并保存`),await Dn(d.user.handle,p);Rl({title:"X",message:"en"===Hn?`${d.user.name} posted a new tweet based on your conversation!`:`${d.user.name} 根据你们的对话发布了新推文！`,avatar:d.user.avatar,leftIcon:"x"});const f=document.getElementById("x-notifications-page");f&&"flex"===f.style.display?await bl():vn("notifications")}catch(e){console.error(`❌ [聊天记忆Tweet检测] 检查 ${n.name} 失败:`,e)}}async function Ml(n,t){try{console.log("🔍 [私信Tweet检测] 开始检测私信对话中的发帖意图");const o=["发帖","发推","发推特","发推文","发tweet","发条推","发个帖","发条帖","发个推","发一条","发布推文","发布帖子","post","tweet","tweeted","posting","gonna post","will post","going to post","publish","share on x","share on twitter","发到X上","发到推特","发到平台","分享到X","晒到X"];let a=!1,i=-1;for(let n=t.length-1;n>=Math.max(0,t.length-10);n--){const e=t[n];if("text"===e.type&&e.content&&!e.isOwn){const t=e.content.toLowerCase();if(o.some(n=>t.includes(n.toLowerCase()))){a=!0,i=n,console.log("✅ [私信Tweet检测] 对方主动提及发帖:",e.content.substring(0,50));break}}}if(!a)return void console.log("⏭️ [私信Tweet检测] 对方未主动提及发帖，跳过");const r=Math.max(0,i-10),s=Math.min(t.length,i+11),l=t.slice(r,s);console.log(`📝 [私信Tweet检测] 提取上下文消息: ${l.length} 条`);const c=await Tl(n,l);if(!c)return void console.log("⚠️ [私信Tweet检测] AI未生成推文内容");const d=Date.now(),p={id:`mention_newtweet_dm_${d}`,type:"newTweet",user:n.user,content:`New Tweet from ${n.user.name}`,time:"刚刚",timestamp:d,tweet:c},g=e(),m=`mentions_${vt||"main"}`;let x=await g.xAccountProfiles.get(m);x||(x={handle:m,id:m,data:[]}),x.data.unshift(p),await g.xAccountProfiles.put(x),console.log("✅ [私信Tweet检测] 已生成并保存 New Tweet 通知"),await Dn(n.user.handle,c);Rl({title:"X",message:"en"===Hn?`${n.user.name} posted a new tweet!`:`${n.user.name} 发布了新推文！`,avatar:n.user.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x"});const u=document.getElementById("x-notifications-page");u&&"flex"===u.style.display?await bl():vn("notifications")}catch(n){console.error("❌ [私信Tweet检测] 失败:",n)}}async function Tl(t,o,a={}){try{const i=a.isAutoTweet||!1,r=a.timeSinceLastMessage||0,{apiConfig:l,xSettings:c,xDb:p}=(a.type,await g.loadConfigAndSettings()),{userPrompt:m,worldSetting:x}=c;let u="stranger",h=null,f=null;if(t.id)if(t.id.startsWith("msg_account_")){u="account";const n=t.id.split("_");n.length>2&&(f=n[2])}else t.id.startsWith("msg_")&&"msg_001"!==t.id&&(u="character",h=t.id.replace("msg_",""));console.log(`📝 [Tweet生成] 消息类型: ${u}`,{characterId:h,accountHandle:f});const b=s.buildUserXProfileInfo(n.userProfileData),v=`userTweets_${vt||"main"}`,y=await p.xUserTweets.get(v),w=y?.tweets?.slice(0,5)||[];let k=[];if(i){const n=t.user.handle.replace("@",""),e=await p.xAccountProfiles.get(n);e&&e.tweets&&e.tweets.length>0&&(k=e.tweets.slice(0,20),console.log(`📝 [Tweet生成] 读取到 ${k.length} 条现有推文用于删除决策`))}let $=0;const C=new Date,I=new Date(C.getTime()+288e5),S=I.getUTCFullYear(),M=I.getUTCMonth()+1,T=I.getUTCDate(),A=I.getUTCHours(),E=I.getUTCMinutes(),z=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][I.getUTCDay()];let B="";B=A>=5&&A<9?"清晨":A>=9&&A<12?"上午":A>=12&&A<14?"中午":A>=14&&A<18?"下午":A>=18&&A<22?"晚上":"深夜";let L=s.buildBaseSystemPrompt({userPrompt:m,worldSetting:x});$=d.logTokenUsage("Tweet生成器","基础系统提示词",L,$),L+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⏰ 当前时间信息 ⏰\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n当前时间（北京时间）：${S}年${M}月${T}日 ${z} ${String(A).padStart(2,"0")}:${String(E).padStart(2,"0")}\n时段：${B}\n**请根据当前时间生成符合时间情境的推文**：\n- 如果是清晨或上午，推文可以是早安问候、早餐分享、一天计划等\n- 如果是中午，可以是午餐分享、工作进展等\n- 如果是下午，可以是下午茶、工作日常、生活感悟等\n- 如果是晚上，可以是晚餐、晚间活动、一天总结等\n- 如果是深夜，可以是深夜想法、失眠感悟等\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,$=d.logTokenUsage("Tweet生成器","时间信息",L.substring(L.lastIndexOf("⏰ 当前时间信息")),$);const P={boundCharacters:[]};"character"===u&&h&&(P.boundCharacters=[h]);const D=await s.getApplicableWorldBooks("posts",P);D&&(L+=D,$=d.logTokenUsage("Tweet生成器","世界书内容",D,$)),L+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：基于私信对话生成推文 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的推文生成器。${i?`${t.user.name} (${t.user.handle}) 在后台自动发布推文。\n🤖 **后台自动发推模式**：角色根据最近的聊天记录自主决定发布推文内容\n⏰ **距离上次聊天**: ${Math.floor(r/60)} 分钟前（${r} 秒）\n📝 **推文重点**: 以刻画 ${t.user.name} 自身为主，可以分享日常、想法、近况等，聊天记录仅作为灵感参考`:`在私信对话中，${t.user.name} (${t.user.handle}) 提到要发布推文。`}\n🚨 **注意：是 ${t.user.name} 要发推文，不是用户本人！**\n请根据对话上下文，生成 ${t.user.name} 可能会发布的推文内容。\n**对话上下文**（最近的私信对话${i?"，作为灵感参考":""}）：\n`,o.forEach((n,e)=>{const o=n.isOwn?b.name:t.user.name;let a="";"text"===n.type?a=n.content:"image"===n.type?a=n.isOwn&&n.imageData?"[图片]":`[图片: ${n.imageDescription||""}]`:"voice"===n.type?a=`[语音: ${n.voiceText}]`:"sticker"===n.type&&(a="[表情包]"),L+=`\n${e+1}. ${o}: ${a}`}),L+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",t._isBusinessBetrayal&&(L+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🔥 特殊模式：商业推广反水 🔥\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨 **重要：${t.user.name} 决定"反水"，不按照商业任务要求发推文！**\n**反水类型（选择其中一种）**：\n1. **揭露型**（40%）：\n- 直接揭露有人花钱让自己发广告\n- 例："有人给我钱让我宣传XXX，但我觉得这东西真的很一般..."\n- 例："刚收到一个推广邀约，说实话我用过那玩意儿，不推荐"\n2. **吐槽型**（30%）：\n- 吐槽任务本身或产品/服务\n- 例："又有人让我帮忙推广了，但这次的东西真的...算了不说了"\n- 例："有些推广真的很无语，明明产品质量那样还要我说好话"\n3. **完全不配合型**（20%）：\n- 完全不提任务，发自己想发的内容\n- 例："今天心情不好，不想工作"\n- 例："做自己想做的事比什么都重要"\n4. **阴阳怪气型**（10%）：\n- 表面上完成任务，但用讽刺/暗示的语气\n- 例："某个'非常好用'的产品（此处省略一万字）"\n- 例："终于可以体验到'传说中'的XXX了呢😊"\n**生成要求**：\n- 推文必须体现${t.user.name}的性格特质\n- 根据角色设定选择合适的反水方式\n- 推文要自然，不要太刻意\n- 可以保留一定的模糊性，让读者自己理解\n- stats数据要合理（反水推文可能会有更多讨论：comments 20-60, likes 50-200）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,$=d.logTokenUsage("Tweet生成器","反水模式说明",L.substring(L.lastIndexOf("🔥 特殊模式")),$));const N=L.substring(L.lastIndexOf("🎯 核心任务"));$=d.logTokenUsage("Tweet生成器","核心任务说明",N,$);const R=L.length;L+=`\n【用户X平台资料】（用于理解对话背景）：\n- 用户名：${b.name}\n- 用户句柄：${b.handle}\n- 认证状态：${b.verified?"已认证":"未认证"}\n${b.publicIdentity?`- 公众身份：${b.publicIdentity}`:""}\n${b.bio?`- 个人简介：${b.bio}`:""}\n`,w.length>0&&(L+="\n【用户最近推文】（供参考，对话可能涉及这些推文）：\n",w.forEach((n,e)=>{L+=`\n${e+1}. "${n.content}"\n- 发布时间：${n.time||"最近"}\n- 互动数据：${n.stats?.likes||0}喜欢，${n.stats?.comments||0}评论\n`}));const H=L.substring(R);$=d.logTokenUsage("Tweet生成器","用户资料和推文",H,$);const j=L.length;console.log("🔍 [Tweet生成] 用户身份识别列表:",b.knownIdentityCharacters,`角色ID: ${h}`);const U=await s.getUnifiedProfile(t.user.handle,{userProfileInfo:b});if(U){"character"===U.type&&(console.log(`🔍 [Tweet生成] 角色知道用户身份: ${U.knowsUserIdentity}`),console.log(`🔍 [Tweet生成] 角色用户人设: "${U.characterData?.userPersona||"无"}"`)),L+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━",L+=s.formatProfileForPrompt(U,{includeType:!0,includeTweets:!0,includeRelationships:!0}),L+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**推文生成要求**：\n- 推文内容必须严格符合${U.name}的${"character"===U.type?"性格和说话风格":"身份和风格"}\n${i?`- 🎯 **后台自动发推重点**：推文以刻画${U.name}自身为主（日常、想法、近况、感受等）\n- 聊天记录仅作为灵感来源，不要直接提及或暗示与用户的对话\n- 推文应该像${U.name}的独立生活动态，而非对话延续\n- 可以是：分享心情、吐槽日常、发表观点、晒照片、记录生活等\n- 时间感：距离上次聊天已过去${Math.floor(r/60)}分钟，推文可以反映这段时间的活动`:"- 推文要与私信对话内容相关"}\n`,"character"===U.type?(L+="- 参考角色人设和最近的推文风格\n",U.knowsUserIdentity?(L+=`- ✅ 该角色知道用户身份（${b.name} / ${b.handle}），推文中可以自然地@用户或提及与用户相关的内容\n`,L+="- 可以结合对用户的了解生成推文内容\n"):(L+="- ❌ 该角色不知道用户身份，推文不应该直接提及或@用户\n",L+="- 推文内容独立于用户，不要暗示认识用户\n")):"account"===U.type&&(L+="- 参考账户的发帖习惯和平台形象\n");const n=L.substring(j);$=d.logTokenUsage("Tweet生成器","发送者详细信息",n,$)}else L+=`\n**推文生成要求**：\n- 推文内容要符合 ${t.user.name} 的身份和对话语境\n- 推文要与私信对话内容相关\n`;L+=`\n- 内容要自然，像是真实用户会发布的推文\n- 可以包含情绪、观点、分享或日常内容\n- 字数控制在20-200字之间\n- 可以带emoji表情\n- ${i?"40%":"30%"}的概率带图片（如果合适的话，提供图片描述）\n- stats数据要合理（普通用户流量：comments 5-30, retweets 10-80, likes 20-150, views 100-2000）\n${i?`\n🎯 **后台自动发推特别提示**：\n- 推文要体现${t.user.name}的独立生活和个性\n- 不要让推文看起来像是在回应某个对话\n- 可以发一些与聊天无关的日常内容\n- 展现角色在用户不在场时的生活状态${k.length>0?`\n\n🗑️ **旧推文清理决策**（重要！）：\n你需要同时决定是否删除一些旧推文。${t.user.name}当前有以下推文：\n\n${k.map((n,e)=>`\n${e+1}. [ID: ${n.id||`tweet_${e}`}]\n内容: "${n.content}"\n发布时间: ${n.timestamp?new Date(n.timestamp).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}):"未知"}\n互动数据: ${n.stats?.likes||0}赞 ${n.stats?.comments||0}评论 ${n.stats?.retweets||0}转发`).join("")}\n\n**删除标准（选择性删除，不是必须删除）**：\n1. **内容重复**：多条推文表达相同的意思或话题\n2. **啰嗦冗余**：推文内容过于琐碎、没有价值\n3. **后悔发布**：不符合角色人设、暴露了不该说的信息\n4. **过时内容**：已经不再relevant的临时性内容\n5. **质量低劣**：文字表达不佳、没有意义的推文\n6. **情绪化发言**：当时情绪激动发布的不当内容\n\n**删除决策原则**：\n- 🎯 **选择性删除**：不是所有推文都要删，只删除确实有问题的\n- 📊 **保持数量**：一般保留10-15条优质推文即可\n- ⚖️ **权衡利弊**：互动数据高的推文需要更强的理由才删除\n- 🤔 **符合性格**：删除决策要符合${t.user.name}的性格特点\n  * 完美主义者可能删除更多\n  * 随性的人可能很少删除\n  * 谨慎的人会删除可能引起争议的\n  * 粗线条的人基本不在意旧推文\n\n**如何返回删除决策**：\n- 在JSON的 "tweetsToDelete" 字段中列出要删除的推文ID\n- 可以返回空数组 [] 表示不删除任何推文\n- 每个ID必须是上述列表中的真实ID`:""}`:""}\n【JSON返回格式】：\n\`\`\`json\n{\n"content": "推文文本内容",\n"image": {"type": "description", "content": "图片描述"} 或 null,\n"time": "刚刚",\n"stats": {\n"comments": 评论数,\n"retweets": 转发数,\n"likes": 点赞数,\n"views": 浏览数\n},${i&&k.length>0?'\n"tweetsToDelete": ["要删除的推文ID1", "要删除的推文ID2"] 或 [],':""}\n"comments": [\n{\n "id": "评论唯一ID（可留空，系统自动生成）",\n "user": {\n "name": "评论者昵称",\n "handle": "@评论者句柄",\n "avatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n "verified": false\n },\n "content": "评论文本",\n "time": "时间描述（如'2小时前'）",\n "image": {"type": "description", "content": "图片文字描述"} (可选，10-20%的评论带图),\n "stats": {\n "replies": 回复数,\n "retweets": 转发数,\n "likes": 点赞数\n }\n}\n]\n}\n\`\`\`\n关键规则：\n1. 推文内容要与对话上下文相关\n2. 🚨 推文是 ${t.user.name} 发布的，不是 ${b.name}\n3. 符合发布者的说话风格和身份\n4. stats中所有数字必须是纯数字，不带引号\n5. image字段可选，如果不需要图片就设为null\n6. **必须包含2-5条评论**，评论要与推文内容相关且自然\n7. 10-20%的评论可以带图（image字段）\n8. 评论的stats数据要合理（replies 0-10, retweets 0-20, likes 1-50）${i&&k.length>0?`\n9. 🗑️ **tweetsToDelete字段**：根据上述删除标准决定要删除的推文ID列表\n   - 可以是空数组[]（不删除任何推文）\n   - 可以包含1-5个推文ID（选择性删除）\n   - 每个ID必须是现有推文列表中的真实ID\n   - 删除决策要符合${t.user.name}的性格特点`:""}\n`;const O=L.substring(L.lastIndexOf("【JSON返回格式】"));$=d.logTokenUsage("Tweet生成器","JSON格式要求",O,$),d.logFinalPrompt("Tweet生成器",L,"请生成推文");const _=[{role:"user",content:"请生成推文"}],F=await g.sendAIRequest({apiConfig:l,systemPrompt:L,messages:_,temperature:.8}),X=g.parseJSONResponse(F);let q=X.tweetsToDelete||[];i&&q.length>0&&(console.log(`🗑️ [Tweet生成] AI决定删除 ${q.length} 条旧推文:`,q),await async function(n,t){try{if(!t||0===t.length)return;const o=e(),a=n.replace("@","");console.log(`🗑️ [推文删除] 开始从 ${a} 的主页删除 ${t.length} 条推文`);let i=await o.xAccountProfiles.get(a);if(!i||!i.tweets)return void console.log("⏭️ [推文删除] 账户主页不存在或无推文，跳过删除");const r=i.tweets.length;i.tweets=i.tweets.filter(n=>!t.includes(n.id));const s=i.tweets.length,l=r-s;l>0?(i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log(`✅ [推文删除] 成功删除 ${l} 条推文，当前推文总数: ${s}`)):console.log("⏭️ [推文删除] 未找到要删除的推文ID，可能已被删除")}catch(n){console.error("❌ [推文删除] 删除推文失败:",n)}}(t.user.handle,q)),delete X.tweetsToDelete;const V=Date.now();return X.id=`newtweet_${V}`,X.user=t.user,X.timestamp=V,delete X.time,X.comments&&X.comments.length>0&&X.comments.forEach((n,e)=>{n.id||(n.id=`newtweet_${V}_c${e}`),n.timestamp||(n.timestamp=V+60*(5+30*Math.random())*1e3),delete n.time}),console.log("✅ [Tweet生成] 推文内容已生成:",X),X}catch(n){return console.error("❌ [Tweet生成] 失败:",n),null}}n.toggleChatHistoryDetection=async function(){wl=!wl;const n=document.getElementById("chat-history-detection-toggle"),e=n.querySelector(".toggle-circle"),t=document.getElementById("chat-history-detection-status");wl?(n.style.backgroundColor="var(--x-accent)",e.style.left="22px",t.style.display="block",await $l(),function(){yl&&clearInterval(yl);yl=setInterval(async()=>{await $l()},kl),Cl()}(),await Il(!0),mn("聊天记忆检测已开启","success")):(n.style.backgroundColor="#333",e.style.left="2px",t.style.display="none",yl&&(clearInterval(yl),yl=null),await Il(!1),mn("聊天记忆检测已关闭","info"))};let Al=null,El=!1,zl=new Set;function Bl(e,t=!1,o,a=!0,i=!0){Rn[Hn]||Rn.zh;const r=void 0!==o?`msg_idx_${o}`:`msg_temp_${Math.random()}`,s=!t&&e.senderId&&e.senderName,l=document.createElement("div");if(l.className="message-item",l.setAttribute("data-message-id",r),l.setAttribute("data-message-index",void 0!==o?o:-1),l.style.cssText=`\n display: flex; flex-direction: column; align-items: ${t?"flex-end":"flex-start"}; margin-bottom: ${a?"16px":"4px"}; position: relative; transition: opacity 0.2s; opacity: 0; transform: translateY(10px);\n`,s){const n=document.createElement("div");n.style.cssText="\n display: flex; align-items: flex-start; gap: 8px; width: 100%; ";const t=document.createElement("img");t.src=e.senderAvatar,t.style.cssText="\n width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; margin-top: 2px; ",n.appendChild(t);const o=document.createElement("div");o.style.cssText="\n flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; ";const a=document.createElement("div");a.style.cssText="\n display: flex; align-items: center; gap: 6px; ",a.innerHTML=`\n <span style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); ">${e.senderName}</span>\n <span style="font-size: 13px; color:var(--x-text-secondary); ">${e.senderHandle}</span>\n `,o.appendChild(a),n.appendChild(o),l.appendChild(n),l.style.flexDirection="row",l.style.alignItems="flex-start"}if(El){const n=zl.has(r),e=document.createElement("div");e.className="message-select-indicator",e.style.cssText=`\n position: absolute; ${t?"right: -10px;":"left: -10px;"}\n top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${n?"var(--x-accent)":"var(--x-border-color)"}; background-color: ${n?"var(--x-accent)":"var(--x-bg-primary)"}; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; `,n&&(e.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #fff;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></g>\n </svg>\n '),e.onclick=n=>{n.stopPropagation(),Oc(r)},l.appendChild(e),l.style.opacity=n?"0.7":"1"}let c=null;const d=n=>{El||(c=setTimeout(()=>{El=!0,zl.clear(),function(){const n=document.getElementById("message-input-toolbar");n&&(n.style.display="none");let e=document.getElementById("message-delete-toolbar");if(!e){e=document.createElement("div"),e.id="message-delete-toolbar",e.style.cssText="\n position: fixed; bottom: 0; left: 0; right: 0; height: 56px; background-color:var(--x-bg-primary); border-top: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 100; ",e.innerHTML='\n <div style="display: flex; align-items: center; gap: 16px;">\n <button onclick="exitMessageMultiSelectMode()" style="background: none; border: none; color: var(--x-accent); font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 0; ">取消</button>\n <button onclick="selectAllMessages()" style="background: none; border: none; color: var(--x-accent); font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 0; ">全选</button>\n </div>\n <div style="color:var(--x-text-secondary); font-size: 14px; ">\n 已选择 <span id="message-selected-count">0</span> 条\n </div>\n <button onclick="deleteSelectedMessages()" id="message-delete-btn" style="background-color: #f4212e; border: none; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 18px; opacity: 0.5; pointer-events: none; ">删除</button>\n ';const n=document.getElementById("x-message-detail-page");n&&n.appendChild(e)}e.style.display="flex"}(),_c(),Oc(r),navigator.vibrate&&navigator.vibrate(50)},500))},p=()=>{c&&(clearTimeout(c),c=null)};l.addEventListener("touchstart",d),l.addEventListener("touchend",p),l.addEventListener("touchmove",p),l.addEventListener("mousedown",d),l.addEventListener("mouseup",p),l.addEventListener("mouseleave",p),El&&(l.style.cursor="pointer",l.onclick=()=>{Oc(r)});const g=document.createElement("div"),m=`\n max-width: 70%; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; ${a?t?"border-bottom-right-radius: 4px;":"border-bottom-left-radius: 4px;":""}\n`;if("text"===e.type){g.style.cssText=m+`\n padding: 12px 16px; background-color: ${t?"var(--x-accent)":"var(--x-bg-secondary)"}; color: ${t?"#fff !important":"var(--x-text-primary)"}; width: fit-content; `;const n=R(e.content||"",{isOwn:t});g.innerHTML=n}else if("image"===e.type){g.style.cssText=m+"\n padding: 0; background-color: transparent; width: fit-content; ";const t=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o=document.createElement("div");if(o.id=t,o.style.cssText=`\n position: relative; border-radius: 12px; overflow: hidden; ${e.imageData?"background-color: transparent;":"background-color: rgba(142, 142, 142, 0.15); padding: 16px;"}\n max-width: ${e.imageData?"200px":"280px"}; `,e.imageData){const t=document.createElement("img");t.src=e.imageData,t.style.cssText="\n max-width: 200px; max-height: 200px; width: auto; height: auto; display: block; border-radius: 12px; cursor: pointer; ",t.onclick=()=>{n.open(e.imageData,"_blank")},o.appendChild(t)}else{const n=document.createElement("div");n.style.cssText="\n color:var(--x-text-primary); font-size: 15px; line-height: 1.4; word-wrap: break-word; ",n.textContent=e.imageDescription||"[图片]",o.appendChild(n)}if(e.sensitive){const n=`mask_${t}`,e=document.createElement("div");e.id=n,e.style.cssText="\n position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; z-index: 1; ",e.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #fff; margin-bottom: 8px;">\n <g><path d="M12 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm0-4c-.552 0-1 .448-1 1s.448 1 1 1 1-.448 1-1-.448-1-1-1z"></path><path d="M12 5c-7.633 0-9.927 6.617-9.948 6.684L1.946 12l.105.316C2.073 12.383 4.367 19 12 19s9.927-6.617 9.948-6.684l.106-.316-.105-.316C21.927 11.617 19.633 5 12 5zm0 12c-5.351 0-7.424-3.846-7.926-5C4.578 10.842 6.652 7 12 7c5.351 0 7.424 3.846 7.926 5-.504 1.158-2.578 5-7.926 5z"></path></g>\n </svg>\n <div style="color: #fff; font-weight: 600; font-size: 15px; margin-bottom: 4px;">可能含有敏感内容</div>\n <div style="color: rgba(255,255,255,0.8); font-size: 13px;">点击查看</div>\n ',e.onclick=function(){this.style.display="none"},o.appendChild(e)}g.appendChild(o)}else if("voice"===e.type){g.style.cssText=m+`\n padding: 10px 14px; background-color: ${t?"var(--x-accent)":"var(--x-bg-secondary)"}; color: ${t?"#fff":"var(--x-text-primary)"}; max-width: 180px; width: fit-content; `;const n=`voice_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;g.innerHTML=`\n <div id="${n}" style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: ${t?"#fff":"var(--x-text-primary)"};" onclick="toggleVoiceText('${n}', '${e.voiceText?.replace(/'/g,"\\'")}')">\n <div style="width: 32px; height: 32px; border-radius: 50%; background-color: ${t?"rgba(255,255,255,0.2)":"var(--x-accent)"}; display: flex; align-items: center; justify-content: center; flex-shrink: 0; ">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n <g><path d="M8 5v14l11-7z"></path></g>\n </svg>\n </div>\n <span style="font-weight: 600; color: inherit; font-size: 14px;">${e.duration||"0:05"}</span>\n </div>\n `}else if("sticker"===e.type)g.style.cssText=m+"\n padding: 0; background-color: transparent; width: fit-content; ",g.innerHTML=`\n <div style="max-width: 120px; border-radius: 8px; overflow: hidden; ">\n <img src="${e.stickerUrl}"\n alt="表情包"\n style="width: 100%; height: auto; display: block; border-radius: 8px; "\n onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding: 12px; color:var(--x-text-secondary); text-align: center;\\'>表情包加载失败</div>';">\n </div>\n `;else if("link"===e.type){g.style.cssText=m+"\n padding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; ";const n=`link_card_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;g.innerHTML=`\n <div id="${n}" style="border: 1px solid var(--x-border-color); border-radius: 12px; overflow: hidden; background-color:var(--x-bg-secondary); cursor: pointer; transition: all 0.2s; "\n onmouseover="this.style.backgroundColor='var(--x-bg-hover)'; this.style.borderColor='var(--x-accent)'"\n onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'; this.style.borderColor='var(--x-border-color)'">\n <div style="padding: 12px;">\n <div style="font-weight: 600; margin-bottom: 4px; color:var(--x-text-primary);">\n ${e.title||"链接"}\n </div>\n ${e.description?`\n <div style="font-size: 13px; color:var(--x-text-secondary); margin-bottom: 8px;">\n ${e.description}\n </div>\n `:""}\n <div style="font-size: 13px; color: var(--x-accent); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">\n ${e.url||"点击查看文章"}\n </div>\n </div>\n </div>\n `,setTimeout(()=>{const t=document.getElementById(n);t&&(t.onclick=()=>{openArticlePage({title:e.title,author:e.author||"佚名",source:e.source||e.url||"未知来源",body:e.body||e.description||""})})},0)}else if("quoteTweet"===e.type)g.style.cssText=m+"\n padding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; ",g.innerHTML=`\n ${e.caption?`\n <div style="padding: 12px 16px; background-color: ${t?"var(--x-accent)":"var(--x-bg-secondary)"}; color: ${t?"#fff":"var(--x-text-primary)"}; border-radius: 12px; margin-bottom: 8px; width: fit-content; ">${R(e.caption||"",{isOwn:t})}</div>\n `:""}\n <div style="border: 1px solid var(--x-border-color); border-radius: 12px; padding: 12px; background-color:var(--x-bg-secondary); width: fit-content; max-width: 100%; ">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <img src="${e.tweet.userAvatar}" style="width: 20px; height: 20px; border-radius: 50%;">\n <span style="font-weight: 600; color:var(--x-text-primary);">${e.tweet.userName}</span>\n ${e.tweet.verified?'\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.26 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.45 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>\n </svg>\n ':""}\n <span style="color:var(--x-text-secondary); font-size: 13px;">${e.tweet.userHandle}</span>\n <span style="color:var(--x-text-secondary); font-size: 13px;">·</span>\n <span style="color:var(--x-text-secondary); font-size: 13px;">${e.tweet.time}</span>\n </div>\n <div style="color:var(--x-text-primary);">${R(e.tweet.content||"",{isOwn:!1})}</div>\n </div>\n `;else if("quoteProfile"===e.type){g.style.cssText=m+"\n padding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; ";const n=`profile_card_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;g.innerHTML=`\n ${e.caption?`\n <div style="padding: 12px 16px; background-color: ${t?"var(--x-accent)":"var(--x-bg-secondary)"}; color: ${t?"#fff":"var(--x-text-primary)"}; border-radius: 12px; margin-bottom: 8px; ">${R(e.caption||"",{isOwn:t})}</div>\n `:""}\n <div id="${n}" style="border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; background-color:var(--x-bg-secondary); cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'">\n <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">\n <img src="${e.profile.avatar}" style="width: 48px; height: 48px; border-radius: 50%;">\n <div style="flex: 1;">\n <div style="display: flex; align-items: center; gap: 4px;">\n <span style="font-weight: 700; color:var(--x-text-primary);">${e.profile.name}</span>\n ${e.profile.verified?'\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <g><path d="M22.25 12c0-1.43-.88-2.67-2.19-3.34.46-1.39.2-2.9-.81-3.91s-2.52-1.27-3.91-.81c-.66-1.31-1.91-2.19-3.34-2.19s-2.67.88-3.33 2.19c-1.4-.46-2.91-.2-3.92.81s-1.26 2.52-.8 3.91c-1.31.67-2.2 1.91-2.2 3.34s.89 2.67 2.2 3.34c-.46 1.39-.21 2.9.8 3.91s2.52 1.26 3.91.81c.67 1.31 1.91 2.19 3.34 2.19s2.68-.88 3.34-2.19c1.39.45 2.9.2 3.91-.81s1.27-2.52.81-3.91c1.31-.67 2.19-1.91 2.19-3.34zm-11.71 4.2L6.8 12.46l1.41-1.42 2.26 2.26 4.8-5.23 1.47 1.36-6.2 6.77z"></path></g>\n </svg>\n ':""}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px;">${e.profile.handle}</div>\n </div>\n </div>\n ${e.profile.bio?`\n <div style="color:var(--x-text-primary); margin-bottom: 8px; font-size: 14px;">\n ${e.profile.bio}\n </div>\n `:""}\n <div style="color:var(--x-text-secondary); font-size: 13px;">\n ${e.profile.followers} 位关注者\n </div>\n </div>\n `,setTimeout(()=>{const t=document.getElementById(n);t&&(t.onclick=()=>{openAccountProfileFromQuoteProfile(e.profile)})},0)}else if("quoteFanGroup"===e.type){g.style.cssText=m+"\npadding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; ";const n=`fangroup_card_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;g.innerHTML=`\n${e.caption?`\n<div style="padding: 12px 16px; background-color: ${t?"var(--x-accent)":"var(--x-bg-secondary)"}; color: ${t?"#fff":"var(--x-text-primary)"}; border-radius: 12px; margin-bottom: 8px; ">${R(e.caption||"",{isOwn:t})}</div>\n`:""}\n<div id="${n}" style="border: 1px solid var(--x-border-color); border-radius: 12px; padding: 16px; background-color:var(--x-bg-secondary); cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\nonmouseout="this.style.backgroundColor='var(--x-bg-secondary)'">\n<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">\n<img src="${e.fanGroup.avatar}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">\n<div style="flex: 1;">\n<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">\n<span style="font-weight: 700; color:var(--x-text-primary); font-size: 15px;">${e.fanGroup.name}</span>\n<span style="padding: 2px 8px; background-color:var(--x-bg-primary); color:var(--x-text-secondary); font-size: 11px; border-radius: 4px; font-weight: 600; ">粉丝群</span>\n</div>\n<div style="color:var(--x-text-secondary); font-size: 13px;">\n${e.fanGroup.memberCount} 位成员\n</div>\n</div>\n</div>\n${e.fanGroup.threshold?`\n<div style="padding: 10px; background-color:var(--x-bg-primary); border-radius: 8px; color:var(--x-text-secondary); font-size: 12px; line-height: 1.4; margin-top: 8px; ">\n<div style="color:var(--x-text-primary); font-weight: 600; margin-bottom: 4px; font-size: 11px;">入群门槛</div>\n${e.fanGroup.threshold.length>100?e.fanGroup.threshold.substring(0,100)+"...":e.fanGroup.threshold}\n</div>\n`:""}\n</div>\n`,setTimeout(()=>{const t=document.getElementById(n);t&&(t.onclick=()=>{console.log("点击了粉丝群卡片:",e.fanGroup)})},0)}else if("groupFile"===e.type){g.style.cssText=m+"\npadding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; max-width: 280px; ";const n=`file_card_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t=Ec(e.file.type),o={text:"#2b303b",image:"#2e3440",video:"#262b36",link:"#272c36",default:"#252933"},a=o[e.file.type]||o.default,i=new Date(e.file.uploadedAt),r=`${i.getMonth()+1}/${i.getDate()} ${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}`;g.innerHTML=`\n<div id="${n}" style="\n border: 1px solid var(--x-border-color);\n border-radius: 12px;\n overflow: hidden;\n background-color:var(--x-bg-secondary);\n cursor: pointer;\n transition: all 0.2s;\n" onmouseover="this.style.backgroundColor='var(--x-bg-hover)'; this.style.borderColor='var(--x-accent)'"\n onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'; this.style.borderColor='var(--x-border-color)'">\n \x3c!-- 文件头部 --\x3e\n <div style="\n display: flex;\n align-items: center;\n gap: 12px;\n padding: 12px;\n border-bottom: 1px solid var(--x-border-color);\n ">\n \x3c!-- 文件图标 --\x3e\n <div style="\n width: 38px;\n height: 38px;\n border-radius: 6px;\n background-color: ${a};\n display: flex;\n align-items: center;\n justify-content: center;\n flex-shrink: 0;\n box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n ">\n <div style="width: 18px; height: 18px; color: rgba(255,255,255,0.85);">\n ${t.replace("currentColor","rgba(255,255,255,0.85)")}\n </div>\n </div>\n\n \x3c!-- 文件信息 --\x3e\n <div style="flex: 1; min-width: 0;">\n <div style="\n color:var(--x-text-primary);\n font-size: 14px;\n font-weight: 600;\n overflow: hidden;\n text-overflow: ellipsis;\n white-space: nowrap;\n margin-bottom: 2px;\n ">${e.file.name}</div>\n <div style="\n color:var(--x-text-secondary);\n font-size: 11px;\n display: flex;\n align-items: center;\n gap: 6px;\n ">\n <span>${e.file.uploadedBy}</span>\n <span>·</span>\n <span>${r}</span>\n </div>\n </div>\n </div>\n\n \x3c!-- 文件内容预览 --\x3e\n <div style="\n padding: 10px 12px;\n color:var(--x-text-secondary);\n font-size: 12px;\n line-height: 1.4;\n max-height: 60px;\n overflow: hidden;\n text-overflow: ellipsis;\n display: -webkit-box;\n -webkit-line-clamp: 3;\n -webkit-box-orient: vertical;\n ">${e.file.content.substring(0,100)}${e.file.content.length>100?"...":""}</div>\n</div>\n`,setTimeout(()=>{const t=document.getElementById(n);t&&(t.onclick=()=>{zc(e.file)})},0)}else if("transfer"===e.type){g.style.cssText=m+"\n padding: 0; background-color: transparent; width: fit-content; ";const n=document.getElementById("x-social-screen"),o=n&&n.classList.contains("x-theme-light"),a=t,i=parseFloat(e.amount||0).toFixed(2),r="transfer-card-"+(e.timestamp||Date.now()),s=!0===e.isBusiness;g.innerHTML=`\n <div id="${r}" style="position: relative; background-color: ${o?"#ffffff":"#1f1f1f"}; border-radius: 12px; padding: 12px 16px; max-width: 200px; box-shadow: ${o?"0 2px 8px rgba(0, 0, 0, 0.1), 0 4px 16px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.05)":"0 2px 8px rgba(0, 0, 0, 0.3), 0 4px 16px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(255, 255, 255, 0.05)"}; border: 1px solid ${s?o?"rgba(29, 155, 240, 0.3)":"rgba(29, 155, 240, 0.4)":o?"rgba(0, 0, 0, 0.06)":"rgba(255, 255, 255, 0.08)"}; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; "\n onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='${o?"0 4px 12px rgba(0, 0, 0, 0.15), 0 6px 20px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06)":"0 4px 12px rgba(0, 0, 0, 0.4), 0 6px 20px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(255, 255, 255, 0.08)"}'"\n onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='${o?"0 2px 8px rgba(0, 0, 0, 0.1), 0 4px 16px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.05)":"0 2px 8px rgba(0, 0, 0, 0.3), 0 4px 16px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(255, 255, 255, 0.05)"}'"\n ">\n ${s?'\n\n <div style="position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; background-color: var(--x-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3); ">\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: #ffffff;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path><path d="M12 10L14.5 14L17 10L14.5 12L12 10ZM10 10L7.5 12L10 14L7.5 14L10 10Z"></path></g>\n </svg>\n </div>\n ':""}\n\n <div style="width: 36px; height: 36px; border-radius: 50%; background-color: ${o?"#f5f5f5":"#2d2d2d"}; display: flex; align-items: center; justify-content: center; flex-shrink: 0; ">\n${function(n,e){const t=e?"#666666":"#cccccc";if(!n||"pending"===n)return`\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: ${t};">\n <g><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10s10-4.486,10-10S17.514,2,12,2z M12,20c-4.411,0-8-3.589-8-8 s3.589-8,8-8s8,3.589,8,8S16.411,20,12,20z"></path><path d="M13,7h-2v5.414l3.293,3.293l1.414-1.414L13,11.586V7z"></path></g>\n </svg>\n `;if("accepted"===n)return`\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: ${t};">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></g>\n </svg>\n `;if("rejected"===n)return`\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: ${t};">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"></path></g>\n </svg>\n `;return`\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: ${t};">\n <g><path d="M12,2C6.486,2,2,6.486,2,12s4.486,10,10,10s10-4.486,10-10S17.514,2,12,2z M12,20c-4.411,0-8-3.589-8-8 s3.589-8,8-8s8,3.589,8,8S16.411,20,12,20z"></path><path d="M13,7h-2v5.414l3.293,3.293l1.414-1.414L13,11.586V7z"></path></g>\n </svg>\n`}(e.status,o)}\n </div>\n\n <div style="display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; ">\n <div style="font-size: 11px; font-weight: 500; color: ${o?"#888888":"#aaaaaa"}; text-transform: uppercase; letter-spacing: 0.3px; ">${s?"💼 ":""}${Ul(e.status,a)}</div>\n <div style="font-size: 16px; font-weight: 600; color: ${o?"#1a1a1a":"#e5e5e5"}; line-height: 1; ">\n ${Ol(e.status,a,i)}\n </div>\n ${e.note?`\n <div style="font-size: 11px; color: ${o?"#666666":"#999999"}; line-height: 1.2; margin-top: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${e.note}</div>\n `:""}\n </div>\n\n <div style="width: 6px; height: 6px; border-radius: 50%; background-color: ${s?"var(--x-accent)":o?"#666666":"#999999"}; flex-shrink: 0; "></div>\n </div>\n `,setTimeout(()=>{const n=document.getElementById(r);n&&(n.onclick=()=>{openTransferDetails(e,t)})},0)}else if("system"===e.type)l.style.alignItems="center",g.style.cssText="\n padding: 8px 16px; background-color:var(--x-bg-secondary); border-radius: 16px; font-size: 13px; color:var(--x-text-secondary); text-align: center; max-width: 80%; ",g.textContent=e.content;else if("forward"===e.type){g.style.cssText=m+"\n padding: 0; background-color: transparent; color:var(--x-text-primary); width: fit-content; ";const n="tweet"===e.forwardType?"推文":"评论";g.innerHTML=`\n <div style="border: 1px solid var(--x-border-color); border-radius: 12px; overflow: hidden; background-color:var(--x-bg-secondary); ">\n\n <div style="padding: 8px 12px; background-color: var(--x-bg-hover); border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: var(--x-text-secondary);">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n <span style="font-size: 12px; color:var(--x-text-secondary);">转发${n}</span>\n </div>\n\n <div style="padding: 12px;">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <img src="${e.forwardContent.user.avatar}" style="width: 24px; height: 24px; border-radius: 50%;">\n <div style="display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0;">\n <span style="font-weight: 600; color:var(--x-text-primary); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n ${e.forwardContent.user.name}\n </span>\n <span style="color:var(--x-text-secondary); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n ${e.forwardContent.user.handle}\n </span>\n </div>\n </div>\n <div style="color:var(--x-text-primary); font-size: 14px; line-height: 1.4; word-wrap: break-word;">\n ${R(e.forwardContent.content||"无内容",{isOwn:!1})}\n </div>\n ${e.forwardContent.image?"description"===e.forwardContent.image.type?`\n <div style="margin-top: 8px; background-color:var(--x-bg-primary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 8px;">\n <div style="color:var(--x-text-secondary); font-size: 13px;">${e.forwardContent.image.content}</div>\n </div>\n `:`\n <div style="margin-top: 8px; border-radius: 8px; overflow: hidden;">\n <img src="${e.forwardContent.image.content}" style="max-width: 100%; max-height: 200px; border-radius: 8px;" alt="图片">\n </div>\n `:""}\n ${e.forwardContent.time?`\n <div style="color:var(--x-text-secondary); font-size: 12px; margin-top: 8px;">\n ${e.forwardContent.time}\n </div>\n `:""}\n </div>\n </div>\n `}if(s){const n=l.querySelector("div"),e=n?.querySelector("div:nth-child(2)");e?e.appendChild(g):l.appendChild(g)}else l.appendChild(g);if(i&&a){const n=document.createElement("div");if(n.style.cssText="\n font-size: 12px; color:var(--x-text-secondary); margin-top: 4px; padding: 0 4px;\n",e.timestamp?n.textContent=xc(e.timestamp):n.textContent=e.time||"刚刚",s){const e=l.querySelector("div"),t=e?.querySelector("div:nth-child(2)");t?t.appendChild(n):l.appendChild(n)}else l.appendChild(n)}return l}function Ll(){console.log("🔵 [正在输入] 开始显示气泡");const n=document.getElementById("message-detail-content");if(!n)return void console.warn("⚠️ [正在输入] 找不到消息容器");let e=document.getElementById("typing-indicator");e&&(console.log("⚠️ [正在输入] 检测到旧气泡，先移除"),e.remove()),console.log("✅ [正在输入] 创建气泡元素");const t=function(){const n=document.createElement("div");n.id="typing-indicator",n.className="message-item",n.style.cssText="\n display: flex !important; flex-direction: column; align-items: flex-start; margin-bottom: 16px; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; position: relative; z-index: 1;\n";const e=document.createElement("div");e.style.cssText="\n padding: 12px 16px; border-radius: 18px; border-bottom-left-radius: 4px; background-color:var(--x-bg-secondary); display: flex; align-items: center; gap: 5px;\n";for(let n=0;n<3;n++){const t=document.createElement("div");t.style.cssText=`\n width: 8px; height: 8px; border-radius: 50%; background-color:var(--x-text-secondary); animation: typingBounce 1.4s infinite ease-in-out; animation-delay: ${.2*n}s; flex-shrink: 0; `,e.appendChild(t)}if(n.appendChild(e),!document.getElementById("typing-animation-style")){const n=document.createElement("style");n.id="typing-animation-style",n.textContent="\n @keyframes typingBounce {\n 0%, 60%, 100% {\n transform: translateY(0); opacity: 0.7; }\n 30% {\n transform: translateY(-10px); opacity: 1; }\n }\n ",document.head.appendChild(n)}return n}();n.appendChild(t),console.log("✅ [正在输入] 气泡已添加到DOM",t),requestAnimationFrame(()=>{requestAnimationFrame(()=>{t&&t.parentNode&&(t.style.opacity="1",t.style.transform="translateY(0)",console.log("✅ [正在输入] 气泡动画已触发"))})}),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTo({top:n.scrollHeight,behavior:"smooth"}),console.log("✅ [正在输入] 已滚动到底部"))},100)}function Pl(){console.log("🔴 [正在输入] 开始隐藏气泡");const n=document.getElementById("typing-indicator");n?(n.style.opacity="0",n.style.transform="translateY(10px)",console.log("✅ [正在输入] 气泡开始淡出"),setTimeout(()=>{n&&n.parentNode&&(n.remove(),console.log("✅ [正在输入] 气泡已从DOM移除"))},300)):console.log("⚠️ [正在输入] 气泡不存在，无需隐藏")}async function Dl(n,e=300){for(let t=0;t<n.length;t++){const o=n[t];await new Promise(n=>setTimeout(n,e)),o.style.transition="all 0.3s ease",o.style.opacity="1",o.style.transform="translateY(0)";const a=document.getElementById("message-detail-scrollable");a&&a.scrollTo({top:a.scrollHeight,behavior:"smooth"})}}function Nl(n){const e=[];let t=[],o=null;return n.forEach((n,a)=>{const i=n.senderId||(n.isOwn?"user":"other");null===o||o===i?(t.push({message:n,index:a}),o=i):(e.push(t),t=[{message:n,index:a}],o=i)}),t.length>0&&e.push(t),e}function Rl(n){const{title:e="",message:t="",avatar:o=null,leftIcon:a="x",leftIconHtml:i=null,duration:r=3e3,showTime:s=!0,isCall:l=!1,onAnswer:c=null,onDecline:d=null,onTimeout:p=null,callTimeoutMs:g=3e4,onClick:m=null}=n,x=document.getElementById("phone-notification-popup");if(x){const e=x.dataset?.notificationMode||"normal",t=!!x._closing,o="call"===e&&!t,a=!!l;if(o&&!a)return;if(!t&&a&&"call"!==e){const e=Number(x._closeAt),t=3200,o=Number.isFinite(e)?Math.max(0,Math.trunc(e-Date.now()))+450:t;return void setTimeout(()=>{try{Rl(n)}catch(n){}},o)}if(o&&a)return;try{x._autoCloseTimer&&clearTimeout(x._autoCloseTimer),x._removeTimer&&clearTimeout(x._removeTimer),x._callTimeoutTimer&&clearTimeout(x._callTimeoutTimer),x._callVibrateTimer&&(clearInterval(x._callVibrateTimer),x._callVibrateTimer=null,navigator.vibrate&&navigator.vibrate(0))}catch(n){}x.remove()}if(l&&!document.getElementById("x-call-anim-style")){const n=document.createElement("style");n.id="x-call-anim-style",n.textContent="\n        @keyframes x-pulse-black {\n          0% { box-shadow: 0 0 0 0 var(--x-phone-notif-pulse, rgba(0, 0, 0, 0.35)); }\n          70% { box-shadow: 0 0 0 12px rgba(0, 0, 0, 0); }\n          100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }\n        }\n      ",document.head.appendChild(n)}const u=document.createElement("div");if(u.id="phone-notification-popup",u.dataset.notificationMode=l?"call":"normal",u.style.cssText="\n position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--x-bg-primary); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); padding: 12px 16px; display: flex; align-items: center; gap: 12px; z-index: 10000; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid var(--x-border-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);\n user-select: none; -webkit-user-select: none;\n touch-action: none;\n","x"===a||i||l&&!i){const n=document.createElement("div");n.style.cssText="\n width: 32px; height: 32px; background-color:#000; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; ",n.innerHTML=i||'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n <g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g>\n </svg>\n ',u.appendChild(n)}const h=document.createElement("div");h.style.cssText="\n flex: 1; min-width: 0;\n";let f="";e&&(f+=`\n <div style="font-size: 13px; font-weight: 600; color:var(--x-phone-notif-text-primary, var(--x-text-primary)); margin-bottom: 2px; ">${e}</div>\n `),t&&(f+=`\n <div style="font-size: 14px; color:var(--x-phone-notif-text-secondary, var(--x-text-secondary)); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; ">${t}</div>\n `),h.innerHTML=f,u.appendChild(h);const b=()=>{if(!u._closing){u._closing=!0;try{u._autoCloseTimer&&clearTimeout(u._autoCloseTimer),u._removeTimer&&clearTimeout(u._removeTimer),u._callTimeoutTimer&&clearTimeout(u._callTimeoutTimer),u._callVibrateTimer&&(clearInterval(u._callVibrateTimer),u._callVibrateTimer=null,navigator.vibrate&&navigator.vibrate(0))}catch(n){}u.style.top="-100px",u._removeTimer=setTimeout(()=>{u.parentNode&&u.remove()},400)}};if(l){const n=document.createElement("div");n.style.cssText="\n display: flex; align-items: center; gap: 12px; margin-left: 8px;\n";const t=document.createElement("div");t.style.cssText="\n width: 36px; height: 36px;\n border-radius: 50%;\n background-color: #E5E5E5;\n display: flex; align-items: center; justify-content: center;\n cursor: pointer;\n transition: transform 0.1s;\n",t.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #000;">\n  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n </svg>\n';const o=document.createElement("div");o.style.cssText="\n width: 36px; height: 36px;\n border-radius: 50%;\n background-color: #000000;\n display: flex; align-items: center; justify-content: center;\n cursor: pointer;\n transition: transform 0.1s;\n animation: x-pulse-black 1.5s infinite;\n box-shadow: 0 0 0 0 var(--x-phone-notif-pulse, rgba(0, 0, 0, 0.35));\n filter: drop-shadow(0 0 4px var(--x-phone-notif-pulse, rgba(0, 0, 0, 0.35)));\n",o.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;">\n  <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.44-5.15-3.75-6.59-6.59l1.97-1.57c.26-.26.36-.6.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3.34 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>\n </svg>\n',t.onclick=n=>{n.stopPropagation(),t.style.transform="scale(0.9)",setTimeout(()=>{b(),d&&d(),setTimeout(()=>{Rl({title:e,message:"通话已拒绝",leftIcon:"custom",leftIconHtml:'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',duration:2e3})},200)},100)},o.onclick=n=>{n.stopPropagation(),o.style.transform="scale(0.9)",setTimeout(()=>{b(),c&&c(),setTimeout(()=>{Rl({title:e,message:"通话已接通",leftIcon:"custom",leftIconHtml:'<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #fff;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',duration:2e3})},200)},100)},n.appendChild(t),n.appendChild(o),u.appendChild(n)}else{if(s){const n=document.createElement("div");n.style.cssText=`\n font-size: 11px; color:var(--x-phone-notif-text-secondary, var(--x-text-secondary)); position: absolute; top: 12px; right: ${o?"64px":"16px"}; `;const e=new Date,t=e.getHours(),a=String(e.getMinutes()).padStart(2,"0");n.textContent=`${t}:${a}`,u.appendChild(n)}if(o){const n=document.createElement("img");n.src=o,n.style.cssText="\n width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; ",u.appendChild(n)}}document.body.appendChild(u);try{const n=n=>{if(!n)return null;const e=String(n).trim().toLowerCase();if("transparent"===e)return{r:0,g:0,b:0,a:0};const t=e.match(/^rgba?\\(\\s*(\\d+(?:\\.\\d+)?)\\s*,\\s*(\\d+(?:\\.\\d+)?)\\s*,\\s*(\\d+(?:\\.\\d+)?)(?:\\s*,\\s*(\\d+(?:\\.\\d+)?))?\\s*\\)$/);if(t)return{r:Number(t[1]),g:Number(t[2]),b:Number(t[3]),a:null==t[4]?1:Number(t[4])};const o=e.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);if(o){const n=o[1];if(3===n.length){return{r:parseInt(n[0]+n[0],16),g:parseInt(n[1]+n[1],16),b:parseInt(n[2]+n[2],16),a:1}}return{r:parseInt(n.slice(0,2),16),g:parseInt(n.slice(2,4),16),b:parseInt(n.slice(4,6),16),a:1}}return null},e=(n,e)=>{const t=Math.max(0,Math.min(1,Number(n.a)));return{r:n.r*t+e.r*(1-t),g:n.g*t+e.g*(1-t),b:n.b*t+e.b*(1-t),a:1}},t=n=>{const e=[n.r,n.g,n.b].map(n=>Math.max(0,Math.min(255,Number(n)))/255).map(n=>n<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4));return.2126*e[0]+.7152*e[1]+.0722*e[2]};let o=n(getComputedStyle(u).backgroundColor);if(o){if(o.a<1){const t=getComputedStyle(document.body).backgroundColor||getComputedStyle(document.documentElement).backgroundColor;o=e(o,n(t)||{r:255,g:255,b:255,a:1})}const a=t(o)<.55;u.style.setProperty("--x-phone-notif-text-primary",a?"rgba(255,255,255,0.95)":"rgba(0,0,0,0.9)"),u.style.setProperty("--x-phone-notif-text-secondary",a?"rgba(255,255,255,0.72)":"rgba(0,0,0,0.62)"),u.style.setProperty("--x-phone-notif-pulse",a?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.35)")}}catch(n){}if(requestAnimationFrame(()=>{if(u.isConnected&&!u._closing&&(u.style.top="16px",l&&navigator.vibrate)){const n=[60,90,60,700];try{navigator.vibrate(n)}catch(n){}u._callVibrateTimer=setInterval(()=>{try{navigator.vibrate(n)}catch(n){}},1800)}}),l){const n=Number(g),e=Number.isFinite(n)?Math.max(0,Math.trunc(n)):3e4;u._callTimeoutTimer=setTimeout(()=>{b(),"function"==typeof p&&p()},e)}else u._closeAt=Date.now()+Number(r||0),u._autoCloseTimer=setTimeout(()=>{b()},r),u.onclick=()=>{b(),"function"==typeof m&&m()}}function Hl(n,e,t){const o="en"===Hn,a=o?t>1?" messages":" message":"条私信";Rl({title:n,message:o?`sent you ${t}${a}`:`回复了你 ${t}${a}`,avatar:e,leftIcon:"x"})}function jl(n){const e=document.createElement("div");return e.style.cssText="\n text-align: center; margin: 24px 0 16px;\n",e.innerHTML=`\n <span style="font-size: 13px; font-weight: 600; color:var(--x-text-primary); padding: 6px 12px; background-color:var(--x-bg-secondary); border-radius: 12px; ">${n}</span>\n`,e}function Ul(n,e){return n&&"pending"!==n?"accepted"===n?e?"SENT":"RECEIVED":"rejected"===n?"REJECTED":"PENDING":"PENDING"}function Ol(n,e,t){return n&&"pending"!==n&&"accepted"===n?`${e?"-":"+"}$${t}`:`$${t}`}async function _l(n){try{const t=e(),o=`businessTransfers_${vt||"main"}`;let a=await t.xAccountProfiles.get(o);a||(a={handle:o,name:"businessTransfers",accountId:vt||"main",data:[],updatedAt:(new Date).toISOString()}),a.data.push({...n,savedAt:(new Date).toISOString()}),await t.xAccountProfiles.put(a),console.log("✅ 商业转账已保存:",n.transferId)}catch(n){console.error("❌ 保存商业转账失败:",n)}}async function Fl(t,o){try{console.log("💼 [商业转账] 开始处理任务:",t.taskDescription);const a=["发帖","发推","发推特","发推文","发tweet","发条推","发个帖","发条帖","发个推","发一条","发布推文","发布帖子","post","tweet","tweeted","posting","gonna post","will post","going to post","publish","share on x","share on twitter","发到X上","发到推特","发到平台","分享到X","晒到X","宣传","推广","广告"],i=t.taskDescription.toLowerCase();if(!a.some(n=>i.includes(n.toLowerCase())))return void console.log("⏭️ [商业转账] 任务不包含发推关键词，跳过");console.log("✅ [商业转账] 检测到发推任务");if(!(Math.random()<.8))return void console.log("❌ [商业转账] AI决定不完成任务（20%概率）");console.log("✅ [商业转账] AI决定完成任务，正在生成推文...");const r=e();let l=!1,c="";try{const e=await s.getUnifiedProfile(o.user.handle,{userProfileInfo:s.buildUserXProfileInfo(n.userProfileData)});if(e){let n=.1;if("character"===e.type){const t=e.characterData,o=(t.aiPersona||"").toLowerCase();if(["叛逆","狡猾","冷漠","自私","腹黑","毒舌","刻薄","傲慢","高傲","不羁","反叛","rebellious","cunning","selfish","cold","arrogant","sarcastic"].some(n=>o.includes(n))&&(n+=.15,c="角色性格叛逆/不友好",console.log("🎭 [反水检测] 角色性格因素 +15%")),e.knowsUserIdentity){if(t.userPersona){const e=t.userPersona.toLowerCase();["敌人","对手","仇人","讨厌","不喜欢","矛盾","竞争","enemy","rival","dislike","hate"].some(n=>e.includes(n))&&(n+=.2,c+=(c?"，":"")+"与用户关系不好",console.log("🎭 [反水检测] 负面关系 +20%"))}}else n+=.1,c+=(c?"，":"")+"不认识用户",console.log("🎭 [反水检测] 陌生关系 +10%")}else"stranger"!==e.type&&"account"!==e.type||(n+=.05,c="非绑定角色类型",console.log("🎭 [反水检测] 路人/账号类型 +5%"));console.log(`🎭 [反水检测] 最终反水概率: ${(100*n).toFixed(0)}%`),l=Math.random()<n,l&&console.log(`🔥 [商业转账] AI决定反水！原因: ${c}`)}}catch(n){console.error("🎭 [反水检测] 获取资料失败，使用默认概率:",n),l=Math.random()<.1}const d=[{type:"text",content:l?`用户花钱让我发推广，但我准备反水揭露这件事或者发负面内容。任务要求：${t.taskDescription}`:`我需要完成一个商业任务：${t.taskDescription}`,isOwn:!1,time:"最近",_isBetrayal:l,_betrayalReason:c}],p={id:o.id,user:o.user,_isBusinessBetrayal:l},g=await Tl(p,d);if(!g)return void console.log("⚠️ [商业转账] 推文生成失败");const m=Date.now(),x={id:`mention_business_${m}`,type:"newTweet",user:o.user,content:l?`⚠️ ${o.user.name} 反水了！`:`New Tweet from ${o.user.name}`,time:"刚刚",timestamp:m,tweet:g,fromBusinessTransfer:!0,businessTransferId:t.timestamp,isBetrayal:l,betrayalReason:c},u=`mentions_${vt||"main"}`;let h=await r.xAccountProfiles.get(u);h||(h={handle:u,id:u,data:[]}),h.data.unshift(x),await r.xAccountProfiles.put(h),await Dn(o.user.handle,g),console.log("✅ [商业转账] 推文已生成并发布"+(l?"（反水）":""));const f="en"===Hn;Rl({title:l?"⚠️ 商业推广反水":"X",message:l?f?`${o.user.name} betrayed and posted a negative tweet!`:`${o.user.name} 反水了！发布了负面/揭露内容`:f?`${o.user.name} completed the business task and posted a tweet!`:`${o.user.name} 完成了商业任务并发布了推文！`,avatar:o.user.avatar,leftIcon:l?"custom":"x",leftIconHtml:l?'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #ef4444;">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></g>\n </svg>\n ':void 0});const b=document.getElementById("x-notifications-page");b&&"flex"===b.style.display?await bl():vn("notifications")}catch(n){console.error("❌ [商业转账] 任务处理失败:",n)}}async function Xl(n,t){try{const o=e(),a=`businessTransfers_${vt||"main"}`;let i=await o.xAccountProfiles.get(a);if(i&&i.data){const e=i.data.find(e=>e.transferId===n);e&&(e.taskStatus=t,"in_progress"!==t||e.acceptedAt?"completed"===t&&(e.completedAt=(new Date).toISOString()):e.acceptedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log("✅ 商业转账状态已更新:",t))}}catch(n){console.error("❌ 更新商业转账状态失败:",n)}}function ql(n,e,t){return n.sort((n,e)=>new Date(e.createdAt)-new Date(n.createdAt)).map(n=>{const o=new Date;let a;if(n.taskDeadline)a=new Date(n.taskDeadline);else if(n.acceptedAt&&n.taskDeadlineHours){const e=new Date(n.acceptedAt),t=parseFloat(n.taskDeadlineHours)||24;a=new Date(e.getTime()+60*t*60*1e3)}else if(n.createdAt&&n.taskDeadlineHours){const e=new Date(n.createdAt),t=parseFloat(n.taskDeadlineHours)||24;a=new Date(e.getTime()+60*t*60*1e3)}else a=new Date(o.getTime()+864e5);const i=a.getTime()-o.getTime(),r=i<=0;let s="";if(i>0){const n=Math.floor(i/36e5),e=Math.floor(i%36e5/6e4);s=n>0?`${n}小时${e}分钟`:`${e}分钟`}else s="已过期";return`\n <div style="margin-bottom: 12px; background: linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.03)"} 0%, ${t?"rgba(0, 0, 0, 0.01)":"rgba(255, 255, 255, 0.01)"} 100%); border: 1px solid ${t?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; border-radius: 12px; transition: all 0.2s; position: relative; overflow: hidden; ">\n\n <div style="position: absolute; top: 50%; right: -20px; transform: translateY(-50%) rotate(15deg); font-size: 32px; color: ${t?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.02)"}; font-weight: 700; pointer-events: none; ">TICKET</div>\n <div style="padding: 16px;">\n <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">\n <div style="flex: 1;">\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 15px; font-weight: 600; margin-bottom: 4px; ">${"sent"===e?`发给 ${n.receiverName||n.senderName||"对方"}`:`来自 ${n.senderName||n.receiverName||"对方"}`}</div>\n <div style="color: ${t?"#536471":"#71767b"}; font-size: 11px; font-family: monospace; letter-spacing: 0.5px; ">${new Date(n.createdAt).toLocaleString("zh-CN")}</div>\n </div>\n <div style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.12)"} 0%, ${t?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"} 100%); color: ${t?"#0f1419":"#ffffff"}; font-size: 10px; font-weight: 600; border-radius: 10px; margin-left: 12px; border: 1px solid ${t?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"}; letter-spacing: 0.5px; ">${{pending:"待接收",in_progress:"进行中",completed:"已完成",failed:"已失败"}[n.taskStatus||"pending"]}</div>\n </div>\n\n <div style="color: ${t?"#0f1419":"#e5e5e5"}; font-size: 13px; line-height: 1.4; margin-bottom: 12px; padding: 10px; background: ${t?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.02)"}; border-left: 2px solid ${t?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.15)"}; border-radius: 4px; ">${n.taskDescription}</div>\n\n <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px dashed ${t?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; ">\n <div style="color: ${r?"#dc2626":t?"#536471":"#71767b"}; font-size: 11px; display: flex; align-items: center; gap: 4px; ">\n <svg viewBox="0 0 24 24" style="width: 11px; height: 11px; fill: currentColor;">\n <g><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path></g>\n </svg>\n ${s}\n </div>\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 13px; font-weight: 700; font-family: monospace; ">$${n.amount} <span style="opacity: 0.6; font-size: 11px;">(定金 $${n.depositAmount})</span></div>\n </div>\n\n <div style="margin-top: 12px; text-align: right;">\n <button onclick="deleteBusinessTransfer('${n.transferId}', event)" style="background: linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.12)"} 0%, ${t?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"} 100%); color: ${t?"#0f1419":"#ffffff"}; border: 1px dashed ${t?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.2)"}; border-radius: 8px; padding: 6px 12px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; position: relative; overflow: hidden; " onmouseover="this.style.background='linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.15)"} 0%, ${t?"rgba(0, 0, 0, 0.06)":"rgba(255, 255, 255, 0.08)"} 100%)'; this.style.transform='scale(1.02)'"\n onmouseout="this.style.background='linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.12)"} 0%, ${t?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"} 100%)'; this.style.transform='scale(1)'">\n <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: currentColor; opacity: 0.7;">\n <g><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></g>\n </svg>\n 删除任务\n </button>\n </div>\n </div>\n </div>\n `}).join("")}function Vl(n,e){return`\n <div style="text-align: center; padding: 32px 20px; color: ${e?"#6b7280":"#9ca3af"}; font-size: 14px; ">\n <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: currentColor; opacity: 0.3; margin: 0 auto 12px;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path></g>\n </svg>\n <div>暂无${"sent"===n?"发出的":"接收的"}商业转账</div>\n </div>\n`}n.toggleVoiceText=function(n,e){const t=document.getElementById(n);if(!t)return;"true"===t.getAttribute("data-showing-text")?(t.innerHTML=t.getAttribute("data-original-html"),t.setAttribute("data-showing-text","false")):(t.setAttribute("data-original-html",t.innerHTML),t.innerHTML=`<div style="padding: 4px;">${e}</div>`,t.setAttribute("data-showing-text","true"))},n.showPhoneNotification=Rl,n.openTransferDialog=function(){const n=document.getElementById("transfer-dialog");if(n){n.style.display="flex";const e=document.getElementById("transfer-amount-input"),t=document.getElementById("transfer-note-input"),o=document.getElementById("transfer-note-counter");e&&(e.value=""),t&&(t.value=""),o&&(o.textContent="0 / 100"),setTimeout(()=>{e&&e.focus()},100)}},n.closeTransferDialog=function(){const n=document.getElementById("transfer-dialog");n&&(n.style.display="none",setTimeout(()=>{switchTransferType("normal");const n=document.getElementById("transfer-amount-input"),e=document.getElementById("transfer-note-input"),t=document.getElementById("transfer-task-description"),o=document.getElementById("transfer-task-deadline"),a=document.getElementById("transfer-deposit-ratio");n&&(n.value=""),e&&(e.value=""),t&&(t.value=""),o&&(o.value="24"),a&&(a.value="20");const i=document.getElementById("transfer-note-counter"),r=document.getElementById("transfer-task-counter");i&&(i.textContent="0 / 100"),r&&(r.textContent="0 / 500")},200))},n.updateTransferNoteCounter=function(){const n=document.getElementById("transfer-note-input"),e=document.getElementById("transfer-note-counter");n&&e&&(e.textContent=`${n.value.length} / 100`)},n.updateTaskDescriptionCounter=function(){const n=document.getElementById("transfer-task-description"),e=document.getElementById("transfer-task-counter");n&&e&&(e.textContent=`${n.value.length} / 500`)},n.switchTransferType=function(n){const e=document.getElementById("transfer-type-normal-btn"),t=document.getElementById("transfer-type-business-btn"),o=document.getElementById("business-transfer-section");e&&t&&o&&("business"===n?(e.style.backgroundColor="transparent",e.style.color="var(--x-text-primary)",t.style.backgroundColor="var(--x-accent)",t.style.color="#fff",o.style.display="block"):(e.style.backgroundColor="var(--x-accent)",e.style.color="#fff",t.style.backgroundColor="transparent",t.style.color="var(--x-text-primary)",o.style.display="none"))},n.sendTransfer=async function(){const n=document.getElementById("transfer-amount-input"),e=document.getElementById("transfer-note-input");if(!n||!e)return;const t=parseFloat(n.value),o=e.value.trim();if(t<=0||t>9999999)return void mn("请输入有效金额（0.01 - 9,999,999）","error");const a=document.getElementById("business-transfer-section"),i=a&&"none"!==a.style.display;let r=null;if(i){const n=document.getElementById("transfer-task-description")?.value.trim(),e=document.getElementById("transfer-task-deadline")?.value,o=parseFloat(document.getElementById("transfer-deposit-ratio")?.value||20);if(!n)return void mn("请填写任务描述","error");if(!e||e<1)return void mn("请设置有效的任务期限","error");const a=t*o/100,i=t-a;r={isBusiness:!0,taskDescription:n,taskDeadline:new Date(Date.now()+60*e*60*1e3).toISOString(),taskDeadlineHours:parseInt(e),depositRatio:o,depositAmount:a.toFixed(2),remainingAmount:i.toFixed(2),taskStatus:"pending",taskProgress:0}}if(await Mt(),!It.isActivated)return void mn("请先激活钱包","error");const s=i?parseFloat(r.depositAmount):t;if(It.balance<s)mn("钱包余额不足","error");else try{It.balance-=s;const n=Al?.user?.name||"对方",e=i?`商业转账给 ${n}（定金 ${r.depositRatio}%）${o?` - ${o}`:""}`:`转账给 ${n}${o?` - ${o}`:""}`,a={id:"transfer_out_"+Date.now(),description:e,amount:-s,timestamp:(new Date).toISOString(),type:i?"business_transfer_deposit":"transfer_out"};It.transactions.unshift(a),await Tt(),console.log("💰 钱包余额已扣除:",s,"剩余余额:",It.balance);const l={type:"transfer",amount:t.toFixed(2),note:o||null,status:"pending",timestamp:(new Date).toISOString(),isOwn:!0,...r};Zl.push(l);const c=document.getElementById("message-detail-content");if(c){const n=Bl(l,!0,void 0,!0,!0);c.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}if(lc(l),i&&Al){const e=Al.user?.name||Al.userName||n,t=Al.user?.handle||Al.userHandle||"unknown",o=Al.user?.avatar||Al.userAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";await _l({...l,transferId:l.timestamp,conversationId:Al.id,receiverName:e,receiverHandle:t,receiverAvatar:o,direction:"sent",createdAt:l.timestamp}),console.log("💼 商业转账已记录到数据库（发出方）- 接收者:",e)}closeTransferDialog(),console.log("✅ 转账消息已发送:",l);mn(i?`商业转账已发送 (-$${s.toFixed(2)} 定金)`:`转账已发送 (-$${t.toFixed(2)})`,"success")}catch(n){console.error("转账处理失败:",n),mn("转账失败: "+n.message,"error")}},n.openTransferDetails=function(n,e){const t=document.getElementById("transfer-details-modal"),o=document.getElementById("transfer-details-content");if(!t||!o)return;const a=document.getElementById("x-social-screen"),i=a&&a.classList.contains("x-theme-light");if(n.isBusiness&&(!n.depositAmount||!n.remainingAmount)){const e=parseFloat(n.amount||0),t=parseFloat(n.depositRatio||0);if(n.depositAmount=(e*t/100).toFixed(2),n.remainingAmount=(e-parseFloat(n.depositAmount)).toFixed(2),!n.taskDeadline&&n.taskDeadlineHours){const e=new Date(n.timestamp||Date.now()).getTime()+60*parseFloat(n.taskDeadlineHours)*60*1e3;n.taskDeadline=new Date(e).toISOString()}}parseFloat(n.amount||0).toFixed(2),n.status,n.note,n.time||xc(n.timestamp);o.innerHTML=function(n,e,t){const o=parseFloat(n.amount||0).toFixed(2),a=n.status||"pending",i=n.note||"",r=n.time||xc(n.timestamp),s=!0===n.isBusiness,l=s?n:null,c="pending"===a,d=!e&&c;let p="",g=!1;if(s&&l.taskDeadline){const n=new Date(l.taskDeadline),e=new Date,t=n.getTime()-e.getTime();if(t>0){const n=Math.floor(t/36e5),e=Math.floor(t%36e5/6e4);p=n>0?`${n}小时${e}分钟`:`${e}分钟`}else p="已过期",g=!0}const m=s?parseFloat(l.depositAmount||0).toFixed(2):o;return`\n <div style="background-color: ${t?"#ffffff":"#1f1f1f"}; position: relative; overflow: hidden; max-height: 80vh; display: flex; flex-direction: column; ">\n\n <div style="flex: 1; overflow-y: auto; overflow-x: hidden; ">\n\n <div style="padding: 24px 20px 16px; background-color: ${t?"#ffffff":"#1f1f1f"}; position: relative; ">\n\n <div onclick="closeTransferDetails()" style="position: absolute; top: 16px; right: 16px; cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; z-index: 10; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n\n <div style="text-align: center; font-size: 18px; font-weight: 700; color: ${t?"#1a1a1a":"#e5e5e5"}; margin-bottom: 8px; ">${s?"商业转账详情":"转账详情"}</div>\n\n ${s?`\n <div style="text-align: center; margin-bottom: 12px; ">\n <span style="display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.15)"} 0%, ${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.08)"} 100%); color: ${t?"#1a1a1a":"#e5e5e5"}; font-size: 11px; font-weight: 600; border-radius: 12px; letter-spacing: 0.5px; border: 1px solid ${t?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"}; ">BUSINESS</span>\n </div>\n `:""}\n <div style="text-align: center; font-size: 12px; color: ${t?"#888888":"#aaaaaa"}; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; ">${Ul(a,e)}</div>\n\n <div style="text-align: center; font-size: 32px; font-weight: 700; color: ${t?"#1a1a1a":"#e5e5e5"}; margin-bottom: ${s?"8px":"16px"}; ">\n ${Ol(a,e,m)}\n </div>\n\n ${s?`\n <div style="text-align: center; font-size: 12px; color: ${t?"#888888":"#aaaaaa"}; margin-bottom: 16px; ">定金 ${l.depositRatio}%</div>\n `:""}\n\n ${i?`\n <div style="text-align: center; font-size: 14px; color: ${t?"#666666":"#999999"}; margin-bottom: 16px; padding: 8px 16px; background-color: ${t?"#f5f5f5":"#2d2d2d"}; border-radius: 8px; ">"${i}"</div>\n `:""}\n\n <div style="position: absolute; top: 50%; right: -40px; transform: translateY(-50%) rotate(15deg); font-size: 48px; color: ${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}; font-weight: 700; pointer-events: none; white-space: nowrap; ">${s?"BUSINESS":"TRANSFER"}</div>\n </div>\n\n <div style="height: 20px; background: linear-gradient(90deg,\n ${t?"#ffffff":"#1f1f1f"} 10px,\n transparent 10px,\n transparent 20px,\n ${t?"#ffffff":"#1f1f1f"} 20px\n ); background-size: 20px 100%; position: relative; ">\n <div style="position: absolute; left: -10px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.5); "></div>\n <div style="position: absolute; right: -10px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.5); "></div>\n </div>\n\n <div style="padding: 16px 20px 20px; background-color: ${t?"#ffffff":"#1f1f1f"}; ">\n\n ${s?`\n <div style="margin-bottom: 16px; padding: 12px; background-color: ${t?"#f8f9fa":"#2a2a2a"}; border: 1px solid ${t?"#e1e8ed":"#38444d"}; border-radius: 8px; ">\n <div style="font-size: 12px; font-weight: 600; color: ${t?"#666666":"#999999"}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;">\n <g><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></g>\n </svg>\n 任务要求\n </div>\n <div style="font-size: 14px; color: ${t?"#1a1a1a":"#e5e5e5"}; line-height: 1.5; margin-bottom: 12px; white-space: pre-wrap; word-wrap: break-word; ">${l.taskDescription}</div>\n <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid ${t?"#e1e8ed":"#38444d"}; ">\n <span style="font-size: 12px; color: ${t?"#666666":"#999999"}; display: flex; align-items: center; gap: 4px; ">\n <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: currentColor;">\n <g><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path></g>\n </svg>\n 任务期限\n </span>\n <span style="font-size: 13px; font-weight: 600; color: ${g?"#dc2626":t?"#1a1a1a":"#e5e5e5"}; ">${p}</span>\n </div>\n </div>\n\n <div style="margin-bottom: 16px; padding: 12px; background-color: ${t?"#f8f9fa":"#2a2a2a"}; border: 1px solid ${t?"#e1e8ed":"#38444d"}; border-radius: 8px; ">\n <div style="font-size: 12px; font-weight: 600; color: ${t?"#666666":"#999999"}; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: currentColor;">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"></path></g>\n </svg>\n 金额明细\n </div>\n <div style="display: flex; justify-content: space-between; margin-bottom: 6px; ">\n <span style="font-size: 13px; color: ${t?"#666666":"#999999"};">总金额</span>\n <span style="font-size: 13px; color: ${t?"#1a1a1a":"#e5e5e5"}; font-weight: 600;">$${o}</span>\n </div>\n <div style="display: flex; justify-content: space-between; margin-bottom: 6px; ">\n <span style="font-size: 13px; color: ${t?"#666666":"#999999"};">定金 (${l.depositRatio||0}%)</span>\n <span style="font-size: 13px; color: var(--x-accent); font-weight: 600;">$${parseFloat(l.depositAmount||0).toFixed(2)}</span>\n </div>\n <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid ${t?"#e1e8ed":"#38444d"}; ">\n <span style="font-size: 13px; color: ${t?"#666666":"#999999"};">尾款</span>\n <span style="font-size: 13px; color: ${t?"#1a1a1a":"#e5e5e5"}; font-weight: 600;">$${parseFloat(l.remainingAmount||0).toFixed(2)}</span>\n </div>\n </div>\n `:""}\n\n <div style="display: flex; justify-content: space-between; margin-bottom: 12px; ">\n <span style="color: ${t?"#666666":"#999999"}; font-size: 13px;">转账时间</span>\n <span style="color: ${t?"#1a1a1a":"#e5e5e5"}; font-size: 13px;">${r}</span>\n </div>\n <div style="display: flex; justify-content: space-between; margin-bottom: 12px; ">\n <span style="color: ${t?"#666666":"#999999"}; font-size: 13px;">${s?"任务状态":"转账状态"}</span>\n <span style="color: ${t?"#1a1a1a":"#e5e5e5"}; font-size: 13px;">\n ${"pending"===a?"待处理":"accepted"===a?"已完成":"已拒绝"}\n </span>\n </div>\n\n <div style="text-align: center; margin: 16px 0; padding: 8px 0; border-top: 1px solid ${t?"#eeeeee":"#333333"}; ">\n <div style="font-family: monospace; font-size: 24px; color: ${t?"#1a1a1a":"#e5e5e5"}; letter-spacing: 2px; margin-bottom: 4px; ">||||||||||||| ${Math.random().toString().slice(2,13)}</div>\n <div style="font-size: 11px; color: ${t?"#888888":"#aaaaaa"}; ">${s?"BUSINESS":"TRANSFER"} ID: ${n.timestamp?new Date(n.timestamp).getTime():Date.now()}</div>\n </div>\n </div>\n </div>\n\n ${d?`\n <div style="padding: 16px 20px; background-color: ${t?"#ffffff":"#1f1f1f"}; border-top: 1px solid ${t?"#eeeeee":"#333333"}; ">\n ${s?`\n <div style="font-size: 12px; color: ${t?"#888888":"#aaaaaa"}; text-align: center; margin-bottom: 12px; line-height: 1.4; ">接收此商业转账即表示同意完成任务要求</div>\n `:""}\n <div style="display: flex; gap: 12px; ">\n <button id="reject-transfer-btn" style="flex: 1; padding: 12px; border: 1px solid ${t?"#dc2626":"#ef4444"}; color: ${t?"#dc2626":"#ef4444"}; background: transparent; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='${t?"#fef2f2":"#1f1416"}'"\n onmouseout="this.style.backgroundColor='transparent'">\n 拒绝\n </button>\n <button id="accept-transfer-btn" style="flex: 1; padding: 12px; border: none; color: #ffffff; background: var(--x-accent); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.opacity='0.9'"\n onmouseout="this.style.opacity='1'">\n ${s?"接受任务":"接收"}\n </button>\n </div>\n </div>\n `:""}\n ${e&&s&&"accepted"===a&&"in_progress"===l.taskStatus?`\n <div style="padding: 16px 20px; background-color: ${t?"#ffffff":"#1f1f1f"}; border-top: 1px solid ${t?"#eeeeee":"#333333"}; ">\n <div style="font-size: 12px; color: ${t?"#888888":"#aaaaaa"}; text-align: center; margin-bottom: 12px; line-height: 1.4; ">验收任务完成情况，确认后将支付剩余尾款</div>\n <button id="complete-task-btn" style="width: 100%; padding: 12px; border: 1px solid ${t?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.2)"}; color: ${t?"#0f1419":"#ffffff"}; background: linear-gradient(135deg, ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.12)"} 0%, ${t?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"} 100%); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.15)"}'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></g>\n </svg>\n 确认完成任务并支付尾款 ($${l.remainingAmount})\n </button>\n </div>\n `:""}\n </div>\n`}(n,e,i);const r=document.getElementById("accept-transfer-btn"),s=document.getElementById("reject-transfer-btn"),l=document.getElementById("complete-task-btn");r&&(r.onclick=()=>acceptTransfer(n.timestamp)),s&&(s.onclick=()=>rejectTransfer(n.timestamp)),l&&(l.onclick=()=>completeBusinessTask(n.timestamp)),t.style.display="flex"},n.closeTransferDetails=function(){const n=document.getElementById("transfer-details-modal");n&&(n.style.display="none")},n.acceptTransfer=async function(t){try{const o=e(),a=`messageConversation_${vt||"main"}_${Al.id}`,i=await o.xAccountProfiles.get(a);if(i&&i.data&&i.data.messages){const e=i.data.messages.find(n=>"transfer"===n.type&&n.timestamp===t);if(e){const a=parseFloat(e.amount),r=!0===e.isBusiness;let s=a;if(r)if(void 0!==e.depositAmount)s=parseFloat(e.depositAmount);else{s=a*(parseFloat(e.depositRatio)||20)/100,e.depositAmount=s.toFixed(2),e.remainingAmount=(a-s).toFixed(2)}if(e.status="accepted",r){e.taskStatus="in_progress";const n=new Date;e.acceptedAt=n.toISOString();const t=parseFloat(e.taskDeadlineHours)||24,o=new Date(n.getTime()+60*t*60*1e3);e.taskDeadline=o.toISOString(),console.log("⏰ [接收商业转账] 设置任务截止时间:",{acceptedAt:e.acceptedAt,deadlineHours:t,taskDeadline:e.taskDeadline})}const l={type:"system",systemType:"transferAccepted",content:r?`你接收了商业转账（定金 $${s.toFixed(2)}），请在 ${e.taskDeadlineHours} 小时内完成任务`:`你接收了 $${a.toFixed(2)} 的转账`,timestamp:(new Date).toISOString(),time:"刚刚"};i.data.messages.push(l),await o.xAccountProfiles.put(i),await Mt();const c=parseFloat(It.balance)||0;It.balance=c+s;const d=Al?.user?.name||"对方",p={id:"transfer_in_"+Date.now(),description:r?`商业转账收款（定金）- ${d}${e.note?` - ${e.note}`:""}`:`收款自 ${d}${e.note?` - ${e.note}`:""}`,amount:s,timestamp:(new Date).toISOString(),type:r?"business_transfer_deposit_in":"transfer_in"};if(It.transactions.unshift(p),await Tt(),r&&Al){const n=Al.user?.name||Al.userName||"对方",o=Al.user?.handle||Al.userHandle||"unknown",a=Al.user?.avatar||Al.userAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",i={...e,transferId:t,conversationId:Al.id,senderName:n,senderHandle:o,senderAvatar:a,direction:"received",createdAt:e.timestamp,acceptedAt:(new Date).toISOString()};console.log("💼 [保存商业转账] 准备保存:",i),console.log("💼 [发送者信息] 名字:",n,"句柄:",o),console.log("💼 [保存商业转账] taskDeadline:",i.taskDeadline),console.log("💼 [保存商业转账] taskStatus:",i.taskStatus),await _l(i),console.log("💼 商业转账已记录到数据库")}if(Rl({title:"X Wallet",message:r?`已收定金 $${s.toFixed(2)}，请完成任务以获得尾款`:`已收款 $${a.toFixed(2)}, 当前余额 $${It.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"}),closeTransferDetails(),Al&&Al.user){const n={name:Al.user.name,handle:Al.user.handle,avatar:Al.user.avatar};await Wl(Al,n)}if(console.log("✅ 转账已接收:",s,"新余额:",It.balance),r&&setTimeout(()=>{Fl(e,Al)},1e3),!r&&!e.isOwn){const e=i.data.messages.filter(n=>"transfer"===n.type&&n.isBusiness&&"in_progress"===n.taskStatus&&!n.isOwn).pop();e&&(console.log("💼 [商业任务尾款] 检测到进行中的商业任务，将此转账视为尾款"),e.taskStatus="completed",e.completedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),await Xl(e.timestamp,"completed"),console.log("✅ [商业任务尾款] 商业任务已完成，状态已更新"),Rl({title:"X Wallet",message:`任务已完成，已收尾款 $${s.toFixed(2)}, 当前余额 $${It.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"}))}}}}catch(n){console.error("接收转账失败:",n),mn("接收转账失败","error")}},n.rejectTransfer=async function(n){try{const t=e(),o=`messageConversation_${vt||"main"}_${Al.id}`,a=await t.xAccountProfiles.get(o);if(a&&a.data&&a.data.messages){const e=a.data.messages.find(e=>"transfer"===e.type&&e.timestamp===n);if(e){const n=parseFloat(e.amount);e.status="rejected";const o={type:"system",systemType:"transferRejected",content:`你拒绝了 $${n.toFixed(2)} 的转账`,timestamp:(new Date).toISOString(),time:"刚刚"};if(a.data.messages.push(o),await t.xAccountProfiles.put(a),closeTransferDetails(),Al&&Al.user){const n={name:Al.user.name,handle:Al.user.handle,avatar:Al.user.avatar};await Wl(Al,n)}console.log("❌ 转账已拒绝:",n)}}}catch(n){console.error("拒绝转账失败:",n),mn("拒绝转账失败","error")}},n.completeBusinessTask=async function(t){try{if(!Al)return void mn("无法找到当前对话","error");const o=e(),a=`messageConversation_${vt||"main"}_${Al.id}`,i=await o.xAccountProfiles.get(a);if(i&&i.data&&i.data.messages){const e=i.data.messages.find(n=>"transfer"===n.type&&n.timestamp===t);if(e&&e.isBusiness){const a=parseFloat(e.remainingAmount);if(await Mt(),It.balance<a)return void mn("钱包余额不足，无法支付尾款","error");e.taskStatus="completed",e.completedAt=(new Date).toISOString(),It.balance-=a;const r=`businessTransfers_${vt||"main"}`;let s="对方";const l=await o.xAccountProfiles.get(r);if(l&&l.data){const n=l.data.find(n=>n.transferId===t);n&&n.senderName&&(s=n.senderName)}"对方"===s&&Al?.user?.name&&(s=Al.user.name);const c={id:"business_remaining_"+Date.now(),description:`商业转账尾款 - ${s}${e.note?` - ${e.note}`:""}`,amount:-a,timestamp:(new Date).toISOString(),type:"business_transfer_remaining"};It.transactions.unshift(c),await Tt();const d={type:"system",systemType:"businessTaskCompleted",content:`你已确认任务完成并支付尾款 $${a.toFixed(2)}`,timestamp:(new Date).toISOString(),time:"刚刚"};if(i.data.messages.push(d),await o.xAccountProfiles.put(i),await Xl(t,"completed"),Rl({title:"X Wallet",message:`任务已完成，已支付尾款 $${a.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"}),closeTransferDetails(),Al&&Al.user){const n={name:Al.user.name,handle:Al.user.handle,avatar:Al.user.avatar};await Wl(Al,n)}console.log("✅ 商业任务已完成，尾款已支付:",a)}}}catch(n){console.error("完成任务失败:",n),mn("完成任务失败","error")}},n.openBusinessTransferManager=async function(){const n=document.getElementById("x-social-screen"),t=n&&n.classList.contains("x-theme-light"),o=e(),a=`businessTransfers_${vt||"main"}`;let i=await o.xAccountProfiles.get(a);const r=i?.data||[],s=r.filter(n=>"sent"===n.direction),l=r.filter(n=>"received"===n.direction),c=document.createElement("div");c.id="business-transfer-manager-modal",c.style.cssText=`\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: ${t?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; display: flex; align-items: center; justify-content: center; z-index: 26; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n`,c.innerHTML=`\n <div style="background-color: ${t?"rgba(255, 255, 255, 0.95)":"rgba(0, 0, 0, 0.95)"}; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; width: 90%; max-width: 500px; max-height: 80vh; position: relative; overflow: hidden; box-shadow: ${t?"0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 0, 0, 0.1)":"0 20px 60px rgba(0, 0, 0, 0.8), 0 8px 32px rgba(255, 255, 255, 0.05)"}; border: 2px solid ${t?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; " onclick="event.stopPropagation()">\n\n <div style="background: linear-gradient(135deg, ${t?"rgba(248, 250, 252, 0.8)":"rgba(22, 24, 28, 0.8)"} 0%, ${t?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"} 100%); padding: 24px; text-align: center; border-bottom: 2px solid ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; position: relative; ">\n\n <button onclick="closeBusinessTransferManager()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: ${t?"#536471":"#71767b"}; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}';"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 20px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; ">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path></g>\n </svg>\n 商业转账管理\n </div>\n <div style="color: ${t?"#536471":"#71767b"}; font-size: 14px; ">管理所有商业合作订单</div>\n </div>\n\n <div style="max-height: 60vh; overflow-y: auto; padding: 16px 20px; ">\n\n <div style="margin-bottom: 24px;">\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 16px; font-weight: 700; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid ${t?"#e1e8ed":"#38444d"}; display: flex; align-items: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <g><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></g>\n </svg>\n 已发出 (${s.length})\n </div>\n ${s.length>0?ql(s,"sent",t):Vl("sent",t)}\n </div>\n\n <div>\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 16px; font-weight: 700; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid ${t?"#e1e8ed":"#38444d"}; display: flex; align-items: center; gap: 6px; ">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor;">\n <g><path d="M20 8l-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"></path></g>\n </svg>\n 已接收 (${l.length})\n </div>\n ${l.length>0?ql(l,"received",t):Vl("received",t)}\n </div>\n </div>\n </div>\n`,document.body.appendChild(c),document.body.style.overflow="hidden",c.addEventListener("click",n=>{n.target===c&&closeBusinessTransferManager()});const d=c.querySelector("div");d.style.transform="scale(0.8) translateY(20px)",d.style.opacity="0",requestAnimationFrame(()=>{d.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",d.style.transform="scale(1) translateY(0)",d.style.opacity="1"})},n.closeBusinessTransferManager=function(){const n=document.getElementById("business-transfer-manager-modal");if(n){const e=n.querySelector("div");e.style.transform="scale(0.9) translateY(20px)",e.style.opacity="0",setTimeout(()=>{n.remove(),document.body.style.overflow="auto"},200)}},n.deleteBusinessTransfer=async function(t,o){o.stopPropagation();try{const a=e(),i=`businessTransfers_${vt||"main"}`,r=await a.xAccountProfiles.get(i);if(!r||!r.data)return void mn("无法找到商业转账数据","error");const s=r.data.find(n=>n.transferId===t);if(!s)return void mn("无法找到该任务","error");const l=parseFloat(s.depositAmount)||0,c=parseFloat(s.amount)||0,d=l+c,p=`删除此任务将扣除违约费 $${d.toFixed(2)}\n（定金 $${l.toFixed(2)} + 全款 $${c.toFixed(2)}）\n并降低信用值\n\n是否确认删除？`;if(!confirm(p))return;const g=o.target.closest('div[style*="margin-bottom: 12px"]');if(g){if(g.style.animation="crumple-tear 0.6s cubic-bezier(0.4, 0, 1, 1) forwards",g.style.transformOrigin="center center",!document.getElementById("business-transfer-animations")){const n=document.createElement("style");n.id="business-transfer-animations",n.textContent="\n @keyframes crumple-tear {\n 0% {\n transform: scale(1) rotate(0deg); opacity: 1; }\n 20% {\n transform: scale(0.95) rotate(-2deg); }\n 40% {\n transform: scale(0.9) rotate(2deg) translateY(-5px); filter: blur(0px); }\n 60% {\n transform: scale(0.7) rotate(-5deg) translateY(-10px); filter: blur(1px); opacity: 0.8; }\n 80% {\n transform: scale(0.4) rotate(8deg) translateY(-15px); filter: blur(3px); opacity: 0.4; }\n 100% {\n transform: scale(0.1) rotate(15deg) translateY(-20px); filter: blur(5px); opacity: 0; }\n }\n ",document.head.appendChild(n)}await new Promise(n=>setTimeout(n,600))}await Mt(),It.balance-=d;const m=Math.min(20,Math.floor(c/10));It.creditScore=Math.max(0,It.creditScore-m);const x={id:"penalty_"+Date.now(),description:`删除商业任务违约费 - ${s.taskDescription.substring(0,30)}...`,amount:-d,timestamp:(new Date).toISOString(),type:"penalty"};It.transactions.unshift(x),await Tt(),r.data=r.data.filter(n=>n.transferId!==t),await a.xAccountProfiles.put(r),Rl({title:"X Wallet",message:`任务已删除，扣除违约费 $${d.toFixed(2)}，信用值 -${m}`,avatar:n.userProfileData?.avatar,leftIcon:"custom",leftIconHtml:'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #71767b;">\n <g><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></g>\n </svg>\n ',duration:5e3}),console.log(`🗑️ 商业任务已删除，扣除违约费 $${d.toFixed(2)}，信用值 -${m}`),closeBusinessTransferManager(),setTimeout(()=>{openBusinessTransferManager()},300)}catch(n){console.error("删除商业转账失败:",n),mn("删除失败","error")}};let Gl=null;async function Yl(){try{const t=e(),o=`businessTransfers_${vt||"main"}`,a=await t.xAccountProfiles.get(o);if(!a||!a.data||0===a.data.length)return;const i=a.data,r=new Date;let s=!1;const l=[];for(const e of i){let t;if(e.taskDeadline)t=new Date(e.taskDeadline);else if(e.acceptedAt&&e.taskDeadlineHours){const n=new Date(e.acceptedAt),o=parseFloat(e.taskDeadlineHours)||24;t=new Date(n.getTime()+60*o*60*1e3)}else{if(!e.createdAt||!e.taskDeadlineHours){console.warn("⚠️ 商业转账缺少截止时间信息，跳过:",e.transferId),l.push(e);continue}{const n=new Date(e.createdAt),o=parseFloat(e.taskDeadlineHours)||24;t=new Date(n.getTime()+60*o*60*1e3)}}const o=e.completedAt?new Date(e.completedAt):null,a=t.getTime()-r.getTime();if("in_progress"===e.taskStatus&&a>0&&a<=36e5&&!e.reminderSent){const t=Math.floor(a/36e5),o=Math.floor(a%36e5/6e4),i=t>0?`${t}小时${o}分钟`:`${o}分钟`;Rl({title:"商业转账提醒",message:`任务"${e.taskDescription.substring(0,20)}..."还剩${i}截止，请及时完成！`,avatar:n.userProfileData?.avatar,leftIcon:"custom",leftIconHtml:'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #f59e0b;">\n <g><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path></g>\n </svg>\n ',duration:5e3}),e.reminderSent=!0,s=!0,console.log(`⏰ 已发送任务即将到期提醒: ${e.taskDescription.substring(0,30)}`)}let i=!1,c=!1;if(a<0&&Math.abs(a)>36e5&&(i=!0,"in_progress"===e.taskStatus&&(c=!0),console.log(`🗑️ 删除过期任务: ${e.taskDescription.substring(0,30)}`)),"completed"===e.taskStatus&&o){r.getTime()-o.getTime()>108e5&&(i=!0,console.log(`🗑️ 删除已完成任务: ${e.taskDescription.substring(0,30)}`))}if(i){if(c){const t=parseFloat(e.amount)||0,o=t;await Mt(),It.balance-=o;const a=Math.min(15,Math.floor(t/15));It.creditScore=Math.max(0,It.creditScore-a);const i={id:"penalty_expired_"+Date.now(),description:`任务过期违约费 - ${e.taskDescription.substring(0,30)}...`,amount:-o,timestamp:(new Date).toISOString(),type:"penalty"};It.transactions.unshift(i),await Tt(),Rl({title:"X Wallet",message:`任务已过期，扣除违约费 $${o.toFixed(2)}，信用值 -${a}`,avatar:n.userProfileData?.avatar,leftIcon:"custom",leftIconHtml:'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: #71767b;">\n <g><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path></g>\n </svg>\n ',duration:5e3}),console.log(`💸 任务过期违约费 $${o.toFixed(2)}，信用值 -${a}`)}s=!0}else l.push(e)}if(s){await t.xAccountProfiles.put({handle:o,name:"businessTransfers",accountId:vt||"main",data:l,updatedAt:(new Date).toISOString()}),console.log(`✅ 商业转账数据已更新，保留 ${l.length}/${i.length} 条记录`);document.getElementById("business-transfer-manager-modal")&&(closeBusinessTransferManager(),setTimeout(()=>{openBusinessTransferManager()},300))}}catch(n){console.error("检查商业转账状态失败:",n)}}async function Wl(n,t){const o=document.getElementById("message-detail-content");if(!o)return;o.innerHTML="";const a=document.getElementById("message-detail-top-avatar"),i=document.getElementById("message-detail-top-name");if(a&&(a._fangroupClickHandler&&(a.removeEventListener("click",a._fangroupClickHandler),delete a._fangroupClickHandler),a._fangroupTouchHandler&&(a.removeEventListener("touchend",a._fangroupTouchHandler),delete a._fangroupTouchHandler)),a&&(a.src=t.avatar),i&&(i.textContent=t.name),a){n.id.startsWith("msg_")&&"msg_001"!==n.id&&!n.id.startsWith("msg_account_")?(a.onclick=null,a.style.cursor="default"):(a.onclick=()=>{hc(n,t)},a.style.cursor="pointer")}const r=document.getElementById("message-detail-avatar"),s=document.getElementById("message-detail-name"),l=document.getElementById("message-detail-handle");r&&(r.src=t.avatar,r.style.cursor="pointer",r.onclick=()=>{openAccountProfile(t.name,t.handle,t.avatar)}),s&&(s.textContent=t.name),l&&(l.textContent=t.handle);const c=document.getElementById("message-detail-bio");t.bio&&c?(c.textContent=t.bio,c.style.display="block"):c&&(c.style.display="none");const d=t.followersCount||"0",p=Rn[Hn]||Rn.zh,g=document.getElementById("message-detail-followers");g&&(g.textContent=`${d} ${p.messageFollowers}`);try{const t=e(),a=`messageConversation_${vt||"main"}_${n.id}`,i=await t.xAccountProfiles.get(a);if(i&&i.data&&i.data.messages&&i.data.messages.length>0){console.log("✅ 加载已有对话记录"),i._liveUserData&&!n._liveUserData&&(n._liveUserData=i._liveUserData,Al._liveUserData=i._liveUserData,console.log("💎 [加载对话] 从数据库恢复直播间用户数据",i._liveUserData));const e=new Date,t="en"===Hn?e.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):`${e.getFullYear()}年${e.getMonth()+1}月${String(e.getDate()).padStart(2,"0")}日`;o.appendChild(jl(t));const a=Nl(i.data.messages),r=[];a.forEach(n=>{const e=!0===n[0].message.isOwn;n.forEach((t,a)=>{const i=a===n.length-1,s=Bl(t.message,e,t.index,i);o.appendChild(s),r.push(s)})}),r.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"});try{const n=i.data.messages.filter(n=>n.isOwn&&!0===n.waitingForAIResponse);n.length>0?(Zl=n,console.log(`✅ 恢复了 ${Zl.length} 条等待AI回复的消息到队列`)):console.log("📝 所有消息都已得到AI回复")}catch(n){console.error("恢复消息队列失败:",n)}return void setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}}catch(n){console.warn("检查对话记录失败:",n)}o.innerHTML=`\n <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 32px;">\n <div style="text-align: center; max-width: 300px;">\n\n <img src="${t.avatar}"\n style="width: 64px; height: 64px; border-radius: 50%; margin-bottom: 16px; object-fit: cover; ">\n\n <div style="font-size: 28px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px; ">开始对话</div>\n <div style="font-size: 14px; color:var(--x-text-secondary); line-height: 1.4; ">向 ${t.name} 发送消息开始聊天</div>\n </div>\n </div>\n`,console.log("✅ 角色私信详情页已加载（首次对话）")}function Jl(n,e){const t=document.getElementById("message-detail-content");if(!t)return;t.innerHTML="",!n._accountType&&n.id&&(n.id.startsWith("msg_account_")?n._accountType="account":n.id.startsWith("msg_npc_")?n._accountType="npc":n.id.startsWith("msg_relationship_")?n._accountType="relationshipNpc":n.id.startsWith("msg_")||(n._accountType="stranger"),console.log("🔍 [类型检测] 设置消息类型为:",n._accountType));const o=document.getElementById("message-detail-top-avatar"),a=document.getElementById("message-detail-top-name");o&&(o._fangroupClickHandler&&(o.removeEventListener("click",o._fangroupClickHandler),delete o._fangroupClickHandler),o._fangroupTouchHandler&&(o.removeEventListener("touchend",o._fangroupTouchHandler),delete o._fangroupTouchHandler)),o&&(o.src=n.user.avatar),a&&(a.textContent=n.user.name);const i=n.id&&n.id.startsWith("msg_")&&"msg_001"!==n.id&&!n.id.startsWith("msg_account_");o&&!i?(o.style.cursor="pointer",o.onclick=t=>{t.stopPropagation(),console.log("📱 [小头像点击] 打开联系人设置，类型:",n._accountType),hc(n,e)}):o&&(o.style.cursor="default",o.onclick=null);const r=document.getElementById("message-detail-avatar"),s=document.getElementById("message-detail-name"),l=document.getElementById("message-detail-handle");r&&(r.src=n.user.avatar,r.style.cursor="pointer",r.onclick=()=>{openAccountProfileFromDM(n,e)}),s&&(s.textContent=n.user.name),l&&(l.textContent=n.user.handle);const c=document.getElementById("message-detail-bio");e?.senderProfile?.bio&&c?(c.textContent=e.senderProfile.bio,c.style.display="block"):c&&(c.style.display="none");const d=e?.senderProfile?.followers||Math.floor(1e3*Math.random())+100,p=Rn[Hn]||Rn.zh;document.getElementById("message-detail-followers").textContent=`${d} ${p.messageFollowers}`;const g=new Date,m="en"===Hn?g.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):`${g.getFullYear()}年${g.getMonth()+1}月${String(g.getDate()).padStart(2,"0")}日`;if(t.appendChild(jl(m)),e&&e.messages&&e.messages.length>0){const n=Nl(e.messages),o=[];n.forEach(n=>{const e=!0===n[0].message.isOwn;n.forEach((a,i)=>{const r=i===n.length-1,s=Bl(a.message,e,a.index,r);t.appendChild(s),o.push(s)})}),o.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"})}else{const e=Bl({type:"text",content:n.preview,time:"刚刚"},!1,0,!0);t.appendChild(e),e.style.opacity="1",e.style.transform="translateY(0)"}setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}n.openMessageDetail=async function(n){!n._accountType&&n.id&&(n.id.startsWith("msg_account_")?n._accountType="account":n.id.startsWith("msg_npc_")?n._accountType="npc":n.id.startsWith("msg_relationship_")?n._accountType="relationshipNpc":n.id.startsWith("msg_")&&"msg_001"!==n.id||(n._accountType="stranger"),console.log("🔍 [打开私信] 检测到类型:",n._accountType,"| ID:",n.id)),"fangroup"!==n.type&&delete n.type,Al=n,Zl=[];const t=document.getElementById("x-messages-page"),o=document.getElementById("x-notifications-page"),a=o&&"flex"===o.style.display;t.style.display="none";const i=document.getElementById("compose-message-btn");i&&(i.style.display="none"),a&&(o.style.display="none");const r=document.getElementById("refresh-messages-btn");r&&(r.style.display="none");const s=document.getElementById("x-message-detail-page");s.style.display="flex",s.dataset.conversationId=n.id,s.dataset.fromNotifications=a?"true":"false",setTimeout(()=>{const n=document.getElementById("message-input"),e=document.getElementById("message-send-btn");n&&(n.disabled=!1,n.placeholder="发送私信"),e&&(e.disabled=!1)},50);const l=e();try{const e=`messagesList_${vt||"main"}`,t=await l.xAccountProfiles.get(e);if(t&&t.data){const o=t.data,a=o.findIndex(e=>e.id===n.id);-1!==a&&o[a].unread&&(o[a].unread=!1,o[a].unreadCount=0,await l.xAccountProfiles.put({handle:e,name:"messagesList",data:o,updatedAt:(new Date).toISOString()}),dc=o,console.log("✅ 已清除未读标记"))}}catch(n){console.error("清除未读标记失败:",n)}if("fangroup"===n.type||n.id&&n.id.startsWith("fangroup_"))return console.log("👥 检测到粉丝群，加载粉丝群详情页"),void async function(n){const t=document.getElementById("message-detail-content");if(!t)return;t.innerHTML="";const o=document.getElementById("message-detail-top-avatar"),a=document.getElementById("message-detail-top-name");o&&(o.src=n.userAvatar||n.groupAvatar,o.style.cursor="pointer",o._fangroupClickHandler&&(o.removeEventListener("click",o._fangroupClickHandler),o.removeEventListener("touchend",o._fangroupTouchHandler)),o._fangroupClickHandler=e=>{e.preventDefault(),e.stopPropagation(),console.log("🖱️ [头像点击] 粉丝群头像被点击"),vc(n)},o._fangroupTouchHandler=e=>{e.preventDefault(),e.stopPropagation(),console.log("📱 [头像点击] 移动端触摸事件"),vc(n)},o.addEventListener("click",o._fangroupClickHandler),o.addEventListener("touchend",o._fangroupTouchHandler)),a&&(a.textContent=n.userName||n.groupName);const i=document.getElementById("message-detail-scrollable");if(i){const n=i.querySelector('[style*="padding: 24px"]');n&&(n.style.display="none")}try{const o=e(),a=`messageConversation_${vt||"main"}_${n.id}`,i=await o.xAccountProfiles.get(a);if(i&&i.data&&i.data.messages&&i.data.messages.length>0){console.log("✅ 加载已有粉丝群对话记录");const n=new Date,e="en"===Hn?n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):`${n.getFullYear()}年${n.getMonth()+1}月${String(n.getDate()).padStart(2,"0")}日`;t.appendChild(jl(e));const o=Nl(i.data.messages),a=[];o.forEach(n=>{const e=!0===n[0].message.isOwn;n.forEach((o,i)=>{const r=i===n.length-1,s=Bl(o.message,e,o.index,r);t.appendChild(s),a.push(s)})}),a.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"});try{const n=i.data.messages.filter(n=>n.isOwn&&!0===n.waitingForAIResponse);n.length>0&&(Zl=n,console.log(`✅ 恢复了 ${Zl.length} 条等待AI回复的消息到队列`))}catch(n){console.error("恢复消息队列失败:",n)}return void setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}}catch(n){console.warn("检查粉丝群对话记录失败:",n)}t.innerHTML=`\n <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 32px;">\n <div style="text-align: center; max-width: 300px;">\n\n <img src="${n.userAvatar||n.groupAvatar}"\n style="width: 64px; height: 64px; border-radius: 50%; margin-bottom: 16px; object-fit: cover; ">\n\n <div style="font-size: 28px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px; ">粉丝群聊天</div>\n <div style="font-size: 14px; color:var(--x-text-secondary); line-height: 1.4; ">向粉丝群发送消息开始互动</div>\n </div>\n </div>\n`,console.log("✅ 粉丝群私信详情页已加载（首次对话）")}(n);if(n.id&&n.id.startsWith("msg_")&&"msg_001"!==n.id){console.log("📨 检测到已绑定角色私信，从账户主页数据读取资料");const e=n.id.replace("msg_","");try{const t=await l.xCharacterProfiles.get(e);if(t){const e=t.xHandle.replace("@",""),o=await l.xAccountProfiles.get(e);if(o&&o.accountInfo){console.log("✅ 找到角色的账户主页数据");const e={...o.accountInfo,avatar:t.xAvatar,name:t.xName,handle:t.xHandle};return void Wl(n,e)}}if(console.log("⚠️ 未找到角色的账户主页数据，使用基本资料"),t){const e={name:t.xName,handle:t.xHandle,avatar:t.xAvatar,bio:t.xBio||"",followersCount:t.followersCount||"0",verified:t.xVerified||!1};return void Wl(n,e)}}catch(n){console.error("读取角色资料失败:",n)}}!n.user&&n.userName&&(n.user={name:n.userName,handle:n.userHandle,avatar:n.userAvatar,verified:n.verified||!1});const c=`messageConversation_${vt||"main"}_${n.id}`;let d=null;try{const e=await l.xAccountProfiles.get(c);if(e&&e.data){if(d=e.data,console.log("✅ 从数据库加载私信对话数据"),e.isBlocked)return console.log("⚠️ [拉黑] 该用户已被拉黑"),Jl(n,d),void setTimeout(()=>{const n=document.getElementById("message-input"),e=document.getElementById("message-send-btn");n&&(n.disabled=!0,n.placeholder="对方已将你拉黑"),e&&(e.disabled=!0)},100);Jl(n,d)}}catch(n){console.error("加载私信对话数据失败:",n)}if(!d){const e=document.getElementById("message-detail-content");e&&(e.innerHTML='\n <div style="flex: 1; display: flex; align-items: center; justify-content: center;">\n <div style="text-align: center;">\n <div style="margin-bottom: 12px;">\n <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: var(--x-accent); animation: spin 1s linear infinite;">\n <g><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></g>\n </svg>\n </div>\n <div style="color:var(--x-text-primary); font-size: 16px; font-weight: 600;">正在生成对话详情...</div>\n </div>\n </div>\n '),d=await vl(n),Jl(n,d||null)}},n.closeMessageDetail=async function(){const n=document.getElementById("message-input");n&&(n.value="",autoResizeMessageInput(n));const e=document.getElementById("x-message-detail-page"),t="true"===e.dataset.fromNotifications;e.style.display="none";if(Al&&!0===Al._fromAccountProfile){console.log("📖 [返回] 从私信详情页返回账户主页");const n=document.getElementById("account-profile-page");n&&(n.style.display="flex")}else if(t){console.log("📖 [返回] 从私信详情页返回通知页面"),document.getElementById("x-notifications-page").style.display="flex";const n=document.getElementById("refresh-messages-btn"),e=document.querySelector(".notification-tab.active")?.textContent.includes("全部")||document.querySelector(".notification-tab.active")?.textContent.includes("All");n&&e&&(n.style.display="flex"),await bl()}else{console.log("📖 [返回] 从私信详情页返回私信列表"),document.getElementById("x-messages-page").style.display="flex";const n=document.getElementById("compose-message-btn");n&&(n.style.display="flex"),gc(dc)}Al=null,Zl=[]},n.autoResizeMessageInput=function(n){n.style.height="36px";const e=n.scrollHeight;e>36&&(n.style.height=Math.min(e,100)+"px")},n.handleMessageInputKeydown=function(n){"Enter"!==n.key||n.shiftKey||(n.preventDefault(),sendMessageContent())},n.toggleMessageFunctionMenu=function(){const n=document.getElementById("message-function-menu"),e=document.getElementById("message-add-btn");if(!n||!e)return;if("flex"===n.style.display){n.style.display="none";const t=e.querySelector("svg");t&&(t.style.transform="rotate(0deg)")}else{n.style.display="flex";const t=e.querySelector("svg");t&&(t.style.transform="rotate(45deg)")}},document.addEventListener("click",function(n){const e=document.getElementById("message-function-menu"),t=document.getElementById("message-add-btn");if(e&&t&&!e.contains(n.target)&&!t.contains(n.target)){e.style.display="none";const n=t.querySelector("svg");n&&(n.style.transform="rotate(0deg)")}}),n.openImageTypeSelector=function(){const n=document.getElementById("image-type-selector-dialog");n&&(n.style.display="flex")},n.closeImageTypeSelector=function(){const n=document.getElementById("image-type-selector-dialog");n&&(n.style.display="none")},n.selectImageType=function(n){closeImageTypeSelector(),"real"===n?triggerMessageImageUpload():"text"===n&&function(){const n=document.getElementById("text-image-dialog"),e=document.getElementById("text-image-description-input"),t=document.getElementById("text-image-counter");n&&(n.style.display="flex");e&&(e.value="");t&&(t.textContent="0 / 500");setTimeout(()=>{e&&e.focus()},100)}()},n.closeTextImageDialog=function(){const n=document.getElementById("text-image-dialog");n&&(n.style.display="none")},n.updateTextImageCounter=function(){const n=document.getElementById("text-image-description-input"),e=document.getElementById("text-image-counter");n&&e&&(e.textContent=`${n.value.length} / 500`)},n.sendTextImage=async function(){const n=document.getElementById("text-image-description-input");if(!n)return;const e=n.value.trim();if(!e)return void mn("请输入图片描述","error");closeTextImageDialog();const t=new Date,o={type:"image",imageDescription:e,sensitive:!1,time:`${t.getHours()}:${String(t.getMinutes()).padStart(2,"0")}`,timestamp:t.toISOString(),isOwn:!0};Zl.push(o);const a=document.getElementById("message-detail-content");if(a){const n=Bl(o,!0,a.querySelectorAll(".message-item").length);a.appendChild(n),setTimeout(()=>{n.style.transition="all 0.3s ease",n.style.opacity="1",n.style.transform="translateY(0)"},10),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&n.scrollTo({top:n.scrollHeight,behavior:"smooth"})},100)}await lc(o),console.log("✅ 文字图片消息已添加到队列，等待发送")},n.triggerMessageImageUpload=function(){const n=document.getElementById("message-image-input");n&&n.click()};let Kl=[];async function Ql(n,e){const t=new Date,o=t.getHours(),a={type:"image",imageData:n,fileName:e,time:`${o>12?o-12:o}:${String(t.getMinutes()).padStart(2,"0")} ${o>=12?"下午":"上午"}`,timestamp:t.toISOString(),isOwn:!0};Zl.push(a);const i=document.getElementById("message-detail-content");if(i){const n=Bl(a,!0,i.querySelectorAll(".message-item:not(#typing-indicator)").length,!0);i.appendChild(n),setTimeout(()=>{n.style.transition="all 0.3s ease",n.style.opacity="1",n.style.transform="translateY(0)"},10),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&n.scrollTo({top:n.scrollHeight,behavior:"smooth"})},100)}await lc(a),console.log("✅ 图片消息已添加到队列，等待发送")}n.handleMessageImageUpload=async function(n){const e=n.target.files;if(e&&0!==e.length)if(Kl.length+e.length>4)mn("最多只能上传4张图片","error");else{for(let n=0;n<e.length;n++){const t=e[n];if(!t.type.startsWith("image/")){mn("请选择图片文件","error");continue}if(t.size>5242880){mn("图片文件不能超过5MB","error");continue}const o=new FileReader;o.onload=function(n){const e=n.target.result;Kl.push({content:e,fileName:t.name}),Ql(e,t.name),console.log(`✅ 图片 ${t.name} 已添加并发送`)},o.readAsDataURL(t)}n.target.value=""}};let Zl=[],nc=[],ec="frequent";async function tc(){try{const n=e(),t=`userStickers_${vt||"main"}`,o=await n.xUserTweets.get(t);o&&o.stickers?(nc=o.stickers,nc=nc.map(n=>({...n,useCount:n.useCount||0,lastUsedAt:n.lastUsedAt||null}))):nc=[]}catch(n){console.error("加载表情包失败:",n),nc=[]}}async function oc(){try{const n=e(),t=`userStickers_${vt||"main"}`;await n.xUserTweets.put({id:t,stickers:nc,updatedAt:(new Date).toISOString()}),console.log("✅ 表情包已保存")}catch(n){console.error("保存表情包失败:",n)}}function ac(){const n=document.getElementById("sticker-tab-frequent"),e=document.getElementById("sticker-tab-all");"frequent"===ec?(n.style.borderBottomColor="var(--x-accent)",n.style.color="var(--x-text-primary)",e.style.borderBottomColor="transparent",e.style.color="var(--x-text-secondary)"):(n.style.borderBottomColor="transparent",n.style.color="var(--x-text-secondary)",e.style.borderBottomColor="var(--x-accent)",e.style.color="var(--x-text-primary)")}function ic(){const e=document.getElementById("sticker-list");if(!e)return;const t=n.innerWidth;let o="80px";t<400?o="70px":t<500&&(o="75px"),e.style.gridTemplateColumns=`repeat(auto-fill, minmax(${o}, 1fr))`,e.innerHTML="";let a=[];if("frequent"===ec){const n=nc.filter(n=>n.useCount>0).sort((n,e)=>e.useCount!==n.useCount?e.useCount-n.useCount:n.lastUsedAt&&e.lastUsedAt?new Date(e.lastUsedAt)-new Date(n.lastUsedAt):0).slice(0,20);if(a=n,0===n.length)return e.style.display="flex",void(e.innerHTML='\n <div style="width: 100%; text-align: center; padding: 60px 20px; color:var(--x-text-secondary); ">\n <div style="font-size: 48px; margin-bottom: 12px;">😊</div>\n <div style="font-size: 14px; margin-bottom: 8px; font-weight: 600;">暂无常用表情包</div>\n <div style="font-size: 13px;">使用过的表情包会出现在这里</div>\n </div>\n ');e.style.display="grid"}else{if(a=[...nc].reverse(),0===nc.length)return e.style.display="flex",void(e.innerHTML='\n <div style="width: 100%; text-align: center; padding: 60px 20px; color:var(--x-text-secondary); ">\n <div style="font-size: 48px; margin-bottom: 12px;">📦</div>\n <div style="font-size: 14px; margin-bottom: 8px; font-weight: 600;">暂无表情包</div>\n <div style="font-size: 13px;">点击下方"导入表情包"添加</div>\n </div>\n ');e.style.display="grid"}const i=a.length;let r=0;if(i>10){const n=document.createElement("div");n.id="sticker-loading-indicator",n.style.cssText="\n        grid-column: 1 / -1;\n        text-align: center;\n        padding: 20px;\n        color: var(--x-text-secondary);\n        font-size: 13px;\n      ",n.textContent=`正在加载表情包... (0/${i})`,e.appendChild(n)}requestAnimationFrame(function t(){const o=Math.min(r+10,i),s=a.slice(r,o),l=document.createDocumentFragment();if(s.forEach((e,t)=>{const o=nc.findIndex(n=>n.url===e.url&&n.description===e.description),a=document.createElement("div");a.style.cssText="\n          position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; \n          transition: transform 0.2s; width: 100%; padding-bottom: 100%; \n          background-color:var(--x-bg-secondary);\n        ",a.onmouseover=()=>{a.style.transform="scale(1.05)"},a.onmouseout=()=>{a.style.transform="scale(1)"},a.onclick=()=>{n.getCommentStickerMode&&n.getCommentStickerMode()?n.selectCommentSticker&&n.selectCommentSticker(e):(!async function(n){const e=await sc();if(e.isBlocked)return void mn("对方已将你拉黑，无法发送消息","error");if(e.error)return void mn(e.error,"error");const t=nc.findIndex(e=>e.url===n.url&&e.description===n.description);-1!==t&&(nc[t].useCount=(nc[t].useCount||0)+1,nc[t].lastUsedAt=(new Date).toISOString(),await oc());const o=new Date,a=o.getHours(),i=String(o.getMinutes()).padStart(2,"0"),r=`${a>12?a-12:a}:${i} ${a>=12?"下午":"上午"}`,s={type:"sticker",stickerDescription:n.description,stickerUrl:n.url,time:r,timestamp:o.toISOString(),isOwn:!0};Zl.push(s);const l=document.getElementById("message-detail-content");if(l){const n=Bl(s,!0,l.querySelectorAll(".message-item:not(#typing-indicator)").length,!0);l.appendChild(n),setTimeout(()=>{n.style.transition="all 0.3s ease",n.style.opacity="1",n.style.transform="translateY(0)"},10),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&n.scrollTo({top:n.scrollHeight,behavior:"smooth"})},100)}await lc(s),console.log("✅ 表情包消息已添加到队列，等待发送")}(e),closeStickerPicker())},a.innerHTML=`\n          <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">\n            <img src="${e.url}" alt="${e.description}"\n              style="width: 100%; height: 100%; object-fit: cover; display: block;"\n              onerror="this.parentElement.innerHTML='<div style=\\'display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background-color:var(--x-bg-secondary); color:var(--x-text-secondary); font-size: 11px; padding: 4px; text-align: center;\\'>❌<br>加载失败<br><button onclick=\\'deleteSticker(${o})\\' style=\\'margin-top: 4px; padding: 2px 6px; font-size: 10px; background: var(--x-accent); color: white; border: none; border-radius: 4px; cursor: pointer;\\'>删除</button></div>';">\n          </div>\n          <button onclick="deleteSticker(${o}); event.stopPropagation();"\n            ontouchstart="this.style.opacity='1'"\n            style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; width: 24px; height: 24px; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; opacity: 0; transition: opacity 0.2s; z-index: 2; " \n            onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">\n            <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #fff;">\n              <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n            </svg>\n          </button>\n        `,l.appendChild(a)}),e.appendChild(l),r=o,i>10){const n=document.getElementById("sticker-loading-indicator");n&&(r<i?n.textContent=`正在加载表情包... (${r}/${i})`:n.remove())}r<i?requestAnimationFrame(t):console.log(`✅ [表情包渲染] 完成，共${i}个，分${Math.ceil(i/10)}批渲染`)})}function rc(){const n=document.getElementById("sticker-manager-list");n&&(n.innerHTML="",0!==nc.length?nc.forEach((e,t)=>{const o=document.createElement("div");o.style.cssText="\n padding: 12px; margin-bottom: 8px; background-color:var(--x-bg-secondary); border-radius: 8px; display: flex; gap: 12px; align-items: flex-start; ",o.innerHTML=`\n <img src="${e.url}"\n style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0;"\n onerror="this.src=''; this.style.background='var(--x-bg-hover)'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center';">\n <div style="flex: 1; min-width: 0;">\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">\n ${e.description}\n </div>\n <div style="font-size: 12px; color:var(--x-text-secondary); word-break: break-all; margin-bottom: 4px;">\n ${e.url}\n </div>\n <div style="font-size: 11px; color:var(--x-text-secondary);">\n 使用次数: ${e.useCount||0}\n ${e.lastUsedAt?`· 最后使用: ${new Date(e.lastUsedAt).toLocaleString("zh-CN")}`:""}\n </div>\n </div>\n <button onclick="editSticker(${t}); event.stopPropagation();" style="background-color: var(--x-bg-hover); color:var(--x-text-primary); border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; flex-shrink: 0; ">编辑</button>\n <button onclick="deleteSticker(${t}); event.stopPropagation();" style="background-color: rgba(239, 68, 68, 0.1); color: rgb(239, 68, 68); border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; flex-shrink: 0; ">删除</button>\n `,n.appendChild(o)}):n.innerHTML='\n <div style="text-align: center; padding: 40px 20px; color:var(--x-text-secondary);">\n <div style="font-size: 14px;">暂无表情包</div>\n </div>\n ')}async function sc(){if(!Al)return{isBlocked:!1,error:"会话数据丢失"};try{const n=e(),t=`messageConversation_${vt||"main"}_${Al.id}`,o=await n.xAccountProfiles.get(t);if(o&&o.isBlocked){console.log("⚠️ [拉黑] 对方已拉黑用户，禁止发送消息");const n=document.getElementById("message-input"),e=document.getElementById("message-send-btn");return n&&(n.disabled=!0,n.placeholder="对方已将你拉黑"),e&&(e.disabled=!0),{isBlocked:!0}}return{isBlocked:!1}}catch(n){return console.error("检查拉黑状态失败:",n),{isBlocked:!1,error:n.message}}}async function lc(t){if(Al)try{const o=e(),a=`messageConversation_${vt||"main"}_${Al.id}`;let i=await o.xAccountProfiles.get(a);if(i&&i.data){i.data.messages||(i.data.messages=[]),t.waitingForAIResponse=!0,i.data.messages.push(t),i.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(i),console.log("✅ 用户消息已保存到数据库（更新）");const e=Al.id;if(e&&e.startsWith("msg_")&&!e.startsWith("msg_account_")){const t=e.replace("msg_","");"function"==typeof n.resetAutoMessageTrigger&&n.resetAutoMessageTrigger(t)}try{const n=`messagesList_${vt||"main"}`,t=await o.xAccountProfiles.get(n);if(t&&t.data){const a=t.data,i=a.findIndex(n=>n.id===e);-1!==i&&a[i].unread&&(a[i].unread=!1,a[i].unreadCount=0,await o.xAccountProfiles.put({handle:n,name:"messagesList",data:a,updatedAt:(new Date).toISOString()}),dc=a,console.log("✅ 已清除未读标记（用户回复）"))}}catch(n){console.error("清除未读标记失败:",n)}}else{console.log("📨 创建新的对话记录");const e={handle:a,name:"messageConversation",data:{messages:[t]},messageId:Al.id,updatedAt:(new Date).toISOString()};await o.xAccountProfiles.put(e),console.log("✅ 用户消息已保存到数据库（新建）");const i=Al.id;if(i&&i.startsWith("msg_")&&!i.startsWith("msg_account_")){const e=i.replace("msg_","");"function"==typeof n.resetAutoMessageTrigger&&n.resetAutoMessageTrigger(e)}}}catch(n){console.error("保存用户消息失败:",n)}}async function cc(n,t=null){const o=t||Al;if(o&&n&&0!==n.length)try{const t=e(),a=`messageConversation_${vt||"main"}_${o.id}`,i=await t.xAccountProfiles.get(a);i&&i.data&&(i.data.messages||(i.data.messages=[]),i.data.messages.forEach(n=>{n.isOwn&&n.waitingForAIResponse&&(n.waitingForAIResponse=!1)}),n.forEach(n=>{n.timestamp||(n.timestamp=(new Date).toISOString())}),i.data.messages.push(...n),o._liveUserData&&!i._liveUserData&&(i._liveUserData=o._liveUserData,console.log("💎 [保存对话] 保存直播间用户数据到数据库")),i.updatedAt=(new Date).toISOString(),await t.xAccountProfiles.put(i),console.log("✅ AI回复已保存到数据库"))}catch(n){console.error("保存AI回复失败:",n)}}n.openStickerPicker=async function(){await tc(),ec="frequent",ac(),ic();const n=document.getElementById("sticker-picker-modal");n&&(n.style.display="flex")},n.switchStickerTab=function(n){ec=n,ac(),ic()},n.closeStickerPicker=function(){const e=document.getElementById("sticker-picker-modal");e&&(e.style.display="none"),n.setCommentStickerMode&&n.setCommentStickerMode(!1)},n.deleteSticker=async function(n){if(confirm("确定要删除这个表情包吗？")){nc.splice(n,1),await oc();const e=document.getElementById("sticker-manager-dialog");e&&"flex"===e.style.display&&rc();const t=document.getElementById("sticker-picker-modal");t&&"flex"===t.style.display&&ic(),mn("已删除","success")}},n.openAddStickerDialog=function(){const n=document.getElementById("add-sticker-dialog");if(n){n.style.display="flex";const e=document.getElementById("sticker-batch-input");e&&(e.value="")}},n.closeAddStickerDialog=function(){const n=document.getElementById("add-sticker-dialog");n&&(n.style.display="none")},n.openVoiceMessageDialog=function(){const n=document.getElementById("voice-message-dialog");if(n){n.style.display="flex";const e=document.getElementById("voice-message-text-input");e&&(e.value="",e.focus())}},n.closeVoiceMessageDialog=function(){const n=document.getElementById("voice-message-dialog");n&&(n.style.display="none")},n.sendVoiceMessage=function(){const n=document.getElementById("voice-message-text-input");if(!n)return;const e=n.value.trim();if(!e)return void mn("请输入语音内容","error");const t=Math.max(5,Math.ceil(e.length/10)),o=Math.floor(t/60),a=t%60,i=o>0?`${o}:${String(a).padStart(2,"0")}`:`0:${String(a).padStart(2,"0")}`,r=new Date,s=r.getHours(),l={type:"voice",voiceText:e,duration:i,time:`${s>12?s-12:s}:${String(r.getMinutes()).padStart(2,"0")} ${s>=12?"下午":"上午"}`,timestamp:r.toISOString(),isOwn:!0};Zl.push(l);const c=document.getElementById("message-detail-content");if(c){const n=Bl(l,!0,void 0,!0,!0);c.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}lc(l),closeVoiceMessageDialog(),console.log("✅ [语音消息] 已添加到队列:",l)},n.openStickerManager=async function(){await tc(),rc();const n=document.getElementById("sticker-manager-dialog");n&&(n.style.display="flex")},n.closeStickerManager=function(){const n=document.getElementById("sticker-manager-dialog");n&&(n.style.display="none")},n.editSticker=function(n){const e=nc[n];if(!e)return;const t=prompt("修改描述:",e.description);if(null===t)return;const o=prompt("修改链接:",e.url);if(null!==o)try{const e=new URL(o.trim());nc[n].description=t.trim(),nc[n].url=e.href,oc().then(()=>{rc(),mn("修改成功","success")})}catch(n){mn("链接格式无效","error")}},n.clearAllStickers=async function(){confirm(`确定要清空所有 ${nc.length} 个表情包吗？此操作不可恢复！`)&&(nc=[],await oc(),rc(),ic(),mn("已清空所有表情包","success"))},n.batchAddStickers=async function(){const n=document.getElementById("sticker-batch-input"),e=n?n.value.trim():"";if(!e)return void mn("请输入表情包信息","error");const t=e.split("\n").filter(n=>n.trim()),o=[],a=[];for(let n=0;n<t.length;n++){const e=t[n].trim(),i=e.match(/(https?:\/\/[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/);if(!i){a.push(`第${n+1}行：未找到有效链接`);continue}let r=i[0].trim();const s=e.substring(0,i.index).trim();if(!s){a.push(`第${n+1}行：缺少描述`);continue}try{const e=new URL(r);if(!e.protocol||!e.host){a.push(`第${n+1}行：链接格式无效`);continue}r=e.href}catch(e){a.push(`第${n+1}行：链接格式无效 - ${e.message}`);continue}[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"].some(n=>r.toLowerCase().includes(n))||console.warn(`第${n+1}行：链接可能不是图片格式，但仍会导入`);nc.some(n=>n.url===r)?a.push(`第${n+1}行：该表情包已存在`):o.push({description:s,url:r,useCount:0,lastUsedAt:null,createdAt:(new Date).toISOString()})}if(0===o.length)return void(a.length>0?mn(a.join("\n"),"error"):mn("没有可导入的表情包","error"));nc.push(...o),await oc(),ic(),closeAddStickerDialog();let i=`成功导入${o.length}个表情包`;a.length>0&&(i+=`，${a.length}个失败`),mn(i,"success")},n.sendMessageContent=async function(){const n=document.getElementById("message-input");if(!n)return;const e=n.value.trim();if(!e)return;const t=await sc();if(t.isBlocked)return void mn("对方已将你拉黑，无法发送消息","error");if(t.error)return void mn(t.error,"error");const o=new Date,a=o.getHours(),i={type:"text",content:e,time:`${a>12?a-12:a}:${String(o.getMinutes()).padStart(2,"0")} ${a>=12?"下午":"上午"}`,timestamp:o.toISOString(),isOwn:!0};Zl.push(i);const r=document.getElementById("message-detail-content");if(r){const n=r.querySelectorAll(".message-item:not(#typing-indicator)").length,e=Array.from(r.querySelectorAll(".message-item:not(#typing-indicator)")),t=e[e.length-1],o=(t?.querySelector("[data-message-index]")?.closest(".message-item")?.style.alignItems,Bl(i,!0,n,!0));r.appendChild(o),setTimeout(()=>{o.style.transition="all 0.3s ease",o.style.opacity="1",o.style.transform="translateY(0)"},10),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&n.scrollTo({top:n.scrollHeight,behavior:"smooth"})},100)}n.value="",autoResizeMessageInput(n),await lc(i),console.log("✅ 用户消息已发送并保存:",e)},n.regenerateAIResponse=async function(){if(Al)try{const n=e(),t=`messageConversation_${vt||"main"}_${Al.id}`,o=await n.xAccountProfiles.get(t);if(!o||!o.data||!o.data.messages)return void mn("没有对话记录","error");const a=o.data.messages;let i=-1;for(let n=a.length-1;n>=0;n--)if(!0===a[n].isOwn){i=n;break}if(-1===i)return void mn("没有找到用户消息","error");const r=[];for(let n=i;n<a.length&&!0===a[n].isOwn;n++)r.push(a[n]);const s=a.slice(0,i+r.length);o.data.messages=s,await n.xAccountProfiles.put(o);const l=document.getElementById("message-detail-content");if(l){l.innerHTML="";const n=new Date,e="en"===Hn?n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):`${n.getFullYear()}年${n.getMonth()+1}月${String(n.getDate()).padStart(2,"0")}日`;l.appendChild(jl(e));const t=Nl(s),o=[];t.forEach(n=>{const e=!0===n[0].message.isOwn;n.forEach((t,a)=>{const i=a===n.length-1,r=Bl(t.message,e,t.index,i);l.appendChild(r),o.push(r)})}),o.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}Zl=r,setTimeout(()=>{getAIResponse()},500)}catch(n){console.error("重新生成失败:",n),mn("重新生成失败","error")}else mn("会话数据丢失","error")},n.getAIResponse=async function(){if(!Al)return void mn("会话数据丢失","error");if(0===Zl.length){console.log("📖 [AI回复] userMessageQueue为空，尝试从数据库读取未回复消息");try{const n=e(),t=`messageConversation_${vt||"main"}_${Al.id}`,o=await n.xAccountProfiles.get(t);if(!(o&&o.data&&o.data.messages))return void mn("请先发送消息","info");{const n=o.data.messages;let e=-1;for(let t=n.length-1;t>=0;t--)if(!1===n[t].isOwn&&"system"!==n[t].type){e=t;break}const t=[];for(let o=e+1;o<n.length;o++)!0===n[o].isOwn&&t.push(n[o]);if(!(t.length>0))return void mn("请先发送消息","info");Zl=[...t],console.log(`✅ [AI回复] 从数据库读取到 ${Zl.length} 条未回复消息`),console.log("📋 [AI回复] 消息类型:",Zl.map(n=>n.type).join(", "))}}catch(n){return console.error("❌ [AI回复] 读取未回复消息失败:",n),void mn("请先发送消息","info")}}const t=Al,o=document.getElementById("message-send-btn");o&&(o.disabled=!0,o.style.opacity="0.5");try{console.log("📤 [AI回复] 准备显示正在输入气泡"),Ll();let o;if("fangroup"===t.type||t.id&&t.id.startsWith("fangroup_"))console.log("📤 [AI回复] 检测到粉丝群，调用第11个情景生成器"),o=await kc(t,!0,{userMessages:Zl});else{console.log("📤 [AI回复] 开始请求AI生成回复（普通私信）");const n={userMessages:Zl};t._liveUserData&&(n.liveUserData=t._liveUserData,console.log("💎 [AI回复] 检测到直播间用户数据，传递给生成器",n.liveUserData)),o=await vl(t,!0,n)}console.log("📥 [AI回复] AI回复已返回"),Pl();const a=o&&o.some(n=>"system"===n.type&&"blocked"===n.systemType),i=o&&o.some(n=>"system"===n.type&&"unblocked"===n.systemType),r=o&&o.some(n=>"system"===n.type&&"away"===n.systemType);if(i){console.log("🎉 [拉黑解除] 对方已解除拉黑");try{const n=e(),o=`messageConversation_${vt||"main"}_${t.id}`,a=await n.xAccountProfiles.get(o);a&&(a.isBlocked=!1,delete a.blockedAt,await n.xAccountProfiles.put(a),console.log("✅ [拉黑解除] 拉黑状态已解除"))}catch(n){console.error("❌ [拉黑解除] 解除拉黑状态失败:",n)}const n=document.getElementById("message-input"),a=document.getElementById("message-send-btn");n&&(n.disabled=!1,n.placeholder="发送私信"),a&&(a.disabled=!1);const i=o.find(n=>"system"===n.type&&"unblocked"===n.systemType);if(i){const n=document.getElementById("message-detail-content");if(n){const e=Bl(i,!1,n.querySelectorAll(".message-item:not(#typing-indicator)").length,!0);n.appendChild(e),requestAnimationFrame(()=>{e.style.opacity="1",e.style.transform="translateY(0)"})}}const r=o.filter(n=>"system"!==n.type||"unblocked"!==n.systemType);if(r.length>0){const n=document.getElementById("message-detail-content");if(n){let e=n.querySelectorAll(".message-item:not(#typing-indicator)").length;r.forEach((t,o)=>{const a=Bl(t,!1,e+o,o===r.length-1);n.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"})})}await cc(o,t)}else await cc(o,t);const s="en"===Hn;Rl({title:t.userName||t.user?.name||"未知用户",message:s?"Has unblocked you":"已解除拉黑",avatar:t.userAvatar||t.user?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"x",duration:3e3}),Zl=[];const l=document.getElementById("message-detail-scrollable");return void(l&&setTimeout(()=>{l.scrollTop=l.scrollHeight},100))}if(a){console.log("⚠️ [拉黑] 对方已将用户拉黑");try{const n=e(),o=`messageConversation_${vt||"main"}_${t.id}`,a=await n.xAccountProfiles.get(o);a&&(a.isBlocked=!0,a.blockedAt=(new Date).toISOString(),await n.xAccountProfiles.put(a),console.log("✅ [拉黑] 拉黑状态已保存"))}catch(n){console.error("❌ [拉黑] 保存拉黑状态失败:",n)}const n=document.getElementById("message-input"),a=document.getElementById("message-send-btn");if(n&&(n.disabled=!0,n.placeholder="对方已将你拉黑"),a&&(a.disabled=!0),o&&o.length>0){const n=document.getElementById("message-detail-content");if(n){const e=n.querySelectorAll(".message-item:not(#typing-indicator)").length,t=Bl(o[0],!1,e,!0);n.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1",t.style.transform="translateY(0)"})}await cc(o,t)}return Rl({title:"X",message:"en"===Hn?"You have been blocked by this user":"对方已将你拉黑",leftIcon:"x",duration:3e3}),Zl=[],void(a&&(a.disabled=!1,a.style.opacity="1"))}if(r){console.log("⏰ [离开] 对方暂时离开");const n=o.find(n=>"system"===n.type&&"away"===n.systemType),a=n.awayDuration||60;try{const n=e(),o=`messageConversation_${vt||"main"}_${t.id}`,i=await n.xAccountProfiles.get(o);i&&(i.isAway=!0,i.awayUntil=new Date(Date.now()+60*a*1e3).toISOString(),i.awayDuration=a,await n.xAccountProfiles.put(i),console.log(`✅ [离开] 离开状态已保存，将在${a}分钟后恢复`))}catch(n){console.error("❌ [离开] 保存离开状态失败:",n)}if(o&&o.length>0){const n=document.getElementById("message-detail-content");if(n){const e=n.querySelectorAll(".message-item:not(#typing-indicator)").length,t=Bl(o[0],!1,e,!0);n.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1",t.style.transform="translateY(0)"})}await cc(o,t)}setTimeout(()=>{console.log("⏰ [离开] 离开时间结束，准备触发自动消息"),"function"==typeof triggerAutoMessageAfterAway&&triggerAutoMessageAfterAway(t.id)},60*a*1e3);Rl({title:"X",message:n.content,leftIcon:"x",duration:3e3}),Zl=[];const i=document.getElementById("message-send-btn");return void(i&&(i.disabled=!1,i.style.opacity="1"))}if(o&&o.length>0){const a=document.getElementById("message-detail-content");if(a){let n=a.querySelectorAll(".message-item:not(#typing-indicator)").length;const e=[],t=o.length;o.forEach((o,i)=>{const r=Bl(o,!1,n,i===t-1);a.appendChild(r),e.push(r),n++}),await Dl(e,400)}if(await cc(o,t),await async function(t){try{console.log("🔍 [粉丝群加入] ========== 开始检测 =========="),console.log("🔍 [粉丝群加入] 当前对话:",t.id,t.name||t.userName);const o=e(),a=`messageConversation_${vt||"main"}_${t.id}`;console.log("🔍 [粉丝群加入] 读取对话ID:",a);const i=await o.xAccountProfiles.get(a);if(!i||!i.data||!i.data.messages)return void console.log("⚠️ [粉丝群加入] 未找到对话记录");const r=i.data.messages;console.log(`🔍 [粉丝群加入] 对话总消息数: ${r.length}`);const l=[],c=Math.max(0,r.length-20);console.log(`🔍 [粉丝群加入] 检查消息范围: ${c} - ${r.length-1}`);for(let n=c;n<r.length;n++){const e=r[n];console.log(`🔍 [粉丝群加入] 消息${n}: type=${e.type}, isOwn=${e.isOwn}`),"quoteFanGroup"===e.type&&(console.log(`✅ [粉丝群加入] 找到quoteFanGroup消息! isOwn=${e.isOwn}`,e.fanGroup),!0===e.isOwn&&l.push(e))}if(0===l.length)return void console.log("⏭️ [粉丝群加入] 未检测到用户发送的粉丝群转发消息");console.log(`✅ [粉丝群加入] 检测到 ${l.length} 个粉丝群转发`);for(const o of l){const a=o.fanGroup,i=.4+.3*Math.random();if(!(Math.random()<i)){console.log(`🎯 [粉丝群加入] ${t.userName||t.user?.name} 决定不加入粉丝群 ${a.name}`);continue}console.log(`✅ [粉丝群加入] ${t.userName||t.user?.name} 决定加入粉丝群 ${a.name}`);const r=t.userHandle||t.user?.handle;if(!r){console.warn("⚠️ [粉丝群加入] 无法获取联系人句柄");continue}const l=await s.getUnifiedProfile(r,{userProfileInfo:n.userProfileData,messageId:t.id});if(!l){console.warn("⚠️ [粉丝群加入] 无法获取联系人资料");continue}const c={id:t.id,name:l.name,handle:l.handle,avatar:l.avatar,type:l.type,joinedAt:(new Date).toISOString()},d=e(),p=`messagesList_${vt||"main"}`,g=await d.xAccountProfiles.get(p);let m=g?.data||[];const x=m.findIndex(n=>n.id===a.id);if(-1!==x){const n=m[x];if(n.members||(n.members=[]),n.members.some(n=>n.id===c.id)){console.log(`⚠️ [粉丝群加入] ${c.name} 已经是粉丝群成员`);continue}n.members.push(c),n.memberCount=n.members.length,await d.xAccountProfiles.put({handle:p,name:"messagesList",data:m,updatedAt:(new Date).toISOString()}),console.log(`✅ [粉丝群加入] ${c.name} 已加入粉丝群 ${a.name}，当前成员数: ${n.memberCount}`);const e=`messageConversation_${vt||"main"}_${a.id}`,t=await d.xAccountProfiles.get(e);if(t&&t.data){t.data.messages||(t.data.messages=[]);const n={type:"system",systemType:"memberJoined",content:`${c.name} 加入了粉丝群`,timestamp:(new Date).toISOString(),time:"刚刚"};t.data.messages.push(n),await d.xAccountProfiles.put(t),console.log("✅ [粉丝群加入] 已在粉丝群对话中添加系统通知")}setTimeout(()=>{const n="en"===Hn;Rl({title:a.name,message:n?`${c.name} joined the fan group`:`${c.name} 加入了粉丝群`,avatar:a.avatar,leftIcon:"x",duration:3e3})},3e3),"block"===document.getElementById("x-messages-page")?.style.display&&await pc(),await $c(a.id,n.memberCount)}}}catch(n){console.error("❌ [粉丝群加入] 处理粉丝群加入失败:",n)}}(t),await async function(t,o){try{const a=t.find(n=>"transfer"===n.type&&n.status&&"pending"!==n.status);if(!a)return;const i=e(),r=`messageConversation_${vt||"main"}_${o.id}`,s=await i.xAccountProfiles.get(r);if(!s||!s.data||!s.data.messages)return;const l=s.data.messages.find(n=>"transfer"===n.type&&n.isOwn&&"pending"===n.status);if(!l)return;const c=parseFloat(l.amount),d=!0===l.isBusiness;if("accepted"===a.status){l.status="accepted",d&&(l.taskStatus="in_progress",l.acceptedAt=(new Date).toISOString());const e={type:"system",systemType:"transferAccepted",content:d?`对方接收了商业转账（定金 $${parseFloat(l.depositAmount).toFixed(2)}），已开始执行任务`:`对方接收了你的 $${c.toFixed(2)} 转账`,timestamp:(new Date).toISOString(),time:"刚刚"};s.data.messages.push(e),await Mt();const t=o?.user?.name||"对方",a=d?"business_transfer_deposit":"transfer_out",r=d?parseFloat(l.depositAmount):c,p=It.transactions.find(n=>n.type===a&&Math.abs(n.amount+r)<.01);p&&(p.description=d?`商业转账给 ${t}（定金已接收）${l.note?` - ${l.note}`:""}`:`转账给 ${t}（已接收）${l.note?` - ${l.note}`:""}`),await Tt(),await i.xAccountProfiles.put(s),d&&o&&(await Xl(l.timestamp,"in_progress"),console.log("💼 AI接收的商业转账状态已更新为进行中"),setTimeout(()=>{Fl(l,o)},1e3)),setTimeout(()=>{Rl({title:"X Wallet",message:d?`对方已接受任务，定金 $${r.toFixed(2)} 已支付`:`已付款 $${c.toFixed(2)}, 当前余额 $${It.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"})},3e3),console.log("✅ AI 接收了转账:",d?`商业转账，定金 ${r}`:c)}else if("rejected"===a.status){l.status="rejected",d&&(l.taskStatus="rejected");const e={type:"system",systemType:"transferRejected",content:d?`对方拒绝了商业转账，定金 $${parseFloat(l.depositAmount).toFixed(2)} 已退回`:`对方拒绝了你的 $${c.toFixed(2)} 转账`,timestamp:(new Date).toISOString(),time:"刚刚"};s.data.messages.push(e),await Mt();const t=d?parseFloat(l.depositAmount):c;It.balance+=t;const a=o?.user?.name||"对方",r=d?"business_transfer_deposit":"transfer_out",p=It.transactions.find(n=>n.type===r&&Math.abs(n.amount+t)<.01);p&&(p.description=d?`商业转账给 ${a}（已拒绝，定金已退回）${l.note?` - ${l.note}`:""}`:`转账给 ${a}（已拒绝，已退回）${l.note?` - ${l.note}`:""}`,p.amount=0);const g={id:"refund_"+Date.now(),description:d?`${a} 拒绝商业转账，定金已退回${l.note?` - ${l.note}`:""}`:`${a} 拒绝转账，已退回${l.note?` - ${l.note}`:""}`,amount:t,timestamp:(new Date).toISOString(),type:"refund"};It.transactions.unshift(g),await Tt(),await i.xAccountProfiles.put(s),setTimeout(()=>{Rl({title:"X Wallet",message:d?`商业转账被拒绝，定金 $${t.toFixed(2)} 已退回，当前余额 $${It.balance.toFixed(2)}`:`转账被拒绝，已退回 $${t.toFixed(2)}, 当前余额 $${It.balance.toFixed(2)}`,avatar:n.userProfileData?.avatar,leftIcon:"x"})},4e3),console.log("❌ AI 拒绝了转账，已退回:",d?`商业转账定金 ${t}`:c)}if(Al&&Al.id===o.id){const n={name:o.user.name,handle:o.user.handle,avatar:o.user.avatar};await Wl(Al,n)}}catch(n){console.error("处理 AI 转账响应失败:",n)}}(o,t),Zl=[],"none"!==document.getElementById("x-message-detail-page")?.style.display){const n=t.user?.name||t.userName||t.groupName;Hl(n,t.user?.avatar||t.userAvatar||t.groupAvatar,o.length)}else{console.log("✅ AI回复已保存（用户已离开详情页）");try{const n=e(),a=`messagesList_${vt||"main"}`,i=await n.xAccountProfiles.get(a);if(i&&i.data){const e=i.data,r=e.findIndex(n=>n.id===t.id);if(-1!==r){e[r].unread=!0,e[r].unreadCount=(e[r].unreadCount||0)+o.length,await n.xAccountProfiles.put({handle:a,name:"messagesList",data:e,updatedAt:(new Date).toISOString()}),dc=e;const i=t.user?.name||t.userName||t.groupName;Hl(i,t.user?.avatar||t.userAvatar||t.groupAvatar,o.length),vn("messages"),console.log("✅ 已标记为未读并显示提醒")}}}catch(n){console.error("标记未读失败:",n)}}(async()=>{try{const n=e(),o=`messageConversation_${vt||"main"}_${t.id}`,a=await n.xAccountProfiles.get(o);a&&a.data&&a.data.messages&&await Ml(t,a.data.messages)}catch(n){console.error("New Tweet 检测失败:",n)}})()}else{console.log("📭 [不回复] AI决定不回复用户消息");Rl({title:"X",message:"en"===Hn?"Message delivered":"消息已送达",leftIcon:"x",duration:2e3}),Zl=[]}}catch(n){console.error("获取AI回复失败:",n),Pl(),"none"!==document.getElementById("x-message-detail-page")?.style.display&&mn(`获取回复失败: ${n.message}`,"error")}finally{o&&(o.disabled=!1,o.style.opacity="1")}},n.openAccountProfileFromDM=async function(n,e){try{console.log("🔍 从私信详情页打开账户主页:",n.user.name);const t={name:n.user.name,handle:n.user.handle,avatar:n.user.avatar,verified:n.user.verified||!1};e&&e.senderProfile&&(e.senderProfile.bio&&(t.bio=e.senderProfile.bio),e.senderProfile.followers&&(t.followersCount=e.senderProfile.followers.toString()),void 0!==e.senderProfile.verified&&(t.verified=e.senderProfile.verified)),console.log("📋 现有资料:",t),await openAccountProfile(t.name,t.handle,t.avatar,{source:"dm",existingInfo:t,messagePreview:n.preview})}catch(n){console.error("从私信详情页打开账户主页失败:",n),mn(`打开主页失败: ${n.message}`,"error")}},n.openAccountProfileFromQuoteProfile=async function(n){try{console.log("🔍 从账户名片打开主页:",n.name);const e={name:n.name,handle:n.handle,avatar:n.avatar,verified:n.verified||!1};n.bio&&(e.bio=n.bio),n.followers&&(e.followersCount=n.followers.toString()),console.log("📋 现有资料:",e);let t=null;Al&&(console.log("📝 [名片点击] 检测到当前对话:",Al.userName),t={currentConversationHandle:Al.userHandle||Al.handle,currentConversationName:Al.userName||Al.name,messageId:Al.id}),await openAccountProfile(e.name,e.handle,e.avatar,{source:"dm_quote_profile",existingInfo:e,conversationContext:t})}catch(n){console.error("从账户名片打开主页失败:",n),mn(`打开主页失败: ${n.message}`,"error")}};let dc=[];async function pc(){console.log("📨 加载私信列表");try{const n=e(),t=`messagesList_${vt||"main"}`,o=await n.xAccountProfiles.get(t);o&&o.data?(dc=o.data,console.log("✅ 从数据库加载私信列表，共",dc.length,"条")):(console.log("📨 数据库中没有私信列表数据，使用空列表"),dc=[]),gc(dc)}catch(n){console.error("加载私信列表失败:",n),mn("加载私信失败","error")}}async function gc(n){const t=document.getElementById("messages-list-container");if(!t)return void console.error("私信列表容器不存在");t.innerHTML="";let o=[];try{const n=e(),t=`xSettings_${vt||"main"}`,a=await n.xSettings.get(t);o=a?.boundCharacters||[],console.log("📋 [渲染私信列表] 当前绑定角色数:",o.length)}catch(n){console.warn("⚠️ [渲染私信列表] 获取绑定角色列表失败:",n)}const a=[];for(const e of n||[]){if(e.id&&e.id.startsWith("msg_")&&"msg_001"!==e.id&&!e.id.startsWith("msg_account_")&&!e.id.startsWith("msg_npc_")&&!e.id.startsWith("msg_relationship_")){const n=e.id.replace("msg_","");o.includes(n)?a.push(e):console.log(`🔍 [私信列表过滤] 跳过未绑定角色: ${n}`)}else a.push(e)}if(console.log(`📨 [渲染私信列表] 原始消息: ${n?.length||0}条，过滤后: ${a.length}条`),0!==a.length)for(const n of a){const e=await mc(n);t.appendChild(e)}else t.innerHTML='\n <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 32px; text-align: center; ">\n <svg viewBox="0 0 24 24" style="width: 56px; height: 56px; fill: var(--x-text-secondary); margin-bottom: 16px;">\n <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>\n </svg>\n <div style="font-size: 28px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 8px; " data-i18n="messagesEmpty">暂无私信</div>\n <div style="font-size: 14px; color:var(--x-text-secondary); max-width: 320px; " data-i18n="messagesEmptyDesc">发送私信与朋友保持联系</div>\n </div>\n '}async function mc(t){const o=document.createElement("div");o.className="message-item",o.style.cssText="\n display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--x-border-color); cursor: pointer; transition: background-color 0.2s;\n";let a=t.userAvatar,i=t.userName,r=t.userHandle;if(t.id&&t.id.startsWith("msg_")&&"msg_001"!==t.id)try{const n=e(),o=t.id.replace("msg_",""),s=await n.xCharacterProfiles.get(o);s&&(s.xAvatar&&(a=s.xAvatar),s.xName&&(i=s.xName),s.xHandle&&(r=s.xHandle))}catch(n){console.warn("读取角色X资料失败:",n)}let s=t.lastMessage||"",l=t.timestamp;try{const n=e(),o=`messageConversation_${vt||"main"}_${t.id}`,a=await n.xAccountProfiles.get(o);if(a&&a.data&&a.data.messages){const n=a.data.messages;if(n.length>0){const e=n[n.length-1];"text"===e.type?s=e.content:"image"===e.type?s="[图片]":"voice"===e.type?s="[语音]":"link"===e.type?s="[链接]":"quoteTweet"===e.type?s="[转发推文]":"quoteProfile"===e.type&&(s="[转发主页]"),e.timestamp&&(l=e.timestamp)}}}catch(n){console.warn("获取最新消息失败:",n)}const c=xc(l);return o.innerHTML=`\n\n <div style="position: relative; flex-shrink: 0; margin-right: 12px;">\n\n <img src="${a}"\nalt="${i}"\n style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; ">\n\n ${t.unread?'\n <div style="position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background-color: var(--x-accent); border: 2px solid var(--x-bg-primary); border-radius: 50%; "></div>\n ':""}\n </div>\n\n <div style="flex: 1; min-width: 0;">\n\n <div style="display: flex; align-items: center; margin-bottom: 4px;">\n <span style="font-size: 15px; font-weight: ${t.unread,"700"}; color:var(--x-text-primary); margin-right: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${i}</span>\n<span style="font-size: 15px; color:var(--x-text-secondary); margin-right: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">@${r}</span>\n <span style="font-size: 15px; color:var(--x-text-secondary); margin-left: auto; flex-shrink: 0; ">· ${c}</span>\n </div>\n\n <div style="font-size: 15px; color: ${t.unread?"var(--x-text-primary)":"var(--x-text-secondary)"}; font-weight: ${t.unread?"600":"normal"}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${s||"开始对话"}</div>\n </div>\n`,o.addEventListener("mouseenter",()=>{o.style.backgroundColor="var(--x-bg-hover)"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="transparent"}),o.addEventListener("click",()=>{n.openMessageDetail(t)}),o}function xc(n){const e=new Date,t=new Date(n),o=e-t,a=Math.floor(o/1e3),i=Math.floor(a/60),r=Math.floor(i/60),s=Math.floor(r/24),l="en"===Hn;if(a<60)return l?"now":"刚刚";if(i<60)return l?`${i}m`:`${i}分钟`;if(r<24)return l?`${r}h`:`${r}小时`;if(s<7)return l?`${s}d`:`${s}天`;if(l){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()}`}return`${t.getMonth()+1}月${t.getDate()}日`}function uc(){const n=document.getElementById("new-message-modal");n&&n.remove()}async function hc(t,o){const a=dc.some(n=>n.id===t.id);let i=!1,r=60,s=t.user.avatar;try{const n=e(),o=`strangerSettings_${vt||"main"}_${t.id}`,a=await n.xAccountProfiles.get(o);a&&(i=a.autoMessageEnabled||!1,r=a.autoMessageInterval||60,s=a.customAvatar||t.user.avatar)}catch(n){console.error("读取设置失败:",n)}const l=document.createElement("div");l.id="stranger-message-settings-modal",l.style.cssText="\n position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 25; backdrop-filter: blur(4px);\n",l.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; border: 1px solid var(--x-border-color); display: flex; flex-direction: column; " onclick="event.stopPropagation()">\n\n <div style="padding: 16px 20px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; ">\n <div style="display: flex; align-items: center; gap: 12px;">\n <img src="${t.user.avatar}" style="width: 40px; height: 40px; border-radius: 50%;">\n <div>\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">${t.user.name}</div>\n <div style="font-size: 14px; color:var(--x-text-secondary);">${t.user.handle}</div>\n </div>\n </div>\n <div onclick="closeStrangerMessageSettings()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="flex: 1; overflow-y: auto; padding: 20px; ">\n\n <div style="margin-bottom: 24px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; ">\n <div>\n <div style="font-size: 16px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">\n 添加到联系人\n </div>\n <div style="font-size: 13px; color:var(--x-text-secondary);">\n 添加后可在私信列表中快速找到\n </div>\n </div>\n <div class="x-toggle" id="contact-toggle" onclick="toggleStrangerContact('${t.id}')" style="cursor: pointer;">\n <div class="toggle-switch" style="width: 50px; height: 30px; background-color: ${a?"var(--x-accent)":"#333"}; border-radius: 15px; position: relative; transition: all 0.3s ease; ">\n <div class="toggle-circle" style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: ${a?"22px":"2px"}; transition: all 0.3s ease; "></div>\n </div>\n </div>\n </div>\n </div>\n\n <div style="margin-bottom: 24px;">\n <div style="font-size: 16px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 12px;">\n 更换头像\n </div>\n <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">\n <img id="stranger-avatar-preview" src="${s}" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; ">\n </div>\n <div style="display: flex; gap: 8px;">\n <input\n type="text"\n id="stranger-avatar-url-input"\n placeholder="输入图片链接地址"\n value="${s}"\n style="flex: 1; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 20px; padding: 10px 16px; font-size: 14px; color:var(--x-text-primary); outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n >\n <button onclick="updateStrangerAvatar('${t.id}')" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">\n 更新\n </button>\n </div>\n </div>\n\n <div style="margin-bottom: 24px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; ">\n <div>\n <div style="font-size: 16px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">\n 自动发信息\n </div>\n <div style="font-size: 13px; color:var(--x-text-secondary);">\n ${a?"启用后该账户会自动发送私信和推文":"需先添加到联系人后才能启用"}\n </div>\n </div>\n <div class="x-toggle" id="auto-message-toggle" onclick="${a?`toggleStrangerAutoMessage('${t.id}')`:"showXToast('请先添加到联系人', 'warning')"}" style="cursor: ${a?"pointer":"not-allowed"}; opacity: ${a?"1":"0.5"};">\n <div class="toggle-switch" style="width: 50px; height: 30px; background-color: ${i?"var(--x-accent)":"#333"}; border-radius: 15px; position: relative; transition: all 0.3s ease; ">\n <div class="toggle-circle" style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: ${i?"22px":"2px"}; transition: all 0.3s ease; "></div>\n </div>\n </div>\n </div>\n\n ${a?`\n <div style="margin-top: 12px;">\n <div style="font-size: 14px; color:var(--x-text-secondary); margin-bottom: 8px;">\n 发送间隔（秒）\n </div>\n <input\n type="number"\n id="stranger-interval-input"\n min="10"\n max="3600"\n value="${r}"\n style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 10px 12px; font-size: 14px; color:var(--x-text-primary); outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n onchange="updateStrangerInterval('${t.id}', this.value)"\n >\n <div style="font-size: 12px; color:var(--x-text-secondary); margin-top: 4px;">\n 建议：60-300秒之间\n </div>\n </div>\n `:""}\n </div>\n </div>\n </div>\n`;const c=document.getElementById("x-social-screen");c?c.appendChild(l):document.body.appendChild(l),l.onclick=n=>{n.target===l&&fc()},n.currentStrangerSettings={messageData:t,conversationData:o}}function fc(){const e=document.getElementById("stranger-message-settings-modal");e&&e.remove(),n.currentStrangerSettings=null}async function bc(t){try{const o=e(),a=`strangerSettings_${vt||"main"}_${t}`,i=await o.xAccountProfiles.get(a),r=i&&i.autoMessageEnabled,s=document.getElementById("auto-message-toggle"),l=s.querySelector(".toggle-switch"),c=s.querySelector(".toggle-circle");if(r)i.autoMessageEnabled=!1,await o.xAccountProfiles.put(i),l.style.backgroundColor="#333",c.style.left="2px",mn("已关闭自动发信息","success");else{const e=i||{handle:a,id:a,messageId:t,autoMessageInterval:60};if(e.autoMessageEnabled=!0,e.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(e),l.style.backgroundColor="var(--x-accent)",c.style.left="22px",void 0!==n.lastAutoMessageTrigger){n.lastAutoMessageTrigger[t]=Date.now();const o=e.autoMessageInterval||60;console.log(`⏰ 已为 ${t} 设置初始触发时间，需等待 ${o}秒 后首次触发`)}mn("已开启自动发信息","success")}}catch(n){console.error("切换自动发信息失败:",n),mn("操作失败","error")}}async function vc(n){console.log("🎯 [粉丝群] 打开设置弹窗",n);try{const t=e(),o=`messagesList_${vt||"main"}`,a=await t.xAccountProfiles.get(o),i=(a?.data||[]).find(e=>e.id===n.id);if(!i)return void mn("未找到粉丝群数据","error");let r=!1,s=120;const l=`fanGroupSettings_${vt||"main"}_${n.id}`,c=await t.xAccountProfiles.get(l);c&&c.data&&(r=c.data.autoMessageEnabled||!1,s=c.data.autoMessageInterval||120);const d=document.createElement("div");d.id="fangroup-settings-modal",d.style.cssText="\n position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 25; backdrop-filter: blur(4px); ",d.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 480px; max-height: 85vh; overflow: hidden; border: 1px solid var(--x-border-color); display: flex; flex-direction: column; " onclick="event.stopPropagation()">\n\n <div style="padding: 14px 16px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; ">\n <div style="font-size: 17px; font-weight: 700; color:var(--x-text-primary);">粉丝群设置</div>\n <div style="display: flex; align-items: center; gap: 4px;">\n <div onclick="openFanGroupShareModal('${n.id}')" style="cursor: pointer; padding: 6px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'"\n title="转发粉丝群">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);">\n <g><path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.791-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.791 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></g>\n </svg>\n </div>\n <div onclick="closeFanGroupSettings()" style="cursor: pointer; padding: 6px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-secondary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n\n <div style="flex: 1; overflow-y: auto; padding: 16px; ">\n\n <div style="margin-bottom: 18px;">\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 10px;">\n 群头像\n </div>\n <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">\n <img id="fangroup-avatar-preview" src="${i.userAvatar||i.groupAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}" style="width: 52px; height: 52px; border-radius: 50%; object-fit: cover; ">\n </div>\n <div style="display: flex; gap: 6px;">\n <input\n type="text"\n id="fangroup-avatar-input"\n placeholder="输入图片链接地址"\n value="${i.userAvatar||i.groupAvatar||""}"\n style="flex: 1; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 8px 12px; font-size: 13px; color:var(--x-text-primary); outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n oninput="updateFanGroupAvatarPreview(this.value)"\n >\n <button onclick="saveFanGroupAvatar('${n.id}')" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 8px; padding: 8px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">\n 更新\n </button>\n </div>\n </div>\n\n <div style="margin-bottom: 18px;">\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 10px;">\n 群名称\n </div>\n <input\n type="text"\n id="fangroup-name-input"\n placeholder="输入群名称"\n value="${i.userName||i.groupName||"我的粉丝群"}"\n maxlength="30"\n style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 10px 12px; font-size: 13px; color:var(--x-text-primary); outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n >\n </div>\n\n <div style="margin-bottom: 18px;">\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 10px;">\n 入群门槛\n </div>\n <textarea\n id="fangroup-threshold-input"\n placeholder="例如：关注满30天、互动次数达到10次等..."\n maxlength="200"\n style="width: 100%; min-height: 80px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 10px 12px; font-size: 13px; color:var(--x-text-primary); outline: none; resize: vertical; font-family: inherit; line-height: 1.5; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n >${i.groupThreshold||""}</textarea>\n <div style="text-align: right; margin-top: 4px;">\n <span style="font-size: 11px; color:var(--x-text-secondary);">设置粉丝需要满足的条件才能进群</span>\n </div>\n </div>\n\n <div style="margin-bottom: 24px;">\n <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; ">\n <div>\n <div style="font-size: 16px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px;">\n 后台自动发信息\n </div>\n <div style="font-size: 13px; color:var(--x-text-secondary);">\n 启用后群成员会自动交流\n </div>\n </div>\n <div class="x-toggle" id="fangroup-auto-message-toggle" onclick="toggleFanGroupAutoMessage('${n.id}')" style="cursor: pointer;">\n <div class="toggle-switch" style="width: 50px; height: 30px; background-color: ${r?"var(--x-accent)":"#333"}; border-radius: 15px; position: relative; transition: all 0.3s ease; ">\n <div class="toggle-circle" style="width: 26px; height: 26px; background-color:#fff; border-radius: 50%; position: absolute; top: 2px; left: ${r?"22px":"2px"}; transition: all 0.3s ease; "></div>\n </div>\n </div>\n </div>\n\n <div style="margin-top: 12px;">\n <div style="font-size: 14px; color:var(--x-text-secondary); margin-bottom: 8px;">\n 发送间隔（秒）\n </div>\n <input\n type="number"\n id="fangroup-interval-input"\n min="60"\n max="3600"\n value="${s}"\n style="width: 100%; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 10px 12px; font-size: 14px; color:var(--x-text-primary); outline: none; "\n onfocus="this.style.borderColor='var(--x-accent)'"\n onblur="this.style.borderColor='var(--x-border-color)'"\n onchange="updateFanGroupInterval('${n.id}', this.value)"\n >\n <div style="font-size: 12px; color:var(--x-text-secondary); margin-top: 4px;">\n 建议：120-600秒之间\n </div>\n </div>\n </div>\n\n <div style="margin-bottom: 18px;">\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">\n <span>群成员</span>\n <span style="font-size: 13px; color: var(--x-accent); font-weight: 700;">${i.members?.length||0} 人</span>\n </div>\n <div style="max-height: 240px; overflow-y: auto; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 8px; padding: 6px; ">\n ${i.members&&i.members.length>0?i.members.map(e=>`\n <div style="display: flex; align-items: center; gap: 10px; padding: 6px; border-radius: 6px; transition: background-color 0.2s; margin-bottom: 2px; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <img src="${e.avatar}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; ">\n <div style="flex: 1; min-width: 0;">\n <div style="color:var(--x-text-primary); font-size: 13px; font-weight: 600;">\n ${e.name}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 11px;">\n ${e.handle}\n </div>\n </div>\n <button onclick="kickFanGroupMember('${n.id}', '${e.id}', '${e.name}')" style="background-color: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; padding: 4px 10px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; " onmouseover="this.style.backgroundColor='#ef444410'"\n onmouseout="this.style.backgroundColor='transparent'">\n 踢出\n </button>\n </div>\n `).join(""):'<div style="text-align: center; padding: 20px; color:var(--x-text-secondary); font-size: 12px; ">暂无成员</div>'}\n </div>\n </div>\n </div>\n\n <div style="padding: 12px 16px; border-top: 1px solid var(--x-border-color); display: flex; flex-direction: column; gap: 8px;">\n\n <button onclick="openFanGroupApplicationsModal('${n.id}')" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 8px; padding: 10px 16px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'" onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <g><path d="M17.5 4.5c-1.95-1.96-5.11-1.96-7.07 0-1.96 1.96-1.96 5.11 0 7.07 1.95 1.96 5.11 1.96 7.07 0 1.96-1.96 1.96-5.11 0-7.07zM14 9c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z M12 14H6c-1.1 0-2 .9-2 2v5h16v-5c0-1.1-.9-2-2-2h-6z"></path></g>\n </svg>\n 查看入群申请\n </button>\n\n <div style="display: flex; gap: 6px;">\n <button onclick="dissolveFanGroup('${n.id}')" style="background-color: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; padding: 9px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; " onmouseover="this.style.backgroundColor='#ef444410'"\n onmouseout="this.style.backgroundColor='transparent'">\n 解散群聊\n </button>\n <button onclick="closeFanGroupSettings()" style="flex: 1; background-color:var(--x-bg-secondary); color:var(--x-text-secondary); border: none; border-radius: 8px; padding: 9px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'" onmouseout="this.style.backgroundColor='var(--x-bg-secondary)'">取消</button>\n <button onclick="saveFanGroupSettings('${n.id}')" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 8px; padding: 9px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">保存</button>\n </div>\n </div>\n </div>\n `;const p=document.getElementById("x-social-screen");p?p.appendChild(d):document.body.appendChild(d),d.onclick=n=>{n.target===d&&yc()}}catch(n){console.error("❌ [粉丝群] 打开设置失败:",n),mn("打开设置失败","error")}}function yc(){const n=document.getElementById("fangroup-settings-modal");n&&n.remove()}function wc(){const n=document.getElementById("fangroup-share-modal");n&&n.remove()}async function kc(e,t=!1,o={}){console.log("💬 [第11情景] 粉丝群私信生成器启动",{groupId:e.id,groupName:e.userName||e.groupName,isContinueMode:t});try{const{apiConfig:a,xSettings:i,xDb:r}=await g.loadConfigAndSettings(),{userPrompt:l,worldSetting:c}=i,p=s.buildUserXProfileInfo(n.userProfileData),m=`userTweets_${vt||"main"}`,x=await r.xUserTweets.get(m),u=x?.tweets?.slice(0,3)||[];console.log("📋 [第11情景] 用户资料:",p),console.log("📋 [第11情景] 用户推文数:",u.length);const h=`messagesList_${vt||"main"}`,f=await r.xAccountProfiles.get(h),b=(f?.data||[]).find(n=>n.id===e.id);if(!b)return mn("未找到粉丝群数据","error"),[];const v=b.members||[],y=[],w=[];console.log("👥 [第11情景] 群成员数:",v.length);const k=`fanGroupApplications_${vt||"main"}_${b.id}`,$=await r.xAccountProfiles.get(k),C=$?.data||[];for(const n of v){const e=await s.getUnifiedProfile(n.handle,{userProfileInfo:p,messageId:n.id});e&&(e.tweets&&e.tweets.length>0&&(e.tweets=[e.tweets[0]]),y.push(e));const t=C.find(e=>e.id===n.id&&"approved"===e.status);t&&w.push({memberId:n.id,memberName:n.name,memberHandle:n.handle,reason:t.reason,type:t.type,amount:t.amount})}console.log("📊 [第11情景] 已加载成员资料:",y.length),console.log("📊 [第11情景] 已加载入群申请:",w.length);let I=0,S=s.buildBaseSystemPrompt({userPrompt:l,worldSetting:c});I=d.logTokenUsage("第11情景-粉丝群私信","基础系统提示词",S,I);const M=await s.getApplicableWorldBooks("messages",{boundCharacters:[]});M&&(S+=M,I=d.logTokenUsage("第11情景-粉丝群私信","世界书内容",M,I)),S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 用户完整资料（粉丝群主）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n- 用户名：${p.name}\n- 用户句柄：${p.handle}\n- 认证状态：${p.verified?"已认证":"未认证"}\n${p.verificationType&&"none"!==p.verificationType?"- 认证类型："+("verified"===p.verificationType?"蓝色勾标认证":"couple"===p.verificationType?"情侣认证":"married"===p.verificationType?"已婚认证":"vip"===p.verificationType?"VIP认证":"无"):""}\n${p.publicIdentity?`- 公众身份：${p.publicIdentity}`:""}\n${p.bio?`- 个人简介：${p.bio}`:""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,u.length>0&&(S+=`\n【用户近期推文】（${u.length}条，了解群主风格）：\n`,u.forEach((n,e)=>{S+=`${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n`})),S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👥 粉丝群信息\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n- 群名：${b.userName||b.groupName}\n- 群主：${p.name} (${p.handle})\n- 当前成员数：${v.length} 人\n${b.groupThreshold?`- 入群门槛：${b.groupThreshold}`:"- 入群门槛：无"}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;try{const n=`fanGroupAnnouncements_${vt||"main"}_${b.id}`,e=await r.xAccountProfiles.get(n),t=e?.data||[];if(t.length>0){S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📢 粉丝群公告（${t.length}条）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 重要：请注意以下群公告内容，这些是群主发布的重要信息，成员的对话可能会涉及这些公告内容。\n`;t.slice(0,10).forEach((n,e)=>{const t=new Date(n.createdAt),o=`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日 ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;S+=`\n【公告 ${e+1}】\n发布时间：${o}\n公告内容：${n.content}\n`}),S+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",console.log(`📢 [第11情景] 已加载群公告: ${t.length}条`)}}catch(n){console.warn("⚠️ [第11情景] 加载群公告失败:",n)}try{const n=`fanGroupFolders_${vt||"main"}_${b.id}`,e=await r.xAccountProfiles.get(n),t=e?.data||[],o=await Bc(b.id);if(S+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📁 粉丝群文件库\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 重要：以下是群内的文件管理系统，成员可以在对话中引用、讨论或上传新文件。\n",t.length>0?(S+=`\n【文件夹列表】（${t.length}个）\n⚠️ 上传文件时可以选择放入以下文件夹，也可以不放入任何文件夹（散落显示）\n`,t.forEach((n,e)=>{const t=o.filter(e=>e.folderId===n.id);S+=`${e+1}. 文件夹「${n.name}」\n - 文件夹ID: ${n.id}（上传文件时使用此ID）\n - 包含文件数: ${t.length}个\n`})):S+="\n【文件夹列表】\n暂无文件夹，上传的文件将显示为未分类状态\n",o.length>0){S+=`\n【已上传文件】（${o.length}个）\n`;o.slice(0,20).forEach((n,e)=>{const t=new Date(n.uploadedAt),o=`${t.getMonth()+1}/${t.getDate()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`,a="text"===n.type?"文本文档":"image"===n.type?"图片文件":"video"===n.type?"视频文件":"link"===n.type?"链接":"文件";S+=`\n【文件 ${e+1}】\n文件名：${n.name}\n类型：${a}\n上传者：${n.uploadedBy}\n上传时间：${o}\n所属文件夹：${n.folderName}\n内容摘要：${n.content.substring(0,150)}${n.content.length>150?"...":""}\n`})}S+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",console.log(`📁 [第11情景] 已加载群文件: ${o.length}个, 文件夹: ${t.length}个`)}catch(n){console.warn("⚠️ [第11情景] 加载群文件失败:",n)}v.length>0&&(S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👥 群成员资料（${v.length}人）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 重要：每个成员必须使用以下准确的ID、昵称和句柄，不得自创！\n`,v.forEach((n,e)=>{S+=`\n【群成员 ${e+1}】\n- 成员ID: ${n.id}（生成消息时必须使用此ID作为senderId）\n- 昵称: ${n.name}（生成消息时必须使用此昵称作为senderName）\n- 句柄: ${n.handle}（生成消息时必须使用此句柄作为senderHandle）\n- 头像: ${n.avatar}（生成消息时必须使用此头像作为senderAvatar）\n`;const t=y.find(e=>e.handle===n.handle);if(t){const n=s.formatProfileForPrompt(t,{includeType:!1,includeTweets:!0,includeRelationships:!0});S+=n}else S+="⚠️ 未能获取该成员的详细资料\n";const o=w.find(e=>e.memberHandle===n.handle);o&&(S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📝 入群申请信息（了解该成员加群动机）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n申请理由：${o.reason}\n申请类型：${"sincere"===o.type?"真诚粉丝":"normal"===o.type?"普通申请":"可疑申请"}\n${o.amount>0?`入群费用：$${o.amount.toFixed(2)}`:"免费入群"}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`),S+="\n"}),S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 生成消息时的成员身份使用规则\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n必须从上述群成员列表中选择，使用准确的ID和身份信息：\n- senderId：必须使用【成员ID】（例如：${v[0]?.id}）\n- senderName：必须使用【昵称】（例如：${v[0]?.name}）\n- senderHandle：必须使用【句柄】（例如：${v[0]?.handle}）\n- senderAvatar：必须使用【头像】（例如：${v[0]?.avatar}）\n\n🚨 禁止自创成员身份！所有发言者必须是上述列出的群成员！\n⚠️ 如果某成员已被踢出（在聊天记录中看到"XX 被移出了粉丝群"），则该成员不得再发言！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`);let T=[];if(t){const n=`messageConversation_${vt||"main"}_${b.id}`,e=await r.xAccountProfiles.get(n);e&&e.data&&e.data.messages&&(T=e.data.messages)}if(console.log("📖 [第11情景] 现有对话记录:",T.length,"条（包括系统通知）"),t&&T.length>0){S+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 粉丝群聊天记录（当前私信的历史记录，包括系统通知）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";T.slice(-30).forEach((n,e)=>{let t="";if("system"===n.type)return t=`[系统通知] ${n.content}`,void(S+=`${t}\n`);const o=n.isOwn?p.name:n.senderName||"群成员";if("text"===n.type)t=n.content||"";else if("image"===n.type)t=n.isOwn&&n.imageData?"[用户发送了图片]":n.imageDescription?`[图片: ${n.imageDescription}]`:"[图片]";else if("voice"===n.type)t=`[语音: ${n.voiceText||"语音消息"}]`;else if("sticker"===n.type)t=n.isOwn&&n.stickerDescription?`[用户发送的表情包: ${n.stickerDescription}]`:n.stickerUrl?`[表情包: ${n.stickerUrl}]`:"[表情包]";else if("transfer"===n.type){const e=parseFloat(n.amount||0).toFixed(2),o=n.note?` (${n.note})`:"",a=n.isOwn?"转出":"转入";t=`[${a}: $${e}${o}]`}else if("link"===n.type)t=`[文章链接]\n标题：${n.title}\n简介：${n.description||""}\n作者：${n.author||""}\n来源：${n.source||""}\n正文：${n.body||n.description||""}`;else if("quoteTweet"===n.type)t=`[转发推文: ${n.tweet?.content||""}]`;else if("quoteProfile"===n.type)t=`[分享主页: ${n.profile?.name||""}]`;else if("quoteFanGroup"===n.type)t=`[分享粉丝群: ${n.fanGroup?.name||""}（${n.fanGroup?.memberCount||0}人）${n.fanGroup?.threshold?`，入群门槛：${n.fanGroup.threshold}`:""}]`;else if("groupFile"===n.type){const e="text"===n.file?.type?"文本文档":"image"===n.file?.type?"图片":"video"===n.file?.type?"视频":"link"===n.file?.type?"链接":"文件";t=`[群文件: ${n.file?.name||"未命名文件"}]\n类型：${e}\n上传者：${n.file?.uploadedBy||"未知"}\n内容：${n.file?.content?.substring(0,100)||""}${n.file?.content?.length>100?"...":""}`}else if("forward"===n.type)if("tweet"===n.forwardType)if(t="[转发了推文]\n",n.fullContext&&n.fullContext.tweet){const e=n.fullContext.tweet;t+=`推文作者：${e.user?.name||"未知"}\n推文内容：${e.content||""}\n`,n.fullContext.comments&&n.fullContext.comments.length>0&&(t+=`评论区（${n.fullContext.comments.length}条评论）：\n`,n.fullContext.comments.slice(0,3).forEach((n,e)=>{t+=` ${e+1}. ${n.user?.name||"未知"}: ${n.content||""}\n`}),n.fullContext.comments.length>3&&(t+=` ...还有${n.fullContext.comments.length-3}条评论\n`))}else t+=`${n.forwardContent?.content||""}`;else"comment"===n.forwardType&&(t="[转发了评论]\n",n.fullContext?(n.fullContext.parentTweet&&(t+=`原推文作者：${n.fullContext.parentTweet.user?.name||"未知"}\n原推文内容：${n.fullContext.parentTweet.content||""}\n\n`),n.fullContext.comment&&(t+=`评论作者：${n.fullContext.comment.user?.name||"未知"}\n评论内容：${n.fullContext.comment.content||""}`)):t+=`${n.forwardContent?.content||""}`);else t=`[${n.type}消息]`;if(t){const n=t.length>100?`${t.substring(0,100)}...`:t;S+=`${o}: ${n}\n`}}),S+='\n⚠️ 以上是现有对话记录（包括系统通知），请保持对话的连贯性和一致性\n⚠️ 注意：如果看到"XX 被移出了粉丝群"的系统通知，该成员不得再发言！\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n'}const A=o.isAutoTrigger||!1,E=o.newMemberCount||0;S+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：粉丝群对话生成 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的粉丝群私信对话生成器。\n**群聊场景**：\n- 📱 这是X社交平台的粉丝群私信功能\n- 👥 这是一个群聊，有${v.length}位成员\n- 👑 群主是${p.name} (${p.handle})\n${A?`- 🎉 群成员数达到${E}人，触发自动群聊`:"- 💬 用户"+(t?"刚刚在群里发言":"打开了粉丝群聊天")}\n**生成要求**：\n${A?`\n1. 生成5-12条群成员的发言，庆祝群成员达到${E}人\n2. 成员发言应该多样化：祝贺、感谢群主、分享感受、互相交流等\n3. 不同成员的发言风格应该根据其资料和入群申请体现差异\n4. 可以@群主或其他成员（使用句柄，如 @${p.handle}）\n5. 🎯 **重要：成员之间要互相交流**，不要只是单向对群主说话\n`:o.isAutoReaction?"\n1. 生成6-15条群成员之间的自发交流消息\n2. 🎯 **核心：成员之间的互动交流，而不是对群主的回应**\n3. 交流内容可以是：\n- 成员之间互相打招呼、闲聊\n- 讨论共同感兴趣的话题（根据成员资料推断）\n- 分享最近的生活、工作、学习\n- 互相@对方进行对话（使用句柄，如 @成员句柄）\n- 对其他成员的推文或动态发表看法\n- 讨论群主的最近推文（但不是直接@群主）\n- 组织活动、约饭、游戏等\n4. 每个成员的发言要符合其性格特点和入群申请体现的动机\n5. 营造真实的粉丝群内部氛围，像真实的粉丝群一样有活力\n6. 至少要有2-3组成员之间的对话往来（A说话->B回应->C插话）\n":t?'\n1. 根据用户最新发言，生成3-8条群成员的回复\n2. 🎯 **重要：不要所有成员都只回应群主**\n3. 可以有以下几种情况：\n- 部分成员直接回应群主的发言\n- 部分成员之间互相交流、讨论群主的话题\n- 部分成员@其他成员进行对话\n4. 回复应该自然、多样，符合各成员的身份和性格\n5. 不是每个成员都必须回复，根据话题相关性和成员特点选择\n6. 营造真实的群聊氛围，而不是"群主发言->所有人回应"的模式\n':"\n1. 生成4-8条群成员的日常发言\n2. 发言内容可以是：打招呼、分享日常、讨论共同兴趣、询问群主等\n3. 体现真实的粉丝群氛围\n4. 成员之间可以互相交流，不要只是单向对群主说话\n"}\n${o.isAutoReaction?"6.":"5."} 🚨 只生成群成员的消息，不要生成用户（群主）的消息\n${o.isAutoReaction?"7.":"6."} 每条消息必须包含senderId（成员ID）、senderName（成员昵称）、senderHandle（成员句柄）、senderAvatar（成员头像）\n${o.isAutoReaction?"8.":"7."} 消息类型包括多种，请根据实际需要自然选择\n**消息类型使用原则**：\n- ⭐ **以文本消息为主**：大部分消息（80-90%）应该是纯文本消息（type: "text"）\n- 📷 **偶尔使用其他类型**：仅在特定情况下使用其他消息类型（10-20%）：\n* image：当需要分享照片、图片或视觉内容时\n* voice：当成员特别激动、情绪强烈时\n* sticker：⚠️ **极少使用**（不超过5%）！只在情绪特别强烈且适合用表情包表达时才使用\n* transfer：⚠️ **极少使用**！群成员可以发红包给群主或其他成员（5-30美元），需谨慎\n* link：当需要分享文章、新闻或故事时\n* quoteTweet：当提及或讨论某条推文时\n* quoteProfile：当推荐某个账户或介绍某人时\n- 🚫 **禁止每种类型都使用**：不要为了展示多样性而强行使用所有消息类型\n- ✅ **自然使用**：根据对话内容和情境自然选择消息类型，不刻意\n**JSON返回格式**：\n\`\`\`json\n{\n"messages": [\n{\n "senderId": "成员ID（从成员列表中选择）",\n "senderName": "成员昵称",\n "senderHandle": "成员句柄（如@username）",\n "senderAvatar": "成员头像URL",\n "type": "text",\n "content": "消息内容",\n "time": "刚刚"\n}\n]\n}\n\`\`\`\n**消息类型详解**：\n1. 文本消息（最常用，首选）：\n{\n"type": "text",\n"content": "消息内容",\n"time": "刚刚"\n}\n2. 图片消息：\n{\n"type": "image",\n"imageDescription": "图片内容的文字描述",\n"sensitive": false,\n"time": "刚刚"\n}\n3. 语音消息：\n{\n"type": "voice",\n"voiceText": "先用括号标注出对声音的形容，再是语音内容的文字",\n"duration": "时长如0:15",\n"time": "刚刚"\n}\n4. 表情包消息：\n{\n"type": "sticker",\n"stickerUrl": "表情包图片链接（从世界书中选择）",\n"time": "刚刚"\n}\n5. 转账消息（普通转账，群成员发红包）：\n{\n"type": "transfer",\n"amount": 20.00,\n"note": "感谢群主",\n"status": "pending",\n"time": "刚刚"\n}\n⚠️ 转账说明：\n- amount：转账金额（数字类型），建议5-30美元\n- note：转账备注，说明转账目的\n- status：必须为"pending"\n- 🚫 **不支持商业转账**：粉丝群中只能发普通转账（红包、礼物等）\n- 🚫 **谨慎使用**：只有关系亲密或有明确理由时才转账\n6. 文章链接消息：\n{\n"type": "link",\n"url": "文章来源网址（可选）",\n"title": "文章标题",\n"description": "文章简介/摘要",\n"author": "文章作者",\n"source": "文章来源名称",\n"body": "文章正文内容（完整内容，可使用**文本**加粗，__文本__下划线）",\n"time": "刚刚"\n}\n7. 转发推文：\n{\n"type": "quoteTweet",\n"tweet": {\n"userName": "推文作者名",\n"userHandle": "@handle",\n"userAvatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n"verified": false,\n"content": "推文内容",\n"time": "推文时间"\n},\n"caption": "转发时的说明（可选）",\n"time": "刚刚"\n}\n8. 转发主页：\n{\n"type": "quoteProfile",\n"profile": {\n"name": "账户名",\n"handle": "@handle",\n"avatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n"bio": "个人简介",\n"followers": 关注者数量（数字）,\n"verified": false\n},\n"caption": "转发时的说明（可选）",\n"time": "刚刚"\n}\n9. 转发粉丝群：\n{\n"type": "quoteFanGroup",\n"fanGroup": {\n"id": "粉丝群ID",\n"name": "粉丝群名称",\n"avatar": "粉丝群头像链接",\n"memberCount": 成员数量（数字）,\n"threshold": "入群门槛说明（可选）"\n},\n"caption": "转发时的说明（可选）",\n"time": "刚刚"\n}\n⚠️ 转发粉丝群说明：\n- 这是用户转发粉丝群邀请时的消息类型\n- 包含粉丝群的基本信息：名称、头像、成员数、入群门槛等\n- 群成员可以根据粉丝群信息决定是否感兴趣、讨论这个群等\n- AI不应该主动生成此类型消息（除非有合理的场景理由）\n10. 群文件上传：\n{\n"type": "groupFile",\n"file": {\n"name": "文件名称",\n"type": "文件类型（text/image/video/link）",\n"content": "文件内容（完整文本内容、链接URL等）",\n"folderId": "文件夹ID（可选）"\n},\n"time": "刚刚"\n}\n⚠️ 群文件说明：\n- 成员可以上传文本文档、图片链接、视频链接、文章链接等各种资料到群文件\n- file.type：文件类型（text文本、image图片、video视频、link链接）\n- file.content：文件实际内容，对于文本是完整内容，对于链接是URL\n- file.name：文件名，应该能够概括文件内容\n- file.folderId：📂 **文件夹归类**（可选字段）\n * 如果要将文件放入特定文件夹，从上方【文件夹列表】中选择对应的文件夹ID\n * 例如：如果有文件夹「学习资料」ID为folder_123，设置"folderId": "folder_123"\n * 如果不指定或设为null，文件将显示为"未分类"状态\n * 💡 建议：相关主题的文件归入同一文件夹，方便查找和管理\n- 📁 成员上传的文件会自动添加到群文件库，群主和其他成员可以在群文件中查看\n- 🎯 使用场景：分享学习资料、工作文档、有用的链接、图片素材等\n- 🎯 归类建议：根据内容类型选择合适的文件夹，如学习资料放入学习文件夹，图片素材放入素材文件夹\n11. 转发推文/评论（forward）：\n⚠️ **此类型禁止AI生成！这是用户手动转发操作产生的消息类型。**\n如果在聊天记录中看到此类型消息，说明用户转发了推文或评论到群里，可以查看其中的完整内容：\n- 转发推文时，包含完整推文内容和该推文的所有评论区内容\n- 转发评论时，包含评论内容和该评论所属的推文内容\nAI应该根据这些完整的上下文信息来理解用户分享的内容并给出回应。\n⚠️ 重要规则：\n- 群成员ID、昵称、句柄、头像必须从上方群成员资料中选择，不要自创\n- 每个成员的发言要符合其资料和入群申请体现的性格特点\n- 保持群聊的真实感和多样性，避免千篇一律\n- ⚠️ image和sticker是完全不同的类型，不要混淆！\n- ⚠️ link类型是文章链接，需要包含完整的文章内容\n- 时间使用相对时间（如"刚刚"、"1分钟前"等）\n- 所有头像统一使用成员列表中提供的头像URL\n- verified字段必须是布尔值(true/false)\n- followers等数字字段必须是纯数字\n- 可选字段不使用时完全省略，不要设为null\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const z=S.length;S+=s.buildUniversalConstraints(p);const B=S.substring(z);I=d.logTokenUsage("第11情景-粉丝群私信","用户约束",B,I);const L=[{role:"user",content:"请生成粉丝群对话"}];d.logFinalPrompt("第11情景-粉丝群私信",S,L[0].content);const P=await g.sendAIRequest({apiConfig:a,systemPrompt:S,messages:L,temperature:.9});console.log("🎯 [第11情景] AI响应长度:",P.length,"字符"),console.log("🎯 [第11情景] AI完整响应:\n",P);let D=g.parseJSONResponse(P);if(!D.messages||!Array.isArray(D.messages))throw new Error("AI返回的数据格式不正确");console.log(`✅ [第11情景] 成功解析JSON，共${D.messages.length}条消息`),console.log("📋 [第11情景] 消息发送者列表:",D.messages.map(n=>`${n.senderName}(${n.senderId})`).join(", "));const N=D.messages.map(n=>({type:n.type||"text",content:n.content||"",isOwn:!1,time:n.time||"刚刚",timestamp:(new Date).toISOString(),senderId:n.senderId,senderName:n.senderName,senderHandle:n.senderHandle,senderAvatar:n.senderAvatar,imageDescription:n.imageDescription,sensitive:n.sensitive,stickerUrl:n.stickerUrl,voiceText:n.voiceText,voiceDuration:n.voiceDuration,duration:n.duration,amount:n.amount,note:n.note,status:n.status,title:n.title,description:n.description,author:n.author,source:n.source,body:n.body,url:n.url,tweet:n.tweet,caption:n.caption,profile:n.profile,file:n.file?{name:n.file.name,type:n.file.type,content:n.file.content,folderId:n.file.folderId||null,uploadedBy:n.senderName,uploadedAt:(new Date).toISOString()}:void 0}));console.log(`✅ [第11情景] 成功生成${N.length}条群聊消息`);const R=N.filter(n=>"groupFile"===n.type&&n.file);if(R.length>0){console.log(`📁 [第11情景] 检测到${R.length}个AI生成的群文件，正在保存...`);try{const n=`fanGroupFiles_${vt||"main"}_${b.id}`,e=await r.xAccountProfiles.get(n);let t=e?.data||[];for(const n of R){const e={id:`file_ai_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:n.file.name,type:n.file.type,content:n.file.content,folderId:n.file.folderId||null,uploadedBy:n.senderName,uploadedAt:n.file.uploadedAt||(new Date).toISOString()};t.push(e),n.file.id=e.id,console.log(`✅ [群文件] AI上传文件: ${e.name} (${n.senderName})`)}await r.xAccountProfiles.put({handle:n,name:"fanGroupFiles",data:t,updatedAt:(new Date).toISOString()}),console.log(`✅ [第11情景] 已保存${R.length}个AI生成的群文件到数据库`)}catch(n){console.error("❌ [第11情景] 保存AI生成的群文件失败:",n)}}return(await s.enforceAvatarRules({messages:N})).messages||N}catch(n){return console.error("❌ [第11情景] 生成粉丝群对话失败:",n),mn("生成对话失败: "+n.message,"error"),[]}}async function $c(t,o){console.log("🔍 [粉丝群] 检查自动触发条件",{groupId:t,newMemberCount:o});if([5,15,25,35,45,55,65,75,85,95].includes(o)){console.log(`🎉 [粉丝群] 成员数达到${o}人，触发自动群聊！`);try{const a=e(),i=`messagesList_${vt||"main"}`,r=await a.xAccountProfiles.get(i),s=(r?.data||[]).find(n=>n.id===t);if(!s)return void console.error("❌ [粉丝群] 未找到粉丝群数据");const l=await kc(s,!0,{isAutoTrigger:!0,newMemberCount:o});if(!l||0===l.length)return void console.error("❌ [粉丝群] AI未生成任何消息");const c=`messageConversation_${vt||"main"}_${t}`,d=await a.xAccountProfiles.get(c);if(d&&d.data?(d.data.messages.push(...l),await a.xAccountProfiles.put(d)):await a.xAccountProfiles.put({handle:c,name:"conversation",data:{messages:l},updatedAt:(new Date).toISOString()}),console.log(`✅ [粉丝群] 已保存${l.length}条自动生成的群聊消息`),r&&r.data){const n=r.data.findIndex(n=>n.id===t);if(-1!==n){const e=l[l.length-1];r.data[n].lastMessage=e.content||e.voiceText||e.imageDescription||"[消息]",r.data[n].timestamp=(new Date).toISOString(),r.data[n].unread=!0,await a.xAccountProfiles.put(r),dc=r.data}}await pc(),Rl({title:s.userName||s.groupName,message:`群成员达到${o}人啦！大家都在庆祝呢~`,avatar:s.userAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"custom",leftIconHtml:'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);">\n <g><path d="M17.5 4.5c-1.95-1.96-5.11-1.96-7.07 0-1.96 1.96-1.96 5.11 0 7.07 1.95 1.96 5.11 1.96 7.07 0 1.96-1.96 1.96-5.11 0-7.07zM14 9c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z M12 14H6c-1.1 0-2 .9-2 2v5h16v-5c0-1.1-.9-2-2-2h-6z"></path></g>\n </svg>\n ',duration:5e3,onClick:()=>{n.openMessageDetail(s)}}),mn(`粉丝群达到${o}人！`,"success")}catch(n){console.error("❌ [粉丝群] 自动触发失败:",n)}}else console.log("⏸️ [粉丝群] 未达到触发条件")}async function Cc(){if(!Al)return;const t=Al.id,o=document.getElementById("fangroup-announcements-container");if(o)try{const a=e(),i=`fanGroupAnnouncements_${vt||"main"}_${t}`,r=await a.xAccountProfiles.get(i),s=r?.data||[];if(console.log("📢 [群公告] 加载公告列表",{groupId:t,count:s.length}),o.innerHTML="",0===s.length)return void(o.innerHTML='\n <div style="width: 100%; text-align: center; color:var(--x-text-secondary); font-size: 14px; padding: 40px 20px; grid-column: 1 / -1;">\n 📌 暂无公告，点击下方按钮创建第一条公告\n </div>\n ');s.forEach((e,t)=>{const a=function(e,t){const o=document.createElement("div"),a=document.getElementById("x-social-screen"),i=a?.classList.contains("x-theme-light"),r=["#EB9FAA","#F7D2D5","#FCEFF0","#C0CEE4","#F2E4E9","#A0A0A3","#BFBBBE","#5F5F60","#67B3DB","#9EDAF1","#CDEEF8","#FFFBDD","#D40D3E","#FDF5DC","#C9EAF8","#DA2E53","#FFEBD5","#FFC4AF","#FF8D65","#8FDBE0"],s=Math.floor(Math.random()*r.length),l=r[s],c={bg:l,border:i?Ic(l,15):Sc(l,15)},d=n.innerWidth<=640,p=d?1.5:3,g=(Math.random()*p*2-p).toFixed(2),m=Math.random(),x=m<.3,u=m>=.3&&m<.6,h=m>=.6,f=Math.random()>.5?"left":"right",b=["#c0c0c0","#ffd700","#ff6b6b","#4ecdc4"],v=b[Math.floor(Math.random()*b.length)],y=Math.random()>.5,w=60*Math.random()+20+"%",k=Math.random()>.5?"45deg":"-45deg",$=new Date(e.createdAt),C=`${$.getFullYear()}/${String($.getMonth()+1).padStart(2,"0")}/${String($.getDate()).padStart(2,"0")} ${String($.getHours()).padStart(2,"0")}:${String($.getMinutes()).padStart(2,"0")}`,I=h?"polygon(\n 0% 2%, 3% 0%, 6% 2%, 9% 0%, 12% 1%, 15% 0%, 18% 2%, 21% 0%, 24% 1%, 27% 0%,\n 30% 2%, 33% 0%, 36% 1%, 39% 0%, 42% 2%, 45% 0%, 48% 1%, 51% 0%, 54% 2%,\n 57% 0%, 60% 1%, 63% 0%, 66% 2%, 69% 0%, 72% 1%, 75% 0%, 78% 2%, 81% 0%,\n 84% 1%, 87% 0%, 90% 2%, 93% 0%, 96% 1%, 100% 0%, 100% 100%, 0% 100%\n )":"none";o.style.cssText=`\n width: 100%;\n max-width: 400px;\n min-height: 180px;\n margin: 0 auto;\n background-color: ${c.bg};\n background-image:\n repeating-linear-gradient(\n 0deg,\n transparent,\n transparent 2px,\n rgba(0, 0, 0, 0.025) 2px,\n rgba(0, 0, 0, 0.025) 3px\n );\n border: none;\n border-radius: ${h?"0":"3px"};\n padding: ${d?"16px":"20px"};\n box-shadow:\n 0 1px 3px rgba(0, 0, 0, 0.12),\n 0 3px 6px rgba(0, 0, 0, 0.08),\n inset 0 1px 0 rgba(255, 255, 255, 0.15),\n inset 0 0 30px rgba(255, 255, 255, 0.05);\n cursor: pointer;\n transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n transform: rotate(${g}deg);\n position: relative;\n overflow: visible;\n animation: announceCardFadeIn 0.5s ease-out ${.12*t}s both;\n clip-path: ${I};\n filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));\n `;const S=Mc(l),M=Mc(l,.65);return o.innerHTML=`\n ${u?`\n\n <div style="position: absolute; top: ${10*Math.random()-5}px; left: ${20*Math.random()+40}%; transform: translateX(-50%) rotate(${6*Math.random()-3}deg); width: 80px; height: 25px; background: rgba(255, 255, 255, ${i?"0.5":"0.15"}); opacity: 0.7; border-left: 1px solid rgba(0, 0, 0, 0.05); border-right: 1px solid rgba(0, 0, 0, 0.05); z-index: 1;"></div>\n `:""}\n\n ${x?`\n\n <div style="position: absolute; top: 8px; ${f}: 12px; width: 8px; height: 24px; border: 2px solid ${v}; border-radius: 8px 8px 4px 4px; transform: rotate(${20*Math.random()-10}deg); opacity: 0.8; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);"></div>\n `:""}\n\n ${y?`\n\n <div style="position: absolute; top: 0; left: ${w}; width: 1px; height: 100%; background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.06) 20%, rgba(0, 0, 0, 0.06) 80%, transparent); transform: rotate(${k}); pointer-events: none;"></div>\n `:""}\n\n <div style="position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(0,0,0,0.015) 1px, rgba(0,0,0,0.015) 2px), repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.015) 1px, rgba(0,0,0,0.015) 2px); pointer-events: none; opacity: 0.6;"></div>\n\n <div style="position: relative; z-index: 2; color: ${S}; font-size: 14px; line-height: 1.8; margin-bottom: 16px; word-wrap: break-word; white-space: pre-wrap; font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif; text-shadow: 0 1px 0 rgba(255, 255, 255, 0.1);">\n ${e.content}\n </div>\n\n <div style="position: relative; z-index: 2; display: flex; align-items: center; justify-content: space-between; margin-top: 16px; padding-top: 12px; border-top: 1px dashed ${c.border};">\n <div style="font-size: 11px; color: ${M}; font-style: italic; opacity: 0.8;">\n ${C}\n </div>\n <button onclick="event.stopPropagation(); deleteFanGroupAnnouncement('${e.id}')" style="background: rgba(0, 0, 0, 0.05); border: 1px solid ${c.border}; color: ${S}; cursor: pointer; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(0, 0, 0, 0.15)'; this.style.transform='scale(1.05)'" onmouseout="this.style.backgroundColor='rgba(0, 0, 0, 0.05)'; this.style.transform='scale(1)'">\n 🗑️\n </button>\n </div>\n `,o.addEventListener("mouseenter",()=>{o.style.transform=`rotate(${.5*parseFloat(g)}deg) translateY(-12px) scale(1.03)`,o.style.filter="drop-shadow(0 8px 16px rgba(0, 0, 0, 0.2))",o.style.zIndex="100"}),o.addEventListener("mouseleave",()=>{o.style.transform=`rotate(${g}deg) translateY(0) scale(1)`,o.style.filter="drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))",o.style.zIndex="auto"}),o}(e,t);o.appendChild(a)})}catch(n){console.error("❌ [群公告] 加载失败:",n),o.innerHTML='\n <div style="width: 100%; text-align: center; color: #ef4444; font-size: 14px; padding: 40px 20px; grid-column: 1 / -1;">\n ❌ 加载失败，请重试\n </div>\n '}}function Ic(n,e){const t=parseInt(n.replace("#",""),16),o=Math.round(2.55*e);return"#"+(16777216+65536*Math.max((t>>16)-o,0)+256*Math.max((t>>8&255)-o,0)+Math.max((255&t)-o,0)).toString(16).slice(1)}function Sc(n,e){const t=parseInt(n.replace("#",""),16),o=Math.round(2.55*e);return"#"+(16777216+65536*Math.min((t>>16)+o,255)+256*Math.min((t>>8&255)+o,255)+Math.min((255&t)+o,255)).toString(16).slice(1)}function Mc(n,e=1){const t=parseInt(n.replace("#",""),16);return(299*(t>>16&255)+587*(t>>8&255)+114*(255&t))/1e3>128?1===e?"#1f2937":`rgba(31, 41, 55, ${e})`:1===e?"#f9fafb":`rgba(249, 250, 251, ${e})`}if(n.closeStrangerMessageSettings=fc,n.toggleStrangerContact=async function(t){try{const o=e(),a=`messagesList_${vt||"main"}`,i=await o.xAccountProfiles.get(a);let r=i?.data||[];console.log("📝 [联系人] 当前私信列表数量:",r.length);const s=r.findIndex(n=>n.id===t),l=document.getElementById("contact-toggle"),c=l.querySelector(".toggle-switch"),d=l.querySelector(".toggle-circle");if(-1!==s){r.splice(s,1),console.log("📝 [联系人] 移除后私信列表数量:",r.length),c.style.backgroundColor="#333",d.style.left="2px";const n=`strangerSettings_${vt||"main"}_${t}`;await o.xAccountProfiles.delete(n);const e=document.getElementById("auto-message-toggle");if(e){const n=e.querySelector(".toggle-switch"),t=e.querySelector(".toggle-circle");n.style.backgroundColor="#333",t.style.left="2px",e.style.opacity="0.5",e.style.cursor="not-allowed",e.onclick=()=>mn("请先添加到联系人","warning")}mn("已从联系人移除","success")}else{const e=n.currentStrangerSettings.messageData,o={id:t,userName:e.user.name,userHandle:e.user.handle.replace("@",""),userAvatar:e.user.avatar,lastMessage:e.preview||"",timestamp:(new Date).toISOString(),unread:!1};r.unshift(o),console.log("📝 [联系人] 添加后私信列表数量:",r.length),c.style.backgroundColor="var(--x-accent)",d.style.left="22px";const a=document.getElementById("auto-message-toggle");a&&(a.style.opacity="1",a.style.cursor="pointer",a.onclick=()=>bc(t)),mn("已添加到联系人","success")}await o.xAccountProfiles.put({handle:a,name:"messagesList",data:r,updatedAt:(new Date).toISOString()}),console.log("✅ [联系人] 已保存到数据库，列表数量:",r.length),dc=r;const p=document.getElementById("x-messages-page");p&&"flex"===p.style.display&&await pc()}catch(n){console.error("切换联系人状态失败:",n),mn("操作失败","error")}},n.updateStrangerAvatar=async function(t){const o=document.getElementById("stranger-avatar-url-input");if(!o)return;const a=o.value.trim();if(a)try{const o=document.getElementById("stranger-avatar-preview");o&&(o.src=a);const i=document.getElementById("message-detail-top-avatar");i&&(i.src=a);const r=document.getElementById("message-detail-avatar");r&&(r.src=a);const s=e(),l=`strangerSettings_${vt||"main"}_${t}`,c=await s.xAccountProfiles.get(l)||{handle:l,id:l,messageId:t};c.customAvatar=a,c.updatedAt=(new Date).toISOString(),await s.xAccountProfiles.put(c);const d=dc.findIndex(n=>n.id===t);if(-1!==d){dc[d].userAvatar=a;const n=`messagesList_${vt||"main"}`;await s.xAccountProfiles.put({handle:n,name:"messagesList",data:dc,updatedAt:(new Date).toISOString()});const e=document.getElementById("x-messages-page");e&&("flex"===e.style.display?(await pc(),console.log("✅ [陌生人头像] 私信列表已立即刷新")):console.log("✅ [陌生人头像] 私信列表将在下次显示时自动刷新"))}n.currentStrangerSettings&&n.currentStrangerSettings.messageData&&(n.currentStrangerSettings.messageData.user.avatar=a),mn("头像已更新","success")}catch(n){console.error("更新头像失败:",n),mn("更新失败","error")}else mn("请输入头像链接","warning")},n.updateStrangerInterval=async function(n,t){try{const o=parseInt(t);if(isNaN(o)||o<10||o>3600)return void mn("时间间隔必须在10-3600秒之间","warning");const a=e(),i=`strangerSettings_${vt||"main"}_${n}`,r=await a.xAccountProfiles.get(i)||{handle:i,id:i,messageId:n};r.autoMessageInterval=o,r.updatedAt=(new Date).toISOString(),await a.xAccountProfiles.put(r),mn(`已设置间隔为 ${o} 秒`,"success")}catch(n){console.error("更新时间间隔失败:",n),mn("更新失败","error")}},n.toggleStrangerAutoMessage=bc,n.loadMessagesList=pc,n.handleMessageDetailAvatarClick=function(){if(console.log("🖱️ [头像点击] 触发头像点击事件"),!Al)return void console.warn("⚠️ [头像点击] currentMessageConversation 为空");console.log("🖱️ [头像点击] 当前对话类型:",Al.type,Al.id);if("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_"))return console.log("🖱️ [头像点击] 检测到粉丝群，打开设置"),void vc(Al);if(Al.id&&Al.id.startsWith("msg_")&&"msg_001"!==Al.id)return void console.log("🖱️ [头像点击] 角色对话不支持设置");console.log("🖱️ [头像点击] 打开联系人设置，类型:",Al._accountType||"stranger");hc({id:Al.id,user:{name:Al.userName||Al.name,handle:Al.userHandle||Al.handle,avatar:Al.userAvatar||Al.avatar},preview:Al.lastMessage||"",_accountType:Al._accountType||"stranger"},null)},n.removeFanGroupQuote=function(){console.log("🗑️ [粉丝群转发] 移除引用"),n.currentQuoteFanGroup=null;const e=document.getElementById("compose-fangroup-quote-section");e&&(e.remove(),console.log("✅ [粉丝群转发] 引用区域已移除")),mn("已移除粉丝群引用","info")},n.kickFanGroupMember=async function(t,o,a){console.log("🚫 [粉丝群] 踢出成员",t,o,a);try{if(!confirm(`确定要将 ${a} 踢出粉丝群吗？`))return;const i=e(),r=`messagesList_${vt||"main"}`,s=await i.xAccountProfiles.get(r);let l=s?.data||[];const c=l.findIndex(n=>n.id===t);if(-1===c)return void mn("未找到粉丝群数据","error");const d=l[c];d.members||(d.members=[]);const p=d.members.findIndex(n=>n.id===o);if(-1===p)return void mn("未找到该成员","error");d.members.splice(p,1),d.memberCount=d.members.length,await i.xAccountProfiles.put({handle:r,name:"messagesList",data:l,updatedAt:(new Date).toISOString()}),console.log("✅ [粉丝群] 成员已移除，当前成员数:",d.memberCount);const g=`messageConversation_${vt||"main"}_${t}`,m=await i.xAccountProfiles.get(g);if(m&&m.data&&m.data.messages){const e={type:"system",systemType:"memberKicked",content:`${a} 被移出了粉丝群`,timestamp:(new Date).toISOString(),time:"刚刚"};m.data.messages.push(e),await i.xAccountProfiles.put(m),console.log("✅ [粉丝群] 已添加踢出系统通知"),Al&&Al.id===t&&await n.openMessageDetail(d)}mn("已将成员移出粉丝群","success"),yc(),setTimeout(()=>{vc(d)},300)}catch(n){console.error("❌ [粉丝群] 踢出成员失败:",n),mn("操作失败: "+n.message,"error")}},n.dissolveFanGroup=async function(n){console.log("💥 [粉丝群] 解散群聊",n);try{if(!confirm("确定要解散此粉丝群吗？\n\n解散后将删除所有成员、申请记录和聊天记录，此操作不可撤销！"))return;const t=e(),o=`messagesList_${vt||"main"}`,a=await t.xAccountProfiles.get(o);let i=a?.data||[];const r=i.findIndex(e=>e.id===n);if(-1===r)return void mn("未找到粉丝群数据","error");const s=i[r].userName||i[r].groupName;i.splice(r,1),await t.xAccountProfiles.put({handle:o,name:"messagesList",data:i,updatedAt:(new Date).toISOString()}),dc=i,console.log("✅ [粉丝群] 已从私信列表中删除");const l=`fanGroupApplications_${vt||"main"}_${n}`;try{await t.xAccountProfiles.delete(l),console.log("✅ [粉丝群] 已删除申请数据")}catch(n){console.warn("⚠️ [粉丝群] 删除申请数据时出错（可能不存在）:",n)}const c=`messageConversation_${vt||"main"}_${n}`;try{await t.xAccountProfiles.delete(c),console.log("✅ [粉丝群] 已删除聊天记录")}catch(n){console.warn("⚠️ [粉丝群] 删除聊天记录时出错（可能不存在）:",n)}if(yc(),closeFanGroupApplicationsModal(),Al&&Al.id===n){Al=null;const n=document.getElementById("message-detail-view");n&&(n.style.display="none")}await pc(),mn(`已解散粉丝群"${s}"`,"success")}catch(n){console.error("❌ [粉丝群] 解散失败:",n),mn("解散失败: "+n.message,"error")}},n.closeFanGroupContactSelectModal=function(){const e=document.getElementById("fangroup-contact-select-modal");e&&e.remove(),n.selectedFanGroupContacts=new Set},n.toggleContactSelection=function(e){n.selectedFanGroupContacts||(n.selectedFanGroupContacts=new Set);const t=document.querySelector(`.fangroup-contact-item[data-contact-id="${e}"]`),o=t?.querySelector(".contact-checkbox");if(!t||!o)return;n.selectedFanGroupContacts.has(e)?(n.selectedFanGroupContacts.delete(e),t.classList.remove("selected"),o.style.backgroundColor="var(--x-bg-primary)",o.style.borderColor="var(--x-border-color)",o.innerHTML=""):(n.selectedFanGroupContacts.add(e),t.classList.add("selected"),o.style.backgroundColor="var(--x-accent)",o.style.borderColor="var(--x-accent)",o.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #fff;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></g>\n </svg>\n ');const a=document.getElementById("fangroup-contact-confirm-btn");if(a){const e=n.selectedFanGroupContacts.size;a.textContent=`转发 (${e})`,e>0?(a.disabled=!1,a.style.opacity="1"):(a.disabled=!0,a.style.opacity="0.5")}},n.confirmFanGroupContactShare=async function(t){if(n.selectedFanGroupContacts&&0!==n.selectedFanGroupContacts.size)try{const o=e(),a=`messagesList_${vt||"main"}`,i=await o.xAccountProfiles.get(a),r=i?.data||[],s=r.find(n=>n.id===t);if(!s)return void mn("未找到粉丝群数据","error");console.log(`📤 [粉丝群转发] 开始转发到 ${n.selectedFanGroupContacts.size} 个联系人`);const l={type:"quoteFanGroup",fanGroup:{id:s.id,name:s.userName||s.groupName||"我的粉丝群",avatar:s.userAvatar||s.groupAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",memberCount:s.memberCount||0,threshold:s.groupThreshold||""},timestamp:(new Date).toISOString(),time:"刚刚",isOwn:!0};let c=0;for(const e of n.selectedFanGroupContacts)try{const n=`messageConversation_${vt||"main"}_${e}`,t=await o.xAccountProfiles.get(n);t&&t.data?(t.data.messages||(t.data.messages=[]),t.data.messages.push(l),await o.xAccountProfiles.put(t)):await o.xAccountProfiles.put({handle:n,name:"messageConversation",data:{messages:[l]},messageId:e,accountId:vt||"main",updatedAt:(new Date).toISOString()});const a=r.find(n=>n.id===e);a&&(a.lastMessage=`[粉丝群] ${s.userName||s.groupName||"我的粉丝群"}`,a.timestamp=(new Date).toISOString(),a.unread=!1),c++,console.log(`✅ [粉丝群转发] 已转发到联系人: ${e}`)}catch(n){console.error(`❌ [粉丝群转发] 转发到联系人 ${e} 失败:`,n)}await o.xAccountProfiles.put({handle:a,name:"messagesList",data:r,updatedAt:(new Date).toISOString()}),await pc(),closeFanGroupContactSelectModal(),yc(),mn(`已转发到 ${c} 个联系人`,"success"),console.log(`✅ [粉丝群转发] 转发完成，成功 ${c}/${n.selectedFanGroupContacts.size}`)}catch(n){console.error("❌ [粉丝群转发] 确认转发失败:",n),mn("转发失败: "+n.message,"error")}else mn("请至少选择一个联系人","warning")},n.triggerFanGroupAutoReaction=async function(){if(console.log("🎭 [粉丝群自反应] 开始触发"),!Al)return void mn("会话数据丢失","error");if(!("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_")))return void mn("只有粉丝群支持自反应功能","info");const n=Al,t=document.getElementById("fangroup-auto-reaction-btn"),o=document.getElementById("message-send-btn");t&&(t.disabled=!0,t.style.opacity="0.5"),o&&(o.disabled=!0,o.style.opacity="0.5");try{console.log("📤 [粉丝群自反应] 显示输入气泡"),Ll(),mn("群成员正在交流中...","info"),console.log("📤 [粉丝群自反应] 调用第11个情景生成器");const t=await kc(n,!0,{isAutoReaction:!0});if(console.log(`📤 [粉丝群自反应] AI返回了 ${t?t.length:0} 条消息`),Pl(),!t||0===t.length)return void mn("群成员暂时没有发言","info");const o=e(),a=`messageConversation_${vt||"main"}_${n.id}`,i=await o.xAccountProfiles.get(a);let r=[];i&&i.data&&i.data.messages&&(r=i.data.messages),r.push(...t),await o.xAccountProfiles.put({handle:a,name:"conversation",data:{messages:r},updatedAt:(new Date).toISOString()}),console.log("📤 [粉丝群自反应] 消息已保存到数据库");const s=`messagesList_${vt||"main"}`,l=await o.xAccountProfiles.get(s);if(l&&l.data){const e=l.data.findIndex(e=>e.id===n.id);if(-1!==e){const n=t[t.length-1],a=n.content||n.voiceText||n.imageDescription||"[消息]";l.data[e].lastMessage=`${n.senderName}: ${a}`,l.data[e].timestamp=(new Date).toISOString(),await o.xAccountProfiles.put(l),console.log("📤 [粉丝群自反应] 私信列表预览已更新")}}const c=document.getElementById("message-detail-content");if(c){const n=[];t.forEach((e,o)=>{const a=Bl(e,!1,r.length-t.length+o,!0,!0);c.appendChild(a),n.push(a)}),await Dl(n,300)}mn(`群内产生了 ${t.length} 条新对话`,"success")}catch(n){console.error("❌ [粉丝群自反应] 生成失败:",n),Pl(),mn("生成失败: "+n.message,"error")}finally{t&&(t.disabled=!1,t.style.opacity="1"),o&&(o.disabled=!1,o.style.opacity="1")}},n.openFanGroupAnnouncementModal=async function(){if(Al&&("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_"))){console.log("📢 [群公告] 打开群公告弹窗",Al.id);try{const n=document.getElementById("fangroup-announcement-modal");n&&(n.style.display="flex"),await Cc()}catch(n){console.error("❌ [群公告] 打开弹窗失败:",n),mn("打开失败: "+n.message,"error")}}else mn("当前不是粉丝群聊天","error")},n.closeFanGroupAnnouncementModal=function(){const n=document.getElementById("fangroup-announcement-modal");n&&(n.style.display="none")},n.openCreateAnnouncementDialog=function(){const n=document.getElementById("create-announcement-dialog"),e=document.getElementById("announcement-content-input"),t=document.getElementById("mention-all-checkbox"),o=document.getElementById("announcement-counter");n&&(n.style.display="flex"),e&&(e.value=""),t&&(t.checked=!1),o&&(o.textContent="0 / 500")},n.closeCreateAnnouncementDialog=function(){const n=document.getElementById("create-announcement-dialog");n&&(n.style.display="none")},n.updateAnnouncementCounter=function(){const n=document.getElementById("announcement-content-input"),e=document.getElementById("announcement-counter");if(n&&e){const t=n.value.length;e.textContent=`${t} / 500`}},!document.getElementById("announcement-card-animation-style")){const n=document.createElement("style");n.id="announcement-card-animation-style",n.textContent="\n @keyframes announceCardFadeIn {\n 0% {\n opacity: 0;\n transform: translateY(-40px) translateX(-20px) rotate(-5deg) scale(0.9);\n filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0));\n }\n 60% {\n opacity: 1;\n transform: translateY(5px) translateX(2px) rotate(2deg) scale(1.02);\n }\n 100% {\n opacity: 1;\n transform: translateY(0) translateX(0) rotate(var(--rotation, 0deg)) scale(1);\n filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));\n }\n }\n\n /* 移动端优化 */\n @media (max-width: 640px) {\n #fangroup-announcements-container {\n padding: 16px 12px !important;\n gap: 20px 12px !important;\n }\n }\n ",document.head.appendChild(n)}n.saveFanGroupAnnouncement=async function(){if(!(Al&&("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_"))))return void mn("当前不是粉丝群聊天","error");const t=document.getElementById("announcement-content-input"),o=document.getElementById("mention-all-checkbox"),a=t?.value?.trim();if(!a)return void mn("请输入公告内容","warning");const i=Al.id,r=o?.checked||!1;console.log("📢 [群公告] 保存新公告",{groupId:i,content:a,shouldMentionAll:r});try{const t=e(),o=`fanGroupAnnouncements_${vt||"main"}_${i}`,s=await t.xAccountProfiles.get(o),l=s?.data||[],c={id:`announcement_${Date.now()}`,groupId:i,content:a,createdAt:(new Date).toISOString(),createdBy:"admin"};l.unshift(c),await t.xAccountProfiles.put({handle:o,name:"fanGroupAnnouncements",data:l,updatedAt:(new Date).toISOString()}),console.log("✅ [群公告] 公告已保存");const d=`messageConversation_${vt||"main"}_${i}`,p=await t.xAccountProfiles.get(d);if(p&&p.data&&p.data.messages){const n={type:"system",systemType:"announcement",content:`📢 群主发布了新公告：${a}`,timestamp:(new Date).toISOString(),time:"刚刚"};if(p.data.messages.push(n),await t.xAccountProfiles.put(p),console.log("✅ [群公告] 已添加系统通知"),Al&&Al.id===i){const e=document.getElementById("message-detail-content");if(e){const t=Bl(n,!1,p.data.messages.length-1,!0);e.appendChild(t);const o=document.getElementById("message-detail-scrollable");o&&(o.scrollTop=o.scrollHeight)}}}closeCreateAnnouncementDialog(),await Cc(),mn("公告发布成功","success"),r&&(console.log("📢 [群公告] @全员，触发AI反应"),closeFanGroupAnnouncementModal(),setTimeout(async()=>{try{await n.triggerFanGroupAutoReaction(),mn("已通知所有成员","success")}catch(n){console.error("❌ [群公告] 触发AI反应失败:",n),mn("通知失败: "+n.message,"error")}},500))}catch(n){console.error("❌ [群公告] 保存失败:",n),mn("保存失败: "+n.message,"error")}},n.deleteFanGroupAnnouncement=async function(n){if(!(Al&&("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_"))))return;if(!confirm("确定要删除这条公告吗？"))return;const t=Al.id;console.log("🗑️ [群公告] 删除公告",{groupId:t,announcementId:n});try{const o=e(),a=`fanGroupAnnouncements_${vt||"main"}_${t}`,i=await o.xAccountProfiles.get(a);let r=i?.data||[];r=r.filter(e=>e.id!==n),await o.xAccountProfiles.put({handle:a,name:"fanGroupAnnouncements",data:r,updatedAt:(new Date).toISOString()}),console.log("✅ [群公告] 公告已删除"),await Cc(),mn("公告已删除","success")}catch(n){console.error("❌ [群公告] 删除失败:",n),mn("删除失败: "+n.message,"error")}};let Tc=null;async function Ac(){const n=Al.id,t=document.getElementById("fangroup-files-container"),o=document.getElementById("fangroup-files-back-btn"),a=document.getElementById("fangroup-files-header-title");if(t)try{const i=e(),r=`fanGroupFolders_${vt||"main"}_${n}`,s=await i.xAccountProfiles.get(r),l=s?.data||[],c=`fanGroupFiles_${vt||"main"}_${n}`,d=await i.xAccountProfiles.get(c),p=d?.data||[];let g=[],m=[];Tc?(g=p.filter(n=>n.folderId===Tc.id),o.style.display="flex",a.textContent=Tc.name):(m=l,g=p.filter(n=>!n.folderId),o.style.display="none",a.textContent="群文件"),t.innerHTML="",m.forEach(n=>{t.appendChild(function(n,e){const t=e.filter(e=>e.folderId===n.id),o=t.length,a=document.createElement("div");return a.style.cssText="\n position: relative;\n width: 100%;\n cursor: pointer;\n transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;\n margin-bottom: 6px;\n ",a.innerHTML=`\n <div style="\n position: relative;\n padding-bottom: 100%;\n width: 100%;\n ">\n <div style="\n position: absolute;\n top: 0;\n left: 0;\n right: 0;\n bottom: 0;\n ">\n \x3c!-- 文件夹整体容器 --\x3e\n <div style="\n position: relative;\n width: 100%;\n height: 100%;\n ">\n \x3c!-- 主文件夹 --\x3e\n <div style="\n position: absolute;\n top: 20%;\n left: 0;\n width: 100%;\n height: 80%;\n background: #222222;\n border-radius: 8px;\n box-shadow: 0 4px 10px rgba(0,0,0,0.25);\n z-index: 1;\n ">\n \x3c!-- 文件夹内部纹理 --\x3e\n <div style="\n position: absolute;\n top: 0;\n left: 0;\n width: 100%;\n height: 100%;\n border-radius: 8px;\n background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);\n opacity: 0.5;\n "></div>\n\n \x3c!-- 文件夹图标 --\x3e\n <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="\n position: absolute;\n left: 50%;\n top: 50%;\n transform: translate(-50%, -50%);\n width: 22px;\n height: 22px;\n fill: none;\n stroke: rgba(255,255,255,0.5);\n stroke-width: 1.5;\n stroke-linecap: round;\n stroke-linejoin: round;\n ">\n <path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n </svg>\n </div>\n\n \x3c!-- 堆叠文档1 - 最下层 --\x3e\n <div style="\n position: absolute;\n top: 10%;\n left: 8%;\n width: 84%;\n height: 25%;\n background: #fafafa;\n border-radius: 4px 4px 0 0;\n transform: rotate(-3deg);\n z-index: 2;\n box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n overflow: hidden;\n ">\n \x3c!-- 文档内容线条 --\x3e\n <div style="\n position: absolute;\n top: 30%;\n left: 10%;\n width: 80%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 50%;\n left: 10%;\n width: 60%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 70%;\n left: 10%;\n width: 70%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n </div>\n\n \x3c!-- 堆叠文档2 - 中层 --\x3e\n <div style="\n position: absolute;\n top: 5%;\n left: 10%;\n width: 80%;\n height: 25%;\n background: #f5f5f5;\n border-radius: 4px 4px 0 0;\n z-index: 3;\n box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n overflow: hidden;\n ">\n \x3c!-- 文档内容线条 --\x3e\n <div style="\n position: absolute;\n top: 30%;\n left: 10%;\n width: 80%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 50%;\n left: 10%;\n width: 70%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 70%;\n left: 10%;\n width: 60%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n </div>\n\n \x3c!-- 堆叠文档3 - 顶层 --\x3e\n <div style="\n position: absolute;\n top: 2%;\n left: 13%;\n width: 74%;\n height: 25%;\n background: white;\n border-radius: 4px 4px 0 0;\n transform: rotate(2deg);\n z-index: 4;\n box-shadow: 0 1px 4px rgba(0,0,0,0.1);\n overflow: hidden;\n ">\n \x3c!-- 文档内容线条 --\x3e\n <div style="\n position: absolute;\n top: 30%;\n left: 10%;\n width: 75%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 50%;\n left: 10%;\n width: 55%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n <div style="\n position: absolute;\n top: 70%;\n left: 10%;\n width: 65%;\n height: 2px;\n background-color: rgba(0,0,0,0.06);\n "></div>\n </div>\n\n \x3c!-- 删除按钮 --\x3e\n <div onclick="deleteFanGroupFolder('${n.id}'); event.stopPropagation();" style="\n position: absolute;\n top: 0;\n right: 0;\n width: 18px;\n height: 18px;\n border-radius: 50%;\n background-color: rgba(0,0,0,0.4);\n display: flex;\n align-items: center;\n justify-content: center;\n cursor: pointer;\n opacity: 0;\n transition: opacity 0.2s, background-color 0.2s;\n z-index: 5;\n " onmouseover="this.style.backgroundColor='rgba(200,50,50,0.9)'; this.style.opacity='1';"\n onmouseout="this.style.backgroundColor='rgba(0,0,0,0.4)'; this.style.opacity='0';">\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: white;">\n <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n </svg>\n </div>\n </div>\n </div>\n </div>\n\n \x3c!-- 文件夹名称 --\x3e\n <div style="\n text-align: center;\n margin-top: 2px;\n padding: 0 2px;\n ">\n <div style="\n color: var(--x-text-primary);\n font-size: 11px;\n font-weight: 500;\n overflow: hidden;\n text-overflow: ellipsis;\n white-space: nowrap;\n ">${n.name}</div>\n <div style="\n color: var(--x-text-secondary);\n font-size: 9px;\n margin-top: 1px;\n ">${o}个文件</div>\n </div>\n `,a.onmouseenter=()=>{a.style.transform="translateY(-5px)",a.style.filter="brightness(1.1)",a.style.boxShadow="0 5px 15px rgba(0,0,0,0.2)"},a.onmouseleave=()=>{a.style.transform="translateY(0)",a.style.filter="brightness(1)",a.style.boxShadow="none"},a.onclick=()=>function(n){console.log("📂 [群文件] 打开文件夹:",n.name),Tc=n,Ac()}(n),a}(n,p))}),g.forEach(n=>{t.appendChild(function(n){const e=document.createElement("div");e.style.cssText="\n position: relative;\n width: 100%;\n cursor: pointer;\n transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;\n margin-bottom: 6px;\n ";const t=Ec(n.type),o={text:"#2b303b",image:"#2e3440",video:"#262b36",link:"#272c36",default:"#252933"},a=o[n.type]||o.default,i=Lc?`\n <div id="file-checkbox-${n.id}" onclick="toggleFileSelection('${n.id}'); event.stopPropagation();" style="\n position: absolute;\n top: 6px;\n left: 6px;\n width: 16px;\n height: 16px;\n border-radius: 3px;\n border: 1px solid rgba(255,255,255,0.7);\n background-color: transparent;\n display: flex;\n align-items: center;\n justify-content: center;\n z-index: 10;\n transition: all 0.2s;\n "></div>\n `:"";e.innerHTML=`\n <div style="\n position: relative;\n padding-bottom: 100%;\n width: 100%;\n ">\n <div style="\n position: absolute;\n top: 0;\n left: 0;\n right: 0;\n bottom: 0;\n ">\n \x3c!-- 文件卡片主体 --\x3e\n <div style="\n position: relative;\n width: 100%;\n height: 100%;\n border-radius: 8px;\n background-color: ${a};\n box-shadow: 0 2px 6px rgba(0,0,0,0.15);\n overflow: hidden;\n ">\n \x3c!-- 背景纹理效果 --\x3e\n <div style="\n position: absolute;\n top: 0;\n left: 0;\n width: 100%;\n height: 100%;\n background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0) 70%);\n "></div>\n\n \x3c!-- 文件类型角标 --\x3e\n <div style="\n position: absolute;\n top: 0;\n right: 0;\n width: 0;\n height: 0;\n border-style: solid;\n border-width: 0 20px 20px 0;\n border-color: transparent rgba(255,255,255,0.1) transparent transparent;\n "></div>\n\n \x3c!-- 文件图标 --\x3e\n <div style="\n position: absolute;\n left: 50%;\n top: 50%;\n transform: translate(-50%, -50%);\n width: 34%;\n height: 34%;\n display: flex;\n align-items: center;\n justify-content: center;\n opacity: 0.85;\n ">\n ${t.replace("currentColor","rgba(255,255,255,0.7)")}\n </div>\n\n ${i}\n\n \x3c!-- 删除按钮 - 非批量模式下显示 --\x3e\n ${Lc?"":`\n <div onclick="deleteFanGroupFile('${n.id}'); event.stopPropagation();" style="\n position: absolute;\n top: 4px;\n right: 4px;\n width: 18px;\n height: 18px;\n border-radius: 50%;\n background-color: rgba(0,0,0,0.3);\n display: flex;\n align-items: center;\n justify-content: center;\n cursor: pointer;\n opacity: 0;\n transition: opacity 0.2s, background-color 0.2s;\n z-index: 2;\n " onmouseover="this.style.backgroundColor='rgba(200,50,50,0.9)'; this.style.opacity='1';"\n onmouseout="this.style.backgroundColor='rgba(0,0,0,0.3)'; this.style.opacity='0';">\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: white;">\n <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n </svg>\n </div>\n `}\n </div>\n </div>\n </div>\n\n \x3c!-- 文件名称 --\x3e\n <div style="\n text-align: center;\n margin-top: 2px;\n padding: 0 2px;\n ">\n <div style="\n color: var(--x-text-primary);\n font-size: 11px;\n font-weight: 500;\n overflow: hidden;\n text-overflow: ellipsis;\n white-space: nowrap;\n ">${n.name}</div>\n <div style="\n color: var(--x-text-secondary);\n font-size: 9px;\n margin-top: 1px;\n ">${n.uploadedBy}</div>\n </div>\n `,e.onmouseenter=()=>{e.style.transform="translateY(-5px)",e.style.filter="brightness(1.1)",e.style.boxShadow="0 5px 15px rgba(0,0,0,0.2)"},e.onmouseleave=()=>{e.style.transform="translateY(0)",e.style.filter="brightness(1)",e.style.boxShadow="none"},e.onclick=()=>{Lc?Dc(n.id):zc(n)},Lc&&Pc.has(n.id)&&setTimeout(()=>{Dc(n.id)},10);return e}(n))}),0===m.length&&0===g.length&&(t.innerHTML=`\n <div style="width: 100%; text-align: center; color:var(--x-text-secondary); font-size: 13px; padding: 30px 16px; grid-column: 1 / -1;">\n <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 28px; height: 28px; fill: none; stroke: var(--x-text-secondary); stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; margin: 0 auto 12px; display: block; opacity: 0.6;">\n <path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n ${Tc?'<path d="M9 13h6" />':""}\n </svg>\n ${Tc?"文件夹为空":"暂无文件，点击下方按钮创建文件夹或上传文件"}\n </div>\n `);const x=document.getElementById("fangroup-files-batch-btn");x&&(g.length>0&&!Lc?x.style.display="flex":x.style.display="none"),console.log(`✅ [群文件] 已加载 ${m.length} 个文件夹，${g.length} 个文件`)}catch(n){console.error("❌ [群文件] 加载失败:",n),mn("加载失败","error")}}function Ec(n){const e={text:'<svg viewBox="0 0 24 24" style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round">\n <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>\n <polyline points="14 2 14 8 20 8"></polyline>\n <line x1="16" y1="13" x2="8" y2="13"></line>\n <line x1="16" y1="17" x2="8" y2="17"></line>\n <polyline points="10 9 9 9 8 9"></polyline>\n </svg>',image:'<svg viewBox="0 0 24 24" style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round">\n <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>\n <circle cx="8.5" cy="8.5" r="1.5"></circle>\n <polyline points="21 15 16 10 5 21"></polyline>\n </svg>',video:'<svg viewBox="0 0 24 24" style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round">\n <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>\n <line x1="7" y1="2" x2="7" y2="22"></line>\n <line x1="17" y1="2" x2="17" y2="22"></line>\n <line x1="2" y1="12" x2="22" y2="12"></line>\n <line x1="2" y1="7" x2="7" y2="7"></line>\n <line x1="2" y1="17" x2="7" y2="17"></line>\n <line x1="17" y1="17" x2="22" y2="17"></line>\n <line x1="17" y1="7" x2="22" y2="7"></line>\n </svg>',link:'<svg viewBox="0 0 24 24" style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round">\n <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>\n <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>\n </svg>',default:'<svg viewBox="0 0 24 24" style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round">\n <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>\n <polyline points="13 2 13 9 20 9"></polyline>\n </svg>'};return e[n]||e.default}function zc(n){console.log("[群文件] 打开文件详情:",n.name);!function(){const n=document.getElementById("file-detail-modal");n&&n.remove();const e=document.createElement("div");e.id="file-detail-modal",e.style.cssText="\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground-color: rgba(0, 0, 0, 0.7);\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nz-index: 37;\nbackdrop-filter: blur(4px);\n",e.innerHTML='\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 12px 40px rgba(0,0,0,0.4);" onclick="event.stopPropagation()">\n<div style="padding: 20px 24px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between;">\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 20px; font-weight: 700;" id="file-detail-title">文件详情</h3>\n<button onclick="closeFileDetailModal()" style="background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n<g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n</svg>\n</button>\n</div>\n<div id="file-detail-content" style="padding: 24px;">\n</div>\n</div>\n',e.onclick=()=>closeFileDetailModal();const t=document.getElementById("x-social-screen");t?t.appendChild(e):document.body.appendChild(e)}();const e=document.getElementById("file-detail-title"),t=document.getElementById("file-detail-content");if(!e||!t)return;e.textContent=n.name;const o=Ec(n.type),a={text:"#3b4252",image:"#2e3440",video:"#434c5e",link:"#4c566a",default:"#3b4252"},i=a[n.type]||a.default,r=new Date(n.uploadedAt),s=`${r.getFullYear()}.${String(r.getMonth()+1).padStart(2,"0")}.${String(r.getDate()).padStart(2,"0")} ${String(r.getHours()).padStart(2,"0")}:${String(r.getMinutes()).padStart(2,"0")}`;t.innerHTML=`\n <div style="display: flex; flex-direction: column; gap: 14px;">\n \x3c!-- 文件信息头部 --\x3e\n <div style="display: flex; align-items: flex-start; gap: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--x-border-color);">\n \x3c!-- 文件图标 --\x3e\n <div style="\n width: 46px;\n height: 46px;\n border-radius: 6px;\n background-color: ${i};\n display: flex;\n align-items: center;\n justify-content: center;\n flex-shrink: 0;\n box-shadow: 0 3px 6px rgba(0,0,0,0.12);\n ">\n <div style="width: 22px; height: 22px; color: #fff;">\n ${o.replace("currentColor","#fff")}\n </div>\n </div>\n\n \x3c!-- 文件信息 --\x3e\n <div style="flex: 1; min-width: 0;">\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 3px; line-height: 1.3;">\n ${n.name}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 12px; margin-bottom: 4px;">\n 上传者：${n.uploadedBy}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 11px; display: flex; align-items: center; gap: 3px;">\n <svg viewBox="0 0 24 24" style="width: 11px; height: 11px; fill: var(--x-text-secondary);">\n <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"></path>\n </svg>\n <span>${s}</span>\n </div>\n </div>\n </div>\n\n \x3c!-- 文件内容 --\x3e\n <div>\n <div style="\n display: flex;\n justify-content: space-between;\n align-items: center;\n margin-bottom: 8px;\n ">\n <div style="color:var(--x-text-primary); font-size: 13px; font-weight: 600;">文件内容</div>\n <div style="\n color: var(--x-text-secondary);\n font-size: 11px;\n padding: 1px 6px;\n border: 1px solid var(--x-border-color);\n border-radius: 10px;\n ">\n ${"text"===n.type?"文本文档":"image"===n.type?"图片文件":"video"===n.type?"视频文件":"link"===n.type?"链接":"文件"}\n </div>\n </div>\n\n <div style="\n padding: 12px;\n background-color:var(--x-bg-secondary);\n border-radius: 6px;\n color:var(--x-text-primary);\n font-size: 13px;\n line-height: 1.5;\n max-height: 250px;\n overflow-y: auto;\n white-space: pre-wrap;\n word-wrap: break-word;\n border: 1px solid var(--x-border-color);\n ">${n.content}</div>\n </div>\n\n \x3c!-- 操作按钮 --\x3e\n <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 2px;">\n <button onclick="deleteFanGroupFile('${n.id}'); closeFileDetailModal();" style="\n padding: 6px 12px;\n border-radius: 12px;\n border: none;\n background-color: rgba(0,0,0,0.12);\n color: #ff5252;\n font-size: 12px;\n font-weight: 500;\n cursor: pointer;\n transition: all 0.2s;\n " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.2)'"\n onmouseout="this.style.backgroundColor='rgba(0,0,0,0.12)'">\n 删除文件\n </button>\n </div>\n </div>\n `}async function Bc(n){try{const t=e(),o=`fanGroupFiles_${vt||"main"}_${n}`,a=`fanGroupFolders_${vt||"main"}_${n}`,i=await t.xAccountProfiles.get(o),r=i?.data||[],s=await t.xAccountProfiles.get(a),l=s?.data||[];return r.map(n=>{if(n.folderId){const e=l.find(e=>e.id===n.folderId);if(e)return{...n,folderName:e.name}}return{...n,folderName:"未分类"}})}catch(n){return console.error("[群文件] 获取文件列表失败:",n),[]}}n.openFanGroupFilesModal=async function(){if(!(Al&&("fangroup"===Al.type||Al.id&&Al.id.startsWith("fangroup_"))))return void mn("当前不是粉丝群聊天","error");console.log("📁 [群文件] 打开群文件弹窗");!function(){const n=document.getElementById("fangroup-files-modal");n&&n.remove();const e=document.createElement("div");e.id="fangroup-files-modal",e.style.cssText="\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground-color: rgba(0, 0, 0, 0.7);\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nz-index: 35;\nbackdrop-filter: blur(10px);\npadding: 0 8px;\nbox-sizing: border-box;\n",e.innerHTML='\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 100%; max-width: 800px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden;" onclick="event.stopPropagation()">\n<div style="padding: 16px; border-bottom: 1px solid var(--x-border-color); flex-shrink: 0;">\n<div style="display: flex; align-items: center; justify-content: space-between;">\n<div style="display: flex; align-items: center; gap: 10px;">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 22px; height: 22px; fill: none; stroke: var(--x-accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n</svg>\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 18px; font-weight: 700;" id="fangroup-files-header-title">群文件</h3>\n</div>\n<button onclick="closeFanGroupFilesModal()" style="background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 6px; border-radius: 50%; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'transparent\'">\n<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n<g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n</svg>\n</button>\n</div>\n</div>\n<div id="fangroup-files-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; align-content: flex-start; justify-content: center; min-height: 200px; background-color: var(--x-bg-secondary);">\n<div style="width: 100%; text-align: center; color:var(--x-text-secondary); font-size: 13px; padding: 30px 16px; grid-column: 1 / -1;">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: none; stroke: var(--x-text-secondary); stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; margin: 0 auto 12px; display: block; opacity: 0.7;">\n<path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n</svg>\n暂无文件，点击下方按钮创建文件夹或上传文件\n</div>\n</div>\n<div style="padding: 12px 16px; border-top: 1px solid var(--x-border-color); flex-shrink: 0; display: flex; gap: 8px; flex-wrap: wrap;">\n<div style="display: flex; gap: 8px; flex: 1;">\n<button id="fangroup-files-back-btn" onclick="backToFilesList()" style="display: none; background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 18px; padding: 8px 16px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: currentColor; margin-right: 4px; vertical-align: text-bottom;">\n<path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path>\n</svg>\n返回\n</button>\n<button id="fangroup-files-batch-btn" onclick="toggleBatchMode()" style="display: none; background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: 1px solid var(--x-border-color); border-radius: 18px; padding: 8px 12px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n批量管理\n</button>\n<button id="fangroup-files-cancel-batch-btn" onclick="toggleBatchMode()" style="display: none; background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 18px; padding: 8px 12px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n取消\n</button>\n<button id="fangroup-files-delete-batch-btn" onclick="batchDeleteFiles()" style="display: none; background-color: rgba(220, 38, 38, 0.9); color: #fff; border: none; border-radius: 18px; padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.opacity=\'0.9\'" onmouseout="this.style.opacity=\'1\'">\n删除选中 (0)\n</button>\n</div>\n<div style="display: flex; gap: 8px; flex-wrap: nowrap;">\n<button id="fangroup-files-create-folder-btn" onclick="openCreateFolderDialog()" style="background-color: var(--x-bg-secondary); color: var(--x-text-primary); border: 1px solid var(--x-border-color); border-radius: 18px; padding: 8px 12px; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px;" onmouseover="this.style.backgroundColor=\'var(--x-bg-hover)\'" onmouseout="this.style.backgroundColor=\'var(--x-bg-secondary)\'">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M5 4h4l3 3h7a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-11a2 2 0 0 1 2 -2" />\n</svg>\n<span>新建文件夹</span>\n</button>\n<button id="fangroup-files-upload-btn" onclick="openUploadFileDialog()" style="background-color: #2a2a2a; color: #fff; border: none; border-radius: 18px; padding: 8px 12px; font-size: 13px; font-weight: 500; white-space: nowrap; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 4px;" onmouseover="this.style.backgroundColor=\'#3a3a3a\'" onmouseout="this.style.backgroundColor=\'#2a2a2a\'">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">\n<path d="M12 5v10M7 9l5-5 5 5M19 15v4H5v-4"></path>\n</svg>\n<span>上传文件</span>\n</button>\n</div>\n</div>\n</div>\n',e.onclick=()=>closeFanGroupFilesModal();const t=document.getElementById("x-social-screen");t?t.appendChild(e):document.body.appendChild(e)}();Tc=null,await Ac()},n.closeFanGroupFilesModal=function(){const n=document.getElementById("fangroup-files-modal");n&&(n.remove(),Tc=null)},n.backToFilesList=function(){console.log("📁 [群文件] 返回文件列表"),Tc=null,Ac()},n.openCreateFolderDialog=function(){!function(){const n=document.getElementById("create-folder-dialog");n&&n.remove();const e=document.createElement("div");e.id="create-folder-dialog",e.style.cssText="\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground-color: rgba(0, 0, 0, 0.7);\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nz-index: 36;\nbackdrop-filter: blur(4px);\n",e.innerHTML='\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 450px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); overflow: hidden;" onclick="event.stopPropagation()">\n<div style="padding: 20px 24px; border-bottom: 1px solid var(--x-border-color);">\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 20px; font-weight: 700;">新建文件夹</h3>\n</div>\n<div style="padding: 24px;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n文件夹名称 <span style="color: #ef4444;">*</span>\n</label>\n<input type="text" id="folder-name-input" placeholder="例如：学习资料、项目文档..." maxlength="50" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'var(--x-border-color)\'">\n</div>\n<div style="padding: 16px 24px; border-top: 1px solid var(--x-border-color); display: flex; gap: 12px; justify-content: flex-end;">\n<button onclick="closeCreateFolderDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer;">取消</button>\n<button onclick="saveFanGroupFolder()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 24px; font-size: 14px; font-weight: 700; cursor: pointer;">创建</button>\n</div>\n</div>\n',e.onclick=()=>closeCreateFolderDialog();const t=document.getElementById("x-social-screen");t?t.appendChild(e):document.body.appendChild(e)}();const n=document.getElementById("folder-name-input");n&&(n.value="",setTimeout(()=>n.focus(),100))},n.closeCreateFolderDialog=function(){const n=document.getElementById("create-folder-dialog");n&&n.remove()},n.saveFanGroupFolder=async function(){const n=document.getElementById("folder-name-input"),t=n?.value?.trim();if(!t)return void mn("请输入文件夹名称","warning");const o=Al.id;try{const n=e(),a=`fanGroupFolders_${vt||"main"}_${o}`,i=await n.xAccountProfiles.get(a),r=i?.data||[],s={id:`folder_${Date.now()}`,name:t,createdAt:(new Date).toISOString()};r.push(s),await n.xAccountProfiles.put({handle:a,name:"fanGroupFolders",data:r,updatedAt:(new Date).toISOString()}),console.log("✅ [群文件] 文件夹已创建:",t),closeCreateFolderDialog(),await Ac(),mn("文件夹创建成功","success")}catch(n){console.error("❌ [群文件] 创建失败:",n),mn("创建失败","error")}},n.openUploadFileDialog=async function(){await async function(){const n=document.getElementById("upload-file-dialog");n&&n.remove();const e=document.createElement("div");e.id="upload-file-dialog",e.style.cssText="\nposition: fixed;\ntop: 0;\nleft: 0;\nwidth: 100vw;\nheight: 100vh;\nbackground-color: rgba(0, 0, 0, 0.7);\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nz-index: 36;\nbackdrop-filter: blur(4px);\n",e.innerHTML='\n<div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 12px 40px rgba(0,0,0,0.4);" onclick="event.stopPropagation()">\n<div style="padding: 20px 24px; border-bottom: 1px solid var(--x-border-color);">\n<h3 style="margin: 0; color:var(--x-text-primary); font-size: 20px; font-weight: 700;">上传文件</h3>\n</div>\n<div style="padding: 24px;">\n<div style="margin-bottom: 20px;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n文件名称 <span style="color: #ef4444;">*</span>\n</label>\n<input type="text" id="file-name-input" placeholder="例如：项目文档.pdf、教程视频.mp4..." maxlength="100" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'var(--x-border-color)\'">\n<div style="font-size: 12px; color:var(--x-text-secondary); margin-top: 4px;">提示：文件名需包含后缀（如 .pdf、.mp4、.jpg等）</div>\n</div>\n<div style="margin-bottom: 20px;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n文件类型 <span style="color: #ef4444;">*</span>\n</label>\n<select id="file-type-select" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; cursor: pointer;" onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'var(--x-border-color)\'">\n<option value="text">文字/文档</option>\n<option value="image">图片</option>\n<option value="video">视频</option>\n<option value="link">链接</option>\n</select>\n</div>\n<div style="margin-bottom: 20px;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n文件内容/链接 <span style="color: #ef4444;">*</span>\n</label>\n<textarea id="file-content-input" placeholder="输入文件内容、描述或链接地址..." maxlength="5000" style="width: 100%; min-height: 150px; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; resize: vertical; font-family: inherit; line-height: 1.6; transition: border-color 0.2s;" onfocus="this.style.borderColor=\'var(--x-accent)\'" onblur="this.style.borderColor=\'var(--x-border-color)\'" oninput="updateFileContentCounter()"></textarea>\n<div style="text-align: right; margin-top: 6px;">\n<span id="file-content-counter" style="font-size: 12px; color:var(--x-text-secondary);">0 / 5000</span>\n</div>\n</div>\n<div id="file-folder-select-container" style="margin-bottom: 20px; display: none;">\n<label style="display: block; font-size: 14px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 8px;">\n选择文件夹（可选）\n</label>\n<select id="file-folder-select" style="width: 100%; padding: 12px; background-color:var(--x-bg-secondary); border: 2px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); font-size: 14px; outline: none; cursor: pointer;">\n<option value="">不放入文件夹（散落显示）</option>\n</select>\n</div>\n</div>\n<div style="padding: 16px 24px; border-top: 1px solid var(--x-border-color); display: flex; gap: 12px; justify-content: flex-end;">\n<button onclick="closeUploadFileDialog()" style="background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer;">取消</button>\n<button onclick="saveFanGroupFile()" style="background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 24px; font-size: 14px; font-weight: 700; cursor: pointer;">上传</button>\n</div>\n</div>\n',e.onclick=()=>closeUploadFileDialog();const t=document.getElementById("x-social-screen");return t?t.appendChild(e):document.body.appendChild(e),e}();const n=document.getElementById("file-name-input"),t=document.getElementById("file-type-select"),o=document.getElementById("file-content-input"),a=document.getElementById("file-folder-select-container"),i=document.getElementById("file-folder-select");n&&(n.value=""),t&&(t.value="text"),o&&(o.value="");const r=Al.id,s=e(),l=`fanGroupFolders_${vt||"main"}_${r}`,c=await s.xAccountProfiles.get(l),d=c?.data||[];i&&(i.innerHTML='<option value="">不放入文件夹（散落显示）</option>',d.forEach(n=>{const e=document.createElement("option");e.value=n.id,e.textContent=n.name,Tc&&Tc.id===n.id&&(e.selected=!0),i.appendChild(e)})),a&&d.length>0&&(a.style.display="block"),setTimeout(()=>n?.focus(),100)},n.closeUploadFileDialog=function(){const n=document.getElementById("upload-file-dialog");n&&n.remove()},n.updateFileContentCounter=function(){const n=document.getElementById("file-content-input"),e=document.getElementById("file-content-counter");n&&e&&(e.textContent=`${n.value.length} / 5000`)},n.saveFanGroupFile=async function(){const t=document.getElementById("file-name-input"),o=document.getElementById("file-type-select"),a=document.getElementById("file-content-input"),i=document.getElementById("file-folder-select"),r=t?.value?.trim(),s=o?.value,l=a?.value?.trim(),c=i?.value||null;if(!r)return void mn("请输入文件名称","warning");if(!l)return void mn("请输入文件内容","warning");const d=Al.id,p=n.userProfileData?.name||"用户";try{const n=e(),t=`fanGroupFiles_${vt||"main"}_${d}`,o=await n.xAccountProfiles.get(t),a=o?.data||[],i={id:`file_${Date.now()}`,name:r,type:s,content:l,folderId:c,uploadedBy:p,uploadedAt:(new Date).toISOString()};a.push(i),await n.xAccountProfiles.put({handle:t,name:"fanGroupFiles",data:a,updatedAt:(new Date).toISOString()}),console.log("✅ [群文件] 文件已上传:",r),await async function(n,t){try{const o=e(),a=`messageConversation_${vt||"main"}_${n}`,i=await o.xAccountProfiles.get(a);if(i&&i.data&&i.data.messages){const e={type:"groupFile",file:{id:t.id,name:t.name,type:t.type,content:t.content,uploadedBy:t.uploadedBy,uploadedAt:t.uploadedAt,folderId:t.folderId||null},timestamp:(new Date).toISOString(),time:"刚刚",isOwn:!0};i.data.messages.push(e),await o.xAccountProfiles.put(i),console.log("[群文件] 文件消息已添加到对话");try{const e=`messagesList_${vt||"main"}`,t=await o.xAccountProfiles.get(e);if(t&&t.data){const e=t.data,a=e.findIndex(e=>e.id===n);if(-1!==a){const i=await Bc(n);e[a].files=i,await o.xAccountProfiles.put({...t,data:e}),console.log("[群文件] 已更新粉丝群文件数据，文件总数:",i.length)}}}catch(n){console.error("[群文件] 更新粉丝群文件列表失败:",n)}if(Al&&Al.id===n){const n=document.getElementById("message-detail-content");if(n){const t=Bl(e,!1,i.data.messages.length-1,!0);n.appendChild(t);const o=document.getElementById("message-detail-scrollable");o&&(o.scrollTop=o.scrollHeight)}}}}catch(n){console.error("[群文件] 添加文件消息失败:",n)}}(d,i),closeUploadFileDialog(),await Ac(),mn("文件上传成功","success")}catch(n){console.error("❌ [群文件] 上传失败:",n),mn("上传失败","error")}},n.closeFileDetailModal=function(){const n=document.getElementById("file-detail-modal");n&&n.remove()},n.deleteFanGroupFolder=async function(n){if(!confirm("确定要删除这个文件夹吗？文件夹内的文件将会散落显示。"))return;const t=Al.id;try{const o=e(),a=`fanGroupFolders_${vt||"main"}_${t}`,i=`fanGroupFiles_${vt||"main"}_${t}`,r=await o.xAccountProfiles.get(a);let s=r?.data||[];s=s.filter(e=>e.id!==n),await o.xAccountProfiles.put({handle:a,name:"fanGroupFolders",data:s,updatedAt:(new Date).toISOString()});const l=await o.xAccountProfiles.get(i);let c=l?.data||[];c.forEach(e=>{e.folderId===n&&(e.folderId=null)}),await o.xAccountProfiles.put({handle:i,name:"fanGroupFiles",data:c,updatedAt:(new Date).toISOString()}),console.log("✅ [群文件] 文件夹已删除"),await Ac(),mn("文件夹已删除","success")}catch(n){console.error("❌ [群文件] 删除失败:",n),mn("删除失败","error")}},n.deleteFanGroupFile=async function(n){if(!confirm("确定要删除这个文件吗？"))return;const t=Al.id;try{const o=e(),a=`fanGroupFiles_${vt||"main"}_${t}`,i=await o.xAccountProfiles.get(a);let r=i?.data||[];r=r.filter(e=>e.id!==n),await o.xAccountProfiles.put({handle:a,name:"fanGroupFiles",data:r,updatedAt:(new Date).toISOString()}),console.log("✅ [群文件] 文件已删除"),await Ac(),mn("文件已删除","success")}catch(n){console.error("❌ [群文件] 删除失败:",n),mn("删除失败","error")}};let Lc=!1,Pc=new Set;function Dc(n){Pc.has(n)?Pc.delete(n):Pc.add(n);const e=document.getElementById("fangroup-files-delete-batch-btn");e&&(e.textContent=`删除选中 (${Pc.size})`);const t=document.getElementById(`file-checkbox-${n}`);t&&(Pc.has(n)?(t.style.backgroundColor="rgba(255,255,255,0.9)",t.style.borderColor="rgba(255,255,255,0.9)",t.innerHTML='\n <svg viewBox="0 0 24 24" style="width: 10px; height: 10px; fill: #333;">\n <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path>\n </svg>\n '):(t.style.backgroundColor="transparent",t.style.borderColor="rgba(255,255,255,0.7)",t.innerHTML=""))}async function Nc(e){console.log("🎯 [粉丝群申请生成器] 开始生成申请",{tweetId:e.id,fanGroupId:e.quotedFanGroup.id,fanGroupName:e.quotedFanGroup.name});try{const{apiConfig:t,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r,boundCharacters:l}=o,c=`messagesList_${vt||"main"}`,p=await a.xAccountProfiles.get(c),m=(p?.data||[]).find(n=>n.id===e.quotedFanGroup.id);if(!m)return void mn("未找到粉丝群数据","error");const x=s.buildUserXProfileInfo(n.userProfileData),u=`userTweets_${vt||"main"}`,h=await a.xUserTweets.get(u),f=h?.tweets?.slice(0,3)||[];console.log("📋 [粉丝群申请生成器] 用户完整资料:",x),console.log("📋 [粉丝群申请生成器] 最近推文数量:",f.length);let b=0,v=s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});b=d.logTokenUsage("粉丝群申请生成器","基础系统提示词",v,b);const y=await s.getApplicableWorldBooks("fanGroupApplication",{boundCharacters:l});y&&(v+=y,b=d.logTokenUsage("粉丝群申请生成器","世界书内容",y,b));const w=m.groupThreshold&&/钱|价|元|￥|\$|费|付/.test(m.groupThreshold);v+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：粉丝群入群申请生成器 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的粉丝群申请生成器。用户 ${x.name} (${x.handle}) 发布了一条推文，转发了自己的粉丝群链接：\n**推文内容**：\n"${e.content}"\n**粉丝群信息**：\n- 群名：${m.userName||m.groupName}\n- 当前成员数：${m.memberCount||0}\n- 入群门槛：${m.groupThreshold||"无"}\n**用户X平台完整资料**：\n- 用户名：${x.name}\n- 用户句柄：${x.handle}\n- 认证状态：${x.verified?"已认证":"未认证"}\n${x.verificationType&&"none"!==x.verificationType?"- 认证类型："+("verified"===x.verificationType?"蓝色勾标认证":"couple"===x.verificationType?"情侣认证":"married"===x.verificationType?"已婚认证":"vip"===x.verificationType?"VIP认证":"无"):""}\n${x.publicIdentity?`- 公众身份：${x.publicIdentity}`:""}\n${x.bio?`- 个人简介：${x.bio}`:""}\n${"couple"===x.verificationType&&x.coupleCharacterName?`- 情侣关系：与${x.coupleCharacterName}为公开情侣`:""}\n- 影响力等级：${x.publicIdentity?"公众人物/有影响力":"普通用户"}\n${f.length>0?`**用户最近推文**（了解用户风格和影响力）：\n${f.map((n,e)=>`${e+1}. "${n.content}"\n- 发布时间：${n.time||"最近"}\n- 互动数据：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论，${n.stats?.views||0}浏览`).join("\n")}`:"**用户最近推文**：暂无推文（新用户或较少发帖）"}\n你的任务是生成 5-15个入群申请。\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 申请生成规则 📋\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**申请者类型分布**（必须多样化）：\n1. 真诚粉丝（60-70%）：\n- 真心喜欢用户，想加入粉丝群\n- 申请理由真诚、具体\n- 如果有门槛要求，会认真满足\n2. 普通路人（20-30%）：\n- 看到推文好奇想加入\n- 申请理由较简单\n- 可能不完全符合门槛要求\n3. 恶意/骚扰者（10-20%）：\n- 故意发送不当内容\n- 申请理由奇怪、无礼、或包含骚扰内容\n- 明显不符合门槛要求\n- 可能是为了恶作剧或骚扰\n**真实感要求**：\n- 申请理由要多样化，不要千篇一律\n- 恶意申请要自然，不要太过明显\n- 申请者姓名要真实感，不要太夸张\n${w?`\n**金钱门槛特殊处理**：\n⚠️ 检测到入群门槛与金钱相关："${m.groupThreshold}"\n- 70-80% 的申请者会附带金额\n- 金额范围：根据门槛要求决定（建议 $10-$100）\n- 申请理由中要提到支付意愿\n- 恶意申请者可能故意出价过低或过高来捣乱\n- 真诚粉丝会出合理的价格\n`:""}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📝 JSON返回格式 📝\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\`\`\`json\n{\n"applications": [\n{\n "applicantName": "申请者姓名",\n "applicantHandle": "@handle",\n "applicantAvatar": "https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",\n "reason": "申请理由（要具体、真实）",\n "type": "sincere/normal/malicious",\n "amount": 50.00\n}\n]\n}\n\`\`\`\n**字段说明**：\n- applicantName: 申请者X姓名（真实感）\n- applicantHandle: 申请者X句柄（格式：@username）\n- applicantAvatar: 统一使用默认头像\n- reason: 申请理由（20-80字，要真实、多样化）\n- type: 申请类型（sincere真诚/normal普通/malicious恶意）\n- amount: 附带金额（仅在有金钱门槛时需要，数字类型，保留两位小数）${w?"":"，无金钱门槛时设为0"}\n**重要规则**：\n1. 生成3-8个申请（根据用户影响力决定）\n2. 申请理由要多样化，不要重复\n3. 恶意申请要自然，不要太明显\n4. type字段必须准确反映申请意图\n5. 如果有金钱门槛，70-80%申请要带金额\n6. 金额合理性：真诚粉丝出价合理，恶意者可能出价异常`;const k=v.substring(v.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));b=d.logTokenUsage("粉丝群申请生成器","核心任务说明",k,b);const $=v.length;v+=s.buildUniversalConstraints(x);const C=v.substring($);b=d.logTokenUsage("粉丝群申请生成器","用户资料约束",C,b);const I=[{role:"user",content:"请生成粉丝群入群申请"}];d.logFinalPrompt("粉丝群申请生成器",v,I[0].content);const S=await g.sendAIRequest({apiConfig:t,systemPrompt:v,messages:I,temperature:.8});console.log("🎯 [粉丝群申请生成器] AI响应:",S);let M=g.parseJSONResponse(S);if(!M.applications||!Array.isArray(M.applications))throw new Error("AI返回的数据格式不正确");const T=Date.now();M.applications.forEach((n,e)=>{n.id=`fangroup_app_${T}_${e}`,n.timestamp=(new Date).toISOString(),n.status="pending"}),await Rc(m.id,M.applications),console.log(`✅ [粉丝群申请生成器] 成功生成${M.applications.length}个申请`),setTimeout(()=>{Rl({title:`${m.userName||m.groupName}`,message:`有 ${M.applications.length} 人申请加入粉丝群`,avatar:m.userAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",leftIcon:"custom",leftIconHtml:'\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: var(--x-accent);">\n <g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g>\n </svg>\n ',duration:5e3,onClick:()=>{jc(m.id)}})},1e3)}catch(n){console.error("❌ [粉丝群申请生成器] 生成失败:",n),mn("生成申请失败: "+n.message,"error")}}async function Rc(n,t){try{const o=e(),a=`fanGroupApplications_${vt||"main"}_${n}`;await o.xAccountProfiles.put({handle:a,name:"fanGroupApplications",data:t,updatedAt:(new Date).toISOString()}),console.log("✅ [粉丝群申请] 申请数据已保存到数据库")}catch(n){throw console.error("❌ [粉丝群申请] 保存申请失败:",n),n}}async function Hc(n){try{const t=e(),o=`fanGroupApplications_${vt||"main"}_${n}`,a=await t.xAccountProfiles.get(o);return a?.data||[]}catch(n){return console.error("❌ [粉丝群申请] 读取申请失败:",n),[]}}async function jc(n){console.log("📋 [粉丝群申请] 打开申请弹窗",n);try{const t=(await Hc(n)).filter(n=>"pending"===n.status);if(0===t.length)return void mn("暂无待处理的申请","info");const o=e(),a=`messagesList_${vt||"main"}`,i=await o.xAccountProfiles.get(a),r=(i?.data||[]).find(e=>e.id===n);if(!r)return void mn("未找到粉丝群数据","error");const s=document.getElementById("x-social-screen"),l=s&&s.classList.contains("x-theme-light"),c=document.createElement("div");c.id="fangroup-applications-modal",c.style.cssText=`\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: ${l?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; display: flex; align-items: center; justify-content: center; z-index: 100000; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); `,c.innerHTML=`\n <div style="background-color: ${l?"rgba(255, 255, 255, 0.95)":"rgba(0, 0, 0, 0.95)"}; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; width: 90%; max-width: 500px; max-height: 80vh; position: relative; overflow: hidden; box-shadow: ${l?"0 20px 60px rgba(0, 0, 0, 0.15)":"0 20px 60px rgba(0, 0, 0, 0.8)"}; border: 2px solid ${l?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; " onclick="event.stopPropagation()">\n\n <div style="background: linear-gradient(135deg, ${l?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.05)"} 0%, ${l?"rgba(0, 0, 0, 0.01)":"rgba(255, 255, 255, 0.02)"} 100%); padding: 24px; text-align: center; border-bottom: 1px dashed ${l?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.15)"}; position: relative; ">\n\n <div style="position: absolute; left: -10px; bottom: -10px; width: 20px; height: 20px; border-radius: 50%; background-color: ${l?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; "></div>\n <div style="position: absolute; right: -10px; bottom: -10px; width: 20px; height: 20px; border-radius: 50%; background-color: ${l?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; "></div>\n\n  <button onclick="refreshFanGroupApplications('${n}')" id="refresh-applications-btn" style="position: absolute; top: 16px; right: 56px; background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'" onmouseout="this.style.backgroundColor='transparent'" title="刷新申请">\n<svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: currentColor;">\n<g><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></g>\n</svg>\n</button>\n\n <button onclick="closeFanGroupApplicationsModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n\n <div style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin-bottom: 8px; ">入群申请</div>\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-bottom: 12px; ">${r.userName||r.groupName}</div>\n <div style="color: var(--x-accent); font-size: 12px; font-weight: 700; letter-spacing: 1px; ">${t.length} 人待审核</div>\n </div>\n\n <div id="applications-list-container" style="max-height: 50vh; overflow-y: auto; padding: 16px 24px; ">\n ${t.map((e,t)=>function(n,e,t,o=!1){const a={sincere:"#22c55e",normal:"#3b82f6",malicious:"#ef4444"}[n.type]||"#71767b",i={sincere:"真诚粉丝",normal:"普通申请",malicious:"可疑申请"}[n.type]||"未知";return`\n <div id="app-card-${n.id}" style="margin-bottom: 14px; background-color: ${o?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.04)"}; border: 1px solid ${o?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; border-radius: 12px; padding: 14px; position: relative; overflow: hidden; transition: all 0.2s; ">\n\n <div style="position: absolute; bottom: 8px; right: 8px; font-size: 28px; color: ${o?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.03)"}; font-weight: 700; pointer-events: none; transform: rotate(-15deg); ">#${e+1}</div>\n\n <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">\n <img src="${n.applicantAvatar}" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover; ">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 3px; flex-wrap: wrap;">\n <span style="color: ${o?"#0f1419":"#e7e9ea"}; font-size: 14px; font-weight: 700; ">${n.applicantName}</span>\n <span style="padding: 2px 7px; background-color: ${a}${o?"20":"18"}; color: ${a}; font-size: 10px; font-weight: 700; border-radius: 4px; border: 1px solid ${a}${o?"50":"35"}; ">${i}</span>\n </div>\n <div style="color: ${o?"#536471":"#8b98a5"}; font-size: 12px; ">${n.applicantHandle}</div>\n </div>\n ${n.amount>0?`<div style="padding: 5px 11px; background-color: #22c55e${o?"20":"18"}; color: #22c55e; font-size: 13px; font-weight: 700; border-radius: 7px; border: 1px solid #22c55e${o?"50":"35"}; white-space: nowrap; ">$${n.amount.toFixed(2)}</div>`:""}\n </div>\n\n <div style="color: ${o?"#0f1419":"#e7e9ea"}; font-size: 13px; line-height: 1.5; margin-bottom: 12px; padding: 11px; background-color: ${o?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.05)"}; border-radius: 8px; border-left: 3px solid ${a}; ">${n.reason}</div>\n\n <div style="display: flex; gap: 7px;">\n <button onclick="approveFanGroupApplication('${t}', '${n.id}')" style="flex: 1; background-color: ${o?"#1d9bf0":"var(--x-accent)"}; color: #ffffff; border: none; border-radius: 8px; padding: 9px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.opacity='0.9'"\n onmouseout="this.style.opacity='1'">\n ✓ 通过\n </button>\n <button onclick="rejectFanGroupApplication('${t}', '${n.id}')" style="flex: 1; background-color: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; padding: 9px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; " onmouseover="this.style.backgroundColor='${o?"#ef444415":"#ef444412"}'"\n onmouseout="this.style.backgroundColor='transparent'">\n ✗ 拒绝\n </button>\n </div>\n </div>\n`}(e,t,n,l)).join("")}\n </div>\n </div>\n `,document.body.appendChild(c),document.body.style.overflow="hidden",c.onclick=n=>{n.target===c&&closeFanGroupApplicationsModal()};const d=c.querySelector("div");d.style.transform="scale(0.8) translateY(20px)",d.style.opacity="0",requestAnimationFrame(()=>{d.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",d.style.transform="scale(1) translateY(0)",d.style.opacity="1"})}catch(n){console.error("❌ [粉丝群申请] 打开弹窗失败:",n),mn("打开申请列表失败","error")}}n.toggleBatchMode=function(){Lc=!Lc,Pc.clear();const n=document.getElementById("fangroup-files-batch-btn"),e=document.getElementById("fangroup-files-cancel-batch-btn"),t=document.getElementById("fangroup-files-delete-batch-btn"),o=document.getElementById("fangroup-files-create-folder-btn"),a=document.getElementById("fangroup-files-upload-btn");Lc?(n&&(n.style.display="none"),e&&(e.style.display="flex",e.style.backgroundColor="var(--x-bg-secondary)",e.style.color="var(--x-text-primary)"),t&&(t.style.display="flex",t.textContent="删除选中 (0)",t.style.backgroundColor="rgba(0,0,0,0.12)",t.style.color="#ff5252"),o&&(o.style.display="none"),a&&(a.style.display="none")):(n&&(n.style.display="flex"),e&&(e.style.display="none"),t&&(t.style.display="none"),o&&(o.style.display="flex"),a&&(a.style.display="flex")),Ac()},n.batchDeleteFiles=async function(){if(0===Pc.size)return void mn("请选择要删除的文件","warning");if(!confirm(`确定要删除选中的 ${Pc.size} 个文件吗？`))return;const n=Al.id;try{const t=e(),o=`fanGroupFiles_${vt||"main"}_${n}`,a=await t.xAccountProfiles.get(o);let i=a?.data||[];i=i.filter(n=>!Pc.has(n.id)),await t.xAccountProfiles.put({handle:o,name:"fanGroupFiles",data:i,updatedAt:(new Date).toISOString()}),console.log(`✅ [群文件] 已批量删除 ${Pc.size} 个文件`),mn(`已删除 ${Pc.size} 个文件`,"success"),Pc.clear(),await Ac()}catch(n){console.error("❌ [群文件] 批量删除失败:",n),mn("批量删除失败","error")}},n.createFanGroup=async function(){try{const t=e(),o=`messagesList_${vt||"main"}`,a=await t.xAccountProfiles.get(o);let i=a?.data||[];const r=`fangroup_${Date.now()}`,s={id:r,type:"fangroup",userName:"我的粉丝群",userHandle:"fangroup",userAvatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",lastMessage:"",timestamp:(new Date).toISOString(),unread:!1,groupName:"我的粉丝群",groupThreshold:"",memberCount:0,members:[]};i.unshift(s),await t.xAccountProfiles.put({handle:o,name:"messagesList",data:i,updatedAt:(new Date).toISOString()}),console.log("✅ [粉丝群] 已创建新粉丝群:",r),uc(),dc=i,await pc(),mn("已创建粉丝群","success"),setTimeout(()=>{n.openMessageDetail(s)},300)}catch(n){console.error("❌ [粉丝群] 创建失败:",n),mn("创建粉丝群失败","error")}},n.openFanGroupSettings=vc,n.closeFanGroupSettings=yc,n.updateFanGroupAvatarPreview=function(n){const e=document.getElementById("fangroup-avatar-preview");e&&n&&(e.src=n)},n.saveFanGroupAvatar=async function(n){const t=document.getElementById("fangroup-avatar-input");if(!t)return;const o=t.value.trim();if(o)try{const t=e(),a=`messagesList_${vt||"main"}`,i=await t.xAccountProfiles.get(a);let r=i?.data||[];const s=r.findIndex(e=>e.id===n);if(-1!==s){if(r[s].userAvatar=o,r[s].groupAvatar=o,await t.xAccountProfiles.put({handle:a,name:"messagesList",data:r,updatedAt:(new Date).toISOString()}),dc=r,Al?.id===n){const n=document.getElementById("message-detail-top-avatar");n&&(n.src=o,console.log("✅ [粉丝群头像] 已更新详情页顶部头像"));const e=document.getElementById("message-detail-avatar");e&&(e.src=o,console.log("✅ [粉丝群头像] 已更新详情页大头像"))}const e=document.getElementById("x-messages-page");e&&"flex"===e.style.display?(await pc(),console.log("✅ [粉丝群头像] 私信列表已立即刷新")):console.log("✅ [粉丝群头像] 私信列表将在下次显示时自动刷新"),mn("头像已更新","success")}}catch(n){console.error("❌ [粉丝群] 保存头像失败:",n),mn("保存失败","error")}else mn("请输入头像链接","warning")},n.saveFanGroupSettings=async function(n){try{const t=document.getElementById("fangroup-name-input"),o=document.getElementById("fangroup-threshold-input");if(!t)return;const a=t.value.trim(),i=o?o.value.trim():"";if(!a)return void mn("请输入群名称","warning");const r=e(),s=`messagesList_${vt||"main"}`,l=await r.xAccountProfiles.get(s);let c=l?.data||[];const d=c.findIndex(e=>e.id===n);if(-1!==d){c[d].userName=a,c[d].groupName=a,c[d].groupThreshold=i,await r.xAccountProfiles.put({handle:s,name:"messagesList",data:c,updatedAt:(new Date).toISOString()}),dc=c;const e=document.getElementById("message-detail-top-name");e&&Al?.id===n&&(e.textContent=a),await pc(),mn("设置已保存","success"),yc()}}catch(n){console.error("❌ [粉丝群] 保存设置失败:",n),mn("保存失败","error")}},n.toggleFanGroupAutoMessage=async function(t){try{const o=e(),a=`fanGroupSettings_${vt||"main"}_${t}`,i=await o.xAccountProfiles.get(a),r=!(i?.data?.autoMessageEnabled||!1);if(await o.xAccountProfiles.put({handle:a,name:"fanGroupSettings",data:{autoMessageEnabled:r,autoMessageInterval:i?.data?.autoMessageInterval||120,groupId:t},updatedAt:(new Date).toISOString()}),console.log("🤖 [粉丝群] 自动发信息已"+(r?"启用":"禁用")),r&&void 0!==n.lastAutoMessageTrigger){n.lastAutoMessageTrigger[t]=Date.now();const e=i?.data?.autoMessageInterval||120;console.log(`⏰ 已为粉丝群 ${t} 设置初始触发时间，需等待 ${e}秒 后首次触发`)}const s=document.getElementById("fangroup-auto-message-toggle");if(s){const n=s.querySelector(".toggle-switch"),e=s.querySelector(".toggle-circle");n.style.backgroundColor=r?"var(--x-accent)":"#333",e.style.left=r?"22px":"2px"}mn(r?"已启用后台自动发信息":"已禁用后台自动发信息","success")}catch(n){console.error("❌ [粉丝群] 切换自动发信息失败:",n),mn("操作失败","error")}},n.updateFanGroupInterval=async function(n,t){try{const o=e(),a=`fanGroupSettings_${vt||"main"}_${n}`,i=await o.xAccountProfiles.get(a),r=Math.max(60,Math.min(3600,parseInt(t)||120));await o.xAccountProfiles.put({handle:a,name:"fanGroupSettings",data:{autoMessageEnabled:i?.data?.autoMessageEnabled||!1,autoMessageInterval:r,groupId:n},updatedAt:(new Date).toISOString()}),console.log(`🤖 [粉丝群] 自动发信息间隔已更新: ${r}秒`),mn(`间隔已更新为 ${r} 秒`,"success")}catch(n){console.error("❌ [粉丝群] 更新间隔失败:",n),mn("更新失败","error")}},n.handleMessageDetailAvatarClick=handleMessageDetailAvatarClick,n.openFanGroupShareModal=async function(n){console.log("📤 [粉丝群转发] 打开转发选项",n);try{const t=e(),o=`messagesList_${vt||"main"}`,a=await t.xAccountProfiles.get(o),i=(a?.data||[]).find(e=>e.id===n);if(!i)return void mn("未找到粉丝群数据","error");const r=document.createElement("div");r.id="fangroup-share-modal",r.style.cssText="\n position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 30; backdrop-filter: blur(4px); ",r.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid var(--x-border-color); overflow: hidden; " onclick="event.stopPropagation()">\n\n <div style="padding: 20px; border-bottom: 1px solid var(--x-border-color); ">\n <div style="font-size: 20px; font-weight: 700; color:var(--x-text-primary); text-align: center;">\n 转发粉丝群\n </div>\n </div>\n\n <div style="padding: 20px; border-bottom: 1px solid var(--x-border-color);">\n <div style="display: flex; align-items: center; gap: 12px;">\n <img src="${i.userAvatar||i.groupAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}"\n style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">\n <div style="flex: 1;">\n <div style="color:var(--x-text-primary); font-size: 16px; font-weight: 600; margin-bottom: 4px;">\n ${i.userName||i.groupName||"我的粉丝群"}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px;">\n ${i.memberCount||0} 位成员\n </div>\n </div>\n </div>\n ${i.groupThreshold?`\n <div style="margin-top: 12px; padding: 10px; background-color:var(--x-bg-secondary); border-radius: 8px; color:var(--x-text-secondary); font-size: 13px; line-height: 1.4; ">\n <div style="color:var(--x-text-primary); font-weight: 600; margin-bottom: 4px;">入群门槛</div>\n ${i.groupThreshold}\n </div>\n `:""}\n </div>\n\n <div style="padding: 12px;">\n\n <div onclick="shareFanGroupToContact('${n}')" style="display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <div style="width: 40px; height: 40px; border-radius: 50%; background-color:var(--x-bg-secondary); display: flex; align-items: center; justify-content: center; ">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"></path></g>\n </svg>\n </div>\n <div style="flex: 1;">\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 2px;">\n 转发到联系人\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px;">\n 分享给你的私信联系人\n </div>\n </div>\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-secondary);">\n <g><path d="M8.58 7.17l4.24 4.24-4.24 4.24 1.42 1.42 5.66-5.66-5.66-5.66z"></path></g>\n </svg>\n </div>\n\n <div onclick="shareFanGroupToPost('${n}')" style="display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <div style="width: 40px; height: 40px; border-radius: 50%; background-color:var(--x-bg-secondary); display: flex; align-items: center; justify-content: center; ">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M8.8 7.2H5.6V3.9c0-.4-.3-.8-.8-.8s-.7.4-.7.8v3.3H.8c-.4 0-.8.3-.8.8s.3.8.8.8h3.3v3.3c0 .4.3.8.8.8s.8-.3.8-.8V8.7H9c.4 0 .8-.3.8-.8s-.5-.7-1-.7zm15-4.9v-.1h-.1c-.1 0-9.2 1.2-14.4 11.7-3.8 7.6-3.6 9.9-3.3 9.9.3.1 3.4-6.5 6.7-9.2 5.2-1.1 6.6-3.6 6.6-3.6s-1.5.2-2.1.2c-.8 0-1.4-.2-1.7-.3 1.3-1.2 2.4-1.5 3.5-1.7.9-.2 1.8-.4 3-1.2 2.2-1.6 1.9-5.5 1.8-5.7z"></path></g>\n </svg>\n </div>\n <div style="flex: 1;">\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 2px;">\n 转发到推文\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px;">\n 发布推文并引用粉丝群\n </div>\n </div>\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-secondary);">\n <g><path d="M8.58 7.17l4.24 4.24-4.24 4.24 1.42 1.42 5.66-5.66-5.66-5.66z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="padding: 12px 20px 20px 20px;">\n <button onclick="closeFanGroupShareModal()" style="width: 100%; background-color:var(--x-bg-secondary); color:var(--x-text-primary); border: none; border-radius: 20px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">\n 取消\n </button>\n </div>\n </div>\n `;const s=document.getElementById("x-social-screen");s?s.appendChild(r):document.body.appendChild(r),r.onclick=n=>{n.target===r&&wc()}}catch(n){console.error("❌ [粉丝群转发] 打开转发选项失败:",n),mn("打开转发选项失败","error")}},n.closeFanGroupShareModal=wc,n.shareFanGroupToContact=async function(n){console.log("📤 [粉丝群转发] 转发到联系人",n);try{const t=e(),o=`messagesList_${vt||"main"}`,a=await t.xAccountProfiles.get(o),i=a?.data||[],r=i.find(e=>e.id===n);if(!r)return void mn("未找到粉丝群数据","error");wc();const s=i.filter(e=>e.id!==n);if(0===s.length)return void mn("暂无其他联系人","info");const l=document.createElement("div");l.id="fangroup-contact-select-modal",l.style.cssText="\n position: fixed;\n top: 0;\n left: 0;\n width: 100vw;\n height: 100vh;\n background-color: rgba(0, 0, 0, 0.5);\n display: flex;\n align-items: center;\n justify-content: center;\n z-index: 35;\n backdrop-filter: blur(4px);\n ",l.innerHTML=`\n <div style="\n background-color:var(--x-bg-primary);\n border-radius: 16px;\n width: 90%;\n max-width: 500px;\n max-height: 80vh;\n border: 1px solid var(--x-border-color);\n display: flex;\n flex-direction: column;\n overflow: hidden;\n " onclick="event.stopPropagation()">\n\n <div style="\n padding: 16px 20px;\n border-bottom: 1px solid var(--x-border-color);\n display: flex;\n align-items: center;\n justify-content: space-between;\n ">\n <div style="font-size: 18px; font-weight: 700; color:var(--x-text-primary);">\n 选择转发对象\n </div>\n <div onclick="closeFanGroupContactSelectModal()" style="\n cursor: pointer;\n padding: 8px;\n border-radius: 50%;\n transition: background-color 0.2s;\n " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n\n <div style="\n padding: 16px 20px;\n background-color:var(--x-bg-secondary);\n border-bottom: 1px solid var(--x-border-color);\n ">\n <div style="font-size: 13px; color:var(--x-text-secondary); margin-bottom: 8px;">\n 将要转发的粉丝群\n </div>\n <div style="display: flex; align-items: center; gap: 12px;">\n <img src="${r.userAvatar||r.groupAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}"\n style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">\n <div style="flex: 1;">\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600;">\n ${r.userName||r.groupName||"我的粉丝群"}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px;">\n ${r.memberCount||0} 位成员\n </div>\n </div>\n </div>\n </div>\n\n <div id="fangroup-contact-list" style="\n flex: 1;\n overflow-y: auto;\n padding: 12px;\n ">\n ${s.map(n=>`\n <div class="fangroup-contact-item" data-contact-id="${n.id}" style="\n display: flex;\n align-items: center;\n gap: 12px;\n padding: 12px;\n border-radius: 12px;\n cursor: pointer;\n transition: background-color 0.2s;\n margin-bottom: 8px;\n " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="if(!this.classList.contains('selected')) this.style.backgroundColor='transparent'"\n onclick="toggleContactSelection('${n.id}')">\n\n <div class="contact-checkbox" style="\n width: 20px;\n height: 20px;\n border-radius: 50%;\n border: 2px solid var(--x-border-color);\n background-color: var(--x-bg-primary);\n flex-shrink: 0;\n transition: all 0.2s;\n "></div>\n\n <img src="${n.userAvatar||n.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg"}"\n style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">\n\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">\n <span style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n ${n.userName||n.name||"未知用户"}\n </span>\n ${"fangroup"===n.type?'\n <span style="\n padding: 2px 6px;\n background-color:var(--x-bg-secondary);\n color:var(--x-text-secondary);\n font-size: 10px;\n border-radius: 4px;\n font-weight: 600;\n ">粉丝群</span>\n ':""}\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n ${n.lastMessage||n.userHandle||""}\n </div>\n </div>\n </div>\n `).join("")}\n </div>\n\n <div style="\n padding: 16px 20px;\n border-top: 1px solid var(--x-border-color);\n display: flex;\n gap: 12px;\n ">\n <button onclick="closeFanGroupContactSelectModal()" style="\n flex: 1;\n background-color:var(--x-bg-secondary);\n color:var(--x-text-primary);\n border: none;\n border-radius: 20px;\n padding: 12px 20px;\n font-size: 15px;\n font-weight: 600;\n cursor: pointer;\n transition: opacity 0.2s;\n " onmouseover="this.style.opacity='0.8'"\n onmouseout="this.style.opacity='1'">\n 取消\n </button>\n <button id="fangroup-contact-confirm-btn" onclick="confirmFanGroupContactShare('${n}')" style="\n flex: 1;\n background-color: var(--x-accent);\n color: #fff;\n border: none;\n border-radius: 20px;\n padding: 12px 20px;\n font-size: 15px;\n font-weight: 600;\n cursor: pointer;\n transition: opacity 0.2s;\n opacity: 0.5;\n " disabled>\n 转发 (0)\n </button>\n </div>\n </div>\n `;const c=document.getElementById("x-social-screen");c?c.appendChild(l):document.body.appendChild(l),l.onclick=n=>{n.target===l&&closeFanGroupContactSelectModal()}}catch(n){console.error("❌ [粉丝群转发] 打开联系人选择失败:",n),mn("打开联系人选择失败","error")}},n.shareFanGroupToPost=async function(t){console.log("📤 [粉丝群转发] 转发到发帖",t);try{const o=e(),a=`messagesList_${vt||"main"}`,i=await o.xAccountProfiles.get(a),r=(i?.data||[]).find(n=>n.id===t);if(!r)return void mn("未找到粉丝群数据","error");wc(),yc(),Ft(),setTimeout(()=>{n.currentQuoteFanGroup={id:r.id,name:r.userName||r.groupName||"我的粉丝群",avatar:r.userAvatar||r.groupAvatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",memberCount:r.memberCount||0,threshold:r.groupThreshold||""},console.log("📤 [粉丝群转发] 粉丝群引用数据已设置:",n.currentQuoteFanGroup),function(){if(console.log("🔍 [粉丝群转发] 开始添加引用区域..."),!n.currentQuoteFanGroup)return void console.warn("⚠️ [粉丝群转发] currentQuoteFanGroup 为空");const e=n.currentQuoteFanGroup;console.log("📤 [粉丝群转发] 粉丝群数据:",e);const t=document.getElementById("compose-tweet-modal");if(!t)return void console.error("❌ [粉丝群转发] 找不到发帖弹窗");let o=document.getElementById("compose-fangroup-quote-section");o&&(console.log("🗑️ [粉丝群转发] 移除旧的引用区域"),o.remove());o=document.createElement("div"),o.id="compose-fangroup-quote-section",o.style.cssText="\n margin: 16px 0 0 0; padding: 12px; border: 1px solid var(--x-border-color); border-radius: 12px; background-color: var(--x-bg-hover);\n",o.innerHTML=`\n <div style="display: flex; align-items: flex-start; gap: 12px;">\n <img src="${e.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">\n <span style="color:var(--x-text-primary); font-size: 15px; font-weight: 700;">${e.name}</span>\n <span style="padding: 2px 8px; background-color:var(--x-bg-secondary); color:var(--x-text-secondary); font-size: 11px; border-radius: 4px; font-weight: 600; ">粉丝群</span>\n </div>\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-bottom: 8px;">\n ${e.memberCount} 位成员\n </div>\n ${e.threshold?`\n <div style="padding: 8px; background-color:var(--x-bg-secondary); border-radius: 6px; color:var(--x-text-secondary); font-size: 12px; line-height: 1.4; ">\n <div style="color:var(--x-text-primary); font-weight: 600; margin-bottom: 2px; font-size: 11px;">入群门槛</div>\n ${e.threshold.length>60?e.threshold.substring(0,60)+"...":e.threshold}\n </div>\n `:""}\n </div>\n <div onclick="removeFanGroupQuote()" style="cursor: pointer; padding: 4px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-secondary)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-text-secondary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n </div>\n`;const a=t.querySelector("#compose-text-input");if(!a)return void console.error("❌ [粉丝群转发] 找不到文本输入框");const i=a.parentElement;console.log("📍 [粉丝群转发] 找到输入容器:",i);const r=t.querySelector("#quote-content-preview");r?(i.insertBefore(o,r),console.log("✅ [粉丝群转发] 引用区域已插入到引用预览区域之前")):(i.insertBefore(o,a.nextSibling),console.log("✅ [粉丝群转发] 引用区域已插入到textarea之后"));console.log("✅ [粉丝群转发] 引用区域添加完成！")}(),mn("已添加粉丝群引用，请编写推文内容","success")},150)}catch(n){console.error("❌ [粉丝群转发] 转发到发帖失败:",n),mn("转发失败: "+n.message,"error")}},n.openFanGroupApplicationsModal=jc,n.generateFanGroupConversation=kc,n.checkAndTriggerFanGroupAutoChat=$c,n.refreshFanGroupApplications=async function(n){console.log("🔄 [粉丝群申请] 开始刷新申请",n);const t=document.getElementById("refresh-applications-btn");t&&(t.disabled=!0,t.style.opacity="0.5",t.style.cursor="not-allowed");try{mn("正在查找相关帖子...","info");const t=e(),o=`userTweets_${vt||"main"}`,a=await t.xUserTweets.get(o);if(!a||!a.tweets||0===a.tweets.length)return void mn("请先发布引用该粉丝群的帖子","warning");const i=a.tweets;let r=null;for(const e of i)if(e.quotedFanGroup&&e.quotedFanGroup.id===n){r=e;break}if(!r)return void mn("未找到引用该粉丝群的帖子，请先发布相关帖子","warning");console.log("✅ [粉丝群申请] 找到相关帖子:",r.id),mn("正在生成新的入群申请...","info"),await Nc(r),mn("成功生成新申请！","success"),closeFanGroupApplicationsModal(),setTimeout(()=>{jc(n)},500)}catch(n){console.error("❌ [粉丝群申请] 刷新失败:",n),mn("刷新失败: "+n.message,"error")}finally{t&&(t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer")}},n.closeFanGroupApplicationsModal=function(){const n=document.getElementById("fangroup-applications-modal");if(n){const e=n.querySelector("div");e.style.transform="scale(0.9) translateY(20px)",e.style.opacity="0",setTimeout(()=>{n.remove(),document.body.style.overflow="auto"},200)}},n.approveFanGroupApplication=async function(t,o){console.log("✅ [粉丝群申请] 通过申请",t,o);try{const a=e(),i=await Hc(t),r=i.find(n=>n.id===o);if(!r)return void mn("未找到申请数据","error");if(r.status="approved",r.approvedAt=(new Date).toISOString(),await Rc(t,i),r.amount&&r.amount>0){if(await Mt(),!It.isActivated)return void mn("请先激活钱包","error");It.balance+=r.amount;const n={id:"fangroup_"+Date.now(),description:`${r.applicantName} 的入群费用`,amount:r.amount,timestamp:(new Date).toISOString(),type:"fan_group_fee",applicant:{name:r.applicantName,handle:r.applicantHandle}};It.transactions.unshift(n),await Tt(),console.log(`💰 [粉丝群申请] 入群费用已入账: +$${r.amount.toFixed(2)}`)}const s=`messagesList_${vt||"main"}`,l=await a.xAccountProfiles.get(s),c=l?.data||[],d=c.find(n=>n.id===t);if(d){d.members||(d.members=[]);const n={id:r.id,name:r.applicantName,handle:r.applicantHandle,avatar:r.applicantAvatar,joinedAt:(new Date).toISOString()};d.members.push(n),d.memberCount=d.members.length,await a.xAccountProfiles.put({handle:s,name:"messagesList",data:c,updatedAt:(new Date).toISOString()}),console.log("✅ [粉丝群申请] 成员已添加，当前成员数:",d.memberCount);const e=`messageConversation_${vt||"main"}_${t}`,o=await a.xAccountProfiles.get(e);if(o&&o.data&&o.data.messages){const n={type:"system",systemType:"memberJoined",content:`${r.applicantName} 加入了粉丝群`,timestamp:(new Date).toISOString(),time:"刚刚"};o.data.messages.push(n),await a.xAccountProfiles.put(o),console.log("✅ [粉丝群申请] 已添加入群系统通知")}}if(Al&&Al.id===t){const e=`messagesList_${vt||"main"}`,o=await a.xAccountProfiles.get(e),i=(o?.data||[]).find(n=>n.id===t);i&&await n.openMessageDetail(i)}const p=document.getElementById(`app-card-${o}`);p&&(p.style.transform="translateX(100%)",p.style.opacity="0",setTimeout(()=>p.remove(),300));0===i.filter(n=>"pending"===n.status&&n.id!==o).length?setTimeout(()=>{closeFanGroupApplicationsModal(),mn("所有申请已处理完毕","success")},500):mn(r.amount>0?`已通过申请，收到 $${r.amount.toFixed(2)}`:"已通过申请","success"),d&&d.members&&d.members.length>0&&setTimeout(()=>{$c(t,d.members.length)},1e3)}catch(n){console.error("❌ [粉丝群申请] 通过申请失败:",n),mn("操作失败: "+n.message,"error")}},n.rejectFanGroupApplication=async function(n,e){console.log("❌ [粉丝群申请] 拒绝申请",n,e);try{const t=await Hc(n),o=t.find(n=>n.id===e);if(!o)return void mn("未找到申请数据","error");o.status="rejected",o.rejectedAt=(new Date).toISOString(),await Rc(n,t);const a=document.getElementById(`app-card-${e}`);a&&(a.style.transform="translateX(-100%)",a.style.opacity="0",setTimeout(()=>a.remove(),300));0===t.filter(n=>"pending"===n.status&&n.id!==e).length?setTimeout(()=>{closeFanGroupApplicationsModal(),mn("所有申请已处理完毕","success")},500):mn("已拒绝申请","info")}catch(n){console.error("❌ [粉丝群申请] 拒绝申请失败:",n),mn("操作失败: "+n.message,"error")}};const Uc=n.openMessageDetail;function Oc(n){zl.has(n)?zl.delete(n):zl.add(n),Fc(),Xc()}async function _c(){if(Al)try{const n=e(),t=`messageConversation_${vt||"main"}_${Al.id}`,o=await n.xAccountProfiles.get(t);if(o&&o.data&&o.data.messages){const n=document.getElementById("message-detail-content");if(!n)return;n.querySelectorAll('.message-item, div[style*="text-align: center"]').forEach(n=>{n.classList.contains("message-item")&&n.remove()});const e=Nl(o.data.messages),t=[];e.forEach(e=>{const o=!0===e[0].message.isOwn;e.forEach((a,i)=>{const r=i===e.length-1,s=Bl(a.message,o,a.index,r);n.appendChild(s),t.push(s)})}),t.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"})}}catch(n){console.error("重新加载消息视图失败:",n)}}function Fc(){zl.forEach(n=>{const e=document.querySelector(`[data-message-id="${n}"]`);if(e){e.style.opacity=zl.has(n)?"0.7":"1";const t=e.querySelector(".message-select-indicator");if(t){const e=zl.has(n);t.style.borderColor=e?"var(--x-accent)":"var(--x-border-color)",t.style.backgroundColor=e?"var(--x-accent)":"var(--x-bg-primary)",t.innerHTML=e?'\n <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #fff;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></g>\n </svg>\n ':""}}})}function Xc(){const n=document.getElementById("message-selected-count"),e=document.getElementById("message-delete-btn");n&&(n.textContent=zl.size),e&&(zl.size>0?(e.style.opacity="1",e.style.pointerEvents="auto"):(e.style.opacity="0.5",e.style.pointerEvents="none"))}async function qc(t,o,a,i){try{const r=e(),s=t.replace("@","").toLowerCase(),l=o.replace("@","").toLowerCase();console.log(`🔓 [拉黑解除] 检测触发: 用户=${s}, 对方=${l}, 来源=${a}`);let c=null,d=null;const p=(await r.xCharacterProfiles.toArray()).find(n=>n.xHandle&&n.xHandle.replace("@","").toLowerCase()===l);if(p){c=`msg_${p.characterId}`;const n=`messagesList_${vt||"main"}`,e=await r.xAccountProfiles.get(n);e&&e.data&&(d=e.data.find(n=>n.id===c))}else{if(await r.xAccountProfiles.get(l)){c=`msg_account_${l}`;const n=`messagesList_${vt||"main"}`,e=await r.xAccountProfiles.get(n);e&&e.data&&(d=e.data.find(n=>n.id===c))}else{const n=`messagesList_${vt||"main"}`,e=await r.xAccountProfiles.get(n);e&&e.data&&(d=e.data.find(n=>n.userHandle&&n.userHandle.replace("@","").toLowerCase()===l),d&&(c=d.id))}}if(!c||!d)return void console.log("⚠️ [拉黑解除] 未找到对应的私信记录");const g=`messageConversation_${vt||"main"}_${c}`,m=await r.xAccountProfiles.get(g);if(!m||!m.isBlocked)return void console.log("ℹ️ [拉黑解除] 对方并未拉黑用户，无需解除");console.log("✅ [拉黑解除] 检测到拉黑状态，准备生成AI回复评估是否解除");const x={triggerSource:a,triggerContent:i,isUnblockTrigger:!0},u=await vl(d,!0,{isUnblockRequest:!0,unblockContext:x});if(u&&u.some(n=>"system"===n.type&&"unblocked"===n.systemType)){console.log("🎉 [拉黑解除] AI决定解除拉黑！"),m.isBlocked=!1,delete m.blockedAt,m.updatedAt=(new Date).toISOString(),m.data||(m.data={messages:[]}),m.data.messages||(m.data.messages=[]);const e={type:"system",systemType:"unblockContext",content:"mention"===a?`用户在推文中@了你: "${i.substring(0,100)}..."`:`用户在评论区提到了你: "${i.substring(0,100)}..."`,timestamp:(new Date).toISOString(),time:"刚刚"};m.data.messages.push(e),u.forEach(n=>{n.timestamp||(n.timestamp=(new Date).toISOString()),n.time||(n.time="刚刚"),m.data.messages.push(n)}),await r.xAccountProfiles.put(m),Rl({title:d.userName||d.user?.name||"未知用户",message:"已解除拉黑",avatar:d.userAvatar||d.user?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",onClick:()=>{openMessageDetail(d)}});const t=document.getElementById("x-message-detail-page");if(t&&"flex"===t.style.display){const e=n.currentViewingMessage;if(e&&e.id===c){console.log("🔄 [拉黑解除] 刷新当前私信详情页");const n=document.getElementById("message-input"),e=document.getElementById("message-send-btn");n&&(n.disabled=!1,n.placeholder="发送私信"),e&&(e.disabled=!1),Jl(d,m.data)}}console.log("✅ [拉黑解除] 拉黑已解除，AI消息已发送")}else console.log("❌ [拉黑解除] AI决定不解除拉黑")}catch(n){console.error("❌ [拉黑解除] 检测失败:",n)}}n.openMessageDetail=async function(n,e){console.log("🎯 [粉丝群] 拦截器：检测消息类型",n),Uc&&await Uc(n,e),setTimeout(()=>{!function(n){const e=document.getElementById("message-detail-scrollable");if(!e)return;const t=e.children[0];if(!t)return;const o=document.getElementById("fangroup-auto-reaction-btn"),a=document.getElementById("fangroup-announcement-btn"),i=document.getElementById("fangroup-files-btn");n?(t.style.display="none",o&&(o.style.display="flex"),a&&(a.style.display="flex"),i&&(i.style.display="flex"),console.log("🎯 [粉丝群] 已隐藏详细信息区域，显示自反应按钮、群公告按钮和群文件按钮")):(t.style.display="flex",o&&(o.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="none"))}("fangroup"===n.type)},100)},n.exitMessageMultiSelectMode=function(){El=!1,zl.clear(),function(){const n=document.getElementById("message-delete-toolbar");n&&n.remove();const e=document.getElementById("message-input-toolbar");e&&(e.style.display="flex")}(),_c()},n.selectAllMessages=function(){document.querySelectorAll(".message-item[data-message-id]").forEach(n=>{const e=n.getAttribute("data-message-id");e&&zl.add(e)}),Fc(),Xc()},n.deleteSelectedMessages=async function(){if(0===zl.size)return void mn("请先选择要删除的消息","error");const n="en"===Hn,t=n?`Delete ${zl.size} message(s)?`:`确定删除选中的 ${zl.size} 条消息吗？`;if(confirm(t))try{const t=e(),o=`messageConversation_${vt||"main"}_${Al.id}`,a=await t.xAccountProfiles.get(o);if(a&&a.data&&a.data.messages){const e=new Set;zl.forEach(n=>{const t=n.match(/^msg_idx_(\d+)$/);t&&e.add(parseInt(t[1],10))});const o=a.data.messages.filter((n,t)=>!e.has(t));console.log(`🗑️ 准备删除索引: ${Array.from(e).join(", ")}`),console.log(`📝 删除前消息数: ${a.data.messages.length}, 删除后: ${o.length}`),a.data.messages=o,a.updatedAt=(new Date).toISOString(),await t.xAccountProfiles.put(a),console.log(`✅ 已删除 ${e.size} 条消息`),exitMessageMultiSelectMode();const i=document.getElementById("message-detail-content");if(i){i.innerHTML="";const n=new Date,e="en"===Hn?n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):`${n.getFullYear()}年${n.getMonth()+1}月${String(n.getDate()).padStart(2,"0")}日`;i.appendChild(jl(e));const t=Nl(o),a=[];t.forEach(n=>{const e=!0===n[0].message.isOwn;n.forEach((t,o)=>{const r=o===n.length-1,s=Bl(t.message,e,t.index,r);i.appendChild(s),a.push(s)})}),a.forEach(n=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{const n=document.getElementById("message-detail-scrollable");n&&(n.scrollTop=n.scrollHeight)},100)}mn(n?`Deleted ${e.size} message(s)`:`已删除 ${e.size} 条消息`,"success")}}catch(e){console.error("删除消息失败:",e);mn(n?"Failed to delete messages":"删除消息失败","error")}};let Vc=null;const Gc=5e3,Yc={},Wc={};function Jc(){Vc&&clearInterval(Vc),console.log("🤖 启动后台自动发消息系统"),Vc=setInterval(async()=>{await async function(){try{t();const n=e(),o=`messagesList_${vt||"main"}`,a=await n.xAccountProfiles.get(o),i=a?.data||[],r=Date.now(),s=`xSettings_${vt||"main"}`,l=await n.xSettings.get(s),c=l?.boundCharacters||[],d=await Promise.all(c.map(e=>n.xCharacterProfiles.get(e)));for(const e of d){if(!e||!e.autoMessageEnabled)continue;const t=e.characterId,o=`msg_${t}`,a=i.find(n=>n.id===o);if(!a)continue;const s=`messageConversation_${vt||"main"}_${o}`,l=await n.xAccountProfiles.get(s);if(!l||!l.data||!l.data.messages)continue;const c=l.data.messages,d=e.autoMessageInterval||60,p=(r-(Yc[t]||0))/1e3;if(0===c.length){p>=d&&(console.log(`🤖 触发自动发消息（无聊天记录）: ${e.xName}`),Yc[t]=r,await ed(a,e,0));continue}const g=c[c.length-1],m=(r-(g.timestamp?new Date(g.timestamp).getTime():0))/1e3;m>=d&&!g.isOwn&&p>=d/2&&(console.log(`🤖 触发自动发消息（用户未回复）: ${e.xName}, 距离上次互动 ${Math.floor(m)}秒`),Yc[t]=r,await ed(a,e,m));const x=(r-(Wc[t]||0))/1e3;if(c.length>0&&x>=d&&Math.random()<.2){const n=(r-(g.timestamp?new Date(g.timestamp).getTime():0))/1e3;n>=d&&(console.log(`🎲 [角色自动发推] 触发: ${e.xName}, 距离上次聊天 ${Math.floor(n)}秒`),Wc[t]=r,await Zc(a,e,n,"character"))}}for(const e of i){if(e.id.startsWith("msg_")&&"msg_001"!==e.id&&!e.id.startsWith("msg_account_")&&!e.id.startsWith("msg_npc_")&&!e.id.startsWith("msg_relationship_"))continue;const t=`strangerSettings_${vt||"main"}_${e.id}`,o=await n.xAccountProfiles.get(t);if(!o||!o.autoMessageEnabled)continue;const a=o.autoMessageInterval||60,i=e._accountType||(e.id.startsWith("msg_account_")?"账户":e.id.startsWith("msg_npc_")?"NPC":e.id.startsWith("msg_relationship_")?"关系NPC":"陌生人");console.log(`⏰ [${i}自动发消息] ${e.userName||e.user?.name} 间隔: ${a}秒`);const s=`messageConversation_${vt||"main"}_${e.id}`,l=await n.xAccountProfiles.get(s);if(!l||!l.data||!l.data.messages)continue;const c=l.data.messages,d=(r-(Yc[e.id]||0))/1e3;if(0===c.length){d>=a&&(console.log(`🤖 触发${i}自动发消息（无聊天记录）: ${e.userName||e.user?.name}`),Yc[e.id]=r,await nd(e,o,0));continue}const p=c[c.length-1],g=(r-(p.timestamp?new Date(p.timestamp).getTime():0))/1e3;g>=a&&!p.isOwn&&d>=a/2&&(console.log(`🤖 触发${i}自动发消息（用户未回复）: ${e.userName||e.user?.name}, 距离上次互动 ${Math.floor(g)}秒`),Yc[e.id]=r,await nd(e,o,g));const m=(r-(Wc[e.id]||0))/1e3;if(c.length>0&&m>=a&&Math.random()<.1){const n=(r-(p.timestamp?new Date(p.timestamp).getTime():0))/1e3;n>=a&&(console.log(`🎲 [${i}自动发推] 触发: ${e.userName||e.user?.name}, 距离上次聊天 ${Math.floor(n)}秒`),Wc[e.id]=r,await Zc(e,o,n,"stranger"))}}for(const e of i){if("fangroup"!==e.type)continue;const t=`fanGroupSettings_${vt||"main"}_${e.id}`,o=await n.xAccountProfiles.get(t);if(!o||!o.data||!o.data.autoMessageEnabled)continue;const a=o.data.autoMessageInterval||120;console.log(`⏰ [粉丝群自动发消息] ${e.userName||e.groupName} 间隔: ${a}秒`);const i=`messageConversation_${vt||"main"}_${e.id}`,s=await n.xAccountProfiles.get(i);if(!s||!s.data||!s.data.messages){await n.xAccountProfiles.put({handle:i,name:"conversation",data:{messages:[]},updatedAt:(new Date).toISOString()});continue}const l=s.data.messages,c=(r-(Yc[e.id]||0))/1e3,d=l.slice().reverse().find(n=>"system"!==n.type);if(!d){c>=a&&(console.log(`🤖 触发粉丝群自动交流（无聊天记录）: ${e.userName||e.groupName}`),Yc[e.id]=r,await Qc(e));continue}const p=(r-(d.timestamp?new Date(d.timestamp).getTime():0))/1e3;p>=a&&c>=a/2&&(console.log(`🤖 触发粉丝群自动交流: ${e.userName||e.groupName}, 距离上次互动 ${Math.floor(p)}秒`),Yc[e.id]=r,await Qc(e))}}catch(n){console.error("❌ 检查自动发消息失败:",n)}}()},Gc)}function Kc(){Vc&&(clearInterval(Vc),Vc=null,console.log("🤖 停止后台自动发消息系统"))}async function Qc(n){try{console.log("🎭 [粉丝群自反应] 后台自动触发");const t=await kc(n,!0,{isAutoReaction:!0});if(!t||0===t.length)return void console.log("📭 [粉丝群自反应] AI未生成任何消息");const o=e(),a=`messageConversation_${vt||"main"}_${n.id}`,i=await o.xAccountProfiles.get(a);let r=[];i&&i.data&&i.data.messages&&(r=i.data.messages),r.push(...t),await o.xAccountProfiles.put({handle:a,name:"conversation",data:{messages:r},updatedAt:(new Date).toISOString()}),console.log(`✅ [粉丝群自反应] 后台生成了${t.length}条群聊消息`);const s=`messagesList_${vt||"main"}`,l=await o.xAccountProfiles.get(s);if(l&&l.data){const e=l.data.findIndex(e=>e.id===n.id);if(-1!==e){const n=t[t.length-1],a=n.content||n.voiceText||n.imageDescription||"[消息]";l.data[e].lastMessage=`${n.senderName}: ${a}`,l.data[e].timestamp=(new Date).toISOString(),l.data[e].unread=!0,await o.xAccountProfiles.put(l),dc=l.data}}"block"===document.getElementById("x-messages-page")?.style.display&&await pc()}catch(n){console.error("❌ [粉丝群自反应] 后台触发失败:",n)}}async function Zc(n,t,o,a="character"){try{let i,r,s,l;"character"===a?(i="角色",r=t.xName,s=t.xHandle,l=t.xAvatar):(i=n._accountType||(n.id.startsWith("msg_account_")?"账户":n.id.startsWith("msg_npc_")?"NPC":n.id.startsWith("msg_relationship_")?"关系NPC":"陌生人"),r=n.userName||n.user?.name||n.name,s=n.userHandle||n.user?.handle||n.handle,l=n.userAvatar||n.user?.avatar||n.avatar),console.log(`📨 ${i} ${r} 正在自动发推...`);const c=e(),d=`messageConversation_${vt||"main"}_${n.id}`,p=await c.xAccountProfiles.get(d);if(!p||!p.data||!p.data.messages)return void console.warn("自动发推失败，无聊天记录");const g=p.data.messages.slice(-20),m=await Tl(n,g,{isAutoTweet:!0,timeSinceLastMessage:Math.floor(o),type:a});if(!m)return void console.warn("自动发推生成失败，无推文内容");const x=Date.now(),u={id:`mention_newtweet_auto_${x}`,type:"newTweet",user:{name:r,handle:s,avatar:l},content:`New Tweet from ${r}`,time:"刚刚",timestamp:x,tweet:m},h=`mentions_${vt||"main"}`;let f=await c.xAccountProfiles.get(h);f||(f={handle:h,id:h,data:[]}),f.data.unshift(u),await c.xAccountProfiles.put(f),console.log(`✅ ${i}自动发推成功: ${r}`),await Dn(s,m);Rl({title:"X",message:"en"===Hn?`${r} posted a new tweet!`:`${r} 发布了新推文！`,avatar:l,leftIcon:"x"});const b=document.getElementById("x-notifications-page");b&&"flex"===b.style.display?await bl():vn("notifications")}catch(n){console.error("❌ 触发自动发推失败:",n)}}async function nd(n,t,o){try{const t=n._accountType||(n.id.startsWith("msg_account_")?"账户":n.id.startsWith("msg_npc_")?"NPC":n.id.startsWith("msg_relationship_")?"关系NPC":"陌生人"),a=n.userName||n.user?.name||n.name;console.log(`📨 ${t} ${a} 正在自动发消息...`);const i=await vl(n,!0,{isAutoMessage:!0,timeSinceLastMessage:Math.floor(o)});if(!i||0===i.length)return void console.warn(`${t}自动发消息生成失败，无新消息`);const r=e(),s=`messageConversation_${vt||"main"}_${n.id}`,l=await r.xAccountProfiles.get(s);if(l&&l.data){i.forEach(n=>{n.timestamp||(n.timestamp=(new Date).toISOString())}),l.data.messages.push(...i),l.updatedAt=(new Date).toISOString(),await r.xAccountProfiles.put(l),console.log(`✅ ${t}自动消息已保存: ${i.length}条`);if(mn("en"===Hn?`${a} sent you ${i.length} message(s)`:`${a} 向你发送了 ${i.length} 条私信`,"info"),Al&&Al.id===n.id){const n=document.getElementById("message-detail-content");if(n){let e=n.querySelectorAll(".message-item").length;i.forEach(t=>{const o=Bl(t,!1,e);n.appendChild(o),e++})}}try{const e=`messagesList_${vt||"main"}`,o=await r.xAccountProfiles.get(e);if(o&&o.data){const a=o.data,s=a.findIndex(e=>e.id===n.id);-1!==s&&(a[s].unread=!0,a[s].unreadCount=(a[s].unreadCount||0)+i.length,await r.xAccountProfiles.put({handle:e,name:"messagesList",data:a,updatedAt:(new Date).toISOString()}),dc=a,console.log(`✅ 已标记${t}私信为未读`))}}catch(n){console.error("更新未读状态失败:",n)}const e=document.getElementById("x-messages-page");e&&"none"!==e.style.display?await pc():vn("messages")}}catch(n){console.error("❌ 触发陌生人自动发消息失败:",n)}}async function ed(n,t,o){try{console.log(`📨 角色 ${t.xName} 正在自动发消息...`);const a=await vl(n,!0,{isAutoMessage:!0,timeSinceLastMessage:Math.floor(o)});if(!a||0===a.length)return void console.warn("自动发消息生成失败，无新消息");const i=e(),r=`messageConversation_${vt||"main"}_${n.id}`,s=await i.xAccountProfiles.get(r);if(s&&s.data){a.forEach(n=>{n.timestamp||(n.timestamp=(new Date).toISOString())}),s.data.messages.push(...a),s.updatedAt=(new Date).toISOString(),await i.xAccountProfiles.put(s),console.log(`✅ 自动消息已保存: ${a.length}条`);try{await Ml(n,s.data.messages)}catch(n){console.error("New Tweet 检测失败:",n)}if(mn("en"===Hn?`${t.xName} sent you ${a.length} message(s)`:`${t.xName} 向你发送了 ${a.length} 条私信`,"info"),Al&&Al.id===n.id){const n=document.getElementById("message-detail-content");if(n){let e=n.querySelectorAll(".message-item").length;a.forEach(t=>{const o=Bl(t,!1,e);n.appendChild(o),e++})}}try{const t=e(),o=`messagesList_${vt||"main"}`,i=await t.xAccountProfiles.get(o);if(i&&i.data){const e=i.data,r=e.findIndex(e=>e.id===n.id);-1!==r&&(e[r].unread=!0,e[r].unreadCount=(e[r].unreadCount||0)+a.length,await t.xAccountProfiles.put({handle:o,name:"messagesList",data:e,updatedAt:(new Date).toISOString()}),dc=e,console.log("✅ 已标记私信为未读"))}}catch(n){console.error("更新未读状态失败:",n)}const o=document.getElementById("x-messages-page");o&&"none"!==o.style.display?await pc():vn("messages")}}catch(n){console.error("❌ 触发自动发消息失败:",n)}}n.lastAutoMessageTrigger=Yc,n.lastAutoTweetTrigger=Wc,n.resetAutoMessageTrigger=function(n){n&&Yc[n]&&(delete Yc[n],console.log(`🔄 已重置角色 ${n} 的自动发消息触发记录`)),n&&Wc[n]&&(delete Wc[n],console.log(`🔄 已重置角色 ${n} 的自动发推触发记录`))},n.loadMessagesList=pc,n.openNewMessageModal=async function(){console.log("📨 打开新建私信弹窗");try{const n=t(),o=e(),a=`xSettings_${vt||"main"}`,i=await o.xSettings.get(a),r=i?.boundCharacters||[];console.log(`📨 绑定角色数: ${r.length}`);const s=(await n.chats.toArray()).filter(n=>!n.isGroup&&r.includes(n.id)),l=[];for(const n of s){const e=await o.xCharacterProfiles.get(n.id);e&&l.push({id:n.id,name:n.name,xProfile:e})}console.log(`📨 可选择角色数: ${l.length}`),function(n){const e=document.createElement("div");e.id="new-message-modal",e.style.cssText="\n display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--x-modal-overlay); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px);\n",e.innerHTML=`\n <div class="modal-content" onclick="event.stopPropagation()" style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 500px; max-height: 70vh; overflow: hidden; border: 1px solid var(--x-border-color); ">\n\n <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--x-border-color); background-color:var(--x-bg-primary); ">\n <div style="display: flex; align-items: center; gap: 20px;">\n\n <div class="modal-close-btn" onclick="closeNewMessageModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n\n <h2 style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin: 0; ">新建私信</h2>\n </div>\n </div>\n\n <div class="modal-body" style="padding: 16px 20px; overflow-y: auto; max-height: calc(70vh - 80px); ">\n\n <div style="color:var(--x-text-secondary); font-size: 14px; margin-bottom: ${n.length>0?"16px":"8px"}; line-height: 1.4; ">\n ${n.length>0?"选择要发送私信的角色":"暂无可用角色，可以创建粉丝群"}\n </div>\n\n <div id="new-message-characters-list" style="display: flex; flex-direction: column; gap: 0; ">\n ${n.map(n=>`\n <div class="character-select-item" data-character-id="${n.id}" onclick="selectCharacterForMessage('${n.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n\n <img src="${n.xProfile.xAvatar}"\n alt="${n.xProfile.xName}"\n style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; object-fit: cover; ">\n\n <div style="flex: 1; min-width: 0;">\n <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px; ">\n <span style="font-size: 15px; font-weight: 700; color:var(--x-text-primary); ">${n.xProfile.xName}</span>\n ${n.xProfile.xVerified?'\n <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; fill: var(--x-accent);">\n <path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-2.5-1.668c-.326-.217-.413-.656-.196-.982.217-.326.656-.414.982-.196l1.875 1.25 3.75-5.625c.22-.33.66-.418.99-.196.33.22.418.66.196.99z"/>\n </svg>\n ':""}\n </div>\n <div style="font-size: 15px; color:var(--x-text-secondary); ">@${n.xProfile.xHandle}</div>\n </div>\n </div>\n `).join("")}\n </div>\n ${n.length>0?'\n\n <div style="height: 1px; background-color: var(--x-border-color); margin: 16px 0; "></div>\n ':""}\n\n <div onclick="createFanGroup()" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; border: 2px dashed var(--x-border-color); " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'; this.style.borderColor='var(--x-accent)'"\n onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='var(--x-border-color)'">\n\n <div style="width: 40px; height: 40px; border-radius: 50%; background-color:var(--x-bg-secondary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; ">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-accent);">\n <g><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></g>\n </svg>\n </div>\n\n <div style="flex: 1; min-width: 0;">\n <div style="font-size: 15px; font-weight: 700; color:var(--x-text-primary); margin-bottom: 2px; ">创建粉丝群</div>\n <div style="font-size: 13px; color:var(--x-text-secondary); ">与你的粉丝群组互动</div>\n </div>\n </div>\n </div>\n </div>\n`;const t=document.getElementById("x-social-screen");t?t.appendChild(e):document.body.appendChild(e);e.addEventListener("click",n=>{n.target===e&&uc()})}(l)}catch(n){console.error("打开新建私信弹窗失败:",n),mn("打开弹窗失败","error")}},n.startAutoMessageSystem=Jc,n.stopAutoMessageSystem=Kc,n.closeNewMessageModal=uc,n.selectCharacterForMessage=async function(n){console.log("📨 选择角色创建私信:",n);try{const o=t(),a=e(),i=await o.chats.get(n),r=await a.xCharacterProfiles.get(n);if(!i||!r)return void mn("无法获取角色信息","error");if(-1===dc.findIndex(e=>e.id===`msg_${n}`)){const e={id:`msg_${n}`,userName:r.xName,userHandle:r.xHandle,userAvatar:r.xAvatar,lastMessage:"",timestamp:(new Date).toISOString(),unread:!1};dc.unshift(e),console.log("✅ 已添加新私信:",e);try{const n=`messagesList_${vt||"main"}`;await a.xAccountProfiles.put({handle:n,name:"messagesList",data:dc,updatedAt:(new Date).toISOString()}),console.log("✅ 私信列表已保存到数据库")}catch(n){console.error("保存私信列表失败:",n)}}else console.log("⚠️ 该角色的私信已存在");uc(),gc(dc),mn(`已添加与 ${r.xName} 的私信`,"success")}catch(n){console.error("选择角色失败:",n),mn("操作失败","error")}},console.log("✅ 全局接口已暴露");const td=["https://i.postimg.cc/CLJM9Wgg/4af1071dfec6baab460e61e9eeb280f2.jpg","https://i.postimg.cc/fyNThsyJ/ff606a3597bbf3eaab3f0dbc4366cfac.jpg","https://i.postimg.cc/C5LX8r6c/90502cdcef619816182a5e03e7de5592.jpg","https://i.postimg.cc/QxCvxPTn/53551999bb82fecf909ea84947dd008c.jpg","https://i.postimg.cc/y8S50Znm/f26c037c7785d0cdd3e371ebdce85df7.jpg","https://i.postimg.cc/sDKfbtrD/4e7fc081056f2f475ed481e27ddfcd4a.jpg","https://i.postimg.cc/65z6FDX6/27fce0a614e984e577264e58b25b0da5.jpg","https://i.postimg.cc/65z6FDXp/931f9cc4c1bf7a0f1ee7b4fdfa334c5d.jpg","https://i.postimg.cc/hPM4NHBS/5747a13122e4366828c95e673bcefba6.jpg","https://i.postimg.cc/yYn62wHN/8700fba519fec2eccbeaa00e3b8996a9.jpg"];n.openArticlePage=function(n){console.log("📰 [文章查看] 打开文章页面",n),od=n;const e=td[Math.floor(Math.random()*td.length)];document.getElementById("article-cover").style.backgroundImage=`url('${e}')`;const t=document.getElementById("article-title");t.textContent=n.title||"无标题";/[a-zA-Z]/.test(n.title)?t.classList.add("article-title-en"):t.classList.remove("article-title-en"),document.getElementById("article-author").textContent=n.author||"佚名",document.getElementById("article-source").textContent=n.source||"未知来源";const o=document.getElementById("article-body");let a=n.body||n.description||"";a=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),a=a.replace(/__(.*?)__/g,"<em>$1</em>"),o.innerHTML=a,document.getElementById("x-article-page").style.display="flex",console.log("✅ [文章查看] 文章页面已打开")},n.closeArticlePage=function(){document.getElementById("x-article-page").style.display="none",console.log("✅ [文章查看] 文章页面已关闭")};let od=null;n.shareArticle=function(){console.log("📤 [文章转发] 打开转发弹窗"),od?async function(){try{const n=e(),t=`messagesList_${vt||"main"}`,o=await n.xAccountProfiles.get(t),a=o?.data||[];if(0===a.length)return void mn("暂无私信联系人","info");const i=document.createElement("div");i.id="share-article-modal",i.style.cssText="\n display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--x-modal-overlay); z-index: 22; align-items: center; justify-content: center; backdrop-filter: blur(4px); ",i.innerHTML=`\n <div class="modal-content" onclick="event.stopPropagation()" style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; border: 1px solid var(--x-border-color); display: flex; flex-direction: column; ">\n\n <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--x-border-color); background-color:var(--x-bg-primary); ">\n <div style="display: flex; align-items: center; gap: 20px;">\n\n <div class="modal-close-btn" onclick="closeShareArticleModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n\n <h2 style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin: 0; ">转发文章</h2>\n </div>\n </div>\n\n <div class="modal-body" style="padding: 16px 20px; overflow-y: auto; flex: 1; ">\n\n <div style="padding: 12px; background-color:var(--x-bg-secondary); border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--x-border-color); ">\n <div style="font-size: 15px; font-weight: 600; color:var(--x-text-primary); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${od?.title||"无标题"}</div>\n <div style="font-size: 13px; color:var(--x-text-secondary); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; ">${od?.description||""}</div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-secondary); font-size: 13px; margin-bottom: 8px; ">附加文字（可选）</label>\n <textarea id="share-article-message" placeholder="添加一些说明..." style="width: 100%; min-height: 80px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); padding: 12px; font-size: 15px; resize: vertical; outline: none; box-sizing: border-box; font-family: inherit; " onfocus="this.style.borderColor='var(--x-accent)'" onblur="this.style.borderColor='var(--x-border-color)'"></textarea>\n </div>\n\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-bottom: 12px; ">选择要转发到的联系人</div>\n\n <div id="share-article-contacts-list" style="display: flex; flex-direction: column; gap: 0; ">\n ${a.map(n=>`\n <div class="contact-select-item" data-contact-id="${n.id}" onclick="selectContactForShare('${n.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n\n <img src="${n.userAvatar}"\n alt="${n.userName}"\n style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; object-fit: cover; ">\n\n <div style="flex: 1; min-width: 0;">\n <div style="font-size: 15px; font-weight: 700; color:var(--x-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${n.userName}</div>\n <div style="font-size: 13px; color:var(--x-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">@${n.userHandle}</div>\n </div>\n </div>\n `).join("")}\n </div>\n </div>\n </div>\n `;const r=document.getElementById("x-social-screen");r?r.appendChild(i):document.body.appendChild(i),i.addEventListener("click",n=>{n.target===i&&closeShareArticleModal()})}catch(n){console.error("显示转发弹窗失败:",n),mn("打开转发失败","error")}}():mn("无法获取文章信息","error")},n.closeShareArticleModal=function(){const n=document.getElementById("share-article-modal");n&&n.remove()},n.selectContactForShare=async function(n){console.log("📤 [文章转发] 转发到联系人:",n);try{const t=e(),o=document.getElementById("share-article-message"),a=o?o.value.trim():"",i=new Date,r=i.getHours(),s=String(i.getMinutes()).padStart(2,"0"),l=`${r>12?r-12:r}:${s} ${r>=12?"下午":"上午"}`,c={type:"link",url:od.source||"",title:od.title,description:od.description||"",author:od.author,source:od.source,body:od.body,time:l,timestamp:i.toISOString(),isOwn:!0},d=`messageConversation_${vt||"main"}_${n}`;let p=await t.xAccountProfiles.get(d);if(p||(p={handle:d,name:"messageConversation",data:{messages:[]},messageId:n,accountId:vt||"main",updatedAt:(new Date).toISOString()}),p.data.messages||(p.data.messages=[]),p.data.messages.push(c),a){const n={type:"text",content:a,time:l,timestamp:i.toISOString(),isOwn:!0};p.data.messages.push(n)}const g=p.data.messages.length-1;g>=0&&(p.data.messages[g].waitingForAIResponse=!0),p.updatedAt=(new Date).toISOString(),await t.xAccountProfiles.put(p);const m=`messagesList_${vt||"main"}`,x=await t.xAccountProfiles.get(m);if(x&&x.data){const e=x.data,o=e.findIndex(e=>e.id===n);if(-1!==o){e[o].lastMessage=a||"[链接]",e[o].timestamp=i.toISOString();const n=e.splice(o,1)[0];e.unshift(n),await t.xAccountProfiles.put({handle:m,name:"messagesList",data:e,updatedAt:(new Date).toISOString()}),dc=e}}closeShareArticleModal(),closeArticlePage();const u=document.getElementById("x-message-detail-page");if(u&&"none"!==u.style.display){if(u.dataset.conversationId===n){const e=`messagesList_${vt||"main"}`,o=await t.xAccountProfiles.get(e);if(o&&o.data){const e=o.data.find(e=>e.id===n);e&&await loadMessageDetail({id:e.id,user:{name:e.userName,handle:e.userHandle,avatar:e.userAvatar}})}}}mn("文章已转发","success"),console.log("✅ [文章转发] 转发成功")}catch(n){console.error("转发文章失败:",n),mn("转发失败","error")}};let ad=null;n.showShareContentModal=async function(n,t){console.log("📤 [内容转发] 准备转发:",t,n),ad={...n,contentType:t};try{const o=e(),a=`messagesList_${vt||"main"}`,i=await o.xAccountProfiles.get(a),r=i?.data||[];if(0===r.length)return void mn("暂无私信联系人","info");const s=document.createElement("div");s.id="share-content-modal",s.style.cssText="\n display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--x-modal-overlay); z-index: 22; align-items: center; justify-content: center; backdrop-filter: blur(4px); ";let l="";("tweet"===t||"comment"===t)&&(l=`\n <div style="padding: 12px; background-color:var(--x-bg-secondary); border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--x-border-color); ">\n <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">\n <img src="${n.user.avatar}" style="width: 32px; height: 32px; border-radius: 50%;" alt="${n.user.name}">\n <div>\n <div style="font-size: 14px; font-weight: 600; color:var(--x-text-primary);">${n.user.name}</div>\n <div style="font-size: 12px; color:var(--x-text-secondary);">${n.user.handle}</div>\n </div>\n </div>\n <div style="font-size: 14px; color:var(--x-text-primary); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-height: 1.4; ">${n.content||"无内容"}</div>\n </div>\n `),s.innerHTML=`\n <div class="modal-content" onclick="event.stopPropagation()" style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; border: 1px solid var(--x-border-color); display: flex; flex-direction: column; ">\n\n <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--x-border-color); background-color:var(--x-bg-primary); ">\n <div style="display: flex; align-items: center; gap: 20px;">\n\n <div class="modal-close-btn" onclick="closeShareContentModal()" style="cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--x-text-primary);">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n\n <h2 style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin: 0; ">转发${"tweet"===t?"推文":"评论"}</h2>\n </div>\n </div>\n\n <div class="modal-body" style="padding: 16px 20px; overflow-y: auto; flex: 1; ">\n\n ${l}\n\n <div style="margin-bottom: 16px;">\n <label style="display: block; color:var(--x-text-secondary); font-size: 13px; margin-bottom: 8px; ">附加文字（可选）</label>\n <textarea id="share-content-message" placeholder="添加一些说明..." style="width: 100%; min-height: 80px; background-color:var(--x-bg-secondary); border: 1px solid var(--x-border-color); border-radius: 12px; color:var(--x-text-primary); padding: 12px; font-size: 15px; resize: vertical; outline: none; box-sizing: border-box; font-family: inherit; " onfocus="this.style.borderColor='var(--x-accent)'" onblur="this.style.borderColor='var(--x-border-color)'"></textarea>\n </div>\n\n <div style="color:var(--x-text-secondary); font-size: 13px; margin-bottom: 12px; ">选择要转发到的联系人</div>\n\n <div id="share-content-contacts-list" style="display: flex; flex-direction: column; gap: 0; ">\n ${r.map(n=>`\n <div class="contact-select-item" data-contact-id="${n.id}" onclick="selectContactForContentShare('${n.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n\n <img src="${n.userAvatar}"\n alt="${n.userName}"\n style="width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; object-fit: cover; ">\n\n <div style="flex: 1; min-width: 0;">\n <div style="font-size: 15px; font-weight: 700; color:var(--x-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">${n.userName}</div>\n <div style="font-size: 13px; color:var(--x-text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ">@${n.userHandle}</div>\n </div>\n </div>\n `).join("")}\n </div>\n </div>\n </div>\n `;const c=document.getElementById("x-social-screen");c?c.appendChild(s):document.body.appendChild(s),s.addEventListener("click",n=>{n.target===s&&closeShareContentModal()})}catch(n){console.error("显示转发弹窗失败:",n),mn("打开转发失败","error")}},n.closeShareContentModal=function(){const n=document.getElementById("share-content-modal");n&&n.remove(),ad=null},n.selectContactForContentShare=async function(n){if(!ad)return void mn("转发数据丢失","error");console.log("📤 [内容转发] 转发到联系人:",n);const t={...ad};try{const o=e(),a=document.getElementById("share-content-message"),i=a?a.value.trim():"",r=new Date,s=r.getHours(),l=String(r.getMinutes()).padStart(2,"0"),c=`${s>12?s-12:s}:${l} ${s>=12?"下午":"上午"}`,d={type:"forward",forwardType:t.contentType,forwardContent:{user:t.user,content:t.content,time:t.time,image:t.image||null},fullContext:{},time:c,timestamp:r.toISOString(),isOwn:!0};"tweet"===t.contentType?d.fullContext={tweet:t.fullTweet||{user:t.user,content:t.content,time:t.time,image:t.image},comments:t.comments||[]}:"comment"===t.contentType&&(d.fullContext={comment:{user:t.user,content:t.content,time:t.time,image:t.image},parentTweet:t.parentTweet||null});const p=`messageConversation_${vt||"main"}_${n}`;let g=await o.xAccountProfiles.get(p);if(g||(g={handle:p,name:"messageConversation",data:{messages:[]},messageId:n,accountId:vt||"main",updatedAt:(new Date).toISOString()}),g.data.messages||(g.data.messages=[]),g.data.messages.push(d),i){const n={type:"text",content:i,time:c,timestamp:r.toISOString(),isOwn:!0};g.data.messages.push(n)}const m=g.data.messages.length-1;m>=0&&(g.data.messages[m].waitingForAIResponse=!0),g.updatedAt=(new Date).toISOString(),await o.xAccountProfiles.put(g);const x=`messagesList_${vt||"main"}`,u=await o.xAccountProfiles.get(x);if(u&&u.data){const e=u.data,a=e.findIndex(e=>e.id===n);if(-1!==a){e[a].lastMessage=i||`[转发了${"tweet"===t.contentType?"推文":"评论"}]`,e[a].timestamp=r.toISOString();const n=e.splice(a,1)[0];e.unshift(n),await o.xAccountProfiles.put({handle:x,name:"messagesList",data:e,updatedAt:(new Date).toISOString()}),dc=e}}closeShareContentModal();const h=document.getElementById("x-message-detail-page");if(h&&"none"!==h.style.display){if(h.dataset.conversationId===n){const e=`messagesList_${vt||"main"}`,t=await o.xAccountProfiles.get(e);if(t&&t.data){const e=t.data.find(e=>e.id===n);e&&await loadMessageDetail({id:e.id,user:{name:e.userName,handle:e.userHandle,avatar:e.userAvatar}})}}}mn(("tweet"===t.contentType?"推文":"评论")+"已转发","success"),console.log("✅ [内容转发] 转发成功")}catch(n){console.error("转发失败:",n),mn("转发失败","error")}},n.renderXSocialScreenProxy=Xs,n.switchXPage=u,n.switchHomeTab=function(n){a(".x-tab","active"),i(".x-tab","color","#71767b"),o(".tab-indicator"),o(".tab-content");const e=document.querySelectorAll(".x-tab"),t="for-you"===n?0:1,r="for-you"===n?"for-you-content":"following-content";e[t]&&(e[t].classList.add("active"),e[t].style.color="#fff",e[t].querySelector(".tab-indicator").style.display="block");const s=document.getElementById(r);s&&(s.style.display="flex")},n.refreshXTweets=xn,n.showTweetComments=async function(n){console.log("📖 [首页推文] 点击评论按钮，推文ID:",n);let e=P.find(e=>e.id===n);if(e||(e=D.find(e=>e.id===n)),!e)return console.error("❌ [首页推文] 未找到推文:",n),void mn("未找到该推文","error");await io(e)},n.submitComment=dn,n.handleCommentInput=function(n){const e=n.target,t=document.getElementById("reply-btn");e.value.trim().length>0?(t.style.opacity="1",t.disabled=!1):(t.style.opacity="0.5",t.disabled=!0),"Enter"!==n.key||n.shiftKey||(n.preventDefault(),e.value.trim().length>0&&dn())},n.autoResize=function(n){n.style.height="20px",n.style.height=Math.min(n.scrollHeight,120)+"px";const e=document.getElementById("reply-btn");n.value.trim().length>0?(e.style.opacity="1",e.disabled=!1):(e.style.opacity="0.5",e.disabled=!0)},n.showReplyInput=function(n,e){document.querySelectorAll(".reply-input-container").forEach(n=>{n.style.display="none"});const t=document.getElementById(`reply-input-${n}`);if(t){t.style.display="block";t.querySelector("textarea").focus()}},n.cancelReply=pn,n.submitReply=gn,n.handleReplyInput=function(n,e,t){const o=n.target,a=document.getElementById(`reply-btn-${e}`);o.value.trim().length>0?(a.style.opacity="1",a.disabled=!1):(a.style.opacity="0.5",a.disabled=!0),"Enter"!==n.key||n.shiftKey||(n.preventDefault(),o.value.trim().length>0&&gn(e,t))},n.autoResizeReply=function(n,e){n.style.height="20px",n.style.height=Math.min(n.scrollHeight,80)+"px";const t=document.getElementById(`reply-btn-${e}`);n.value.trim().length>0?(t.style.opacity="1",t.disabled=!1):(t.style.opacity="0.5",t.disabled=!0)},n.toggleLike=toggleLike,n.toggleCommentLike=function(n,e){const t="true"===e.dataset.liked,o=parseInt(e.dataset.likes),a=e.querySelector(".like-icon"),i=e.querySelector(".like-count");t?(e.dataset.liked="false",e.dataset.likes=(o-1).toString(),e.classList.remove("liked"),i.textContent=(o-1).toString()):(e.dataset.liked="true",e.dataset.likes=(o+1).toString(),e.classList.add("liked"),i.textContent=(o+1).toString(),a.classList.add("like-animation"),setTimeout(()=>{a.classList.remove("like-animation")},600))},n.deleteUserComment=async function(n){if(!confirm("确定要删除这条评论吗？"))return;const t=document.querySelector(`[data-comment-id="${n}"]`);if(t){t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="0",t.style.transform="translateX(-20px)",setTimeout(()=>{t.remove(),mn("评论已删除","success")},300);const o=(n,e)=>n.filter(n=>n.id!==e&&(n.replies&&n.replies.length>0&&(n.replies=o(n.replies,e)),!0));try{const t=sessionStorage.getItem("currentTweetData");if(t){const a=JSON.parse(t);if(a.comments){a.comments=o(a.comments,n),sessionStorage.setItem("currentTweetData",JSON.stringify(a));const t=document.querySelector(".tweet-stats .comment-count");if(t){const n=parseInt(t.textContent)||0;n>0&&(t.textContent=n-1)}const i=e(),r=await i.xTweetsData.get("tweets");if(r){if(r.forYouTweets){const e=r.forYouTweets.findIndex(n=>n.id===a.id);-1!==e&&(r.forYouTweets[e].comments=o(r.forYouTweets[e].comments||[],n),P[e]=r.forYouTweets[e])}if(r.followingTweets){const e=r.followingTweets.findIndex(n=>n.id===a.id);-1!==e&&(r.followingTweets[e].comments=o(r.followingTweets[e].comments||[],n),D[e]=r.followingTweets[e])}await i.xTweetsData.put(r)}if(a.id.startsWith("user_")){const e=`userTweets_${vt||"main"}`,t=await i.xUserTweets.get(e);if(t&&t.tweets){const e=t.tweets.findIndex(n=>n.id===a.id);-1!==e&&(t.tweets[e].comments=o(t.tweets[e].comments||[],n),await i.xUserTweets.put(t))}}console.log("评论已从数据库中删除:",n)}}else if(cn){const t=[...P,...D].find(n=>n.id===cn);if(t&&t.comments){t.comments=o(t.comments,n),t.stats.comments=Math.max(0,(t.stats.comments||0)-1);const a=P.findIndex(n=>n.id===t.id);if(-1!==a)P[a]=t;else{const n=D.findIndex(n=>n.id===t.id);-1!==n&&(D[n]=t)}const i=e();await i.xTweetsData.put({id:"tweets",forYouTweets:P,followingTweets:D,lastUpdated:(new Date).toISOString()}),console.log("主页评论已从数据库中删除:",n)}}}catch(n){console.error("删除评论数据失败:",n),mn("删除评论失败，请重试","error")}}},n.showSensitiveContent=function(n){const e=document.querySelector(`#media-${n} .sensitive-overlay`),t=document.getElementById(`content-${n}`);e&&(e.style.display="none"),t&&(t.style.filter="none")},n.handleQuotedTweetClick=function(n){mn(`点击了引用的 ${n} 的内容`,"info")},n.handleQuoteRetweetFromData=async function(n,t){let o=null;if("tweet"===n){if(o=[...P,...D].find(n=>n.id===t),!o)try{const n=e(),a=`userTweets_${vt||"main"}`,i=await n.xUserTweets.get(a);i&&i.tweets&&(o=i.tweets.find(n=>n.id===t))}catch(n){console.error("查找用户推文失败:",n)}if(!o){const n=sessionStorage.getItem("currentTweetData");if(n)try{const e=JSON.parse(n);e.id===t&&(o=e)}catch(n){console.error("解析详情页推文数据失败:",n)}}}else"comment"===n&&(o=await async function(n){const t=document.querySelector(`[data-comment-id="${n}"]`);if(t)try{const e=t.querySelector(".tweet-user-name").textContent,o=t.querySelector(".tweet-user-handle").textContent,a=t.querySelector(".tweet-avatar").src,i=null!==t.querySelector(".tweet-verified"),r=t.querySelector(".comment-content");let s="";if(r){const n=r.cloneNode(!0),e=n.querySelector(".reply-to");e&&e.remove(),s=n.textContent.trim()}const l=t.querySelector(".tweet-time");return{id:n,user:{name:e,handle:o,avatar:a,verified:i},content:s,time:l?l.textContent.replace("·","").trim():"刚刚"}}catch(n){console.error("从DOM提取评论信息失败:",n)}const o=[...P,...D];for(const e of o)if(e.comments)for(const t of e.comments){if(t.id===n)return t;if(t.replies)for(const e of t.replies)if(e.id===n)return e}const a=sessionStorage.getItem("currentTweetData");if(a){const e=c.safeParseJSON(a);if(e&&e.comments)for(const t of e.comments){if(t.id===n)return t;if(t.replies)for(const e of t.replies)if(e.id===n)return e}}try{const t=e(),o=await t.xUserTweets.get("userTweets");if(o&&o.tweets)for(const e of o.tweets)if(e.comments)for(const t of e.comments){if(t.id===n)return t;if(t.replies)for(const e of t.replies)if(e.id===n)return e}}catch(n){c.handleError(n,"查找用户推文评论")}return null}(t));if(!o)return void mn("无法找到要引用的内容","error");let a=null;o.media&&o.media.length>0?("description"===o.media[0].type||"image"===o.media[0].type)&&(a={type:"description",content:o.media[0].description}):o.image&&(a=o.image),So(n,t,o.user.name,o.user.handle,o.user.avatar,o.user.verified,o.content||"",o.time,a,o.link||null,o.location||null)},n.openComposeTweetModal=Ft,n.closeComposeTweetModal=Xt,n.publishTweet=async function(){const t=document.getElementById("compose-text-input").value.trim();if(!t)return void mn("请输入推文内容","error");if("business"===Ot&&!_t)return void mn("请选择要完成的商业任务","error");const o={id:"user_"+Date.now(),content:t,image:to(),location:oo(),link:ao(),timestamp:new Date,user:{name:n.userProfileData.name,handle:n.userProfileData.handle,avatar:n.userProfileData.avatar,verified:n.userProfileData.verified},stats:{comments:0,retweets:0,likes:0,views:0},comments:[],privacy:Ot};"business"===Ot&&(o.businessTransferId=_t,o.isBusinessPost=!0),void 0!==Io&&Io&&(o.quotedTweet={type:Io.type,user:{name:Io.user.name,handle:Io.user.handle,avatar:Io.user.avatar,verified:Io.user.verified},content:Io.content,time:Io.time,image:Io.image||null,link:Io.link||null,location:Io.location||null}),void 0!==n.currentQuoteFanGroup&&n.currentQuoteFanGroup&&(o.quotedFanGroup={id:n.currentQuoteFanGroup.id,name:n.currentQuoteFanGroup.name,avatar:n.currentQuoteFanGroup.avatar,memberCount:n.currentQuoteFanGroup.memberCount,threshold:n.currentQuoteFanGroup.threshold},console.log("📤 [发帖] 已添加粉丝群引用到推文数据:",o.quotedFanGroup)),console.log("推文数据:",o),Xt(),await async function(n){try{const t=e(),o=`userTweets_${vt||"main"}`;let a=await t.xUserTweets.get(o);a||(a={id:o,tweets:[]}),n.accountId=vt||"main",a.tweets.unshift(n),await t.xUserTweets.put(a),console.log("用户推文已保存到账户:",vt,n)}catch(n){console.error("保存用户推文失败:",n)}}(o),"none"!==document.getElementById("x-profile-page").style.display&&$o(),io(o),mn(Io?"引用转发已发布！":"发帖成功！","success"),"business"===Ot?(mn("正在提交任务成果...","info"),await async function(n,t){try{console.log("💼 [商业推贴] 开始处理任务提交");const o=e(),a=`businessTransfers_${vt||"main"}`,i=await o.xAccountProfiles.get(a);if(!i||!i.data)return void console.error("❌ 未找到商业转账数据");const r=i.data.find(n=>n.transferId===t);if(!r)return void console.error("❌ 未找到对应的商业转账");console.log("✅ [商业推贴] 找到商业转账:",r);const s=`messageConversation_${vt||"main"}_${r.conversationId}`,l=await o.xAccountProfiles.get(s);if(!l)return console.error("❌ 未找到对话信息"),void mn("无法找到对应的对话，请手动联系对方","error");console.log("✅ [商业推贴] 找到对话:",l);const c={id:r.conversationId,user:{name:r.senderName,handle:r.senderHandle,avatar:r.senderAvatar,verified:!1}};await async function(n,t,o){try{console.log("🤖 [商业任务评估] 开始AI评估流程"),console.log("📝 [商业任务评估] 步骤1：生成AI评论...");const a={...n,_isBusinessPost:!0,_businessTransferId:t.transferId,_taskDescription:t.taskDescription};await mo(a),setTimeout(async()=>{console.log("💬 [商业任务评估] 步骤2：发送AI评估私信..."),Rl({title:"X",message:`${o.user.name} 正在评估你的任务完成情况...`,avatar:o.user.avatar,leftIcon:"x"}),await async function(n,t,o){try{console.log("💼 [AI评估] 开始生成评估私信");const a={isBusinessTaskEvaluation:!0,tweetData:n,businessTransfer:t},i={id:o.id,user:o.user},r=await vl(i,!0,{isAutoMessage:!0,businessTaskEvaluation:a});if(!r||0===r.length)return void console.error("❌ [AI评估] 未生成评估消息");console.log("✅ [AI评估] 生成了评估消息:",r);const s=e(),l=`messageConversation_${vt||"main"}_${o.id}`,c=await s.xAccountProfiles.get(l);if(c&&c.data){r.forEach(n=>{c.data.messages.push({...n,isOwn:!1,timestamp:(new Date).toISOString()})}),await s.xAccountProfiles.put(c),console.log("✅ [AI评估] 评估消息已保存到数据库");const n=r.filter(n=>"transfer"===n.type);if(n.length>0)for(const e of n)await co(e,t,o);setTimeout(()=>{Rl({title:"X",message:`${o.user.name} 已完成任务评估`,avatar:o.user.avatar,leftIcon:"x"})},1e3)}}catch(n){console.error("❌ [AI评估] 生成评估私信失败:",n)}}(n,t,o)},3e3)}catch(n){console.error("❌ [商业任务评估] 失败:",n),mn("任务评估失败: "+n.message,"error")}}(n,r,c)}catch(n){console.error("❌ [商业推贴] 处理失败:",n),mn("提交失败: "+n.message,"error")}}(o,_t)):"public"===Ot&&(mn("正在等待回复...","info"),await mo(o),o.quotedFanGroup&&(console.log("📤 [粉丝群] 检测到粉丝群引用推文，准备触发申请生成器"),setTimeout(async()=>{await Nc(o)},2e3)))},n.handleComposeInput=function(){qt(),Vt(),Gt()},n.processHashtagsAndMentions=Gt,n.toggleImageSection=Yt,n.selectImageMethod=function(n){const e=document.getElementById("img-desc-btn"),t=document.getElementById("img-upload-btn"),o=document.getElementById("image-description-input"),a=document.getElementById("image-upload-area");e.style.backgroundColor="#333",e.style.borderColor="#536471",t.style.backgroundColor="#333",t.style.borderColor="#536471",o.style.display="none",a.style.display="none","description"===n?(e.style.backgroundColor="var(--x-accent)",e.style.borderColor="var(--x-accent)",o.style.display="block"):"upload"===n&&(t.style.backgroundColor="var(--x-accent)",t.style.borderColor="var(--x-accent)",a.style.display="block")},n.triggerImageUpload=function(){document.getElementById("image-file-input").click()},n.handleImageUpload=function(n){const e=n.target.files;if(!e||0===e.length)return;if(Wt.length+e.length>4)return void mn("最多只能上传4张图片","error");const t=document.getElementById("preview-images-container"),o=document.getElementById("uploaded-image-preview");let a=0;const i=e.length;for(let n=0;n<e.length;n++){const r=e[n];if(!r.type.startsWith("image/")){mn("请选择图片文件","error");continue}if(r.size>5242880){mn("图片文件不能超过5MB","error");continue}const s=new FileReader;s.onload=function(n){const e=n.target.result;Wt.push(e);const r=document.createElement("div");r.style.cssText="position: relative; border-radius: 8px; overflow: hidden;",r.innerHTML=`\n <img src="${e}" style="width: 100%; height: 150px; object-fit: cover; display: block;" alt="预览图片">\n <div onclick="removeUploadedImage(${Wt.length-1})" style="position: absolute; top: 4px; right: 4px; background-color: rgba(0,0,0,0.7); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.9)'" onmouseout="this.style.backgroundColor='rgba(0,0,0,0.7)'">\n <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #fff;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </div>\n `,t.appendChild(r),o.style.display="block",a++,a===i&&mn(`成功上传${i}张图片`,"success")},s.readAsDataURL(r)}},n.saveImageData=function(){mn("图片数据已保存","success")},n.removeImage=function(){Jt(),Yt()},n.toggleLocationSection=Kt,n.saveLocationData=function(){document.getElementById("location-input").value.trim()?mn("位置信息已保存","success"):mn("请先输入位置信息","error")},n.removeLocation=function(){Qt(),Kt()},n.toggleLinkSection=Zt,n.saveLinkData=function(){const n=document.getElementById("link-title-input").value.trim(),e=document.getElementById("link-url-input").value.trim(),t=document.getElementById("link-description-input").value.trim();n||e||t?mn("链接信息已保存","success"):mn("请先填写链接信息","error")},n.removeLink=function(){no(),Zt()},n.triggerLinkImageUpload=function(){document.getElementById("link-image-input").click()},n.handleLinkImageUpload=function(n){const e=n.target.files[0];if(!e)return;if(!e.type.startsWith("image/"))return void mn("请选择图片文件","error");if(e.size>5242880)return void mn("图片文件不能超过5MB","error");const t=new FileReader;t.onload=function(n){const e=document.getElementById("link-image-preview");document.getElementById("link-preview-image").src=n.target.result,e.style.display="block",mn("链接首图上传成功","success")},t.readAsDataURL(e)},n.removeQuoteContent=Mo,n.togglePrivacySettings=async function(){if("public"===Ot)Ot="private";else if("private"===Ot){await async function(){try{const n=e(),t=`businessTransfers_${vt||"main"}`,o=await n.xAccountProfiles.get(t);if(console.log("🔍 [检查商业任务] 数据:",o),!o||!o.data)return console.log("🔍 [检查商业任务] 没有保存的数据"),!1;console.log("🔍 [检查商业任务] 总任务数:",o.data.length);const a=new Date,i=o.data.filter(n=>{if(console.log("🔍 [检查任务]",{direction:n.direction,taskStatus:n.taskStatus,taskDeadline:n.taskDeadline,acceptedAt:n.acceptedAt,taskDeadlineHours:n.taskDeadlineHours}),"received"!==n.direction||"in_progress"!==n.taskStatus)return!1;let e;if(n.taskDeadline)e=new Date(n.taskDeadline);else{if(!n.acceptedAt||!n.taskDeadlineHours)return console.warn("⚠️ [检查任务] 任务没有足够信息计算截止时间，仍然认为有效",n),!0;{const t=new Date(n.acceptedAt),o=parseFloat(n.taskDeadlineHours)||24;e=new Date(t.getTime()+60*o*60*1e3),console.log("⚠️ [检查任务] 动态计算截止时间:",e.toISOString())}}const t=e.getTime()>a.getTime();return console.log("🔍 [检查任务] 是否有效:",t,"截止时间:",e,"现在:",a),t});return console.log("🔍 [检查商业任务] 有效任务数:",i.length),i.length>0}catch(n){return console.error("检查商业任务失败:",n),!1}}()?Ot="business":(Ot="public",mn("当前没有待完成的商业转账任务","info"))}else Ot="public";!function(){const n=document.getElementById("privacy-icon-path"),e=document.getElementById("privacy-text");if("public"===Ot){n.setAttribute("d","M12 1.75C6.34 1.75 1.75 6.34 1.75 12S6.34 22.25 12 22.25 22.25 17.66 22.25 12 17.66 1.75 12 1.75zm-.81 14.68l-4.1-3.27 1.25-1.57 2.47 1.98 3.97-5.47 1.62 1.18-5.21 7.15z"),e.textContent="所有人可以回复",e.style.color="var(--x-accent)";const t=document.getElementById("business-task-selection");t&&(t.style.display="none"),mn("已切换为所有人可见","success")}else if("private"===Ot){n.setAttribute("d","M17.863 13.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44zM12 2C9.791 2 8 3.79 8 6s1.791 4 4 4 4-1.79 4-4-1.791-4-4-4z"),e.textContent="仅自己可见",e.style.color="var(--x-accent)";const t=document.getElementById("business-task-selection");t&&(t.style.display="none"),mn("已切换为仅自己可见","success")}else n.setAttribute("d","M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"),e.textContent="商业化推贴",e.style.color="var(--x-accent)",eo(),mn("已切换为商业化推贴","success")}()},n.editProfile=function(){Bt()},n.openEditProfileModal=Bt,n.closeEditProfileModal=Lt,n.saveProfileChanges=async function(){const o=document.getElementById("edit-user-name").value.trim(),a=document.getElementById("edit-user-handle").value.trim(),i=document.getElementById("edit-user-bio").value.trim(),r=document.getElementById("edit-custom-tag1").value.trim(),s=document.getElementById("edit-custom-tag2").value.trim(),l=document.getElementById("edit-tag1-icon").value.trim()||"✨",c=document.getElementById("edit-tag2-icon").value.trim()||"📅",d=document.getElementById("edit-tag1-color").value||"#71767b",p=document.getElementById("edit-tag2-color").value||"#71767b",g=Ht(document.getElementById("edit-following-count").value),m=Ht(document.getElementById("edit-followers-count").value),x=document.getElementById("edit-cover-image").src,u=document.getElementById("edit-main-avatar").src,h=document.getElementById("edit-verification-type").value,f=document.getElementById("edit-couple-character").value;let b="";if(f)try{const n=e(),t=await n.xCharacterProfiles.get(f);if(t)b=`@${t.xHandle}（${t.xName}）`;else{const n=document.querySelector(`#edit-couple-character option[value="${f}"]`),e=n?n.textContent:"";if(e){b=`@${e.toLowerCase().replace(/\s+/g,"_")}（${e}）`}}}catch(n){console.error("获取情侣角色X资料失败:",n);const e=document.querySelector(`#edit-couple-character option[value="${f}"]`),t=e?e.textContent:"";if(t){b=`@${t.toLowerCase().replace(/\s+/g,"_")}（${t}）`}}const v=document.getElementById("edit-public-identity").value.trim(),y=document.getElementById("edit-show-real-name").checked,w=document.getElementById("edit-real-name").value.trim();if(o)if(a)if(o.length>50)mn("名称不能超过50个字符","error");else if(a.length>15)mn("用户名不能超过15个字符","error");else if(i.length>160)mn("自我介绍不能超过160个字符","error");else if(r.length>30)mn("自定义标签1不能超过30个字符","error");else if(s.length>30)mn("自定义标签2不能超过30个字符","error");else if(g.length>20)mn("关注数量过长","error");else if(m.length>20)mn("关注者数量过长","error");else if(y&&w.length>50)mn("真实姓名不能超过50个字符","error");else if(!y||w){n.userProfileData.name=o,n.userProfileData.handle="@"+a,n.userProfileData.bio=i,n.userProfileData.customTag1=r,n.userProfileData.customTag2=s,n.userProfileData.customTag1Icon=l,n.userProfileData.customTag2Icon=c,n.userProfileData.customTag1Color=d,n.userProfileData.customTag2Color=p,n.userProfileData.following=g,n.userProfileData.followers=m,n.userProfileData.coverImage=x,n.userProfileData.avatar=u,n.userProfileData.verificationType=h,n.userProfileData.coupleCharacterId=f,n.userProfileData.coupleCharacterName=b,n.userProfileData.publicIdentity=v,n.userProfileData.showRealName=y,n.userProfileData.realName=y?w:"",n.userProfileData.verified="none"!==h,n.userProfileData.knownIdentityCharacters||(n.userProfileData.knownIdentityCharacters=[]),"couple"===h&&f&&async function(n,t){try{const o=e();let a=await o.xCharacterProfiles.get(n);a&&(a.xVerified=!0,a.verificationType="couple",a.couplePartnerName=t,await o.xCharacterProfiles.put(a),console.log(`已为角色 ${a.xName} 设置情侣认证，情侣对象: ${t}`))}catch(n){console.error("为角色设置情侣认证失败:",n)}}(f,n.userProfileData.name);try{if(console.log("📝 准备保存用户资料..."),console.log("👤 已知身份角色数:",n.userProfileData.knownIdentityCharacters?.length||0),console.log("👤 已知身份角色列表:",n.userProfileData.knownIdentityCharacters||[]),n.userProfileData.knownIdentityCharacters&&n.userProfileData.knownIdentityCharacters.length>0){const e=t(),o=await e.chats.toArray(),a=[];let i=0;for(const e of n.userProfileData.knownIdentityCharacters){const n=o.find(n=>n.id===e);n?!0!==n.isGroup&&"chat_record"!==n.isGroup?n.linkedCharacterData?i++:a.push(e):i++:i++}i>0&&(console.log(`🧹 保存前自动清理了 ${i} 个无效身份角色ID`),n.userProfileData.knownIdentityCharacters=a)}await async function(){try{const t=e(),o=vt||"main";await t.xUserProfile.put({id:o,...n.userProfileData,lastUpdated:(new Date).toISOString()});const a=await t.xAccountList.get(o);a&&(a.name=n.userProfileData.name,a.avatar=n.userProfileData.avatar,await t.xAccountList.put(a)),console.log("用户资料已保存到数据库，账户ID:",o),n.userProfileData.knownIdentityCharacters&&n.userProfileData.knownIdentityCharacters.length>0&&console.log("已知身份角色:",n.userProfileData.knownIdentityCharacters.length+"个")}catch(n){throw console.error("保存用户资料失败:",n),n}}(),dt(),pt(),gt(u),Lt();let o="个人资料已更新";n.userProfileData.knownIdentityCharacters&&n.userProfileData.knownIdentityCharacters.length>0&&(o+=`，已设置 ${n.userProfileData.knownIdentityCharacters.length} 个角色知道您的身份`),mn(o,"success"),n.userProfileData.knownIdentityCharacters&&n.userProfileData.knownIdentityCharacters.length>0&&(console.log("✅ 已保存的用户身份识别设置:",n.userProfileData.knownIdentityCharacters),console.log("✅ 这些角色现在知道您的身份，可以在X平台上与您自然互动"))}catch(n){console.error("保存个人资料失败:",n),mn("保存失败: "+n.message,"error")}}else mn("选择公开真名时必须填写真实姓名","error");else mn("用户名不能为空","error");else mn("名称不能为空","error")},n.switchProfileTab=function(n){document.querySelectorAll(".profile-tab").forEach(n=>{n.classList.remove("active"),n.style.color="#71767b",n.querySelector(".tab-indicator").style.display="none"}),document.querySelectorAll(".profile-tab-content").forEach(n=>{n.style.display="none"});const e=document.querySelector(`.profile-tab[onclick="switchProfileTab('${n}')"]`);e&&(e.classList.add("active"),e.style.color="#fff",e.querySelector(".tab-indicator").style.display="block");const t=document.getElementById(`profile-${n}-content`);t&&(t.style.display="block"),"posts"===n?$o():"highlights"===n?loadHighlights():"likes"===n&&loadLikes()},n.toggleProfileMenu=function(){const n=document.getElementById("profile-dropdown-menu"),e="none"!==n.style.display;n.style.display=e?"none":"block"},n.openAccountManager=async function(){document.getElementById("profile-dropdown-menu").style.display="none",yt()},n.openAccountWallet=async function(){document.getElementById("profile-dropdown-menu").style.display="none",await Mt(),function(){Gl&&clearInterval(Gl);Yl(),Gl=setInterval(()=>{Yl()},6e4),console.log("✅ 商业转账状态检查已启动")}(),function(){const e=document.getElementById("x-social-screen"),t=e&&e.classList.contains("x-theme-light"),o=document.createElement("div");o.id="wallet-modal",o.style.cssText=`\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: ${t?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"}; display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);\n`,o.innerHTML=`\n <div style="background-color: ${t?"rgba(255, 255, 255, 0.95)":"rgba(0, 0, 0, 0.95)"}; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; width: 90%; max-width: 360px; position: relative; overflow: hidden; box-shadow: ${t?"0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 32px rgba(0, 0, 0, 0.1)":"0 20px 60px rgba(0, 0, 0, 0.8), 0 8px 32px rgba(255, 255, 255, 0.05)"}; border: 2px solid ${t?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; " onclick="event.stopPropagation()">\n\n <div style="background: linear-gradient(135deg, ${t?"rgba(248, 250, 252, 0.8)":"rgba(22, 24, 28, 0.8)"} 0%, ${t?"rgba(255, 255, 255, 0.6)":"rgba(0, 0, 0, 0.6)"} 100%); padding: 24px; text-align: center; border-bottom: 2px solid ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; position: relative; ">\n\n <button onclick="closeWalletModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: none; color: ${t?"#536471":"#71767b"}; cursor: pointer; padding: 8px; border-radius: 50%; transition: all 0.2s; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}';"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n\n <div style="margin-bottom: 16px;">\n <img src="${n.userProfileData?.avatar||te.avatar}" style="width: 64px; height: 64px; border-radius: 50%; border: 3px solid var(--x-accent); object-fit: cover; " alt="${n.userProfileData?.name||te.name}">\n </div>\n\n <div style="color: ${t?"#0f1419":"#ffffff"}; font-size: 18px; font-weight: 700; margin-bottom: 4px; ">${n.userProfileData?.name||te.name}</div>\n\n <div style="color: ${t?"#536471":"#71767b"}; font-size: 14px; margin-bottom: 16px; ">Digital Wallet</div>\n\n <div id="wallet-status" style="display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; letter-spacing: 1px; ${It.isActivated?"background-color: rgba(34, 197, 94, 0.15); color: #22c55e; border: 2px solid rgba(34, 197, 94, 0.4);":`background-color: ${t?"rgba(156, 163, 175, 0.15)":"rgba(156, 163, 175, 0.1)"}; color: ${t?"#6b7280":"#9ca3af"}; border: 2px solid ${t?"rgba(156, 163, 175, 0.3)":"rgba(156, 163, 175, 0.2)"};`}\n ">${It.isActivated?"ACTIVATED":"INACTIVE"}</div>\n </div>\n\n <div style="padding: 24px; background-color: ${t?"rgba(255, 255, 255, 0.3)":"rgba(0, 0, 0, 0.3)"}; ">\n ${It.isActivated?function(n=!1){return`\n <div>\n\n <div style="background: linear-gradient(135deg, ${n?"rgba(248, 250, 252, 0.8)":"rgba(22, 24, 28, 0.8)"} 0%, ${n?"rgba(229, 231, 235, 0.6)":"rgba(55, 65, 81, 0.6)"} 100%); border: 2px solid ${n?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center; ">\n <div style="color: ${n?"#6b7280":"#9ca3af"}; font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; ">Balance</div>\n <div style="color: ${n?"#0f1419":"#ffffff"}; font-size: 32px; font-weight: 700; margin-bottom: 4px; ">$${It.balance.toFixed(2)}</div>\n <div style="color: ${n?"#6b7280":"#9ca3af"}; font-size: 13px; ">${It.currency}</div>\n </div>\n\n <div style="margin-bottom: 16px;">\n <div style="color: ${n?"#6b7280":"#9ca3af"}; font-size: 12px; font-weight: 600; letter-spacing: 1px; margin-bottom: 12px; text-transform: uppercase; ">Recent Activity</div>\n ${It.transactions.length>0?function(n=!1){return It.transactions.slice(0,2).map(e=>`\n <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 2px solid ${n?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; ">\n <div>\n <div style="color: ${n?"#0f1419":"#ffffff"}; font-size: 14px; font-weight: 600; margin-bottom: 2px; ">${e.description}</div>\n <div style="color: ${n?"#6b7280":"#9ca3af"}; font-size: 12px; ">${new Date(e.timestamp).toLocaleDateString()}</div>\n </div>\n <div style="color: ${e.amount>0?"#22c55e":"#ef4444"}; font-size: 14px; font-weight: 700; ">${e.amount>0?"+":""}$${Math.abs(e.amount).toFixed(2)}</div>\n </div>\n`).join("")}(n):function(n=!1){return`\n <div style="text-align: center; padding: 20px; color: ${n?"#6b7280":"#9ca3af"}; font-size: 14px; ">\n <div style="margin-bottom: 8px; opacity: 0.6;">📋</div>\n <div>No transactions yet</div>\n </div>\n`}(n)}\n </div>\n\n <div style="display: flex; gap: 12px;">\n <button onclick="showIncomeHistory()" style="flex: 1; background-color: var(--x-accent); color: ${n?"#0f1419":"#ffffff"}; border: none; border-radius: 12px; padding: 12px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; " onmouseover="this.style.backgroundColor='#1a8cd8'"\n onmouseout="this.style.backgroundColor='var(--x-accent)'">\n + Add Funds\n ${At()>0?`<span style="position: absolute; top: -2px; right: -2px; background: #22c55e; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; ">${At()}</span>`:""}\n </button>\n <button onclick="showExpenseHistory()" style="flex: 1; background-color: transparent; color: ${n?"#0f1419":"#ffffff"}; border: none; border-radius: 12px; padding: 12px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; " onmouseover="this.style.backgroundColor='${n?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}';"\n onmouseout="this.style.backgroundColor='transparent'">\n Send\n ${Et()>0?`<span style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; ">${Et()}</span>`:""}\n </button>\n </div>\n </div>\n`}(t):function(n=!1){return`\n <div style="text-align: center;">\n\n <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, ${n?"rgba(248, 250, 252, 0.8)":"rgba(22, 24, 28, 0.8)"} 0%, ${n?"rgba(229, 231, 235, 0.6)":"rgba(55, 65, 81, 0.6)"} 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 2px solid ${n?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"}; ">\n <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: ${n?"#6b7280":"#9ca3af"};">\n <g><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></g>\n </svg>\n </div>\n\n <div style="color: ${n?"#0f1419":"#ffffff"}; font-size: 16px; font-weight: 600; margin-bottom: 8px; ">激活你的数字钱包</div>\n <div style="color: ${n?"#536471":"#71767b"}; font-size: 14px; line-height: 1.5; margin-bottom: 24px; ">点击下方按钮激活钱包<br>初始金额将根据你的公众身份随机生成</div>\n\n <button id="activate-wallet-btn" onclick="activateWallet()" style="width: 100%; background: linear-gradient(135deg, var(--x-accent) 0%, #1a8cd8 100%); color: #fff; border: none; border-radius: 12px; padding: 16px 24px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(29, 155, 240, 0.3)'"\n onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">\n <span id="activate-btn-text">🚀 激活钱包</span>\n <div id="activate-btn-loader" style="display: none;">\n <svg style="animation: spin 1s linear infinite; width: 20px; height: 20px;" viewBox="0 0 24 24">\n <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.3)" stroke-width="2" fill="none"/>\n <path d="M4,12a8,8 0 1,1 16,0" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/>\n </svg>\n </div>\n </button>\n </div>\n`}(t)}\n </div>\n\n <div style="display: flex; justify-content: center; align-items: center; padding: 16px 24px; gap: 24px; border-top: 2px solid ${t?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"}; background-color: ${t?"rgba(248, 250, 252, 0.5)":"rgba(22, 24, 28, 0.5)"}; ">\n <div onclick="openBusinessTransferManager()" style="padding: 12px; border-radius: 50%; cursor: pointer; transition: all 0.2s; color: ${t?"#536471":"#71767b"}; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}'; this.style.color='var(--x-accent)';"\n onmouseout="this.style.backgroundColor='transparent'; this.style.color='${t?"#536471":"#71767b"}';" title="商业转账管理">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"></path><path d="M12 10L14.5 14L17 10L14.5 12L12 10ZM10 10L7.5 12L10 14L7.5 14L10 10Z"></path></g>\n </svg>\n </div>\n <div onclick="exportWallet()" style="padding: 12px; border-radius: 50%; cursor: pointer; transition: all 0.2s; color: ${t?"#536471":"#71767b"}; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}'; this.style.color='var(--x-accent)';"\n onmouseout="this.style.backgroundColor='transparent'; this.style.color='${t?"#536471":"#71767b"}';" title="导出钱包">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"></path></g>\n </svg>\n </div>\n <div onclick="copyWalletInfo()" style="padding: 12px; border-radius: 50%; cursor: pointer; transition: all 0.2s; color: ${t?"#536471":"#71767b"}; " onmouseover="this.style.backgroundColor='${t?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"}'; this.style.color='var(--x-accent)';"\n onmouseout="this.style.backgroundColor='transparent'; this.style.color='${t?"#536471":"#71767b"}';" title="复制钱包信息">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></g>\n </svg>\n </div>\n </div>\n </div>\n`,document.body.appendChild(o),document.body.style.overflow="hidden",o.addEventListener("click",n=>{n.target===o&&St()});const a=o.querySelector("div");a.style.transform="scale(0.8) translateY(20px)",a.style.opacity="0",requestAnimationFrame(()=>{a.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",a.style.transform="scale(1) translateY(0)",a.style.opacity="1"})}()},n.closeWalletModal=St,n.activateWallet=async function(){const e=document.getElementById("activate-wallet-btn"),t=document.getElementById("activate-btn-text"),o=document.getElementById("activate-btn-loader");t.style.display="none",o.style.display="block",e.disabled=!0,e.style.cursor="not-allowed",await new Promise(n=>setTimeout(n,2e3));try{const e=function(){const e=(n.userProfileData?.publicIdentity||"").toLowerCase(),t={celebrity:{min:1e3,max:5e3,keywords:["明星","演员","歌手","导演","艺人","celebrity","star","actor","singer"]},influencer:{min:500,max:1500,keywords:["网红","博主","主播","influencer","streamer","youtuber","blogger"]},professional:{min:200,max:800,keywords:["专家","教授","医生","律师","工程师","expert","professor","doctor","lawyer","engineer"]},business:{min:300,max:1e3,keywords:["企业家","CEO","总裁","创始人","entrepreneur","founder","executive"]},creator:{min:150,max:600,keywords:["作家","画家","设计师","摄影师","writer","artist","designer","photographer"]},regular:{min:50,max:200,keywords:[]}};for(const[n,o]of Object.entries(t)){if("regular"===n)continue;if(o.keywords.some(n=>e.includes(n))){const e=Math.random()*(o.max-o.min)+o.min;return console.log(`💰 根据身份类型 "${n}" 生成初始金额: $${e.toFixed(2)}`),Math.round(100*e)/100}}const o=t.regular,a=Math.random()*(o.max-o.min)+o.min;return console.log(`💰 默认身份生成初始金额: $${a.toFixed(2)}`),Math.round(100*a)/100}();It.isActivated=!0,It.balance=e,It.initialAmount=e,It.activatedAt=(new Date).toISOString(),It.transactions=[{id:"init_"+Date.now(),description:"Initial Deposit",amount:e,timestamp:(new Date).toISOString(),type:"deposit"}],await Tt(),function(n){St();const e=document.createElement("div");e.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 30; backdrop-filter: blur(12px);\n",e.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 24px; padding: 40px; text-align: center; border: 1px solid var(--x-border-color); max-width: 320px; width: 90%; animation: walletSuccessIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); ">\n\n <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: walletSuccessCheck 0.8s ease-in-out 0.3s both; ">\n <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: white;">\n <g><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></g>\n </svg>\n </div>\n\n <div style="color:var(--x-text-primary); font-size: 20px; font-weight: 700; margin-bottom: 8px; ">钱包激活成功！</div>\n <div style="color: #22c55e; font-size: 24px; font-weight: 700; margin-bottom: 16px; ">+$${n.toFixed(2)}</div>\n <div style="color:var(--x-text-secondary); font-size: 14px; line-height: 1.5; margin-bottom: 24px; ">恭喜！你的数字钱包已成功激活<br>初始资金已到账</div>\n\n <button onclick="this.parentElement.parentElement.remove(); document.body.style.overflow='auto'; openAccountWallet();" style="background: linear-gradient(135deg, var(--x-accent) 0%, #1a8cd8 100%); color: #fff; border: none; border-radius: 12px; padding: 12px 24px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; ">查看钱包</button>\n </div>\n`,document.body.appendChild(e),setTimeout(()=>{e.parentElement&&(e.remove(),document.body.style.overflow="auto")},3e3)}(e)}catch(n){console.error("激活钱包失败:",n),mn("钱包激活失败","error"),t.style.display="block",o.style.display="none",e.disabled=!1,e.style.cursor="pointer"}},n.addFunds=function(){showIncomeHistory()},n.sendMoney=function(){showExpenseHistory()},n.shareWallet=function(){mn("分享功能开发中...","info")},n.exportWallet=function(){mn("导出功能开发中...","info")},n.copyWalletInfo=function(){const e=`${n.userProfileData?.name||te.name||"用户"}的数字钱包\n余额: $${It.balance.toFixed(2)}\n状态: ${It.isActivated?"已激活":"未激活"}`;navigator.clipboard?navigator.clipboard.writeText(e).then(()=>{mn("钱包信息已复制","success")}).catch(()=>{mn("复制失败","error")}):mn("复制功能不支持","error")},n.updateCharacterCounts=Dt,n.toggleRealNameInput=Nt,n.updateTag1ColorFromText=function(){const n=document.getElementById("edit-tag1-color-text"),e=document.getElementById("edit-tag1-color");if(n&&e){const t=n.value.trim();t.match(/^#[0-9A-Fa-f]{6}$/)&&(e.value=t)}},n.updateTag1ColorFromPicker=function(){const n=document.getElementById("edit-tag1-color-text"),e=document.getElementById("edit-tag1-color");n&&e&&(n.value=e.value)},n.updateTag2ColorFromText=function(){const n=document.getElementById("edit-tag2-color-text"),e=document.getElementById("edit-tag2-color");if(n&&e){const t=n.value.trim();t.match(/^#[0-9A-Fa-f]{6}$/)&&(e.value=t)}},n.updateTag2ColorFromPicker=function(){const n=document.getElementById("edit-tag2-color-text"),e=document.getElementById("edit-tag2-color");n&&e&&(n.value=e.value)},n.editCoverImage=function(){const n=document.getElementById("edit-cover-image").src,e=prompt("请输入封面图片链接：",n);if(null===e)return;if(!e.trim())return void mn("请输入有效的图片链接","error");try{new URL(e)}catch(n){return void mn("请输入有效的图片链接","error")}const t=new Image;t.onload=function(){document.getElementById("edit-cover-image").src=e,mn("封面图已更新","success")},t.onerror=function(){mn("无法加载该图片，请检查链接是否正确","error")},t.src=e},n.removeCoverImage=function(){document.getElementById("edit-cover-image").src="https://i.postimg.cc/qRzMB6nQ/default-cover.jpg",mn("已移除封面图","success")},n.editAvatarImage=function(){const n=document.getElementById("edit-main-avatar").src,e=prompt("请输入头像图片链接：",n);if(null===e)return;if(!e.trim())return void mn("请输入有效的图片链接","error");try{new URL(e)}catch(n){return void mn("请输入有效的图片链接","error")}const t=new Image;t.onload=function(){document.getElementById("edit-main-avatar").src=e,mn("头像已更新","success")},t.onerror=function(){mn("无法加载该图片，请检查链接是否正确","error")},t.src=e},n.updateVerificationTypeUI=Pt,n.toggleCharacterBinding=function(){ee.characterBinding=!ee.characterBinding,pe();const n=document.getElementById("character-binding-area");ee.characterBinding?(n.style.display="block",ge()):(n.style.display="none",ee.boundCharacters||(ee.boundCharacters=[]))},n.toggleCharacterSelection=me,n.openCharacterXProfile=xe,n.closeCharacterXProfileModal=ue,n.saveCharacterXProfile=be,n.updateCharacterXAvatar=function(n){const e=document.getElementById("character-x-avatar");if(!n||""===n.trim())return void(e.src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg");try{new URL(n)}catch(n){return void(e.src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg")}[".jpg",".jpeg",".png",".gif",".webp",".bmp"].some(e=>n.toLowerCase().includes(e))||(e.onerror=function(){this.src="https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",mn("头像链接无效，已使用默认头像","warning")}),e.src=n},n.updateCharacterBioCount=he,n.toggleCharacterRealNameInput=Rt,n.openAddRelationshipModal=function(){ve=null,document.getElementById("relationship-modal-title").textContent="添加NPC关系",document.getElementById("relationship-npc-name").value="",document.getElementById("relationship-npc-handle").value="",document.getElementById("relationship-type").value="朋友",document.getElementById("relationship-description").value="",$e(),document.getElementById("relationship-modal").style.display="block"},n.editRelationship=function(n){const e=ye.find(e=>e.id===n);e&&(ve=n,document.getElementById("relationship-modal-title").textContent="编辑NPC关系",document.getElementById("relationship-npc-name").value=e.npcName,document.getElementById("relationship-npc-handle").value=e.npcHandle,document.getElementById("relationship-type").value=e.relationshipType,document.getElementById("relationship-description").value=e.description||"",$e(),document.getElementById("relationship-modal").style.display="block")},n.deleteRelationship=async function(n){if(confirm("确定要删除这个关系绑定吗？"))try{console.log("🗑️ [删除关系] 开始删除关系:",n),console.log("🗑️ [删除关系] 删除前关系数:",ye.length);const e=ye.length;ye=ye.filter(e=>e.id!==n);const t=ye.length;if(console.log("🗑️ [删除关系] 删除后关系数:",t),e===t)return console.warn("⚠️ [删除关系] 未找到要删除的关系"),void mn("未找到要删除的关系","warning");await Ce(),we(ye),mn("关系已删除","success")}catch(n){console.error("❌ [删除关系] 删除关系失败:",n),mn(`删除失败: ${n.message}`,"error")}},n.closeRelationshipModal=ke,n.updateRelationshipDescCount=$e,n.saveRelationshipForm=Ie,n.saveXSettings=se,n.saveXPreset=async function(){const n=prompt("请输入预设名称:");if(n&&""!==n.trim())try{const t={systemPrompt:document.getElementById("x-system-prompt").value,worldSetting:document.getElementById("x-world-setting").value,characterBinding:ee.characterBinding||!1,boundCharacters:ee.boundCharacters||[]},o=e();await o.xPresets.add({name:n.trim(),...t,createdAt:(new Date).toISOString()}),mn(`预设"${n}"已保存`,"success"),de()}catch(n){console.error("保存预设失败:",n),mn("保存预设失败: "+n.message,"error")}else mn("预设名称不能为空","error")},n.loadXPreset=async function(n){try{const t=e(),o=await t.xPresets.get(n);o&&(ee.systemPrompt=o.systemPrompt||"",ee.worldSetting=o.worldSetting||"",ee.characterBinding=o.characterBinding||!1,ee.boundCharacters=o.boundCharacters||[],await ae(),mn(`已加载预设"${o.name}"`,"success"))}catch(n){console.error("加载预设失败:",n),mn("加载预设失败: "+n.message,"error")}},n.deleteXPreset=async function(n){if(confirm("确定要删除这个预设吗？"))try{const t=e();await t.xPresets.delete(n),mn("预设已删除","success"),de()}catch(n){console.error("删除预设失败:",n),mn("删除预设失败: "+n.message,"error")}},n.exportXData=async function(){try{const n=e(),t={xSettings:await n.xSettings.toArray(),xUserProfile:await n.xUserProfile.toArray(),xTweetsData:await n.xTweetsData.toArray(),xUserTweets:await n.xUserTweets.toArray(),xCharacterProfiles:await n.xCharacterProfiles.toArray(),xPresets:await n.xPresets.toArray(),xAskbox:await n.xAskbox.toArray(),xActiveAccount:await n.xActiveAccount.toArray(),xAccountList:await n.xAccountList.toArray(),xNPCs:await n.xNPCs.toArray(),xAccountProfiles:await n.xAccountProfiles.toArray(),xAccountAskbox:await n.xAccountAskbox.toArray(),xBookmarks:await n.xBookmarks.toArray(),xCharacterRelationships:await n.xCharacterRelationships.toArray(),xMapDatingData:await n.xMapDatingData.toArray(),xMapUserProfile:await n.xMapUserProfile.toArray(),xMapChats:await n.xMapChats.toArray(),xMapSavedChats:localStorage.getItem("xMapSavedChats")||"[]",newspaperCachedData:localStorage.getItem("newspaperCachedData")||null,newspaperStats:localStorage.getItem("newspaperStats")||null,newspaperGenerateHistory:localStorage.getItem("newspaperGenerateHistory")||null,exportTime:(new Date).toISOString(),version:"2.2",dataType:"x-social-full-backup"},o=JSON.stringify(t,null,2),a=new Blob([o],{type:"application/json"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=`x-data-backup-${(new Date).toISOString().split("T")[0]}.json`,i.click(),mn("所有数据已导出","success"),console.log("✅ X数据导出成功，包含:",{"设置数":t.xSettings.length,"用户资料数":t.xUserProfile.length,"推文数据数":t.xTweetsData.length,"用户推文数":t.xUserTweets.length,"角色X资料数":t.xCharacterProfiles.length,"预设数":t.xPresets.length,"用户提问箱数":t.xAskbox.length,"活跃账户数":t.xActiveAccount.length,"账户列表数":t.xAccountList.length,"NPC设置数":t.xNPCs.length,"账户主页数据数":t.xAccountProfiles.length,"账户提问箱数":t.xAccountAskbox.length,"书签数":t.xBookmarks.length,"关系册数":t.xCharacterRelationships.length,"地图约会数据数":t.xMapDatingData.length,"地图用户资料数":t.xMapUserProfile.length,"地图聊天数据数":t.xMapChats.length,"保存的聊天列表数":JSON.parse(t.xMapSavedChats).length})}catch(n){console.error("❌ 导出数据失败:",n),mn("导出失败: "+n.message,"error")}},n.importXData=function(){if(!confirm("⚠️ 警告：导入数据将完全替换当前所有X数据（包括用户资料、推文、帖子、设置等），此操作不可撤销！\n\n确定要继续吗？"))return;const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async function(t){const o=t.target.files[0];if(!o)return;const a=new FileReader;a.onload=async function(t){try{const o=JSON.parse(t.target.result);if(!o||"x-social-full-backup"!==o.dataType)return void mn("导入失败: 不是有效的X数据备份文件","error");mn("正在导入数据，请稍候...","info");const a=e();await a.xSettings.clear(),await a.xUserProfile.clear(),await a.xTweetsData.clear(),await a.xUserTweets.clear(),await a.xCharacterProfiles.clear(),await a.xPresets.clear(),await a.xAskbox.clear(),await a.xActiveAccount.clear(),await a.xAccountList.clear(),await a.xNPCs.clear(),await a.xAccountProfiles.clear(),await a.xAccountAskbox.clear(),await a.xBookmarks.clear(),await a.xCharacterRelationships.clear(),await a.xMapDatingData.clear(),await a.xMapUserProfile.clear(),await a.xMapChats.clear(),localStorage.removeItem("xMapSavedChats"),localStorage.removeItem("newspaperCachedData"),localStorage.removeItem("newspaperStats"),localStorage.removeItem("newspaperGenerateHistory"),console.log("✅ 已清空旧数据"),o.xSettings&&o.xSettings.length>0&&await a.xSettings.bulkAdd(o.xSettings),o.xUserProfile&&o.xUserProfile.length>0&&await a.xUserProfile.bulkAdd(o.xUserProfile),o.xTweetsData&&o.xTweetsData.length>0&&await a.xTweetsData.bulkAdd(o.xTweetsData),o.xUserTweets&&o.xUserTweets.length>0&&await a.xUserTweets.bulkAdd(o.xUserTweets),o.xCharacterProfiles&&o.xCharacterProfiles.length>0&&await a.xCharacterProfiles.bulkAdd(o.xCharacterProfiles),o.xPresets&&o.xPresets.length>0&&await a.xPresets.bulkAdd(o.xPresets),o.xAskbox&&o.xAskbox.length>0&&await a.xAskbox.bulkAdd(o.xAskbox),o.xActiveAccount&&o.xActiveAccount.length>0&&await a.xActiveAccount.bulkAdd(o.xActiveAccount),o.xAccountList&&o.xAccountList.length>0&&await a.xAccountList.bulkAdd(o.xAccountList),o.xNPCs&&o.xNPCs.length>0&&await a.xNPCs.bulkAdd(o.xNPCs),o.xAccountProfiles&&o.xAccountProfiles.length>0&&await a.xAccountProfiles.bulkAdd(o.xAccountProfiles),o.xAccountAskbox&&o.xAccountAskbox.length>0&&await a.xAccountAskbox.bulkAdd(o.xAccountAskbox),o.xBookmarks&&o.xBookmarks.length>0&&await a.xBookmarks.bulkAdd(o.xBookmarks),o.xCharacterRelationships&&o.xCharacterRelationships.length>0&&await a.xCharacterRelationships.bulkAdd(o.xCharacterRelationships),o.xMapDatingData&&o.xMapDatingData.length>0&&await a.xMapDatingData.bulkAdd(o.xMapDatingData),o.xMapUserProfile&&o.xMapUserProfile.length>0&&await a.xMapUserProfile.bulkAdd(o.xMapUserProfile),o.xMapChats&&o.xMapChats.length>0&&await a.xMapChats.bulkAdd(o.xMapChats),o.xMapSavedChats&&localStorage.setItem("xMapSavedChats",o.xMapSavedChats),o.newspaperCachedData&&localStorage.setItem("newspaperCachedData",o.newspaperCachedData),o.newspaperStats&&localStorage.setItem("newspaperStats",o.newspaperStats),o.newspaperGenerateHistory&&localStorage.setItem("newspaperGenerateHistory",o.newspaperGenerateHistory),console.log("✅ X数据导入成功，包含:",{"设置数":o.xSettings?.length||0,"用户资料数":o.xUserProfile?.length||0,"推文数据数":o.xTweetsData?.length||0,"用户推文数":o.xUserTweets?.length||0,"角色X资料数":o.xCharacterProfiles?.length||0,"预设数":o.xPresets?.length||0,"用户提问箱数":o.xAskbox?.length||0,"活跃账户数":o.xActiveAccount?.length||0,"账户列表数":o.xAccountList?.length||0,"NPC设置数":o.xNPCs?.length||0,"账户主页数据数":o.xAccountProfiles?.length||0,"账户提问箱数":o.xAccountAskbox?.length||0,"书签数":o.xBookmarks?.length||0,"关系册数":o.xCharacterRelationships?.length||0,"地图约会数据数":o.xMapDatingData?.length||0,"地图用户资料数":o.xMapUserProfile?.length||0,"地图聊天数据数":o.xMapChats?.length||0,"保存的聊天列表数":o.xMapSavedChats?JSON.parse(o.xMapSavedChats).length:0}),mn("数据导入成功！页面即将刷新...","success"),setTimeout(()=>{n.location.reload()},1500)}catch(n){console.error("❌ 导入数据失败:",n),mn("导入失败: "+n.message,"error")}},a.readAsText(o)},t.click()},n.toggleXTheme=On,n.showTweetDetail=io,n.handleDetailCommentInput=function(e){const t=e.target;if(so(),"Enter"===e.key&&!e.shiftKey){e.preventDefault();const o=t.value.trim().length>0,a=n.getSelectedCommentSticker?null!==n.getSelectedCommentSticker():null!==Ao;(o||a)&&lo()}},n.autoResizeDetail=function(n){n.style.height="20px",n.style.height=Math.min(n.scrollHeight,120)+"px",so()},n.submitDetailComment=lo,n.toggleDetailLike=function(n,e){const t="true"===e.dataset.liked,o=parseInt(e.dataset.likes);t?(e.dataset.liked="false",e.dataset.likes=(o-1).toString(),e.style.color="#71767b"):(e.dataset.liked="true",e.dataset.likes=(o+1).toString(),e.style.color="#f91880")},n.rerollAIReplies=async function(){go&&(clearTimeout(go),go=null);try{const n=uo();if(!n)return void mn("无法获取当前推文信息","error");const e=await async function(){const n=uo();if(!n)return[];const e=sessionStorage.getItem("currentTweetData");if(e)try{return[JSON.parse(e)]}catch(n){console.warn("无法解析推文数据:",n)}return[]}(),t=e.find(e=>e.id===n);if(!t)return void mn("未找到推文数据","error");const o="account"===t._source,a="search"===t._source,i=t.id&&t.id.startsWith("user_");console.log("🔄 [重回/推进] 推文类型:",{isAccountTweet:o,isSearchTweet:a,isUserTweet:i,currentMode:po?"推进模式":"重回模式",tweetId:n}),!o&&!a||po||(console.warn("⚠️ [重回/推进] 账户/搜索推文不支持重回模式，自动切换到推进模式"),po=!0,xo());const r=document.getElementById("reroll-replies-btn"),s=r.innerHTML,l=getComputedStyle(document.getElementById("x-social-screen")).getPropertyValue("--x-text-primary").trim()||"#fff";r.innerHTML=`\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: ${l}; animation: spin 1s linear infinite;">\n <g>\n <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z" />\n </g>\n </svg>\n `,r.style.pointerEvents="none";let c="正在推进帖子互动...";!po&&i?c="正在重新生成回复...":o?c="正在推进账户推文互动...":a&&(c="正在推进搜索推文互动..."),mn(c,"info"),await mo(t,!po,po),r.innerHTML=s,r.style.pointerEvents="auto"}catch(n){console.error("AI回复操作失败:",n),mn(po?"推进失败，请检查网络连接":"重新生成失败，请检查网络连接","error");const e=document.getElementById("reroll-replies-btn");xo(),e.style.pointerEvents="auto"}},n.toggleTweetSelection=yo,n.enterMultiSelectMode=wo,n.exitMultiSelectMode=exitMultiSelectMode,n.selectAllTweets=selectAllTweets,n.deleteSelectedTweets=deleteSelectedTweets,n.showXToast=mn,n.toggleIdentityCharacter=function(n){te.knownIdentityCharacters||(te.knownIdentityCharacters=[]);const e=te.knownIdentityCharacters.indexOf(n);-1===e?te.knownIdentityCharacters.push(n):te.knownIdentityCharacters.splice(e,1),jt()},n.closeAccountManager=wt,n.switchAccount=kt,n.createNewAccount=async function(){try{const n=e(),t="account_"+Date.now(),o=qs(t);await n.xUserProfile.put(o);const a={accountId:t,name:"新用户",avatar:"https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg",createdAt:(new Date).toISOString()};await n.xAccountList.put(a);const i=`askbox_${t}`;await n.xAskbox.put({id:i,avatar:"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",nickname:"= =",prompt:"请向我匿名提问!waiting...",background:"https://i.postimg.cc/7LqVqxt4/mmexport1759588659314.jpg",answeredQuestions:[]}),console.log("✅ 已为新账户创建空提问箱:",t),await kt(t)}catch(n){console.error("创建新账户失败:",n),mn("创建新账户失败","error")}},n.deleteAccount=async function(n){if("main"!==n){if(confirm("确定要删除这个账户吗？此操作无法撤销。"))try{const t=e();await t.xUserProfile.delete(n),await t.xAccountList.delete(n);const o=`askbox_${n}`;await t.xAskbox.delete(o);const a=`messagesList_${n}`;await t.xAccountProfiles.delete(a);const i=`strangerMessages_${n}`;await t.xAccountProfiles.delete(i);const r=`mentions_${n}`;await t.xAccountProfiles.delete(r);const s=await t.xAccountProfiles.where("name").equals("messageConversation").toArray();for(const e of s)(e.accountId===n||e.handle.startsWith(`messageConversation_${n}_`))&&await t.xAccountProfiles.delete(e.handle);await t.xSettings.delete(`xSettings_${n}`),await t.xUserTweets.delete(`userTweets_${n}`);const l=await t.xBookmarks.where("accountId").equals(n).toArray();for(const n of l)await t.xBookmarks.delete(n.id);const c=`wallet_${n}`;await t.xAccountProfiles.delete(c),console.log(`✅ 已清理账户 ${n} 的所有相关数据`),mn("账户已删除","success"),wt(),setTimeout(()=>{yt()},300)}catch(n){console.error("删除账户失败:",n),mn("删除账户失败","error")}}else mn("无法删除默认账户","error")},n.triggerCommentImageUpload=function(){document.getElementById("comment-image-input").click()},n.handleCommentImageUpload=function(n){const e=n.target.files[0];if(!e)return;const t=new FileReader;t.onload=function(n){on=n.target.result;const e=document.getElementById("comment-image-preview");document.getElementById("comment-image-preview-img").src=on,e.style.display="block",mn("图片已添加","success")},t.readAsDataURL(e)},n.removeCommentImage=rn,n.triggerDetailCommentImageUpload=function(){document.getElementById("detail-comment-image-input").click()},n.handleDetailCommentImageUpload=function(n){const e=n.target.files[0];if(!e)return;const t=new FileReader;t.onload=function(n){an=n.target.result;const e=document.getElementById("detail-comment-image-preview");document.getElementById("detail-comment-image-preview-img").src=an,e.style.display="block",mn("图片已添加","success")},t.readAsDataURL(e)},n.removeDetailCommentImage=ln,n.openCommentStickers=sn,n.toggleCharacterRelationship=async function(){ee.characterRelationship||(ee.characterRelationship={}),ee.characterRelationship.enabled=!ee.characterRelationship.enabled,Ae();const n=document.getElementById("relationship-binding-area");ee.characterRelationship.enabled?(n.style.display="block",await Ee(),setTimeout(()=>{ze()},100)):n.style.display="none",await se()},n.openCharacterRelationshipGraph=async function(){await Ee();const e=document.getElementById("character-relationship-graph-modal");e&&(e.style.display="block",document.body.style.overflow="hidden",setTimeout(()=>{Oe(),Fe(),at()},100),n.addEventListener("resize",Be),n.addEventListener("orientationchange",Be),n.addEventListener("keydown",Le))},n.closeCharacterRelationshipGraph=Pe,n.addRelationshipLink=function(){(Me.characters||[]).length<2?mn("至少需要2个已绑定角色才能创建关系","error"):(je=!0,Ue=null,mn("请点击选择第一个角色","info"),console.log("📍 进入角色选择模式"),Fe())},n.openEditRelationshipDetailModal=tt,n.closeEditRelationshipDetail=ot,n.saveRelationshipDetail=async function(){if(!Te)return;const n=Me.links.find(n=>n.id===Te);if(n){n.relationAtoB=document.getElementById("relationship-a-to-b").value.trim(),n.relationBtoA=document.getElementById("relationship-b-to-a").value.trim(),n.story=document.getElementById("relationship-story").value.trim(),Fe(),at(),ot();try{const t=e(),o=vt||"main",a=`xCharacterRelationships_${o}`;await t.xCharacterRelationships.put({id:a,accountId:o,data:Me,lastUpdated:(new Date).toISOString()}),ze(),mn("关系已更新并保存","success"),console.log("✅ 关系已自动保存:",n)}catch(n){console.error("❌ 保存关系失败:",n),mn("关系已更新但保存失败","error")}}},n.deleteRelationshipLink=async function(){if(Te&&confirm("确定要删除这条关系吗？")){Me.links=Me.links.filter(n=>n.id!==Te),Fe(),at(),ot();try{const n=e(),t=vt||"main",o=`xCharacterRelationships_${t}`;await n.xCharacterRelationships.put({id:o,accountId:t,data:Me,lastUpdated:(new Date).toISOString()}),ze(),mn("关系已删除","success")}catch(n){console.error("❌ 删除关系失败:",n),mn("关系已删除但保存失败","error")}}},n.clearAllRelationships=async function(){if(confirm("确定要清空所有关系吗？此操作不可恢复。")){Me.links=[],Fe(),at();try{const n=e(),t=vt||"main",o=`xCharacterRelationships_${t}`;await n.xCharacterRelationships.put({id:o,accountId:t,data:Me,lastUpdated:(new Date).toISOString()}),ze(),mn("已清空所有关系","success")}catch(n){console.error("❌ 清空关系失败:",n),mn("已清空但保存失败","error")}}},n.saveRelationshipGraph=async function(){try{const n=e(),t=vt||"main",o=`xCharacterRelationships_${t}`;await n.xCharacterRelationships.put({id:o,accountId:t,data:Me,lastUpdated:(new Date).toISOString()}),ze(),Pe(),mn("关系图已保存","success"),console.log("✅ 关系图已保存:",Me)}catch(n){console.error("❌ 保存关系图失败:",n),mn("保存失败","error")}},n.characterRelationshipData=Me,n.toggleNPCBinding=async function(){ee.npcBinding=!ee.npcBinding,rt();const n=document.getElementById("npc-binding-area");ee.npcBinding?(n.style.display="block",await st()):n.style.display="none",await se()},n.openCreateNPCModal=function(){it=null,document.getElementById("npc-name").value="",document.getElementById("npc-handle").value="",document.getElementById("npc-avatar").value="",document.getElementById("npc-personality").value="",document.getElementById("npc-posting-habits").value="",document.getElementById("npc-homepage").value="",document.getElementById("npc-modal-title").textContent="创建NPC",lt(),document.getElementById("npc-edit-modal").style.display="block",document.body.style.overflow="hidden"},n.editNPC=async function(n){try{const t=e(),o="xNPCs_global",a=await t.xNPCs.get(o),i=(a?.npcs||[]).find(e=>e.id===n);if(!i)return void mn("NPC不存在","error");it=n,document.getElementById("npc-name").value=i.name||"",document.getElementById("npc-handle").value=i.handle||"",document.getElementById("npc-avatar").value=i.avatar||"",document.getElementById("npc-personality").value=i.personality||"",document.getElementById("npc-posting-habits").value=i.postingHabits||"",document.getElementById("npc-homepage").value=i.homepage||"",document.getElementById("npc-modal-title").textContent="编辑NPC",await lt(i.boundUsers||[]),document.getElementById("npc-edit-modal").style.display="block",document.body.style.overflow="hidden"}catch(n){console.error("加载NPC数据失败:",n),mn("加载失败","error")}},n.saveNPC=async function(){try{const n=document.getElementById("npc-name").value.trim(),t=document.getElementById("npc-handle").value.trim(),o=document.getElementById("npc-avatar").value.trim(),a=document.getElementById("npc-personality").value.trim(),i=document.getElementById("npc-posting-habits").value.trim(),r=document.getElementById("npc-homepage").value.trim(),s=Array.from(document.querySelectorAll('#npc-bind-users input[type="checkbox"]:checked')).map(n=>n.value);if(!n)return void mn("NPC姓名不能为空","error");if(!t)return void mn("NPC句柄不能为空","error");const l=t.startsWith("@")?t:`@${t}`,c=e(),d="xNPCs_global",p=await c.xNPCs.get(d);let g=p?.npcs||[];if(it){const e=g.findIndex(n=>n.id===it);-1!==e&&(g[e]={...g[e],name:n,handle:l,avatar:o||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",personality:a,postingHabits:i,homepage:r,boundUsers:s,updatedAt:(new Date).toISOString()})}else{const e={id:"npc_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),name:n,handle:l,avatar:o||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg",personality:a,postingHabits:i,homepage:r,boundUsers:s,createdAt:(new Date).toISOString()};g.push(e)}await c.xNPCs.put({id:d,npcs:g,lastUpdated:(new Date).toISOString()}),console.log(`✅ NPC已${it?"更新":"创建"}:`,n,t),console.log("📎 绑定账号数量:",s.length),console.log("📎 绑定账号列表:",s.length>0?s:"无"),await st(),ct(),mn(it?"NPC已更新":"NPC已创建","success")}catch(n){console.error("保存NPC失败:",n),mn("保存失败: "+n.message,"error")}},n.deleteNPC=async function(n){if(confirm("确定要删除这个NPC吗？\n此操作将影响所有绑定了此NPC的账号。"))try{const t=e(),o="xNPCs_global",a=await t.xNPCs.get(o);let i=a?.npcs||[];i=i.filter(e=>e.id!==n),await t.xNPCs.put({id:o,npcs:i,lastUpdated:(new Date).toISOString()}),await st(),mn("NPC已删除","success")}catch(n){console.error("删除NPC失败:",n),mn("删除失败","error")}},n.closeNPCEditModal=ct,n.loadAskboxData=Zs,n.changeAskboxAvatar=async function(){const n=prompt("请输入新的头像URL:",Gs.avatar);if(n&&n.trim()){Gs.avatar=n.trim();const e=document.getElementById("askbox-avatar");e&&(e.src=Gs.avatar),await Qs(),mn("头像已更新并保存","success")}},n.saveAskboxNickname=async function(){const n=document.getElementById("askbox-nickname");if(!n)return;const e=n.textContent.trim();e&&e!==Gs.nickname&&(Gs.nickname=e,await Qs(),console.log("✅ 昵称已自动保存:",e))},n.saveAskboxPrompt=async function(){const n=document.getElementById("askbox-prompt");if(!n)return;const e=n.textContent.trim();e&&e!==Gs.prompt&&(Gs.prompt=e,await Qs(),console.log("✅ 提示文字已自动保存:",e))},n.openAskboxSettings=function(){const n=prompt("请输入新的背景图URL:",Gs.background);if(n&&n.trim()){Gs.background=n.trim();const e=document.getElementById("askbox-background");e&&(e.style.backgroundImage=`url('${Gs.background}')`),Qs(),mn("背景图已更新并保存","success")}},n.getNewQuestion=async function(){try{mn("正在生成新的提问...","info");const{apiConfig:e,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r,boundCharacters:l}=o,c=s.buildUserXProfileInfo(n.userProfileData),p=`userTweets_${vt||"main"}`,m=await a.xUserTweets.get(p),x=(m?.tweets||[]).slice(0,5);let u="";if("couple"===c.verificationType&&c.coupleCharacterId){const n=await a.xCharacterProfiles.where("characterId").equals(c.coupleCharacterId).first();n&&(u=`\n【情侣角色信息】：\n- X姓名：${n.xName}\n- X句柄：${n.xHandle}\n- X简介：${n.xBio||"无"}\n- 公众身份：${n.publicIdentity||"无"}\n- 真实姓名：${n.showRealName&&n.realName?n.realName:"未公开"}\n`)}let h="";if(l.length>0){const n=t(),e=(await n.chats.toArray()).filter(n=>!n.isGroup&&l.includes(n.id)),o=await a.xCharacterProfiles.toArray(),i=new Map;if(o.forEach(n=>{i.set(n.characterId,n)}),e.length>0){h="\n【绑定角色信息（可匿名提问）】：\n以下角色可以作为匿名提问者：\n";for(const n of e){const e=i.get(n.id);e&&(h+=`\n- ${e.xName}（${e.xHandle}）: ${n.settings.aiPersona?.substring(0,100)||""}`)}}}const f=Gs.answeredQuestions.filter(n=>n.answer&&n.answer.trim()).slice(0,5).map(n=>`Q: ${n.question}\nA: ${n.answer}`).join("\n\n");let b=0,v=s.buildBaseSystemPrompt({userPrompt:i,worldSetting:r});b=d.logTokenUsage("提问箱生成器","基础系统提示词",v,b),v+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 - 匿名提问箱 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是一个匿名提问箱系统。请为用户生成一个有趣的、适合他们身份的匿名提问。\n【用户身份信息】：\n- 用户名：${c.name}\n- X句柄：${c.handle}\n- 简介：${c.bio||"无"}\n- 公众身份：${c.publicIdentity||"无"}\n- 认证类型：${s.getUserVerificationTypeDescription(c)}\n${"couple"===c.verificationType&&c.coupleCharacterName?`- 情侣关系：与${c.coupleCharacterName}是公开情侣`:""}\n${u}\n【用户最近发布的推文】：\n${x.length>0?x.map((n,e)=>{let t=`${e+1}. ${n.content}${n.time?` (${n.time})`:""}`;return n.image&&("description"===n.image.type?t+=`\n [图片描述: ${n.image.content}]`:"upload"===n.image.type&&(t+="\n [包含上传的图片]")),t}).join("\n"):"暂无推文"}\n${h}\n${f?`【之前的提问与回复历史】：\n${f}\n\n【继续性要求】：新提问可以延续之前的话题，也可以开启新话题，保持自然。`:""}\n【提问生成要求】：\n1. 提问要自然、真实，像是真实的匿名用户提出的\n2. 提问内容要与用户的身份、简介、公众身份、最近发布的推文相关\n3. 如果有绑定角色，可以让角色以匿名身份提问，提问内容要符合角色的人设和性格\n4. 如果有之前的提问历史，可以延续话题，也可以提出新话题\n5. 提问可以是：\n- 关于最近推文内容的追问或评论\n- 关于生活经验、情感态度的询问\n- 关于兴趣爱好、专业技能的请教\n- 关于日常趣事、特殊经历的好奇\n- 轻松幽默或深度思考的话题\n6. 提问长度适中（10-50字），不要太长或太短\n7. 语气可以是：好奇的、调侃的、真诚的、幽默的\n8. 避免过于私密、冒犯或不适当的问题\n【返回格式】：\n每行一个提问，用换行符分隔，不需要序号、引号或其他格式\n每个提问独立成行，直接输出提问内容\n示例格式：\n看到你最近发的推文，感觉心情不错呀？\n最近有遇到什么让你特别开心的事吗？\n如果可以拥有一个超能力，你会选什么？\n你觉得最重要的人生品质是什么？\n现在，请为用户生成3-10个匿名提问（每行一个）：`;const y=v.substring(v.indexOf("【用户身份信息】"));b=d.logTokenUsage("提问箱生成器","用户信息与要求",y,b);const w=[{role:"user",content:"请生成3-10个匿名提问，每行一个"}];d.logFinalPrompt("提问箱生成器",v,w[0].content);const k=(await g.sendAIRequest({apiConfig:e,systemPrompt:v,messages:w,temperature:.9})).split("\n").map(n=>n.trim()).filter(n=>n.length>0).map(n=>n.replace(/^\d+[\.\)、]\s*/,"").replace(/^[-•]\s*/,"").replace(/^["「『]|["」』]$/g,"").trim()).filter(n=>n.length>0);if(0===k.length)throw new Error("AI返回了空的提问内容");console.log(`✅ 解析到 ${k.length} 个提问:`,k);const $=k.map((n,e)=>({id:`q_${Date.now()}_${e}_${Math.random().toString(36).substr(2,9)}`,question:n,answer:"",date:(new Date).toISOString()}));Gs.answeredQuestions.unshift(...$),await Qs(),nl(),mn(`你有 ${$.length} 个新的提问请查收`,"success")}catch(n){console.error("生成提问失败:",n),mn(`生成失败: ${n.message}`,"error")}},n.saveQuestionAnswer=async function(n){const e=document.getElementById(`answer-${n}`);if(!e)return;const t=Gs.answeredQuestions.find(e=>e.id===n);if(!t)return;let o=e.textContent.trim();"点击此处回复..."===o&&(o=""),o!==t.answer&&(t.answer=o,await Qs(),console.log("✅ 回复已自动保存:",n))},n.startQuestionLongPress=function(n){Ys||(Js=setTimeout(()=>{tl(),el(n)},500))},n.endQuestionLongPress=function(){Js&&(clearTimeout(Js),Js=null)},n.toggleQuestionSelection=el,n.enterAskboxMultiSelectMode=tl,n.exitAskboxMultiSelectMode=ol,n.selectAllQuestions=function(){document.querySelectorAll(".askbox-question-item").forEach(n=>{const e=n.dataset.questionId;Ws.has(e)||(Ws.add(e),n.style.border="3px solid #1d9bf0",n.style.backgroundColor="color-mix(in srgb, var(--x-accent) , 0.1)")}),al()},n.deleteSelectedQuestions=async function(){if(0===Ws.size)return void mn("请先选择要删除的提问","warning");if(confirm(`确定要删除选中的 ${Ws.size} 个提问吗？删除后无法恢复。`))try{Gs.answeredQuestions=Gs.answeredQuestions.filter(n=>!Ws.has(n.id)),await Qs(),mn(`已删除 ${Ws.size} 个提问`,"success"),ol(),nl()}catch(n){console.error("删除提问失败:",n),mn("删除失败: "+n.message,"error")}},n.switchSearchTab=$,n.handleTrendingClick=function(n){console.log("点击热搜:",n);let e=null;for(const t in f){const o=f[t].find(e=>e.id===n);if(o){e=o;break}}if(!e)return void console.error("未找到热搜数据:",n);const t=document.getElementById("search-input");t&&(t.value=e.title,I()),M()},n.handleTrendingMore=function(n){console.log("热搜更多选项:",n),mn("更多选项功能待开发","info")},n.openAddCategoryModal=async function(){const n=document.getElementById("category-manager-modal");n&&(n.style.display="flex",await A(),E())},n.closeCategoryModal=T,n.addNewCategory=function(){b.push({id:`custom_${Date.now()}`,name:"",description:"",enabled:!0}),E()},n.deleteCategory=z,n.toggleCategory=B,n.updateCategoryName=function(n,e){b[n]&&(b[n].name=e.trim())},n.updateCategoryDescription=function(n,e){b[n]&&(b[n].description=e.trim())},n.saveCustomCategories=async function(){try{const n=e(),t=`customCategories_${vt||"main"}`;await n.xTweetsData.put({id:t,categories:b,lastUpdated:(new Date).toISOString()}),console.log("✅ 自定义分类已保存"),mn("分类设置已保存","success"),L(),T()}catch(n){console.error("❌ 保存自定义分类失败:",n),mn("保存失败: "+n.message,"error")}},n.refreshTrends=async function(){const e=document.querySelector(".refresh-trends-btn");if(e){e.classList.add("spinning");try{const{apiConfig:e,xSettings:t,xDb:o}=await g.loadConfigAndSettings(),{userPrompt:a,worldSetting:i,boundCharacters:r}=t,l=s.buildUserXProfileInfo(n.userProfileData),c=l.publicIdentity||"",p=l.bio||"",m=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(c+" "+p);console.log("🎭 用户公众身份检测:",{isPublicFigure:m,publicIdentity:c,bio:p});let x=0,u=s.buildBaseSystemPrompt({userPrompt:a,worldSetting:i});x=d.logTokenUsage("热搜生成器","基础系统提示词",u,x);const h=await s.getApplicableWorldBooks("trending",{boundCharacters:r});h&&(u+=h,x=d.logTokenUsage("热搜生成器","世界书内容",h,x));const v=await bn("热搜生成器",{usageRate:.6,usageDescription:'**热搜场景的大事件使用（重要！）**：\n🔥 **核心原则**：热搜榜应该真实反映当前世界的热点事件，至少60%的热搜应该与大事件直接相关\n\n1. **直接热搜**：大事件本身就是热搜话题\n   - 事件标题直接上榜："XXX事件引发全网讨论"\n   - 事件关键词："XXX"、"XXX最新进展"\n   - 相关人物/机构："XXX回应XXX事件"\n\n2. **衍生话题**：从大事件延伸出的讨论话题\n   - 网友反应："网友热议XXX"\n   - 专家评论："专家解读XXX"\n   - 类似事件："XXX与XXX事件对比"\n\n3. **次级热搜**：受大事件影响的相关内容\n   - 如果是灾难事件，可能有"捐款榜"、"救援进展"等\n   - 如果是娱乐八卦，可能有"吃瓜群众"、"资深扒手"等\n   - 如果是政策事件，可能有"影响分析"、"专家访谈"等\n\n4. **黑色幽默热搜**：保持讽刺风格\n   - 热搜标题要有黑色幽默感\n   - 可以讽刺、夸张、反转\n\n5. **分布要求**：\n   - "为你推荐"：3-4条大事件相关（60-80%）\n   - "当前趋势"：3-4条大事件相关（60-80%）\n   - 其余可以是常规热搜（娱乐、体育、日常等）'});v&&(u+=v,x=d.logTokenUsage("热搜生成器","世界运转大事件",v,x));const y=b.filter(n=>n.enabled&&n.name);if(u+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的热搜生成器。请生成当前的热门话题列表。\n【生成要求】：\n- 为"为你推荐"和"当前趋势"各生成5条热搜\n${y.length>0?`- 同时为以下自定义分类各生成5条热搜：${y.map(n=>`"${n.name}"`).join("、")}`:""}\n- 热搜话题要多样化，涵盖不同领域和分类\n- 热搜数量（帖子数）要符合真实社交平台规模（1万到100万之间）\n- 话题标题要简洁有力，符合社交媒体特点\n${m?"- 用户或绑定角色是公众人物，可以适当生成1-2条相关热搜（占比约20%）":"- 用户和角色不是公众人物，生成通用热门话题即可，不要涉及用户或角色"}\n【热搜分类示例】：\n- 娱乐 · 热门话题：电影、音乐、综艺、明星动态\n- 体育 · 实时：比赛、运动员、体育赛事\n- 科技 · 趋势：新技术、产品发布、科技新闻\n- 社会 · 讨论：时事、民生、社会话题\n- 游戏 · 热门：游戏更新、电竞、游戏新闻\n- 文化 · 热议：艺术、文学、传统文化\n- 音乐 · 流行：新歌、演唱会、音乐人动态\n- 美食 · 推荐：美食探店、烹饪技巧\n- 旅游 · 探索：旅行目的地、旅游攻略\n- 时尚 · 潮流：穿搭、时装周、潮流单品\n- 健康 · 生活：养生、健身、生活方式\n- 全球 · 趋势：国际新闻、全球热点\n- 商业 · 财经：经济动态、商业新闻\n- 教育 · 学习：学习方法、教育资讯\n${y.length>0?`\n【自定义分类详细说明】：${y.map(n=>`\n- ${n.name}：${n.description||"生成该分类下的热门话题"}`).join("")}\n`:""}\n`,m){u+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 公众人物信息（可用于生成相关热搜）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n【用户公开信息】：\n- 用户名：${l.name}\n- 用户句柄：${l.handle}\n- 公众身份：${l.publicIdentity}\n${l.bio?`- 个人简介：${l.bio}`:""}\n${"none"!==l.verificationType?`- 认证状态：${s.getUserVerificationTypeDescription(l)}`:""}\n${"couple"===l.verificationType&&l.coupleCharacterName?`- 情侣关系：与${l.coupleCharacterName}为公开情侣`:""}\n`;const n=[];if(r.length>0){const e=await o.xCharacterProfiles.toArray();for(const t of r){const o=e.find(n=>n.characterId===t);if(o&&o.publicIdentity){/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(o.publicIdentity)&&n.push({type:"character",name:o.xName,handle:o.xHandle,publicIdentity:o.publicIdentity,bio:o.xBio||""})}}}const e="xNPCs_global",t=await o.xNPCs.get(e),a=vt||"main",i=(t?.npcs||[]).filter(n=>n.boundUsers&&n.boundUsers.includes(a));for(const e of i){const t=[e.personality||"",e.homepage||""].join(" ");/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(t)&&n.push({type:"npc",name:e.name,handle:e.handle,publicIdentity:"公众人物",bio:e.personality||""})}if(n.length>0){u+="\n【绑定公众人物信息】：\n";for(const e of n){u+=`\n【${e.name}】（${"character"===e.type?"角色":"NPC"}）\n- X姓名：${e.name}\n- X句柄：${e.handle}\n- 公众身份：${e.publicIdentity}\n${e.bio?`- 简介/人设：${e.bio}`:""}\n`;try{const n=e.handle.replace("@",""),t=await o.xAccountProfiles.get(n),a=t?.tweets?.slice(0,5)||[];a.length>0&&(u+=`\n${e.name} 的近期推文（${a.length}条）：\n`,a.forEach((n,e)=>{u+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发\n${n.media&&n.media.length>0?` - 媒体：${n.media[0].description.substring(0,50)+"..."}\n`:""}`}))}catch(n){console.warn(`热搜生成器：读取 ${e.name} 的推文失败:`,n)}u+="\n"}}try{const n=`userTweets_${vt||"main"}`,e=await o.xUserTweets.get(n),t=e?.tweets?.slice(0,5)||[];t.length>0&&(u+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📰 用户近期推文（公众人物）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n${l.name} 的近期推文（${t.length}条）：\n`,t.forEach((n,e)=>{u+=`\n${e+1}. "${n.content}"\n- 时间：${n.time||"最近"}\n- 互动：${n.stats?.likes||0}喜欢，${n.stats?.retweets||0}转发，${n.stats?.comments||0}评论\n${n.image?` - 媒体：${"description"===n.image.type?n.image.content.substring(0,50)+"...":"包含图片"}\n`:""}`}),u+="\n【使用说明】：\n- 可以基于用户和角色的近期推文内容生成相关的热搜话题\n- 热搜可以反映他们最近的活动、作品、或引起的讨论\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n")}catch(n){console.warn("热搜生成器：读取用户推文失败:",n)}u+="\n【公众人物热搜规则】：\n- 可以生成与用户或角色相关的热搜话题（1-2条，占比约20%）\n- 话题应该基于公众身份信息和近期推文内容，符合其领域和形象\n- 可以围绕他们的近期动态、作品、或引起的热议生成热搜\n- 不要泄露私密人设、聊天记忆等非公开信息\n- 热搜内容要真实可信，像真正的社交平台热搜\n- 其余80%的热搜应该是与用户/角色无关的通用热门话题\n";const c=u.substring(u.indexOf("📋 公众人物信息"));x=d.logTokenUsage("热搜生成器","公众人物信息与近期推文",c,x)}let w='{\n"recommended": [\n{\n "category": "分类 · 标签",\n "title": "热搜话题标题",\n "count": 数字（帖子数量，1万-100万之间）\n}\n],\n"trending": [\n{\n "category": "分类 · 标签",\n "title": "热搜话题标题",\n "count": 数字（帖子数量，1万-100万之间）\n}\n]';y.length>0&&y.forEach(n=>{w+=`,\n"${n.id}": [\n{\n "category": "分类 · 标签",\n "title": "热搜话题标题",\n "count": 数字（帖子数量，1万-100万之间）\n}\n]`}),w+="\n}",u+=`\n【返回格式】：严格JSON格式，不要添加任何其他文字说明\n${w}\n**注意事项**：\n1. category格式：分类 · 标签（例如："娱乐 · 热门话题"）\n2. title要简洁有力，不超过20个字\n3. count必须是纯数字，不带引号，范围在10000-1000000之间\n4. 每个数组包含5个热搜项\n5. 话题要多样化，不要集中在某一领域\n6. 确保返回纯JSON，不要有markdown代码块标记\n${y.length>0?"7. 自定义分类的热搜要紧密围绕分类主题和描述，确保内容相关性":""}\n【最终检查】：确认话题真实可信，分类准确，数量合理，${i.trim()?"严格遵守世界观设定，":""}格式正确。\n`;const k=u.substring(u.indexOf("🎯 核心任务说明 🎯"));x=d.logTokenUsage("热搜生成器","任务说明与格式要求",k,x);const $=[{role:"user",content:"请生成最新的X平台热搜话题列表"}];d.logFinalPrompt("热搜生成器",u,$[0].content);const I=await g.sendAIRequest({apiConfig:e,systemPrompt:u,messages:$,temperature:.9}),S=g.parseJSONResponse(I);if(!S.recommended||!S.trending)throw new Error("AI返回的数据格式不正确，缺少必要字段");if(!Array.isArray(S.recommended)||!Array.isArray(S.trending))throw new Error("热搜数据格式错误：recommended和trending必须是数组");if(y.length>0)for(const n of y)S[n.id]?Array.isArray(S[n.id])||console.warn(`⚠️ 自定义分类"${n.name}"的数据格式错误`):console.warn(`⚠️ AI未返回自定义分类"${n.name}"的数据`);const M=Date.now();S.recommended=S.recommended.map((n,e)=>({...n,id:`rec_${M}_${e}`})),S.trending=S.trending.map((n,e)=>({...n,id:`trend_${M}_${e}`})),y.forEach(n=>{S[n.id]&&Array.isArray(S[n.id])&&(S[n.id]=S[n.id].map((e,t)=>({...e,id:`${n.id}_${M}_${t}`})))}),f.recommended=S.recommended,f.trending=S.trending,y.forEach(n=>{S[n.id]&&(f[n.id]=S[n.id])});try{const n={id:"trends",recommended:S.recommended,trending:S.trending,lastUpdated:(new Date).toISOString()};y.forEach(e=>{S[e.id]&&(n[e.id]=S[e.id])}),await o.xTweetsData.put(n),console.log("✅ 热搜数据已保存到数据库",{"默认分类":2,"自定义分类":y.length})}catch(n){console.error("⚠️ 保存热搜数据失败:",n)}C(),mn("热搜已刷新","success")}catch(n){console.error("❌ 刷新热搜失败:",n),mn(`刷新失败: ${n.message}`,"error")}finally{e&&e.classList.remove("spinning")}}},n.toggleSearchButton=I,n.performSearch=M,n.switchSearchResultTab=function(n){y=n,document.querySelectorAll("#search-results-view .search-tab").forEach((e,t)=>{["top","latest","users"][t]===n?e.classList.add("active"):e.classList.remove("active")}),S()},n.backToTrending=function(){w=!1,document.getElementById("search-results-view").style.display="none",document.getElementById("trending-view").style.display="flex";const n=document.getElementById("search-back-btn");n&&(n.style.display="none");const e=document.querySelector(".refresh-trends-btn");e&&(e.style.display="flex");const t=document.getElementById("search-input");t&&(t.value="",I()),v=""},n.openAccountProfile=openAccountProfile,n.closeAccountProfile=closeAccountProfile,n.showAccountTweetDetail=showAccountTweetDetail,n.toggleAccountFollow=toggleAccountFollow,n.toggleAccountNotifications=toggleAccountNotifications,n.sendMessageToAccount=sendMessageToAccount,n.switchAccountTab=switchAccountTab,n.refreshAccountProfile=refreshAccountProfile,n.toggleProgressMode=toggleProgressMode,n.handleRefreshButtonMouseDown=handleRefreshButtonMouseDown,n.handleRefreshButtonMouseUp=handleRefreshButtonMouseUp,n.goBackFromTweetDetail=goBackFromTweetDetail,n.toggleXTheme=On,n.toggleXLanguage=async function(){try{Hn="zh"===Hn?"en":"zh",Un(Hn);const n=e(),t=`xLanguage_${vt||"main"}`;await n.xSettings.put({id:t,language:Hn,updatedAt:(new Date).toISOString()}),console.log("🌐 语言已切换为: "+("zh"===Hn?"中文":"English")),mn("zh"===Hn?Rn.zh.toastLanguageChinese:Rn.en.toastLanguageEnglish,"success")}catch(n){console.error("语言切换失败:",n),mn("Language switch failed","error")}},n.openAccentColorPicker=function(){const n=document.createElement("div");n.id="accent-color-picker-modal",n.style.cssText="\n position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);\n";const e=document.getElementById("x-social-screen"),t=getComputedStyle(e).getPropertyValue("--x-accent").trim();n.innerHTML=`\n <div style="background-color:var(--x-bg-primary); border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid var(--x-border-color); overflow: hidden; ">\n\n <div style="padding: 20px; border-bottom: 1px solid var(--x-border-color); display: flex; align-items: center; justify-content: space-between; ">\n <h3 style="margin: 0; color:var(--x-text-primary); font-size: 20px; font-weight: 700;">选择主题色</h3>\n <button onclick="closeAccentColorPicker()" style="background: transparent; border: none; color:var(--x-text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">\n <g><path d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path></g>\n </svg>\n </button>\n </div>\n\n <div style="padding: 20px;">\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 12px;">预设颜色</div>\n <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">\n ${Fn.map(n=>`\n <div onclick="applyAccentColor('${n.color}')" style="cursor: pointer; aspect-ratio: 1; border-radius: 8px; background-color: ${n.color}; border: 3px solid ${n.color===t?"var(--x-text-primary)":"transparent"}; transition: all 0.2s; position: relative; display: flex; align-items: center; justify-content: center; " onmouseover="this.style.transform='scale(1.05)'"\n onmouseout="this.style.transform='scale(1)'">\n ${n.color===t?'<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #fff;"><path d="M9 16.17L5.53 12.7l-1.06 1.06L9 18.3l9.54-9.54-1.06-1.06L9 16.17z"/></svg>':""}\n </div>\n `).join("")}\n </div>\n\n <div style="color:var(--x-text-primary); font-size: 15px; font-weight: 600; margin-bottom: 12px;">自定义颜色</div>\n <div style="display: flex; gap: 12px; align-items: center;">\n <input type="color" id="custom-accent-color" value="${t}" style="width: 60px; height: 40px; border: 2px solid var(--x-border-color); border-radius: 8px; cursor: pointer; background: transparent; ">\n <button onclick="applyAccentColor(document.getElementById('custom-accent-color').value)" style="flex: 1; background-color: var(--x-accent); color: #fff; border: none; border-radius: 20px; padding: 10px 20px; font-size: 15px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; " onmouseover="this.style.opacity='0.9'"\n onmouseout="this.style.opacity='1'">\n 应用\n </button>\n </div>\n\n <button onclick="applyAccentColor('#1d9bf0')" style="width: 100%; margin-top: 16px; background: transparent; color:var(--x-text-secondary); border: 1px solid var(--x-border-color); border-radius: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; " onmouseover="this.style.backgroundColor='var(--x-bg-hover)'"\n onmouseout="this.style.backgroundColor='transparent'">\n 重置为默认色\n </button>\n </div>\n </div>\n`,document.body.appendChild(n),n.addEventListener("click",e=>{e.target===n&&Xn()})},n.closeAccentColorPicker=Xn,n.applyAccentColor=async function(n){try{const t=document.getElementById("x-social-screen");if(!t)return;t.style.setProperty("--x-accent",n);const o=e(),a=`xAccentColor_${vt||"main"}`;await o.xSettings.put({id:a,accentColor:n,updatedAt:(new Date).toISOString()}),mn("主题色已更新","success"),Xn(),console.log("✅ 主题色已应用:",n)}catch(n){console.error("应用主题色失败:",n),mn("应用主题色失败","error")}},n.switchLiveTab=Yo,n.joinLiveStream=function(t){let o=null;for(const n in Go){const e=Go[n].find(n=>n.id===t);if(e){o=e;break}}if(!o)return console.error("❌ [直播间] 未找到直播数据:",t),void mn("直播间不存在","error");Ko={...o,type:o.category.includes("语音")||t.startsWith("audio")?"audio":"video"},async function(n){try{const t=e();if(!t)return console.error("❌ [直播间] 加载失败: 无法获取数据库实例"),null;const o="liveRoomDetails_"+n;return await t.xAccountProfiles.get(o)||null}catch(n){return console.error("❌ [直播间] 加载失败:",n),null}}(t).then(e=>{if(e){if(Ko.details=e,!0===e.isEnded){console.log(`🚫 [直播间] 直播间 ${t} 已结束，阻止进入`);return Ea(o.streamerName||"主播",!1),void(Ko=null)}if(e.giftLeaderboard&&e.giftLeaderboard.userTotalPoints>0){const n=e.giftLeaderboard.userTotalPoints,t=e.giftLeaderboard.userRank,o=e.userGifts?e.userGifts.length:0;console.log(`💝 [直播间] 已恢复您的礼物记录: ${o}个礼物, 总积分${n}, 排名#${t||"未上榜"}`)}Ia()}else mn("正在准备直播间...","info"),async function(e){try{const{db:t,xDb:o,apiConfig:a,xSettings:i}=await g.loadConfigAndSettings(),{userPrompt:l,worldSetting:c,boundCharacters:p}=i,m=s.buildUserXProfileInfo(n.userProfileData);if(e.streamerHandle){const n=r.clean(e.streamerHandle),t=(await o.xCharacterProfiles.toArray()).find(e=>r.clean(e.xHandle)===n);if(t&&t.xAvatar)e.streamerAvatar!==t.xAvatar&&(e.streamerAvatar=t.xAvatar,e.streamerName=t.xName,e.streamerHandle=t.xHandle);else{const t=(await g.loadBoundNPCs()).find(e=>r.clean(e.handle)===n);t&&t.avatar&&e.streamerAvatar!==t.avatar&&(e.streamerAvatar=t.avatar,e.streamerName=t.name,e.streamerHandle=t.handle)}}const x=await s.getUnifiedProfile(e.streamerHandle,{userProfileInfo:m});if(!x)throw console.error("❌ [直播间生成器] 无法获取主播资料"),new Error("无法获取主播资料");const u=100*Math.random();let h="middle";u<20?h="beginning":u>=90&&(h="ending");let f=0,b=s.buildBaseSystemPrompt({userPrompt:l,worldSetting:c});f=d.logTokenUsage("直播间生成器","基础系统提示词",b,f);const v=await s.getApplicableWorldBooks("live",{boundCharacters:p});v&&(b+=v,f=d.logTokenUsage("直播间生成器","世界书内容",v,f));let y="",w="";"beginning"===h?(y="开播阶段",w="\n【开播】主播：欢迎、介绍内容、暖场 | 弹幕：欢迎、问候、期待 | ❌禁止：再见/结束语"):"middle"===h?(y="进行中",w="\n【进行中】主播：讨论话题、分享内容、互动 | 弹幕：讨论、提问、评论 | ❌禁止：欢迎/告别语"):(y="结束阶段",w="\n【结束】主播：总结、感谢、告别(最后一条加shouldEndLive:true) | 弹幕：感谢、道别 | ❌禁止：欢迎语"),b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的直播间内容生成器。请为当前直播间生成完整的详细数据。\n\n【已有的直播间基本信息】：\n- 直播标题："+e.title+"\n- 主播姓名："+e.streamerName+"\n- 主播句柄："+e.streamerHandle+"\n- 直播分类："+e.category+"\n- 直播时长："+e.duration+"\n- 在线人数："+e.onlineCount+(e.description?"\n- 直播简介："+e.description:"")+"\n\n🎬 【当前直播阶段】："+y+w+"\n\n【需要生成的内容】：\n1. 完整的直播间详细信息（description, details, notice, tags）\n2. 主播发言内容（15-20条，符合主播人设和当前阶段）\n3. 弹幕消息（30-40条，来自虚构观众，符合当前阶段）\n4. 三个榜单数据（礼物榜、粉丝榜、活跃榜，每个10人）\n5. 🎙️ 语音连线系统配置（仅限语音直播）\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n";const k=b.substring(b.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));f=d.logTokenUsage("直播间生成器","核心任务说明",k,f),b+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎙️ 语音连线系统(connectionSettings)\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n根据主播性格设置连线配置：\n\n**温柔型**: enabled:true, threshold:{type:"followDays",value:7}, waitingList:2-4人\n**商业型**: enabled:true, threshold:{type:"giftRank",value:10}, waitingList:0-2人\n**高冷型**: enabled:50%概率, threshold:{type:"giftRank",value:5}, waitingList:0-1人\n**搞笑型**: enabled:true, threshold:{type:"none",value:0}, waitingList:3-5人\n**佛系型**: enabled:false (70%概率)\n\n⚠️ waitingList中的观众必须虚构，不能使用真实用户信息\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n',f=d.logTokenUsage("直播间生成器","语音连线系统规则",b.substring(b.lastIndexOf("🎙️ 语音连线系统")),f);const $=m.publicIdentity||"",C=m.bio||"",I=/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test($+" "+C),S=[];if(p.length>0){const n=await o.xCharacterProfiles.toArray();for(const e of p){const t=n.find(n=>n.characterId===e);t&&t.publicIdentity&&/明星|网红|博主|演员|歌手|艺人|主播|up主|偶像|导演|制片|编剧|作家|influencer|celebrity|singer|actor|artist|streamer|idol/i.test(t.publicIdentity)&&S.push({characterId:e,xProfile:t})}}let M="";if(I||S.length>0){M="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🌟 高曝光身份观众检测\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下是进入直播间的高曝光公众人物，可能会引起其他观众的注意和讨论：\n",I&&(M+=`\n【${m.name}（观众身份）】\n- 公众身份：${$}\n- X句柄：${m.handle}\n- 可能会被其他观众认出并讨论\n`);for(const{xProfile:n}of S)M+=`\n【${n.xName}（观众身份）】\n- 公众身份：${n.publicIdentity}\n- X句柄：${n.xHandle}\n- 可能会被其他观众认出并讨论\n`;M+=`\n【高曝光观众弹幕生成规则】：\n- 约15-25%的弹幕可以提到这些高曝光观众的进入\n- 讨论应该是其他普通观众的视角，例如：\n  * "卧槽，${I?m.name:S[0]?.xProfile.xName}也在看这个直播？"\n  * "大佬来了！"\n  * "有没有人注意到XXX也在线？"\n- 不要在每条弹幕中都提及，保持自然和多样性\n- 其余75-85%的弹幕应该是正常的直播内容讨论\n- 主播可以注意到高曝光观众并打招呼（可选）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`,b+=M,f=d.logTokenUsage("直播间生成器","高曝光身份上下文",M,f)}const T=s.formatProfileForPrompt(x,{includeType:!0,includeTweets:!0,includeRelationships:!0});b+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📺 主播资料\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"+T+'\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💬 主播发言要求\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**拒绝模板化！** 每句话要有情绪、停顿、口语化。根据人设演绎：\n- 口语化：用"嗯...""emmm""诶？"等停顿词，避免书面化\n- 情绪层次：不只"开心"还有"哈哈哈笑死""绷不住了"；不只"好吧"还有"服了""你赢了"\n- 多样互动：回答加思考过程"嗯？你说这首...等等我看看"；不要只"谢谢支持"\n- 话题延展：不要一问一答，要延伸话题、反问观众\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n👥 弹幕内容要求\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**拒绝口水话！** 要具体分析、真实反应：\n- ❌禁止："真好磕""666""1号观众"等套路话\n- ✅昵称：生活化("深夜失眠人""摸鱼达人")，不要"user123"敷衍\n- ✅恋爱剧情：分析"这互动细节绝了"/情绪"啊啊啊我死了"/玩梗"单身狗暴击"，不只"磕到了"\n- ✅抓马冲突：分析"转折太离谱"/吃瓜"坐等反转"/站队"我站XXX"，不只"天呐"\n- ✅游戏技术：专业"操作可以"/质疑"运气吧"/学习"学到了"，不只"6666"\n- ✅音乐唱歌：专业"高音稳"/共鸣"听哭了"/请求"再来一遍"，不只"好听"\n- 20-30%弹幕是观众互动，不都对着主播说\n- musicMood字段：休闲/音乐/游戏/学习/运动/美食/情感/悲伤/浪漫/工作\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n💰 Super Chat & 观众类型\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n**SC规则**: 0-3条(70%概率0),50-2000元,10-80字符。80%主播感谢回应,20%故意忽略导致观众质问。20-30%普通弹幕是对SC的反应。\n\n**观众类型**: 普通粉丝(40-50%支持主播)/路过(20-25%好奇询问)/土豪(5-10%炫耀指挥)/黑粉(10-15%挑刺嘲讽)/广告(3-8%引流推销)/潜水(5-10%表情包冒泡)\n\n**主播反应**: 温柔型热情回应/高冷型爱理不理/搞笑型调侃化解/佛系型选择性忽略\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n',f=d.logTokenUsage("直播间生成器","主播资料信息",T,f);const A=b.length;b+=s.buildUniversalConstraints(m);const E=b.substring(A);f=d.logTokenUsage("直播间生成器","用户约束信息",E,f),b+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 JSON返回格式(必须严格遵守)\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n❌禁止: markdown标记/注释/尾逗号/单引号/数字加引号/额外文字\n✅必须: 双引号/"刚刚"等时间格式/数字不加引号/纯JSON从{到}\n\n**核心字段说明**:\n\n1. **基础**: title(标题5-50字), description(简介10-100字), details(详情20-200字), notice(公告10-100字), tags(2-4个标签), viewers(在线100-100000)\n\n2. **musicMood**(音乐氛围): 休闲/音乐/游戏/学习/运动/美食/情感/悲伤/浪漫/工作 - 根据直播分类选择，系统自动匹配背景音乐\n\n3. **streamerMessages**(主播发言15-20条): content(内容10-50字), time("刚刚"/"1分钟前"等)\n   - **shouldEndLive**(可选布尔): 仅结束阶段最后一条设为true，触发关闭直播间\n\n4. **danmaku**(弹幕30-40条): userName(虚构昵称), userHandle(虚构句柄@xxx), content(内容5-30字)\n\n5. **superChats**(付费弹幕0-3条,70%概率0/20%概率1/10%概率2-3): userName, userHandle, amount(50-2000元), content(10-80字), time\n   - 80%主播感谢回应,20%忽略导致观众质问 | 20-30%普通弹幕对SC反应\n\n6. **leaderboards**(榜单): gifts(礼物榜)/fans(粉丝榜)/active(活跃榜)各10人\n   - gifts: value=累计送礼积分(100-99999严格递减), badge(可选💎👑⭐)\n   - fans: value=粉丝等级(1-50000严格递减)\n   - active: value=活跃天数(1-3000严格递减)\n   - ⚠️ **榜单禁止真实用户${m.name}/${m.handle}，必须虚构**\n\n7. **giftRankContactConfig**(主播礼物榜私联配置,必填): 主播主动私联礼物榜排名靠前土豪维护金钱关系\n   - **willContactPrivately**(布尔): 是否主动私联礼物榜高排名用户\n   - **contactRankThreshold**(1-10): 第几名及以上触发私联(3=前3名/5=前5名/10=前10名)\n   - **persistAfterRejection**(布尔): 被拒绝后是否持续发私信\n   - 根据性格: 势利/商业化(true,3-7,true) | 高冷/耍大牌(false,0,false) | 平易近人(true,5-10,false) | 傲娇(true,5,false) | 执着/粘人(true,5,true)\n\n8. **connectionSettings**(语音连线配置,仅语音直播):\n   - enabled(布尔): 是否开启连线\n   - threshold: {type:"none"/"points"/"fanLevel"/"giftRank"/"followDays", value:数字, description:描述}\n   - waitingList(0-5个虚构观众): [{userName,userHandle,avatar,waitTime}]\n   - maxWaiting(3-10): 最大排队人数 | averageWaitTime: "约2-3分钟"\n\n**JSON示例**:\n{\n  "title":"标题","description":"描述","details":"详情","notice":"公告","tags":["标签"],"viewers":1250,"musicMood":"休闲",\n  "streamerMessages":[{"content":"内容","time":"刚刚"},{"content":"最后","time":"2分钟前","shouldEndLive":true}],\n  "danmaku":[{"userName":"虚构名","userHandle":"@虚构","content":"内容"}],\n  "superChats":[{"userName":"虚构","userHandle":"@虚构","amount":500,"content":"内容","time":"1分钟前"}],\n  "leaderboards":{"gifts":[{"userName":"虚构","userHandle":"@虚构","value":99999,"badge":"💎"}],"fans":[...],"active":[...]},\n  "giftRankContactConfig":{"willContactPrivately":true,"contactRankThreshold":5,"persistAfterRejection":false},\n  "connectionSettings":{"enabled":true,"threshold":{"type":"followDays","value":7,"description":"描述"},"waitingList":[{"userName":"虚构","userHandle":"@虚构","avatar":"","waitTime":"2分钟"}],"maxWaiting":8,"averageWaitTime":"约2-3分钟"}\n}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 你现在必须返回符合上述规则的纯JSON，从{开始到}结束，无其他内容。\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const z=b.substring(b.lastIndexOf("📋 JSON返回格式"));f=d.logTokenUsage("直播间生成器","JSON格式要求",z,f);let B="";B="beginning"===h?"\n\n🎬开播阶段：欢迎开场 | ❌禁止：再见/结束语":"middle"===h?"\n\n🎬进行中：讨论互动 | ❌禁止：欢迎/告别语":'\n\n🎬结束阶段：告别总结 | ✅最后一条发言加"shouldEndLive":true';const L=[{role:"user",content:"生成完整JSON数据"+B+"\n\n❌禁止:```标记/注释/JSON外文字/数字加引号/尾逗号 | ✅直接返回纯JSON从{到}"}];d.logFinalPrompt("直播间生成器",b,L[0].content);let P=(await g.sendAIRequest({apiConfig:a,systemPrompt:b,messages:L,temperature:.8})).trim();P=P.replace(/^```json\s*/i,""),P=P.replace(/^```\s*/i,""),P=P.replace(/\s*```$/i,"");const D=P.indexOf("{");D>0&&(P=P.substring(D));const N=P.lastIndexOf("}");N>=0&&N<P.length-1&&(P=P.substring(0,N+1));let R=g.parseJSONResponse(P);R=await g.postProcessData(R,m);const H=["title","description","details","notice","tags","viewers","streamerMessages","danmaku","leaderboards"];for(const n of H)if(!R[n])throw new Error(`AI返回的数据缺少必需字段: ${n}`);if(!Array.isArray(R.tags))throw new Error("tags必须是数组");if(!Array.isArray(R.streamerMessages))throw new Error("streamerMessages必须是数组");if(!Array.isArray(R.danmaku))throw new Error("danmaku必须是数组");if(0===R.streamerMessages.length)throw new Error("streamerMessages不能为空");if(0===R.danmaku.length)throw new Error("danmaku不能为空");if("number"!=typeof R.viewers)throw new Error("viewers必须是数字");const j=Date.now();return R.generatedAt=j,R.streamId=e.id,R.latestGenerationId=j,R.livePhase=h,R.streamerMessages&&R.streamerMessages.forEach(n=>{n.generationId=j}),R.danmaku&&R.danmaku.forEach(n=>{n.generationId=j}),R}catch(n){throw console.error("❌ [直播间生成器] 生成失败:",n),n}}(o).then(n=>(Ko.details=n,aa(t,n))).then(()=>{Ia()}).catch(n=>{console.error("❌ [直播间] 生成失败:",n),mn("进入直播间失败: "+n.message,"error")})}).catch(n=>{console.error("❌ [直播间] 加载失败:",n),mn("进入直播间失败","error")})},n.initLivePage=Ca,n.renderLiveStreams=Wo,n.openLiveCategoryModal=function(){const n=document.getElementById("live-category-manager-modal");n&&(n.style.display="block",document.body.style.overflow="hidden",ur())},n.closeLiveCategoryModal=xr,n.addNewLiveCategory=function(){const n={id:`live_cat_${Date.now()}`,name:"",description:"",enabled:!0};Xo.push(n),ur()},n.deleteLiveCategory=function(n){Xo=Xo.filter(e=>e.id!==n),ur(),vr()},n.toggleLiveCategory=function(n){const e=Xo.find(e=>e.id===n);e&&(e.enabled=!e.enabled,vr())},n.updateLiveCategoryName=function(n,e){const t=Xo.find(e=>e.id===n);t&&(t.name=e)},n.updateLiveCategoryDescription=function(n,e){const t=Xo.find(e=>e.id===n);t&&(t.description=e)},n.saveLiveCustomCategories=async function(){try{if(Xo.filter(n=>n.name.trim()).length!==Xo.length)return void mn("请填写所有分类的名称","error");const n=e(),t=`liveCategories_${vt||"main"}`;await n.xSettings.put({id:t,categories:Xo,updatedAt:(new Date).toISOString()}),vr(),mn("直播分类设置已保存","success"),xr()}catch(n){console.error("保存直播分类失败:",n),mn("保存失败: "+n.message,"error")}},n.syncLivePageAvatar=gr,n.toggleLiveActionButtons=function(){const e=document.getElementById("live-refresh-btn"),t=document.getElementById("live-start-btn"),o=document.getElementById("live-main-btn"),a=document.getElementById("live-main-icon");e&&t&&o&&a&&(n.liveBtnExpanded=!n.liveBtnExpanded,n.liveBtnExpanded?(o.style.transform="rotate(45deg)",a.style.transform="rotate(-45deg)",setTimeout(()=>{e.style.transform="scale(1) translateX(0)",e.style.opacity="1"},50),setTimeout(()=>{t.style.transform="scale(1) translateX(0)",t.style.opacity="1"},100)):(o.style.transform="scale(1)",a.style.transform="rotate(0deg)",e.style.transform="scale(0) translateX(15px)",e.style.opacity="0",t.style.transform="scale(0) translateX(-15px)",t.style.opacity="0"))},n.refreshLiveStreams=async function(){console.log("🔴 [直播刷新] 开始刷新直播列表...");const e=document.getElementById("live-refresh-btn");if(e){const n=e.querySelector("svg");n&&(n.style.animation="spin 1s linear")}try{const{db:e,xDb:t,apiConfig:o,xSettings:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:l,boundCharacters:c}=a,p=s.buildUserXProfileInfo(n.userProfileData);let m=0,x=s.buildBaseSystemPrompt({userPrompt:i,worldSetting:l});m=d.logTokenUsage("直播刷新生成器","基础系统提示词",x,m);const u=await s.getApplicableWorldBooks("live",{boundCharacters:c});u&&(x+=u,m=d.logTokenUsage("直播刷新生成器","世界书内容",u,m)),x+='\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务说明 🎯\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是X社交平台的直播内容生成器。请生成当前的直播数据。\n\n【生成要求】：\n- 为"语音直播"和"视频直播"各生成3个直播间\n- 如果有自定义直播分类，也为每个分类生成3个直播间\n- 直播内容要多样化，符合分类特点\n- 直播者可以是绑定角色、绑定NPC或虚构的普通用户\n- 绑定角色是否正在直播由AI根据角色人设和兴趣决定\n\n【直播数据格式】：\n- 直播标题：简洁有趣，符合直播内容\n- 直播者信息：姓名、句柄、头像、认证状态\n- 直播时长：合理的时长（如 "1h 23m", "2h 15m", "35m"等）\n- 在线人数：1-2000之间的合理数字\n- 直播类别：符合分类的具体标签\n- 直播间简介：可选，简短描述直播内容\n\n🚨 **重要：你必须只返回有效的JSON格式数据，任何语法错误都会导致系统崩溃！** 🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';const h=x.substring(x.lastIndexOf("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"));m=d.logTokenUsage("直播刷新生成器","核心任务说明",h,m);const f=await s.buildCompleteCharacterInfo(c,p,"live");f&&(x+=f,m=d.logTokenUsage("直播刷新生成器","角色资料信息",f,m));const b=await g.loadBoundNPCs();if(b.length>0){const n=x.length;x+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 绑定NPC资料（可作为直播者）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n以下NPC可以作为直播者出现：\n";for(const n of b)x+=`\n【NPC信息】\n- X姓名：${n.name}\n- X句柄：${n.handle}\n- X头像：${n.avatar}\n- 认证状态：false\n【人设描述】\n${n.personality||"暂无人设描述"}\n【发帖习惯/兴趣】\n${n.postingHabits||"暂无描述"}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const e=x.substring(n);m=d.logTokenUsage("直播刷新生成器","NPC资料信息",e,m)}const v=Xo.filter(n=>n.enabled&&n.name.trim());v.length>0&&(x+="\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📂 自定义直播分类\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",v.forEach(n=>{x+=`\n【${n.name}】\n- 分类描述：${n.description||"无描述"}\n- 生成要求：为此分类生成3个相关的直播间\n`}),x+="━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n",m=d.logTokenUsage("直播刷新生成器","自定义分类信息",x.substring(x.lastIndexOf("📂 自定义直播分类")),m));const y=x.length;x+=s.buildUniversalConstraints(p);const w=x.substring(y);m=d.logTokenUsage("直播刷新生成器","用户约束信息",w,m);let k='{\n  "audio": [\n    {\n      "title": "直播标题",\n      "streamerName": "主播姓名",\n      "streamerHandle": "@句柄",\n      "streamerAvatar": "头像链接",\n      "description": "直播间简介（可选）",\n      "onlineCount": 数字,\n      "category": "直播类别",\n      "duration": "直播时长",\n      "isLive": true\n    }\n  ],\n  "video": [\n    {\n      "title": "直播标题", \n      "streamerName": "主播姓名",\n      "streamerHandle": "@句柄",\n      "streamerAvatar": "头像链接",\n      "description": "直播间简介（可选）",\n      "onlineCount": 数字,\n      "category": "直播类别", \n      "duration": "直播时长",\n      "isLive": true\n    }\n  ]';v.length>0&&v.forEach(n=>{k+=`,\n  "${n.id}": [\n    {\n      "title": "直播标题",\n      "streamerName": "主播姓名", \n      "streamerHandle": "@句柄",\n      "streamerAvatar": "头像链接",\n      "description": "直播间简介（可选）",\n      "onlineCount": 数字,\n      "category": "直播类别",\n      "duration": "直播时长", \n      "isLive": true\n    }\n  ]`}),k+="\n}",x+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n📋 JSON返回格式 - 严格执行 📋\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️ 必须返回完全有效的JSON，任何语法错误都将导致解析失败！\n\n${k}\n\n🚨 【JSON语法严格要求】🚨\n1. **字符串值**：必须用双引号包围，内容中的引号必须转义为\\"\n2. **数字值**：onlineCount直接写数字，不要加引号 ✅ "onlineCount": 156 ❌ "onlineCount": "156"\n3. **布尔值**：isLive固定为true，不加引号 ✅ "isLive": true ❌ "isLive": "true"\n4. **数组**：用[]包围，元素间用逗号分隔，最后一个元素后不要逗号\n5. **对象**：用{}包围，键必须用双引号，最后一个元素后不要逗号\n\n🔒 【必需字段检查】🔒\n每个直播间必须包含：title, streamerName, streamerHandle, streamerAvatar, onlineCount, category, duration, isLive\n其中 description 是可选字段\n\n【直播者选择策略】：\n1. 绑定角色：根据角色人设、兴趣、X资料等判断是否适合直播，如果适合则可作为主播\n2. 绑定NPC：根据NPC人设和发帖习惯判断是否适合直播\n3. 虚构用户：创建符合直播内容的虚构主播\n4. 头像规则：\n   - 绑定角色：使用角色的xAvatar\n   - 绑定NPC：使用NPC的avatar\n   - 虚构用户：使用默认头像 https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg\n5. 认证状态：绑定角色根据xVerified，绑定NPC和虚构用户默认false\n\n【内容质量要求】：\n1. 直播标题要有趣吸引人，符合分类特点\n2. 在线人数要合理（1-2000），热门内容人数可以多一些\n3. 直播时长要现实合理（15分钟到8小时之间）\n4. 直播类别要具体且符合内容（如"音乐分享"、"技术教程"、"游戏娱乐"等）\n5. 直播间简介简洁明了，1-2句话描述直播内容\n\n请直接返回JSON数据，不要添加任何解释文字或markdown标记。\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;const $=x.substring(x.lastIndexOf("📋 JSON返回格式"));m=d.logTokenUsage("直播刷新生成器","JSON格式要求",$,m);const C=[{role:"user",content:"请生成新的X直播平台直播数据。\n\n⚠️ 关键要求：\n1. 必须返回完全有效的JSON格式，不要有任何语法错误\n2. 严格按照上述示例的格式和字段类型\n3. 数字字段不要加引号，布尔值不要加引号\n4. 字符串中的引号必须转义\n5. 不要在对象或数组末尾添加多余的逗号\n\n请直接返回JSON，不要添加任何解释文字。"}],I=C[0].content;d.logFinalPrompt("直播刷新生成器",x,I);const S=await g.sendAIRequest({apiConfig:o,systemPrompt:x,messages:C,temperature:.8});let M=g.parseJSONResponse(S);if(M=await g.postProcessData(M,p),!M.audio||!M.video)throw new Error("AI返回的数据格式不正确，缺少必要字段");const T=await t.xCharacterProfiles.toArray();console.log(`🔍 [直播头像修正] 已加载 ${T.length} 个角色的X资料`);const A=Date.now(),E=(n,e)=>n.map((n,t)=>{const o={...n,id:`${e}_${A}_${t}`,background:Vo(),createdAt:A};if(o.streamerHandle){const n=r.clean(o.streamerHandle),e=T.find(e=>r.clean(e.xHandle)===n);if(e&&e.xAvatar)console.log(`🔧 [直播头像修正] 角色: ${e.xName} (@${n})`),console.log(`   AI头像: ${o.streamerAvatar.substring(0,50)}...`),console.log(`   真实头像: ${e.xAvatar.substring(0,50)}...`),o.streamerAvatar=e.xAvatar,o.streamerName=e.xName,o.streamerHandle=e.xHandle;else{const e=b.find(e=>r.clean(e.handle)===n);e&&e.avatar&&(o.streamerAvatar=e.avatar,o.streamerName=e.name,o.streamerHandle=e.handle)}}return o});M.audio=E(M.audio,"audio"),M.video=E(M.video,"video"),v.forEach(n=>{M[n.id]&&Array.isArray(M[n.id])&&(M[n.id]=E(M[n.id],n.id))}),Go.audio=M.audio,Go.video=M.video,v.forEach(n=>{M[n.id]&&(Go[n.id]=M[n.id])});try{const n={id:"liveStreams",audio:M.audio,video:M.video,lastUpdated:(new Date).toISOString()};v.forEach(e=>{M[e.id]&&(n[e.id]=M[e.id])}),await t.xTweetsData.put(n)}catch(n){console.error("⚠️ 保存直播数据失败:",n)}const z=[],B=[...M.audio,...M.video,...Object.keys(M).filter(n=>!["audio","video"].includes(n)).reduce((n,e)=>(Array.isArray(M[e])&&n.push(...M[e]),n),[])];if(c.length>0){const n=await t.xCharacterProfiles.toArray();for(const e of c){const t=n.find(n=>n.characterId===e);if(t){B.some(n=>n.streamerHandle===t.xHandle||n.streamerName===t.xName)&&z.push({characterId:e,xProfile:t,isLive:!0})}}}if(await br(z),await mr(z),"audio"===Fo||"video"===Fo)Wo(Fo);else{const n=document.getElementById("live-audio-content");if(n&&"none"!==n.style.display){const n=document.getElementById("live-audio-list");n&&Go[Fo]&&(n.innerHTML=Go[Fo].map((n,e)=>Jo(n,0,e)).join(""))}}const L=z.length,P=B.length,D="en"===Hn,N=n.userProfileData?.avatar||"https://i.postimg.cc/4xmx7V4R/mmexport1759081128356.jpg";Rl(L>0?{title:"X",message:D?`Live list refreshed! ${L} character${L>1?"s are":" is"} now streaming!`:`直播列表已刷新！${L}个绑定角色正在直播`,avatar:N,leftIcon:"x"}:{title:"X",message:D?`Live list refreshed! ${P} stream${P>1?"s":""} available`:`直播列表已刷新！共${P}个直播间`,avatar:N,leftIcon:"x"}),console.log("✅ [直播刷新] 刷新完成",{"总直播间数":P,"正在直播的角色":L,"自定义分类":v.length})}catch(n){console.error("❌ [直播刷新] 刷新失败:",n),mn(`直播刷新失败: ${n.message}`,"error")}finally{if(e){const n=e.querySelector("svg");n&&(n.style.animation="")}}},n.startLiveStream=function(){console.log("开启直播"),mn("直播功能开发中...","info")},n.syncLiveCharacterAvatars=mr,n.handleLiveCharacterClick=async function(n,t){if(t){console.log("🎬 [直播间] 点击正在直播的角色:",n);try{const t=e(),o=(await t.xCharacterProfiles.toArray()).find(e=>e.characterId===n);if(!o)return void mn("未找到角色信息","error");let a=null;for(const n in Go){const e=Go[n].find(n=>n.streamerHandle===o.xHandle||n.streamerName===o.xName);if(e){a=e;break}}a?(Ko={...a,type:a.category.includes("语音")||a.id.startsWith("audio")?"audio":"video"},Ia()):mn("未找到该角色的直播间","error")}catch(n){console.error("❌ [直播间] 进入失败:",n),mn("进入直播间失败","error")}}else console.log("角色未在直播:",n),mn("该角色当前未在直播","info")},n.loadSavedLiveData=hr,n.loadLiveCharacterStatus=fr,n.saveLiveCharacterStatus=br,n.handleLiveMainBtnMouseOver=function(){const n=document.getElementById("live-main-btn");n&&(n.style.transform="scale(1.1)")},n.handleLiveMainBtnMouseOut=function(){const e=document.getElementById("live-main-btn");e&&(e.style.transform=n.liveBtnExpanded?"rotate(45deg)":"scale(1)")},n.handleLiveMainBtnTouchStart=function(){const n=document.getElementById("live-main-btn");n&&(n.style.transform="scale(1.05)")},n.handleLiveMainBtnTouchEnd=function(){const e=document.getElementById("live-main-btn");e&&(e.style.transform=n.liveBtnExpanded?"rotate(45deg)":"scale(1)")},n.handleLiveSubBtnMouseOver=function(n){n&&(n.style.transform="scale(1.1)")},n.handleLiveSubBtnMouseOut=function(n){n&&(n.style.transform="scale(1)")},n.handleLiveSubBtnTouchStart=function(n){n&&(n.style.transform="scale(1.05)")},n.handleLiveSubBtnTouchEnd=function(n){n&&(n.style.transform="scale(1)")},void 0===n.liveBtnExpanded&&(n.liveBtnExpanded=!1),n.closeLiveRoom=Aa,n.toggleLiveInfo=function(){const n=document.getElementById("live-info-content"),e=document.getElementById("live-info-arrow");if(!n||!e)return;n.style.maxHeight&&"0px"!==n.style.maxHeight?(n.style.maxHeight="0",e.style.transform="rotate(0deg)"):(n.style.maxHeight=n.scrollHeight+"px",e.style.transform="rotate(180deg)")},n.sendDanmaku=rr,n.sendLike=dr,n.showLiveRoomMenu=pr,n.openToolModal=async function(){try{await async function(){console.log("✅ 道具数据库表schema已在x-core.js中定义")}(),function(){const n="x-tool-styles",e=document.getElementById(n);e&&(e.remove(),console.log("🔄 已删除旧的CSS样式，重新注入"));const t=document.createElement("style");t.id=n,t.textContent="\n/* ========== 道具系统主题变量 ========== */\n#x-tool-modal {\n  --tool-bg-primary: #1a1a1a;\n  --tool-bg-secondary: #000;\n  --tool-text-primary: #fff;\n  --tool-text-secondary: rgba(255, 255, 255, 0.6);\n  --tool-border-primary: rgba(255, 255, 255, 0.15);\n  --tool-border-secondary: rgba(255, 255, 255, 0.08);\n  --tool-card-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);\n  --tool-card-border: rgba(255, 255, 255, 0.12);\n  --tool-shadow: rgba(0, 0, 0, 0.6);\n  --tool-grid-line: rgba(255, 255, 255, 0.02);\n}\n\n/* 日间模式 */\n#x-social-screen.x-theme-light #x-tool-modal {\n  --tool-bg-primary: #e5e5e5;\n  --tool-bg-secondary: #fff;\n  --tool-text-primary: #333;\n  --tool-text-secondary: rgba(0, 0, 0, 0.5);\n  --tool-border-primary: rgba(0, 0, 0, 0.12);\n  --tool-border-secondary: rgba(0, 0, 0, 0.08);\n  --tool-card-bg: linear-gradient(135deg, rgba(0, 0, 0, 0.05) 0%, rgba(0, 0, 0, 0.02) 100%);\n  --tool-card-border: rgba(0, 0, 0, 0.1);\n  --tool-shadow: rgba(0, 0, 0, 0.2);\n  --tool-grid-line: rgba(0, 0, 0, 0.03);\n}\n\n/* 道具弹窗遮罩 */\n#x-tool-modal {\n  display: none;\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.85);\n  z-index: 10000;\n  backdrop-filter: blur(20px);\n  align-items: center;\n  justify-content: center;\n  padding: 0;\n  overflow: hidden;\n}\n\n#x-social-screen.x-theme-light #x-tool-modal {\n  background: rgba(255, 255, 255, 0.85);\n}\n\n/* 背景网格纹理 */\n#x-tool-modal::before {\n  content: '';\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-image:\n    linear-gradient(var(--tool-grid-line) 1px, transparent 1px),\n    linear-gradient(90deg, var(--tool-grid-line) 1px, transparent 1px);\n  background-size: 20px 20px;\n  pointer-events: none;\n}\n\n/* ========== 开机画面 ========== */\n.tool-boot-screen {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: var(--tool-bg-secondary);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 10001;\n  /* 🔧 移除自动淡出动画，改为JavaScript手动控制 */\n}\n\n@keyframes toolBootFadeOut {\n  to {\n    opacity: 0;\n    visibility: hidden;\n  }\n}\n\n.tool-boot-shell {\n  width: 90%;\n  max-width: 380px;\n  background: rgba(0, 0, 0, 0.95);\n  border: 3px solid var(--tool-border-primary);\n  padding: 24px;\n  position: relative;\n  clip-path: polygon(\n    16px 0,\n    calc(100% - 8px) 0,\n    100% 8px,\n    100% calc(100% - 60px),\n    calc(100% - 30px) calc(100% - 30px),\n    calc(100% - 60px) 100%,\n    0 100%,\n    0 16px\n  );\n  box-shadow: 0 20px 60px var(--tool-shadow);\n}\n\n#x-social-screen.x-theme-light .tool-boot-shell {\n  background: rgba(255, 255, 255, 0.95);\n}\n\n.tool-boot-logo {\n  font-size: 32px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  letter-spacing: 8px;\n  margin-bottom: 32px;\n  animation: logoGlow 2s ease-in-out infinite;\n  text-transform: uppercase;\n  text-align: center;\n}\n\n@keyframes logoGlow {\n  0%, 100% {\n    opacity: 1;\n    text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);\n  }\n  50% {\n    opacity: 0.7;\n    text-shadow: 0 0 20px rgba(255, 255, 255, 0.6);\n  }\n}\n\n.tool-boot-icon {\n  font-size: 48px;\n  margin-bottom: 24px;\n  animation: iconPulse 1.5s ease-in-out infinite;\n  text-align: center;\n}\n\n@keyframes iconPulse {\n  0%, 100% { transform: scale(1); }\n  50% { transform: scale(1.1); }\n}\n\n.tool-boot-info {\n  font-size: 10px;\n  color: var(--tool-text-secondary);\n  margin-bottom: 24px;\n  line-height: 1.6;\n}\n\n.tool-boot-info-item {\n  display: flex;\n  justify-content: space-between;\n  padding: 4px 0;\n  border-bottom: 1px solid var(--tool-border-secondary);\n  margin-bottom: 4px;\n}\n\n.tool-boot-progress {\n  margin-top: 32px;\n  position: relative;\n}\n\n.tool-boot-progress-label {\n  font-size: 9px;\n  color: var(--tool-text-secondary);\n  margin-bottom: 8px;\n  letter-spacing: 2px;\n  text-transform: uppercase;\n}\n\n.tool-boot-progress-bar {\n  width: 100%;\n  height: 12px;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid var(--tool-border-primary);\n  position: relative;\n  overflow: hidden;\n  clip-path: polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 0 100%, 0 6px);\n}\n\n#x-social-screen.x-theme-light .tool-boot-progress-bar {\n  background: rgba(0, 0, 0, 0.1);\n}\n\n.tool-boot-progress-fill {\n  height: 100%;\n  background: linear-gradient(90deg,\n    rgba(255, 255, 255, 0.3) 0%,\n    rgba(255, 255, 255, 0.5) 50%,\n    rgba(255, 255, 255, 0.3) 100%);\n  width: 0%;\n  /* 🔧 移除CSS自动动画，改为JavaScript控制width */\n  position: relative;\n  transition: width 0.3s ease-out; /* 平滑过渡 */\n}\n\n#x-social-screen.x-theme-light .tool-boot-progress-fill {\n  background: linear-gradient(90deg,\n    rgba(0, 0, 0, 0.2) 0%,\n    rgba(0, 0, 0, 0.3) 50%,\n    rgba(0, 0, 0, 0.2) 100%);\n}\n\n/* 🔧 移除CSS自动进度条动画，改为JavaScript手动控制 */\n/* @keyframes progressLoad 已禁用，进度条由JavaScript控制 */\n\n.tool-boot-progress-fill::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: repeating-linear-gradient(\n    90deg,\n    transparent,\n    transparent 4px,\n    rgba(255, 255, 255, 0.1) 4px,\n    rgba(255, 255, 255, 0.1) 8px\n  );\n}\n\n.tool-boot-progress-percent {\n  position: absolute;\n  top: 50%;\n  right: 8px;\n  transform: translateY(-50%);\n  font-size: 8px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  /* 🔧 移除百分比动画，改为JavaScript控制 */\n}\n\n/* 🔧 移除百分比淡入动画 */\n\n.tool-boot-scanline {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: 2px;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);\n  animation: scanMove 2s linear infinite;\n}\n\n#x-social-screen.x-theme-light .tool-boot-scanline {\n  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.2), transparent);\n}\n\n@keyframes scanMove {\n  from { transform: translateY(0); }\n  to { transform: translateY(300px); }\n}\n\n/* ========== PSP掌机外壳 ========== */\n.psp-shell {\n  width: 100%;\n  max-width: 380px;\n  background: rgba(0, 0, 0, 0.85);\n  border: 3px solid var(--tool-border-primary);\n  padding: 12px;\n  position: relative;\n  backdrop-filter: blur(20px);\n  box-shadow:\n    0 25px 80px var(--tool-shadow),\n    inset 0 1px 0 rgba(255, 255, 255, 0.1),\n    inset 0 -1px 0 rgba(0, 0, 0, 0.5);\n  clip-path: polygon(\n    16px 0,\n    calc(100% - 8px) 0,\n    100% 8px,\n    100% calc(100% - 60px),\n    calc(100% - 30px) calc(100% - 30px),\n    calc(100% - 60px) 100%,\n    0 100%,\n    0 16px\n  );\n  opacity: 1; /* 🔧 移除自动淡入动画，改为直接显示 */\n}\n\n/* 🔧 移除CSS自动淡入动画，PSP shell由JavaScript手动控制 */\n\n#x-social-screen.x-theme-light .psp-shell {\n  background: rgba(255, 255, 255, 0.85);\n  box-shadow:\n    0 25px 80px rgba(0, 0, 0, 0.2),\n    inset 0 1px 0 rgba(255, 255, 255, 0.8),\n    inset 0 -1px 0 rgba(0, 0, 0, 0.1);\n}\n\n.psp-shell::before,\n.psp-shell::after {\n  content: '';\n  position: absolute;\n  width: 6px;\n  height: 6px;\n  border-radius: 50%;\n  background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));\n  border: 1px solid var(--tool-border-primary);\n  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .psp-shell::before,\n#x-social-screen.x-theme-light .psp-shell::after {\n  background: radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.08));\n}\n\n.psp-shell::before {\n  top: 20px;\n  left: 8px;\n}\n\n.psp-shell::after {\n  top: 20px;\n  right: 8px;\n}\n\n.psp-top {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px 12px;\n  margin-bottom: 10px;\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);\n  border: 1px solid var(--tool-border-secondary);\n  clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);\n  position: relative;\n}\n\n#x-social-screen.x-theme-light .psp-top {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.04) 0%, rgba(0, 0, 0, 0.01) 100%);\n}\n\n.psp-top::before {\n  content: '';\n  position: absolute;\n  bottom: 0;\n  left: 20%;\n  right: 20%;\n  height: 1px;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);\n}\n\n#x-social-screen.x-theme-light .psp-top::before {\n  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.15), transparent);\n}\n\n.psp-logo {\n  font-size: 10px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  letter-spacing: 2px;\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.psp-leds {\n  display: flex;\n  gap: 6px;\n  align-items: center;\n}\n\n.led {\n  width: 6px;\n  height: 6px;\n  border-radius: 50%;\n  background: rgba(255, 255, 255, 0.2);\n  border: 1px solid rgba(255, 255, 255, 0.3);\n  box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.3);\n  animation: blink 2s infinite;\n}\n\n#x-social-screen.x-theme-light .led {\n  background: rgba(0, 0, 0, 0.15);\n  border-color: rgba(0, 0, 0, 0.2);\n}\n\n.led:nth-child(1) { animation-delay: 0s; }\n.led:nth-child(2) { animation-delay: 0.5s; }\n.led:nth-child(3) { animation-delay: 1s; }\n\n@keyframes blink {\n  0%, 100% { opacity: 0.3; }\n  50% {\n    opacity: 1;\n    box-shadow: 0 0 8px rgba(255, 255, 255, 0.6), inset 0 1px 1px rgba(255, 255, 255, 0.3);\n  }\n}\n\n.psp-screen {\n  background: rgba(0, 0, 0, 0.7);\n  border: 2px solid var(--tool-border-secondary);\n  padding: 12px;\n  position: relative;\n  overflow: hidden;\n  box-shadow:\n    inset 0 2px 10px rgba(0, 0, 0, 0.6),\n    inset 0 0 0 1px rgba(255, 255, 255, 0.05);\n  clip-path: polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%);\n}\n\n#x-social-screen.x-theme-light .psp-screen {\n  background: rgba(255, 255, 255, 0.7);\n  box-shadow:\n    inset 0 2px 10px rgba(0, 0, 0, 0.1),\n    inset 0 0 0 1px rgba(0, 0, 0, 0.05);\n}\n\n.screen-dots {\n  position: absolute;\n  top: 6px;\n  left: 6px;\n  display: flex;\n  gap: 3px;\n  z-index: 5;\n}\n\n.screen-dot {\n  width: 3px;\n  height: 3px;\n  border-radius: 50%;\n  background: rgba(255, 255, 255, 0.2);\n}\n\n#x-social-screen.x-theme-light .screen-dot {\n  background: rgba(0, 0, 0, 0.15);\n}\n\n.screen-scanline {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: 100%;\n  background: repeating-linear-gradient(\n    0deg,\n    transparent,\n    transparent 2px,\n    rgba(255, 255, 255, 0.03) 2px,\n    rgba(255, 255, 255, 0.03) 4px\n  );\n  pointer-events: none;\n  z-index: 1;\n}\n\n#x-social-screen.x-theme-light .screen-scanline {\n  background: repeating-linear-gradient(\n    0deg,\n    transparent,\n    transparent 2px,\n    rgba(0, 0, 0, 0.02) 2px,\n    rgba(0, 0, 0, 0.02) 4px\n  );\n}\n\n.tool-close-btn {\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  width: 28px;\n  height: 28px;\n  background: rgba(255, 255, 255, 0.08);\n  border: 1px solid var(--tool-border-primary);\n  border-radius: 50%;\n  cursor: pointer;\n  z-index: 10;\n  transition: all 0.3s;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .tool-close-btn {\n  background: rgba(0, 0, 0, 0.05);\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n.tool-close-btn:hover {\n  background: rgba(255, 255, 255, 0.15);\n  transform: rotate(90deg);\n}\n\n#x-social-screen.x-theme-light .tool-close-btn:hover {\n  background: rgba(0, 0, 0, 0.1);\n}\n\n.tool-close-btn:active {\n  transform: rotate(90deg) scale(0.9);\n}\n\n.tool-close-btn::before,\n.tool-close-btn::after {\n  content: '';\n  position: absolute;\n  width: 12px;\n  height: 2px;\n  background: var(--tool-text-primary);\n  border-radius: 1px;\n}\n\n.tool-close-btn::before { transform: rotate(45deg); }\n.tool-close-btn::after { transform: rotate(-45deg); }\n\n.screen-title {\n  font-size: 11px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  letter-spacing: 3px;\n  text-align: center;\n  margin-bottom: 10px;\n  text-transform: uppercase;\n  position: relative;\n  z-index: 2;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .screen-title {\n  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);\n}\n\n.content-split {\n  display: grid;\n  grid-template-columns: 1fr 110px;\n  gap: 10px;\n  position: relative;\n  z-index: 2;\n}\n\n.cards-area {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 6px;\n}\n\n.item-card {\n  aspect-ratio: 0.7;\n  background: var(--tool-card-bg);\n  border: 1px solid var(--tool-card-border);\n  padding: 6px;\n  cursor: pointer;\n  position: relative;\n  transition: all 0.3s;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  overflow: hidden;\n}\n\n.item-card:nth-child(6n+1) {\n  clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);\n}\n\n.item-card:nth-child(6n+2) {\n  clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 0 100%);\n}\n\n.item-card:nth-child(6n+3) {\n  clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);\n}\n\n.item-card:nth-child(6n+4) {\n  clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 calc(100% - 10px));\n}\n\n.item-card:nth-child(6n+5) {\n  clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);\n}\n\n.item-card:nth-child(6n+6) {\n  clip-path: polygon(0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%);\n}\n\n.item-card:hover {\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);\n  border-color: rgba(255, 255, 255, 0.25);\n  transform: translateY(-3px) scale(1.02);\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\n}\n\n#x-social-screen.x-theme-light .item-card:hover {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.08) 0%, rgba(0, 0, 0, 0.04) 100%);\n  border-color: rgba(0, 0, 0, 0.2);\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);\n}\n\n.item-card.has {\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);\n}\n\n#x-social-screen.x-theme-light .item-card.has {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.06) 0%, rgba(0, 0, 0, 0.03) 100%);\n}\n\n.envelope-line {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: 1px;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);\n  z-index: 1;\n}\n\n#x-social-screen.x-theme-light .envelope-line {\n  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);\n}\n\n.envelope-line::before,\n.envelope-line::after {\n  content: '';\n  position: absolute;\n  top: 0;\n  width: 1px;\n  height: 20px;\n  background: rgba(255, 255, 255, 0.1);\n}\n\n#x-social-screen.x-theme-light .envelope-line::before,\n#x-social-screen.x-theme-light .envelope-line::after {\n  background: rgba(0, 0, 0, 0.08);\n}\n\n.envelope-line::before { left: 30%; transform: rotate(25deg); }\n.envelope-line::after { right: 30%; transform: rotate(-25deg); }\n\n.card-corner-dots {\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  pointer-events: none;\n}\n\n.card-corner-dots::before,\n.card-corner-dots::after {\n  content: '';\n  position: absolute;\n  width: 2px;\n  height: 2px;\n  background: rgba(255, 255, 255, 0.3);\n  border-radius: 50%;\n}\n\n#x-social-screen.x-theme-light .card-corner-dots::before,\n#x-social-screen.x-theme-light .card-corner-dots::after {\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.card-corner-dots::before {\n  top: 3px;\n  left: 3px;\n}\n\n.card-corner-dots::after {\n  bottom: 3px;\n  right: 3px;\n}\n\n.item-icon {\n  font-size: 22px;\n  margin-bottom: 4px;\n  line-height: 1;\n  position: relative;\n  z-index: 2;\n}\n\n.item-name {\n  font-size: 7px;\n  color: var(--tool-text-secondary);\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  text-align: center;\n  position: relative;\n  z-index: 2;\n}\n\n.item-count {\n  position: absolute;\n  top: 3px;\n  right: 3px;\n  background: rgba(0, 0, 0, 0.7);\n  color: #ffffff;\n  font-size: 8px;\n  padding: 2px 4px;\n  border-radius: 3px;\n  font-weight: 700;\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  z-index: 3;\n}\n\n#x-social-screen.x-theme-light .item-count {\n  background: rgba(0, 0, 0, 0.65);\n  border-color: rgba(255, 255, 255, 0.3);\n}\n\n.rarity-corner {\n  position: absolute;\n  bottom: 3px;\n  left: 3px;\n  width: 5px;\n  height: 5px;\n  border-radius: 50%;\n  background: rgba(255, 255, 255, 0.3);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  z-index: 3;\n}\n\n#x-social-screen.x-theme-light .rarity-corner {\n  background: rgba(0, 0, 0, 0.2);\n  border-color: rgba(0, 0, 0, 0.15);\n}\n\n.item-card.rare .rarity-corner {\n  background: rgba(255, 255, 255, 0.8);\n  box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);\n  border-color: rgba(255, 255, 255, 0.5);\n}\n\n#x-social-screen.x-theme-light .item-card.rare .rarity-corner {\n  background: rgba(0, 0, 0, 0.6);\n  box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);\n  border-color: rgba(0, 0, 0, 0.4);\n}\n\n.gacha-machine {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  min-height: 400px;\n}\n\n.gacha-dome {\n  aspect-ratio: 1;\n  background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);\n  border: 2px solid rgba(255, 255, 255, 0.2);\n  border-radius: 50%;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  overflow: hidden;\n  box-shadow:\n    inset 0 -10px 20px rgba(0, 0, 0, 0.3),\n    inset 0 2px 4px rgba(255, 255, 255, 0.1),\n    0 4px 12px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .gacha-dome {\n  background: radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.08) 0%, rgba(0, 0, 0, 0.03) 100%);\n  border-color: rgba(0, 0, 0, 0.15);\n  box-shadow:\n    inset 0 -10px 20px rgba(0, 0, 0, 0.1),\n    inset 0 2px 4px rgba(255, 255, 255, 0.3),\n    0 4px 12px rgba(0, 0, 0, 0.1);\n}\n\n.gacha-dome::before {\n  content: '';\n  position: absolute;\n  top: 15%;\n  left: 20%;\n  width: 40%;\n  height: 30%;\n  background: radial-gradient(ellipse, rgba(255, 255, 255, 0.3) 0%, transparent 70%);\n  border-radius: 50%;\n  filter: blur(8px);\n}\n\n#x-social-screen.x-theme-light .gacha-dome::before {\n  background: radial-gradient(ellipse, rgba(255, 255, 255, 0.6) 0%, transparent 70%);\n}\n\n.gacha-dome::after {\n  content: '';\n  position: absolute;\n  bottom: -2px;\n  left: 20%;\n  right: 20%;\n  height: 8px;\n  background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);\n  border: 1px solid var(--tool-border-primary);\n  border-top: none;\n  border-radius: 0 0 8px 8px;\n}\n\n#x-social-screen.x-theme-light .gacha-dome::after {\n  background: linear-gradient(180deg, rgba(0, 0, 0, 0.06) 0%, rgba(0, 0, 0, 0.03) 100%);\n}\n\n.gacha-ball {\n  width: 50px;\n  height: 50px;\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);\n  border: 2px solid rgba(255, 255, 255, 0.3);\n  border-radius: 50%;\n  position: relative;\n  animation: float 3s ease-in-out infinite;\n  cursor: pointer;\n  box-shadow:\n    0 4px 12px rgba(0, 0, 0, 0.3),\n    inset 0 2px 4px rgba(255, 255, 255, 0.2);\n}\n\n#x-social-screen.x-theme-light .gacha-ball {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.12) 0%, rgba(0, 0, 0, 0.06) 100%);\n  border-color: rgba(0, 0, 0, 0.2);\n  box-shadow:\n    0 4px 12px rgba(0, 0, 0, 0.2),\n    inset 0 2px 4px rgba(255, 255, 255, 0.3);\n}\n\n.gacha-ball::before {\n  content: '';\n  position: absolute;\n  top: 50%;\n  left: 0;\n  right: 0;\n  height: 2px;\n  background: rgba(255, 255, 255, 0.3);\n  transform: translateY(-50%);\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .gacha-ball::before {\n  background: rgba(0, 0, 0, 0.2);\n  box-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);\n}\n\n.gacha-ball::after {\n  content: '';\n  position: absolute;\n  top: 20%;\n  left: 25%;\n  width: 12px;\n  height: 12px;\n  background: rgba(255, 255, 255, 0.5);\n  border-radius: 50%;\n  filter: blur(3px);\n}\n\n#x-social-screen.x-theme-light .gacha-ball::after {\n  background: rgba(255, 255, 255, 0.8);\n}\n\n@keyframes float {\n  0%, 100% { transform: translateY(0); }\n  50% { transform: translateY(-8px); }\n}\n\n.gacha-btns {\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n}\n\n.gacha-btn {\n  padding: 8px 6px;\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);\n  border: 1px solid var(--tool-border-primary);\n  color: var(--tool-text-primary);\n  font-family: 'Courier New', monospace;\n  font-size: 9px;\n  font-weight: 700;\n  letter-spacing: 1px;\n  cursor: pointer;\n  transition: all 0.3s;\n  text-align: center;\n  clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);\n  position: relative;\n  overflow: hidden;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .gacha-btn {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.06) 0%, rgba(0, 0, 0, 0.03) 100%);\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);\n}\n\n.gacha-btn::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 50%;\n  height: 100%;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);\n  transition: left 0.5s;\n}\n\n.gacha-btn:hover::before {\n  left: 100%;\n}\n\n.gacha-btn:hover {\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);\n  border-color: rgba(255, 255, 255, 0.25);\n  transform: translateY(-2px);\n  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .gacha-btn:hover {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.05) 100%);\n  border-color: rgba(0, 0, 0, 0.2);\n  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);\n}\n\n.gacha-btn:active {\n  transform: translateY(0) scale(0.95);\n}\n\n.gacha-cost {\n  font-size: 7px;\n  opacity: 0.6;\n  margin-top: 2px;\n}\n\n/* ========== 翻页控制器 ========== */\n.pagination-control {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 12px;\n  padding: 8px;\n  background: linear-gradient(0deg, rgba(255, 255, 255, 0.04) 0%, transparent 100%);\n  border: 1px solid var(--tool-border-secondary);\n  clip-path: polygon(0 6px, 6px 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 0 100%);\n  position: relative;\n  margin-top: auto;\n  margin-bottom: 6px;\n}\n\n#x-social-screen.x-theme-light .pagination-control {\n  background: linear-gradient(0deg, rgba(0, 0, 0, 0.03) 0%, transparent 100%);\n}\n\n.pagination-control::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 20%;\n  right: 20%;\n  height: 1px;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);\n}\n\n#x-social-screen.x-theme-light .pagination-control::before {\n  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);\n}\n\n.page-arrow {\n  width: 28px;\n  height: 28px;\n  background: rgba(255, 255, 255, 0.08);\n  border: 1px solid var(--tool-border-primary);\n  cursor: pointer;\n  transition: all 0.2s;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  position: relative;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .page-arrow {\n  background: rgba(0, 0, 0, 0.05);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.page-arrow.left {\n  clip-path: polygon(0 50%, 100% 0, 100% 100%);\n}\n\n.page-arrow.right {\n  clip-path: polygon(0 0, 100% 50%, 0 100%);\n}\n\n.page-arrow:hover {\n  background: rgba(255, 255, 255, 0.15);\n  transform: scale(1.1);\n}\n\n#x-social-screen.x-theme-light .page-arrow:hover {\n  background: rgba(0, 0, 0, 0.1);\n}\n\n.page-arrow:active {\n  transform: scale(0.9);\n}\n\n.page-arrow.disabled {\n  opacity: 0.3;\n  cursor: not-allowed;\n  pointer-events: none;\n}\n\n.page-arrow::before {\n  content: '';\n  position: absolute;\n  width: 8px;\n  height: 8px;\n  border-left: 2px solid var(--tool-text-primary);\n  border-bottom: 2px solid var(--tool-text-primary);\n}\n\n.page-arrow.left::before {\n  transform: rotate(45deg);\n  margin-left: 2px;\n}\n\n.page-arrow.right::before {\n  transform: rotate(-135deg);\n  margin-right: 2px;\n}\n\n.page-info {\n  font-family: 'Courier New', monospace;\n  font-size: 11px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  letter-spacing: 1px;\n  min-width: 50px;\n  text-align: center;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .page-info {\n  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);\n}\n\n/* ========== 商店和兑换按钮 ========== */\n.utility-btns {\n  display: flex;\n  flex-direction: column;\n  gap: 6px;\n  margin-top: 6px;\n}\n\n.utility-btn {\n  padding: 8px 6px;\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.03) 100%);\n  border: 1px solid var(--tool-border-primary);\n  color: var(--tool-text-primary);\n  font-family: 'Courier New', monospace;\n  font-size: 8px;\n  font-weight: 700;\n  letter-spacing: 1px;\n  cursor: pointer;\n  transition: all 0.3s;\n  text-align: center;\n  clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);\n  position: relative;\n  overflow: hidden;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 4px;\n}\n\n#x-social-screen.x-theme-light .utility-btn {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.04) 0%, rgba(0, 0, 0, 0.02) 100%);\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);\n}\n\n.utility-btn::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 50%;\n  height: 100%;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);\n  transition: left 0.5s;\n}\n\n.utility-btn:hover::before {\n  left: 100%;\n}\n\n.utility-btn:hover {\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);\n  border-color: rgba(255, 255, 255, 0.2);\n  transform: translateY(-2px);\n  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .utility-btn:hover {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.08) 0%, rgba(0, 0, 0, 0.04) 100%);\n  border-color: rgba(0, 0, 0, 0.15);\n  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);\n}\n\n.utility-btn:active {\n  transform: translateY(0) scale(0.95);\n}\n\n.utility-btn svg {\n  width: 10px;\n  height: 10px;\n  fill: var(--tool-text-primary);\n}\n\n.stats-bar {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 6px;\n  margin-top: 10px;\n  position: relative;\n  z-index: 2;\n}\n\n.stat {\n  padding: 6px;\n  background: rgba(255, 255, 255, 0.04);\n  border: 1px solid var(--tool-border-secondary);\n  text-align: center;\n  clip-path: polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 0 100%, 0 6px);\n  position: relative;\n  box-shadow:\n    inset 0 1px 0 rgba(255, 255, 255, 0.05),\n    0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n#x-social-screen.x-theme-light .stat {\n  background: rgba(0, 0, 0, 0.03);\n  box-shadow:\n    inset 0 1px 0 rgba(0, 0, 0, 0.05),\n    0 2px 4px rgba(0, 0, 0, 0.05);\n}\n\n.stat::before {\n  content: attr(data-icon);\n  position: absolute;\n  top: 50%;\n  left: 8px;\n  transform: translateY(-50%);\n  font-size: 10px;\n  opacity: 0.3;\n}\n\n.stat-val {\n  font-size: 14px;\n  font-weight: 700;\n  color: var(--tool-text-primary);\n  line-height: 1;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n\n#x-social-screen.x-theme-light .stat-val {\n  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);\n}\n\n.psp-controls {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-top: 12px;\n  padding: 10px 12px;\n  background: linear-gradient(0deg, rgba(255, 255, 255, 0.04) 0%, transparent 100%);\n  border: 1px solid var(--tool-border-secondary);\n  clip-path: polygon(0 8px, 8px 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%);\n  position: relative;\n}\n\n#x-social-screen.x-theme-light .psp-controls {\n  background: linear-gradient(0deg, rgba(0, 0, 0, 0.03) 0%, transparent 100%);\n}\n\n.psp-controls::before {\n  content: '';\n  position: absolute;\n  top: 0;\n  left: 20%;\n  right: 20%;\n  height: 1px;\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);\n}\n\n#x-social-screen.x-theme-light .psp-controls::before {\n  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);\n}\n\n.dpad {\n  width: 50px;\n  height: 50px;\n  position: relative;\n}\n\n.dpad-btn {\n  position: absolute;\n  width: 16px;\n  height: 16px;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid var(--tool-border-primary);\n  transition: all 0.2s;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n}\n\n#x-social-screen.x-theme-light .dpad-btn {\n  background: rgba(0, 0, 0, 0.06);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.dpad-btn:hover {\n  background: rgba(255, 255, 255, 0.15);\n  transform: scale(1.05);\n}\n\n#x-social-screen.x-theme-light .dpad-btn:hover {\n  background: rgba(0, 0, 0, 0.1);\n}\n\n.dpad-btn.up {\n  top: 0;\n  left: 50%;\n  transform: translateX(-50%);\n  clip-path: polygon(50% 0, 100% 100%, 0 100%);\n}\n\n.dpad-btn.down {\n  bottom: 0;\n  left: 50%;\n  transform: translateX(-50%);\n  clip-path: polygon(0 0, 100% 0, 50% 100%);\n}\n\n.dpad-btn.left {\n  left: 0;\n  top: 50%;\n  transform: translateY(-50%);\n  clip-path: polygon(0 50%, 100% 0, 100% 100%);\n}\n\n.dpad-btn.right {\n  right: 0;\n  top: 50%;\n  transform: translateY(-50%);\n  clip-path: polygon(0 0, 100% 50%, 0 100%);\n}\n\n.action-btns {\n  display: flex;\n  gap: 8px;\n}\n\n@keyframes roll {\n  0% { transform: rotate(0deg) scale(1); }\n  50% { transform: rotate(180deg) scale(1.15); }\n  100% { transform: rotate(360deg) scale(1); }\n}\n\n.gacha-ball.rolling {\n  animation: roll 1s ease-in-out;\n}\n\n@keyframes cardPop {\n  0% {\n    transform: scale(0) rotate(-90deg);\n    opacity: 0;\n  }\n  60% {\n    transform: scale(1.15) rotate(5deg);\n  }\n  100% {\n    transform: scale(1) rotate(0deg);\n    opacity: 1;\n  }\n}\n\n.item-card.new {\n  animation: cardPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n}\n\n@media (max-width: 360px) {\n  .cards-area {\n    grid-template-columns: repeat(3, 1fr);\n    gap: 5px;\n  }\n\n  .content-split {\n    grid-template-columns: 1fr 100px;\n    gap: 8px;\n  }\n\n  .item-icon {\n    font-size: 20px;\n  }\n\n  .item-name {\n    font-size: 6px;\n  }\n}\n",document.head.appendChild(t),console.log("✅ X Tool System: 样式已注入")}(),function(){if(document.getElementById("x-tool-modal"))return void console.log("⚠️ 道具弹窗已存在，跳过创建");const n=document.createElement("div");n.id="x-tool-modal",n.innerHTML='\n      \x3c!-- 开机画面 --\x3e\n      <div class="tool-boot-screen" id="tool-boot-screen">\n        <div class="tool-boot-shell">\n          <div class="tool-boot-scanline"></div>\n          <div class="tool-boot-content">\n            <div class="tool-boot-icon">◆</div>\n            <div class="tool-boot-logo">INVENTORY</div>\n            <div class="tool-boot-info">\n              <div class="tool-boot-info-item">\n                <span>SYSTEM</span>\n                <span>v3.0.1</span>\n              </div>\n              <div class="tool-boot-info-item">\n                <span>BUILD</span>\n                <span>20250129</span>\n              </div>\n              <div class="tool-boot-info-item">\n                <span>MODE</span>\n                <span>STANDARD</span>\n              </div>\n            </div>\n            <div class="tool-boot-progress">\n              <div class="tool-boot-progress-label">Loading Assets...</div>\n              <div class="tool-boot-progress-bar">\n                <div class="tool-boot-progress-fill"></div>\n                <div class="tool-boot-progress-percent" id="tool-boot-percent">0%</div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- PSP掌机外壳 --\x3e\n      <div class="psp-shell">\n        <div class="psp-top">\n          <div class="psp-logo">\n            <span>◆</span>\n            INVENTORY\n          </div>\n          <div class="psp-leds">\n            <div class="led"></div>\n            <div class="led"></div>\n            <div class="led"></div>\n          </div>\n        </div>\n\n        <div class="psp-screen">\n          <div class="screen-scanline"></div>\n          <div class="screen-dots">\n            <div class="screen-dot"></div>\n            <div class="screen-dot"></div>\n            <div class="screen-dot"></div>\n          </div>\n          <div class="tool-close-btn" onclick="closeToolModal()"></div>\n\n          <div class="screen-title">▪ ITEMS ▪</div>\n\n          <div class="content-split">\n            <div class="cards-area" id="tool-cards-grid"></div>\n\n            <div class="gacha-machine">\n              <div class="gacha-dome">\n                <div class="gacha-ball" id="gacha-ball" onclick="shakeBall()"></div>\n              </div>\n              <div class="gacha-btns">\n                <button class="gacha-btn" onclick="rollOne()">\n                  ROLL 1\n                  <div class="gacha-cost">-100</div>\n                </button>\n                <button class="gacha-btn" onclick="rollTen()">\n                  ROLL 10\n                  <div class="gacha-cost">-900</div>\n                </button>\n              </div>\n              <div class="utility-btns">\n                <button class="utility-btn" onclick="openShopMarketplace()">\n                  <svg viewBox="0 0 24 24">\n                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>\n                  </svg>\n                  SHOP\n                </button>\n                <button class="utility-btn" onclick="openCoinExchange()">\n                  <svg viewBox="0 0 24 24">\n                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>\n                    <path d="M7.41 8.59L6 10l6 6 6-6-1.41-1.41L12 13.17z" transform="rotate(180 12 12)"/>\n                  </svg>\n                  EXCHANGE\n                </button>\n              </div>\n\n              <div class="pagination-control">\n                <div class="page-arrow left" id="page-prev" onclick="previousPage()"></div>\n                <div class="page-info" id="page-info">1/1</div>\n                <div class="page-arrow right" id="page-next" onclick="nextPage()"></div>\n              </div>\n            </div>\n          </div>\n\n          <div class="stats-bar">\n            <div class="stat" data-icon="■">\n              <div class="stat-val" id="tool-total">0</div>\n              <div class="shop-stat-label">Total</div>\n            </div>\n            <div class="stat" data-icon="◆">\n              <div class="stat-val" id="tool-types">0</div>\n              <div class="shop-stat-label">Types</div>\n            </div>\n            <div class="stat" data-icon="●">\n              <div class="stat-val" id="tool-coins">1000</div>\n              <div class="shop-stat-label">Coins</div>\n            </div>\n          </div>\n        </div>\n\n        <div class="psp-controls">\n          <div class="dpad">\n            <div class="dpad-btn up"></div>\n            <div class="dpad-btn down"></div>\n            <div class="dpad-btn left"></div>\n            <div class="dpad-btn right"></div>\n          </div>\n          <div class="action-btns">\n            <div class="shop-action-btn">×</div>\n            <div class="shop-action-btn">○</div>\n            <div class="shop-action-btn">□</div>\n            <div class="shop-action-btn">△</div>\n          </div>\n        </div>\n      </div>\n    ';const e=document.getElementById("x-social-screen");e?(e.appendChild(n),console.log("✅ 道具弹窗HTML已创建（已添加到x-social-screen内）")):(document.body.appendChild(n),console.log("⚠️ 道具弹窗HTML已创建（降级到body）"))}();const t=document.getElementById("x-tool-modal");t&&(t.style.display="flex"),function(){Oo=0;const n=document.getElementById("tool-boot-percent"),e=document.querySelector(".tool-boot-progress-fill");console.log("🎬 [开机动画] 启动缓慢的开机进度条..."),Uo=setInterval(()=>{Oo<90?(Oo+=.5,n&&(n.textContent=Math.floor(Oo)+"%"),e&&(e.style.width=Oo+"%")):90!==Oo&&90.5!==Oo||console.log("⏸️ [开机动画] 进度条到达90%，等待AI生成完毕...")},300)}();const o=e(),a=vt||"main",i=`tools_${a}`,r=await o.xTools.get(i);if(r&&r.scenarioGenerated)console.log("📦 [道具系统] 非首次进入，快速加载数据..."),await async function(){try{const n=e(),t=`tools_${vt||"main"}`,o=await n.xTools.get(t);o?(Eo=o.items||[],zo=o.coins||0,o.gachaPool&&o.gachaPool.length>0?(Lo=o.gachaPool,console.log("✅ 道具数据已加载:",Eo.length,"个道具,",zo,"coins,",Lo.length,"个扭蛋池道具")):console.warn("⚠️ 扭蛋池数据缺失，使用默认扭蛋池")):(console.warn("⚠️ 未找到道具数据，应该先触发情景生成"),Eo=[],zo=0)}catch(n){console.error("❌ 加载道具数据失败:",n)}}(),_o(),setTimeout(()=>{const n=document.querySelector(".tool-boot-screen");n&&(n.style.animation="toolBootFadeOut 0.5s ease-out forwards"),console.log("🎬 [道具系统] 开机画面已关闭（非首次进入）")},1500),setTimeout(async()=>{if("function"==typeof n.generateShopProducts)try{const e=`shopProducts_${a}`,t=await o.xAccountProfiles.get(e);t&&t.products&&0!==t.products.length?console.log("✅ [第十八情景] 商品数据已存在，共",t.products.length,"个商品"):(console.log("🛍️ [第十八情景] 检测到无商品数据，启动后台生成..."),n.generateShopProducts().catch(n=>{console.error("❌ [第十八情景] 商品生成失败（非阻塞）:",n)}))}catch(n){console.error("❌ [第十八情景] 检查商品数据失败:",n)}},100);else{console.log("🎮 [第十七情景] 首次进入道具系统，开始生成初始化数据...");const e=async function(){try{console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("🎮 [第十七情景] 道具系统初始化生成器启动"),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");let e=0;console.log("📦 [第十七情景] 正在加载API配置和用户设置...");const{apiConfig:t,xSettings:o,xDb:a}=await g.loadConfigAndSettings(),{userPrompt:i,worldSetting:r}=o;console.log("✅ [第十七情景] API配置加载完成"),console.log("👤 [第十七情景] 正在读取用户个人资料...");const s=n.userProfileData||{},l=s.publicIdentity||"",c=s.name||"用户",p=s.handle||"@user",m=s.bio||"";console.log("📋 [第十七情景] 用户信息:"),console.log(`   - 用户名: ${c}`),console.log(`   - 句柄: ${p}`),console.log(`   - 公众身份: ${l||"普通人"}`),console.log("   - 个人简介: "+(m?m.substring(0,50)+(m.length>50?"...":""):"无")),console.log("💰 [第十七情景] 初始coins将由AI根据用户身份智能分配");let x="";i.trim()&&(x+=i.trim()+"\n\n",e=d.logTokenUsage("道具系统初始化生成器","用户自定义提示词",x,e));const u=x.length;x+="【世界观设定约束】：\n",r.trim()?(x+=`${r.trim()}\n上述世界观设定是最高优先级的约束条件，必须严格遵守。\n\n`,console.log("🌍 [第十七情景] 已注入世界观设定")):(x+="无特殊世界观限制，但内容需健康正面，符合常识。\n\n",console.log("ℹ️ [第十七情景] 无自定义世界观设定，使用默认规则"));const h=x.substring(u);e=d.logTokenUsage("道具系统初始化生成器","世界观设定约束",h,e);const f=x.length;x+=`\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🎯 核心任务：道具系统初始化生成器（第十七情景）\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n你是道具系统的初始化生成器。你的任务是为用户生成完整的初始道具背包和扭蛋池数据库。\n\n【用户信息】：\n- 用户名：${c}\n- 用户句柄：${p}\n- 公众身份：${l||"普通人"}\n- 个人简介：${m||"无"}\n\n【强制性生成要求】：\n\n0️⃣ **初始金币（initialCoins）智能分配**（必须由你根据用户信息判断）：\n   🚨 **硬性要求**：\n   - 必须根据用户的公众身份、个人简介、世界观设定进行综合判断\n   - 不要使用固定值，要根据实际情况灵活分配\n\n   💰 **分配参考标准**（仅供参考，可灵活调整）：\n   - 富豪/企业家/商人：4000-6000 coins\n   - 明星/艺人/网红/博主：2000-4000 coins\n   - 专业人士（医生/律师/教师/艺术家/作家）：1000-2000 coins\n   - 普通白领/职员：500-1000 coins\n   - 学生/实习生/新人：200-500 coins\n   - 其他情况：根据具体身份和世界观合理判断\n\n   📋 **判断依据**：\n   - 优先根据公众身份判断社会地位和经济实力\n   - 参考个人简介中的职业、成就、背景信息\n   - 符合当前世界观设定（例如末世背景coins应该少，富裕时代coins可以多）\n   - 确保分配合理，不要过高或过低\n\n   ⚠️ **重要**：initialCoins必须是100-10000之间的整数（100的倍数最佳）\n\n1️⃣ **初始道具背包**（必须生成6-10个道具）：\n   🚨 **硬性要求**：\n   - 最少6个，最多10个，建议8-10个\n   - 每个道具必须100%符合用户的公众身份"${l||"普通人"}"\n   - 绝对不允许脱离人设（例如：学生不能有豪车、普通人不能有私人飞机）\n   - 道具必须合理、实用、符合日常生活\n\n   📋 **必需字段**（缺一不可）：\n   - name: 中文名称，简短精确（2-6个汉字）\n   - icon: 单个emoji或符号（如📱🔑💰）\n   - count: 数量（1-10之间的整数）\n   - rarity: 稀有度（"common" 或 "rare"，初始道具以common为主，rare不超过2个）\n   - category: 中文分类（自由创造，符合道具特性即可）\n\n2️⃣ **扭蛋池道具库**（必须生成100-300个道具）：\n   🚨 **硬性要求**：\n   - **最少100个，推荐150-300个** - 这是强制要求，不得少于100个！\n   - 必须严格符合当前世界观设定（绝对禁止出现超越世界观的物品）\n   - 道具名称要富有创意、有趣、多样化，避免重复和单调\n   - 分类要多样化且有趣，可以自由创造新分类\n\n   📊 **稀有度分布**（严格遵守）：\n   - common（普通）：70-75%，权重范围 20-30\n   - rare（稀有）：25-30%，权重范围 2-10\n   - 示例：如果生成150个道具，则common约105-112个，rare约38-45个\n\n   📋 **必需字段**（缺一不可）：\n   - name: 中文名称，简短有趣（2-6个汉字）\n   - icon: 单个emoji或符号\n   - rarity: "common" 或 "rare"\n   - weight: 整数权重（common: 20-30, rare: 2-10）\n   - category: 中文分类（自由创造，符合道具特性即可）\n\n3️⃣ **道具分类创造指南**（鼓励创意，以下仅为参考）：\n\n   💡 **分类创造原则**（重要！）：\n   - ✨ **自由发挥**：可以创造任何有趣的中文分类名称\n   - 🎨 **富有创意**：鼓励使用有趣、新颖、贴切的分类名\n   - 📝 **简短有力**：分类名称2-4个汉字最佳\n   - 🌈 **多样化**：建议创造5-10个不同分类\n   - 🎯 **符合世界观**：分类要贴合当前世界观和用户身份\n\n   📚 **分类示例参考**（不强制使用，激发灵感用）：\n\n   **常规分类**：\n   - 日用品、装备、消耗品、收藏品、特殊道具\n\n   **创意分类**（鼓励使用这类有趣的分类）：\n   - 治愈系、青春记忆、奇幻小物、情感寄托、幸运物\n   - 神秘物品、时光宝盒、心愿物语、温暖时刻、魔法碎片\n   - 怀旧珍藏、惊喜盲盒、梦想碎片、回忆拼图、奇迹见证\n\n   **根据世界观自创**：\n   - 如果是现代都市：时尚单品、数码产品、潮流饰品、网红好物\n   - 如果是古代背景：江湖奇物、文房四宝、古董珍玩、武林秘宝\n   - 如果是校园青春：学习用品、社团装备、青春纪念、校园回忆\n\n   **道具示例**（仅供参考）：\n   - 手机、钥匙、钱包、背包、雨伞、充电宝、耳机、水杯\n   - 帽子、围巾、手套、眼镜、手表、项链、戒指、耳环\n   - 零食、饮料、水果、药品、糖果、咖啡、茶叶\n   - 照片、明信片、纪念币、海报、手办、签名、卡片\n   - 幸运符、许愿币、神秘钥匙、古董、限定版物品\n\n【世界观一致性检查】：\n${r?`当前世界观：${r}\n   ⚠️ 所有道具必须100%符合上述世界观，禁止出现不符合时代/设定的物品！`:"⚠️ 现代都市背景，禁止出现科幻/魔法/古代/未来物品！"}\n\n【质量标准】：\n✅ **必须做到**：\n- 🎨 **创造性**：道具名称有创意、有趣、独特，避免千篇一律\n- 🌟 **趣味性**：分类命名富有想象力，能让人会心一笑\n- 🎯 **多样性**：道具类型丰富多彩，不要重复单调\n- 💯 **符合性**：完美匹配用户身份和世界观设定\n- 😊 **生动性**：emoji图标选择恰当、形象、有趣\n- 🔥 **惊喜感**：让每个道具都有存在的意义和故事感\n\n❌ **绝对禁止**：\n- 重复的道具名称（每个道具都应该是独一无二的）\n- 不符合世界观的物品（严格遵守设定）\n- 脱离用户身份的奢侈品（除非用户是富豪/明星）\n- 分类命名单调乏味（要有创意和趣味性！）\n- 道具数量不足（扭蛋池少于100个）\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🚨🚨🚨 JSON格式强制规范 🚨🚨🚨\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n⚠️ **你必须严格遵守以下JSON格式要求，否则会导致系统崩溃！**\n\n【返回内容规则】：\n✅ **只能返回纯JSON对象**，从 { 开始，到 } 结束\n❌ **绝对禁止**：\n   - 不要任何解释、说明、注释文字\n   - 不要 \`\`\`json 或 \`\`\` 代码块标记\n   - 不要 "好的"、"明白"、"以下是" 等开头语\n   - 不要 "完成"、"已生成" 等结尾语\n   - 不要任何中文或英文的额外说明\n\n【JSON格式规范】：\n1. 使用标准JSON格式，所有字符串必须用双引号 "\n2. 每个对象最后一个字段后面不要逗号\n3. 数组最后一个元素后面不要逗号\n4. 数字类型不要加引号（如 count: 1 而不是 "1"）\n5. 字符串内容可以包含emoji表情符号\n\n【完整JSON示例】（请严格参考此格式）：\n\n{\n  "initialCoins": 800,\n  "initialItems": [\n    {\n      "name": "智能手机",\n      "icon": "📱",\n      "count": 1,\n      "rarity": "common",\n      "category": "数码产品"\n    },\n    {\n      "name": "幸运手链",\n      "icon": "💝",\n      "count": 1,\n      "rarity": "rare",\n      "category": "情感寄托"\n    },\n    {\n      "name": "背包",\n      "icon": "🎒",\n      "count": 1,\n      "rarity": "common",\n      "category": "日用品"\n    },\n    {\n      "name": "钥匙串",\n      "icon": "🔑",\n      "count": 1,\n      "rarity": "common",\n      "category": "日用品"\n    },\n    {\n      "name": "水杯",\n      "icon": "🥤",\n      "count": 1,\n      "rarity": "common",\n      "category": "日用品"\n    },\n    {\n      "name": "耳机",\n      "icon": "🎧",\n      "count": 1,\n      "rarity": "common",\n      "category": "数码产品"\n    }\n  ],\n  "gachaPool": [\n    {\n      "name": "四叶草书签",\n      "icon": "🍀",\n      "rarity": "rare",\n      "weight": 5,\n      "category": "幸运物"\n    },\n    {\n      "name": "樱花糖果",\n      "icon": "🌸",\n      "rarity": "common",\n      "weight": 25,\n      "category": "治愈系"\n    },\n    {\n      "name": "复古相机",\n      "icon": "📷",\n      "rarity": "rare",\n      "weight": 8,\n      "category": "青春记忆"\n    },\n    {\n      "name": "星空明信片",\n      "icon": "✉️",\n      "rarity": "common",\n      "weight": 22,\n      "category": "情感寄托"\n    },\n    {\n      "name": "幸运硬币",\n      "icon": "🪙",\n      "rarity": "rare",\n      "weight": 6,\n      "category": "幸运物"\n    }\n  ]\n}\n\n🔴 **错误示例**（绝对不要这样返回）：\n\n错误1：带有说明文字\n\`\`\`\n好的，我为你生成了以下道具数据：\n{"initialCoins": 800, ...}\n已完成生成。\n\`\`\`\n\n错误2：使用代码块标记\n\`\`\`json\n{"initialCoins": 800, ...}\n\`\`\`\n\n错误3：多余逗号\n{\n  "initialCoins": 800,\n  "initialItems": [...],  ← 最后一个字段后面有逗号，错误！\n}\n\n错误4：字符串没加引号\n{\n  name: "手机"  ← 错误！应该是 "name": "手机"\n}\n\n✅ **正确示例**（必须这样返回）：\n\n{"initialCoins":800,"initialItems":[{"name":"智能手机","icon":"📱","count":1,"rarity":"common","category":"数码产品"}],"gachaPool":[{"name":"四叶草书签","icon":"🍀","rarity":"rare","weight":5,"category":"幸运物"}]}\n\n或者格式化的（推荐）：\n\n{\n  "initialCoins": 800,\n  "initialItems": [\n    {"name": "智能手机", "icon": "📱", "count": 1, "rarity": "common", "category": "数码产品"}\n  ],\n  "gachaPool": [\n    {"name": "四叶草书签", "icon": "🍀", "rarity": "rare", "weight": 5, "category": "幸运物"}\n  ]\n}\n\n🚨 **再次强调**：\n- 你的整个回复必须从 { 开始，以 } 结束\n- 不要任何其他字符、说明、解释\n- 直接返回JSON对象，其他什么都不要\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n💡 **分类创意提示**：\n- 不要只用"日用品"、"消耗品"等常规分类\n- 可以用"治愈系"、"青春记忆"、"情感寄托"、"幸运物"等有趣分类\n- 让每个分类都有故事感和情感共鸣\n\n💡 **数量要求**：\n- initialItems: 必须6-10个道具\n- gachaPool: 必须100-300个道具（推荐150-300个）\n\n🚨 **最终检查清单**：\n在返回前，请逐项确认：\n☑️ JSON格式100%正确：从{开始到}结束，不含任何额外文字\n☑️ 没有代码块标记（不要\`\`\`json或\`\`\`）\n☑️ 没有多余逗号（对象最后字段后、数组最后元素后）\n☑️ 所有字符串使用双引号"\n☑️ 数字类型不加引号（count、weight、initialCoins）\n☑️ initialCoins 已根据用户身份智能判断（100-10000之间的整数）\n☑️ initialItems 有 6-10 个道具\n☑️ gachaPool 有 100-300 个道具（最少100个，推荐150-300个！）\n☑️ 所有道具都符合用户身份"${l||"普通人"}"\n☑️ 所有道具都符合世界观设定\n☑️ 所有字段都是中文（name, category）\n☑️ 稀有度分布合理（70%普通 + 30%稀有）\n☑️ 分类富有创意和趣味性（不要只用常规分类）\n☑️ 道具名称独特有趣，没有重复\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;const b=x.substring(f);e=d.logTokenUsage("道具系统初始化生成器","核心任务说明+用户信息+生成要求+JSON格式",b,e);const v=[{role:"user",content:"请为用户生成初始道具背包和扭蛋池数据"}];d.logFinalPrompt("道具系统初始化生成器",x,v[0].content),console.log("📤 [第十七情景] 正在向AI发送请求..."),console.log("   - Temperature: 0.8"),console.log("   - 预期生成: 3-10个初始道具, 50-100个扭蛋池道具");const y=await g.sendAIRequest({apiConfig:t,systemPrompt:x,messages:v,temperature:.8});console.log("📥 [第十七情景] AI响应已接收"),console.log(`   - 响应长度: ${y.length} 字符`),console.log("🔍 [第十七情景] 正在解析JSON数据...");let w=g.parseJSONResponse(y);if(!w.initialCoins||!w.initialItems||!w.gachaPool)throw new Error("AI返回的数据格式不正确，缺少initialCoins、initialItems或gachaPool字段");("number"!=typeof w.initialCoins||w.initialCoins<100||w.initialCoins>1e4)&&(console.warn(`⚠️ AI返回的initialCoins值不合理: ${w.initialCoins}，使用默认值500`),w.initialCoins=500),console.log("✅ [第十七情景] JSON解析成功"),console.log(`   - AI分配的初始coins: ${w.initialCoins}`),console.log(`   - 初始道具数量: ${w.initialItems.length}个`),console.log(`   - 扭蛋池道具数量: ${w.gachaPool.length}个`),w.initialItems.length>0&&(console.log("🎁 [第十七情景] 初始道具示例:"),w.initialItems.slice(0,3).forEach((n,e)=>{console.log(`   ${e+1}. ${n.icon} ${n.name} x${n.count} [${n.rarity}] (${n.category})`)}),w.initialItems.length>3&&console.log(`   ... 还有 ${w.initialItems.length-3} 个道具`)),w.gachaPool.length>0&&(console.log("🎰 [第十七情景] 扭蛋池道具示例:"),w.gachaPool.slice(0,5).forEach((n,e)=>{console.log(`   ${e+1}. ${n.icon} ${n.name} [${n.rarity}] 权重:${n.weight} (${n.category})`)}),w.gachaPool.length>5&&console.log(`   ... 还有 ${w.gachaPool.length-5} 个道具`)),console.log("💾 [第十七情景] 正在保存数据到数据库...");const k=vt||"main",$=`tools_${k}`;Eo=w.initialItems,zo=w.initialCoins,Lo=w.gachaPool,await a.xTools.put({id:$,accountId:k,items:Eo,coins:zo,gachaPool:w.gachaPool,scenarioGenerated:!0,generatedAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("✅ [第十七情景] 道具系统初始化完成！"),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log(`📦 数据已保存到数据库 (ID: ${$})`),console.log(`🎁 初始道具: ${Eo.length}个`),console.log(`🎰 扭蛋池: ${w.gachaPool.length}个道具`),console.log(`💰 初始coins: ${zo}`),console.log(`🕐 生成时间: ${(new Date).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"})}`),console.log("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.log("⏱️ [第十七情景] AI生成完毕，准备完成开机动画..."),_o(),setTimeout(()=>{const n=document.querySelector(".tool-boot-screen");n&&(n.style.animation="toolBootFadeOut 0.5s ease-out forwards"),console.log("🎬 [第十七情景] 开机画面已关闭"),setTimeout(()=>{mn(`道具系统初始化完成！获得 ${Eo.length} 个初始道具和 ${zo} coins`,"success")},500)},1500)}catch(n){console.error("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.error("❌ [第十七情景] 生成道具数据失败"),console.error("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),console.error("错误类型:",n.name),console.error("错误信息:",n.message),console.error("错误堆栈:",n.stack),console.error("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"),mn("道具系统初始化失败: "+n.message,"error"),Uo&&(clearInterval(Uo),Uo=null),setTimeout(()=>{const n=document.querySelector(".tool-boot-screen");n&&(n.style.animation="toolBootFadeOut 0.5s ease-out forwards"),console.log("🎬 [第十七情景] 错误恢复：开机画面已关闭")},1e3)}}();"function"==typeof n.generateShopProducts?n.generateShopProducts().catch(n=>{console.error("❌ [第十八情景] 商品生成失败（非阻塞）:",n)}):Promise.resolve();await e,"function"==typeof n.generateShopProducts?console.log("🛍️ [第十八情景] 已同时启动商城商品生成（后台运行）"):console.warn("⚠️ [第十八情景] generateShopProducts 函数未找到")}Ho(),console.log("✅ 道具弹窗已打开")}catch(n){console.error("❌ 打开道具弹窗失败:",n),mn("打开道具系统失败: "+n.message,"error")}},n.closeToolModal=function(){const n=document.getElementById("x-tool-modal");n&&(n.style.display="none"),console.log("✅ 道具弹窗已关闭")},n.rollOne=async function(){if(zo<100)return void mn("金币不足！需要100金币","error");zo-=100,jo();const n=document.getElementById("gacha-ball");n&&n.classList.add("rolling"),setTimeout(async()=>{n&&n.classList.remove("rolling");const e=Do(),t=Eo.find(n=>n.name===e.name);t?t.count+=1:Eo.push({name:e.name,icon:e.icon,count:1,rarity:e.rarity}),await Po(),Ho(),setTimeout(()=>{const n=document.querySelectorAll(".item-card.has"),t=Array.from(n).find(n=>{const t=n.querySelector(".item-name");return t&&t.textContent===e.name});t&&(t.classList.add("new"),setTimeout(()=>t.classList.remove("new"),500))},100),mn(`获得道具: ${e.icon} ${e.name} ${"rare"===e.rarity?"(稀有)":""}`,"success")},1e3)},n.rollTen=async function(){if(zo<900)return void mn("金币不足！需要900金币","error");zo-=900,jo();const n=document.getElementById("gacha-ball");n&&n.classList.add("rolling"),setTimeout(async()=>{n&&n.classList.remove("rolling");const e=[];for(let n=0;n<10;n++){const n=Do();e.push(n);const t=Eo.find(e=>e.name===n.name);t?t.count+=1:Eo.push({name:n.name,icon:n.icon,count:1,rarity:n.rarity})}await Po(),Ho();const t=e.filter(n=>"rare"===n.rarity).length;mn(`十连抽完成！获得 ${e.length} 个道具 (${t} 稀有)`,"success")},1e3)},n.shakeBall=function(){const n=document.getElementById("gacha-ball");n&&(n.style.animation="none",setTimeout(()=>{n.style.animation="float 3s ease-in-out infinite"},10))},n.updateExchangePreview=function(){const n=document.getElementById("exchange-amount-input"),e=document.getElementById("exchange-preview");if(!n||!e)return;const t=parseFloat(n.value)||0,o=document.getElementById("x-social-screen"),a=o&&o.classList.contains("x-theme-light");if(t<=0)return void(e.innerHTML=`\n        <div style="\n          font-size: 10px;\n          color: ${a?"rgba(0, 0, 0, 0.4)":"rgba(255, 255, 255, 0.4)"};\n          text-align: center;\n          font-family: 'Courier New', monospace;\n          letter-spacing: 0.5px;\n        ">ENTER AMOUNT</div>\n      `);const i=Math.floor(t/100);e.innerHTML=0===i?`\n        <div style="\n          font-size: 9px;\n          color: ${a?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.5)"};\n          text-align: center;\n          font-family: 'Courier New', monospace;\n          letter-spacing: 0.5px;\n          line-height: 1.4;\n        ">MIN: $100<br>FOR 1 COIN</div>\n      `:`\n        <div style="text-align: center;">\n          <div style="\n            font-size: 8px;\n            color: ${a?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.6)"};\n            margin-bottom: 6px;\n            font-family: 'Courier New', monospace;\n            letter-spacing: 1px;\n            text-transform: uppercase;\n          ">YOU WILL GET</div>\n          <div style="\n            font-size: 24px;\n            font-weight: 700;\n            color: var(--text-primary);\n            font-family: 'Courier New', monospace;\n            text-shadow: 0 1px 2px ${a?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.3)"};\n          ">+${i} COIN${i>1?"S":""}</div>\n          ${t%100!=0?`\n            <div style="\n              font-size: 7px;\n              color: ${a?"rgba(0, 0, 0, 0.4)":"rgba(255, 255, 255, 0.4)"};\n              margin-top: 6px;\n              font-family: 'Courier New', monospace;\n              letter-spacing: 0.5px;\n            ">REMAIN: $${(t%100).toFixed(2)}</div>\n          `:""}\n        </div>\n      `},n.confirmExchange=async function(){const n=document.getElementById("exchange-amount-input");if(!n)return;const e=parseFloat(n.value)||0;if(e<=0)return void mn("请输入有效的兑换金额","error");if(e<100)return void mn("最少需要 $100 才能兑换","error");const t=Math.floor(e/100),o=100*t;if(It.balance<o)mn(`余额不足！需要 $${o.toFixed(2)}，当前余额 $${It.balance.toFixed(2)}`,"error");else try{It.balance-=o,zo+=t;const n={id:"coin_exchange_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),description:`Exchange to ${t} Coin${t>1?"s":""}`,amount:-o,timestamp:(new Date).toISOString(),type:"coin_exchange"};It.transactions.unshift(n),await Tt(),await Po(),jo();const e=document.getElementById("exchange-modal");e&&e.remove(),mn(`兑换成功！获得 ${t} Coin${t>1?"s":""}`,"success"),console.log(`✅ 兑换成功: $${o} → ${t} Coins`)}catch(n){console.error("❌ 兑换失败:",n),mn("兑换失败: "+n.message,"error"),It.balance+=o,zo-=t}},n.previousPage=function(){Bo>1&&(Bo--,Ho(),Ro())},n.nextPage=function(){const n=No();Bo<n&&(Bo++,Ho(),Ro())},n.openCoinExchange=async function(){try{if(await Mt(),!It||!It.isActivated)return void mn("请先激活钱包才能使用兑换功能","error");!function(){const n=document.getElementById("x-social-screen"),e=n&&n.classList.contains("x-theme-light"),t=document.createElement("div");t.id="exchange-modal",t.style.cssText=`\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ${e?"rgba(255, 255, 255, 0.85)":"rgba(0, 0, 0, 0.85)"};\n      backdrop-filter: blur(20px);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 28;\n      animation: fadeIn 0.2s ease-out;\n    `;const o=document.createElement("div");o.style.cssText=`\n      width: 90%;\n      max-width: 380px;\n      background: ${e?"rgba(255, 255, 255, 0.95)":"rgba(0, 0, 0, 0.95)"};\n      border: 3px solid ${e?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.15)"};\n      padding: 16px;\n      position: relative;\n      backdrop-filter: blur(20px);\n      box-shadow: ${e?"0 25px 80px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8), inset 0 -1px 0 rgba(0, 0, 0, 0.1)":"0 25px 80px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.5)"};\n      clip-path: polygon(\n        16px 0,\n        calc(100% - 8px) 0,\n        100% 8px,\n        100% calc(100% - 40px),\n        calc(100% - 20px) calc(100% - 20px),\n        calc(100% - 40px) 100%,\n        0 100%,\n        0 16px\n      );\n    `,o.innerHTML=`\n      <style>\n        @keyframes exchangeFadeIn {\n          from { opacity: 0; transform: scale(0.95); }\n          to { opacity: 1; transform: scale(1); }\n        }\n        @keyframes exchangeScanMove {\n          from { transform: translateY(0); }\n          to { transform: translateY(400px); }\n        }\n        @keyframes exchangePulse {\n          0%, 100% { opacity: 0.3; }\n          50% { opacity: 1; box-shadow: 0 0 8px ${e?"rgba(0, 0, 0, 0.6)":"rgba(255, 255, 255, 0.6)"}; }\n        }\n        @keyframes exchangeFloat {\n          0%, 100% { transform: translateY(0); }\n          50% { transform: translateY(-6px); }\n        }\n        #exchange-modal-content {\n          animation: exchangeFadeIn 0.3s ease-out;\n        }\n      </style>\n\n      \x3c!-- 装饰螺丝钉 --\x3e\n      <div style="\n        position: absolute;\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background: ${e?"radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.08))":"radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1))"};\n        border: 1px solid ${e?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.15)"};\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);\n        top: 20px;\n        left: 8px;\n      "></div>\n      <div style="\n        position: absolute;\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background: ${e?"radial-gradient(circle at 30% 30%, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.08))":"radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1))"};\n        border: 1px solid ${e?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.15)"};\n        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);\n        top: 20px;\n        right: 8px;\n      "></div>\n\n      \x3c!-- 顶部标题栏 --\x3e\n      <div style="\n        padding: 8px 12px;\n        margin-bottom: 12px;\n        background: linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"} 0%, ${e?"rgba(0, 0, 0, 0.01)":"rgba(255, 255, 255, 0.02)"} 100%);\n        border: 1px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"};\n        clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);\n        position: relative;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      ">\n        <div style="\n          position: absolute;\n          bottom: 0;\n          left: 20%;\n          right: 20%;\n          height: 1px;\n          background: linear-gradient(90deg, transparent, ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"}, transparent);\n        "></div>\n\n        <div style="\n          font-size: 10px;\n          font-weight: 700;\n          color: var(--text-primary);\n          letter-spacing: 2px;\n          display: flex;\n          align-items: center;\n          gap: 4px;\n        ">\n          <span style="opacity: 0.5;">◆</span>\n          EXCHANGE\n        </div>\n\n        <div style="display: flex; gap: 6px; align-items: center;">\n          <div style="\n            width: 6px;\n            height: 6px;\n            border-radius: 50%;\n            background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            animation: exchangePulse 2s infinite;\n          "></div>\n          <div style="\n            width: 6px;\n            height: 6px;\n            border-radius: 50%;\n            background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            animation: exchangePulse 2s infinite 0.5s;\n          "></div>\n          <div style="\n            width: 6px;\n            height: 6px;\n            border-radius: 50%;\n            background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.2)":"rgba(255, 255, 255, 0.3)"};\n            animation: exchangePulse 2s infinite 1s;\n          "></div>\n        </div>\n      </div>\n\n      \x3c!-- 主屏幕区域 --\x3e\n      <div style="\n        background: ${e?"rgba(255, 255, 255, 0.7)":"rgba(0, 0, 0, 0.7)"};\n        border: 2px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"};\n        padding: 14px;\n        position: relative;\n        overflow: hidden;\n        box-shadow: ${e?"inset 0 2px 10px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(0, 0, 0, 0.05)":"inset 0 2px 10px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.05)"};\n        clip-path: polygon(0 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%);\n      ">\n        \x3c!-- 扫描线 --\x3e\n        <div style="\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          height: 100%;\n          background: repeating-linear-gradient(\n            0deg,\n            transparent,\n            transparent 2px,\n            ${e?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.03)"} 2px,\n            ${e?"rgba(0, 0, 0, 0.02)":"rgba(255, 255, 255, 0.03)"} 4px\n          );\n          pointer-events: none;\n          z-index: 1;\n        "></div>\n\n        \x3c!-- 装饰点 --\x3e\n        <div style="\n          position: absolute;\n          top: 6px;\n          left: 6px;\n          display: flex;\n          gap: 3px;\n          z-index: 5;\n        ">\n          <div style="width: 3px; height: 3px; border-radius: 50%; background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};"></div>\n          <div style="width: 3px; height: 3px; border-radius: 50%; background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};"></div>\n          <div style="width: 3px; height: 3px; border-radius: 50%; background: ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.2)"};"></div>\n        </div>\n\n        \x3c!-- 关闭按钮 --\x3e\n        <div onclick="document.getElementById('exchange-modal').remove();" style="\n          position: absolute;\n          top: 8px;\n          right: 8px;\n          width: 28px;\n          height: 28px;\n          background: ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.08)"};\n          border: 1px solid ${e?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.15)"};\n          border-radius: 50%;\n          cursor: pointer;\n          z-index: 10;\n          transition: all 0.3s;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          box-shadow: 0 2px 8px ${e?"rgba(0, 0, 0, 0.1)":"rgba(0, 0, 0, 0.2)"};\n        " onmouseover="this.style.background='${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.15)"}'; this.style.transform='rotate(90deg)';" onmouseout="this.style.background='${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.08)"}'; this.style.transform='rotate(0deg)';">\n          <div style="position: relative; width: 100%; height: 100%;">\n            <div style="\n              position: absolute;\n              top: 50%;\n              left: 50%;\n              width: 12px;\n              height: 2px;\n              background: var(--text-primary);\n              border-radius: 1px;\n              transform: translate(-50%, -50%) rotate(45deg);\n            "></div>\n            <div style="\n              position: absolute;\n              top: 50%;\n              left: 50%;\n              width: 12px;\n              height: 2px;\n              background: var(--text-primary);\n              border-radius: 1px;\n              transform: translate(-50%, -50%) rotate(-45deg);\n            "></div>\n          </div>\n        </div>\n\n        \x3c!-- 标题 --\x3e\n        <div style="\n          font-size: 11px;\n          font-weight: 700;\n          color: var(--text-primary);\n          letter-spacing: 3px;\n          text-align: center;\n          margin-bottom: 14px;\n          text-transform: uppercase;\n          position: relative;\n          z-index: 2;\n          text-shadow: 0 1px 2px ${e?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.3)"};\n        ">▪ COIN EXCHANGE ▪</div>\n\n        \x3c!-- 余额和币显示 --\x3e\n        <div style="\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 8px;\n          margin-bottom: 12px;\n          position: relative;\n          z-index: 2;\n        ">\n          <div style="\n            padding: 10px;\n            background: ${e?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.04)"};\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"};\n            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%, 0 8px);\n            position: relative;\n            box-shadow: ${e?"inset 0 1px 0 rgba(0, 0, 0, 0.05), 0 2px 4px rgba(0, 0, 0, 0.05)":"inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 4px rgba(0, 0, 0, 0.1)"};\n          ">\n            <div style="\n              position: absolute;\n              top: 50%;\n              left: 6px;\n              transform: translateY(-50%);\n              font-size: 12px;\n              opacity: 0.3;\n            ">$</div>\n            <div style="\n              font-size: 8px;\n              color: ${e?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.6)"};\n              text-transform: uppercase;\n              letter-spacing: 1px;\n              margin-bottom: 4px;\n              text-align: center;\n            ">WALLET</div>\n            <div style="\n              font-size: 16px;\n              font-weight: 700;\n              color: var(--text-primary);\n              font-family: 'Courier New', monospace;\n              text-align: center;\n              text-shadow: 0 1px 2px ${e?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.3)"};\n            ">${It.balance.toFixed(2)}</div>\n          </div>\n\n          <div style="\n            padding: 10px;\n            background: ${e?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.04)"};\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"};\n            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 0 100%, 0 8px);\n            position: relative;\n            box-shadow: ${e?"inset 0 1px 0 rgba(0, 0, 0, 0.05), 0 2px 4px rgba(0, 0, 0, 0.05)":"inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 2px 4px rgba(0, 0, 0, 0.1)"};\n          ">\n            <div style="\n              position: absolute;\n              top: 50%;\n              left: 6px;\n              transform: translateY(-50%);\n              font-size: 12px;\n              opacity: 0.3;\n            ">●</div>\n            <div style="\n              font-size: 8px;\n              color: ${e?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.6)"};\n              text-transform: uppercase;\n              letter-spacing: 1px;\n              margin-bottom: 4px;\n              text-align: center;\n            ">COINS</div>\n            <div style="\n              font-size: 16px;\n              font-weight: 700;\n              color: var(--text-primary);\n              font-family: 'Courier New', monospace;\n              text-align: center;\n              text-shadow: 0 1px 2px ${e?"rgba(255, 255, 255, 0.5)":"rgba(0, 0, 0, 0.3)"};\n            ">${zo}</div>\n          </div>\n        </div>\n\n        \x3c!-- 兑换率说明 --\x3e\n        <div style="\n          padding: 8px 10px;\n          background: ${e?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.04)"};\n          border: 1px solid ${e?"rgba(0, 0, 0, 0.06)":"rgba(255, 255, 255, 0.06)"};\n          margin-bottom: 12px;\n          position: relative;\n          z-index: 2;\n          clip-path: polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 0 100%, 0 6px);\n        ">\n          <div style="\n            font-size: 9px;\n            color: ${e?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.6)"};\n            text-align: center;\n            font-family: 'Courier New', monospace;\n            letter-spacing: 0.5px;\n          ">RATE: $100 = 1 COIN</div>\n        </div>\n\n        \x3c!-- 输入区域 --\x3e\n        <div style="margin-bottom: 12px; position: relative; z-index: 2;">\n          <label style="\n            display: block;\n            font-size: 8px;\n            color: ${e?"rgba(0, 0, 0, 0.5)":"rgba(255, 255, 255, 0.6)"};\n            margin-bottom: 6px;\n            font-weight: 700;\n            letter-spacing: 1px;\n            text-transform: uppercase;\n          ">AMOUNT ($)</label>\n          <input\n            type="number"\n            id="exchange-amount-input"\n            placeholder="0.00"\n            min="0"\n            step="0.01"\n            style="\n              width: 100%;\n              padding: 10px 12px;\n              background: ${e?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.4)"};\n              border: 2px solid ${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.15)"};\n              font-size: 16px;\n              color: var(--text-primary);\n              font-family: 'Courier New', monospace;\n              font-weight: 700;\n              transition: all 0.2s;\n              box-sizing: border-box;\n              clip-path: polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0 calc(100% - 6px), 0 6px);\n              box-shadow: ${e?"inset 0 2px 4px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.05)":"inset 0 2px 4px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1)"};\n            "\n            oninput="updateExchangePreview()"\n            onfocus="this.style.borderColor='${e?"rgba(0, 0, 0, 0.25)":"rgba(255, 255, 255, 0.3)"}'; this.style.background='${e?"rgba(255, 255, 255, 1)":"rgba(0, 0, 0, 0.6)"}'"\n            onblur="this.style.borderColor='${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.15)"}'; this.style.background='${e?"rgba(255, 255, 255, 0.8)":"rgba(0, 0, 0, 0.4)"}'"\n          />\n        </div>\n\n        \x3c!-- 预览区域 --\x3e\n        <div id="exchange-preview" style="\n          padding: 14px;\n          background: ${e?"rgba(0, 0, 0, 0.04)":"rgba(255, 255, 255, 0.06)"};\n          border: 1px solid ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"};\n          margin-bottom: 12px;\n          min-height: 60px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          position: relative;\n          z-index: 2;\n          clip-path: polygon(0 6px, 6px 0, calc(100% - 6px) 0, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0 calc(100% - 6px));\n          box-shadow: ${e?"inset 0 2px 6px rgba(0, 0, 0, 0.06)":"inset 0 2px 6px rgba(0, 0, 0, 0.3)"};\n        ">\n          <div style="\n            font-size: 10px;\n            color: ${e?"rgba(0, 0, 0, 0.4)":"rgba(255, 255, 255, 0.4)"};\n            text-align: center;\n            font-family: 'Courier New', monospace;\n            letter-spacing: 0.5px;\n          ">ENTER AMOUNT</div>\n        </div>\n\n        \x3c!-- 按钮组 --\x3e\n        <div style="display: flex; gap: 8px; position: relative; z-index: 2;">\n          <button onclick="document.getElementById('exchange-modal').remove();" style="\n            flex: 1;\n            padding: 10px 6px;\n            background: linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.06)":"rgba(255, 255, 255, 0.06)"} 0%, ${e?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.03)"} 100%);\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.15)"};\n            color: var(--text-primary);\n            font-family: 'Courier New', monospace;\n            font-size: 9px;\n            font-weight: 700;\n            letter-spacing: 1px;\n            cursor: pointer;\n            transition: all 0.3s;\n            text-align: center;\n            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);\n            position: relative;\n            overflow: hidden;\n            box-shadow: 0 2px 6px ${e?"rgba(0, 0, 0, 0.1)":"rgba(0, 0, 0, 0.2)"};\n          " onmouseover="this.style.background='linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"} 0%, ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"} 100%)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.06)":"rgba(255, 255, 255, 0.06)"} 0%, ${e?"rgba(0, 0, 0, 0.03)":"rgba(255, 255, 255, 0.03)"} 100%)'; this.style.transform='translateY(0)';">\n            CANCEL\n          </button>\n\n          <button onclick="confirmExchange()" style="\n            flex: 1;\n            padding: 10px 6px;\n            background: linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"} 0%, ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"} 100%);\n            border: 1px solid ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.15)"};\n            color: var(--text-primary);\n            font-family: 'Courier New', monospace;\n            font-size: 9px;\n            font-weight: 700;\n            letter-spacing: 1px;\n            cursor: pointer;\n            transition: all 0.3s;\n            text-align: center;\n            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);\n            position: relative;\n            overflow: hidden;\n            box-shadow: 0 2px 6px ${e?"rgba(0, 0, 0, 0.1)":"rgba(0, 0, 0, 0.2)"};\n          " onmouseover="this.style.background='linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.15)":"rgba(255, 255, 255, 0.15)"} 0%, ${e?"rgba(0, 0, 0, 0.08)":"rgba(255, 255, 255, 0.08)"} 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px ${e?"rgba(0, 0, 0, 0.15)":"rgba(0, 0, 0, 0.3)"}'" onmouseout="this.style.background='linear-gradient(135deg, ${e?"rgba(0, 0, 0, 0.1)":"rgba(255, 255, 255, 0.1)"} 0%, ${e?"rgba(0, 0, 0, 0.05)":"rgba(255, 255, 255, 0.05)"} 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px ${e?"rgba(0, 0, 0, 0.1)":"rgba(0, 0, 0, 0.2)"}'">\n            CONFIRM\n          </button>\n        </div>\n      </div>\n    `,t.appendChild(o),document.body.appendChild(t),t.addEventListener("click",function(n){n.target===t&&t.remove()}),setTimeout(()=>{const n=document.getElementById("exchange-amount-input");n&&n.focus()},100)}()}catch(n){console.error("❌ 打开兑换弹窗失败:",n),mn("打开兑换功能失败: "+n.message,"error")}},n.XSocialApp={init:Fs,render:Xs,version:"1.0",isLoaded:!0},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Fs):setTimeout(Fs,100),console.log("📦 X Social App 模块已加载，版本: 1.0"),n.clearCurrentWalletData=async function(){try{const n=e(),t=vt||"main",o=`wallet_${t}`;await n.xAccountProfiles.delete(o),await Mt(),console.log("✅ 已清空账户钱包数据:",t),mn("钱包数据已清空","success")}catch(n){console.error("❌ 清空钱包数据失败:",n),mn("清空失败: "+n.message,"error")}}}(window);